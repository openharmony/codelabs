/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import cryptoFramework from '@ohos.security.cryptoFramework';
import promptAction from '@ohos.promptAction';
import Logger from '../util/Logger';
import picker from '@ohos.file.picker';
import { CryptoOperation } from '../cryptoframework/CryptoOperation';
import TextFileManager from '../textfilemanager/TextFileManager';
import common from '@ohos.app.ability.common';
import window from '@ohos.window';
import { util } from '@kit.ArkTS';
import { MetadataHelper, MetadataParseResult } from '../util/MetadataHelper';

const TAG: string = '[Crypto_Framework]';

interface BinaryDecryptResult {
  success: boolean;
  data?: ArrayBuffer;
  error?: string;
}

@Component
export struct Decrypt {
  // çŠ¶æ€å˜é‡
  @State fileHash: string = '';
  @State originalExtension: string = '';
  @State isProcessing: boolean = false;
  @State decryptionStatus: string = '';
  @State decryptionDetails: string = '';

  @State keyFileName: string = '';
  @State keyFileUri: string = '';
  @State textFileUri: string = '';
  @State textFileName: string = '';
  @State keyString: string = '';
  @State cipherText: string = '';
  @State plainText: string = '';
  @State message: string = '';
  @State decryptedFileUri: string = '';
  @State createKeyUri: string = '';
  @State encryptedFileUri: string = '';
  @State metadataInfo: string = '';
  @State fileSize: number = 0;

  private CryptoOperation: CryptoOperation = new CryptoOperation();

  build() {
    Stack({ alignContent: Alignment.TopStart }) {
      // èƒŒæ™¯æ¸å˜è£…é¥°å±‚
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 180,
          colors: [[0xF5F7FA, 0.0], [0xE8ECF1, 1.0]]
        })

      // ä¸»å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 16 }) {
          // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
          Row() {
            Column() {
              Text('æ–‡ä»¶è§£å¯†')
                .fontSize(24)
                .fontWeight(600)
                .fontColor($r('sys.color.font_primary'))
                .lineHeight(32)
              
              Text('å®‰å…¨å¯é çš„åŠ å¯†æ–‡ä»¶è§£å¯†å·¥å…·')
                .fontSize(14)
                .fontWeight(400)
                .fontColor($r('sys.color.font_secondary'))
                .margin({ top: 4 })
                .opacity(0.8)
            }
            .alignItems(HorizontalAlign.Center)
            .width('100%')
          }
          .width('100%')
          .padding({ left: 24, right: 24, top: 16, bottom: 8 })

          // æ–‡ä»¶é€‰æ‹©å¡ç‰‡åŒºåŸŸ
          GridRow() {
            GridCol({ span: { xs: 12, sm: 12, md: 12, lg: 12 } }) {
              Column() {
                // å¡ç‰‡æ ‡é¢˜
                Row() {
                  Column() {
                    Text('æ–‡ä»¶é€‰æ‹©')
                      .fontSize(18)
                      .fontWeight(600)
                      .fontColor($r('sys.color.font_primary'))
                      .lineHeight(24)
                  }
                  .alignItems(HorizontalAlign.Start)
                  .width('100%')
                }
                .width('100%')
                .padding({ left: 20, right: 20, top: 16, bottom: 12 })

                // åˆ†éš”çº¿
                Divider()
                  .color(0xE5E5E5)
                  .strokeWidth(1)
                  .margin({ left: 20, right: 20 })

                // æ–‡ä»¶é€‰æ‹©åˆ—è¡¨
                Column({ space: 12 }) {
                  // åŠ å¯†æ–‡ä»¶é€‰æ‹©é¡¹
                  Row() {
                    Column() {
                      Row() {
                        // å›¾æ ‡åŒºåŸŸ
                        Row() {
                          Text('ğŸ“„')
                            .fontSize(20)
                            .fontWeight(400)
                        }
                        .width(40)
                        .height(40)
                        .borderRadius(8)
                        .backgroundColor(0xF0F4F8)
                        .justifyContent(FlexAlign.Center)

                        // æ–‡æœ¬åŒºåŸŸ
                        Column({ space: 4 }) {
                          Text($r('app.string.open_file'))
                            .fontSize(16)
                            .fontWeight(500)
                            .fontColor($r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(22)

                          Text(this.textFileName === '' ? $r('app.string.please_choose') : this.textFileName)
                            .fontSize(13)
                            .fontWeight(400)
                            .fontColor(this.textFileName === '' ? $r('sys.color.font_secondary') : $r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(18)
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .opacity(this.textFileName === '' ? 0.6 : 0.9)
                        }
                        .alignItems(HorizontalAlign.Start)
                        .layoutWeight(1)
                        .margin({ left: 12 })

                        // ç®­å¤´å›¾æ ‡
                        Image($r('app.media.right_arrow'))
                          .height(20)
                          .width(20)
                          .margin({ left: 8 })
                          .opacity(0.5)
                      }
                      .width('100%')
                      .height('100%')
                    }
                    .width('100%')
                    .height('100%')
                  }
                  .width('100%')
                  .height(72)
                  .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                  .backgroundColor(0xFFFFFF)
                  .borderRadius(12)
                  .shadow({
                    radius: 8,
                    color: 0x1A000000,
                    offsetX: 0,
                    offsetY: 2
                  })
                  .onClick(() => {
                    if (!this.isProcessing) {
                      this.selectEncryptedFileAndRead();
                    }
                  })

                  // å¯†é’¥æ–‡ä»¶é€‰æ‹©é¡¹
                  Row() {
                    Column() {
                      Row() {
                        // å›¾æ ‡åŒºåŸŸ
                        Row() {
                          Text('ğŸ”‘')
                            .fontSize(20)
                            .fontWeight(400)
                        }
                        .width(40)
                        .height(40)
                        .borderRadius(8)
                        .backgroundColor(0xFFF8E1)
                        .justifyContent(FlexAlign.Center)

                        // æ–‡æœ¬åŒºåŸŸ
                        Column({ space: 4 }) {
                          Text($r('app.string.select_key_file'))
                            .fontSize(16)
                            .fontWeight(500)
                            .fontColor($r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(22)

                          Text(this.keyFileName === '' ? $r('app.string.please_choose') : this.keyFileName)
                            .fontSize(13)
                            .fontWeight(400)
                            .fontColor(this.keyFileName === '' ? $r('sys.color.font_secondary') : $r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(18)
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .opacity(this.keyFileName === '' ? 0.6 : 0.9)
                        }
                        .alignItems(HorizontalAlign.Start)
                        .layoutWeight(1)
                        .margin({ left: 12 })

                        // ç®­å¤´å›¾æ ‡
                        Image($r('app.media.right_arrow'))
                          .height(20)
                          .width(20)
                          .margin({ left: 8 })
                          .opacity(0.5)
                      }
                      .width('100%')
                      .height('100%')
                    }
                    .width('100%')
                    .height('100%')
                  }
                  .width('100%')
                  .height(72)
                  .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                  .backgroundColor(0xFFFFFF)
                  .borderRadius(12)
                  .shadow({
                    radius: 8,
                    color: 0x1A000000,
                    offsetX: 0,
                    offsetY: 2
                  })
                  .onClick(() => {
                    if (!this.isProcessing) {
                      this.selectAesKeyFileAndRead();
                    }
                  })
                }
                .width('100%')
                .padding({ top: 8, bottom: 16 })
              }
              .width('100%')
              .backgroundColor(0xFFFFFF)
              .borderRadius(20)
              .padding({ top: 0, bottom: 0 })
              .shadow({
                radius: 12,
                color: 0x1F000000,
                offsetX: 0,
                offsetY: 4
              })
            }
          }
          .width('100%')
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })

          // åŠ å¯†æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ
          GridRow() {
            GridCol({ span: { xs: 12, sm: 12, md: 12, lg: 12 } }) {
              Column() {
                // æ ‡é¢˜æ 
                Row() {
                  Row() {
                    Text('ğŸ“Š')
                      .fontSize(18)
                      .margin({ right: 8 })
                    Text('åŠ å¯†æ–‡ä»¶ä¿¡æ¯')
                      .fontSize(18)
                      .fontWeight(600)
                      .fontColor($r('sys.color.font_primary'))
                      .lineHeight(24)
                  }
                  .alignItems(VerticalAlign.Center)
                  .width('100%')
                }
                .width('100%')
                .height(56)
                .padding({ left: 20, right: 20 })
                .justifyContent(FlexAlign.Start)

                // åˆ†éš”çº¿
                Divider()
                  .color(0xE5E5E5)
                  .strokeWidth(1)
                  .margin({ left: 20, right: 20 })

                // å†…å®¹åŒºåŸŸ
                Column({ space: 12 }) {
                  Row() {
                    Scroll() {
                      Column({ space: 10 }) {
                        Text(this.cipherText ? this.cipherText : 'æš‚æ— åŠ å¯†æ–‡ä»¶ä¿¡æ¯')
                          .fontSize(15)
                          .fontWeight(400)
                          .fontColor($r('sys.color.font_primary'))
                          .textAlign(TextAlign.Start)
                          .lineHeight(22)

                        if (this.metadataInfo) {
                          Divider()
                            .color(0xF0F0F0)
                            .strokeWidth(1)
                            .margin({ top: 4, bottom: 4 })

                          Text(this.metadataInfo)
                            .fontSize(13)
                            .fontWeight(400)
                            .fontColor($r('sys.color.font_secondary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(20)
                            .opacity(0.85)
                        }
                      }
                      .width('100%')
                    }
                    .width('100%')
                    .height(140)
                    .scrollBar(BarState.Auto)
                  }
                  .width('100%')
                  .padding({ left: 20, right: 20, top: 8, bottom: 16 })
                }
                .width('100%')
              }
              .width('100%')
              .backgroundColor(0xFFFFFF)
              .borderRadius(20)
              .padding({ top: 0, bottom: 0 })
              .shadow({
                radius: 12,
                color: 0x1F000000,
                offsetX: 0,
                offsetY: 4
              })
            }
          }
          .width('100%')
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })

          // è§£å¯†ç»“æœæ˜¾ç¤ºåŒºåŸŸ
          GridRow() {
            GridCol({ span: { xs: 12, sm: 12, md: 12, lg: 12 } }) {
              Column() {
                // æ ‡é¢˜æ 
                Row() {
                  Row() {
                    Text('âœ…')
                      .fontSize(18)
                      .margin({ right: 8 })
                    Text('è§£å¯†ç»“æœ')
                      .fontSize(18)
                      .fontWeight(600)
                      .fontColor($r('sys.color.font_primary'))
                      .lineHeight(24)
                  }
                  .alignItems(VerticalAlign.Center)
                  .width('100%')
                }
                .width('100%')
                .height(56)
                .padding({ left: 20, right: 20 })
                .justifyContent(FlexAlign.Start)

                // åˆ†éš”çº¿
                Divider()
                  .color(0xE5E5E5)
                  .strokeWidth(1)
                  .margin({ left: 20, right: 20 })

                // å†…å®¹åŒºåŸŸ
                Column({ space: 12 }) {
                  Row() {
                    Scroll() {
                      Column({ space: 10 }) {
                        Text(this.decryptionStatus || 'ç­‰å¾…è§£å¯†æ“ä½œ')
                          .fontSize(15)
                          .fontWeight(500)
                          .fontColor(this.decryptionStatus.includes('æˆåŠŸ') ? 0xFF4CAF50 : 
                                    this.decryptionStatus.includes('å¤±è´¥') ? 0xFFF44336 : 
                                    $r('sys.color.font_primary'))
                          .textAlign(TextAlign.Start)
                          .lineHeight(22)

                        if (this.decryptionDetails) {
                          Divider()
                            .color(0xF0F0F0)
                            .strokeWidth(1)
                            .margin({ top: 4, bottom: 4 })

                          Text(this.decryptionDetails)
                            .fontSize(13)
                            .fontWeight(400)
                            .fontColor($r('sys.color.font_secondary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(20)
                            .opacity(0.85)
                        }
                      }
                      .width('100%')
                    }
                    .width('100%')
                    .height(140)
                    .scrollBar(BarState.Auto)
                  }
                  .width('100%')
                  .padding({ left: 20, right: 20, top: 8, bottom: 16 })
                }
                .width('100%')
              }
              .width('100%')
              .backgroundColor(0xFFFFFF)
              .borderRadius(20)
              .padding({ top: 0, bottom: 0 })
              .shadow({
                radius: 12,
                color: 0x1F000000,
                offsetX: 0,
                offsetY: 4
              })
            }
          }
          .width('100%')
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })

          // æ–‡ä»¶è¯¦ç»†ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ
          GridRow() {
            GridCol({ span: { xs: 12, sm: 12, md: 12, lg: 12 } }) {
              Column() {
                // æ ‡é¢˜æ 
                Row() {
                  Row() {
                    Text('â„¹ï¸')
                      .fontSize(18)
                      .margin({ right: 8 })
                    Text('æ–‡ä»¶è¯¦ç»†ä¿¡æ¯')
                      .fontSize(18)
                      .fontWeight(600)
                      .fontColor($r('sys.color.font_primary'))
                      .lineHeight(24)
                  }
                  .alignItems(VerticalAlign.Center)
                  .width('100%')
                }
                .width('100%')
                .height(56)
                .padding({ left: 20, right: 20 })
                .justifyContent(FlexAlign.Start)

                // åˆ†éš”çº¿
                Divider()
                  .color(0xE5E5E5)
                  .strokeWidth(1)
                  .margin({ left: 20, right: 20 })

                // ä¿¡æ¯é¡¹åˆ—è¡¨
                Column({ space: 16 }) {
                  // æ–‡ä»¶å¤§å°æ˜¾ç¤º
                  Row() {
                    Row() {
                      Text('ğŸ“')
                        .fontSize(16)
                        .margin({ right: 12 })
                      Column({ space: 2 }) {
                        Text('æ–‡ä»¶å¤§å°')
                          .fontSize(13)
                          .fontWeight(400)
                          .fontColor($r('sys.color.font_secondary'))
                          .opacity(0.7)
                        Text(this.fileSize ? this.formatFileSize(this.fileSize) : 'æœªçŸ¥')
                          .fontSize(15)
                          .fontWeight(500)
                          .fontColor($r('sys.color.font_primary'))
                      }
                      .alignItems(HorizontalAlign.Start)
                    }
                    .width('100%')
                    .justifyContent(FlexAlign.Start)
                  }
                  .width('100%')
                  .height(48)
                  .padding({ left: 20, right: 20 })

                  // åˆ†éš”çº¿
                  Divider()
                    .color(0xF5F5F5)
                    .strokeWidth(1)
                    .margin({ left: 20, right: 20 })

                  // åŸå§‹æ ¼å¼æ˜¾ç¤º
                  Row() {
                    Row() {
                      Text('ğŸ“‹')
                        .fontSize(16)
                        .margin({ right: 12 })
                      Column({ space: 2 }) {
                        Text('åŸå§‹æ ¼å¼')
                          .fontSize(13)
                          .fontWeight(400)
                          .fontColor($r('sys.color.font_secondary'))
                          .opacity(0.7)
                        Text(this.originalExtension || 'æœªçŸ¥')
                          .fontSize(15)
                          .fontWeight(500)
                          .fontColor($r('sys.color.font_primary'))
                      }
                      .alignItems(HorizontalAlign.Start)
                    }
                    .width('100%')
                    .justifyContent(FlexAlign.Start)
                  }
                  .width('100%')
                  .height(48)
                  .padding({ left: 20, right: 20, bottom: 16 })
                }
                .width('100%')
                .padding({ top: 8 })
              }
              .width('100%')
              .backgroundColor(0xFFFFFF)
              .borderRadius(20)
              .padding({ top: 0, bottom: 0 })
              .shadow({
                radius: 12,
                color: 0x1F000000,
                offsetX: 0,
                offsetY: 4
              })
            }
          }
          .width('100%')
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })

          // æ“ä½œæŒ‰é’®åŒºåŸŸ
          Column({ space: 16 }) {
            // æ£€æµ‹å…ƒæ•°æ®æŒ‰é’®
            Button() {
              Row() {
                Text('ğŸ”')
                  .fontSize(18)
                  .margin({ right: 8 })
                Text('æ£€æµ‹å…ƒæ•°æ®')
                  .fontSize(16)
                  .fontWeight(600)
                  .lineHeight(22)
                  .fontColor($r('sys.color.comp_background_list_card'))
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)
            }
            .borderRadius(24)
            .type(ButtonType.Capsule)
            .width('100%')
            .height(52)
            .backgroundColor($r('sys.color.brand'))
            .enabled(!this.isProcessing && !!this.textFileUri)
            .opacity((!this.isProcessing && !!this.textFileUri) ? 1.0 : 0.5)
            .shadow({
              radius: 8,
              color: 0x33000000,
              offsetX: 0,
              offsetY: 2
            })
            .onClick(() => {
              this.detectMetadataHeader();
            })

            // è§£å¯†æŒ‰é’®
            Button() {
              Row() {
                if (this.isProcessing) {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                    .color($r('sys.color.comp_background_list_card'))
                    .margin({ right: 8 })
                } else {
                  Text('ğŸ”“')
                    .fontSize(18)
                    .margin({ right: 8 })
                }
                Text($r('app.string.decrypt'))
                  .fontSize(16)
                  .fontWeight(600)
                  .lineHeight(22)
                  .fontColor($r('sys.color.comp_background_list_card'))
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)
            }
            .borderRadius(24)
            .id('decryptionBtn')
            .type(ButtonType.Capsule)
            .width('100%')
            .height(52)
            .backgroundColor($r('sys.color.brand'))
            .shadow({
              radius: 8,
              color: 0x33000000,
              offsetX: 0,
              offsetY: 2
            })
            .onClick(() => {
              if (this.textFileUri === '' || this.keyString === '') {
                this.getUIContext().getPromptAction().showToast({
                  message: $r('app.string.null_message')
                });
              } else {
                this.decryptWithMetadata();
              }
            })

            // å¤„ç†çŠ¶æ€æŒ‡ç¤ºå™¨
            if (this.isProcessing) {
              Row() {
                LoadingProgress()
                  .width(24)
                  .height(24)
                  .color($r('sys.color.brand'))
                Text('æ­£åœ¨å¤„ç†ä¸­...')
                  .fontSize(14)
                  .fontWeight(400)
                  .fontColor($r('sys.color.font_secondary'))
                  .margin({ left: 12 })
                  .opacity(0.8)
              }
              .width('100%')
              .height(40)
              .justifyContent(FlexAlign.Center)
              .margin({ top: 8 })
            }
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 8, bottom: 24 })
        }
        .width('100%')
        .padding({ top: 8, bottom: 16 })
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Auto)
      .scrollable(ScrollDirection.Vertical)
    }
    .width('100%')
    .height('100%')
  }

  /**
   * é€‰æ‹©å¹¶è¯»å–AESå¯†é’¥æ–‡ä»¶
   */
  async selectAesKeyFileAndRead() {
    this.isProcessing = true;
    try {
      let context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      let documentPicker = new picker.DocumentViewPicker(context);
      let documentSelectOptions = new picker.DocumentSelectOptions();

      let uris = await documentPicker.select(documentSelectOptions);
      const windowClass = await window.getLastWindow(context);

      if (uris && uris.length > 0) {
        this.keyFileUri = uris[0];
        this.keyFileName = this.getFileNameFromUri(this.keyFileUri);

        const readResult = await TextFileManager.readTextFile(this.keyFileUri);
        if (readResult.success) {
          try {
            const decoder = new util.TextDecoder('utf-8');
            const uint8 = new Uint8Array(readResult.data as ArrayBuffer);
            const dataSlice = uint8.slice(0, 2000);
            this.keyString = decoder.decode(dataSlice);
          } catch (decodeError) {
            Logger.error(TAG, `Binary decode error: ${decodeError.code}`);
            this.keyString = "å¯†é’¥å†…å®¹é¢„è§ˆä¸å¯ç”¨";
          }
          windowClass.getUIContext().getPromptAction().showToast({ message: 'å¯†é’¥æ–‡ä»¶è¯»å–æˆåŠŸ' });
        } else {
          windowClass.getUIContext().getPromptAction().showToast({ message: 'å¯†é’¥æ–‡ä»¶è¯»å–å¤±è´¥' });
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({ message: 'æœªé€‰æ‹©æ–‡ä»¶' });
      }
    } catch (error) {
      Logger.error(TAG, `selectAesKeyFileAndRead failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({ message: 'é€‰æ‹©æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * é€‰æ‹©å¹¶è¯»å–åŠ å¯†æ–‡ä»¶ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒå…ƒæ•°æ®æ£€æµ‹ï¼‰
   */
  async selectEncryptedFileAndRead() {
    this.isProcessing = true;
    try {
      let context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      let documentPicker = new picker.DocumentViewPicker(context);
      let documentSelectOptions = new picker.DocumentSelectOptions();

      let uris = await documentPicker.select(documentSelectOptions);
      const windowClass = await window.getLastWindow(context);

      if (uris && uris.length > 0) {
        this.textFileUri = uris[0];
        this.textFileName = this.getFileNameFromUri(this.textFileUri);
        this.originalExtension = MetadataHelper.getFileExtension(this.textFileName);

        const readResult = await TextFileManager.readTextFile(this.textFileUri);
        if (readResult.success) {
          const data = readResult.data as ArrayBuffer;
          this.cipherText = `åŠ å¯†æ•°æ®å¤§å°: ${data.byteLength} å­—èŠ‚ï¼ˆäºŒè¿›åˆ¶ï¼‰`;
          this.fileSize = data.byteLength;

          // è‡ªåŠ¨æ£€æµ‹å…ƒæ•°æ®å¤´
          await this.detectMetadataHeader();
          windowClass.getUIContext().getPromptAction().showToast({ message: 'åŠ å¯†æ–‡ä»¶è¯»å–æˆåŠŸ' });
        } else {
          windowClass.getUIContext().getPromptAction().showToast({ message: 'æ–‡ä»¶è¯»å–å¤±è´¥' });
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({ message: 'æœªé€‰æ‹©æ–‡ä»¶' });
      }
    } catch (error) {
      Logger.error(TAG, `selectEncryptedFileAndRead failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({ message: 'é€‰æ‹©æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * æ£€æµ‹å…ƒæ•°æ®å¤´
   */
  async detectMetadataHeader() {
    this.isProcessing = true;
    try {
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);

      if (!this.textFileUri) {
        windowClass.getUIContext().getPromptAction().showToast({ message: 'è¯·å…ˆé€‰æ‹©åŠ å¯†æ–‡ä»¶' });
        return;
      }

      const separationResult = await this.separateMetadataAndCipherData(this.textFileUri);
      if (separationResult.success && separationResult.metadata) {
        const metadata = separationResult.metadata;
        this.metadataInfo = `æ£€æµ‹åˆ°å…ƒæ•°æ®å¤´:\n` +
          `åŸå§‹æ ¼å¼: ${metadata.originalExtension}\n` +
          `æ–‡ä»¶å¤§å°: ${this.formatFileSize(metadata.fileSize || 0)}\n` +
          `åŠ å¯†æ—¶é—´: ${new Date(metadata.timestamp).toLocaleString()}\n` +
          `ç‰ˆæœ¬: v${metadata.version}`;

        this.originalExtension = metadata.originalExtension;

        windowClass.getUIContext().getPromptAction().showToast({
          message: `æ£€æµ‹åˆ°å…ƒæ•°æ®å¤´ï¼ŒåŸå§‹æ ¼å¼: ${metadata.originalExtension}`
        });

        Logger.info(TAG, `å…ƒæ•°æ®å¤´æ£€æµ‹æˆåŠŸ: ${JSON.stringify(metadata)}`);
      } else {
        this.metadataInfo = 'æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„å…ƒæ•°æ®å¤´ï¼Œå¯èƒ½ä¸ºæ—§ç‰ˆæœ¬åŠ å¯†æ–‡ä»¶';
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æœªæ£€æµ‹åˆ°å…ƒæ•°æ®å¤´'
        });
      }
    } catch (error) {
      Logger.error(TAG, `detectMetadataHeader failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({
        message: 'å…ƒæ•°æ®æ£€æµ‹å¤±è´¥'
      });
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * åˆ†ç¦»å…ƒæ•°æ®å¤´å’ŒåŠ å¯†æ•°æ®
   */
  private async separateMetadataAndCipherData(fileUri: string): Promise<MetadataParseResult> {
    try {
      // è¯»å–æ–‡ä»¶æ•°æ®
      const readResult = await TextFileManager.readTextFile(fileUri);
      if (!readResult.success || !readResult.data) {
        return { success: false, message: 'æ–‡ä»¶è¯»å–å¤±è´¥' };
      }

      const fileData = readResult.data as ArrayBuffer;

      return MetadataHelper.parseDataWithMetadata(fileData);

    } catch (error) {
      Logger.error(TAG, `separateMetadataAndCipherData failed: ${error.message}`);
      return {
        success: false,
        message: `å…ƒæ•°æ®åˆ†ç¦»å¤±è´¥: ${error.message}`
      };
    }
  }

  /**
   * åˆ›å»ºè§£å¯†æ–‡ä»¶å¹¶å†™å…¥å†…å®¹ï¼ˆæ”¯æŒå…ƒæ•°æ®æ¢å¤ï¼‰
   */
  async createDecryptedFileAndWrite(decryptedData: ArrayBuffer | string, originalExtension?: string): Promise<boolean> {
    this.isProcessing = true;
    try {
      let context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      let documentPicker = new picker.DocumentViewPicker(context);

      let documentSaveOptions = new picker.DocumentSaveOptions();

      // ä½¿ç”¨å…ƒæ•°æ®ä¸­çš„åŸå§‹æ‰©å±•åæˆ–é»˜è®¤æ‰©å±•å
      const finalExtension = originalExtension || 'decrypted';
      const baseName = MetadataHelper.getFileBaseName(this.textFileName);
      const newFileName = `${baseName}_decrypted.${finalExtension}`;

      documentSaveOptions.newFileNames = [newFileName];

      let saveUris = await documentPicker.save(documentSaveOptions);
      const windowClass = await window.getLastWindow(context);

      if (saveUris && saveUris.length > 0) {
        this.decryptedFileUri = saveUris[0];

        const writeResult = await TextFileManager.writeTextFile(this.decryptedFileUri, decryptedData);
        if (writeResult.success) {
          const message = originalExtension ?
            `è§£å¯†æ–‡ä»¶ä¿å­˜æˆåŠŸï¼Œå·²æ¢å¤ä¸ºåŸå§‹æ ¼å¼: ${originalExtension}` :
            'è§£å¯†æ–‡ä»¶ä¿å­˜æˆåŠŸ';

          windowClass.getUIContext().getPromptAction().showToast({ message });
          return true;
        } else {
          windowClass.getUIContext().getPromptAction().showToast({ message: 'æ–‡ä»¶ä¿å­˜å¤±è´¥' });
          return false;
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({ message: 'æ–‡ä»¶ä¿å­˜å–æ¶ˆ' });
        return false;
      }
    } catch (error) {
      Logger.error(TAG, `createDecryptedFileAndWrite failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({ message: 'æ–‡ä»¶ä¿å­˜å¤±è´¥' });
      return false;
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * å¢å¼ºçš„è§£å¯†åŠŸèƒ½ - æ”¯æŒå…ƒæ•°æ®å¤´è§£æ
   */
  async decryptWithMetadata() {
    this.isProcessing = true;
    const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);

    // é‡ç½®è§£å¯†ç»“æœ
    this.decryptionStatus = '';
    this.decryptionDetails = '';
    this.plainText = '';

    if (this.textFileUri === '' || this.keyString === '') {
      windowClass.getUIContext().getPromptAction().showToast({ message: $r('app.string.null_message') });
      this.isProcessing = false;
      return;
    }

    try {
      // åˆ†ç¦»å…ƒæ•°æ®å¤´å’ŒåŠ å¯†æ•°æ®
      const separationResult = await this.separateMetadataAndCipherData(this.textFileUri);

      if (!separationResult.data) {
        windowClass.getUIContext().getPromptAction().showToast({ message: 'åŠ å¯†æ•°æ®æå–å¤±è´¥' });
        this.isProcessing = false;
        return;
      }

      let decryptionResult: string | BinaryDecryptResult | null = null;
      let originalExtension: string | undefined;

      if (separationResult.success && separationResult.metadata) {
        // æœ‰å…ƒæ•°æ®å¤´çš„æƒ…å†µ
        originalExtension = separationResult.metadata.originalExtension;
        this.originalExtension = originalExtension;

        Logger.info(TAG, `ä½¿ç”¨å…ƒæ•°æ®å¤´ä¿¡æ¯è§£å¯†ï¼ŒåŸå§‹æ ¼å¼: ${originalExtension}`);

        // æ£€æŸ¥æ˜¯å¦æœ‰ Tag
        if (separationResult.tag && separationResult.tag.byteLength > 0) {
          Logger.info(TAG, `ä½¿ç”¨å…ƒæ•°æ®ä¸­çš„ Tag è¿›è¡Œè§£å¯†ï¼ŒTagå¤§å°: ${separationResult.tag.byteLength} å­—èŠ‚`);

          // ä½¿ç”¨ä»å…ƒæ•°æ®ä¸­æå–çš„ Tag
          decryptionResult = await this.CryptoOperation.aesConvertAndDecryptBinary(
            this.keyString, separationResult.data, separationResult.tag
          );
        } else {
          Logger.warn(TAG, 'å…ƒæ•°æ®ä¸­æ²¡æœ‰ Tagï¼Œä½¿ç”¨ç©º Tag è§£å¯†ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰');

          // æ²¡æœ‰ Tag çš„æƒ…å†µï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
          const emptyTag = new ArrayBuffer(0);
          decryptionResult = await this.CryptoOperation.aesConvertAndDecryptBinary(
            this.keyString, separationResult.data, emptyTag
          );
        }
      } else {
        // æ— å…ƒæ•°æ®å¤´çš„æƒ…å†µï¼Œå°è¯•ä¼ ç»Ÿè§£å¯†
        Logger.info(TAG, 'æœªæ£€æµ‹åˆ°å…ƒæ•°æ®å¤´ï¼Œä½¿ç”¨ä¼ ç»Ÿè§£å¯†æ–¹æ³•');

        const readResult = await TextFileManager.readTextFile(this.textFileUri);
        if (!readResult.success) {
          windowClass.getUIContext().getPromptAction().showToast({ message: 'æ–‡ä»¶è¯»å–å¤±è´¥' });
          this.isProcessing = false;
          return;
        }

        // äºŒè¿›åˆ¶æ•°æ® - å°è¯•ä½¿ç”¨ç©º Tag
        const emptyTag = new ArrayBuffer(0);
        decryptionResult = await this.CryptoOperation.aesConvertAndDecryptBinary(
          this.keyString, readResult.data as ArrayBuffer, emptyTag
        );
      }

      // å¤„ç†è§£å¯†ç»“æœ
      const decryptTime = new Date().toLocaleString();

      // æ£€æŸ¥è§£å¯†ç»“æœæ˜¯å¦æˆåŠŸ
      let isDecryptionSuccessful = false;
      let decryptedData: ArrayBuffer | string | undefined;
      let dataSize: number = 0;

      if (decryptionResult) {
        // ä½¿ç”¨ç±»å‹æ–­è¨€æ˜ç¡®å‘Šè¯‰ TypeScript å˜é‡çš„ç±»å‹
        if (typeof decryptionResult === 'string') {
          // å­—ç¬¦ä¸²ç±»å‹çš„è§£å¯†ç»“æœ
          const stringResult = decryptionResult as string;
          isDecryptionSuccessful = true;
          decryptedData = stringResult;
          dataSize = stringResult.length;
          this.plainText = stringResult.substring(0, 1000);
        } else {
          // BinaryDecryptResult ç±»å‹çš„è§£å¯†ç»“æœ
          const binaryResult = decryptionResult as BinaryDecryptResult;
          if (binaryResult.success && binaryResult.data) {
            isDecryptionSuccessful = true;
            decryptedData = binaryResult.data;
            dataSize = binaryResult.data.byteLength;

            // å°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºå­—ç¬¦ä¸²é¢„è§ˆ
            try {
              const decoder = new util.TextDecoder('utf-8');
              this.plainText = decoder.decode(new Uint8Array(decryptedData).slice(0, 1000));
            } catch (error) {
              this.plainText = 'äºŒè¿›åˆ¶å†…å®¹é¢„è§ˆä¸å¯ç”¨';
            }
          } else {
            // BinaryDecryptResult ç±»å‹çš„å¤±è´¥ç»“æœ
            isDecryptionSuccessful = false;
            this.decryptionStatus = 'âŒ è§£å¯†å¤±è´¥';
            this.decryptionDetails = `è§£å¯†è¿‡ç¨‹å‡ºé”™\nè§£å¯†æ—¶é—´: ${decryptTime}\né”™è¯¯: ${binaryResult.error || 'æœªçŸ¥é”™è¯¯'}`;

            windowClass.getUIContext().getPromptAction().showToast({
              message: $r('app.string.decrypt_fail')
            });
          }
        }
      }

      if (isDecryptionSuccessful && decryptedData) {
        this.decryptionStatus = 'âœ… è§£å¯†æˆåŠŸ';
        this.decryptionDetails = `æ–‡ä»¶è§£å¯†å®Œæˆ\nè§£å¯†æ—¶é—´: ${decryptTime}\nå¤„ç†æ•°æ®: ${dataSize} å­—èŠ‚`;

        // è‡ªåŠ¨éªŒè¯å“ˆå¸Œï¼ˆå¦‚æœå…ƒæ•°æ®ä¸­åŒ…å« hash å­—æ®µï¼‰
        try {
          let decryptedBuf: ArrayBuffer;
          if (typeof decryptedData === 'string') {
            decryptedBuf = new util.TextEncoder().encode(decryptedData).buffer;
          } else {
            decryptedBuf = decryptedData as ArrayBuffer;
          }

          if (separationResult && separationResult.metadata && separationResult.metadata.hash) {
            const expectedHash = MetadataHelper.base64ToArrayBuffer(separationResult.metadata.hash!);
            const ok = await this.CryptoOperation.verifyDataIntegrity(decryptedBuf, expectedHash, 'SHA256');
            if (ok) {
              this.decryptionDetails += '\nå“ˆå¸ŒéªŒè¯: âœ… åŒ¹é…';
            } else {
              this.decryptionDetails += '\nå“ˆå¸ŒéªŒè¯: âš ï¸ ä¸åŒ¹é…ï¼æ–‡ä»¶å¯èƒ½è¢«ç¯¡æ”¹æˆ–æŸå';
              this.decryptionStatus = 'âš ï¸ å“ˆå¸Œæ ¡éªŒå¤±è´¥';
            }
          }
        } catch (e) {
          Logger.warn(TAG, `å“ˆå¸ŒéªŒè¯å¤±è´¥: ${e.message}`);
          this.decryptionDetails += '\nå“ˆå¸ŒéªŒè¯: æ— æ³•æ‰§è¡Œ';
        }

        // ä¿å­˜è§£å¯†æ–‡ä»¶
        const saveSuccess = await this.createDecryptedFileAndWrite(decryptedData, originalExtension);
        if (saveSuccess) {
          windowClass.getUIContext().getPromptAction().showToast({
            message: $r('app.string.decrypt_success')
          });

          Logger.info(TAG, `æ–‡ä»¶è§£å¯†æˆåŠŸï¼ŒåŸå§‹æ ¼å¼: ${originalExtension || 'æœªçŸ¥'}, è§£å¯†å¤§å°: ${dataSize} å­—èŠ‚`);
        }
      } else if (!isDecryptionSuccessful) {
        // è§£å¯†å¤±è´¥çš„æƒ…å†µï¼ˆdecryptionResult ä¸º null æˆ–å…¶ä»–å¤±è´¥æƒ…å†µï¼‰
        this.decryptionStatus = 'âŒ è§£å¯†å¤±è´¥';
        this.decryptionDetails = `è§£å¯†è¿‡ç¨‹å‡ºé”™\nè§£å¯†æ—¶é—´: ${decryptTime}\nè¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®`;

        windowClass.getUIContext().getPromptAction().showToast({
          message: $r('app.string.decrypt_fail')
        });
      }

    } catch (error) {
      Logger.error(TAG, `decryptWithMetadata failed, ${error.code}, ${error.message}`);
      this.decryptionStatus = 'âš ï¸ è§£å¯†è¿‡ç¨‹å‡ºé”™';
      this.decryptionDetails = `è§£å¯†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}\nè¯·æ£€æŸ¥å¯†é’¥å’Œæ–‡ä»¶æ ¼å¼`;

      windowClass.getUIContext().getPromptAction().showToast({
        message: $r('app.string.decrypt_fail')
      });
    } finally {
      this.isProcessing = false;
    }
  }

  // æ‰‹åŠ¨å“ˆå¸Œè®¡ç®—åŠŸèƒ½å·²ç§»é™¤ï¼›åŠ å¯†/è§£å¯†æ—¶è‡ªåŠ¨è®¡ç®—å¹¶éªŒè¯å“ˆå¸Œ

  /**
   * ä»æ–‡ä»¶URIä¸­æå–æ–‡ä»¶å
   */
  private getFileNameFromUri(uri: string): string {
    if (!uri) return 'æœªçŸ¥æ–‡ä»¶';
    try {
      const segments = uri.split('/');
      let name = segments[segments.length - 1] || 'æœªçŸ¥æ–‡ä»¶';
      try {
        name = decodeURIComponent(name);
      } catch (e) {
        try { name = decodeURI(name); } catch (_) { }
      }
      if (name.startsWith('file://')) {
        const parts = name.split('/');
        name = parts[parts.length - 1] || name;
      }
      return name;
    } catch (e) {
      return uri;
    }
  }

  /**
   * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º
   */
  private formatFileSize(bytes: number): string {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
}