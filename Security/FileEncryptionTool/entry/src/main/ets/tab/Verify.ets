/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import Logger from '../util/Logger';
import picker from '@ohos.file.picker';
import { CryptoOperation } from '../cryptoframework/CryptoOperation';
import TextFileManager from '../textfilemanager/TextFileManager';
import common from '@ohos.app.ability.common';
import window from '@ohos.window';
import { util } from '@kit.ArkTS';
import { MetadataHelper, MetadataParseResult } from '../util/MetadataHelper';

const TAG: string = '[Crypto_Framework]';

// éªŒç­¾ç»“æœæ¥å£
interface VerifyResult {
  success: boolean;
  isValid: boolean;
  message: string;
  algorithm?: string;
  verifyTime?: string;
}

@Component
export struct Verify {
  // çŠ¶æ€å˜é‡
  @State isProcessing: boolean = false;
  @State verifyResult: string = '';
  @State verifyDetails: string = '';
  @State keyFileName: string = '';
  @State keyFileUri: string = '';
  @State textFileUri: string = '';
  @State textFileName: string = '';
  @State keyString: string = '';
  @State plainText: string = '';
  @State message: string = '';
  @State signFileUri: string = '';
  @State signFileName: string = '';
  @State signData: string = ''; // ç­¾åæ•°æ®ï¼ˆBase64æˆ–åå…­è¿›åˆ¶ï¼‰
  @State createKeyUri: string = '';
  @State fileHash: string = ''; // æ–‡ä»¶å“ˆå¸Œå€¼
  private CryptoOperation: CryptoOperation = new CryptoOperation();

  build() {
    Stack({ alignContent: Alignment.TopStart }) {
      // èƒŒæ™¯æ¸å˜è£…é¥°å±‚
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 180,
          colors: [[0xF5F7FA, 0.0], [0xE8ECF1, 1.0]]
        })

      // ä¸»å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 16 }) {
          // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
          Row() {
            Column() {
              Text('æ–‡ä»¶éªŒç­¾')
                .fontSize(24)
                .fontWeight(600)
                .fontColor($r('sys.color.font_primary'))
                .lineHeight(32)
              
              Text('éªŒè¯æ–‡ä»¶å®Œæ•´æ€§å’ŒçœŸå®æ€§')
                .fontSize(14)
                .fontWeight(400)
                .fontColor($r('sys.color.font_secondary'))
                .margin({ top: 4 })
                .opacity(0.8)
            }
            .alignItems(HorizontalAlign.Center)
            .width('100%')
          }
          .width('100%')
          .padding({ left: 24, right: 24, top: 16, bottom: 8 })

          // æ–‡ä»¶é€‰æ‹©å¡ç‰‡åŒºåŸŸ
          GridRow() {
            GridCol({ span: { xs: 12, sm: 12, md: 12, lg: 12 } }) {
              Column() {
                // å¡ç‰‡æ ‡é¢˜
                Row() {
                  Column() {
                    Text('æ–‡ä»¶é€‰æ‹©')
                      .fontSize(18)
                      .fontWeight(600)
                      .fontColor($r('sys.color.font_primary'))
                      .lineHeight(24)
                  }
                  .alignItems(HorizontalAlign.Start)
                  .width('100%')
                }
                .width('100%')
                .padding({ left: 20, right: 20, top: 16, bottom: 12 })

                // åˆ†éš”çº¿
                Divider()
                  .color(0xE5E5E5)
                  .strokeWidth(1)
                  .margin({ left: 20, right: 20 })

                // æ–‡ä»¶é€‰æ‹©åˆ—è¡¨
                Column({ space: 12 }) {
                  // å¾…éªŒç­¾æ–‡ä»¶é€‰æ‹©é¡¹
                  Row() {
                    Column() {
                      Row() {
                        // å›¾æ ‡åŒºåŸŸ
                        Row() {
                          Text('ğŸ“„')
                            .fontSize(20)
                            .fontWeight(400)
                        }
                        .width(40)
                        .height(40)
                        .borderRadius(8)
                        .backgroundColor(0xF0F4F8)
                        .justifyContent(FlexAlign.Center)

                        // æ–‡æœ¬åŒºåŸŸ
                        Column({ space: 4 }) {
                          Text($r('app.string.open_file'))
                            .fontSize(16)
                            .fontWeight(500)
                            .fontColor($r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(22)

                          Text(this.textFileName === '' ? $r('app.string.please_choose') : this.textFileName)
                            .fontSize(13)
                            .fontWeight(400)
                            .fontColor(this.textFileName === '' ? $r('sys.color.font_secondary') : $r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(18)
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .opacity(this.textFileName === '' ? 0.6 : 0.9)
                        }
                        .alignItems(HorizontalAlign.Start)
                        .layoutWeight(1)
                        .margin({ left: 12 })

                        // ç®­å¤´å›¾æ ‡
                        Image($r('app.media.right_arrow'))
                          .height(20)
                          .width(20)
                          .margin({ left: 8 })
                          .opacity(0.5)
                      }
                      .width('100%')
                      .height('100%')
                    }
                    .width('100%')
                    .height('100%')
                  }
                  .width('100%')
                  .height(72)
                  .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                  .backgroundColor(0xFFFFFF)
                  .borderRadius(12)
                  .shadow({
                    radius: 8,
                    color: 0x1A000000,
                    offsetX: 0,
                    offsetY: 2
                  })
                  .onClick(() => {
                    if (!this.isProcessing) {
                      this.selectTextFileAndRead();
                    }
                  })

                  // RSAå…¬é’¥æ–‡ä»¶é€‰æ‹©é¡¹
                  Row() {
                    Column() {
                      Row() {
                        // å›¾æ ‡åŒºåŸŸ
                        Row() {
                          Text('ğŸ”“')
                            .fontSize(20)
                            .fontWeight(400)
                        }
                        .width(40)
                        .height(40)
                        .borderRadius(8)
                        .backgroundColor(0xFFE3F2FD)
                        .justifyContent(FlexAlign.Center)

                        // æ–‡æœ¬åŒºåŸŸ
                        Column({ space: 4 }) {
                          Text($r('app.string.select_key_file'))
                            .fontSize(16)
                            .fontWeight(500)
                            .fontColor($r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(22)

                          Text(this.keyFileName === '' ? $r('app.string.please_choose') : this.keyFileName)
                            .fontSize(13)
                            .fontWeight(400)
                            .fontColor(this.keyFileName === '' ? $r('sys.color.font_secondary') : $r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(18)
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .opacity(this.keyFileName === '' ? 0.6 : 0.9)
                        }
                        .alignItems(HorizontalAlign.Start)
                        .layoutWeight(1)
                        .margin({ left: 12 })

                        // ç®­å¤´å›¾æ ‡
                        Image($r('app.media.right_arrow'))
                          .height(20)
                          .width(20)
                          .margin({ left: 8 })
                          .opacity(0.5)
                      }
                      .width('100%')
                      .height('100%')
                    }
                    .width('100%')
                    .height('100%')
                  }
                  .width('100%')
                  .height(72)
                  .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                  .backgroundColor(0xFFFFFF)
                  .borderRadius(12)
                  .shadow({
                    radius: 8,
                    color: 0x1A000000,
                    offsetX: 0,
                    offsetY: 2
                  })
                  .onClick(() => {
                    if (!this.isProcessing) {
                      this.selectRsaKeyFileAndRead();
                    }
                  })

                  // ç­¾åæ–‡ä»¶é€‰æ‹©é¡¹
                  Row() {
                    Column() {
                      Row() {
                        // å›¾æ ‡åŒºåŸŸ
                        Row() {
                          Text('âœï¸')
                            .fontSize(20)
                            .fontWeight(400)
                        }
                        .width(40)
                        .height(40)
                        .borderRadius(8)
                        .backgroundColor(0xFFFFF3E0)
                        .justifyContent(FlexAlign.Center)

                        // æ–‡æœ¬åŒºåŸŸ
                        Column({ space: 4 }) {
                          Text($r('app.string.select_signature_file'))
                            .fontSize(16)
                            .fontWeight(500)
                            .fontColor($r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(22)

                          Text(this.signFileName === '' ? $r('app.string.please_choose') : this.signFileName)
                            .fontSize(13)
                            .fontWeight(400)
                            .fontColor(this.signFileName === '' ? $r('sys.color.font_secondary') : $r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(18)
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .opacity(this.signFileName === '' ? 0.6 : 0.9)
                        }
                        .alignItems(HorizontalAlign.Start)
                        .layoutWeight(1)
                        .margin({ left: 12 })

                        // ç®­å¤´å›¾æ ‡
                        Image($r('app.media.right_arrow'))
                          .height(20)
                          .width(20)
                          .margin({ left: 8 })
                          .opacity(0.5)
                      }
                      .width('100%')
                      .height('100%')
                    }
                    .width('100%')
                    .height('100%')
                  }
                  .width('100%')
                  .height(72)
                  .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                  .backgroundColor(0xFFFFFF)
                  .borderRadius(12)
                  .shadow({
                    radius: 8,
                    color: 0x1A000000,
                    offsetX: 0,
                    offsetY: 2
                  })
                  .onClick(() => {
                    if (!this.isProcessing) {
                      this.selectSignFileAndRead();
                    }
                  })
                }
                .width('100%')
                .padding({ top: 8, bottom: 16 })
              }
              .width('100%')
              .backgroundColor(0xFFFFFF)
              .borderRadius(20)
              .padding({ top: 0, bottom: 0 })
              .shadow({
                radius: 12,
                color: 0x1F000000,
                offsetX: 0,
                offsetY: 4
              })
            }
          }
          .width('100%')
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })

          // æ–‡ä»¶å†…å®¹æ˜¾ç¤ºåŒºåŸŸ
          GridRow() {
            GridCol({ span: { xs: 12, sm: 12, md: 12, lg: 12 } }) {
              Column() {
                // æ ‡é¢˜æ 
                Row() {
                  Row() {
                    Text('ğŸ“')
                      .fontSize(18)
                      .margin({ right: 8 })
                    Text($r('app.string.text_context'))
                      .fontSize(18)
                      .fontWeight(600)
                      .fontColor($r('sys.color.font_primary'))
                      .lineHeight(24)
                  }
                  .alignItems(VerticalAlign.Center)
                  .width('100%')
                }
                .width('100%')
                .height(56)
                .padding({ left: 20, right: 20 })
                .justifyContent(FlexAlign.Start)

                // åˆ†éš”çº¿
                Divider()
                  .color(0xE5E5E5)
                  .strokeWidth(1)
                  .margin({ left: 20, right: 20 })

                // å†…å®¹åŒºåŸŸ
                Column({ space: 12 }) {
                  Row() {
                    Scroll() {
                      Column({ space: 10 }) {
                        Text() {
                          Span(this.plainText || $r('app.string.please_choose'))
                            .fontSize(15)
                            .fontWeight(400)
                            .fontColor($r('sys.color.font_primary'))
                        }
                        .textAlign(TextAlign.Start)
                        .lineHeight(22)
                        .maxLines(10)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                      }
                      .width('100%')
                    }
                    .width('100%')
                    .height(140)
                    .scrollBar(BarState.Auto)
                  }
                  .width('100%')
                  .padding({ left: 20, right: 20, top: 8, bottom: 16 })
                }
                .width('100%')
              }
              .width('100%')
              .backgroundColor(0xFFFFFF)
              .borderRadius(20)
              .padding({ top: 0, bottom: 0 })
              .shadow({
                radius: 12,
                color: 0x1F000000,
                offsetX: 0,
                offsetY: 4
              })
            }
          }
          .width('100%')
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })

          // éªŒç­¾ç»“æœæ˜¾ç¤ºåŒºåŸŸ
          if (this.verifyResult) {
            GridRow() {
              GridCol({ span: { xs: 12, sm: 12, md: 12, lg: 12 } }) {
                Column() {
                  // æ ‡é¢˜æ 
                  Row() {
                    Row() {
                      Text(this.verifyResult === 'éªŒç­¾æˆåŠŸ' ? 'âœ…' : this.verifyResult === 'éªŒç­¾å¤±è´¥' ? 'âŒ' : 'âš ï¸')
                        .fontSize(18)
                        .margin({ right: 8 })
                      Text('éªŒç­¾ç»“æœ')
                        .fontSize(18)
                        .fontWeight(600)
                        .fontColor($r('sys.color.font_primary'))
                        .lineHeight(24)
                    }
                    .alignItems(VerticalAlign.Center)
                    .width('100%')
                  }
                  .width('100%')
                  .height(56)
                  .padding({ left: 20, right: 20 })
                  .justifyContent(FlexAlign.Start)

                  // åˆ†éš”çº¿
                  Divider()
                    .color(0xE5E5E5)
                    .strokeWidth(1)
                    .margin({ left: 20, right: 20 })

                  // å†…å®¹åŒºåŸŸ
                  Column({ space: 12 }) {
                    Row() {
                      Scroll() {
                        Column({ space: 10 }) {
                          Text(this.verifyResult)
                            .fontSize(16)
                            .fontWeight(600)
                            .fontColor(this.verifyResult === 'éªŒç­¾æˆåŠŸ' ? 0xFF1E8E3E : 
                                      this.verifyResult === 'éªŒç­¾å¤±è´¥' ? 0xFFF44336 : 
                                      $r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(24)

                          if (this.verifyDetails) {
                            Divider()
                              .color(0xF0F0F0)
                              .strokeWidth(1)
                              .margin({ top: 4, bottom: 4 })

                            Text(this.verifyDetails)
                              .fontSize(13)
                              .fontWeight(400)
                              .fontColor($r('sys.color.font_secondary'))
                              .textAlign(TextAlign.Start)
                              .lineHeight(20)
                              .opacity(0.85)
                          }
                        }
                        .width('100%')
                      }
                      .width('100%')
                      .height(120)
                      .scrollBar(BarState.Auto)
                    }
                    .width('100%')
                    .padding({ left: 20, right: 20, top: 8, bottom: 16 })
                  }
                  .width('100%')
                }
                .width('100%')
                .backgroundColor(this.verifyResult === 'éªŒç­¾æˆåŠŸ' ? 0xFFE8F5E9 : 
                                this.verifyResult === 'éªŒç­¾å¤±è´¥' ? 0xFFFFEBEE : 
                                0xFFFFFF)
                .borderRadius(20)
                .padding({ top: 0, bottom: 0 })
                .shadow({
                  radius: 12,
                  color: 0x1F000000,
                  offsetX: 0,
                  offsetY: 4
                })
              }
            }
            .width('100%')
            .margin({ left: 16, right: 16, top: 8, bottom: 8 })
          }

          // æ“ä½œæŒ‰é’®åŒºåŸŸ
          Column({ space: 16 }) {
            // éªŒç­¾æŒ‰é’®
            Button() {
              Row() {
                if (this.isProcessing) {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                    .color($r('sys.color.comp_background_list_card'))
                    .margin({ right: 8 })
                } else {
                  Text('ğŸ”')
                    .fontSize(18)
                    .margin({ right: 8 })
                }
                Text($r('app.string.verify'))
                  .fontSize(16)
                  .fontWeight(600)
                  .lineHeight(22)
                  .fontColor($r('sys.color.comp_background_list_card'))
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)
            }
            .borderRadius(24)
            .id('verifyBtn')
            .type(ButtonType.Capsule)
            .width('100%')
            .height(52)
            .backgroundColor($r('sys.color.brand'))
            .enabled(!this.isProcessing && !!this.textFileUri && !!this.keyString && !!this.signData)
            .opacity((!this.isProcessing && !!this.textFileUri && !!this.keyString && !!this.signData) ? 1.0 : 0.5)
            .shadow({
              radius: 8,
              color: 0x33000000,
              offsetX: 0,
              offsetY: 2
            })
            .onClick(() => {
              if (this.textFileUri === '' || this.keyString === '' || this.signData === '') {
                this.getUIContext().getPromptAction().showToast({
                  message: $r('app.string.null_message')
                });
              } else {
                this.verifyFunc();
              }
            })

            // å¤„ç†çŠ¶æ€æŒ‡ç¤ºå™¨
            if (this.isProcessing) {
              Row() {
                LoadingProgress()
                  .width(24)
                  .height(24)
                  .color($r('sys.color.brand'))
                Text('æ­£åœ¨å¤„ç†ä¸­...')
                  .fontSize(14)
                  .fontWeight(400)
                  .fontColor($r('sys.color.font_secondary'))
                  .margin({ left: 12 })
                  .opacity(0.8)
              }
              .width('100%')
              .height(40)
              .justifyContent(FlexAlign.Center)
              .margin({ top: 8 })
            }
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 8, bottom: 24 })
        }
        .width('100%')
        .padding({ top: 8, bottom: 16 })
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Auto)
      .scrollable(ScrollDirection.Vertical)
    }
    .width('100%')
    .height('100%')
  }

  /**
   * é€‰æ‹©å¹¶è¯»å–RSAå…¬é’¥æ–‡ä»¶
   */
  async selectRsaKeyFileAndRead() {
    this.isProcessing = true;
    try {
      let context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      let documentPicker = new picker.DocumentViewPicker(context);
      let documentSelectOptions = new picker.DocumentSelectOptions();

      let uris = await documentPicker.select(documentSelectOptions);
      const windowClass = await window.getLastWindow(context);

      if (uris && uris.length > 0) {
        this.keyFileUri = uris[0];
        this.keyFileName = this.getFileNameFromUri(this.keyFileUri);

        // ä½¿ç”¨TextFileManagerè¯»å–å¯†é’¥æ–‡ä»¶
        const readResult = await TextFileManager.readTextFile(this.keyFileUri);
        if (readResult.success) {
          try {
            const decoder = new util.TextDecoder('utf-8');
            const uint8 = new Uint8Array(readResult.data as ArrayBuffer);
            // éœ€è¦å®Œæ•´å…¬é’¥å†…å®¹ç”¨äºéªŒè¯ï¼Œä¸åº”æˆªæ–­ä¸ºå‰ 2000 å­—èŠ‚
            this.keyString = decoder.decode(uint8);
          } catch (decodeError) {
            Logger.error(TAG, `Binary decode error: ${decodeError.code}`);
            this.keyString = "å¯†é’¥å†…å®¹é¢„è§ˆä¸å¯ç”¨";
          }
          windowClass.getUIContext().getPromptAction().showToast({
            message: 'å…¬é’¥æ–‡ä»¶è¯»å–æˆåŠŸ'
          });
        } else {
          windowClass.getUIContext().getPromptAction().showToast({
            message: 'å…¬é’¥æ–‡ä»¶è¯»å–å¤±è´¥'
          });
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æœªé€‰æ‹©æ–‡ä»¶'
        });
      }
    } catch (error) {
      Logger.error(TAG, `selectRsaKeyFileAndRead failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({
        message: 'é€‰æ‹©æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•'
      });
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * é€‰æ‹©å¹¶è¯»å–å¾…éªŒç­¾çš„æ–‡ä»¶
   */
  async selectTextFileAndRead() {
    this.isProcessing = true;
    try {
      let context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      let documentPicker = new picker.DocumentViewPicker(context);
      let documentSelectOptions = new picker.DocumentSelectOptions();

      let uris = await documentPicker.select(documentSelectOptions);
      const windowClass = await window.getLastWindow(context);

      if (uris && uris.length > 0) {
        this.textFileUri = uris[0];
        this.textFileName = this.getFileNameFromUri(this.textFileUri);

        // ä½¿ç”¨TextFileManagerè¯»å–æ–‡ä»¶
        const readResult = await TextFileManager.readTextFile(this.textFileUri);
        if (readResult.success) {
          try {
            const decoder = new util.TextDecoder('utf-8');
            const uint8 = new Uint8Array(readResult.data as ArrayBuffer);
            const dataSlice = uint8.slice(0, 1000);
            this.plainText = decoder.decode(dataSlice);
          } catch (decodeError) {
            Logger.error(TAG, `Binary decode error: ${decodeError.code}`);
            this.plainText = "äºŒè¿›åˆ¶å†…å®¹é¢„è§ˆä¸å¯ç”¨";
          }
          windowClass.getUIContext().getPromptAction().showToast({
            message: 'æ–‡ä»¶è¯»å–æˆåŠŸ'
          });
        } else {
          windowClass.getUIContext().getPromptAction().showToast({
            message: 'æ–‡ä»¶è¯»å–å¤±è´¥'
          });
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æœªé€‰æ‹©æ–‡ä»¶'
        });
      }
    } catch (error) {
      Logger.error(TAG, `selectTextFileAndRead failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({
        message: 'é€‰æ‹©æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•'
      });
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * é€‰æ‹©å¹¶è¯»å–ç­¾åæ–‡ä»¶
   */
  async selectSignFileAndRead() {
    this.isProcessing = true;
    try {
      let context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      let documentPicker = new picker.DocumentViewPicker(context);
      let documentSelectOptions = new picker.DocumentSelectOptions();

      let uris = await documentPicker.select(documentSelectOptions);
      const windowClass = await window.getLastWindow(context);

      if (uris && uris.length > 0) {
        this.signFileUri = uris[0];
        this.signFileName = this.getFileNameFromUri(this.signFileUri);

        // è¯»å–ç­¾åæ–‡ä»¶
        const readResult = await TextFileManager.readTextFile(this.signFileUri);
        if (readResult.success) {
          const fileData = readResult.data as ArrayBuffer;

          // å°è¯•è§£æå…ƒæ•°æ®å¤´
          const parseResult = MetadataHelper.parseDataWithMetadata(fileData);

          if (parseResult.success && parseResult.data) {
            // æå–çº¯ç­¾åæ•°æ®
            const signatureArray = new Uint8Array(parseResult.data);
            this.signData = this.uint8ArrayToBase64(signatureArray);

            // æ˜¾ç¤ºå…ƒæ•°æ®ä¿¡æ¯
            if (parseResult.metadata) {
              this.verifyDetails = `æ£€æµ‹åˆ°ç­¾åå…ƒæ•°æ®:\n` +
                `åŸå§‹æ ¼å¼: ${parseResult.metadata.originalExtension}\n` +
                `ç­¾åç®—æ³•: ${parseResult.metadata.algorithm || 'æœªçŸ¥'}\n` +
                `ç­¾åæ—¶é—´: ${new Date(parseResult.metadata.timestamp).toLocaleString()}`;
            }
          } else {
            // å¦‚æœæ²¡æœ‰å…ƒæ•°æ®å¤´ï¼Œå‡è®¾æ˜¯çº¯ç­¾åæ•°æ®
            const signatureArray = new Uint8Array(fileData);
            this.signData = this.uint8ArrayToBase64(signatureArray);
          }

          windowClass.getUIContext().getPromptAction().showToast({
            message: 'ç­¾åæ–‡ä»¶è¯»å–æˆåŠŸ'
          });
        } else {
          windowClass.getUIContext().getPromptAction().showToast({
            message: 'ç­¾åæ–‡ä»¶è¯»å–å¤±è´¥'
          });
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æœªé€‰æ‹©æ–‡ä»¶'
        });
      }
    } catch (error) {
      Logger.error(TAG, `selectSignFileAndRead failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({
        message: 'é€‰æ‹©æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•'
      });
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼
   */
  async calculateFileHash() {
    this.isProcessing = true;
    try {
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);

      // è¯»å–æ–‡ä»¶æ•°æ®
      const readResult = await TextFileManager.readTextFile(this.textFileUri);
      if (!readResult.success) {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æ–‡ä»¶è¯»å–å¤±è´¥'
        });
        return;
      }

      const fileData = readResult.data as ArrayBuffer;

      // æ‰‹åŠ¨å“ˆå¸Œè®¡ç®—å·²ç§»é™¤ï¼›ç­¾å/éªŒç­¾æµç¨‹ä¼šè‡ªåŠ¨å¤„ç†å“ˆå¸Œ
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * éªŒç­¾åŠŸèƒ½ä¸»å‡½æ•°
   */
  async verifyFunc() {
    this.isProcessing = true;
    const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);

    // é‡ç½®éªŒç­¾ç»“æœ
    this.verifyResult = '';
    this.verifyDetails = '';

    if (this.textFileUri === '' || this.keyString === '' || this.signData === '') {
      windowClass.getUIContext().getPromptAction().showToast({
        message: $r('app.string.null_message')
      });
      this.isProcessing = false;
      return;
    }

    try {
      // è¯»å–åŸå§‹æ–‡ä»¶æ•°æ®
      const readResult = await TextFileManager.readTextFile(this.textFileUri);
      if (!readResult.success) {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æ–‡ä»¶è¯»å–å¤±è´¥'
        });
        this.isProcessing = false;
        return;
      }

      let fileData: ArrayBuffer | string = readResult.data;
      if (typeof fileData !== 'string') {
        fileData = fileData as ArrayBuffer;
      }

      // å‡†å¤‡ç­¾åæ•°æ®ï¼ˆå¯èƒ½æ˜¯Base64æˆ–åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰
      let signatureData: ArrayBuffer;
      if (this.isBase64(this.signData)) {
        // Base64ç¼–ç çš„ç­¾åæ•°æ®
        signatureData = this.base64ToUint8Array(this.signData).buffer;
      } else if (this.isHexString(this.signData)) {
        // åå…­è¿›åˆ¶ç¼–ç çš„ç­¾åæ•°æ®
        signatureData = this.hexStringToUint8Array(this.signData).buffer;
      } else {
        // å‡è®¾æ˜¯åŸå§‹å­—ç¬¦ä¸²æ•°æ®
        const encoder = new util.TextEncoder();
        signatureData = encoder.encode(this.signData).buffer;
      }

      let verifyResult: boolean = false;

      // æ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©éªŒç­¾æ–¹æ³• [1,4](@ref)
      if (typeof fileData === 'string') {
        // å­—ç¬¦ä¸²æ•°æ®ä½¿ç”¨å­—ç¬¦ä¸²éªŒç­¾æ–¹æ³•
        verifyResult = !!(await this.CryptoOperation.rsaConvertAndVerify(
          this.keyString, fileData, this.signData
        ));
      } else {
        // äºŒè¿›åˆ¶æ•°æ®ä½¿ç”¨äºŒè¿›åˆ¶éªŒç­¾æ–¹æ³• [6](@ref)
        const binaryVerifyResult = await this.CryptoOperation.rsaConvertAndVerifyBinary(
          this.keyString, fileData as ArrayBuffer, signatureData
        );
        verifyResult = binaryVerifyResult.valid === true;
      }

      // æ˜¾ç¤ºéªŒç­¾ç»“æœ
      const verifyTime = new Date().toLocaleString();
      if (verifyResult) {
        this.verifyResult = 'éªŒç­¾æˆåŠŸ';
        this.verifyDetails = `æ–‡ä»¶å®Œæ•´æ€§éªŒè¯é€šè¿‡\néªŒç­¾æ—¶é—´: ${verifyTime}\næ–‡ä»¶æ¥æºå¯ä¿¡`;

        windowClass.getUIContext().getPromptAction().showToast({
          message: $r('app.string.verify_success')
        });

        Logger.info(TAG, `æ–‡ä»¶éªŒç­¾æˆåŠŸï¼ŒéªŒç­¾æ—¶é—´: ${verifyTime}`);
      } else {
        this.verifyResult = 'éªŒç­¾å¤±è´¥';
        this.verifyDetails = `æ–‡ä»¶å¯èƒ½å·²è¢«ç¯¡æ”¹æˆ–ç­¾åæ— æ•ˆ\néªŒç­¾æ—¶é—´: ${verifyTime}\nå»ºè®®é‡æ–°è·å–åŸå§‹æ–‡ä»¶`;

        windowClass.getUIContext().getPromptAction().showToast({
          message: $r('app.string.verify_fail')
        });

        Logger.warn(TAG, `æ–‡ä»¶éªŒç­¾å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²è¢«ç¯¡æ”¹`);
      }

    } catch (error) {
      Logger.error(TAG, `verify failed, ${error.code}, ${error.message}`);
      this.verifyResult = 'éªŒç­¾è¿‡ç¨‹å‡ºé”™';
      this.verifyDetails = `éªŒç­¾è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}\nè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œå¯†é’¥æ˜¯å¦æ­£ç¡®`;

      windowClass.getUIContext().getPromptAction().showToast({
        message: 'éªŒç­¾è¿‡ç¨‹å‘ç”Ÿé”™è¯¯'
      });
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * ä»æ–‡ä»¶URIä¸­æå–æ–‡ä»¶å
   */
  private getFileNameFromUri(uri: string): string {
    if (!uri) return 'æœªçŸ¥æ–‡ä»¶';
    try {
      const segments = uri.split('/');
      let name = segments[segments.length - 1] || 'æœªçŸ¥æ–‡ä»¶';
      try {
        name = decodeURIComponent(name);
      } catch (e) {
        try { name = decodeURI(name); } catch (_) { }
      }
      if (name.startsWith('file://')) {
        const parts = name.split('/');
        name = parts[parts.length - 1] || name;
      }
      return name;
    } catch (e) {
      return uri;
    }
  }

  /**
   * æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä¸ºBase64ç¼–ç 
   */
  private isBase64(str: string): boolean {
    try {
      const base64Helper = new util.Base64Helper();
      // å°è¯•è§£ç ï¼Œå¦‚æœæˆåŠŸåˆ™è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„Base64
      base64Helper.decodeSync(str);
      return true;
    } catch (err) {
      return false;
    }
  }

  /**
   * æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä¸ºåå…­è¿›åˆ¶ç¼–ç 
   */
  // é¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼æå‡æ€§èƒ½
  private readonly HEX_REGEX: RegExp = new RegExp("^[0-9A-Fa-f]+$");

  private isHexString(str: string): boolean {
    return str.length > 0 && this.HEX_REGEX.test(str);
  }

  /**
   * Base64å­—ç¬¦ä¸²è½¬æ¢ä¸ºUint8Array
   */
  private base64ToUint8Array(base64: string): Uint8Array {
    try {
      const base64Helper = new util.Base64Helper();
      return base64Helper.decodeSync(base64);
    } catch (error) {
      Logger.error(TAG, `Base64è§£ç å¤±è´¥: ${error.message}`);
      return new Uint8Array(0);
    }
  }

  /**
   * åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸ºUint8Array
   */
  private hexStringToUint8Array(hexString: string): Uint8Array {
    try {
      const bytes = new Uint8Array(hexString.length / 2);
      for (let i = 0; i < hexString.length; i += 2) {
        bytes[i / 2] = parseInt(hexString.substr(i, 2), 16);
      }
      return bytes;
    } catch (error) {
      Logger.error(TAG, `åå…­è¿›åˆ¶è§£ç å¤±è´¥: ${error.message}`);
      return new Uint8Array(0);
    }
  }

  /**
   * Uint8Arrayè½¬æ¢ä¸ºBase64å­—ç¬¦ä¸²
   */
  private uint8ArrayToBase64(uint8Array: Uint8Array): string {
    try {
      const base64Helper = new util.Base64Helper();
      return base64Helper.encodeToStringSync(uint8Array);
    } catch (error) {
      Logger.error(TAG, `Base64ç¼–ç å¤±è´¥: ${error.message}`);
      return '';
    }
  }
}