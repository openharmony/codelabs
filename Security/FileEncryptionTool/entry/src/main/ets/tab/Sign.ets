/*
 * Copyright (c) 2026 Beijing Institute of Technology
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import Logger from '../util/Logger';
import picker from '@ohos.file.picker';
import { CryptoOperation } from '../cryptoframework/CryptoOperation';
import TextFileManager from '../textfilemanager/TextFileManager';
import common from '@ohos.app.ability.common';
import window from '@ohos.window';
import { util } from '@kit.ArkTS';
import { MetadataHelper } from '../util/MetadataHelper';

const TAG: string = '[Crypto_Framework]';

// å®šä¹‰å…ƒæ•°æ®æ¥å£
interface FileMetadata {
  originalExtension: string;
  timestamp: string;
  version: string;
  fileSize?: number;
  signatureAlgorithm?: string;
}

@Component
export struct Sign {
  // çŠ¶æ€å˜é‡
  @State fileHash: string = '';
  @State originalExtension: string = '';
  @State isProcessing: boolean = false;
  @State signResult: string = '';
  @State signatureHex: string = ''; // ç­¾ååå…­è¿›åˆ¶æ˜¾ç¤º

  @State keyFileName: string = '';
  @State keyFileUri: string = '';
  @State textFileUri: string = '';
  @State textFileName: string = '';
  @State keyString: string = '';
  @State cipherText: string = '';
  @State plainText: string = '';
  @State message: string = '';
  @State signFileUri: string = '';
  @State createKeyUri: string = '';
  @State fileSize: number = 0; // æ–‡ä»¶å¤§å°

  private CryptoOperation: CryptoOperation = new CryptoOperation();

  build() {
    Stack({ alignContent: Alignment.TopStart }) {
      // èƒŒæ™¯æ¸å˜è£…é¥°å±‚
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 180,
          colors: [[0xF5F7FA, 0.0], [0xE8ECF1, 1.0]]
        })

      // ä¸»å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 16 }) {
          // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
          Row() {
            Column() {
              Text('æ–‡ä»¶ç­¾å')
                .fontSize(24)
                .fontWeight(600)
                .fontColor($r('sys.color.font_primary'))
                .lineHeight(32)
              
              Text('å®‰å…¨å¯é çš„æ•°å­—ç­¾åå·¥å…·')
                .fontSize(14)
                .fontWeight(400)
                .fontColor($r('sys.color.font_secondary'))
                .margin({ top: 4 })
                .opacity(0.8)
            }
            .alignItems(HorizontalAlign.Center)
            .width('100%')
          }
          .width('100%')
          .padding({ left: 24, right: 24, top: 16, bottom: 8 })

          // æ–‡ä»¶é€‰æ‹©å¡ç‰‡åŒºåŸŸ
          GridRow() {
            GridCol({ span: { xs: 12, sm: 12, md: 12, lg: 12 } }) {
              Column() {
                // å¡ç‰‡æ ‡é¢˜
                Row() {
                  Column() {
                    Text('æ–‡ä»¶é€‰æ‹©')
                      .fontSize(18)
                      .fontWeight(600)
                      .fontColor($r('sys.color.font_primary'))
                      .lineHeight(24)
                  }
                  .alignItems(HorizontalAlign.Start)
                  .width('100%')
                }
                .width('100%')
                .padding({ left: 20, right: 20, top: 16, bottom: 12 })

                // åˆ†éš”çº¿
                Divider()
                  .color(0xE5E5E5)
                  .strokeWidth(1)
                  .margin({ left: 20, right: 20 })

                // æ–‡ä»¶é€‰æ‹©åˆ—è¡¨
                Column({ space: 12 }) {
                  // å¾…ç­¾åæ–‡ä»¶é€‰æ‹©é¡¹
                  Row() {
                    Column() {
                      Row() {
                        // å›¾æ ‡åŒºåŸŸ
                        Row() {
                          Text('ğŸ“„')
                            .fontSize(20)
                            .fontWeight(400)
                        }
                        .width(40)
                        .height(40)
                        .borderRadius(8)
                        .backgroundColor(0xF0F4F8)
                        .justifyContent(FlexAlign.Center)

                        // æ–‡æœ¬åŒºåŸŸ
                        Column({ space: 4 }) {
                          Text($r('app.string.open_file'))
                            .fontSize(16)
                            .fontWeight(500)
                            .fontColor($r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(22)

                          Text(this.textFileName === '' ? $r('app.string.please_choose') : this.textFileName)
                            .fontSize(13)
                            .fontWeight(400)
                            .fontColor(this.textFileName === '' ? $r('sys.color.font_secondary') : $r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(18)
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .opacity(this.textFileName === '' ? 0.6 : 0.9)
                        }
                        .alignItems(HorizontalAlign.Start)
                        .layoutWeight(1)
                        .margin({ left: 12 })

                        // ç®­å¤´å›¾æ ‡
                        Image($r('app.media.right_arrow'))
                          .height(20)
                          .width(20)
                          .margin({ left: 8 })
                          .opacity(0.5)
                      }
                      .width('100%')
                      .height('100%')
                    }
                    .width('100%')
                    .height('100%')
                  }
                  .width('100%')
                  .height(72)
                  .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                  .backgroundColor(0xFFFFFF)
                  .borderRadius(12)
                  .shadow({
                    radius: 8,
                    color: 0x1A000000,
                    offsetX: 0,
                    offsetY: 2
                  })
                  .onClick(() => {
                    if (!this.isProcessing) {
                      this.selectTextFileAndRead();
                    }
                  })

                  // RSAå¯†é’¥æ–‡ä»¶é€‰æ‹©é¡¹
                  Row() {
                    Column() {
                      Row() {
                        // å›¾æ ‡åŒºåŸŸ
                        Row() {
                          Text('ğŸ”')
                            .fontSize(20)
                            .fontWeight(400)
                        }
                        .width(40)
                        .height(40)
                        .borderRadius(8)
                        .backgroundColor(0xFFE8F5E9)
                        .justifyContent(FlexAlign.Center)

                        // æ–‡æœ¬åŒºåŸŸ
                        Column({ space: 4 }) {
                          Text($r('app.string.select_key_file'))
                            .fontSize(16)
                            .fontWeight(500)
                            .fontColor($r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(22)

                          Text(this.keyFileName === '' ? $r('app.string.please_choose') : this.keyFileName)
                            .fontSize(13)
                            .fontWeight(400)
                            .fontColor(this.keyFileName === '' ? $r('sys.color.font_secondary') : $r('sys.color.font_primary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(18)
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .opacity(this.keyFileName === '' ? 0.6 : 0.9)
                        }
                        .alignItems(HorizontalAlign.Start)
                        .layoutWeight(1)
                        .margin({ left: 12 })

                        // ç®­å¤´å›¾æ ‡
                        Image($r('app.media.right_arrow'))
                          .height(20)
                          .width(20)
                          .margin({ left: 8 })
                          .opacity(0.5)
                      }
                      .width('100%')
                      .height('100%')
                    }
                    .width('100%')
                    .height('100%')
                  }
                  .width('100%')
                  .height(72)
                  .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                  .backgroundColor(0xFFFFFF)
                  .borderRadius(12)
                  .shadow({
                    radius: 8,
                    color: 0x1A000000,
                    offsetX: 0,
                    offsetY: 2
                  })
                  .onClick(() => {
                    if (!this.isProcessing) {
                      this.selectRsaKeyFileAndRead();
                    }
                  })
                }
                .width('100%')
                .padding({ top: 8, bottom: 16 })
              }
              .width('100%')
              .backgroundColor(0xFFFFFF)
              .borderRadius(20)
              .padding({ top: 0, bottom: 0 })
              .shadow({
                radius: 12,
                color: 0x1F000000,
                offsetX: 0,
                offsetY: 4
              })
            }
          }
          .width('100%')
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })

          // ç­¾åç»“æœæ˜¾ç¤ºåŒºåŸŸ
          GridRow() {
            GridCol({ span: { xs: 12, sm: 12, md: 12, lg: 12 } }) {
              Column() {
                // æ ‡é¢˜æ 
                Row() {
                  Row() {
                    Text('âœï¸')
                      .fontSize(18)
                      .margin({ right: 8 })
                    Text($r('app.string.signature_result'))
                      .fontSize(18)
                      .fontWeight(600)
                      .fontColor($r('sys.color.font_primary'))
                      .lineHeight(24)
                  }
                  .alignItems(VerticalAlign.Center)
                  .width('100%')
                }
                .width('100%')
                .height(56)
                .padding({ left: 20, right: 20 })
                .justifyContent(FlexAlign.Start)

                // åˆ†éš”çº¿
                Divider()
                  .color(0xE5E5E5)
                  .strokeWidth(1)
                  .margin({ left: 20, right: 20 })

                // å†…å®¹åŒºåŸŸ
                Column({ space: 12 }) {
                  Row() {
                    Scroll() {
                      Column({ space: 10 }) {
                        Text(this.signResult || 'æš‚æ— ç­¾åç»“æœ')
                          .fontSize(15)
                          .fontWeight(400)
                          .fontColor($r('sys.color.font_primary'))
                          .textAlign(TextAlign.Start)
                          .lineHeight(22)

                        if (this.signatureHex) {
                          Divider()
                            .color(0xF0F0F0)
                            .strokeWidth(1)
                            .margin({ top: 4, bottom: 4 })

                          Text('ç­¾åå€¼: ' + this.signatureHex.substring(0, 64) + '...')
                            .fontSize(13)
                            .fontWeight(400)
                            .fontColor($r('sys.color.font_secondary'))
                            .textAlign(TextAlign.Start)
                            .lineHeight(20)
                            .opacity(0.85)
                        }
                      }
                      .width('100%')
                    }
                    .width('100%')
                    .height(140)
                    .scrollBar(BarState.Auto)
                  }
                  .width('100%')
                  .padding({ left: 20, right: 20, top: 8, bottom: 16 })
                }
                .width('100%')
              }
              .width('100%')
              .backgroundColor(0xFFFFFF)
              .borderRadius(20)
              .padding({ top: 0, bottom: 0 })
              .shadow({
                radius: 12,
                color: 0x1F000000,
                offsetX: 0,
                offsetY: 4
              })
            }
          }
          .width('100%')
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })

          // æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ
          GridRow() {
            GridCol({ span: { xs: 12, sm: 12, md: 12, lg: 12 } }) {
              Column() {
                // æ ‡é¢˜æ 
                Row() {
                  Row() {
                    Text('â„¹ï¸')
                      .fontSize(18)
                      .margin({ right: 8 })
                    Text($r('app.string.file_info'))
                      .fontSize(18)
                      .fontWeight(600)
                      .fontColor($r('sys.color.font_primary'))
                      .lineHeight(24)
                  }
                  .alignItems(VerticalAlign.Center)
                  .width('100%')
                }
                .width('100%')
                .height(56)
                .padding({ left: 20, right: 20 })
                .justifyContent(FlexAlign.Start)

                // åˆ†éš”çº¿
                Divider()
                  .color(0xE5E5E5)
                  .strokeWidth(1)
                  .margin({ left: 20, right: 20 })

                // ä¿¡æ¯é¡¹åˆ—è¡¨
                Column({ space: 16 }) {
                  // æ–‡ä»¶å¤§å°æ˜¾ç¤º
                  Row() {
                    Row() {
                      Text('ğŸ“')
                        .fontSize(16)
                        .margin({ right: 12 })
                      Column({ space: 2 }) {
                        Text('æ–‡ä»¶å¤§å°')
                          .fontSize(13)
                          .fontWeight(400)
                          .fontColor($r('sys.color.font_secondary'))
                          .opacity(0.7)
                        Text(this.fileSize ? this.formatFileSize(this.fileSize) : 'æœªçŸ¥')
                          .fontSize(15)
                          .fontWeight(500)
                          .fontColor($r('sys.color.font_primary'))
                      }
                      .alignItems(HorizontalAlign.Start)
                    }
                    .width('100%')
                    .justifyContent(FlexAlign.Start)
                  }
                  .width('100%')
                  .height(48)
                  .padding({ left: 20, right: 20 })

                  // åˆ†éš”çº¿
                  Divider()
                    .color(0xF5F5F5)
                    .strokeWidth(1)
                    .margin({ left: 20, right: 20 })

                  // åŸå§‹æ ¼å¼æ˜¾ç¤º
                  Row() {
                    Row() {
                      Text('ğŸ“‹')
                        .fontSize(16)
                        .margin({ right: 12 })
                      Column({ space: 2 }) {
                        Text('åŸå§‹æ ¼å¼')
                          .fontSize(13)
                          .fontWeight(400)
                          .fontColor($r('sys.color.font_secondary'))
                          .opacity(0.7)
                        Text(this.originalExtension || 'æœªçŸ¥')
                          .fontSize(15)
                          .fontWeight(500)
                          .fontColor($r('sys.color.font_primary'))
                      }
                      .alignItems(HorizontalAlign.Start)
                    }
                    .width('100%')
                    .justifyContent(FlexAlign.Start)
                  }
                  .width('100%')
                  .height(48)
                  .padding({ left: 20, right: 20, bottom: 16 })
                }
                .width('100%')
                .padding({ top: 8 })
              }
              .width('100%')
              .backgroundColor(0xFFFFFF)
              .borderRadius(20)
              .padding({ top: 0, bottom: 0 })
              .shadow({
                radius: 12,
                color: 0x1F000000,
                offsetX: 0,
                offsetY: 4
              })
            }
          }
          .width('100%')
          .margin({ left: 16, right: 16, top: 8, bottom: 8 })

          // æ“ä½œæŒ‰é’®åŒºåŸŸ
          Column({ space: 16 }) {
            // ç”ŸæˆRSAå¯†é’¥æŒ‰é’®
            Button() {
              Row() {
                Text('ğŸ”')
                  .fontSize(18)
                  .margin({ right: 8 })
                Text($r('app.string.generate_rsa_key_randomly'))
                  .fontSize(16)
                  .fontWeight(600)
                  .lineHeight(22)
                  .fontColor($r('sys.color.comp_background_list_card'))
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)
            }
            .id('encryptRsaGenKey')
            .borderRadius(24)
            .type(ButtonType.Capsule)
            .width('100%')
            .height(52)
            .backgroundColor($r('sys.color.brand'))
            .enabled(!this.isProcessing)
            .opacity(!this.isProcessing ? 1.0 : 0.5)
            .shadow({
              radius: 8,
              color: 0x33000000,
              offsetX: 0,
              offsetY: 2
            })
            .onClick(() => {
              this.genRsaKey();
            })

            // ç­¾åæŒ‰é’®
            Button() {
              Row() {
                if (this.isProcessing) {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                    .color($r('sys.color.comp_background_list_card'))
                    .margin({ right: 8 })
                } else {
                  Text('âœï¸')
                    .fontSize(18)
                    .margin({ right: 8 })
                }
                Text($r('app.string.sign'))
                  .fontSize(16)
                  .fontWeight(600)
                  .lineHeight(22)
                  .fontColor($r('sys.color.comp_background_list_card'))
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)
            }
            .borderRadius(24)
            .id('signBtn')
            .type(ButtonType.Capsule)
            .width('100%')
            .height(52)
            .backgroundColor($r('sys.color.brand'))
            .enabled(!this.isProcessing && !!this.textFileUri && !!this.keyString)
            .opacity((!this.isProcessing && !!this.textFileUri && !!this.keyString) ? 1.0 : 0.5)
            .shadow({
              radius: 8,
              color: 0x33000000,
              offsetX: 0,
              offsetY: 2
            })
            .onClick(() => {
              if (this.textFileUri === '' || this.keyString === '') {
                this.getUIContext().getPromptAction().showToast({
                  message: $r('app.string.null_message')
                });
              } else {
                this.signFunc();
              }
            })

            // å¤„ç†çŠ¶æ€æŒ‡ç¤ºå™¨
            if (this.isProcessing) {
              Row() {
                LoadingProgress()
                  .width(24)
                  .height(24)
                  .color($r('sys.color.brand'))
                Text('æ­£åœ¨å¤„ç†ä¸­...')
                  .fontSize(14)
                  .fontWeight(400)
                  .fontColor($r('sys.color.font_secondary'))
                  .margin({ left: 12 })
                  .opacity(0.8)
              }
              .width('100%')
              .height(40)
              .justifyContent(FlexAlign.Center)
              .margin({ top: 8 })
            }
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 8, bottom: 24 })
        }
        .width('100%')
        .padding({ top: 8, bottom: 16 })
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Auto)
      .scrollable(ScrollDirection.Vertical)
    }
    .width('100%')
    .height('100%')
  }

  /**
   * é€‰æ‹©å¹¶è¯»å–RSAå¯†é’¥æ–‡ä»¶
   */
  async selectRsaKeyFileAndRead() {
    this.isProcessing = true;
    try {
      let context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      let documentPicker = new picker.DocumentViewPicker(context);
      let documentSelectOptions = new picker.DocumentSelectOptions();

      let uris = await documentPicker.select(documentSelectOptions);
      const windowClass = await window.getLastWindow(context);

      if (uris && uris.length > 0) {
        this.keyFileUri = uris[0];
        this.keyFileName = this.getFileNameFromUri(this.keyFileUri);

        // ä½¿ç”¨TextFileManagerè¯»å–å¯†é’¥æ–‡ä»¶
        const readResult = await TextFileManager.readTextFile(this.keyFileUri);
        if (readResult.success) {
          try {
            const decoder = new util.TextDecoder('utf-8');
            const uint8 = new Uint8Array(readResult.data as ArrayBuffer);
            // éœ€è¦å®Œæ•´å¯†é’¥å†…å®¹ç”¨äºè§£æä¸ç­¾åï¼Œä¸åº”ä»…ä½¿ç”¨å‰ 1000 å­—èŠ‚
            this.keyString = decoder.decode(uint8);
          } catch (decodeError) {
            Logger.error(TAG, `Binary decode error: ${decodeError.code}`);
            this.keyString = "å¯†é’¥å†…å®¹é¢„è§ˆä¸å¯ç”¨";
          }
          windowClass.getUIContext().getPromptAction().showToast({
            message: 'å¯†é’¥æ–‡ä»¶è¯»å–æˆåŠŸ'
          });
        } else {
          windowClass.getUIContext().getPromptAction().showToast({
            message: 'å¯†é’¥æ–‡ä»¶è¯»å–å¤±è´¥'
          });
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æœªé€‰æ‹©æ–‡ä»¶'
        });
      }
    } catch (error) {
      Logger.error(TAG, `selectRsaKeyFileAndRead failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({
        message: 'é€‰æ‹©æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•'
      });
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * é€‰æ‹©å¹¶è¯»å–å¾…ç­¾åçš„æ–‡ä»¶
   */
  async selectTextFileAndRead() {
    this.isProcessing = true;
    try {
      let context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      let documentPicker = new picker.DocumentViewPicker(context);
      let documentSelectOptions = new picker.DocumentSelectOptions();

      let uris = await documentPicker.select(documentSelectOptions);
      const windowClass = await window.getLastWindow(context);

      if (uris && uris.length > 0) {
        this.textFileUri = uris[0];
        this.textFileName = this.getFileNameFromUri(this.textFileUri);
        this.originalExtension = MetadataHelper.getFileExtension(this.textFileName);

        // ä½¿ç”¨TextFileManagerè¯»å–æ–‡ä»¶
        const readResult = await TextFileManager.readTextFile(this.textFileUri);
        if (readResult.success) {
          try {
            const decoder = new util.TextDecoder('utf-8');
            const uint8 = new Uint8Array(readResult.data as ArrayBuffer);
            const dataSlice = uint8.slice(0, 1000);
            this.plainText = decoder.decode(dataSlice);
            this.fileSize = (readResult.data as ArrayBuffer).byteLength;
          } catch (decodeError) {
            Logger.error(TAG, `Binary decode error: ${decodeError.code}`);
            this.plainText = "äºŒè¿›åˆ¶å†…å®¹é¢„è§ˆä¸å¯ç”¨";
            this.fileSize = (readResult.data as ArrayBuffer).byteLength;
          }
          windowClass.getUIContext().getPromptAction().showToast({
            message: 'æ–‡ä»¶è¯»å–æˆåŠŸ'
          });
        } else {
          windowClass.getUIContext().getPromptAction().showToast({
            message: 'æ–‡ä»¶è¯»å–å¤±è´¥'
          });
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æœªé€‰æ‹©æ–‡ä»¶'
        });
      }
    } catch (error) {
      Logger.error(TAG, `selectTextFileAndRead failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({
        message: 'é€‰æ‹©æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•'
      });
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * åˆ›å»ºå¸¦å…ƒæ•°æ®å¤´çš„ç­¾åæ•°æ®
   */
  private createSignatureWithMetadata(signatureData: ArrayBuffer, originalExtension: string): ArrayBuffer {
    // åˆ›å»ºå…ƒæ•°æ®
    const metadata = MetadataHelper.createDefaultMetadata(
      this.textFileName,
      'RSA-PKCS1-SHA256',
      this.fileSize
    );

    // ç¡®ä¿æœ‰æ­£ç¡®çš„æ‰©å±•å
    if (originalExtension) {
      metadata.originalExtension = originalExtension;
    }

    // ä½¿ç”¨ MetadataHelper åˆ›å»ºå¸¦å…ƒæ•°æ®å¤´çš„æ•°æ®
    return MetadataHelper.createDataWithMetadata(signatureData, metadata);
  }

  /**
   * åˆ›å»ºç­¾åæ–‡ä»¶å¹¶å†™å…¥å†…å®¹ï¼ˆæ”¯æŒå…ƒæ•°æ®å¤´ï¼‰
   */
  async createSignedFileAndWrite(signatureData: ArrayBuffer, originalExtension?: string): Promise<boolean> {
    this.isProcessing = true;
    try {
      let context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      let documentPicker = new picker.DocumentViewPicker(context);

      let documentSaveOptions = new picker.DocumentSaveOptions();

      // æ™ºèƒ½ç”Ÿæˆæ–‡ä»¶å
      let newFileName: string;
      if (originalExtension) {
        const baseName = MetadataHelper.getFileBaseName(this.textFileName);
        newFileName = `${baseName}.${originalExtension}.signature`;
      } else {
        newFileName = this.textFileName + '.signature';
      }

      documentSaveOptions.newFileNames = [newFileName];

      let saveUris = await documentPicker.save(documentSaveOptions);
      const windowClass = await window.getLastWindow(context);

      if (saveUris && saveUris.length > 0) {
        this.signFileUri = saveUris[0];

        // åˆ›å»ºå¸¦å…ƒæ•°æ®å¤´çš„ç­¾åæ•°æ®
        const signatureWithMetadata = this.createSignatureWithMetadata(signatureData, originalExtension || this.originalExtension);

        // ä½¿ç”¨TextFileManagerå†™å…¥æ•°æ®
        const writeResult = await TextFileManager.writeTextFile(this.signFileUri, signatureWithMetadata);
        if (writeResult.success) {
          windowClass.getUIContext().getPromptAction().showToast({
            message: `ç­¾åæ–‡ä»¶ä¿å­˜æˆåŠŸï¼Œæ ¼å¼: ${originalExtension || 'æœªçŸ¥'}`
          });
          return true;
        } else {
          windowClass.getUIContext().getPromptAction().showToast({
            message: 'æ–‡ä»¶ä¿å­˜å¤±è´¥'
          });
          return false;
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æ–‡ä»¶ä¿å­˜å–æ¶ˆ'
        });
        return false;
      }
    } catch (error) {
      Logger.error(TAG, `createSignedFileAndWrite failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({
        message: 'æ–‡ä»¶ä¿å­˜å¤±è´¥'
      });
      return false;
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * åˆ›å»ºå¯†é’¥æ–‡ä»¶å¹¶å†™å…¥å¯†é’¥å†…å®¹
   */
  async createKeyFileAndWrite(): Promise<boolean> {
    this.isProcessing = true;
    try {
      let context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      let documentPicker = new picker.DocumentViewPicker(context);

      let documentSaveOptions = new picker.DocumentSaveOptions();
      documentSaveOptions.newFileNames = ['rsa_key_pair.json'];

      let saveUris = await documentPicker.save(documentSaveOptions);
      const windowClass = await window.getLastWindow(context);

      if (saveUris && saveUris.length > 0) {
        this.createKeyUri = saveUris[0];

        // ä½¿ç”¨TextFileManagerå†™å…¥å¯†é’¥
        const writeResult = await TextFileManager.writeTextFile(this.createKeyUri, this.keyString);
        if (writeResult.success) {
          windowClass.getUIContext().getPromptAction().showToast({
            message: $r('app.string.gen_key_success')
          });
          return true;
        } else {
          windowClass.getUIContext().getPromptAction().showToast({
            message: $r('app.string.gen_key_fail')
          });
          return false;
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'å¯†é’¥ä¿å­˜å–æ¶ˆ'
        });
        return false;
      }
    } catch (error) {
      Logger.error(TAG, `createKeyFileAndWrite failed, ${error.code}, ${error.message}`);
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);
      windowClass.getUIContext().getPromptAction().showToast({
        message: $r('app.string.gen_key_fail')
      });
      return false;
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * ä»æ–‡ä»¶URIä¸­æå–æ–‡ä»¶å
   */
  private getFileNameFromUri(uri: string): string {
    if (!uri) return 'æœªçŸ¥æ–‡ä»¶';
    try {
      const segments = uri.split('/');
      let name = segments[segments.length - 1] || 'æœªçŸ¥æ–‡ä»¶';
      try {
        name = decodeURIComponent(name);
      } catch (e) {
        try { name = decodeURI(name); } catch (_) { }
      }
      if (name.startsWith('file://')) {
        const parts = name.split('/');
        name = parts[parts.length - 1] || name;
      }
      return name;
    } catch (e) {
      return uri;
    }
  }

  /**
   * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º
   */
  private formatFileSize(bytes: number): string {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  /**
   * è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼
   */
  async calculateFileHash() {
    this.isProcessing = true;
    try {
      const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);

      // è¯»å–æ–‡ä»¶æ•°æ®
      const readResult = await TextFileManager.readTextFile(this.textFileUri);
      if (!readResult.success) {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æ–‡ä»¶è¯»å–å¤±è´¥'
        });
        return;
      }

      const fileData = readResult.data as ArrayBuffer;

      // æ‰‹åŠ¨å“ˆå¸Œè®¡ç®—å·²ç§»é™¤ï¼›åŠ è§£å¯†/ç­¾åæµç¨‹ä¼šè‡ªåŠ¨å¤„ç†å“ˆå¸Œ
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * ç­¾ååŠŸèƒ½ä¸»å‡½æ•° - å¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒå…ƒæ•°æ®å¤´
   */
  async signFunc() {
    this.isProcessing = true;
    const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);

    if (this.textFileUri === '' || this.keyString === '') {
      windowClass.getUIContext().getPromptAction().showToast({
        message: $r('app.string.null_message')
      });
      this.isProcessing = false;
      return;
    }

    try {
      // è¯»å–æ–‡ä»¶æ•°æ®
      const readResult = await TextFileManager.readTextFile(this.textFileUri);
      if (!readResult.success) {
        windowClass.getUIContext().getPromptAction().showToast({
          message: 'æ–‡ä»¶è¯»å–å¤±è´¥'
        });
        this.isProcessing = false;
        return;
      }

      const fileDataBuf = readResult.data as ArrayBuffer;
      let signResult: ArrayBuffer | null = null;

      // ä½¿ç”¨äºŒè¿›åˆ¶ç­¾åæ–¹æ³•
      const binarySignResult = await this.CryptoOperation.rsaConvertAndSignBinary(this.keyString, fileDataBuf);
      if (binarySignResult.success && binarySignResult.data) {
        signResult = binarySignResult.data;
      }

      if (signResult) {
        // ç”Ÿæˆç­¾ååå…­è¿›åˆ¶æ˜¾ç¤º
        const signatureArray = new Uint8Array(signResult);
        this.signatureHex = Array.from(signatureArray).map(b => b.toString(16).padStart(2, '0')).join('');

        // æ˜¾ç¤ºç­¾åä¿¡æ¯
        this.signResult = `ç­¾åæˆåŠŸï¼\nç­¾åç®—æ³•: RSA-PKCS1-SHA256\nç­¾åæ—¶é—´: ${new Date().toLocaleString()}\næ–‡ä»¶å¤§å°: ${this.formatFileSize(this.fileSize)}\nç­¾åé•¿åº¦: ${signResult.byteLength} å­—èŠ‚`;

        // ä¿å­˜ç­¾åæ–‡ä»¶
        const saveSuccess = await this.createSignedFileAndWrite(signResult, this.originalExtension);
        if (saveSuccess) {
          windowClass.getUIContext().getPromptAction().showToast({
            message: $r('app.string.sign_success')
          });
          Logger.info(TAG, `æ–‡ä»¶ç­¾åæˆåŠŸï¼ŒåŸå§‹æ ¼å¼: ${this.originalExtension}, ç­¾åå¤§å°: ${signResult.byteLength} å­—èŠ‚`);
        }
      } else {
        windowClass.getUIContext().getPromptAction().showToast({
          message: $r('app.string.sign_fail')
        });
      }

    } catch (error) {
      Logger.error(TAG, `sign failed, ${error.code}, ${error.message}`);
      windowClass.getUIContext().getPromptAction().showToast({
        message: $r('app.string.sign_fail')
      });
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * ç”ŸæˆRSAå¯†é’¥
   */
  async genRsaKey() {
    this.isProcessing = true;
    const windowClass = await window.getLastWindow(this.getUIContext().getHostContext() as common.UIAbilityContext);

    // æ˜¾ç¤ºç”Ÿæˆå¯†é’¥çš„æç¤º
    windowClass.getUIContext().getPromptAction().showToast({
      message: $r('app.string.slow_rsa_key_gen')
    });

    try {
      this.keyString = await this.CryptoOperation.generateRsaKey();

      if (!this.keyString) {
        windowClass.getUIContext().getPromptAction().showToast({
          message: $r('app.string.gen_key_fail')
        });
        this.isProcessing = false;
        return;
      }

      // ä¿å­˜å¯†é’¥æ–‡ä»¶
      const saveSuccess = await this.createKeyFileAndWrite();
      if (saveSuccess) {
        // æ˜¾ç¤ºå¯†é’¥æ‘˜è¦
        const keyPreview = this.keyString.length > 50 ?
          this.keyString.substring(0, 50) + '...' : this.keyString;
        this.signResult = `RSAå¯†é’¥ç”ŸæˆæˆåŠŸï¼Œé•¿åº¦: ${this.keyString.length} å­—ç¬¦`;
        Logger.info(TAG, `RSAå¯†é’¥ç”ŸæˆæˆåŠŸï¼Œé•¿åº¦: ${this.keyString.length} å­—ç¬¦`);
      }

    } catch (error) {
      Logger.error(TAG, `gen rsa key failed, ${error.code}, ${error.message}`);
      windowClass.getUIContext().getPromptAction().showToast({
        message: $r('app.string.gen_key_fail')
      });
    } finally {
      this.isProcessing = false;
    }
  }
}