/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// src/main/ets/pages/EventEditPage.ets
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import { Event, EventModel } from '../model/EventModel';
import { NotificationService } from '../services/NotificationService';

@Component
export struct EventEditPage {
  // æŽ¥æ”¶å…¨å±€è·¯ç”±æ ˆ
  @Consume('pageStack') pageStack: NavPathStack;

  // æŽ¥æ”¶å‚æ•°
  @State eventItem: Event | undefined = undefined;

  // è¡¨å•çŠ¶æ€
  @State eventId: number = 0;
  @State title: string = '';
  @State description: string = '';
  @State isAllDay: boolean = false;
  @State startTime: Date = new Date();
  @State endTime: Date = new Date(new Date().getTime() + 60 * 60 * 1000);

  // æé†’ç›¸å…³çŠ¶æ€
  @State isReminderOn: boolean = false;
  private oldReminderId: number = -1;

  aboutToAppear() {
    if (this.eventItem && this.eventItem.id) {
      this.eventId = this.eventItem.id;
      this.title = this.eventItem.title;
      this.description = this.eventItem.description;
      this.isAllDay = this.eventItem.isAllDay;
      this.startTime = new Date(this.eventItem.startTime);
      this.endTime = new Date(this.eventItem.endTime);

      // åˆå§‹åŒ–æé†’çŠ¶æ€
      this.oldReminderId = this.eventItem.reminderId;
      this.isReminderOn = this.oldReminderId > -1;
    }
  }

  private formatDate(date: Date): string {
    const y = date.getFullYear();
    const m = date.getMonth() + 1;
    const d = date.getDate();
    return `${y}/${m}/${d}`;
  }

  private formatTime(date: Date): string {
    const h = date.getHours().toString().padStart(2, '0');
    const m = date.getMinutes().toString().padStart(2, '0');
    return `${h}:${m}`;
  }

  private pickDate(isStart: boolean) {
    DatePickerDialog.show({
      start: new Date("2020-1-1"),
      end: new Date("2030-12-31"),
      selected: isStart ? this.startTime : this.endTime,
      onAccept: (value: DatePickerResult) => {
        const targetDate = isStart ? this.startTime : this.endTime;
        const newDate = new Date(targetDate.getTime());
        newDate.setFullYear(value.year, value.month, value.day);
        if (isStart) this.startTime = new Date(newDate.getTime());
        else this.endTime = new Date(newDate.getTime());
      }
    })
  }

  private pickTime(isStart: boolean) {
    TimePickerDialog.show({
      selected: isStart ? this.startTime : this.endTime,
      useMilitaryTime: true,
      onAccept: (value: TimePickerResult) => {
        const targetDate = isStart ? this.startTime : this.endTime;
        const newDate = new Date(targetDate.getTime());
        newDate.setHours(value.hour, value.minute);
        if (isStart) this.startTime = new Date(newDate.getTime());
        else this.endTime = new Date(newDate.getTime());
      }
    })
  }

  // âœ… [æ ¸å¿ƒä¿®æ”¹] é€»è¾‘é‡æž„ï¼šå…ˆå­˜ DB èŽ·å– IDï¼Œå†å‘é€šçŸ¥
  async saveEvent() {
    // 1. æ ¡éªŒè¾“å…¥ & å–æ¶ˆæ—§æé†’ (ä¸å˜)
    if (this.title.trim() === '') {
      promptAction.showToast({ message: $r('app.string.toast_event_input_error') });
      return;
    }
    if (this.oldReminderId > -1) {
      await NotificationService.cancelReminder(this.oldReminderId);
    }

    // 2. æž„å»º Event å¯¹è±¡ (ä¸å˜)
    const event = new Event(
      this.title,
      this.startTime.getTime(),
      this.endTime.getTime(),
      this.description,
      this.isAllDay,
      -1
    );
    event.id = this.eventId;

    // 3. ã€ç¬¬ä¸€æ­¥ã€‘å…ˆå­˜å…¥æ•°æ®åº“ï¼Œç¡®ä¿æ‹¿åˆ° ID (ä¸å˜)
    let finalEventId = this.eventId;
    if (this.eventId > 0) {
      await EventModel.update(event);
    } else {
      finalEventId = await EventModel.insert(event);
      event.id = finalEventId;
    }

    // 4. ã€ç¬¬äºŒæ­¥ã€‘è®¾ç½®å‡†ç‚¹æé†’
    let newReminderId = -1;
    if (this.isReminderOn) {

      // âœ… [ä¿®æ”¹] ä¸å†å‡åŽ»ä»»ä½•æ—¶é—´ï¼Œç›´æŽ¥ç”¨å¼€å§‹æ—¶é—´
      const triggerTime = this.startTime.getTime();
      const now = new Date().getTime();

      // åªæœ‰å¼€å§‹æ—¶é—´æ˜¯åœ¨æœªæ¥ï¼Œæ‰è®¾ç½®æé†’
      if (triggerTime > now) {
        const context = getContext(this) as common.UIAbilityContext;
        const hasPermission = await NotificationService.checkAndRequestPermission(context);

        if (hasPermission) {
          // å‘é€è¯·æ±‚ç»™ ReminderAgent
          newReminderId = await NotificationService.publishCalendarReminder(
            context,
            finalEventId,
            this.title,
            this.description || "æ—¥ç¨‹æ—¶é—´åˆ°äº†", // æ–‡æ¡ˆæ”¹ä¸ºâ€œæ—¶é—´åˆ°äº†â€
            triggerTime // ðŸ‘ˆ ä¼ å…¥å‡†ç¡®çš„å¼€å§‹æ—¶é—´
          );
        } else {
          promptAction.showToast({ message: 'é€šçŸ¥æƒé™è¢«æ‹’ç»' });
        }
      } else {
        // å¦‚æžœå¼€å§‹æ—¶é—´å·²è¿‡ï¼ˆæ¯”å¦‚çŽ°åœ¨10:01ï¼Œä½ è®¾äº†10:00å¼€å§‹çš„æ—¥ç¨‹ï¼‰
        promptAction.showToast({ message: 'å¼€å§‹æ—¶é—´å·²è¿‡ï¼Œæœªè®¾ç½®æé†’' });
      }
    }

    // 5. ã€ç¬¬ä¸‰æ­¥ã€‘æ›´æ–° reminderId (ä¸å˜)
    if (newReminderId > -1) {
      event.reminderId = newReminderId;
      await EventModel.update(event);
    }

    promptAction.showToast({ message: $r('app.string.toast_save_success') });
    AppStorage.setOrCreate('refreshEventList', Date.now());
    this.pageStack.pop();
  }

  build() {
    NavDestination() {
      Column() {
        // --- è‡ªå®šä¹‰å¤´éƒ¨ ---
        Row() {
          Image($r('app.media.ic_back'))
            .width(24).height(24).margin({ right: 16 })
            .onClick(() => { this.pageStack.pop(); })

          Text(this.eventId > 0 ? "ç¼–è¾‘æ—¥ç¨‹" : $r('app.string.event_btn_add'))
            .fontSize(20).fontWeight(FontWeight.Bold).layoutWeight(1)

          Button($r('app.string.btn_save'))
            .height(32).fontSize(14)
            .onClick(() => { this.saveEvent() })
        }
        .width('100%').height(56).padding({ left: 16, right: 16 }).backgroundColor(Color.White)

        // --- è¡¨å•å†…å®¹ ---
        Scroll() {
          GridRow({
            columns: { sm: 4, md: 8, lg: 12 },
            gutter: { x: 12, y: 12 }
          }) {
            GridCol({ span: { sm: 4, md: 6, lg: 8 }, offset: { sm: 0, md: 1, lg: 2 } }) {
              Column({ space: 12 }) {
                // æ ‡é¢˜
                TextInput({ text: this.title, placeholder: $r('app.string.label_event_title') })
                  .height(48).backgroundColor(Color.White).borderRadius(12)
                  .onChange((val) => this.title = val)

                // å…¨å¤©å¼€å…³
                Row() {
                  Text($r('app.string.label_all_day')).fontSize(16)
                  Toggle({ type: ToggleType.Switch, isOn: this.isAllDay })
                    .onChange((isOn) => this.isAllDay = isOn)
                }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding(12).backgroundColor(Color.White).borderRadius(12)

                // æé†’å¼€å…³
                Row() {
                  Text("å¼€å¯æé†’").fontSize(16)
                  Toggle({ type: ToggleType.Switch, isOn: this.isReminderOn })
                    .onChange((isOn) => this.isReminderOn = isOn)
                }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding(12).backgroundColor(Color.White).borderRadius(12)

                // å¼€å§‹æ—¶é—´
                Row() {
                  Text($r('app.string.label_start_time')).fontSize(16)
                  Text(this.formatDate(this.startTime)).fontSize(16).fontColor('#007DFF')
                }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding(16).backgroundColor(Color.White).borderRadius(12)
                .onClick(() => { this.pickDate(true); })

                if (!this.isAllDay) {
                  Row() {
                    Text(" ").fontSize(16)
                    Text(this.formatTime(this.startTime)).fontSize(16).fontColor('#007DFF')
                  }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding(16).backgroundColor(Color.White).borderRadius(12)
                  .onClick(() => { this.pickTime(true); })
                }

                // ç»“æŸæ—¶é—´
                Row() {
                  Text($r('app.string.label_end_time')).fontSize(16)
                  Text(this.formatDate(this.endTime)).fontSize(16).fontColor('#007DFF')
                }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding(16).backgroundColor(Color.White).borderRadius(12)
                .onClick(() => { this.pickDate(false); })

                if (!this.isAllDay) {
                  Row() {
                    Text(" ").fontSize(16)
                    Text(this.formatTime(this.endTime)).fontSize(16).fontColor('#007DFF')
                  }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding(16).backgroundColor(Color.White).borderRadius(12)
                  .onClick(() => { this.pickTime(false); })
                }

                // æè¿°
                TextArea({ text: this.description, placeholder: $r('app.string.label_event_desc') })
                  .height(120).backgroundColor(Color.White).borderRadius(12)
                  .onChange((val) => this.description = val)
              }
              .width('100%').padding({ top: 12, bottom: 24 })
            }
          }
        }
        .layoutWeight(1).width('100%').padding({ left: 16, right: 16 }).backgroundColor('#F1F3F5')
      }
      .width('100%').height('100%').backgroundColor('#F1F3F5')
    }
    .hideTitleBar(true)
  }
}