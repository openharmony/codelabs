/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// src/main/ets/pages/EventEditPage.ets
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import { Event, EventModel } from '../model/EventModel';
import { NotificationService } from '../services/NotificationService';
import { Logger } from '../common/utils/Logger';

const logger = new Logger('EventEditlPage');

@Component
export struct EventEditPage {
  // æ¥æ”¶å…¨å±€è·¯ç”±æ ˆ
  @Consume('pageStack') pageStack: NavPathStack;
  // æ¥æ”¶å‚æ•°
  @State eventItem: Event | undefined = undefined;
  // è¡¨å•çŠ¶æ€
  @State eventId: number = 0;
  @State title: string = '';
  @State description: string = '';
  @State isAllDay: boolean = false;
  @State startTime: Date = new Date();
  @State endTime: Date = new Date(new Date().getTime() + 60 * 60 * 1000);
  // æé†’ç›¸å…³çŠ¶æ€
  @State isReminderOn: boolean = false;
  private oldReminderId: number = -1;

  aboutToAppear() {
    if (this.eventItem && this.eventItem.id) {
      this.eventId = this.eventItem.id;
      this.title = this.eventItem.title;
      this.description = this.eventItem.description;
      this.isAllDay = this.eventItem.isAllDay;
      this.startTime = new Date(this.eventItem.startTime);
      this.endTime = new Date(this.eventItem.endTime);

      this.oldReminderId = this.eventItem.reminderId;
      this.isReminderOn = this.oldReminderId > -1;

      // âœ… ã€ä¿®æ­£ä»£ç ã€‘ä½¿ç”¨ .then() æ›¿ä»£ await
      // è¿™æ ·å°±ä¸éœ€è¦åœ¨ aboutToAppear ä¸ŠåŠ  async äº†
      EventModel.queryById(this.eventId).then((freshEvent) => {
        if (freshEvent) {
          // æ•°æ®åº“æŸ¥åˆ°äº†æœ€æ–°æ•°æ®ï¼Œè¦†ç›–å½“å‰é¡µé¢çš„çŠ¶æ€
          this.startTime = new Date(freshEvent.startTime);
          this.endTime = new Date(freshEvent.endTime);
          this.title = freshEvent.title;
          this.description = freshEvent.description;
          this.isAllDay = freshEvent.isAllDay;
          // å¦‚æœéœ€è¦ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥åˆ·æ–°æé†’çŠ¶æ€
          this.oldReminderId = freshEvent.reminderId;
          this.isReminderOn = this.oldReminderId > -1;
        }
      });
    }
  }

  // âœ… [æ ¸å¿ƒä¿®æ”¹] é€»è¾‘é‡æ„ï¼šå…ˆå­˜ DB è·å– IDï¼Œå†å‘é€šçŸ¥
  async saveEvent() {
    // 1. æ ¡éªŒè¾“å…¥ & å–æ¶ˆæ—§æé†’ (ä¸å˜)
    if (this.title.trim() === '') {
      promptAction.showToast({ message: $r('app.string.toast_event_input_error') });
      return;
    }
    if (this.oldReminderId > -1) {
      await NotificationService.cancelReminder(this.oldReminderId);
    }

    // 2. æ„å»º Event å¯¹è±¡ (ä¸å˜)
    const event = new Event(
      this.title,
      this.startTime.getTime(),
      this.endTime.getTime(),
      this.description,
      this.isAllDay,
      -1
    );
    event.id = this.eventId;

    // 3. ã€ç¬¬ä¸€æ­¥ã€‘å…ˆå­˜å…¥æ•°æ®åº“ï¼Œç¡®ä¿æ‹¿åˆ° ID (ä¸å˜)
    let finalEventId = this.eventId;
    if (this.eventId > 0) {
      await EventModel.update(event);
    } else {
      finalEventId = await EventModel.insert(event);
      event.id = finalEventId;
    }

    // 4. ã€ç¬¬äºŒæ­¥ã€‘è®¾ç½®å‡†ç‚¹æé†’
    let newReminderId = -1;
    if (this.isReminderOn) {

      // âœ… [ä¿®æ”¹] ä¸å†å‡å»ä»»ä½•æ—¶é—´ï¼Œç›´æ¥ç”¨å¼€å§‹æ—¶é—´
      const triggerTime = this.startTime.getTime();
      const now = new Date().getTime();

      // åªæœ‰å¼€å§‹æ—¶é—´æ˜¯åœ¨æœªæ¥ï¼Œæ‰è®¾ç½®æé†’
      if (triggerTime > now) {
        const context = getContext(this) as common.UIAbilityContext;
        const hasPermission = await NotificationService.checkAndRequestPermission(context);

        if (hasPermission) {
          // ğŸ“ [ä¿®å¤] æå–å›½é™…åŒ–å­—ç¬¦ä¸²
          // æ³¨æ„ï¼šNotificationService éœ€è¦å…·ä½“çš„ stringï¼Œä¸èƒ½ç›´æ¥ä¼  $r å¯¹è±¡
          // æˆ‘ä»¬ä½¿ç”¨ resourceManager æ¥è§£æèµ„æº
          const defaultDesc = context.resourceManager.getStringSync($r('app.string.event_reminder_time_up').id);

          // å‘é€è¯·æ±‚ç»™ ReminderAgent
          newReminderId = await NotificationService.publishCalendarReminder(
            context,
            finalEventId,
            this.title,
            this.description || defaultDesc, // ä½¿ç”¨è§£æåçš„â€œæ—¥ç¨‹æ—¶é—´åˆ°äº†â€
            triggerTime
          );
        } else {
          promptAction.showToast({ message: $r('app.string.event_toast_permission_denied') });
        }
      } else {
        // å¦‚æœå¼€å§‹æ—¶é—´å·²è¿‡ï¼ˆæ¯”å¦‚ç°åœ¨10:01ï¼Œä½ è®¾äº†10:00å¼€å§‹çš„æ—¥ç¨‹ï¼‰
        promptAction.showToast({ message: $r('app.string.event_toast_start_time_passed') });
      }
    }

    // 5. ã€ç¬¬ä¸‰æ­¥ã€‘æ›´æ–° reminderId (ä¸å˜)
    if (newReminderId > -1) {
      event.reminderId = newReminderId;
      await EventModel.update(event);
    }
    AppStorage.setOrCreate('GlobalRefreshSignal', Date.now());
    logger.info('Event saved, sent GlobalRefreshSignal');

    promptAction.showToast({ message: $r('app.string.toast_save_success') });
    AppStorage.setOrCreate('refreshEventList', Date.now());

    // [DEBUG] 1. æ‰“å°ä¿å­˜æ—¶çš„å…³é”®ä¿¡æ¯
    logger.error(`[DEBUG_1_EDIT] ä¿å­˜å®Œæ¯•ï¼Œå³å°†é€€å‡ºã€‚StartTime: ${this.startTime.getTime()}, ID: ${this.eventId}`);

    this.pageStack.pop();
  }

  build() {
    NavDestination() {
      Column() {
        // --- è‡ªå®šä¹‰å¤´éƒ¨ ---
        Row() {
          Image($r('app.media.ic_back'))
            .width(24).height(24).margin({ right: 16 })
            .onClick(() => {
              this.pageStack.pop();
            })

          // è¿™é‡Œæˆ‘ä»¬å¤ç”¨ string.json é‡Œçš„ "common_edit" (ç¼–è¾‘) æˆ–è€… "event_title_detail" (æ—¥ç¨‹è¯¦æƒ…)
          // å»ºè®®ï¼šæš‚æ—¶ç”¨ app.string.common_edit
          Text(this.eventId > 0 ? $r('app.string.common_edit') : $r('app.string.event_btn_add'))
            .fontSize(20).fontWeight(FontWeight.Bold).layoutWeight(1)

          Button($r('app.string.common_save')) // æ³¨æ„æ£€æŸ¥æ‚¨çš„ string.json æ˜¯å¦æœ‰ btn_saveï¼Œä¹‹å‰ç»™çš„æ˜¯ common_save
            .height(32).fontSize(14)
            .onClick(() => {
              this.saveEvent()
            })
        }
        .width('100%').height(56).padding({ left: 16, right: 16 }).backgroundColor(Color.White)

        // --- è¡¨å•å†…å®¹ ---
        Scroll() {
          GridRow({
            columns: { sm: 4, md: 8, lg: 12 },
            gutter: { x: 12, y: 12 }
          }) {
            GridCol({ span: { sm: 4, md: 6, lg: 8 }, offset: { sm: 0, md: 1, lg: 2 } }) {
              Column({ space: 12 }) {
                // æ ‡é¢˜
                TextInput({ text: this.title, placeholder: $r('app.string.label_event_title') })
                  .height(48).backgroundColor(Color.White).borderRadius(12)
                  .onChange((val) => this.title = val)

                // å…¨å¤©å¼€å…³
                Row() {
                  Text($r('app.string.label_all_day')).fontSize(16)
                  Toggle({ type: ToggleType.Switch, isOn: this.isAllDay })
                    .onChange((isOn) => this.isAllDay = isOn)
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
                .padding(12)
                .backgroundColor(Color.White)
                .borderRadius(12)

                // æé†’å¼€å…³
                Row() {
                  Text($r('app.string.event_label_enable_reminder')).fontSize(16)
                  // æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»æ˜¾å¼ç»‘å®š $$this.isReminderOn å¯èƒ½ä¼šæ›´å¥½ï¼Œä½†ç”¨ä¸‹é¢çš„ setTimeout æ˜¯æœ€é€šç”¨çš„ä¸‡èƒ½è§£æ³•
                  Toggle({ type: ToggleType.Switch, isOn: this.isReminderOn })
                    .onChange((isOn: boolean) => {
                      if (isOn) {
                        const now = new Date().getTime();
                        // æ£€æŸ¥ï¼šå¼€å§‹æ—¶é—´æ˜¯å¦æ—©äºæˆ–ç­‰äºå½“å‰æ—¶é—´
                        if (this.startTime.getTime() <= now) {

                          // 1. å¼¹å‡ºæç¤º
                          promptAction.showToast({
                            message: $r('app.string.toast_reminder_past_time'),
                            duration: 2000
                          });

                          // ğŸ”¥ğŸ”¥ğŸ”¥ã€å…³é”®ä¿®å¤ã€‘ğŸ”¥ğŸ”¥ğŸ”¥
                          // é—®é¢˜åŸå› ï¼šç›´æ¥è®¾ä¸º falseï¼Œç³»ç»Ÿè®¤ä¸ºå€¼æ²¡å˜(åŸæ¥å°±æ˜¯false)ï¼Œæ‰€ä»¥ä¸åˆ·æ–°UIã€‚
                          // è§£å†³åŠæ³•ï¼šå…ˆè®¾ä¸º true (åŒæ­¥å½“å‰UIè§†è§‰)ï¼Œç„¶ååˆ©ç”¨ setTimeout åœ¨ä¸‹ä¸€å¸§å¼ºåˆ¶æ”¹ä¸º falseã€‚
                          this.isReminderOn = true;

                          setTimeout(() => {
                            this.isReminderOn = false;
                          }, 500); // 10æ¯«ç§’çš„æçŸ­å»¶è¿Ÿï¼Œäººçœ¼çœ‹ä¸å‡ºé—ªçƒï¼Œä½†è¶³ä»¥è§¦å‘çŠ¶æ€å˜æ›´æœºåˆ¶

                          return;
                        }
                      }

                      // æ­£å¸¸æƒ…å†µ
                      this.isReminderOn = isOn;
                    })
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
                .padding(12)
                .backgroundColor(Color.White)
                .borderRadius(12)

                // å¼€å§‹æ—¶é—´
                Row() {
                  Text($r('app.string.label_start_time')).fontSize(16)
                  Text(this.formatDate(this.startTime)).fontSize(16).fontColor('#007DFF')
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
                .padding(16)
                .backgroundColor(Color.White)
                .borderRadius(12)
                .onClick(() => {
                  this.pickDate(true);
                })

                if (!this.isAllDay) {
                  Row() {
                    Text(" ").fontSize(16)
                    Text(this.formatTime(this.startTime)).fontSize(16).fontColor('#007DFF')
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.SpaceBetween)
                  .padding(16)
                  .backgroundColor(Color.White)
                  .borderRadius(12)
                  .onClick(() => {
                    this.pickTime(true);
                  })
                }

                // ç»“æŸæ—¶é—´
                Row() {
                  Text($r('app.string.label_end_time')).fontSize(16)
                  Text(this.formatDate(this.endTime)).fontSize(16).fontColor('#007DFF')
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
                .padding(16)
                .backgroundColor(Color.White)
                .borderRadius(12)
                .onClick(() => {
                  this.pickDate(false);
                })

                if (!this.isAllDay) {
                  Row() {
                    Text(" ").fontSize(16)
                    Text(this.formatTime(this.endTime)).fontSize(16).fontColor('#007DFF')
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.SpaceBetween)
                  .padding(16)
                  .backgroundColor(Color.White)
                  .borderRadius(12)
                  .onClick(() => {
                    this.pickTime(false);
                  })
                }

                // æè¿°
                TextArea({ text: this.description, placeholder: $r('app.string.label_event_desc') })
                  .height(120).backgroundColor(Color.White).borderRadius(12)
                  .onChange((val) => this.description = val)
              }
              .width('100%').padding({ top: 12, bottom: 24 })
            }
          }
        }
        .layoutWeight(1).width('100%').padding({ left: 16, right: 16 }).backgroundColor('#F1F3F5')
      }
      .width('100%').height('100%').backgroundColor('#F1F3F5')
    }
    .hideTitleBar(true)
  }

  private formatDate(date: Date): string {
    const y = date.getFullYear();
    const m = date.getMonth() + 1;
    const d = date.getDate();
    return `${y}/${m}/${d}`;
  }

  private formatTime(date: Date): string {
    const h = date.getHours().toString().padStart(2, '0');
    const m = date.getMinutes().toString().padStart(2, '0');
    return `${h}:${m}`;
  }

  private pickDate(isStart: boolean) {
    DatePickerDialog.show({
      start: new Date("2020-1-1"),
      end: new Date("2030-12-31"),
      selected: isStart ? this.startTime : this.endTime,
      onAccept: (value: DatePickerResult) => {
        const targetDate = isStart ? this.startTime : this.endTime;
        const newDate = new Date(targetDate.getTime());
        newDate.setFullYear(value.year, value.month, value.day);
        if (isStart) {
          this.startTime = new Date(newDate.getTime());
        } else {
          this.endTime = new Date(newDate.getTime());
        }
      }
    })
  }

  private pickTime(isStart: boolean) {
    TimePickerDialog.show({
      selected: isStart ? this.startTime : this.endTime,
      useMilitaryTime: true,
      onAccept: (value: TimePickerResult) => {
        const targetDate = isStart ? this.startTime : this.endTime;
        const newDate = new Date(targetDate.getTime());
        newDate.setHours(value.hour, value.minute);
        if (isStart) {
          this.startTime = new Date(newDate.getTime());
        } else {
          this.endTime = new Date(newDate.getTime());
        }
      }
    })
  }
}