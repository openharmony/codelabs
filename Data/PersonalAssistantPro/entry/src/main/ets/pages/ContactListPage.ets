/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// src/main/ets/pages/ContactListPage.ets
import { Contact, ContactModel } from '../model/ContactModel';
import { ContactViewModel } from '../viewmodel/ContactViewModel'; // ğŸ“ [æ–°å¢] å¼•å…¥ ViewModel
import { Logger } from '../common/utils/Logger';
import { emitter } from '@kit.BasicServicesKit';
import promptAction from '@ohos.promptAction'; // ğŸ“ [æ–°å¢] ç”¨äºå¼¹çª—æç¤º
import { CommonConstants } from '../common/constants/CommonConstants';

const logger = new Logger('ContactListPage');
const EVENT_ID_REFRESH = 1001;

@Component
export struct ContactListPage {
  @State contacts: Array<Contact> = [];
  @State keyword: string = '';
  // åˆ—è¡¨ç‰ˆæœ¬å·ï¼Œç”¨äºè¾…åŠ©å¼ºåˆ¶åˆ·æ–°
  @State listVersion: number = 0;
  @Consume('pageStack') pageStack: NavPathStack;
  dialogController: CustomDialogController = new CustomDialogController({
    builder: AddContactDialog({
      onConfirm: (name: string, phone: string, relation: string, email: string) => {
        this.addContact(name, phone, relation, email);
      }
    }),
    alignment: DialogAlignment.Bottom,
    autoCancel: true
  });
  // ğŸ“ [æ–°å¢] å®ä¾‹åŒ– ViewModel
  private contactViewModel = new ContactViewModel();

  get contactCountInfo(): Resource {
    const count: number = this.contacts.length;
    return $r('app.plural.contact_count_info', count, count);
  }

  aboutToAppear(): void {
    logger.info('ã€ç”Ÿå‘½å‘¨æœŸã€‘ContactListPage aboutToAppear');
    this.loadContacts();

    logger.info(`ã€äº‹ä»¶ã€‘æ³¨å†Œç›‘å¬ ID: ${CommonConstants.EVENT_ID_REFRESH}`);
    emitter.on({ eventId: CommonConstants.EVENT_ID_REFRESH }, () => {
      logger.info('ã€äº‹ä»¶ã€‘æ”¶åˆ°åˆ·æ–°ä¿¡å·ï¼Œå»¶è¿Ÿ 50ms æ‰§è¡Œåˆ·æ–°...');
      setTimeout(() => {
        this.loadContacts();
      }, 50);
    });
  }

  aboutToDisappear(): void {
    logger.info('ã€ç”Ÿå‘½å‘¨æœŸã€‘ContactListPage aboutToDisappear');
    emitter.off(CommonConstants.EVENT_ID_REFRESH);
  }

  async loadContacts(): Promise<void> {
    logger.info('ã€æ•°æ®ã€‘æ­£åœ¨ä»æ•°æ®åº“åŠ è½½...');
    try {
      let list: Contact[];
      if (this.keyword && this.keyword.trim().length > 0) {
        list = await ContactModel.search(this.keyword);
      } else {
        list = await ContactModel.queryAll();
      }

      this.contacts = [];
      setTimeout(() => {
        this.contacts = Array.isArray(list) ? list : [];
        this.listVersion++;
        logger.info(`ã€æ•°æ®ã€‘åˆ·æ–°å®Œæˆï¼Œå½“å‰æ¡æ•°: ${this.contacts.length}`);
      }, 0);

    } catch (err) {
      logger.error(`ã€æ•°æ®ã€‘åŠ è½½å¼‚å¸¸: ${JSON.stringify(err)}`);
      this.contacts = [];
    }
  }

  async addContact(name: string, phone: string, relation: string, email: string): Promise<void> {
    // ğŸ“ [ä¿®æ”¹] ä½¿ç”¨ ViewModel è¿›è¡Œå›½é™…åŒ–æ ¡éªŒ
    const errorKey = this.contactViewModel.validateContact(name, phone);
    if (errorKey) {
      // åŠ¨æ€æ‹¼æ¥ app.string.xxx
      promptAction.showToast({ message: $r(`app.string.${errorKey}`) });
      return;
    }

    // ğŸ“ [ä¿®æ”¹] å¤„ç†é»˜è®¤å…³ç³» (å›½é™…åŒ–)
    // å¦‚æœç”¨æˆ·æ²¡å¡«å…³ç³»ï¼Œæ‰‹åŠ¨è·å– "æœ‹å‹" çš„æœ¬åœ°åŒ–å­—ç¬¦ä¸²
    let finalRelation = relation;
    if (!finalRelation || finalRelation.trim() === '') {
      try {
        finalRelation = getContext(this).resourceManager.getStringSync($r('app.string.contact_default_relation').id);
      } catch (e) {
        finalRelation = 'Friend'; // å…œåº•
      }
    }

    const newContact: Contact = new Contact(name, phone, finalRelation, email);
    if (await ContactModel.insert(newContact) > 0) {
      this.keyword = '';
      await this.loadContacts();
      promptAction.showToast({ message: $r('app.string.toast_add_success') });
    }
  }

  async deleteContact(index: number, id: number): Promise<void> {
    if (await ContactModel.deleteById(id)) {
      this.contacts.splice(index, 1);
    }
  }

  build() {
    Column() {
      this.CustomHeader()
      this.SearchBar()

      GridRow({ columns: { sm: 4, md: 8, lg: 12 }, gutter: { x: 12, y: 12 } }) {
        GridCol({ span: { sm: 4, md: 6, lg: 8 }, offset: { sm: 0, md: 1, lg: 2 } }) {
          Column() {
            if (this.contacts.length === 0) {
              Column() {
                Text($r('app.string.contact_empty_list'))
                  .fontColor(Color.Gray)
                  .fontSize(16)
                  .margin({ top: 100 })
              }
              .width('100%').alignItems(HorizontalAlign.Center)
            } else {
              List({ space: 10 }) {
                ForEach(this.contacts, (item: Contact, index: number) => {
                  this.ContactItem(item, index);
                }, (item: Contact) => {
                  return JSON.stringify(item);
                })
              }
              .width('100%').layoutWeight(1).padding({ left: 16, right: 16, bottom: 10 })
            }
          }
          .width('100%').height('100%')
        }
      }
      .layoutWeight(1)
    }
    .width('100%').height('100%').backgroundColor('#F1F3F5')
  }

  private getAvatarText(name: string): string {
    const safe: string = (name ?? '').trim();
    return safe.length > 0 ? safe.substring(0, 1) : '?';
  }

  @Builder
  private DeleteAction(index: number, id: number): void {
    Row() {
      Button($r('app.string.btn_delete'))
        .type(ButtonType.Normal)
        .backgroundColor(Color.Red)
        .fontColor(Color.White)
        .constraintSize({ minWidth: 80, minHeight: 48 })
        .onClick(() => {
          void this.deleteContact(index, id);
        })
    }
    .height('100%')
    .justifyContent(FlexAlign.End)
  }

  @Builder
  private CustomHeader(): void {
    Row() {
      Text($r('app.string.contact_title'))
        .fontSize(24).fontWeight(FontWeight.Bold)
      Blank()
      Button({ type: ButtonType.Circle, stateEffect: true }) {
        Text('+').fontSize(24).fontColor(Color.Black)
      }
      .width(40).height(40).backgroundColor(Color.Transparent)
      .onClick(() => {
        this.dialogController.open();
      })
    }
    .width('100%').height(56).padding({ left: 16, right: 16 }).alignItems(VerticalAlign.Center)
  }

  @Builder
  private SearchBar(): void {
    Row() {
      Search({ value: this.keyword, placeholder: $r('app.string.contact_search_placeholder') })
        .width('100%').height(40).backgroundColor(Color.White)
        .onChange((value: string) => {
          this.keyword = value;
          this.loadContacts();
        })
    }
    .width('100%').padding({ left: 16, right: 16, bottom: 8 })
  }

  @Builder
  private ContactItem(item: Contact, index: number): void {
    ListItem() {
      Row() {
        Stack({ alignContent: Alignment.Center }) {
          Circle({ width: 40, height: 40 }).fill('#E5F1FF')
          Text(this.getAvatarText(item.name)).fontSize(16).fontColor('#007DFF')
        }

        Column() {
          Text(item.name ?? '').fontSize(16).fontWeight(FontWeight.Medium)
          // ğŸ“ [ä¿®æ”¹] ä½¿ç”¨ Resource æ ¼å¼åŒ–
          // Text(`${item.relation ?? ''} | ${item.phone ?? ''}`) æ”¹ä¸ºä½¿ç”¨èµ„æºæ¨¡æ¿
          Text($r('app.string.contact_relation_phone_format', item.relation ?? '', item.phone ?? ''))
            .fontSize(14).fontColor('#999999').margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start).margin({ left: 12 }).layoutWeight(1)
      }
      .width('100%')
      .padding(12)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .onClick(() => {
        logger.info(`ã€æ“ä½œã€‘è¿›å…¥è¯¦æƒ…é¡µ: ${item.name}`);
        this.pageStack.pushPath({ name: 'ContactDetailPage', param: item });
      })
    }
    .swipeAction({
      end: () => {
        this.DeleteAction(index, item.id);
      }
    })
  }
}

@CustomDialog
struct AddContactDialog {
  controller?: CustomDialogController;
  @State name: string = '';
  @State phone: string = '';
  @State relation: string = '';
  @State email: string = '';
  onConfirm: (name: string, phone: string, relation: string, email: string) => void = () => {
  };

  build() {
    Column() {
      Text($r('app.string.contact_btn_add')).fontSize(20).fontWeight(FontWeight.Bold).margin({ top: 20, bottom: 20 })
      TextInput({ placeholder: $r('app.string.contact_label_name') }).onChange((v) => {
        this.name = v;
      }).margin({ bottom: 12 }).width('90%')
      TextInput({ placeholder: $r('app.string.contact_label_phone') }).onChange((v) => {
        this.phone = v;
      }).margin({ bottom: 12 }).width('90%')
      TextInput({ placeholder: $r('app.string.contact_label_email') }).onChange((v) => {
        this.email = v;
      }).margin({ bottom: 12 }).width('90%')
      TextInput({ placeholder: $r('app.string.contact_label_relation') }).onChange((v) => {
        this.relation = v;
      }).margin({ bottom: 20 }).width('90%')
      Row() {
        Button($r('app.string.common_cancel')).backgroundColor(Color.Transparent).fontColor(Color.Gray).onClick(() => {
          this.controller?.close();
        })
        Button($r('app.string.common_add')).onClick(() => {
          this.onConfirm(this.name, this.phone, this.relation, this.email);
          this.controller?.close();
        })
      }
      .justifyContent(FlexAlign.SpaceEvenly).width('100%').margin({ bottom: 20 })
    }
    .backgroundColor(Color.White).borderRadius(24).width('100%')
  }
}