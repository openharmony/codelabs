/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// entry/src/main/ets/pages/EventDetailPage.ets
import { Event, EventModel } from '../model/EventModel';
import { DateUtils } from '../common/utils/DateUtils';
import { StyleConstants } from '../common/constants/StyleConstants';
import { promptAction } from '@kit.ArkUI';
import { Logger } from '../common/utils/Logger';

const logger = new Logger('EventDetailPage');

@Component
export struct EventDetailPage {
  // 1. æŽ¥æ”¶ä»Ž MainPage è·¯ç”±ä¼ é€’çš„å‚æ•°
  @State eventItem: Event | undefined = undefined;
  @State forceUpdateTrigger: number = 0;
  // 2. æŽ¥æ”¶è·¯ç”±æ ˆ
  @Consume('pageStack') pageStack: NavPathStack;
  // 3. ç›‘å¬åˆ—è¡¨åˆ·æ–°ä¿¡å·ï¼ˆåªç”¨äºŽåˆ é™¤æ—¶é€šçŸ¥åˆ—è¡¨é¡µï¼Œä¸ç”¨æ¥åˆ·æ–°è‡ªå·±äº†ï¼‰
  @StorageProp('refreshEventList') refreshSignal: number = 0;

  /**
   * æ ¸å¿ƒåˆ·æ–°é€»è¾‘ï¼šæ ¹æ® ID æŸ¥åº“
   */
  async reloadFromDb() {
    // 1. å…ˆæŸ¥åº“ï¼Œæ‹¿åˆ°æœ€æ–°çš„æ•°æ®
    if (this.eventItem && this.eventItem.id) {
      const freshData = await EventModel.queryById(this.eventItem.id);

      if (freshData) {
        logger.error(`[DEBUG_FORCE] æŸ¥åˆ°æ–°æ•°æ®: ${freshData.startTime}, å‡†å¤‡æ‰§è¡Œã€æ¯ç­é‡ç”Ÿã€‘åˆ·æ–°`);

        // ðŸ”¥ðŸ”¥ðŸ”¥ã€ç¬¬ä¸€æ­¥ã€‘é”€æ¯ UI ðŸ”¥ðŸ”¥ðŸ”¥
        // è®¾ä¸º undefinedï¼Œbuild() é‡Œçš„ if (this.eventItem) ä¼šå˜æˆ false
        // æ•´ä¸ªè¯¦æƒ…é¡µçš„å†…å®¹ä¼šè¢«ä»Žå±å¹•ä¸Šç§»é™¤
        this.eventItem = undefined;

        // ðŸ”¥ðŸ”¥ðŸ”¥ã€ç¬¬äºŒæ­¥ã€‘é‡å»º UI ðŸ”¥ðŸ”¥ðŸ”¥
        // å»¶è¿Ÿ 10ms (æžçŸ­æ—¶é—´ï¼Œäººçœ¼å‡ ä¹Žçœ‹ä¸å‡ºé—ªçƒï¼Œä½†è¶³å¤Ÿè®©å¼•æ“Žé‡ç»˜)
        setTimeout(() => {
          this.eventItem = freshData; // é‡æ–°èµ‹å€¼ï¼ŒUI é‡æ–°åˆ›å»ºï¼Œè¯»å–æ–°æ—¶é—´
          logger.error('[DEBUG_FORCE] UI å·²é‡å»ºï¼Œæ—¶é—´åº”ä¸ºæœ€æ–°');
        }, 10);
      }
    }
  }

  @Builder
  DetailItem(label: ResourceStr, value: ResourceStr, icon?: Resource) {
    Row() {
      if (icon) {
        Image(icon).width(20).height(20).margin({ right: 12 }).fillColor(StyleConstants.COLOR_PRIMARY)
      } else {
        Circle({ width: 8, height: 8 }).fill(StyleConstants.COLOR_PRIMARY).margin({ right: 12 })
      }

      Column() {
        Text(label)
          .fontSize(12)
          .fontColor(StyleConstants.COLOR_TEXT_SECONDARY)
          .margin({ bottom: 4 })

        Text(value)
          .fontSize(16)
          .fontColor(StyleConstants.COLOR_TEXT_PRIMARY)
          .fontWeight(FontWeight.Medium)
      }
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding({ top: 16, bottom: 16 })
    .border({ width: { bottom: 1 }, color: '#F0F0F0' })
  }

  build() {
    // NavDestination æ˜¯å¤„ç† Navigation é¡µé¢ç”Ÿå‘½å‘¨æœŸçš„å…³é”®
    NavDestination() {
      Column() {
        // --- 1. æ ‡é¢˜æ  ---
        Row() {
          Image($r('app.media.ic_back'))
            .width(24).height(24)
            .onClick(() => this.pageStack.pop())

          Text($r('app.string.event_title_detail'))
            .fontSize(20).fontWeight(FontWeight.Bold)
            .margin({ left: 16 })
            .layoutWeight(1)

          Row() {
            Text($r('app.string.common_edit'))
              .fontSize(16).fontColor(StyleConstants.COLOR_PRIMARY)
              .margin({ right: 16 })
              .onClick(() => this.handleEdit())

            Text($r('app.string.common_delete'))
              .fontSize(16).fontColor(StyleConstants.COLOR_DANGER)
              .onClick(() => this.handleDelete())
          }
        }
        .width('100%').height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor(Color.White)

        if (this.eventItem) {
          Scroll() {
            Column() {
              // --- 2. é¡¶éƒ¨å¡ç‰‡ ---
              Column() {
                Text(this.eventItem.title)
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(StyleConstants.COLOR_TEXT_PRIMARY)
                  .margin({ bottom: 12 })

                Row() {
                  if (this.eventItem.isAllDay) {
                    Text($r('app.string.event_label_all_day'))
                      .fontSize(12)
                      .fontColor(Color.White)
                      .backgroundColor(StyleConstants.COLOR_PRIMARY)
                      .padding({
                        left: 8,
                        right: 8,
                        top: 4,
                        bottom: 4
                      })
                      .borderRadius(4)
                      .margin({ right: 8 })
                  }

                  if (this.eventItem.reminderId > -1) {
                    Text($r('app.string.event_label_reminder_on'))
                      .fontSize(12)
                      .fontColor(StyleConstants.COLOR_SUCCESS)
                      .backgroundColor('#E8F5E9')
                      .padding({
                        left: 8,
                        right: 8,
                        top: 4,
                        bottom: 4
                      })
                      .borderRadius(4)
                  }
                }
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .padding(24)
              .backgroundColor(Color.White)
              .margin({ bottom: 12 })

              // --- 3. è¯¦ç»†ä¿¡æ¯ ---
              Column() {
                this.DetailItem($r('app.string.event_label_start_time'),
                  DateUtils.formatFull(this.eventItem.startTime) + (this.forceUpdateTrigger >= 0 ? "" : ""))
                this.DetailItem($r('app.string.event_label_end_time'),
                  DateUtils.formatFull(this.eventItem.endTime) + (this.forceUpdateTrigger >= 0 ? "" : ""))
                this.DetailItem($r('app.string.event_label_desc'),
                  this.eventItem.description || $r('app.string.event_no_desc'))
              }
              .padding({ left: 24, right: 24 })
              .backgroundColor(Color.White)
              .width('100%')
            }
            .width('100%')
          }
          .layoutWeight(1)
          .backgroundColor('#F1F3F5')
        } else {
          Column() {
            Text($r('app.string.event_not_found')).fontSize(16).fontColor(Color.Gray)
          }
          .height('100%').justifyContent(FlexAlign.Center)
        }
      }
      .width('100%').height('100%').backgroundColor('#F1F3F5')
    }
    .hideTitleBar(true)
    // ä½¿ç”¨ .onShown() ç”Ÿå‘½å‘¨æœŸ
    // å½“ç¼–è¾‘é¡µ popï¼Œè¯¦æƒ…é¡µé‡æ–°æ˜¾ç¤ºæ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨
    .onShown(() => {
      logger.info('[DEBUG] onShown è§¦å‘ï¼Œå»¶æ—¶æ‰§è¡Œåˆ·æ–°...');
      setTimeout(() => {
        this.reloadFromDb();
      }, 50); // 50æ¯«ç§’è¶³å¤Ÿè®©é¡µé¢ç¨³å®šä¸‹æ¥ï¼Œä»Žè€Œæ­£ç¡®å“åº” UI åˆ·æ–°
    })
  }

  /**
   * å¤„ç†åˆ é™¤æ“ä½œ
   */
  private handleDelete() {
    promptAction.showDialog({
      title: $r('app.string.event_delete_title'),
      message: $r('app.string.event_delete_confirm'),
      buttons: [
        { text: $r('app.string.common_cancel'), color: StyleConstants.COLOR_TEXT_SECONDARY },
        { text: $r('app.string.common_delete'), color: StyleConstants.COLOR_DANGER }
      ]
    }).then(async (resp) => {
      if (resp.index === 1 && this.eventItem) {
        await EventModel.deleteById(this.eventItem.id);
        promptAction.showToast({ message: $r('app.string.event_toast_deleted') });

        // é€šçŸ¥åˆ—è¡¨é¡µåˆ·æ–°
        AppStorage.setOrCreate('refreshEventList', Date.now());

        this.pageStack.pop();
      }
    });
  }

  private handleEdit() {
    if (this.eventItem) {
      this.pageStack.pushPath({ name: 'EventEditPage', param: this.eventItem });
    }
  }
}