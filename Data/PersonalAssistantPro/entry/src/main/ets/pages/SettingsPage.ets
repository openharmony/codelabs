import { SettingModel } from '../model/SettingModel';
import { BiometricService } from '../services/BiometricService';
import promptAction from '@ohos.promptAction';
import { Logger } from '../common/utils/Logger';

@Component
export struct SettingsPage {
  // é»˜è®¤ç»™ falseï¼Œç­‰å¾… aboutToAppear è¯»å–çœŸå®å€¼
  @State isBiometricOn: boolean = false;

  private settingModel = new SettingModel();
  private logger = new Logger('SettingsPage');

  // é¡µé¢å³å°†æ˜¾ç¤ºæ—¶è§¦å‘
  async aboutToAppear() {
    this.logger.info('ğŸš€ [Page] è¿›å…¥è®¾ç½®é¡µï¼Œå¼€å§‹è¯»å–é…ç½®...');

    try {
      // 1. ä»æ•°æ®åº“/é¦–é€‰é¡¹è¯»å–æœ€æ–°çŠ¶æ€
      const savedStatus = await this.settingModel.isBiometricEnabled();
      this.logger.info(`ğŸ“„ [Page] è¯»åˆ°çš„çŠ¶æ€æ˜¯: ${savedStatus}`);

      // 2. æ›´æ–° UI (è¿™ä¼šè®©å¼€å…³è‡ªåŠ¨è·³åˆ°æ­£ç¡®ä½ç½®)
      this.isBiometricOn = savedStatus;

    } catch (err) {
      this.logger.error('âŒ [Page] è¯»å–é…ç½®å¤±è´¥', err);
    }
  }

  build() {
    NavDestination() {
      Column() {
        List() {
          ListItem() {
            Row() {
              Column() {
                Text($r('app.string.biometric_title'))
                  .fontSize(16)
                  .fontColor('#333333')
                  .fontWeight(FontWeight.Medium)
                Text($r('app.string.biometric_desc'))
                  .fontSize(12)
                  .fontColor('#999999')
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              // å¼€å…³ç»„ä»¶
              Toggle({ type: ToggleType.Switch, isOn: this.isBiometricOn })
                .onChange(async (isOn: boolean) => {
                  // ä¸ºäº†é˜²æ­¢é¡µé¢åˆå§‹åŒ–æ—¶è‡ªåŠ¨è§¦å‘ onChange å¯¼è‡´é€»è¾‘æ­»å¾ªç¯ï¼Œ
                  // æˆ‘ä»¬åœ¨è¿™é‡Œåšä¸€ä¸ªç®€å•çš„åˆ¤æ–­ï¼Œæˆ–è€…æ˜¯ä¾é ç”¨æˆ·çš„çœŸå®ç‚¹å‡»ã€‚
                  // ä½†æœ€ç¨³å¦¥çš„æ–¹å¼æ˜¯ç›´æ¥å¤„ç†ã€‚

                  this.logger.info(`ğŸ‘† [UI] å¼€å…³è¢«ç‚¹å‡»/æ”¹å˜: ${isOn}`);

                  if (isOn) {
                    // === ç”¨æˆ·æƒ³å¼€å¯ ===
                    // å…ˆéªŒè¯æŒ‡çº¹
                    const success = await BiometricService.getInstance().authenticate();
                    if (success) {
                      this.isBiometricOn = true;
                      // ä¿å­˜ä¸º true
                      await this.settingModel.setBiometricEnabled(true);
                      promptAction.showToast({ message: 'ç”Ÿç‰©è®¤è¯å·²å¼€å¯' });
                    } else {
                      // éªŒè¯å¤±è´¥ï¼ŒæŠŠå¼€å…³æ‹¨å›å»
                      this.isBiometricOn = false;
                      promptAction.showToast({ message: 'è®¤è¯å¤±è´¥' });
                    }
                  } else {
                    // === ç”¨æˆ·æƒ³å…³é—­ ===
                    // ç›´æ¥ä¿å­˜ä¸º false
                    this.isBiometricOn = false;
                    await this.settingModel.setBiometricEnabled(false);
                  }
                })
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 12 })
            .backgroundColor(Color.White)
            .borderRadius(12)
          }
        }
        .width('100%')
        .margin({ top: 12 })
        .padding({ left: 12, right: 12 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F1F3F5')
    }
    .title($r('app.string.settings_title'))
    .backgroundColor('#F1F3F5')
  }
}