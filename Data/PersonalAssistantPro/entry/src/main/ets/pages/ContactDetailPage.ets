/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// File: entry/src/main/ets/pages/ContactDetailPage.ets
import { Contact, ContactModel } from '../model/ContactModel';
import { SettingModel } from '../model/SettingModel';
import { BiometricService } from '../services/BiometricService';
import promptAction from '@ohos.promptAction';

@Component
export struct ContactDetailPage {
  @State contact: Contact = new Contact('', '', '');

  // ðŸ”’ éšç§ä¸Žè§£é”çŠ¶æ€
  @State isPrivacyOn: boolean = false;
  @State isUnlocked: boolean = false;

  private settingModel = new SettingModel();

  //  [æ–°å¢ž] ç¼–è¾‘å¼¹çª—æŽ§åˆ¶å™¨
  editDialogController: CustomDialogController = new CustomDialogController({
    builder: EditContactDialog({
      // ä¼ å…¥å½“å‰æ•°æ®ç”¨äºŽå›žæ˜¾
      name: this.contact.name,
      phone: this.contact.phone,
      relation: this.contact.relation,
      email: this.contact.email,
      onConfirm: (name, phone, relation, email) => {
        this.saveContact(name, phone, relation, email);
      }
    }),
    alignment: DialogAlignment.Bottom,
    autoCancel: true
  });

  private getAvatarText(): string {
    const name = this.contact.name || '';
    return name.length > 0 ? name.substring(0, 1).toUpperCase() : '?';
  }

  async aboutToAppear() {
    this.isPrivacyOn = await this.settingModel.isBiometricEnabled();
    if (!this.isPrivacyOn) {
      this.isUnlocked = true;
    }
  }

  async unlock() {
    const success = await BiometricService.getInstance().authenticate();
    if (success) {
      this.isUnlocked = true;
      promptAction.showToast({ message: $r('app.string.unlock_success') });
    } else {
      promptAction.showToast({ message: $r('app.string.unlock_fail') });
    }
  }

  //  [æ–°å¢ž] ä¿å­˜ä¿®æ”¹é€»è¾‘
  async saveContact(name: string, phone: string, relation: string, email: string) {
    // 1. æ›´æ–°å†…å­˜å¯¹è±¡
    this.contact.name = name;
    this.contact.phone = phone;
    this.contact.relation = relation;
    this.contact.email = email;

    // 2. æ›´æ–°æ•°æ®åº“
    const success = await ContactModel.update(this.contact);

    if (success) {
      promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸ' });
    } else {
      promptAction.showToast({ message: 'ä¿®æ”¹å¤±è´¥' });
    }
  }

  //  [æ–°å¢ž] ç‚¹å‡»ç¼–è¾‘æŒ‰é’®é€»è¾‘
  handleEditClick() {
    // å®‰å…¨ç­–ç•¥ï¼šå¦‚æžœå¼€å¯äº†éšç§ä¿æŠ¤ä¸”æœªè§£é”ï¼Œç¦æ­¢ç¼–è¾‘ï¼ˆé˜²æ­¢ç»•è¿‡è§£é”æŸ¥çœ‹å·ç ï¼‰
    if (this.isPrivacyOn && !this.isUnlocked) {
      promptAction.showToast({ message: 'è¯·å…ˆè§£é”ä»¥ç¼–è¾‘éšç§ä¿¡æ¯' });
      this.unlock();
    } else {
      this.editDialogController.open();
    }
  }

  build() {
    NavDestination() {
      GridRow({
        columns: { sm: 4, md: 8, lg: 12 },
        gutter: { x: 12, y: 12 }
      }) {
        GridCol({
          span: { sm: 4, md: 6, lg: 8 },
          offset: { sm: 0, md: 1, lg: 2 }
        }) {
          Column() {
            // --- å¤´éƒ¨åŒºåŸŸ ---
            Column() {
              Stack({ alignContent: Alignment.Center }) {
                Circle({ width: 80, height: 80 }).fill('#E5F1FF')
                Text(this.getAvatarText())
                  .fontSize(30)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#007DFF')
              }
              .margin({ top: 40, bottom: 16 })

              Text(this.contact.name)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.Black)
                .margin({ bottom: 8 })

              Text(this.contact.relation)
                .fontSize(14)
                .fontColor(Color.Gray)
                .padding({ left: 12, right: 12, top: 4, bottom: 4 })
                .backgroundColor('#EFEFEF')
                .borderRadius(16)
            }
            .width('100%')
            .alignItems(HorizontalAlign.Center)

            // --- è¯¦æƒ…åˆ—è¡¨åŒºåŸŸ ---
            List() {
              // ðŸ“ž ç”µè¯
              ListItem() {
                Row() {
                  Text($r('app.string.contact_detail_phone'))
                    .width(80)
                    .fontColor(Color.Gray)
                    .fontSize(16)

                  if (this.isUnlocked) {
                    Text(this.contact.phone)
                      .fontWeight(FontWeight.Regular)
                      .fontSize(16)
                      .fontColor(Color.Black)
                      .layoutWeight(1)
                      .textAlign(TextAlign.End)
                  } else {
                    Row() {
                      Text(this.contact.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2'))
                        .fontSize(16)
                        .fontColor(Color.Black)
                        .layoutWeight(1)
                        .textAlign(TextAlign.End)
                        .margin({ right: 8 })

                      Button($r('app.string.btn_view'))
                        .type(ButtonType.Capsule)
                        .height(24)
                        .fontSize(12)
                        .backgroundColor('#007DFF')
                        .onClick(() => { this.unlock(); })
                    }
                    .layoutWeight(1)
                    .justifyContent(FlexAlign.End)
                  }
                }
                .width('100%')
                .padding(16)
                .backgroundColor(Color.White)
              }

              // ðŸ“§ é‚®ç®±
              this.DetailItem(
                $r('app.string.contact_detail_email'),
                this.contact.email || $r('app.string.contact_detail_empty')
              )

              // ðŸ”— å…³ç³»
              this.DetailItem(
                $r('app.string.contact_detail_relation'),
                this.contact.relation
              )
            }
            .width('100%')
            .borderRadius(16)
            .margin({ top: 30 })
            .backgroundColor(Color.White)
            .divider({ strokeWidth: 0.5, color: '#F0F0F0', startMargin: 16, endMargin: 16 })
          }
          .width('100%')
          .height('100%')
          .padding({ left: 16, right: 16 })
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F1F3F5')
    }
    .title($r('app.string.contact_detail_title'))
    .backgroundColor('#F1F3F5')
    //  [æ–°å¢ž] å³ä¸Šè§’èœå•
    .menus([
      {
        value: $r('app.string.btn_edit'),
        icon: $r('app.media.ic_edit_box'),
        action: () => {
          this.handleEditClick();
        }
      }
    ])
  }

  @Builder DetailItem(label: Resource, value: string | Resource) {
    ListItem() {
      Row() {
        Text(label)
          .width(80)
          .fontColor(Color.Gray)
          .fontSize(16)

        Text(value)
          .fontWeight(FontWeight.Regular)
          .fontSize(16)
          .fontColor(Color.Black)
          .layoutWeight(1)
          .textAlign(TextAlign.End)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .maxLines(1)
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
    }
  }
}

//  [æ–°å¢ž] ç¼–è¾‘å¼¹çª—ç»„ä»¶
@CustomDialog
struct EditContactDialog {
  controller?: CustomDialogController;
  onConfirm: (name: string, phone: string, relation: string, email: string) => void = () => {};

  // è¿™é‡Œçš„ State ç”¨æ¥æŽ¥æ”¶åˆå§‹å€¼å¹¶æ”¯æŒç”¨æˆ·ä¿®æ”¹
  @State name: string = '';
  @State phone: string = '';
  @State relation: string = '';
  @State email: string = '';

  build() {
    Column() {
      Text('ç¼–è¾‘è”ç³»äºº')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 20 })

      TextInput({ text: this.name, placeholder: $r('app.string.input_name') })
        .onChange((v) => { this.name = v; })
        .margin({ bottom: 12 }).width('90%')

      TextInput({ text: this.phone, placeholder: $r('app.string.input_phone') })
        .onChange((v) => { this.phone = v; })
        .margin({ bottom: 12 }).width('90%')

      TextInput({ text: this.email, placeholder: 'è¯·è¾“å…¥é‚®ç®±' })
        .onChange((v) => { this.email = v; })
        .margin({ bottom: 12 }).width('90%')

      TextInput({ text: this.relation, placeholder: $r('app.string.input_relation') })
        .onChange((v) => { this.relation = v; })
        .margin({ bottom: 20 }).width('90%')

      Row() {
        Button($r('app.string.btn_cancel'))
          .backgroundColor(Color.Transparent)
          .fontColor(Color.Gray)
          .onClick(() => { this.controller?.close(); })

        Button($r('app.string.btn_save')) // å»ºè®®æ·»åŠ  string: "ä¿å­˜"
          .onClick(() => {
            this.onConfirm(this.name, this.phone, this.relation, this.email);
            this.controller?.close();
          })
      }
      .justifyContent(FlexAlign.SpaceEvenly).width('100%').margin({ bottom: 20 })
    }
    .backgroundColor(Color.White).borderRadius(24).width('100%')
  }
}