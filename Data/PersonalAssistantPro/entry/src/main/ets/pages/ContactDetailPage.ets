// File: entry/src/main/ets/pages/ContactDetailPage.ets
import { Contact } from '../model/ContactModel';
import { SettingModel } from '../model/SettingModel'; // âœ… å¼•å…¥é…ç½®æ¨¡å‹
import { BiometricService } from '../services/BiometricService'; // âœ… å¼•å…¥ç”Ÿç‰©è®¤è¯æœåŠ¡
import promptAction from '@ohos.promptAction';

@Component
export struct ContactDetailPage {
  // æ¥æ”¶é¡µé¢è·¯ç”±ä¼ é€’è¿‡æ¥çš„å‚æ•°
  @State contact: Contact = new Contact('', '', '');

  // ğŸ”’ æ–°å¢ï¼šéšç§ä¸è§£é”çŠ¶æ€
  @State isPrivacyOn: boolean = false; // æ€»å¼€å…³ï¼šæ˜¯å¦å¼€å¯äº†éšç§ä¿æŠ¤
  @State isUnlocked: boolean = false;  // å½“å‰çŠ¶æ€ï¼šæ˜¯å¦å·²è§£é”æŸ¥çœ‹

  private settingModel = new SettingModel();

  // è·å–å¤´åƒæ–‡å­—
  private getAvatarText(): string {
    const name = this.contact.name || '';
    return name.length > 0 ? name.substring(0, 1).toUpperCase() : '?';
  }

  // âœ… ç”Ÿå‘½å‘¨æœŸï¼šæ£€æŸ¥éšç§è®¾ç½®
  async aboutToAppear() {
    // 1. è¯»å–è®¾ç½®ï¼šç”¨æˆ·æ˜¯å¦åœ¨â€œæˆ‘çš„â€é‡Œå¼€å¯äº†éšç§é”ï¼Ÿ
    this.isPrivacyOn = await this.settingModel.isBiometricEnabled();

    // 2. é€»è¾‘åˆ¤æ–­ï¼šå¦‚æœæ²¡å¼€é”ï¼Œé»˜è®¤å°±æ˜¯â€œå·²è§£é”â€çŠ¶æ€ï¼Œç›´æ¥çœ‹
    // åªæœ‰â€œå¼€å¯äº†éšç§é”â€ä¸”â€œå°šæœªéªŒè¯â€ï¼ŒisUnlocked æ‰æ˜¯ false
    if (!this.isPrivacyOn) {
      this.isUnlocked = true;
    }
  }

  // âœ… æ ¸å¿ƒä¸šåŠ¡ï¼šè§¦å‘æŒ‡çº¹è§£é”
  async unlock() {
    const success = await BiometricService.getInstance().authenticate();
    if (success) {
      this.isUnlocked = true; // æ”¹å˜çŠ¶æ€ï¼ŒUI ä¼šè‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºçœŸå·ç 
      promptAction.showToast({ message: $r('app.string.unlock_success') });
    } else {
      promptAction.showToast({ message: $r('app.string.unlock_fail') });
    }
  }

  build() {
    NavDestination() {
      GridRow({
        columns: { sm: 4, md: 8, lg: 12 },
        gutter: { x: 12, y: 12 }
      }) {
        GridCol({
          span: { sm: 4, md: 6, lg: 8 },
          offset: { sm: 0, md: 1, lg: 2 }
        }) {
          Column() {
            // --- å¤´éƒ¨åŒºåŸŸ ---
            Column() {
              Stack({ alignContent: Alignment.Center }) {
                Circle({ width: 80, height: 80 }).fill('#E5F1FF')
                Text(this.getAvatarText())
                  .fontSize(30)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#007DFF')
              }
              .margin({ top: 40, bottom: 16 })

              Text(this.contact.name)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.Black)
                .margin({ bottom: 8 })

              Text(this.contact.relation)
                .fontSize(14)
                .fontColor(Color.Gray)
                .padding({ left: 12, right: 12, top: 4, bottom: 4 })
                .backgroundColor('#EFEFEF')
                .borderRadius(16)
            }
            .width('100%')
            .alignItems(HorizontalAlign.Center)

            // --- è¯¦æƒ…åˆ—è¡¨åŒºåŸŸ ---
            List() {
              // ğŸ“ ç”µè¯ (æ ¸å¿ƒä¿®æ”¹ç‚¹ï¼šæ ¹æ®è§£é”çŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹)
              ListItem() {
                Row() {
                  Text($r('app.string.contact_detail_phone')) // "ç”µè¯"
                    .width(80)
                    .fontColor(Color.Gray)
                    .fontSize(16)

                  if (this.isUnlocked) {
                    // âœ… æƒ…å†µ Aï¼šå·²è§£é”/æ²¡å¼€é” -> æ˜¾ç¤ºçœŸå®å·ç 
                    Text(this.contact.phone)
                      .fontWeight(FontWeight.Regular)
                      .fontSize(16)
                      .fontColor(Color.Black)
                      .layoutWeight(1)
                      .textAlign(TextAlign.End)
                  } else {
                    // ğŸ”’ æƒ…å†µ Bï¼šæœªè§£é” -> æ˜¾ç¤ºæ©ç  + æŒ‰é’®
                    Row() {
                      // 138****1234
                      Text(this.contact.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2'))
                        .fontSize(16)
                        .fontColor(Color.Black)
                        .layoutWeight(1)
                        .textAlign(TextAlign.End)
                        .margin({ right: 8 })

                      // æŸ¥çœ‹æŒ‰é’®
                      Button($r('app.string.btn_view')) // "æŸ¥çœ‹"
                        .type(ButtonType.Capsule)
                        .height(24)
                        .fontSize(12)
                        .backgroundColor('#007DFF')
                        .onClick(() => {
                          this.unlock(); // ç‚¹å‡»è§¦å‘æŒ‡çº¹
                        })
                    }
                    .layoutWeight(1)
                    .justifyContent(FlexAlign.End)
                  }
                }
                .width('100%')
                .padding(16)
                .backgroundColor(Color.White)
              }

              // ğŸ“§ é‚®ç®± (æ™®é€šå±•ç¤º)
              this.DetailItem(
                $r('app.string.contact_detail_email'),
                this.contact.email || $r('app.string.contact_detail_empty')
              )

              // ğŸ”— å…³ç³» (æ™®é€šå±•ç¤º)
              this.DetailItem(
                $r('app.string.contact_detail_relation'),
                this.contact.relation
              )
            }
            .width('100%')
            .borderRadius(16)
            .margin({ top: 30 })
            .backgroundColor(Color.White)
            .divider({
              strokeWidth: 0.5,
              color: '#F0F0F0',
              startMargin: 16,
              endMargin: 16
            })
          }
          .width('100%')
          .height('100%')
          .padding({ left: 16, right: 16 })
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F1F3F5')
    }
    .title($r('app.string.contact_detail_title'))
    .backgroundColor('#F1F3F5')
  }

  // æ™®é€šåˆ—è¡¨é¡¹ Builder (ä¿æŒåŸæ ·)
  @Builder DetailItem(label: Resource, value: string | Resource) {
    ListItem() {
      Row() {
        Text(label)
          .width(80)
          .fontColor(Color.Gray)
          .fontSize(16)

        Text(value)
          .fontWeight(FontWeight.Regular)
          .fontSize(16)
          .fontColor(Color.Black)
          .layoutWeight(1)
          .textAlign(TextAlign.End)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .maxLines(1)
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
    }
  }
}