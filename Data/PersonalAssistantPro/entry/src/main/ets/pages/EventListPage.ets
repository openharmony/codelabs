/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// entry/src/main/ets/pages/EventListPage.ets
import { Event, EventModel } from '../model/EventModel';
import { Logger } from '../common/utils/Logger';
import { MonthView } from '../view/calendar/MonthView';
import { WeekView } from '../view/calendar/WeekView';
//  [ä¿®å¤] å¼•å…¥ TaskStatus ç±»å‹
import { CalendarViewModel, TaskStatus } from '../viewmodel/CalendarViewModel';

const logger = new Logger('EventListPage');

@Component
export struct EventListPage {
  @State events: Array<Event> = [];
  @State keyword: string = '';
  // é»˜è®¤é€‰ä¸­ä»Šå¤©
  @State selectedTimestamp: number = new Date().getTime();

  //  [ä¿®å¤] ç±»å‹æ”¹ä¸º Map<string, TaskStatus>
  @State taskMap: Map<string, TaskStatus> = new Map();

  @State viewMode: string = 'month';

  @Consume('pageStack') pageStack: NavPathStack;
  // åŒæ ·ç›‘å¬è¿™ä¸ªå¼ºåˆ·æ–°ä¿¡å·
  @StorageProp('GlobalRefreshSignal') @Watch('onGlobalRefresh') signal: number = 0;

  onGlobalRefresh() {
    logger.info('Received GlobalRefreshSignal, refreshing list...');
    this.refreshAllData();
  }
  @StorageProp('notificationJumpTarget') @Watch('onNotificationJump') jumpTarget: string = '';
  @StorageProp('notificationJumpId') jumpId: number = -1;
  @StorageProp('refreshEventList') @Watch('onRefreshChange') refreshSignal: number = 0;

  private calendarViewModel = new CalendarViewModel();
  onPageShow() {
    this.refreshAllData();
  }
  aboutToAppear() {
    // 1. âœ… [æ ¸å¿ƒä¿®å¤] ä½¿ç”¨ setTimeout å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿èƒ½å¤Ÿæ•è·å†·å¯åŠ¨ä¿¡å·
    // å°†æ£€æŸ¥æ”¾åˆ°äº‹ä»¶é˜Ÿåˆ—çš„æœ«å°¾ï¼Œé¿å¼€ UI åˆå§‹åŒ–ç«äº‰
    setTimeout(() => {
      this.checkColdStartJump();
    }, 100);

    // 2. åŠ è½½æ•°æ®
    this.refreshAllData();
  }

  // âœ… ç‹¬ç«‹å‡ºæ¥çš„æ£€æŸ¥æ–¹æ³•
  private checkColdStartJump() {
    // ç»•è¿‡ @StoragePropï¼Œç›´æ¥æŸ¥ AppStorage (æœ€çœŸå®çš„æ•°æ®)
    const storedTarget = AppStorage.get<string>('notificationJumpTarget');
    const storedId = AppStorage.get<number>('notificationJumpId');

    logger.info(`[ColdStart Check] Target: ${storedTarget}, ID: ${storedId}`);

    if (storedTarget === 'EventDetailPage' && storedId && storedId > 0) {
      logger.info('ğŸš€ DETECTED PENDING JUMP! Triggering now...');

      // å¼ºåˆ¶åŒæ­¥æœ¬åœ°çŠ¶æ€
      this.jumpTarget = storedTarget;
      this.jumpId = storedId;

      // æ‰§è¡Œè·³è½¬
      this.onNotificationJump();
    } else {
      logger.info('No pending jump found during cold start.');
    }
  }
  // âœ… è·³è½¬å“åº”é€»è¾‘
  async onNotificationJump() {
    logger.info(`[Jump Logic] Processing jump... Target: ${this.jumpTarget}, ID: ${this.jumpId}`);

    if (this.jumpTarget === 'EventDetailPage') {
      // 1. æ¶ˆè´¹ä¿¡å· (æ¸…ç©º)
      AppStorage.setOrCreate('notificationJumpTarget', '');

      // 2. æ£€æŸ¥ ID
      if (this.jumpId > 0) {
        logger.info(`[Jump Logic] Querying DB for Event ID: ${this.jumpId}`);
        const event = await EventModel.queryById(this.jumpId);

        if (event) {
          logger.info('[Jump Logic] Event found! Pushing to stack.');
          this.pageStack.pushPath({ name: 'EventDetailPage', param: event });
        } else {
          logger.error('[Jump Logic] Failed: Event ID not found in DB.');
        }
      } else {
        logger.error(`[Jump Logic] Failed: Invalid ID ${this.jumpId}`);
      }
    }
  }

  onRefreshChange() {
    this.refreshAllData();
  }

  async refreshAllData() {
    await this.loadMonthTaskDots();
    await this.loadEventsForList();
  }

  async loadMonthTaskDots() {
    try {
      const date = new Date(this.selectedTimestamp);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;

      const monthEvents = await EventModel.queryByMonth(year, month);

      //  è¿™é‡Œçš„ç±»å‹ç°åœ¨åŒ¹é…äº†
      this.taskMap = this.calendarViewModel.processEventsToTaskMap(monthEvents);
    } catch (err) {
      logger.error('Load calendar dots failed', JSON.stringify(err));
    }
  }

  async loadEventsForList() {
    try {
      if (this.keyword && this.keyword.trim().length > 0) {
        this.events = await EventModel.search(this.keyword);
        return;
      }

      const startOfDay = new Date(this.selectedTimestamp);
      startOfDay.setHours(0, 0, 0, 0);

      const endOfDay = new Date(this.selectedTimestamp);
      endOfDay.setHours(23, 59, 59, 999);

      this.events = await EventModel.queryRange(startOfDay.getTime(), endOfDay.getTime());

    } catch (err) {
      logger.error('Load events list failed', JSON.stringify(err));
      this.events = [];
    }
  }

  async deleteEvent(index: number, id: number) {
    const success = await EventModel.deleteById(id);
    if (success) {
      this.events.splice(index, 1);
      this.refreshAllData();
      logger.info(`Deleted event id: ${id}`);
    }
  }

  @Builder
  private CustomHeader(): void {
    Row() {
      Text($r('app.string.event_title'))
        .fontSize(24)
        .fontWeight(FontWeight.Bold)

      Blank()

      Row() {
        Text('æœˆ')
          .fontSize(14)
          .fontColor(this.viewMode === 'month' ? '#FFFFFF' : '#007DFF')
          .backgroundColor(this.viewMode === 'month' ? '#007DFF' : Color.Transparent)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .borderRadius(14)
          .onClick(() => this.viewMode = 'month')

        Text('å‘¨')
          .fontSize(14)
          .fontColor(this.viewMode === 'week' ? '#FFFFFF' : '#007DFF')
          .backgroundColor(this.viewMode === 'week' ? '#007DFF' : Color.Transparent)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .borderRadius(14)
          .onClick(() => this.viewMode = 'week')
      }
      .backgroundColor('#E5F1FF')
      .borderRadius(16)
      .margin({ right: 16 })

      Button({ type: ButtonType.Circle, stateEffect: true }) {
        Text('+')
          .fontSize(24)
          .fontColor(Color.Black)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        this.pageStack.pushPath({ name: 'EventEditPage' });
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  private SearchBar(): void {
    Row() {
      Search({ value: this.keyword, placeholder: 'æœç´¢æ—¥ç¨‹æ ‡é¢˜ã€å¤‡æ³¨...' })
        .width('100%')
        .height(40)
        .backgroundColor(Color.White)
        .placeholderColor(Color.Gray)
        .placeholderFont({ size: 14 })
        .textFont({ size: 14 })
        .onChange((value: string) => {
          this.keyword = value;
          this.loadEventsForList();
        })
        .onSubmit((value: string) => {
          this.keyword = value;
          this.loadEventsForList();
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, bottom: 8 })
  }

  @Builder
  DeleteAction(index: number, id: number) {
    Button() {
      Text($r('app.string.btn_delete'))
        .fontColor(Color.White)
        .fontSize(14)
    }
    .width(80)
    .height('100%')
    .backgroundColor(Color.Red)
    .onClick(() => {
      this.deleteEvent(index, id);
    })
  }

  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  @Builder
  EventItem(item: Event, index: number) {
    ListItem() {
      Row() {
        Column()
          .width(4)
          .height(40)
          .backgroundColor('#007DFF')
          .borderRadius(2)
          .margin({ right: 12 })

        Column() {
          Text(item.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(Color.Black)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(item.isAllDay ? $r('app.string.label_all_day') : `${this.formatTime(item.startTime)} - ${this.formatTime(item.endTime)}`)
            .fontSize(14)
            .fontColor(Color.Gray)
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        if (item.isAllDay) {
          Text('All Day')
            .fontSize(12)
            .fontColor('#007DFF')
            .backgroundColor('#E5F1FF')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(10)
        }
      }
      .width('100%')
      .padding(12)
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
    .margin({ bottom: 10 })
    .onClick(() => {
      this.pageStack.pushPath({ name: 'EventDetailPage', param: item });
    })
    .swipeAction({
      end: this.DeleteAction(index, item.id)
    })
  }

  build() {
    Column() {
      this.CustomHeader()

      if (this.keyword.length === 0) {
        Column() {
          if (this.viewMode === 'month') {
            MonthView({
              selectedTimestamp: $selectedTimestamp,
              taskMap: this.taskMap,
              onDateSelected: (ts: number) => {
                this.selectedTimestamp = ts;
                this.loadEventsForList();
              }
            })
          } else {
            WeekView({
              selectedTimestamp: $selectedTimestamp,
              taskMap: this.taskMap,
              onDateSelected: (ts) => {
                this.loadEventsForList();
              }
            })
          }
        }
        .margin({ bottom: 12 })
      } else {
        this.SearchBar()
      }

      GridRow({
        columns: { sm: 4, md: 8, lg: 12 },
        gutter: { x: 12, y: 12 }
      }) {
        GridCol({
          span: { sm: 4, md: 6, lg: 8 },
          offset: { sm: 0, md: 1, lg: 2 }
        }) {
          Column() {
            if (this.events.length === 0) {
              Column() {
                Image($r('app.media.app_icon'))
                  .width(64)
                  .height(64)
                  .opacity(0.3)
                  .grayscale(1)
                  .margin({ bottom: 10 })

                if (this.keyword.length > 0) {
                  Text('æ— æœç´¢ç»“æœ').fontSize(16).fontColor(Color.Gray)
                } else {
                  Text('ä»Šå¤©æ²¡æœ‰å®‰æ’').fontSize(16).fontColor(Color.Black)
                  Text('å»ä¼‘æ¯ä¸€ä¸‹å§').fontSize(14).fontColor(Color.Gray).margin({ top: 4 })
                }
              }
              .justifyContent(FlexAlign.Center)
              .height('100%')
              .width('100%')
            } else {
              List() {
                ForEach(this.events, (item: Event, index: number) => {
                  this.EventItem(item, index)
                }, (item: Event) => `${item.id}_${item.startTime}`)
              }
              .width('100%')
              .layoutWeight(1)
              .padding({ left: 16, right: 16, top: 10 })
            }
          }
          .width('100%')
          .layoutWeight(1)
        }
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
  }
}