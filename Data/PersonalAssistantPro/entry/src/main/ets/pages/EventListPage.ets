/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// entry/src/main/ets/pages/EventListPage.ets

import { Event, EventModel } from '../model/EventModel';
import { Logger } from '../common/utils/Logger';
import { MonthView } from '../view/calendar/MonthView';
import { WeekView } from '../view/calendar/WeekView';
import { CalendarViewModel, TaskStatus } from '../viewmodel/CalendarViewModel';

const logger = new Logger('EventListPage');

@Component
export struct EventListPage {
  @State events: Array<Event> = [];
  @State keyword: string = '';
  // é»˜è®¤é€‰ä¸­ä»Šå¤©
  @State selectedTimestamp: number = new Date().getTime();

  @State taskMap: Map<string, TaskStatus> = new Map();

  @State viewMode: string = 'month';

  @Consume('pageStack') pageStack: NavPathStack;

  // ç›‘å¬å…¨å±€åˆ·æ–°ä¿¡å·
  @StorageProp('GlobalRefreshSignal') @Watch('onGlobalRefresh') signal: number = 0;

  onGlobalRefresh() {
    logger.info('Received GlobalRefreshSignal, refreshing list...');
    this.refreshAllData();
  }

  // é€šçŸ¥è·³è½¬ç›¸å…³çŠ¶æ€
  @StorageProp('notificationJumpTarget') @Watch('onNotificationJump') jumpTarget: string = '';
  @StorageProp('notificationJumpId') jumpId: number = -1;

  // ç›‘å¬åˆ—è¡¨åˆ·æ–°è¯·æ±‚
  @StorageProp('refreshEventList') @Watch('onRefreshChange') refreshSignal: number = 0;

  private calendarViewModel = new CalendarViewModel();

  onPageShow() {
    this.refreshAllData();
  }

  aboutToAppear() {
    // 1. ä½¿ç”¨ setTimeout å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿èƒ½å¤Ÿæ•è·å†·å¯åŠ¨æ—¶çš„é€šçŸ¥ç‚¹å‡»ä¿¡å·
    setTimeout(() => {
      this.checkColdStartJump();
    }, 100);

    // 2. åŠ è½½é¡µé¢æ•°æ®
    this.refreshAllData();
  }

  // ç‹¬ç«‹å‡ºæ¥çš„å†·å¯åŠ¨è·³è½¬æ£€æŸ¥æ–¹æ³•
  private checkColdStartJump() {
    // ç»•è¿‡ @StoragePropï¼Œç›´æ¥æŸ¥ AppStorage è·å–æœ€çœŸå®çš„æ•°æ®
    const storedTarget = AppStorage.get<string>('notificationJumpTarget');
    const storedId = AppStorage.get<number>('notificationJumpId');

    logger.info(`[ColdStart Check] Target: ${storedTarget}, ID: ${storedId}`);

    if (storedTarget === 'EventDetailPage' && storedId && storedId > 0) {
      logger.info('ğŸš€ DETECTED PENDING JUMP! Triggering now...');

      // å¼ºåˆ¶åŒæ­¥æœ¬åœ°çŠ¶æ€ï¼Œè§¦å‘ Watch å›è°ƒ
      this.jumpTarget = storedTarget;
      this.jumpId = storedId;

      // æ‰‹åŠ¨æ‰§è¡Œè·³è½¬é€»è¾‘
      this.onNotificationJump();
    } else {
      logger.info('No pending jump found during cold start.');
    }
  }

  // è·³è½¬å“åº”é€»è¾‘
  async onNotificationJump() {
    logger.info(`[Jump Logic] Processing jump... Target: ${this.jumpTarget}, ID: ${this.jumpId}`);

    if (this.jumpTarget === 'EventDetailPage') {
      // 1. æ¶ˆè´¹ä¿¡å· (æ¸…ç©ºï¼Œé˜²æ­¢é‡å¤è·³è½¬)
      AppStorage.setOrCreate('notificationJumpTarget', '');

      // 2. æ£€æŸ¥ ID å¹¶æŸ¥è¯¢æ•°æ®åº“
      if (this.jumpId > 0) {
        logger.info(`[Jump Logic] Querying DB for Event ID: ${this.jumpId}`);
        const event = await EventModel.queryById(this.jumpId);

        if (event) {
          logger.info('[Jump Logic] Event found! Pushing to stack.');
          this.pageStack.pushPath({ name: 'EventDetailPage', param: event });
        } else {
          logger.error('[Jump Logic] Failed: Event ID not found in DB.');
        }
      } else {
        logger.error(`[Jump Logic] Failed: Invalid ID ${this.jumpId}`);
      }
    }
  }

  onRefreshChange() {
    this.refreshAllData();
  }

  async refreshAllData() {
    await this.loadMonthTaskDots();
    await this.loadEventsForList();
  }

  // åŠ è½½æ—¥å†ä¸Šçš„ä»»åŠ¡å°åœ†ç‚¹
  async loadMonthTaskDots() {
    try {
      const date = new Date(this.selectedTimestamp);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;

      const monthEvents = await EventModel.queryByMonth(year, month);

      this.taskMap = this.calendarViewModel.processEventsToTaskMap(monthEvents);
    } catch (err) {
      logger.error('Load calendar dots failed', JSON.stringify(err));
    }
  }

  // åŠ è½½å½“å‰é€‰ä¸­æ—¥æœŸçš„äº‹ä»¶åˆ—è¡¨
  async loadEventsForList() {
    try {
      // å¦‚æœæœ‰æœç´¢å…³é”®è¯ï¼Œä¼˜å…ˆæ˜¾ç¤ºæœç´¢ç»“æœ
      if (this.keyword && this.keyword.trim().length > 0) {
        this.events = await EventModel.search(this.keyword);
        return;
      }

      // å¦åˆ™æ˜¾ç¤ºå½“å¤©çš„æ—¥ç¨‹
      const startOfDay = new Date(this.selectedTimestamp);
      startOfDay.setHours(0, 0, 0, 0);

      const endOfDay = new Date(this.selectedTimestamp);
      endOfDay.setHours(23, 59, 59, 999);

      this.events = await EventModel.queryRange(startOfDay.getTime(), endOfDay.getTime());

    } catch (err) {
      logger.error('Load events list failed', JSON.stringify(err));
      this.events = [];
    }
  }

  // åˆ é™¤äº‹ä»¶
  async deleteEvent(index: number, id: number) {
    const success = await EventModel.deleteById(id);
    if (success) {
      this.events.splice(index, 1);
      this.refreshAllData();
      logger.info(`Deleted event id: ${id}`);
    }
  }

  // é¡¶éƒ¨æ ‡é¢˜æ  + è§†å›¾åˆ‡æ¢æŒ‰é’®
  @Builder
  private CustomHeader(): void {
    Row() {
      Text($r('app.string.event_title'))
        .fontSize(24)
        .fontWeight(FontWeight.Bold)

      Blank()

      // æœˆè§†å›¾/å‘¨è§†å›¾åˆ‡æ¢
      Row() {
        Text('æœˆ')
          .fontSize(14)
          .fontColor(this.viewMode === 'month' ? '#FFFFFF' : '#007DFF')
          .backgroundColor(this.viewMode === 'month' ? '#007DFF' : Color.Transparent)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .borderRadius(14)
          .onClick(() => this.viewMode = 'month')

        Text('å‘¨')
          .fontSize(14)
          .fontColor(this.viewMode === 'week' ? '#FFFFFF' : '#007DFF')
          .backgroundColor(this.viewMode === 'week' ? '#007DFF' : Color.Transparent)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .borderRadius(14)
          .onClick(() => this.viewMode = 'week')
      }
      .backgroundColor('#E5F1FF')
      .borderRadius(16)
      .margin({ right: 16 })

      // æ·»åŠ æŒ‰é’®
      Button({ type: ButtonType.Circle, stateEffect: true }) {
        Text('+')
          .fontSize(24)
          .fontColor(Color.Black)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        this.pageStack.pushPath({ name: 'EventEditPage' });
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .alignItems(VerticalAlign.Center)
  }

  // æœç´¢æ 
  @Builder
  private SearchBar(): void {
    Row() {
      Search({ value: this.keyword, placeholder: 'æœç´¢æ—¥ç¨‹æ ‡é¢˜ã€å¤‡æ³¨...' })
        .width('100%')
        .height(40)
        .backgroundColor(Color.White)
        .placeholderColor(Color.Gray)
        .placeholderFont({ size: 14 })
        .textFont({ size: 14 })
        .onChange((value: string) => {
          this.keyword = value;
          this.loadEventsForList();
        })
        .onSubmit((value: string) => {
          this.keyword = value;
          this.loadEventsForList();
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, bottom: 8 })
  }

  // ä¾§æ»‘åˆ é™¤æŒ‰é’®
  @Builder
  DeleteAction(index: number, id: number) {
    Button() {
      Text($r('app.string.btn_delete'))
        .fontColor(Color.White)
        .fontSize(14)
    }
    .width(80)
    .height('100%')
    .backgroundColor(Color.Red)
    .onClick(() => {
      this.deleteEvent(index, id);
    })
  }

  // æ—¶é—´æ ¼å¼åŒ–å·¥å…·
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // å•ä¸ªæ—¥ç¨‹åˆ—è¡¨é¡¹
  @Builder
  EventItem(item: Event, index: number) {
    ListItem() {
      Row() {
        // å·¦ä¾§è£…é¥°æ¡ (è“è‰²)
        Column()
          .width(4)
          .height(40)
          .backgroundColor('#007DFF')
          .borderRadius(2)
          .margin({ right: 12 })

        // ä¸­é—´ï¼šæ ‡é¢˜ä¸æ—¶é—´
        Column() {
          Text(item.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(Color.Black)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(item.isAllDay ? $r('app.string.label_all_day') : `${this.formatTime(item.startTime)} - ${this.formatTime(item.endTime)}`)
            .fontSize(14)
            .fontColor(Color.Gray)
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // å³ä¾§ï¼šçŠ¶æ€å›¾æ ‡åŒº (æé†’ + å…¨å¤©)
        Row() {
          // ğŸ”” æé†’å›¾æ ‡ï¼šå¦‚æœæœ‰ reminderIdï¼Œæ˜¾ç¤ºå°é“ƒé“›
          if (item.reminderId > -1) {
            Image($r('app.media.ic_public_reminder'))
              .width(16)
              .height(16)
              .fillColor('#FF9800') // è®¾ä¸ºæ©™è‰²æ›´é†’ç›®ï¼Œè‹¥è¦ç°è‰²å¯è®¾ä¸º #999999 æˆ–åˆ é™¤æ­¤è¡Œ
              .margin({ right: 6 })
          }

          // All Day æ ‡ç­¾
          if (item.isAllDay) {
            Text('All Day')
              .fontSize(12)
              .fontColor('#007DFF')
              .backgroundColor('#E5F1FF')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .borderRadius(10)
          }
        }
        .alignItems(VerticalAlign.Center)
      }
      .width('100%')
      .padding(12)
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
    .margin({ bottom: 10 })
    .onClick(() => {
      this.pageStack.pushPath({ name: 'EventDetailPage', param: item });
    })
    .swipeAction({
      end: this.DeleteAction(index, item.id)
    })
  }

  build() {
    Column() {
      this.CustomHeader()

      // å¦‚æœä¸åœ¨æœç´¢æ¨¡å¼ï¼Œæ˜¾ç¤ºæ—¥å†è§†å›¾
      if (this.keyword.length === 0) {
        Column() {
          if (this.viewMode === 'month') {
            MonthView({
              selectedTimestamp: $selectedTimestamp,
              taskMap: this.taskMap,
              onDateSelected: (ts: number) => {
                this.selectedTimestamp = ts;
                this.loadEventsForList();
              }
            })
          } else {
            WeekView({
              selectedTimestamp: $selectedTimestamp,
              taskMap: this.taskMap,
              onDateSelected: (ts) => {
                this.loadEventsForList();
              }
            })
          }
        }
        .margin({ bottom: 12 })
      } else {
        // æœç´¢æ¨¡å¼æ˜¾ç¤ºæœç´¢æ 
        this.SearchBar()
      }

      // æ—¥ç¨‹åˆ—è¡¨åŒºåŸŸ
      GridRow({
        columns: { sm: 4, md: 8, lg: 12 },
        gutter: { x: 12, y: 12 }
      }) {
        GridCol({
          span: { sm: 4, md: 6, lg: 8 },
          offset: { sm: 0, md: 1, lg: 2 }
        }) {
          Column() {
            if (this.events.length === 0) {
              // ç©ºçŠ¶æ€é¡µ
              Column() {
                Image($r('app.media.app_icon'))
                  .width(64)
                  .height(64)
                  .opacity(0.3)
                  .grayscale(1)
                  .margin({ bottom: 10 })

                if (this.keyword.length > 0) {
                  Text('æ— æœç´¢ç»“æœ').fontSize(16).fontColor(Color.Gray)
                } else {
                  Text('ä»Šå¤©æ²¡æœ‰å®‰æ’').fontSize(16).fontColor(Color.Black)
                  Text('å»ä¼‘æ¯ä¸€ä¸‹å§').fontSize(14).fontColor(Color.Gray).margin({ top: 4 })
                }
              }
              .justifyContent(FlexAlign.Center)
              .height('100%')
              .width('100%')
            } else {
              // åˆ—è¡¨æ¸²æŸ“
              List() {
                ForEach(this.events, (item: Event, index: number) => {
                  this.EventItem(item, index)
                }, (item: Event) => `${item.id}_${item.startTime}`)
              }
              .width('100%')
              .layoutWeight(1)
              .padding({ left: 16, right: 16, top: 10 })
            }
          }
          .width('100%')
          .layoutWeight(1)
        }
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
  }
}