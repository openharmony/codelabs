/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// entry/src/main/ets/pages/MinePage.ets
import { SettingModel } from '../model/SettingModel';
import { BackupService } from '../services/BackupService';
import { promptAction } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import { Logger } from '../common/utils/Logger';

const logger = new Logger('MinePage');

@Component
export struct MinePage {
  @State isBiometricOn: boolean = false;
  // Ê∑ªÂä†Â§ÑÁêÜÁä∂ÊÄÅÔºåÈò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
  @State isProcessing: boolean = false;
  private settingModel = new SettingModel();

  async aboutToAppear() {
    this.isBiometricOn = await this.settingModel.isBiometricEnabled();
  }

  // Â§ÑÁêÜÂ§á‰ªΩ
  async handleBackup() {
    if (this.isProcessing) {
      return;
    }
    this.isProcessing = true;
    try {
      const path = await BackupService.getInstance().backup(getContext(this));

      // ÊòæÁ§∫ÊàêÂäüÂºπÁ™óÔºåÂπ∂‰º†ÂÖ•Ë∑ØÂæÑÂèÇÊï∞
      promptAction.showDialog({
        title: $r('app.string.mine_backup_success_title'),
        message: $r('app.string.mine_backup_success_msg', path),
        buttons: [{ text: $r('app.string.common_confirm'), color: '#007DFF' }]
      });
    } catch (err) {
      logger.error('Backup failed', JSON.stringify(err));
      promptAction.showToast({ message: $r('app.string.mine_backup_fail') });
    } finally {
      this.isProcessing = false;
    }
  }

  // Â§ÑÁêÜÊÅ¢Â§ç
  async handleRestore() {
    if (this.isProcessing) {
      return;
    }

    promptAction.showDialog({
      title: $r('app.string.mine_restore_confirm_title'),
      message: $r('app.string.mine_restore_confirm_msg'),
      buttons: [
        { text: $r('app.string.common_cancel'), color: '#666666' },
        { text: $r('app.string.mine_restore_btn'), color: '#007DFF' }
      ]
    }).then(async (resp) => {
      if (resp.index === 1) {
        this.isProcessing = true;
        try {
          promptAction.showToast({ message: $r('app.string.common_loading') });

          const count = await BackupService.getInstance().restore(getContext(this));

          AppStorage.setOrCreate('refreshEventList', Date.now());
          AppStorage.setOrCreate('GlobalRefreshSignal', Date.now());

          promptAction.showToast({ message: $r('app.string.mine_restore_success', count) });
        } catch (error) {
          // =========== üîç Ë∞ÉËØïÊó•ÂøóÂºÄÂßã ===========
          // Â∞Ü error Âº∫ËΩ¨‰∏∫ BusinessError ‰ª•‰æøËÆøÈóÆÂ±ûÊÄß (ArkTS ËØ≠Ê≥ïË¶ÅÊ±Ç)
          let err = error as BusinessError;

          logger.error('‚ùå [Restore Debug] ÊçïËé∑Âà∞ÂºÇÂ∏∏!');
          logger.error(`‚ùå [Restore Debug] Á±ªÂûã (typeof): ${typeof error}`);
          // ÊòæÂºèÊâìÂç∞ messageÔºåËÄå‰∏çÊòØ stringify
          logger.error(`‚ùå [Restore Debug] ÈîôËØØ‰ø°ÊÅØ (message): ${err.message}`);
          logger.error(`‚ùå [Restore Debug] ÈîôËØØ‰ª£Á†Å (code): ${err.code}`);
          logger.error(`‚ùå [Restore Debug] Â†ÜÊ†à (stack): ${err.stack}`);
          // =========== üîç Ë∞ÉËØïÊó•ÂøóÁªìÊùü ===========

          // ÊèêÂèñÁî®‰∫éÊòæÁ§∫ÁöÑÈîôËØØ‰ø°ÊÅØ
          let uiMsg = '';
          if (err.message && err.message.length > 0) {
            uiMsg = err.message; // ‰ºòÂÖà‰ΩøÁî® Error ÂØπË±°ÁöÑ message
          } else {
            // Â¶ÇÊûú message ‰∏∫Á©∫ÔºåÂÜçÂ∞ùËØïËΩ¨Â≠óÁ¨¶‰∏≤ÔºåÈò≤Ê≠¢Âá∫Áé∞ "{}"
            uiMsg = JSON.stringify(error);
            if (uiMsg === '{}') {
              uiMsg = 'Êú™Áü•ÈîôËØØ (Unknown Error)';
            }
          }

          promptAction.showToast({
            message: $r('app.string.mine_restore_fail', uiMsg),
            duration: 3000
          });
        } finally {
          this.isProcessing = false;
        }
      }
    });
  }

  // ÁîüÁâ©ËØÜÂà´ÂºÄÂÖ≥ÂàáÊç¢
  async onBiometricChange(isOn: boolean) {
    this.isBiometricOn = isOn;
    await this.settingModel.setBiometricEnabled(isOn);
    if (isOn) {
      promptAction.showToast({ message: $r('app.string.privacy_active_toast') });
    } else {
      promptAction.showToast({ message: $r('app.string.privacy_inactive_toast') });
    }
  }

  @Builder
  SectionHeader(title: ResourceStr) {
    Text(title)
      .fontSize(14)
      .fontColor('#666666')
      .margin({ left: 16, top: 20, bottom: 8 })
      .width('100%')
  }

  build() {
    Column() {
      // 1. È°∂ÈÉ®‰∏™‰∫∫‰ø°ÊÅØÂå∫Âüü
      Column() {
        Image($r('app.media.app_icon'))
          .width(80)
          .height(80)
          .margin({ bottom: 10 })
          .borderRadius(16)
          // ÁÆÄÂçïÁöÑÁÅ∞Â∫¶Â§ÑÁêÜÊ®°ÊãüÂ§¥ÂÉè
          .grayscale(0)
        Text('Personal Assistant')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 4 })
        Text('Pro Version')
          .fontSize(14)
          .fontColor('#666666')
      }
      .width('100%')
      .height(220)
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#E5F1FF')

      // 2. ËÆæÁΩÆÈÄâÈ°πÂàóË°®
      List() {
        // --- Á¨¨‰∏ÄÁªÑÔºöËÆæÁΩÆ ---
        // ListItem() {
        //   Column() {
        //     this.SectionHeader($r('app.string.settings_title'))
        //
        //     Column() {
        //       // ÈöêÁßÅÈîÅÂºÄÂÖ≥
        //       Row() {
        //         Row() {
        //           Image($r('app.media.ic_public_lock')) // Á°Æ‰øù‰Ω†ÊúâËøô‰∏™ÂõæÊ†áÔºåÊàñËÄÖÊç¢‰∏Ä‰∏™Â≠òÂú®ÁöÑ
        //             .width(24).height(24).margin({ right: 12 }).fillColor('#007DFF')
        //           Text($r('app.string.privacy_lock_title')).fontSize(16).fontColor('#333333')
        //         }
        //
        //         Toggle({ type: ToggleType.Switch, isOn: this.isBiometricOn })
        //           .onChange((isOn) => this.onBiometricChange(isOn))
        //       }
        //       .width('100%')
        //       .justifyContent(FlexAlign.SpaceBetween)
        //       .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        //       .backgroundColor(Color.White)
        //     }
        //     .borderRadius(12)
        //     .clip(true)
        //     .backgroundColor(Color.White)
        //     .margin({ left: 12, right: 12 })
        //   }
        // }

        // --- Á¨¨‰∫åÁªÑÔºöÊï∞ÊçÆÁÆ°ÁêÜ ---
        ListItem() {
          Column() {
            this.SectionHeader($r('app.string.mine_section_sync'))

            Column() {
              // Â§á‰ªΩÊåâÈíÆ
              Row() {
                Row() {
                  Image($r('app.media.ic_public_save')) // ÂÅáËÆæÊúâ save ÂõæÊ†áÔºåÊàñËÄÖÁî® ic_public_folder
                    .width(24).height(24).margin({ right: 12 }).fillColor('#007DFF')
                  Text($r('app.string.mine_item_backup')).fontSize(16).fontColor('#333333')
                }

                Image($r('app.media.ic_public_arrow_right'))
                  .width(16).height(16).fillColor('#CCCCCC')
              }
              .width('100%')
              .justifyContent(FlexAlign.SpaceBetween)
              .padding(16)
              .backgroundColor(Color.White)
              .onClick(() => this.handleBackup())

              Divider().color('#F1F3F5').margin({ left: 52 })

              // ÊÅ¢Â§çÊåâÈíÆ
              Row() {
                Row() {
                  Image($r('app.media.ic_public_refresh')) // ÂÅáËÆæÊúâ refresh ÂõæÊ†á
                    .width(24).height(24).margin({ right: 12 }).fillColor('#007DFF')
                  Text($r('app.string.mine_item_restore')).fontSize(16).fontColor('#333333')
                }

                Image($r('app.media.ic_public_arrow_right'))
                  .width(16).height(16).fillColor('#CCCCCC')
              }
              .width('100%')
              .justifyContent(FlexAlign.SpaceBetween)
              .padding(16)
              .backgroundColor(Color.White)
              .onClick(() => this.handleRestore())
            }
            .borderRadius(12)
            .clip(true)
            .backgroundColor(Color.White)
            .margin({ left: 12, right: 12 })
          }
        }

        // --- Loading Áä∂ÊÄÅÊèêÁ§∫ ---
        if (this.isProcessing) {
          ListItem() {
            Row() {
              LoadingProgress().width(24).height(24).margin({ right: 8 }).color('#007DFF')
              Text($r('app.string.common_loading')).fontSize(14).fontColor('#999999')
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .padding({ top: 20 })
          }
        }
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#F1F3F5')
      .padding({ bottom: 20 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
  }
}