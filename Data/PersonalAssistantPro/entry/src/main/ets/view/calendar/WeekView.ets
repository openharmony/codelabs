/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// entry/src/main/ets/view/calendar/WeekView.ets
import { CalendarModel, CalendarViewModel, TaskStatus } from '../../viewmodel/CalendarViewModel';
import { DayItemView } from './DayItemView';

@Component
export struct WeekView {
  //  [ä¿®æ­£] @Watch å¿…é¡»å†™åœ¨å˜é‡ä¸Šï¼Œæ„æ€ä¸ºï¼šå½“ selectedTimestamp å˜åŒ–æ—¶ï¼Œè°ƒç”¨ onSelectedDateChange
  @Link @Watch('onSelectedDateChange') selectedTimestamp: number;
  // æ¥æ”¶å¿™ç¢Œæ—¥æœŸ Map
  @Prop taskMap: Map<string, TaskStatus> = new Map();
  // å†…éƒ¨çŠ¶æ€ï¼šè¿™å‘¨çš„7å¤©æ•°æ®
  @State weekData: Array<CalendarModel> = [];
  private viewModel: CalendarViewModel = new CalendarViewModel();
  // ğŸ“ [ä¿®æ”¹] ä½¿ç”¨ Resource æ•°ç»„æ›¿ä»£ç¡¬ç¼–ç çš„å­—ç¬¦ä¸²æ•°ç»„
  private weekTitles: Resource[] = [
    $r('app.string.week_sun'),
    $r('app.string.week_mon'),
    $r('app.string.week_tue'),
    $r('app.string.week_wed'),
    $r('app.string.week_thu'),
    $r('app.string.week_fri'),
    $r('app.string.week_sat')
  ];

  // å›è°ƒ
  onDateSelected: (timestamp: number) => void = () => {
  };

  aboutToAppear() {
    this.refreshData();
  }

  //  ç›‘å¬å›è°ƒæ–¹æ³• (è¿™é‡Œä¸éœ€è¦å†åŠ  @Watch äº†)
  onSelectedDateChange() {
    // åªæœ‰å½“é€‰ä¸­çš„æ—¥æœŸè·³å‡ºäº†å½“å‰å‘¨çš„èŒƒå›´æ—¶ï¼Œæ‰éœ€è¦åˆ·æ–°æ•°æ®
    this.refreshData();
  }

  refreshData() {
    this.weekData = this.viewModel.getWeekData(this.selectedTimestamp);
  }

  // åˆ‡æ¢åˆ°ä¸Šä¸€å‘¨
  prevWeek() {
    const date = new Date(this.selectedTimestamp);
    date.setDate(date.getDate() - 7);
    this.selectedTimestamp = date.getTime();
    // ç”±äºæ˜¯åŒå‘ç»‘å®šï¼Œä¿®æ”¹ selectedTimestamp ä¼šè‡ªåŠ¨è§¦å‘ onSelectedDateChange -> refreshData
    this.onDateSelected(this.selectedTimestamp);
  }

  // åˆ‡æ¢åˆ°ä¸‹ä¸€å‘¨
  nextWeek() {
    const date = new Date(this.selectedTimestamp);
    date.setDate(date.getDate() + 7);
    this.selectedTimestamp = date.getTime();
    this.onDateSelected(this.selectedTimestamp);
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨æ§åˆ¶æ  (å·¦å³åˆ‡æ¢ + æ—¥æœŸèŒƒå›´)
      Row() {
        Image($r('app.media.ic_public_arrow_left'))
          .width(20).height(20)
          .onClick(() => this.prevWeek())

        Text(this.getWeekRangeTitle())
          .fontSize(14)
          .fontColor(Color.Gray)
          .margin({ left: 10, right: 10 })

        Image($r('app.media.ic_public_arrow_right'))
          .width(20).height(20)
          .onClick(() => this.nextWeek())
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .height(30)
      .margin({ bottom: 8 })

      // 2. æ˜ŸæœŸæ ‡é¢˜å¤´ (Mon, Tue, Wed...)
      GridRow({ columns: 7 }) {
        // ğŸ“ [ä¿®æ”¹] éå† Resource æ•°ç»„
        ForEach(this.weekTitles, (title: Resource) => {
          GridCol() {
            Text(title)
              .fontSize(12)
              .fontColor('#999999')
              .width('100%')
              .textAlign(TextAlign.Center)
          }
        })
      }
      .width('100%')
      .height(20)
      .margin({ bottom: 4 })

      // 3. æ˜ŸæœŸæ•°æ®ç½‘æ ¼
      Grid() {
        ForEach(this.weekData, (day: CalendarModel) => {
          GridItem() {
            DayItemView({
              dayModel: day,
              selectedTimestamp: this.selectedTimestamp,
              // ä¼ é€’æ¡çŠ¶æ ·å¼
              stripType: this.taskMap.get(`${day.year}-${day.month}-${day.day}`)?.stripType || '',
              // ä¼ é€’ç‚¹çŠ¶æ ·å¼
              hasPoint: this.taskMap.get(`${day.year}-${day.month}-${day.day}`)?.hasPoint || false
            })
          }
          .onClick(() => {
            this.selectedTimestamp = day.timestamp;
            this.onDateSelected(day.timestamp);
          })
        })
      }
      .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr')
      .rowsTemplate('1fr')
      .height(40)
    }
    .width('100%')
    .padding(10)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  // ğŸ“ [ä¿®æ”¹] åŠ¨æ€è·å–å¹´æœˆæ—¥å•ä½
  private getWeekRangeTitle(): string {
    if (this.weekData.length === 0) {
      return '';
    }
    const start = this.weekData[0];
    const end = this.weekData[6];

    // è·å–ä¸Šä¸‹æ–‡ä»¥è§£æèµ„æºå­—ç¬¦ä¸²
    const context = getContext(this);
    const y = context.resourceManager.getStringSync($r('app.string.calendar_unit_year').id);
    const m = context.resourceManager.getStringSync($r('app.string.calendar_unit_month').id);
    const d = context.resourceManager.getStringSync($r('app.string.calendar_unit_day').id);

    // æ‹¼æ¥å­—ç¬¦ä¸²: "2023å¹´5æœˆ1æ—¥ - 5æœˆ7æ—¥"
    return `${start.year}${y}${start.month}${m}${start.day}${d} - ${end.month}${m}${end.day}${d}`;
  }
}