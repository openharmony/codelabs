/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// src/main/ets/view/form/DatePickerItem.ets
import { StyleConstants } from '../../common/constants/StyleConstants';
import { DateUtils } from '../../common/utils/DateUtils';

/**
 * å°è£…çš„æ—¥æœŸ/æ—¶é—´é€‰æ‹©ç»„ä»¶
 * * åŠŸèƒ½ç‰¹ç‚¹ï¼š
 * 1. æ”¯æŒæ—¥æœŸé€‰æ‹© (YYYY-MM-DD)
 * 2. æ”¯æŒæ—¶é—´é€‰æ‹© (HH:mm)
 * 3. è‡ªå®šä¹‰æ ‡é¢˜å’Œå ä½ç¬¦
 * 4. åº•éƒ¨å¼¹çª—äº¤äº’
 */
@Component
export struct DatePickerItem {
  // === å±æ€§å®šä¹‰ ===

  /** æ ‡é¢˜æ–‡æœ¬ */
  @Prop title: string | Resource = '';
  /** å½“å‰é€‰ä¸­çš„æ—¶é—´æˆ³ */
  @Link timestamp: number;
  /** é€‰æ‹©æ¨¡å¼: true=æ—¥æœŸ, false=æ—¶é—´ */
  @Prop isDateMode: boolean = true;
  /** å ä½æç¤ºæ–‡æ¡ˆ */
  // ğŸ“ [ä¿®æ”¹] ç±»å‹å¢åŠ  Resourceï¼Œé»˜è®¤å€¼æ”¹ä¸ºèµ„æºå¼•ç”¨
  @Prop placeholder: string | Resource = $r('app.string.common_select_placeholder');
  // === å†…éƒ¨çŠ¶æ€ ===
  @State private isPressed: boolean = false;

  /**
   * æ„å»º UI
   */
  build() {
    Column() {
      // 1. æ ‡é¢˜åŒºåŸŸ
      Text(this.title)
        .fontSize(StyleConstants.ICON_SIZE_MD)
        .fontColor(StyleConstants.COLOR_TEXT_SECONDARY)
        .margin({ bottom: StyleConstants.SPACE_XS })
        .width('100%')

      // 2. äº¤äº’åŒºåŸŸ (æ¨¡æ‹Ÿè¾“å…¥æ¡†æ ·å¼)
      Row() {
        // æ˜¾ç¤ºé€‰ä¸­çš„æ—¶é—´ï¼Œæˆ–è€…å ä½ç¬¦
        Text(this.getDisplayText())
          .fontSize(StyleConstants.ICON_SIZE_LG)
          .fontColor(this.timestamp > 0 ? StyleConstants.COLOR_TEXT_PRIMARY : StyleConstants.COLOR_TEXT_SECONDARY)
          .layoutWeight(1)

        // å³ä¾§ç®­å¤´å›¾æ ‡
        Image($r('app.media.ic_back')) // å¤ç”¨è¿”å›å›¾æ ‡ï¼Œæ—‹è½¬180åº¦
          .width(16)
          .height(16)
          .fillColor(StyleConstants.COLOR_TEXT_SECONDARY)
          .rotate({ angle: 180 })
          .opacity(0.5)
      }
      .width('100%')
      .height(StyleConstants.HEIGHT_INPUT)
      .backgroundColor(this.isPressed ? '#F5F5F5' : Color.Transparent) // æŒ‰å‹æ€
      .border({
        width: { bottom: 1 },
        color: StyleConstants.COLOR_DIVIDER
      })
      // 3. ç‚¹å‡»äº¤äº’äº‹ä»¶
      .onClick(() => {
        this.showPickerDialog();
      })
      .onTouch((event) => {
        if (event.type === TouchType.Down) {
          this.isPressed = true;
        } else if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
          this.isPressed = false;
        }
      })
    }
    .width('100%')
    .padding({
      top: StyleConstants.SPACE_MD,
      bottom: StyleConstants.SPACE_MD
    })
  }

  /**
   * è·å–æ˜¾ç¤ºçš„æ–‡æœ¬å†…å®¹
   */
  // ğŸ“ [ä¿®æ”¹] è¿”å›ç±»å‹å…¼å®¹ Resource
  private getDisplayText(): string | Resource {
    if (!this.timestamp || this.timestamp <= 0) {
      return this.placeholder;
    }
    if (this.isDateMode) {
      return DateUtils.formatDate(this.timestamp);
    } else {
      return DateUtils.formatTime(this.timestamp);
    }
  }

  /**
   * å¼¹å‡ºç³»ç»Ÿé€‰æ‹©å™¨
   */
  private showPickerDialog() {
    // é»˜è®¤é€‰ä¸­æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”¨å½“å‰æ—¶é—´
    const current = this.timestamp > 0 ? new Date(this.timestamp) : new Date();

    if (this.isDateMode) {
      // --- æ—¥æœŸé€‰æ‹©æ¨¡å¼ ---
      DatePickerDialog.show({
        start: new Date("2000-1-1"),
        end: new Date("2100-12-31"),
        selected: current,
        onAccept: (value: DatePickerResult) => {
          // é€šè¿‡ value.year, value.month, value.day é‡æ–°æ„é€ æ—¶é—´æˆ³
          const newDate = new Date();
          newDate.setFullYear(value.year!, value.month!, value.day!);
          // ä¿ç•™åŸæ¥çš„æ—¶åˆ†ç§’ä¿¡æ¯ (å¯é€‰é€»è¾‘)
          if (this.timestamp > 0) {
            const oldDate = new Date(this.timestamp);
            newDate.setHours(oldDate.getHours(), oldDate.getMinutes());
          } else {
            newDate.setHours(9, 0, 0); // é»˜è®¤ä¸Šåˆ9ç‚¹
          }
          this.timestamp = newDate.getTime();
        }
      });
    } else {
      // --- æ—¶é—´é€‰æ‹©æ¨¡å¼ ---
      TimePickerDialog.show({
        selected: current,
        useMilitaryTime: true, // 24å°æ—¶åˆ¶
        onAccept: (value: TimePickerResult) => {
          const newDate = this.timestamp > 0 ? new Date(this.timestamp) : new Date();
          newDate.setHours(value.hour!, value.minute!);
          this.timestamp = newDate.getTime();
        }
      });
    }
  }
}