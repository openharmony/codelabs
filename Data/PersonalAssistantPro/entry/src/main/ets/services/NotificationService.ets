/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import reminderAgentManager from '@ohos.reminderAgentManager';
import notificationManager from '@ohos.notificationManager';
import common from '@ohos.app.ability.common';
import wantAgent from '@ohos.app.ability.wantAgent';
import { Logger } from '../common/utils/Logger';

const logger = new Logger('NotificationService');

export class NotificationService {

  static async checkAndRequestPermission(context: common.UIAbilityContext): Promise<boolean> {
    try {
      const isEnabled = await notificationManager.isNotificationEnabled();
      if (isEnabled) {
        return true;
      }
      logger.info('Notification is disabled, requesting permission...');
      await notificationManager.requestEnableNotification(context);
      return await notificationManager.isNotificationEnabled();
    } catch (err) {
      logger.error(`Request notification permission failed: ${JSON.stringify(err)}`);
      return false;
    }
  }

  static async publishCalendarReminder(context: common.UIAbilityContext, title: string, content: string, targetTime: number): Promise<number> {
    logger.info(`[Step 1] Preparing reminder. Bundle: ${context.abilityInfo.bundleName}, Ability: ${context.abilityInfo.name}`);
    const date = new Date(targetTime);

    try {
      // 1. å‡†å¤‡ WantAgentInfo
      // é‡‡ç”¨â€œæ¨¡æ‹Ÿæ¡Œé¢å›¾æ ‡ç‚¹å‡»â€çš„ç­–ç•¥ï¼Œè¿™æ˜¯æœ€ç¨³å¦¥çš„å”¤èµ·æ–¹å¼
      const wantInfo: wantAgent.WantAgentInfo = {
        wants: [
          {
            bundleName: context.abilityInfo.bundleName,
            abilityName: context.abilityInfo.name,
            action: 'ohos.want.action.home', // ğŸ‘ˆ å¿…é¡»åŠ ï¼šåŒ¹é… module.json5 çš„ action
            entities: ['entity.system.home'], // ğŸ‘ˆ å¿…é¡»åŠ ï¼šåŒ¹é… module.json5 çš„ entities
            parameters: {
              'fromNotification': true // ğŸ‘ˆ å¿…é¡»åŠ ï¼šé˜²æ­¢ Intent è¢«ç³»ç»Ÿå»é‡æ‹¦æˆª
            }
          }
        ],
        // ä½¿ç”¨ START_ABILITY å¯åŠ¨åº”ç”¨
        operationType: wantAgent.OperationType.START_ABILITY,
        requestCode: 0,
        // REPLACE_ELEMENT ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„å‚æ•°
        wantAgentFlags: [wantAgent.WantAgentFlags.REPLACE_ELEMENT]
      };

      // 2. è·å– WantAgent
      const agent = await wantAgent.getWantAgent(wantInfo);
      logger.info('[Step 2] WantAgent created with HOME action.');

      // 3. æ„å»ºæé†’è¯·æ±‚å¯¹è±¡
      const reminderRequest: reminderAgentManager.ReminderRequestCalendar = {
        reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_CALENDAR,
        dateTime: {
          year: date.getFullYear(),
          month: date.getMonth() + 1,
          day: date.getDate(),
          hour: date.getHours(),
          minute: date.getMinutes(),
          second: 0
        },
        content: content,
        title: title,
        snoozeTimes: 0,
        timeInterval: 0,
        ringDuration: 5,
        notificationId: Math.floor(targetTime / 1000),

        // ä½¿ç”¨ as ESObject è§£å†³ç±»å‹é—®é¢˜
        wantAgent: agent as ESObject
      };

      // 4. å‘å¸ƒæé†’
      const reminderId = await reminderAgentManager.publishReminder(reminderRequest);
      logger.info(`[Step 3] Reminder published successfully. ID: ${reminderId}`);
      return reminderId;

    } catch (err) {
      logger.error(`[ERROR] Publish failed. Code:${err.code}, Message:${err.message}`);
      return -1;
    }
  }

  static async cancelReminder(reminderId: number): Promise<void> {
    if (reminderId < 0) return;
    try {
      await reminderAgentManager.cancelReminder(reminderId);
      logger.info(`Reminder ${reminderId} canceled.`);
    } catch (err) {
      logger.error(`Cancel reminder failed code:${err.code} message:${err.message}`);
    }
  }
}