import dataPreferences from '@ohos.data.preferences';
import { Logger } from '../common/utils/Logger';
import { Context } from '@kit.AbilityKit';

export class PreferenceService {
  private static instance: PreferenceService;
  private preferences: dataPreferences.Preferences | null = null;
  private logger = new Logger('PreferenceService');

  private readonly PREF_NAME = 'personal_assistant_pref';
  private readonly KEY_AES_SECRET = 'secure_aes_key';

  private constructor() {}

  public static getInstance(): PreferenceService {
    if (!PreferenceService.instance) {
      PreferenceService.instance = new PreferenceService();
    }
    return PreferenceService.instance;
  }

  async init(context: Context): Promise<void> {
    try {
      this.preferences = await dataPreferences.getPreferences(context, this.PREF_NAME);
      this.logger.info('Preferences initialized successfully.');
    } catch (err) {
      this.logger.error('Failed to get preferences', err);
    }
  }

  // --- AES å¯†é’¥ä¸“ç”¨æ–¹æ³• ---

  async getAesKey(): Promise<string> {
    return await this.getValue<string>(this.KEY_AES_SECRET, '');
  }

  async saveAesKey(key: string): Promise<void> {
    await this.putValue(this.KEY_AES_SECRET, key);
  }

  // --- ğŸ”¥ é€šç”¨è¯»å†™æ–¹æ³• (è§£å†³ Model å±‚è°ƒç”¨æŠ¥é”™çš„æ ¸å¿ƒ) ---

  /**
   * é€šç”¨è·å–å€¼æ–¹æ³•
   * ä½¿ç”¨æ³›å‹ <T> é¿å… 'any' ç±»å‹æŠ¥é”™
   */
  async getValue<T>(key: string, defValue: T): Promise<T> {
    if (!this.preferences) return defValue;
    try {
      // æ˜¾å¼æ–­è¨€ä¸º ValueTypeï¼Œæ»¡è¶³ç¼–è¯‘å™¨æ£€æŸ¥
      const val = await this.preferences.get(key, defValue as dataPreferences.ValueType);
      return val as T;
    } catch (err) {
      this.logger.error(`Failed to get value for ${key}`, err);
      return defValue;
    }
  }

  /**
   * é€šç”¨å†™å…¥å€¼æ–¹æ³•
   */
  async putValue(key: string, value: dataPreferences.ValueType): Promise<void> {
    if (!this.preferences) return;
    try {
      await this.preferences.put(key, value);
      await this.preferences.flush();
    } catch (err) {
      this.logger.error(`Failed to put value for ${key}`, err);
    }
  }
}