/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// PAP/PersonalAssistantPro/entry/src/main/ets/entryability/EntryAbility.ets
import { AbilityConstant, ConfigurationConstant, UIAbility, Want } from '@kit.AbilityKit';
import { window } from '@kit.ArkUI';
import { Logger } from '../common/utils/Logger';
import { runCurrentDebugCase } from '../debug/DebugRunner';
import { PreferenceService } from '../services/PreferenceService';
import { RdbHelper } from '../common/database/RdbHelper';
import { AesCryptoUtils } from '../common/utils/AesCryptoUtils';

export default class EntryAbility extends UIAbility {
  private logger = new Logger('EntryAbility');

  // âœ… ç”Ÿå‘½å‘¨æœŸï¼šåº”ç”¨å†·å¯åŠ¨ (è¢«ç‚¹å‡»å›¾æ ‡æˆ–é€šçŸ¥å”¤èµ·)
  async onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): Promise<void> {
    this.logger.info('Ability onCreate');
    AppStorage.setOrCreate('abilityContext', this.context);

    // âœ… 1. æ£€æŸ¥æ˜¯å¦æœ‰é€šçŸ¥è·³è½¬å‚æ•°
    this.handleNotificationJump(want);

    try {
      this.context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
    } catch (err) {
      this.logger.error(`Failed to set colorMode. Cause: ${JSON.stringify(err as object)}`);
    }

    // === åŸæœ‰åˆå§‹åŒ–é€»è¾‘ä¿æŒä¸å˜ ===
    try {
      this.logger.info('=== [Debug Mode] Pre-initializing dependencies ===');

      // 1. åˆå§‹åŒ–é¦–é€‰é¡¹
      await PreferenceService.getInstance().init(this.context);

      // 2. åˆå§‹åŒ–æ•°æ®åº“
      await RdbHelper.getInstance().initRdb(this.context);

      // 3. åˆå§‹åŒ–åŠ å¯†å¯†é’¥
      const savedKey = await PreferenceService.getInstance().getAesKey();

      if (savedKey && savedKey.length > 0) {
        await AesCryptoUtils.initKey(savedKey);
        this.logger.info('âœ… Restored AES key from preferences.');
      } else {
        const newKey = await AesCryptoUtils.initKey();
        await PreferenceService.getInstance().saveAesKey(newKey);
        this.logger.info('ğŸ†• Generated and saved new AES key.');
      }

      this.logger.info('=== Dependencies ready. Starting Debug Case ===');

      // 4. è¿è¡Œè°ƒè¯•ç”¨ä¾‹
      await runCurrentDebugCase();

    } catch (err) {
      this.logger.error(`Debug environment init failed: ${JSON.stringify(err as object)}`);
    }

    this.logger.info('Initialization delegated to SplashPage.');
  }

  // âœ… ç”Ÿå‘½å‘¨æœŸï¼šåº”ç”¨å·²åœ¨åå°è¿è¡Œ (è¢«é€šçŸ¥å”¤èµ·)
  // å¿…é¡»æ·»åŠ è¿™ä¸ªæ–¹æ³•ï¼Œå¦åˆ™åå°è¿è¡Œæ—¶ç‚¹å‡»é€šçŸ¥æ²¡ååº”
  onNewWant(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    this.logger.info('Ability onNewWant');
    // å¤„ç†çƒ­å¯åŠ¨æ—¶çš„è·³è½¬å‚æ•°
    this.handleNotificationJump(want);
  }

  onDestroy(): void {
    this.logger.info('Ability onDestroy');
  }

  onWindowStageCreate(windowStage: window.WindowStage): void {
    this.logger.info('Ability onWindowStageCreate');

    windowStage.loadContent('pages/SplashPage', (err) => {
      if (err.code) {
        this.logger.error(`Failed to load the content. Cause: ${JSON.stringify(err)}`);
        return;
      }
      this.logger.info('Succeeded in loading the content.');
    });
  }

  onWindowStageDestroy(): void {
    this.logger.info('Ability onWindowStageDestroy');
  }

  onForeground(): void {
    this.logger.info('Ability onForeground');
  }

  onBackground(): void {
    this.logger.info('Ability onBackground');
  }

  // âœ… è¾…åŠ©æ–¹æ³•ï¼šå¤„ç†é€šçŸ¥è·³è½¬é€»è¾‘
  private handleNotificationJump(want: Want) {
    if (want && want.parameters && want.parameters['targetPage']) {
      const targetPage = want.parameters['targetPage'] as string;
      const eventId = want.parameters['eventId'] as number;

      // âœ… ä½¿ç”¨ logger è¾“å‡ºæ—¥å¿—
      this.logger.info(`ğŸ”” Notification Clicked! Preparing to jump to: ${targetPage}, ID: ${eventId}`);

      // 1. å…ˆå­˜ ID (æ•°æ®)
      AppStorage.setOrCreate('notificationJumpId', eventId);

      // 2. å†å­˜ Target (å¼€å…³)
      AppStorage.setOrCreate('notificationJumpTarget', targetPage);
    }
  }
}