/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-20
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { SportData, RouteData, LocationInfo, DataPoint } from '../model/SportModel';
import router from '@ohos.router';
import { RouteMapInner } from '../components/RouteMapInner';
import { ChartComponent } from '../components/ChartComponent';

// ç§»é™¤å¯èƒ½ä¸å­˜åœ¨çš„å¯¼å…¥ï¼Œä½¿ç”¨é»˜è®¤å€¼

@Entry
@Component
struct HistoryDetailPage {
  @State sportRecord: SportData | null = null;
  @State routeData: RouteData = new RouteData();

  aboutToAppear() {
    // èŽ·å–ä»ŽHistoryPageä¼ é€’è¿‡æ¥çš„è¿åŠ¨è®°å½•æ•°æ®
    const params = router.getParams();
    console.log('èŽ·å–åˆ°è·¯ç”±å‚æ•°:', params);

    // å®‰å…¨åœ°èŽ·å–recordå‚æ•°
    let recordJson = '';
    if (params) {
      // ä½¿ç”¨ç±»åž‹æ–­è¨€ï¼Œé¿å…anyç±»åž‹
      interface RecordParams {
        record?: string;
      }

      const parsedParams = params as RecordParams;
      if (parsedParams.record) {
        recordJson = parsedParams.record;
        this.sportRecord = JSON.parse(recordJson) as SportData;
        console.log('èŽ·å–åˆ°è¿åŠ¨è®°å½• - ç±»åž‹:', this.sportRecord.type, 'è·ç¦»:', this.sportRecord.distance, 'ç±³', 'æ—¶é—´:',
          this.sportRecord.duration, 'æ¯«ç§’', 'å¡è·¯é‡Œ:', this.sportRecord.calories, 'kcal');
        console.log('é€Ÿåº¦æ•°æ®ç‚¹æ•°é‡:', this.sportRecord.speedData ? this.sportRecord.speedData.length : 0);
        console.log('å¡è·¯é‡Œæ•°æ®ç‚¹æ•°é‡:', this.sportRecord.caloriesData ? this.sportRecord.caloriesData.length : 0);
        if (this.sportRecord.speedData && this.sportRecord.speedData.length > 0) {
          console.log('å‰5ä¸ªé€Ÿåº¦æ•°æ®ç‚¹:');
          this.sportRecord.speedData.slice(0, 5).forEach((point, index) => {
            console.log(`  æ•°æ®ç‚¹${index + 1} - æ—¶é—´æˆ³:`, point.timestamp, 'é€Ÿåº¦:', point.value, 'm/s');
          });
        }
        if (this.sportRecord.caloriesData && this.sportRecord.caloriesData.length > 0) {
          console.log('å‰5ä¸ªå¡è·¯é‡Œæ•°æ®ç‚¹:');
          this.sportRecord.caloriesData.slice(0, 5).forEach((point, index) => {
            console.log(`  æ•°æ®ç‚¹${index + 1} - æ—¶é—´æˆ³:`, point.timestamp, 'å¡è·¯é‡Œ:', point.value, 'kcal');
          });
        }

        // åˆå§‹åŒ–routeDataï¼Œç”¨äºŽæ˜¾ç¤ºè½¨è¿¹
        if (this.sportRecord && this.sportRecord.route) {
          this.routeData = new RouteData();
          // å°†è¿åŠ¨è®°å½•ä¸­çš„routeè½¬æ¢ä¸ºLocationInfoæ ¼å¼ï¼Œç”¨äºŽæ˜¾ç¤ºè½¨è¿¹
          this.sportRecord.route.forEach(routePoint => {
            // æ˜¾å¼åˆ›å»ºLocationInfoå®žä¾‹ï¼Œé¿å…æœªç±»åž‹åŒ–å¯¹è±¡å­—é¢é‡
            const locationInfo = new LocationInfo(
              routePoint.latitude,
              routePoint.longitude,
              0, // altitude
              0, // accuracy
              0, // speed
              routePoint.timestamp,
              0, // totalDistance
              0, // netDistance
              0// netDuration
            );
            this.routeData.addRoutePoint(locationInfo);
          });

          // è®¾ç½®å½“å‰ä½ç½®ä¸ºæœ€åŽä¸€ä¸ªè½¨è¿¹ç‚¹
          if (this.routeData.routePoints.length > 0) {
            const lastPoint = this.routeData.routePoints[this.routeData.routePoints.length - 1];
            this.routeData.updateCurrentLocation(lastPoint);
          }
        }
      }
    }
  }

  build() {
    Column() {
      // é¡µé¢æ ‡é¢˜å’Œè¿”å›žæŒ‰é’®
      Row() {
        Text('ðŸƒ è¿åŠ¨è¯¦æƒ…')
          .fontSize(24)
          .fontWeight(700)
          .fontColor('#333333')

        Blank()

        Text('è¿”å›ž')
          .fontSize(16)
          .fontColor('#4ECDC4')
          .onClick(() => {
            router.back();
          })
      }
      .width('100%')
      .padding({
        left: 16,
        right: 16,
        top: 16,
        bottom: 16
      })

      // æ·»åŠ æ»šåŠ¨ç»„ä»¶
      Scroll() {
        Column() {
          if (this.sportRecord) {
            // è¿åŠ¨æ¦‚è§ˆå¡ç‰‡
            Column() {
              Text(this.getSportTypeName(this.sportRecord.type))
                .fontSize(20)
                .fontWeight(700)
                .fontColor('#333333')
                .margin({ bottom: 6 })

              Text(this.formatDate(this.sportRecord.startTime))
                .fontSize(14)
                .fontColor('#999999')
                .margin({ bottom: 12 })

              // è¿åŠ¨æ•°æ®æ¦‚è§ˆ
              Row() {
                this.StatItem('è·ç¦»', this.formatDistance(this.sportRecord.distance), '#FF6B6B')
                this.StatItem('æ—¶é—´', this.formatDuration(this.sportRecord.duration), '#4ECDC4')
                this.StatItem('å¹³å‡é€Ÿåº¦', this.formatSpeed(this.sportRecord.averageSpeed), '#45B7D1')
                this.StatItem('å¡è·¯é‡Œ', this.formatCalories(this.sportRecord.calories), '#FFA502')
              }
              .width('100%')
              .justifyContent(FlexAlign.SpaceAround)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(16)
            .shadow({
              radius: 6,
              color: '#1A000000',
              offsetX: 0,
              offsetY: 2
            })
            .margin({ bottom: 12 })

            // è¿åŠ¨è½¨è¿¹åœ°å›¾
            Column() {
              Text('ðŸ“ è¿åŠ¨è½¨è¿¹')
                .fontSize(18)
                .fontWeight(700)
                .fontColor('#333333')
                .margin({ bottom: 10 })

              RouteMapInner({
                routeData: $routeData
              })
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(16)
            .shadow({
              radius: 6,
              color: '#1A000000',
              offsetX: 0,
              offsetY: 2
            })
            .margin({ bottom: 12 })

            // é€Ÿåº¦å˜åŒ–å›¾è¡¨
            if (this.sportRecord.speedData && this.sportRecord.speedData.length > 0) {
              ChartComponent({
                data: this.sportRecord.speedData,
                title: 'é€Ÿåº¦å˜åŒ–è¶‹åŠ¿',
                xLabel: 'æ—¶é—´',
                yLabel: 'é€Ÿåº¦ (m/s)',
                color: '#4ECDC4'
              })
                .width('100%')
                .margin({ bottom: 12 })
            }

            // å¡è·¯é‡Œå¢žé•¿å›¾è¡¨
            if (this.sportRecord.caloriesData && this.sportRecord.caloriesData.length > 0) {
              ChartComponent({
                data: this.sportRecord.caloriesData,
                title: 'å¡è·¯é‡Œå¢žé•¿è¶‹åŠ¿',
                xLabel: 'æ—¶é—´',
                yLabel: 'å¡è·¯é‡Œ',
                color: '#FF6B6B'
              })
                .width('100%')
                .margin({ bottom: 12 })
            }

            // è¿åŠ¨æ•°æ®è¯¦æƒ…
            Column() {
              Text('ðŸ“ˆ è¿åŠ¨æ•°æ®')
                .fontSize(18)
                .fontWeight(700)
                .fontColor('#333333')
                .margin({ bottom: 12 })

              // é€Ÿåº¦ä¿¡æ¯
              Row() {
                Text('æœ€é«˜é€Ÿåº¦:')
                  .fontSize(16)
                  .fontColor('#666666')
                Blank()
                Text(`${(this.sportRecord.currentSpeed || 0).toFixed(1)} m/s`)
                  .fontSize(16)
                  .fontWeight(700)
                  .fontColor('#45B7D1')
              }
              .width('100%')
              .padding({ top: 10, bottom: 10 })

              // è·¯çº¿ä¿¡æ¯
              Row() {
                Text('è·¯çº¿ç‚¹æ•°é‡:')
                  .fontSize(16)
                  .fontColor('#666666')
                Blank()
                Text(`${this.sportRecord.route ? this.sportRecord.route.length : 0} ä¸ª`)
                  .fontSize(16)
                  .fontWeight(700)
                  .fontColor('#333333')
              }
              .width('100%')
              .padding({ top: 10, bottom: 10 })
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(16)
            .shadow({
              radius: 6,
              color: '#1A000000',
              offsetX: 0,
              offsetY: 2
            })
            .margin({ bottom: 24 })
          } else {
            // åŠ è½½å¤±è´¥æç¤º
            Column() {
              Text('åŠ è½½è¿åŠ¨è®°å½•å¤±è´¥')
                .fontSize(16)
                .fontColor('#999999')
            }
            .width('100%')
            .height(300)
            .justifyContent(FlexAlign.Center)
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16 })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }

  @Builder
  StatItem(label: string, value: string, color: string) {
    Column() {
      Text(value)
        .fontSize(20)
        .fontWeight(700) // ä½¿ç”¨æ•°å­—å€¼ä»£æ›¿FontWeightæžšä¸¾
        .fontColor(color)
        .margin({ bottom: 4 })
      Text(label)
        .fontSize(12)
        .fontColor('#999999')
    }

    // ç§»é™¤alignItemsï¼Œä½¿ç”¨é»˜è®¤å¯¹é½æ–¹å¼
  }

  getSportTypeName(type: string): string {
    switch (type) {
      case 'running':
        return 'è·‘æ­¥';
      case 'walking':
        return 'è¡Œèµ°';
      case 'cycling':
        return 'éª‘è¡Œ';
      default:
        return 'è¿åŠ¨';
    }
  }

  formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
  }

  formatDistance(distance: number): string {
    if (distance >= 1000) {
      return `${(distance / 1000).toFixed(2)} km`;
    }
    return `${distance.toFixed(0)} m`;
  }

  formatDuration(duration: number): string {
    const hours = Math.floor(duration / 3600000);
    const minutes = Math.floor((duration % 3600000) / 60000);
    const seconds = Math.floor((duration % 60000) / 1000);

    if (hours > 0) {
      return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }

  formatSpeed(speed: number): string {
    return `${speed.toFixed(1)} m/s`;
  }

  formatCalories(calories: number): string {
    return `${calories.toFixed(0)} kcal`;
  }
}
