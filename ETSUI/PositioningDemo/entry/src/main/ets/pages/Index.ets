// SPDX-License-Identifier: MIT
import { LocationService } from '../service/LocationService';
import { SportService } from '../service/SportService';
import { ReminderService } from '../service/ReminderService';
import { HistoryService } from '../service/HistoryService';
import { StatisticsService } from '../service/StatisticsService';
import { AchievementService } from '../service/AchievementService';
import { SportType, SportData, RouteData, LocationInfo } from '../model/SportModel';
import { SportControlButton } from '../components/SportControlButton';
import { RouteMap } from '../components/RouteMapInner';
import { ReminderSettingComponent } from '../components/ReminderSettingComponent';
import { common } from '@kit.AbilityKit';
import router from '@ohos.router';
import { map } from '@kit.MapKit';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct Index {
  @State selectedType: SportType = SportType.RUNNING;
  @State sportData: SportData | null = null;
  @State isRunning: boolean = false;
  @State isPaused: boolean = false;
  @State errorMessage: string = '';
  @State currentLocation: LocationInfo | null = null;
  @State routePoints: LocationInfo[] = [];
  @State isSimulator: boolean = false;
  @State routeData: RouteData = new RouteData();
  @State selectedMode: string = 'è‡ªç”±è·‘';
  
  private locationService: LocationService = new LocationService();
  private reminderService: ReminderService = new ReminderService();
  private sportService: SportService = new SportService(this.reminderService);
  private historyService: HistoryService = new HistoryService();
  private statisticsService: StatisticsService = new StatisticsService(this.historyService);
  private achievementService: AchievementService = new AchievementService(this.historyService, this.statisticsService);
  private simulationTimer: number = -1;
  private uiUpdateTimer: number = -1;
  private routeMapController?: map.MapComponentController;

  async aboutToAppear() {
    const context = getContext(this) as common.UIAbilityContext;
    this.historyService.init(context).then(() => {
      // ä¸å†ç¡¬ç¼–ç ä¸ºtrueï¼Œè€Œæ˜¯è®©åº”ç”¨è‡ªåŠ¨æ£€æµ‹æˆ–ç”±ç”¨æˆ·é€‰æ‹©
      // é»˜è®¤ä½¿ç”¨çœŸå®æ¨¡å¼ï¼Œå…è®¸æ¨¡æ‹Ÿå™¨å°è¯•ä½¿ç”¨çœŸå®GPS
      this.isSimulator = false;
      console.log('é»˜è®¤ä½¿ç”¨çœŸå®æ¨¡å¼ï¼Œå…è®¸æ¨¡æ‹Ÿå™¨å°è¯•ä½¿ç”¨çœŸå®GPS');
    }).catch((error: Error) => {
      console.error('åˆå§‹åŒ–å†å²æœåŠ¡å¤±è´¥:', error);
    });
    
    // åˆå§‹åŒ–æˆå°±æœåŠ¡
    await this.achievementService.init(context);
    console.log('æˆå°±æœåŠ¡å·²åˆå§‹åŒ–');
    
    // åˆå§‹åŒ–æé†’æœåŠ¡
    this.reminderService.init(context);
    console.log('æé†’æœåŠ¡å·²åˆå§‹åŒ–');
    console.log('ReminderService å®ä¾‹:', this.reminderService);
    console.log('SportService ä½¿ç”¨çš„ ReminderService å®ä¾‹:', this.sportService.getReminderService());
    
    // é¡µé¢åˆå§‹åŒ–æ—¶è‡ªåŠ¨è·å–å½“å‰å®šä½
    try {
      await this.autoGetLocation();
    } catch (error) {
      console.error('è‡ªåŠ¨è·å–å®šä½å¤±è´¥:', error);
      // å¦‚æœè·å–å®šä½å¤±è´¥ï¼Œè®¾ç½®ä¸€ä¸ªé»˜è®¤ä½ç½®
      this.setDefaultLocation();
    }
  }
  
  // è‡ªåŠ¨è·å–å®šä½
  private async autoGetLocation(): Promise<void> {
    const context = getContext(this) as common.UIAbilityContext;
    const hasPermission = await this.locationService.requestPermissions(context);
    
    if (hasPermission) {
      const result = await this.locationService.getCurrentLocation();
      if (result.location) {
        this.currentLocation = result.location;
        this.routeData.updateCurrentLocation(result.location);
        this.routeData.addRoutePoint(result.location);
        console.log('è‡ªåŠ¨è·å–åˆ°çœŸå®å®šä½:', result.location);
      } else {
        console.error('è‡ªåŠ¨è·å–å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
        this.setDefaultLocation();
      }
    } else {
      console.error('æ²¡æœ‰å®šä½æƒé™ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
      this.setDefaultLocation();
    }
  }
  
  // è®¾ç½®é»˜è®¤ä½ç½®
  private setDefaultLocation(): void {
    const defaultLocation = new LocationInfo(
      39.9042, // åŒ—äº¬å¤©å®‰é—¨é™„è¿‘
      116.4074,
      0,
      0,
      0,
      Date.now(),
      0,
      0,
      0
    );
    this.currentLocation = defaultLocation;
    this.routeData.updateCurrentLocation(defaultLocation);
    this.routeData.addRoutePoint(defaultLocation);
    console.log('ä½¿ç”¨é»˜è®¤ä½ç½®:', defaultLocation);
  }

  onSelectSportType(type: SportType): void {
    this.selectedType = type;
  }

  onStartSport(): void {
    this.startSport();
  }

  onPauseSport(): void {
    this.pauseSport();
  }

  onResumeSport(): void {
    this.resumeSport();
  }

  onStopSport(): void {
    this.stopSport();
  }

  build() {
    Column() {
      Scroll() {
        Column() {
          this.TopNavBar()
          
          if (this.errorMessage) {
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor(Color.Red)
              .margin({ bottom: 12 })
              .alignSelf(ItemAlign.Center)
          }
          
          if (!this.isRunning) {
            // æ·»åŠ å½“å‰å®šä½æ˜¾ç¤ºå’Œè·å–å®šä½æŒ‰é’®
            Column() {
              Text(`å½“å‰å®šä½: ${this.currentLocation ? `${this.currentLocation.latitude.toFixed(6)}, ${this.currentLocation.longitude.toFixed(6)}` : 'æœªè·å–'}`)
                .fontSize(14)
                .fontColor('#666666')
                .margin({ bottom: 8 })
                .width('100%')
                .textAlign(TextAlign.Center)
              
              Row() {
                Button('è·å–å½“å‰å®šä½')
                  .fontSize(14)
                  .fontColor('#FFFFFF')
                  .backgroundColor('#4ECDC4')
                  .borderRadius(8)
                  .padding({ left: 16, right: 16, top: 6, bottom: 6 })
                  .onClick(() => {
                    this.getCurrentLocation();
                  })
                
                Button('æ‰“å¼€å®šä½è®¾ç½®')
                  .fontSize(14)
                  .fontColor('#4ECDC4')
                  .backgroundColor('#FFFFFF')
                  .borderRadius(8)
                  .padding({ left: 16, right: 16, top: 6, bottom: 6 })
                  .border({ width: 1, color: '#4ECDC4' })
                  .onClick(() => {
                    this.openLocationSettings();
                  })
                  .margin({ left: 8 })
              }
              .justifyContent(FlexAlign.Center)
            }
            .margin({ bottom: 12 })
          }
          
          this.SportTypeSelector()
          
          // æé†’è®¾ç½®ç»„ä»¶
          ReminderSettingComponent({
            reminderService: this.reminderService
          })
          .margin({ bottom: 16 })
          
          this.MapArea()
          
          if (this.sportData) {
            Column() {
              Row() {
                Column() {
                  Text(this.sportData.distance.toFixed(0))
                    .fontSize(20)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#FF6B6B')
                    .margin({ bottom: 2 })
                  Text('è·ç¦»')
                    .fontSize(12)
                    .fontColor('#999999')
                }
                .alignItems(HorizontalAlign.Center)
                
                Column() {
                  Text(this.formatDuration(this.sportData.duration))
                    .fontSize(20)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#4ECDC4')
                    .margin({ bottom: 2 })
                  Text('æ—¶é—´')
                    .fontSize(12)
                    .fontColor('#999999')
                }
                .alignItems(HorizontalAlign.Center)
                
                Column() {
                  Text(this.sportData.currentSpeed.toFixed(1))
                    .fontSize(20)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#45B7D1')
                    .margin({ bottom: 2 })
                  Text('é€Ÿåº¦')
                    .fontSize(12)
                    .fontColor('#999999')
                }
                .alignItems(HorizontalAlign.Center)
                
                Column() {
                  Text(this.sportData.calories.toFixed(0))
                    .fontSize(20)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#FFA502')
                    .margin({ bottom: 2 })
                  Text('å¡è·¯é‡Œ')
                    .fontSize(12)
                    .fontColor('#999999')
                }
                .alignItems(HorizontalAlign.Center)
              }
              .width('100%')
              .justifyContent(FlexAlign.SpaceEvenly)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .shadow({ radius: 6, color: '#1A000000', offsetX: 0, offsetY: 2 })
            .margin({ bottom: 16 })
          }
        }
        .width('100%')
        .backgroundColor('#F8F9FA')
        .padding({ left: 16, right: 16 })
      }
      .flexGrow(1)
      
      // ä¸­å¤®æ§åˆ¶åŒºåŸŸå›ºå®šåœ¨åº•éƒ¨
      Row() {
        this.CentralControl()
      }
      .margin({ bottom: 20 })
    }
    .width('100%')
    .height('100%')
    .padding({ top: 10, bottom: 10 })
  }

  @Builder
  TopNavBar() {
    Row() {
      Column() {
        Text('è¿åŠ¨åŠ©æ‰‹')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
        Text(this.getSportTypeName())
          .fontSize(12)
          .fontColor('#999999')
      }
      .alignItems(HorizontalAlign.Start)

      Blank()

      Row() {
        Text('ğŸ‘¤')
          .fontSize(20)
          .margin({ right: 12 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/ProfilePage' });
          })

        Text('ğŸ“Š')
          .fontSize(20)
          .margin({ right: 12 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/HistoryPage' });
          })

        Text('ğŸ†')
          .fontSize(20)
          .margin({ right: 12 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/AchievementPage' });
          })

        if (this.isRunning && !this.isPaused) {
          Row() {
            Circle()
              .width(10)
              .height(10)
              .fill('#FF6B6B')
              .margin({ right: 4 })
            Text('è¿åŠ¨ä¸­')
              .fontSize(12)
              .fontColor('#FF6B6B')
          }
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .backgroundColor('#FF6B6B20')
          .borderRadius(16)
        }
      }
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceBetween)
    .margin({ bottom: 12 })
  }

  @Builder
  SportTypeSelector() {
    Column() {
      // è¿åŠ¨ç±»å‹é€‰æ‹©
      Row() {
        Text('è¿åŠ¨ç±»å‹:')
          .fontSize(12)
          .fontColor('#666666')
          .margin({ right: 8 })
        
        Text('è·‘æ­¥')
          .fontSize(12)
          .fontWeight(this.selectedType === SportType.RUNNING ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedType === SportType.RUNNING ? '#FFFFFF' : '#333333')
          .backgroundColor(this.selectedType === SportType.RUNNING ? '#4ECDC4' : '#F0F0F0')
          .borderRadius(16)
          .padding({ left: 16, right: 16, top: 6, bottom: 6 })
          .margin({ right: 6 })
          .onClick(() => {
            this.selectedType = SportType.RUNNING;
          })
        
        Text('è¡Œèµ°')
          .fontSize(12)
          .fontWeight(this.selectedType === SportType.WALKING ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedType === SportType.WALKING ? '#FFFFFF' : '#333333')
          .backgroundColor(this.selectedType === SportType.WALKING ? '#4ECDC4' : '#F0F0F0')
          .borderRadius(16)
          .padding({ left: 16, right: 16, top: 6, bottom: 6 })
          .margin({ right: 6 })
          .onClick(() => {
            this.selectedType = SportType.WALKING;
          })
        
        Text('éª‘è¡Œ')
          .fontSize(12)
          .fontWeight(this.selectedType === SportType.CYCLING ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedType === SportType.CYCLING ? '#FFFFFF' : '#333333')
          .backgroundColor(this.selectedType === SportType.CYCLING ? '#4ECDC4' : '#F0F0F0')
          .borderRadius(16)
          .padding({ left: 16, right: 16, top: 6, bottom: 6 })
          .onClick(() => {
            this.selectedType = SportType.CYCLING;
          })
      }
      .margin({ bottom: 8 })
      .justifyContent(FlexAlign.Start)
      
      // è¿è¡Œæ¨¡å¼åˆ‡æ¢
      Row() {
        Text('è¿è¡Œæ¨¡å¼:')
          .fontSize(12)
          .fontColor('#666666')
          .margin({ right: 8 })
        
        if (this.isSimulator) {
          // å½“å‰æ˜¯æ¨¡æ‹Ÿæ¨¡å¼ï¼Œæ˜¾ç¤ºçœŸå®æ¨¡å¼æŒ‰é’®
          Text('åˆ‡æ¢åˆ°çœŸå®æ¨¡å¼')
            .fontSize(12)
            .fontColor('#4ECDC4')
            .onClick(() => {
              this.isSimulator = false;
              console.log('åˆ‡æ¢åˆ°çœŸå®æ¨¡å¼');
            })
        } else {
          // å½“å‰æ˜¯çœŸå®æ¨¡å¼ï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿæ¨¡å¼æŒ‰é’®
          Text('åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼')
            .fontSize(12)
            .fontColor('#4ECDC4')
            .onClick(() => {
              this.isSimulator = true;
              console.log('åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼');
            })
        }
      }
      .margin({ bottom: 12 })
      .justifyContent(FlexAlign.Start)
    }
  }

  @Builder
  MapArea() {
    // åœ°å›¾ç»„ä»¶
    RouteMap({
      routeData: $routeData
    })
    .margin({ bottom: 16 })
    .height(250)
  }

  @Builder
  CentralControl() {
    SportControlButton({
      isRunning: this.isRunning,
      isPaused: this.isPaused,
      onStart: () => {
        this.startSport();
      },
      onPause: () => {
        this.pauseSport();
      },
      onResume: () => {
        this.resumeSport();
      },
      onStop: () => {
        this.stopSport();
      }
    })
    .margin({ bottom: 20 })
  }

  async startSport() {
    this.errorMessage = '';
    this.routePoints = [];
    // é‡ç½®routeDataï¼Œç¡®ä¿æ¯æ¬¡è¿åŠ¨å¼€å§‹æ—¶éƒ½æ˜¯æ–°çš„å®ä¾‹
    this.routeData = new RouteData();

    try {
      if (this.isSimulator) {
        console.log('æ¨¡æ‹Ÿå™¨ç¯å¢ƒï¼Œç›´æ¥å¯åŠ¨æ¨¡æ‹Ÿ');
        this.sportData = this.sportService.startSport(this.selectedType);
        this.isRunning = true;
        this.isPaused = false;
        console.log('è¿åŠ¨æœåŠ¡å·²å¯åŠ¨, sportData:', this.sportData);
        
        // æ¨¡æ‹Ÿå™¨æ¨¡å¼ä¸‹ï¼Œè®¾ç½®åˆå§‹ä½ç½®
        const initialLocation = new LocationInfo(
          39.9042, // åŒ—äº¬å¤©å®‰é—¨é™„è¿‘
          116.4074,
          0,
          0,
          0,
          Date.now(),
          0,
          0,
          0
        );
        this.currentLocation = initialLocation;
        this.routeData.updateCurrentLocation(initialLocation);
        this.routeData.addRoutePoint(initialLocation);
        
        this.startSimulation();
        this.startUIUpdateTimer();
      } else {
        const context = getContext(this) as common.UIAbilityContext;
        console.log('å¼€å§‹è¯·æ±‚æƒé™...');
        const hasPermission = await this.locationService.requestPermissions(context);
        console.log('æƒé™ç»“æœ:', hasPermission);
        
        if (!hasPermission) {
          this.errorMessage = 'ä½ç½®æƒé™è¢«æ‹’ç»ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼';
          // æƒé™è¢«æ‹’ç»ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼
          this.isSimulator = true;
          this.sportData = this.sportService.startSport(this.selectedType);
          this.isRunning = true;
          this.isPaused = false;
          
          // æ¨¡æ‹Ÿå™¨æ¨¡å¼ä¸‹ï¼Œè®¾ç½®åˆå§‹ä½ç½®
          const initialLocation = new LocationInfo(
            39.9042, // åŒ—äº¬å¤©å®‰é—¨é™„è¿‘
            116.4074,
            0,
            0,
            0,
            Date.now(),
            0,
            0,
            0
          );
          this.currentLocation = initialLocation;
          this.routeData.updateCurrentLocation(initialLocation);
          this.routeData.addRoutePoint(initialLocation);
          
          this.startSimulation();
          return;
        }

        console.log('å¯åŠ¨è¿åŠ¨æœåŠ¡...');
        this.sportData = this.sportService.startSport(this.selectedType);
        this.isRunning = true;
        this.isPaused = false;
        
        // å¯åŠ¨UIæ›´æ–°å®šæ—¶å™¨
        this.startUIUpdateTimer();
        
        console.log('çœŸæœºç¯å¢ƒï¼Œå¯åŠ¨çœŸå®ä½ç½®æ›´æ–°');
        try {
          const success = await this.locationService.startLocationUpdate((location: LocationInfo) => {
            console.log('æ”¶åˆ°ä½ç½®æ›´æ–°:', location);
            if (this.isRunning && !this.isPaused) {
              this.currentLocation = location;
              this.routePoints.push(location);
              this.routeData.updateCurrentLocation(location);
              this.routeData.addRoutePoint(location);
              this.sportService.updateLocation(location);
              this.sportData = this.sportService.getCurrentSportData();
            }
          });

          if (!success) {
            console.error('å¯åŠ¨ä½ç½®æ›´æ–°å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼');
            this.errorMessage = 'å¯åŠ¨ä½ç½®è¿½è¸ªå¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼';
            // å¯åŠ¨çœŸå®ä½ç½®æœåŠ¡å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼
            this.locationService.stopLocationUpdate();
            this.isSimulator = true;
            
            // æ¨¡æ‹Ÿå™¨æ¨¡å¼ä¸‹ï¼Œè®¾ç½®åˆå§‹ä½ç½®
            const initialLocation = new LocationInfo(
              39.9042, // åŒ—äº¬å¤©å®‰é—¨é™„è¿‘
              116.4074,
              0,
              0,
              0,
              Date.now(),
              0,
              0,
              0
            );
            this.currentLocation = initialLocation;
            this.routeData.updateCurrentLocation(initialLocation);
            this.routeData.addRoutePoint(initialLocation);
            
            this.startSimulation();
          }
        } catch (err) {
          console.error('å¯åŠ¨ä½ç½®æ›´æ–°å‘ç”Ÿå¼‚å¸¸ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼:', err);
          this.errorMessage = 'ä½ç½®æœåŠ¡å¼‚å¸¸ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼';
          // å‘ç”Ÿå¼‚å¸¸ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼
          this.locationService.stopLocationUpdate();
          this.isSimulator = true;
          
          // æ¨¡æ‹Ÿå™¨æ¨¡å¼ä¸‹ï¼Œè®¾ç½®åˆå§‹ä½ç½®
          const initialLocation = new LocationInfo(
            39.9042, // åŒ—äº¬å¤©å®‰é—¨é™„è¿‘
            116.4074,
            0,
            0,
            0,
            Date.now(),
            0,
            0,
            0
          );
          this.currentLocation = initialLocation;
          this.routeData.updateCurrentLocation(initialLocation);
          this.routeData.addRoutePoint(initialLocation);
          
          this.startSimulation();
        }
      }
    } catch (err) {
      console.error('å¯åŠ¨è¿åŠ¨å¤±è´¥:', err);
      this.errorMessage = 'å‘ç”Ÿé”™è¯¯: ' + JSON.stringify(err);
      this.isRunning = false;
    }
  }

  pauseSport() {
    this.sportService.pauseSport();
    this.isPaused = true;
    // æš‚åœæ—¶åœæ­¢UIæ›´æ–°å®šæ—¶å™¨
    this.stopUIUpdateTimer();
    this.sportData = this.sportService.getCurrentSportData();
  }

  resumeSport() {
    this.sportService.resumeSport();
    this.isPaused = false;
    // æ¢å¤æ—¶é‡æ–°å¯åŠ¨UIæ›´æ–°å®šæ—¶å™¨
    this.startUIUpdateTimer();
  }

  stopSport() {
    const finalData = this.sportService.stopSport();
    this.locationService.stopLocationUpdate();
    this.stopSimulation();
    this.stopUIUpdateTimer();
    this.isRunning = false;
    this.isPaused = false;
    this.currentLocation = null;
    
    if (finalData) {
      this.historyService.saveSportRecord(finalData).then(async () => {
        // æ£€æŸ¥å¹¶æ›´æ–°æˆå°±
        const newlyUnlocked = await this.achievementService.checkAndUpdateAchievements(finalData);
        if (newlyUnlocked.length > 0) {
          console.log(`è§£é”äº† ${newlyUnlocked.length} ä¸ªæˆå°±`);
          // æ˜¾ç¤ºæˆå°±è§£é”æç¤º
          promptAction.showToast({
            message: `ğŸ‰ è§£é”äº† ${newlyUnlocked.length} ä¸ªæˆå°±ï¼`,
            duration: 3000
          });
        }
      }).catch((error: Error) => {
        console.error('ä¿å­˜è®°å½•æˆ–æ£€æŸ¥æˆå°±å¤±è´¥:', error);
      });
      this.showSportSummary(finalData);
    }
  }
  
  // å¯åŠ¨UIæ›´æ–°å®šæ—¶å™¨
  private startUIUpdateTimer(): void {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    this.stopUIUpdateTimer();
    
    // åˆ›å»ºæ–°çš„å®šæ—¶å™¨ï¼Œæ¯ç§’æ›´æ–°ä¸€æ¬¡UI
    this.uiUpdateTimer = setInterval(() => {
      if (this.isRunning) {
        // ä»è¿åŠ¨æœåŠ¡è·å–æœ€æ–°çš„è¿åŠ¨æ•°æ®
        const latestData = this.sportService.getCurrentSportData();
        if (latestData) {
          // æ›´æ–°@Stateå˜é‡ï¼Œè§¦å‘UIåˆ·æ–°
          this.sportData = latestData;
          console.log('UIæ›´æ–°å®šæ—¶å™¨è§¦å‘ï¼Œæ›´æ–°è¿åŠ¨æ•°æ®');
        }
      }
    }, 1000);
  }
  
  // åœæ­¢UIæ›´æ–°å®šæ—¶å™¨
  private stopUIUpdateTimer(): void {
    if (this.uiUpdateTimer !== -1) {
      clearInterval(this.uiUpdateTimer);
      this.uiUpdateTimer = -1;
    }
  }

  startSimulation() {
    console.log('å¼€å§‹æ¨¡æ‹Ÿä½ç½®æ›´æ–°');
    let baseLat = 39.9042;
    let baseLon = 116.4074;
    let index = 0;
    let lastLat = baseLat;
    let lastLon = baseLon;
    let lastTime = Date.now();
    let totalDistance = 0;
    
    this.simulationTimer = setInterval(() => {
      console.log('æ¨¡æ‹Ÿå®šæ—¶å™¨è§¦å‘, isRunning:', this.isRunning, 'isPaused:', this.isPaused);
      
      if (!this.isRunning || this.isPaused) {
        console.log('æ¨¡æ‹Ÿæš‚åœï¼Œè·³è¿‡æ›´æ–°');
        return;
      }
      
      let lat = baseLat;
      let lon = baseLon;
      
      // ç”Ÿæˆæ›´åŠ å¹³æ»‘çš„è½¨è¿¹ï¼Œé¿å…å‡ºç°æ˜æ˜¾çš„æ¨ªå‘çº¿æ®µ
      if (index > 0) {
        // ç”Ÿæˆç›´çº¿è¿åŠ¨è½¨è¿¹ï¼Œä»ä¸­å¿ƒç‚¹å‘åŒ—åä¸œæ–¹å‘ç§»åŠ¨
        const step = 0.0005; // æ¯æ­¥ç§»åŠ¨çš„è·ç¦»ï¼ˆçº¦50ç±³ï¼‰
        const direction = Math.PI / 4; // 45åº¦æ–¹å‘ï¼ŒåŒ—åä¸œ
        
        // æ ¹æ®ç´¢å¼•ç”Ÿæˆå¹³æ»‘çš„ä½ç½®ï¼Œé¿å…è·³è·ƒ
        lat = baseLat + Math.sin(direction) * step * index;
        lon = baseLon + Math.cos(direction) * step * index;
      }
      
      const speed = 2 + Math.random() * 3;
      const currentTime = Date.now();
      
      const distance = this.calculateDistance(lastLat, lastLon, lat, lon);
      totalDistance += distance;
      const netDuration = currentTime - lastTime;
      
      console.log('ç”Ÿæˆæ¨¡æ‹Ÿä½ç½®:', index, 'lat:', lat, 'lon:', lon, 'speed:', speed, 'distance:', distance, 'totalDistance:', totalDistance);
      
      const location = new LocationInfo(
        lat,
        lon,
        100,
        10,
        speed,
        currentTime,
        totalDistance,
        distance,
        netDuration
      );
      
      lastLat = lat;
      lastLon = lon;
      lastTime = currentTime;
      
      console.log('æ›´æ–°routeDataä¹‹å‰, routePointsé•¿åº¦:', this.routePoints.length, 'routeData.routePointsé•¿åº¦:', this.routeData.routePoints.length);
      this.routeData.addRoutePoint(location);
      this.routeData.updateCurrentLocation(location);
      this.routePoints.push(location);
      this.sportService.updateLocation(location);
      this.sportData = this.sportService.getCurrentSportData();
      console.log('æ›´æ–°routeDataä¹‹å, routePointsé•¿åº¦:', this.routePoints.length, 'routeData.routePointsé•¿åº¦:', this.routeData.routePoints.length);
      
      console.log('æ¨¡æ‹Ÿä½ç½®æ›´æ–°å®Œæˆ, routePointsé•¿åº¦:', this.routePoints.length, 'sportData:', this.sportData);
      
      index++;
    }, 2000);
    
    console.log('æ¨¡æ‹Ÿå®šæ—¶å™¨å·²å¯åŠ¨, ID:', this.simulationTimer);
  }

  stopSimulation() {
    if (this.simulationTimer !== -1) {
      clearInterval(this.simulationTimer);
      this.simulationTimer = -1;
      console.log('åœæ­¢æ¨¡æ‹Ÿä½ç½®æ›´æ–°');
    }
  }

  calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {
    const R = 6371000;
    const dLat = this.toRadians(lat2 - lat1);
    const dLon = this.toRadians(lon2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  toRadians(degrees: number): number {
    return degrees * (Math.PI / 180);
  }

  showSportSummary(data: SportData) {
    promptAction.showDialog({
      title: 'è¿åŠ¨å®Œæˆ',
      message: `è¿åŠ¨ç±»å‹: ${this.getSportTypeName()}\nè·ç¦»: ${data.distance.toFixed(2)}ç±³\næ—¶é—´: ${this.formatDuration(data.duration)}\nå¹³å‡é€Ÿåº¦: ${data.averageSpeed.toFixed(1)}ç±³/ç§’\næ¶ˆè€—å¡è·¯é‡Œ: ${data.calories.toFixed(0)}`,
      buttons: [
        {
          text: 'ç¡®å®š',
          color: '#007AFF'
        }
      ]
    }).then(() => {
      this.sportData = null;
    });
  }

  getSportTypeName(): string {
    switch (this.selectedType) {
      case SportType.RUNNING:
        return 'è·‘æ­¥';
      case SportType.WALKING:
        return 'è¡Œèµ°';
      case SportType.CYCLING:
        return 'éª‘è¡Œ';
      default:
        return 'è¿åŠ¨';
    }
  }

  private formatDuration(duration: number): string {
    const hours = Math.floor(duration / 3600000);
    const minutes = Math.floor((duration % 3600000) / 60000);
    const seconds = Math.floor((duration % 60000) / 1000);

    if (hours > 0) {
      return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }
  
  // è·å–å½“å‰å®šä½æ–¹æ³•
  private getCurrentLocation(): void {
    console.log('å¼€å§‹è·å–å½“å‰å®šä½');
    const context = getContext(this) as common.UIAbilityContext;
    
    // æ£€æŸ¥å¹¶è¯·æ±‚å®šä½æƒé™
    this.locationService.requestPermissions(context).then((hasPermission) => {
      console.log('æƒé™æ£€æŸ¥ç»“æœ:', hasPermission);
      if (!hasPermission) {
        this.errorMessage = 'ä½ç½®æƒé™è¢«æ‹’ç»ï¼Œæ— æ³•è·å–å®šä½';
        return;
      }
      
      // è·å–å½“å‰å®šä½
      console.log('æƒé™å·²è·å–ï¼Œå¼€å§‹è¯·æ±‚çœŸå®å®šä½');
      this.locationService.getCurrentLocation().then((result) => {
        console.log('å®šä½ç»“æœè¿”å›:', result);
        if (result.location) {
          this.currentLocation = result.location;
          console.log('è·å–åˆ°çœŸå®å®šä½:', result.location);
          this.errorMessage = '';
          
          // æ›´æ–°routeDataçš„å½“å‰ä½ç½®
          this.routeData.updateCurrentLocation(result.location);
          this.routeData.addRoutePoint(result.location);
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          promptAction.showToast({
            message: 'è·å–çœŸå®å®šä½æˆåŠŸ',
            duration: 2000
          });
        } else {
          if (result.isLocationSwitchOff) {
            console.error('ä½ç½®å¼€å…³å¤„äºå…³é—­çŠ¶æ€');
            this.errorMessage = 'ä½ç½®å¼€å…³å¤„äºå…³é—­çŠ¶æ€ï¼Œè¯·å¼€å¯åé‡è¯•';
            
            // æ˜¾ç¤ºä½ç½®å¼€å…³å…³é—­æç¤º
            promptAction.showToast({
              message: 'ä½ç½®å¼€å…³å…³é—­ï¼Œè¯·å¼€å¯å®šä½æœåŠ¡',
              duration: 2000
            });
          } else {
            console.error('çœŸå®å®šä½å¤±è´¥ï¼Œæ£€æŸ¥æ¨¡æ‹Ÿå™¨GPSæ˜¯å¦å¼€å¯');
            this.errorMessage = 'è·å–çœŸå®å®šä½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾å¤‡GPSæ˜¯å¦å¼€å¯';
            
            // æ˜¾ç¤ºå¤±è´¥æç¤º
            promptAction.showToast({
              message: 'çœŸå®å®šä½å¤±è´¥',
              duration: 2000
            });
          }
        }
      });
    });
  }
  
  // è·³è½¬åˆ°å®šä½è®¾ç½®
  private openLocationSettings(): void {
    const context = getContext(this) as common.UIAbilityContext;
    
    try {
      context.startAbility({
        uri: 'location_manager_settings'
      });
      console.log('å·²è·³è½¬åˆ°å®šä½è®¾ç½®');
    } catch (error) {
      console.error('è·³è½¬å®šä½è®¾ç½®å¤±è´¥:', error);
      promptAction.showToast({
        message: 'è·³è½¬å®šä½è®¾ç½®å¤±è´¥',
        duration: 2000
      });
    }
  }
}
