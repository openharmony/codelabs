import { LocationService } from '../service/LocationService';
import { SportService } from '../service/SportService';
import { HistoryService } from '../service/HistoryService';
import { SportType, SportData, RouteData, LocationInfo } from '../model/SportModel';
import { SportTypeSelector } from '../components/SportTypeSelector';
import { SportDataDisplay } from '../components/SportDataDisplay';
import { SportControlButton } from '../components/SportControlButton';
import { RouteMapInner } from '../components/RouteMapInner';
import { common } from '@kit.AbilityKit';
import router from '@ohos.router';
import { map } from '@kit.MapKit';

@Entry
@Component
struct Index {
  @State selectedType: SportType = SportType.RUNNING;
  @State sportData: SportData | null = null;
  @State isRunning: boolean = false;
  @State isPaused: boolean = false;
  @State errorMessage: string = '';
  @State currentLocation: LocationInfo | null = null;
  @State routePoints: LocationInfo[] = [];
  @State isSimulator: boolean = false;
  @State routeData: RouteData = new RouteData();
  
  private locationService: LocationService = new LocationService();
  private sportService: SportService = new SportService();
  private historyService: HistoryService = new HistoryService();
  private simulationTimer: number = -1;
  private routeMapController?: map.MapComponentController;

  async aboutToAppear() {
    const context = getContext(this) as common.UIAbilityContext;
    await this.historyService.init(context);
    this.isSimulator = true;
    console.log('ä½¿ç”¨æ¨¡æ‹Ÿå™¨æ¨¡å¼');
  }

  onSelectSportType(type: SportType): void {
    this.selectedType = type;
  }

  onStartSport(): void {
    this.startSport();
  }

  onPauseSport(): void {
    this.pauseSport();
  }

  onResumeSport(): void {
    this.resumeSport();
  }

  onStopSport(): void {
    this.stopSport();
  }

  build() {
    Column() {
      this.Header()

      if (this.errorMessage) {
        Text(this.errorMessage)
          .fontSize(14)
          .fontColor(Color.Red)
          .margin({ top: 10, bottom: 10 })
      }

      if (!this.isRunning) {
        SportTypeSelector({
          selectedType: this.selectedType,
          onSelect: (type: SportType) => {
            this.onSelectSportType(type);
          }
        })
        .margin({ top: 20 })
      }

      if (this.isRunning) {
        RouteMapInner({
          routeData: $routeData
        })
        .margin({ top: 20 })
      }

      if (this.sportData) {
        Text(`è°ƒè¯•: è·ç¦»=${this.sportData.distance.toFixed(2)} æ—¶é—´=${this.sportData.duration.toFixed(0)}`)
          .fontSize(12)
          .fontColor('#999999')
          .margin({ top: 10, bottom: 10 })
        
        Column() {
          Row() {
            Column() {
              Text(this.sportData.distance.toFixed(0))
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF6B6B')
                .margin({ bottom: 4 })
              Text('è·ç¦»')
                .fontSize(12)
                .fontColor('#999999')
            }
            .alignItems(HorizontalAlign.Center)
            
            Column() {
              Text(this.formatDuration(this.sportData.duration))
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#4ECDC4')
                .margin({ bottom: 4 })
              Text('æ—¶é—´')
                .fontSize(12)
                .fontColor('#999999')
            }
            .alignItems(HorizontalAlign.Center)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceEvenly)
          .margin({ bottom: 20 })

          Row() {
            Column() {
              Text(this.sportData.currentSpeed.toFixed(1))
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#45B7D1')
                .margin({ bottom: 4 })
              Text('é€Ÿåº¦')
                .fontSize(12)
                .fontColor('#999999')
            }
            .alignItems(HorizontalAlign.Center)
            
            Column() {
              Text(this.sportData.calories.toFixed(0))
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFA502')
                .margin({ bottom: 4 })
              Text('å¡è·¯é‡Œ')
                .fontSize(12)
                .fontColor('#999999')
            }
            .alignItems(HorizontalAlign.Center)
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceEvenly)
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .shadow({ radius: 8, color: '#1A000000', offsetX: 0, offsetY: 2 })
      }

      Blank()

      SportControlButton({
        isRunning: this.isRunning,
        isPaused: this.isPaused,
        onStart: () => {
          this.onStartSport();
        },
        onPause: () => {
          this.onPauseSport();
        },
        onResume: () => {
          this.onResumeSport();
        },
        onStop: () => {
          this.onStopSport();
        }
      })
      .margin({ bottom: 30 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
    .padding({ top: 20, left: 16, right: 16 })
  }

  @Builder
  Header() {
    Row() {
      Column() {
        Text('è¿åŠ¨åŠ©æ‰‹')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
        Text(this.getSportTypeName())
          .fontSize(14)
          .fontColor('#999999')
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)

      Blank()

      Row() {
        Text('ðŸ“Š')
          .fontSize(24)
          .margin({ right: 16 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/HistoryPage' });
          })

        if (this.isRunning && !this.isPaused) {
          Row() {
            Circle()
              .width(12)
              .height(12)
              .fill('#FF6B6B')
              .margin({ right: 6 })
            Text('è¿åŠ¨ä¸­')
              .fontSize(14)
              .fontColor('#FF6B6B')
          }
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor('#FF6B6B20')
          .borderRadius(20)
        }
      }
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceBetween)
  }

  async startSport() {
    this.errorMessage = '';
    this.routePoints = [];

    try {
      if (this.isSimulator) {
        console.log('æ¨¡æ‹Ÿå™¨çŽ¯å¢ƒï¼Œç›´æŽ¥å¯åŠ¨æ¨¡æ‹Ÿ');
        this.sportData = this.sportService.startSport(this.selectedType);
        this.isRunning = true;
        this.isPaused = false;
        console.log('è¿åŠ¨æœåŠ¡å·²å¯åŠ¨, sportData:', this.sportData);
        this.startSimulation();
      } else {
        const context = getContext(this) as common.UIAbilityContext;
        console.log('å¼€å§‹è¯·æ±‚æƒé™...');
        const hasPermission = await this.locationService.requestPermissions(context);
        console.log('æƒé™ç»“æžœ:', hasPermission);
        
        if (!hasPermission) {
          this.errorMessage = 'ä½ç½®æƒé™è¢«æ‹’ç»';
          return;
        }

        console.log('å¯åŠ¨è¿åŠ¨æœåŠ¡...');
        this.sportData = this.sportService.startSport(this.selectedType);
        this.isRunning = true;
        this.isPaused = false;
        
        console.log('çœŸæœºçŽ¯å¢ƒï¼Œå¯åŠ¨çœŸå®žä½ç½®æ›´æ–°');
        const success = await this.locationService.startLocationUpdate((location: LocationInfo) => {
          console.log('æ”¶åˆ°ä½ç½®æ›´æ–°:', location);
          if (this.isRunning && !this.isPaused) {
            this.currentLocation = location;
            this.routePoints.push(location);
            this.sportService.updateLocation(location);
            this.sportData = this.sportService.getCurrentSportData();
          }
        });

        if (!success) {
          console.error('å¯åŠ¨ä½ç½®æ›´æ–°å¤±è´¥');
          this.errorMessage = 'å¯åŠ¨ä½ç½®è¿½è¸ªå¤±è´¥';
          this.isRunning = false;
        }
      }
    } catch (err) {
      console.error('å¯åŠ¨è¿åŠ¨å¤±è´¥:', err);
      this.errorMessage = 'å‘ç”Ÿé”™è¯¯: ' + JSON.stringify(err);
      this.isRunning = false;
    }
  }

  pauseSport() {
    this.sportService.pauseSport();
    this.isPaused = true;
    this.sportData = this.sportService.getCurrentSportData();
  }

  resumeSport() {
    this.sportService.resumeSport();
    this.isPaused = false;
  }

  stopSport() {
    const finalData = this.sportService.stopSport();
    this.locationService.stopLocationUpdate();
    this.stopSimulation();
    this.isRunning = false;
    this.isPaused = false;
    this.currentLocation = null;
    
    if (finalData) {
      this.historyService.saveSportRecord(finalData);
      this.showSportSummary(finalData);
    }
  }

  startSimulation() {
    console.log('å¼€å§‹æ¨¡æ‹Ÿä½ç½®æ›´æ–°');
    let baseLat = 39.9042;
    let baseLon = 116.4074;
    let index = 0;
    let lastLat = baseLat;
    let lastLon = baseLon;
    let lastTime = Date.now();
    let totalDistance = 0;
    
    this.simulationTimer = setInterval(() => {
      console.log('æ¨¡æ‹Ÿå®šæ—¶å™¨è§¦å‘, isRunning:', this.isRunning, 'isPaused:', this.isPaused);
      
      if (!this.isRunning || this.isPaused) {
        console.log('æ¨¡æ‹Ÿæš‚åœï¼Œè·³è¿‡æ›´æ–°');
        return;
      }
      
      index++;
      
      const angle = index * 0.05;
      const radius = 0.002;
      
      const lat = baseLat + Math.sin(angle) * radius;
      const lon = baseLon + Math.cos(angle) * radius;
      
      const speed = 2 + Math.random() * 3;
      const currentTime = Date.now();
      
      const distance = this.calculateDistance(lastLat, lastLon, lat, lon);
      totalDistance += distance;
      const netDuration = currentTime - lastTime;
      
      console.log('ç”Ÿæˆæ¨¡æ‹Ÿä½ç½®:', index, 'lat:', lat, 'lon:', lon, 'speed:', speed, 'distance:', distance, 'totalDistance:', totalDistance);
      
      const location = new LocationInfo(
        lat,
        lon,
        100,
        10,
        speed,
        currentTime,
        totalDistance,
        distance,
        netDuration
      );
      
      lastLat = lat;
      lastLon = lon;
      lastTime = currentTime;
      
      console.log('æ›´æ–°routeDataä¹‹å‰, routePointsé•¿åº¦:', this.routePoints.length, 'routeData.routePointsé•¿åº¦:', this.routeData.routePoints.length);
      this.routeData.addRoutePoint(location);
      this.routeData.updateCurrentLocation(location);
      this.routePoints.push(location);
      this.sportService.updateLocation(location);
      this.sportData = this.sportService.getCurrentSportData();
      console.log('æ›´æ–°routeDataä¹‹åŽ, routePointsé•¿åº¦:', this.routePoints.length, 'routeData.routePointsé•¿åº¦:', this.routeData.routePoints.length);
      
      console.log('æ¨¡æ‹Ÿä½ç½®æ›´æ–°å®Œæˆ, routePointsé•¿åº¦:', this.routePoints.length, 'sportData:', this.sportData);
    }, 2000);
    
    console.log('æ¨¡æ‹Ÿå®šæ—¶å™¨å·²å¯åŠ¨, ID:', this.simulationTimer);
  }

  stopSimulation() {
    if (this.simulationTimer !== -1) {
      clearInterval(this.simulationTimer);
      this.simulationTimer = -1;
      console.log('åœæ­¢æ¨¡æ‹Ÿä½ç½®æ›´æ–°');
    }
  }

  calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {
    const R = 6371000;
    const dLat = this.toRadians(lat2 - lat1);
    const dLon = this.toRadians(lon2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  toRadians(degrees: number): number {
    return degrees * (Math.PI / 180);
  }

  showSportSummary(data: SportData) {
    AlertDialog.show({
      title: 'è¿åŠ¨å®Œæˆ',
      message: `è¿åŠ¨ç±»åž‹: ${this.getSportTypeName()}\nè·ç¦»: ${this.sportService.formatDistance(data.distance)}\næ—¶é—´: ${this.sportService.formatDuration(data.duration)}\nå¹³å‡é€Ÿåº¦: ${this.sportService.formatSpeed(data.averageSpeed)}\næ¶ˆè€—å¡è·¯é‡Œ: ${this.sportService.formatCalories(data.calories)}`,
      confirm: {
        value: 'ç¡®å®š',
        action: () => {
          this.sportData = null;
        }
      }
    });
  }

  getSportTypeName(): string {
    switch (this.selectedType) {
      case SportType.RUNNING:
        return 'è·‘æ­¥';
      case SportType.WALKING:
        return 'è¡Œèµ°';
      case SportType.CYCLING:
        return 'éª‘è¡Œ';
      default:
        return 'è¿åŠ¨';
    }
  }

  private formatDuration(duration: number): string {
    const hours = Math.floor(duration / 3600000);
    const minutes = Math.floor((duration % 3600000) / 60000);
    const seconds = Math.floor((duration % 60000) / 1000);

    if (hours > 0) {
      return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }
}
