
/*
 * Copyright (c) 2026 Huawei Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { promptAction } from '@kit.ArkUI';
import common from '@ohos.app.ability.common';
import picker from '@ohos.file.picker';
import image from '@ohos.multimedia.image';
import fs from '@ohos.file.fs';
import { Item, ItemUseStatus, DEFAULT_CATEGORY_OPTIONS } from '../model/Item';
import ItemRdb from '../data/ItemRdb';
import { StatisticsPage } from './StatisticsPage';
import { MinePage } from './MinePage';
import { itemStore } from '../store';

interface SelectOption {
  value: string;
  icon?: Resource;
}

@Component
struct FormCard {
  @Prop title: string = "";
  @BuilderParam content: () => void = this.emptyBuilder;

  @Builder emptyBuilder() {}

  build() {
    Column() {
      Text(this.title)
        .fontSize(14)
        .fontColor("#666666")
        .margin({ bottom: 8 })
        .width("100%")

      Column() {
        this.content()
      }
      .width("100%")
      .backgroundColor(Color.White)
      .borderRadius(12)
      .padding(12)
      .shadow({ radius: 4, color: "#0D000000", offsetY: 2 })
    }
    .width("100%")
    .margin({ bottom: 16 })
  }
}

@Entry
@Component
struct LightItemNote {
  @State currentTab: number = 0;
  @State itemList: Item[] = [];
  @State searchText: string = "";
  @State editingItemId: number = -1;

  // å›¾ç‰‡é¢„è§ˆçŠ¶æ€ - å…³é”®ä¿®æ”¹
  @State showImagePreview: boolean = false;
  @State previewImagePath: string = "";
  @State imageScale: number = 1; // æ–°å¢ï¼šå›¾ç‰‡ç¼©æ”¾æ¯”ä¾‹
  @State imageOffsetX: number = 0; // æ–°å¢ï¼šå›¾ç‰‡Xè½´åç§»
  @State imageOffsetY: number = 0; // æ–°å¢ï¼šå›¾ç‰‡Yè½´åç§»

  // è¡¨å•çŠ¶æ€
  @State itemName: string = "";
  @State itemCategory: string = "";
  @State itemPrice: string = "";
  @State itemLocation: string = "";
  @State itemNote: string = "";
  @State itemUseStatus: ItemUseStatus = "åœ¨ç”¨";
  @State selectedDate: Date = new Date();
  @State dateStr: string = "";
  @State nameError: string = "";
  @State priceError: string = "";
  @State itemImagePath: string = "";

  private itemCategories: string[] = DEFAULT_CATEGORY_OPTIONS;
  private itemUseStatusOptions: ItemUseStatus[] = ["åœ¨ç”¨", "é—²ç½®", "å·²ä¸¢å¼ƒ"];
  private context = getContext(this) as common.UIAbilityContext;

  aboutToAppear(): void {
    const now = new Date();
    this.dateStr = this.formatDate(now);
    this.initDatabase();
    itemStore.onDataCleared(this.dataClearedCallback);
    itemStore.onItemCountChange(this.itemCountChangedCallback);
  }

  aboutToDisappear(): void {
    itemStore.offDataCleared(this.dataClearedCallback);
    itemStore.offItemCountChange(this.itemCountChangedCallback);
  }

  private async initDatabase(): Promise<void> {
    try {
      await ItemRdb.getRdbStore(this.context);
      await this.refreshItemList();
      await itemStore.updateItemCount();
    } catch (err) {
      console.error("æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:", err);
      promptAction.showToast({ message: 'æ•°æ®åˆå§‹åŒ–å¤±è´¥', duration: 2000 });
    }
  }

  private formatDate(date: Date): string {
    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
  }

  private async refreshItemList(): Promise<void> {
    if (!ItemRdb.isInitialized()) {
      console.warn("æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŠ è½½æ•°æ®");
      return;
    }

    try {
      const items = await ItemRdb.queryAll();
      this.itemList = Array.from(items);
      console.info(`åˆ—è¡¨åˆ·æ–°æˆåŠŸï¼Œå…±${this.itemList.length}æ¡æ•°æ®`);
    } catch (err) {
      console.error("åŠ è½½ç‰©å“åˆ—è¡¨å¤±è´¥:", err);
      promptAction.showToast({ message: 'åŠ è½½æ•°æ®å¤±è´¥', duration: 2000 });
    }
  }

  private showDatePicker(): void {
    DatePickerDialog.show({
      start: new Date("2010-1-1"),
      end: new Date("2100-12-31"),
      selected: this.selectedDate,
      onAccept: (value: DatePickerResult) => {
        const year = value.year;
        const month = value.month;
        const day = value.day;
        if (year !== undefined && month !== undefined && day !== undefined) {
          this.selectedDate = new Date(year, month, day);
          this.dateStr = this.formatDate(this.selectedDate);
        }
      }
    })
  }

  private validateForm(): boolean {
    let isValid = true;

    if (this.itemName.trim() === "") {
      this.nameError = "ç‰©å“åç§°ä¸èƒ½ä¸ºç©º";
      isValid = false;
    } else {
      this.nameError = "";
    }

    if (this.itemPrice === "") {
      this.priceError = "ä»·æ ¼ä¸èƒ½ä¸ºç©º";
      isValid = false;
    } else if (isNaN(Number(this.itemPrice)) || Number(this.itemPrice) < 0) {
      this.priceError = "è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼";
      isValid = false;
    } else {
      this.priceError = "";
    }

    return isValid;
  }

  private getCategoryOptions(): SelectOption[] {
    const options: SelectOption[] = [];
    for (let i = 0; i < this.itemCategories.length; i++) {
      options.push({ value: this.itemCategories[i] });
    }
    return options;
  }

  private async selectItemImage(): Promise<void> {
    try {
      const photoPicker = new picker.PhotoViewPicker();
      const selectOptions = new picker.PhotoSelectOptions();
      selectOptions.maxSelectNumber = 1;
      selectOptions.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;

      const result = await photoPicker.select(selectOptions);

      if (result.photoUris && result.photoUris.length > 0) {
        const imageUri = result.photoUris[0];
        this.itemImagePath = imageUri;
        promptAction.showToast({ message: 'å›¾ç‰‡é€‰æ‹©æˆåŠŸ', duration: 1500 });
      }
    } catch (err) {
      console.error("é€‰æ‹©å›¾ç‰‡å¤±è´¥:", err);
      promptAction.showToast({ message: 'å›¾ç‰‡é€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•', duration: 2000 });
    }
  }

  private removeItemImage(): void {
    this.itemImagePath = "";
    promptAction.showToast({ message: 'å›¾ç‰‡å·²ç§»é™¤', duration: 1500 });
  }

  // å›¾ç‰‡é¢„è§ˆ - å…³é”®ä¿®æ”¹
  private previewImage(item: Item): void {
    if (item.imagePath) {
      this.previewImagePath = item.imagePath;
      this.showImagePreview = true;
      this.imageScale = 1; // é‡ç½®ç¼©æ”¾
      this.imageOffsetX = 0; // é‡ç½®åç§»
      this.imageOffsetY = 0;
    } else {
      promptAction.showToast({ message: 'è¯¥ç‰©å“æš‚æ— å›¾ç‰‡', duration: 1500 });
    }
  }

  // å…³é—­é¢„è§ˆ - å…³é”®ä¿®æ”¹
  private closeImagePreview(): void {
    this.showImagePreview = false;
    this.previewImagePath = "";
    this.imageScale = 1;
    this.imageOffsetX = 0;
    this.imageOffsetY = 0;
  }

  // å›¾ç‰‡ç¼©æ”¾æ‰‹åŠ¿ - æ–°å¢
  private onPinchGesture(event: GestureEvent): void {
    if (event.scale !== undefined) {
      this.imageScale = Math.max(0.5, Math.min(3, this.imageScale * event.scale));
    }
  }

  // å›¾ç‰‡å¹³ç§»æ‰‹åŠ¿ - æ–°å¢
  private onPanGesture(event: GestureEvent): void {
    if (event.offsetX !== undefined && event.offsetY !== undefined) {
      this.imageOffsetX += event.offsetX;
      this.imageOffsetY += event.offsetY;
    }
  }

  private startEdit(item: Item): void {
    this.editingItemId = item.id;
    this.itemName = item.name;
    this.itemCategory = item.category;
    this.itemPrice = item.price.toString();
    this.itemLocation = item.location;
    this.itemNote = item.note;
    this.itemUseStatus = item.useStatus;
    this.dateStr = item.buyDate;
    this.selectedDate = new Date(item.buyDate);
    this.itemImagePath = item.imagePath || "";

    this.currentTab = 0;
    promptAction.showToast({ message: 'è¿›å…¥ç¼–è¾‘æ¨¡å¼', duration: 1500 });
  }

  private async addItem(): Promise<void> {
    if (!this.validateForm()) {
      promptAction.showToast({ message: 'è¯·æ£€æŸ¥è¡¨å•å¡«å†™', duration: 2000 });
      return;
    }

    const itemData: Item = {
      id: this.editingItemId !== -1 ? this.editingItemId : Date.now(),
      name: this.itemName.trim(),
      category: this.itemCategory || "å…¶ä»–",
      buyDate: this.dateStr,
      price: Number(this.itemPrice),
      location: this.itemLocation.trim(),
      note: this.itemNote.trim(),
      useStatus: this.itemUseStatus,
      isLent: false,
      lendTo: "",
      returnDate: "",
      isPrecious: false,
      maintenanceDate: "",
      imagePath: this.itemImagePath
    };

    try {
      if (this.editingItemId !== -1) {
        await ItemRdb.update(itemData);
        await itemStore.updateItemCount();
        promptAction.showToast({ message: 'ç‰©å“ä¿®æ”¹æˆåŠŸï¼', duration: 2000 });
      } else {
        await ItemRdb.insert(itemData);
        await itemStore.updateItemCount();
        promptAction.showToast({ message: 'ç‰©å“æ·»åŠ æˆåŠŸï¼', duration: 2000 });
      }

      this.itemList = [];
      setTimeout(async () => {
        await this.refreshItemList();
        this.itemList = [...this.itemList];
      }, 100);

      this.resetForm();
    } catch (err) {
      console.error("æ“ä½œå¤±è´¥:", err);
      promptAction.showToast({
        message: this.editingItemId !== -1 ? 'ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•' : 'æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  private resetForm(): void {
    this.itemName = "";
    this.itemCategory = "";
    this.itemPrice = "";
    this.itemLocation = "";
    this.itemNote = "";
    this.itemUseStatus = "åœ¨ç”¨";
    this.selectedDate = new Date();
    this.dateStr = this.formatDate(this.selectedDate);
    this.nameError = "";
    this.priceError = "";
    this.itemImagePath = "";
    this.editingItemId = -1;
  }

  private async deleteItem(id: number): Promise<void> {
    AlertDialog.show({
      title: 'ç¡®è®¤åˆ é™¤',
      message: 'ç¡®å®šè¦åˆ é™¤è¯¥ç‰©å“è®°å½•å—ï¼Ÿ',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'åˆ é™¤',
        fontColor: Color.Red,
        action: async () => {
          try {
            await ItemRdb.delete(id);
            await itemStore.updateItemCount();
            this.itemList = this.itemList.filter(item => item.id !== id);
            setTimeout(async () => {
              await this.refreshItemList();
            }, 100);
            promptAction.showToast({ message: 'å·²åˆ é™¤', duration: 2000 });
          } catch (err) {
            console.error("åˆ é™¤ç‰©å“å¤±è´¥:", err);
            promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', duration: 2000 });
          }
        }
      }
    });
  }

  private dataClearedCallback = (): void => {
    console.info('æ¥æ”¶åˆ°æ•°æ®æ¸…ç©ºäº‹ä»¶ï¼Œåˆ·æ–°åˆ—è¡¨');
    this.refreshItemList();
  };

  private itemCountChangedCallback = (count: number): void => {
    console.info(`ç‰©å“æ•°é‡å˜åŒ–: ${count}ä¸ªï¼Œåˆ·æ–°åˆ—è¡¨`);
    this.refreshItemList();
  };

  @Builder itemEnd(item: Item) {
    Row() {
      Button("ç¼–è¾‘")
        .type(ButtonType.Normal)
        .width(80)
        .height("100%")
        .backgroundColor("#4A6CF7")
        .fontColor(Color.White)
        .onClick(() => {
          this.startEdit(item);
        })
      Button("åˆ é™¤")
        .type(ButtonType.Normal)
        .width(80)
        .height("100%")
        .backgroundColor(Color.Red)
        .fontColor(Color.White)
        .onClick(() => {
          this.deleteItem(item.id);
        })
    }
    .padding({ left: 12 })
    .justifyContent(FlexAlign.End)
  }

  private getFilteredItems(): Item[] {
    const keyword = this.searchText.trim().toLowerCase();
    if (!keyword) {
      return this.itemList;
    }

    const filteredItems: Item[] = [];
    for (let i = 0; i < this.itemList.length; i++) {
      const item = this.itemList[i];
      if (item.name.toLowerCase().includes(keyword) ||
      item.category.toLowerCase().includes(keyword) ||
      item.location.toLowerCase().includes(keyword) ||
      item.note.toLowerCase().includes(keyword) ||
      item.useStatus.toLowerCase().includes(keyword)) {
        filteredItems.push(item);
      }
    }
    return filteredItems;
  }

  private getStatusColor(status: ItemUseStatus): string {
    switch (status) {
      case 'åœ¨ç”¨': return "#34C759";
      case 'é—²ç½®': return "#FF9500";
      case 'å·²ä¸¢å¼ƒ': return "#8E8E93";
      default: return "#333333";
    }
  }

  @Builder TabBuilder(title: string, index: number, icon: string) {
    Column() {
      Text(icon)
        .fontSize(22)
        .margin({ bottom: 4 })
        .opacity(this.currentTab === index ? 1 : 0.5)
        .animation({ duration: 300 })
      Text(title)
        .fontSize(10)
        .fontColor(this.currentTab === index ? "#4A6CF7" : "#999999")
        .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Normal)
        .animation({ duration: 300 })
    }
    .justifyContent(FlexAlign.Center)
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }

  private getCategoryColor(category: string): string {
    const colors: Record<string, string> = {
      "æ•°ç äº§å“": "#007AFF",
      "è¡£ç‰©": "#FF9500",
      "ä¹¦ç±": "#5856D6",
      "å¨å…·": "#5AC8FA",
      "å®¶å…·": "#FFCC00",
      "ç¾å¦†": "#FF2D55",
      "é£Ÿå“": "#34C759",
      "å…¶ä»–": "#8E8E93"
    };
    return colors[category] || "#4A6CF7";
  }

  private getStatusBgColor(status: ItemUseStatus): string {
    switch (status) {
      case 'åœ¨ç”¨': return "#E6F4EA";
      case 'é—²ç½®': return "#FFF0E0";
      case 'å·²ä¸¢å¼ƒ': return "#F2F2F7";
      default: return "#F5F5F5";
    }
  }

  build() {
    Column() {
      Row() {
        Text(this.editingItemId !== -1 ? "ç¼–è¾‘ç‰©å“" : "è½»ç‰©å¿—")
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
      }
      .width("100%")
      .height(44)
      .linearGradient({
        angle: 90,
        colors: [[0x4A6CF7, 0.0], [0x4E54C8, 1.0]]
      })
      .padding({ left: 16, right: 16 })
      .alignItems(VerticalAlign.Center)
      .justifyContent(FlexAlign.Center)

      Tabs({ index: this.currentTab, barPosition: BarPosition.End }) {
        TabContent() {
          Scroll() {
            Column() {
              FormCard({ title: "ç‰©å“åç§° *" }) {
                Column() {
                  TextInput({ placeholder: "è¯·è¾“å…¥ç‰©å“åç§°", text: this.itemName })
                    .fontSize(16)
                    .width("100%")
                    .height(48)
                    .backgroundColor(Color.Transparent)
                    .onChange((value: string) => {
                      this.itemName = value;
                      this.validateForm();
                    })

                  if (this.nameError) {
                    Text(this.nameError)
                      .fontSize(12)
                      .fontColor("#F53F3F")
                      .margin({ top: 4 })
                  }
                }
              }

              FormCard({ title: "ç‰©å“åˆ†ç±»" }) {
                Select(this.getCategoryOptions())
                  .value(this.itemCategory || "è¯·é€‰æ‹©åˆ†ç±»")
                  .font({ size: 16 })
                  .fontColor(this.itemCategory ? "#333333" : "#999999")
                  .selectedOptionFont({ size: 16 })
                  .optionFont({ size: 16 })
                  .width("100%")
                  .height(48)
                  .onSelect((index: number, value: string) => {
                    this.itemCategory = value;
                  })
              }

              FormCard({ title: "è´­ä¹°æ—¥æœŸ" }) {
                Row() {
                  Text(this.dateStr)
                    .fontSize(16)
                    .fontColor("#333333")
                  Blank()
                  Text("ğŸ“…")
                    .fontSize(20)
                }
                .width("100%")
                .height(40)
                .alignItems(VerticalAlign.Center)
                .onClick(() => {
                  this.showDatePicker();
                })
              }

              FormCard({ title: "ä»·æ ¼ï¼ˆå…ƒï¼‰*" }) {
                Column() {
                  TextInput({ placeholder: "0.00", text: this.itemPrice })
                    .fontSize(16)
                    .fontColor("#333333")
                    .width("100%")
                    .height(48)
                    .backgroundColor(Color.Transparent)
                    .type(InputType.Number)
                    .onChange((value: string) => {
                      const filtered = value.replace(/[^0-9.]/g, '');
                      const parts = filtered.split('.');
                      if (parts.length > 2) {
                        this.itemPrice = parts[0] + '.' + parts.slice(1).join('');
                      } else {
                        this.itemPrice = filtered;
                      }
                      this.validateForm();
                    })

                  if (this.priceError) {
                    Text(this.priceError)
                      .fontSize(12)
                      .fontColor("#F53F3F")
                      .margin({ top: 4 })
                  }
                }
              }

              FormCard({ title: "å­˜æ”¾ä½ç½®" }) {
                TextInput({ placeholder: "ä¾‹å¦‚ï¼šè¡£æŸœç¬¬ä¸€å±‚", text: this.itemLocation })
                  .fontSize(16)
                  .fontColor("#333333")
                  .width("100%")
                  .height(48)
                  .backgroundColor(Color.Transparent)
                  .onChange((value: string) => {
                    this.itemLocation = value;
                  })
              }

              FormCard({ title: "ä½¿ç”¨çŠ¶æ€" }) {
                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.itemUseStatusOptions, (status: ItemUseStatus) => {
                    Row() {
                      Radio({ value: status, group: "itemUseStatus" })
                        .checked(this.itemUseStatus === status)
                        .onChange((isChecked: boolean) => {
                          if (isChecked) {
                            this.itemUseStatus = status;
                          }
                        })
                      Text(status)
                        .fontSize(14)
                        .fontColor("#333333")
                        .onClick(() => {
                          this.itemUseStatus = status;
                        })
                    }
                    .margin({ right: 16, bottom: 8 })
                  })
                }
              }

              FormCard({ title: "ç‰©å“å›¾ç‰‡" }) {
                Column() {
                  if (this.itemImagePath) {
                    Stack() {
                      Image(this.itemImagePath)
                        .width("100%")
                        .height(200)
                        .objectFit(ImageFit.Cover)
                        .borderRadius(8)

                      Button("ğŸ—‘ï¸")
                        .width(32)
                        .height(32)
                        .borderRadius(16)
                        .backgroundColor(Color.Red)
                        .fontColor(Color.White)
                        .position({ right: 8, top: 8 })
                        .onClick(() => this.removeItemImage())
                    }
                  } else {
                    Column() {
                      Text("ğŸ“·")
                        .fontSize(40)
                        .margin({ bottom: 8 })
                      Text("ç‚¹å‡»ä¸Šä¼ ç‰©å“å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰")
                        .fontSize(14)
                        .fontColor("#999999")
                    }
                    .width("100%")
                    .height(200)
                    .backgroundColor("#F5F7FA")
                    .borderRadius(8)
                    .justifyContent(FlexAlign.Center)
                    .alignItems(HorizontalAlign.Center)
                    .onClick(() => this.selectItemImage())
                  }
                }
              }

              FormCard({ title: "å¤‡æ³¨" }) {
                TextArea({ placeholder: "å†™ç‚¹ä»€ä¹ˆ...", text: this.itemNote })
                  .fontSize(14)
                  .width("100%")
                  .height(80)
                  .backgroundColor("#F5F7FA")
                  .borderRadius(8)
                  .onChange((value: string) => {
                    this.itemNote = value;
                  })
              }

              Button(this.editingItemId !== -1 ? "ä¿å­˜ä¿®æ”¹" : "æ·»åŠ ç‰©å“")
                .width("100%")
                .height(50)
                .linearGradient({
                  angle: 90,
                  colors: [[0x4A6CF7, 0.0], [0x4E54C8, 1.0]]
                })
                .fontColor(Color.White)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .borderRadius(25)
                .shadow({ radius: 8, color: "#4D4A6CF7", offsetY: 4 })
                .onClick(async () => await this.addItem())
                .margin({
                  top: 16,
                  bottom: this.editingItemId !== -1 ? 16 : 32
                })

              if (this.editingItemId !== -1) {
                Button("å–æ¶ˆä¿®æ”¹")
                  .width("100%")
                  .height(50)
                  .backgroundColor("#F0F2F5")
                  .fontColor("#666666")
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .borderRadius(25)
                  .onClick(() => {
                    this.resetForm();
                  })
                  .margin({ bottom: 32 })
              }
            }
            .padding(16)
          }
          .width("100%")
          .height("100%")
          .backgroundColor("#F9FAFB")
        }
        .tabBar(this.TabBuilder("æ·»åŠ ", 0, "â•"))

        TabContent() {
          Column() {
            Row() {
              Search({ value: this.searchText, placeholder: 'æœç´¢ç‰©å“åç§°ã€åˆ†ç±»ã€ä½ç½®' })
                .layoutWeight(1)
                .height(40)
                .backgroundColor(Color.White)
                .placeholderColor('#999999')
                .placeholderFont({ size: 14 })
                .textFont({ size: 14 })
                .onChange((value: string) => {
                  this.searchText = value;
                })
            }
            .width("100%")
            .padding({ left: 16, right: 16, top: 12, bottom: 8 })

            if (this.getFilteredItems().length === 0) {
              Column() {
                Text("ğŸ“¦")
                  .fontSize(60)
                  .margin({ bottom: 16 })
                Text("è¿˜æ²¡æœ‰æ·»åŠ ç‰©å“å“¦ï¼Œå¿«å»æ·»åŠ å§")
                  .fontSize(14)
                  .fontColor("#999999")
              }
              .width("100%")
              .height("60%")
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            } else {
              List({ space: 0 }) {
                ForEach(this.getFilteredItems(), (item: Item) => {
                  ListItem() {
                    Row() {
                      Column() {
                          Stack() {
                            Text(item.category.substring(0, 1))
                              .fontSize(18)
                              .fontWeight(FontWeight.Bold)
                              .fontColor(Color.White)

                        }
                      }
                      .width(40)
                      .height(40)
                      .borderRadius(20)
                      .backgroundColor(this.getCategoryColor(item.category))
                      .justifyContent(FlexAlign.Center)
                      .alignItems(HorizontalAlign.Center)
                      .margin({ right: 12 })

                      Column({ space: 4 }) {
                        Row({ space: 8 }) {
                          Text(item.name)
                            .fontSize(16)
                            .fontWeight(FontWeight.Medium)
                            .fontColor("#333333")
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .layoutWeight(1)

                          Text(item.useStatus)
                            .fontSize(10)
                            .fontColor(this.getStatusColor(item.useStatus))
                            .backgroundColor(this.getStatusBgColor(item.useStatus))
                            .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                            .borderRadius(4)
                            .flexShrink(0)
                        }
                        .width("100%")

                        Text(`${item.buyDate} Â· Â¥${item.price.toFixed(2)}`)
                          .fontSize(12)
                          .fontColor("#999999")
                          .width("100%")
                          .maxLines(1)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })

                        if (item.location) {
                          Text(`ä½ç½®ï¼š${item.location}`)
                            .fontSize(12)
                            .fontColor("#666666")
                            .width("100%")
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                        }

                        if (item.note) {
                          Text(item.note)
                            .fontSize(12)
                            .fontColor("#666666")
                            .width("100%")
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .margin({ top: 4 })
                        }
                      }
                      .layoutWeight(1)
                    }
                    .width("100%")
                    .padding(16)
                    .backgroundColor(Color.White)
                    .borderRadius(12)
                    .shadow({ radius: 4, color: "#0D000000", offsetY: 2 })
                    .onClick(() => this.previewImage(item))
                  }
                  .swipeAction({ end: this.itemEnd(item) })
                  .margin({ bottom: 12 })
                }, (item: Item) => item.id.toString())
              }
              .width("100%")
              .layoutWeight(1)
              .padding({ left: 16, right: 16, bottom: 16 })
              .scrollBar(BarState.Auto)
            }
          }
          .width("100%")
          .height("100%")
          .backgroundColor("#F9FAFB")
        }
        .tabBar(this.TabBuilder("ç‰©å“åˆ—è¡¨", 1, "ğŸ“‹"))

        TabContent() {
          StatisticsPage({ itemList: this.itemList })
        }
        .tabBar(this.TabBuilder("ç»Ÿè®¡", 2, "ğŸ“Š"))

        TabContent() {
          MinePage()
        }
        .tabBar(this.TabBuilder("æˆ‘çš„", 3, "ğŸ‘¤"))
      }

      .barWidth("100%")
      .barHeight(60)
      .backgroundColor(Color.White)
      .layoutWeight(1)
      .onChange((index: number) => {
        this.currentTab = index;
      })


      if (this.showImagePreview) {
        Stack({ alignContent: Alignment.Center }) {
          // èƒŒæ™¯é®ç½©
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.85)')
            .zIndex(1);

          // å…³é—­æŒ‰é’®ï¼ˆæœ€é«˜å±‚çº§ - ä¼˜åŒ–å®šä½ï¼‰
          Button('X')
            .width(60)
            .height(40)
            .borderRadius(20)
            .backgroundColor(Color.Red)
            .fontColor(Color.White)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .zIndex(3)
            // å…³é”®ä¿®æ”¹ï¼šæ”¹ç”¨ right/top å›ºå®šå†…è¾¹è·ï¼Œè€Œéç™¾åˆ†æ¯”x
            .position({ right: 16, top: 24 })
            .onClick(() => {
              console.log('å…³é—­æŒ‰é’®ç‚¹å‡»ï¼Œæ›´æ–°çŠ¶æ€');
              this.showImagePreview = false;
              this.previewImagePath = '';
              this.imageScale = 1;
              this.imageOffsetX = 0;
              this.imageOffsetY = 0;
            });

          // å›¾ç‰‡é¢„è§ˆ
          Image(this.previewImagePath)
            .width('90%')
            .height('70%')
            .objectFit(ImageFit.Contain)
            .borderRadius(8)
            .scale({ x: this.imageScale, y: this.imageScale })
            .translate({ x: this.imageOffsetX, y: this.imageOffsetY })
            .zIndex(2)
            .gesture(
              PinchGesture()
                .onActionUpdate((event: GestureEvent) => {
                  if (event.scale) {
                    this.imageScale = Math.max(0.5, Math.min(3, this.imageScale * event.scale));
                  }
                })
            )
            .gesture(
              PanGesture()
                .onActionUpdate((event: GestureEvent) => {
                  if (event.offsetX && event.offsetY) {
                    this.imageOffsetX += event.offsetX;
                    this.imageOffsetY += event.offsetY;
                  }
                })
            );
        }
        .width('100%')
        .height('100%')
        .position({ left: 0, top: 0 })
        .zIndex(999);
      }
    }
    .width("100%")
    .height("100%")
    .backgroundColor("#F9FAFB")
  }
}