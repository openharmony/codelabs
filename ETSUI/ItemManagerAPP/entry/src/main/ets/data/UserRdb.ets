/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import relationalStore from '@ohos.data.relationalStore';
import common from '@ohos.app.ability.common';
import { UserInfo } from '../model/types'; // å¯¼å…¥ä½ å®šä¹‰çš„ UserInfo ç±»å‹

// æ•°æ®åº“é”™è¯¯ç±»å‹å®šä¹‰ï¼ˆå’Œ ItemRdb å®Œå…¨ä¸€è‡´ï¼‰
interface RdbError {
  code: number;
  message: string;
}

class UserInfoRdb {
  private rdbStore: relationalStore.RdbStore | null = null;
  private tableName: string = 'USER_INFO_TABLE'; // ç”¨æˆ·ä¿¡æ¯è¡¨
  private isMock: boolean = false; // é¢„è§ˆå™¨å…¼å®¹æ¨¡å¼
  private mockData: UserInfo = { // é¢„è§ˆå™¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆå•ç”¨æˆ·ï¼‰
    avatar: 'ğŸ‘¤',
    nickname: 'è½»ç‰©å¿—ç”¨æˆ·',
    joinDate: '2026å¹´1æœˆ'
  };

  // å½»åº•åˆ é™¤ id å­—æ®µ
  private sqlCreate: string = `CREATE TABLE IF NOT EXISTS USER_INFO_TABLE (
    avatar TEXT DEFAULT 'ğŸ‘¤',
    nickname TEXT DEFAULT 'è½»ç‰©å¿—ç”¨æˆ·',
    joinDate TEXT NOT NULL
  )`;

  private static instance: UserInfoRdb;
  // æ–°å¢ï¼šä¿å­˜ä¸Šä¸‹æ–‡ï¼Œé¿å…é‡å¤ä¼ é€’
  private context: common.UIAbilityContext | null = null;

  // å•ä¾‹æ¨¡å¼ï¼ˆä¿ç•™ï¼‰
  static getInstance(): UserInfoRdb {
    if (!UserInfoRdb.instance) {
      UserInfoRdb.instance = new UserInfoRdb();
    }
    return UserInfoRdb.instance;
  }

  private constructor() {}

  // æ ¸å¿ƒä¿®å¤ï¼šåˆå§‹åŒ–æ•°æ®åº“ï¼ˆä¿å­˜ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿åªåˆå§‹åŒ–ä¸€æ¬¡ï¼‰
  async getRdbStore(context: common.UIAbilityContext): Promise<relationalStore.RdbStore | null> {
    // ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œåç»­æ“ä½œæ— éœ€é‡å¤ä¼ é€’
    this.context = context;
    if (this.rdbStore) {
      return this.rdbStore;
    }

    const STORE_CONFIG: relationalStore.StoreConfig = {
      name: 'ItemManager.db', // å’Œç‰©å“æ•°æ®åº“å…±ç”¨
      securityLevel: relationalStore.SecurityLevel.S1
    };

    try {
      return new Promise((resolve, reject) => {
        relationalStore.getRdbStore(context, STORE_CONFIG, (err: RdbError | null, store: relationalStore.RdbStore) => {
          if (err) {
            console.warn(`è·å–ç”¨æˆ·ä¿¡æ¯æ•°æ®åº“å¤±è´¥: Code=${err.code}, Msg=${err.message}`);
            console.warn('åˆ‡æ¢åˆ°é¢„è§ˆå™¨æ¨¡æ‹Ÿæ¨¡å¼');
            this.isMock = true;
            resolve(null);
            return;
          }

          // åˆ›å»ºç”¨æˆ·ä¿¡æ¯è¡¨ï¼ˆæ—  id å­—æ®µï¼‰
          store.executeSql(this.sqlCreate).then(() => {
            console.info('ç”¨æˆ·ä¿¡æ¯æ•°æ®è¡¨åˆ›å»ºæˆåŠŸ');
            this.rdbStore = store;
            // åˆå§‹åŒ–é»˜è®¤æ•°æ®ï¼ˆæ—  idï¼‰
            this.initDefaultUserInfo().then(() => {
              resolve(store);
            });
          }).catch((sqlErr: Error) => {
            console.error(`åˆ›å»ºç”¨æˆ·ä¿¡æ¯æ•°æ®è¡¨å¤±è´¥: ${sqlErr.message}`);
            this.isMock = true;
            resolve(store);
          });
        });
      });
    } catch (e) {
      console.warn('ç”¨æˆ·ä¿¡æ¯æ•°æ®åº“APIå¼‚å¸¸ï¼ˆé¢„è§ˆå™¨ç¯å¢ƒï¼‰ï¼Œåˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼');
      this.isMock = true;
      return null;
    }
  }

  // åˆå§‹åŒ–é»˜è®¤ç”¨æˆ·ä¿¡æ¯ï¼ˆå½»åº•ç§»é™¤ id é€»è¾‘ï¼‰
  private async initDefaultUserInfo(): Promise<void> {
    if (this.isMock || !this.rdbStore) {
      return;
    }

    // æŸ¥è¯¢è¡¨ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼ˆæ—  id æ¡ä»¶ï¼‰
    const predicates = new relationalStore.RdbPredicates(this.tableName);
    const resultSet = await this.rdbStore.query(predicates);

    if (resultSet.rowCount === 0) {
      // æ’å…¥é»˜è®¤å€¼ï¼ˆæ—  id å­—æ®µï¼‰
      const defaultInfo: UserInfo = {
        avatar: 'ğŸ‘¤',
        nickname: 'è½»ç‰©å¿—ç”¨æˆ·',
        joinDate: new Date().getFullYear() + 'å¹´' + (new Date().getMonth() + 1) + 'æœˆ'
      };
      const valueBucket: relationalStore.ValuesBucket = {
        avatar: defaultInfo.avatar,
        nickname: defaultInfo.nickname,
        joinDate: defaultInfo.joinDate
      };
      await this.rdbStore.insert(this.tableName, valueBucket);
      console.info('é»˜è®¤ç”¨æˆ·ä¿¡æ¯åˆå§‹åŒ–æˆåŠŸï¼ˆæ—  idï¼‰');
    }
    resultSet.close();
  }

  // æ£€æŸ¥æ•°æ®åº“æ˜¯å¦åˆå§‹åŒ–ï¼ˆä¿ç•™ï¼‰
  isInitialized(): boolean {
    return this.rdbStore !== null || this.isMock;
  }

  // ========== æ ¸å¿ƒä¿®å¤ï¼šæŸ¥è¯¢å‰å…ˆåˆå§‹åŒ–æ•°æ®åº“ ==========
  async queryUserInfo(): Promise<UserInfo> {
    // å…³é”®ï¼šå¦‚æœæœªåˆå§‹åŒ–ä¸”æœ‰ä¸Šä¸‹æ–‡ï¼Œå…ˆåˆå§‹åŒ–æ•°æ®åº“
    if (!this.rdbStore && !this.isMock && this.context) {
      await this.getRdbStore(this.context);
    }

    if (this.isMock) {
      // é¢„è§ˆå™¨æ¨¡å¼ï¼šè¿”å›æ¨¡æ‹Ÿæ•°æ®
      return {
        avatar: this.mockData.avatar,
        nickname: this.mockData.nickname,
        joinDate: this.mockData.joinDate
      };
    }

    if (!this.rdbStore) {
      throw new Error('ç”¨æˆ·ä¿¡æ¯æ•°æ®åº“æœªåˆå§‹åŒ–ï¼ˆæ— æœ‰æ•ˆä¸Šä¸‹æ–‡ï¼‰');
    }

    // æ—  id æ¡ä»¶ï¼Œç›´æ¥æŸ¥è¯¢æ•´å¼ è¡¨
    const predicates = new relationalStore.RdbPredicates(this.tableName);
    const resultSet = await this.rdbStore.query(predicates);

    let userInfo: UserInfo = {
      avatar: 'ğŸ‘¤',
      nickname: 'è½»ç‰©å¿—ç”¨æˆ·',
      joinDate: '2026å¹´1æœˆ'
    };

    // è¯»å–ç¬¬ä¸€æ¡æ•°æ®ï¼ˆå•ç”¨æˆ·ä»…ä¸€æ¡ï¼‰
    if (resultSet.rowCount > 0) {
      resultSet.goToFirstRow();
      userInfo = {
        avatar: resultSet.getString(resultSet.getColumnIndex('avatar')) || 'ğŸ‘¤',
        nickname: resultSet.getString(resultSet.getColumnIndex('nickname')) || 'è½»ç‰©å¿—ç”¨æˆ·',
        joinDate: resultSet.getString(resultSet.getColumnIndex('joinDate')) || '2026å¹´1æœˆ'
      };
    }

    resultSet.close();
    return userInfo;
  }

  // ========== æ ¸å¿ƒä¿®å¤ï¼šæ›´æ–°å¤´åƒå‰å…ˆåˆå§‹åŒ–æ•°æ®åº“ ==========
  async updateAvatar(avatar: string): Promise<number> {
    // å…³é”®ï¼šå¦‚æœæœªåˆå§‹åŒ–ä¸”æœ‰ä¸Šä¸‹æ–‡ï¼Œå…ˆåˆå§‹åŒ–æ•°æ®åº“
    if (!this.rdbStore && !this.isMock && this.context) {
      await this.getRdbStore(this.context);
    }

    if (this.isMock) {
      this.mockData.avatar = avatar;
      return 1; // æ›´æ–°æˆåŠŸè¿”å›1
    }

    if (!this.rdbStore) {
      throw new Error('ç”¨æˆ·ä¿¡æ¯æ•°æ®åº“æœªåˆå§‹åŒ–ï¼ˆæ— æœ‰æ•ˆä¸Šä¸‹æ–‡ï¼‰');
    }

    const valueBucket: relationalStore.ValuesBucket = {
      avatar: avatar
    };

    // æ—  id æ¡ä»¶ï¼Œç›´æ¥æ›´æ–°æ•´å¼ è¡¨ï¼ˆä»…ä¸€æ¡æ•°æ®ï¼‰
    const predicates = new relationalStore.RdbPredicates(this.tableName);
    return this.rdbStore.update(valueBucket, predicates);
  }

  // ========== æ ¸å¿ƒä¿®å¤ï¼šæ›´æ–°æ˜µç§°å‰å…ˆåˆå§‹åŒ–æ•°æ®åº“ ==========
  async updateNickname(nickname: string): Promise<number> {
    if (nickname.trim() === '') {
      throw new Error('æ˜µç§°ä¸èƒ½ä¸ºç©º');
    }
    if (nickname.length > 12) {
      throw new Error('æ˜µç§°ä¸èƒ½è¶…è¿‡12ä¸ªå­—ç¬¦');
    }

    // å…³é”®ï¼šå¦‚æœæœªåˆå§‹åŒ–ä¸”æœ‰ä¸Šä¸‹æ–‡ï¼Œå…ˆåˆå§‹åŒ–æ•°æ®åº“
    if (!this.rdbStore && !this.isMock && this.context) {
      await this.getRdbStore(this.context);
    }

    if (this.isMock) {
      this.mockData.nickname = nickname.trim();
      return 1;
    }

    if (!this.rdbStore) {
      throw new Error('ç”¨æˆ·ä¿¡æ¯æ•°æ®åº“æœªåˆå§‹åŒ–ï¼ˆæ— æœ‰æ•ˆä¸Šä¸‹æ–‡ï¼‰');
    }

    const valueBucket: relationalStore.ValuesBucket = {
      nickname: nickname.trim()
    };

    // æ—  id æ¡ä»¶ï¼Œç›´æ¥æ›´æ–°
    const predicates = new relationalStore.RdbPredicates(this.tableName);
    return this.rdbStore.update(valueBucket, predicates);
  }

  // ========== æ‰©å±•æ–¹æ³•ï¼šæ›´æ–°å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼ˆç§»é™¤ idï¼‰ ==========
  async updateUserInfo(userInfo: UserInfo): Promise<number> {
    // å…³é”®ï¼šå¦‚æœæœªåˆå§‹åŒ–ä¸”æœ‰ä¸Šä¸‹æ–‡ï¼Œå…ˆåˆå§‹åŒ–æ•°æ®åº“
    if (!this.rdbStore && !this.isMock && this.context) {
      await this.getRdbStore(this.context);
    }

    if (this.isMock) {
      this.mockData = {
        avatar: userInfo.avatar,
        nickname: userInfo.nickname,
        joinDate: userInfo.joinDate
      };
      return 1;
    }

    if (!this.rdbStore) {
      throw new Error('ç”¨æˆ·ä¿¡æ¯æ•°æ®åº“æœªåˆå§‹åŒ–ï¼ˆæ— æœ‰æ•ˆä¸Šä¸‹æ–‡ï¼‰');
    }

    const valueBucket: relationalStore.ValuesBucket = {
      avatar: userInfo.avatar,
      nickname: userInfo.nickname.trim(),
      joinDate: userInfo.joinDate
    };

    const predicates = new relationalStore.RdbPredicates(this.tableName);
    return this.rdbStore.update(valueBucket, predicates);
  }

  // ========== æ¸…ç©ºç”¨æˆ·ä¿¡æ¯ï¼ˆç§»é™¤ id æ¡ä»¶ï¼‰ ==========
  async clearAll(): Promise<void> {
    // å…³é”®ï¼šå¦‚æœæœªåˆå§‹åŒ–ä¸”æœ‰ä¸Šä¸‹æ–‡ï¼Œå…ˆåˆå§‹åŒ–æ•°æ®åº“
    if (!this.rdbStore && !this.isMock && this.context) {
      await this.getRdbStore(this.context);
    }

    if (this.isMock) {
      this.mockData = {
        avatar: 'ğŸ‘¤',
        nickname: 'è½»ç‰©å¿—ç”¨æˆ·',
        joinDate: '2026å¹´1æœˆ'
      };
      return;
    }

    if (!this.rdbStore) {
      throw new Error('ç”¨æˆ·ä¿¡æ¯æ•°æ®åº“æœªåˆå§‹åŒ–ï¼ˆæ— æœ‰æ•ˆä¸Šä¸‹æ–‡ï¼‰');
    }

    // æ—  id æ¡ä»¶ï¼Œæ¸…ç©ºæ•´å¼ è¡¨
    const predicates = new relationalStore.RdbPredicates(this.tableName);
    await this.rdbStore.delete(predicates);
    // é‡æ–°æ’å…¥é»˜è®¤å€¼
    await this.initDefaultUserInfo();
  }
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹ï¼ˆå”¯ä¸€é»˜è®¤å¯¼å‡ºï¼Œæ— é‡å¤ï¼‰
export default UserInfoRdb.getInstance();