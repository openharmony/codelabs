/**
 * æ ‡ç­¾ç®¡ç†é¡µé¢
 */
import { LifeHubData, Tag } from '../../model/LifeHubData';

interface TagWithCount extends Tag {
  count: number;
}

interface ColorOption {
  value: string;
}

interface CategoryOption {
  value: 'all' | 'health' | 'goal' | 'mood' | 'learning' | 'diary';
  label: string;
}

@Entry
@Component
export struct TagsMain {
  private lifeHubData: LifeHubData = new LifeHubData();
  
  @State tags: TagWithCount[] = [];
  @State isLoading: boolean = true;
  @State showAddDialog: boolean = false;
  @State newTagName: string = '';
  @State newTagColor: string = '#007DFF';
  @State newTagCategory: string = 'all';

  private colors: ColorOption[] = [
    { value: '#007DFF' }, { value: '#4CAF50' }, { value: '#FF9800' }, { value: '#E91E63' }, 
    { value: '#9C27B0' }, { value: '#00BCD4' }, { value: '#FF5722' }, { value: '#795548' }
  ];

  private categories: CategoryOption[] = [
    { value: 'all', label: 'å…¨éƒ¨' },
    { value: 'health', label: 'å¥åº·' },
    { value: 'goal', label: 'ç›®æ ‡' },
    { value: 'mood', label: 'å¿ƒæƒ…' },
    { value: 'learning', label: 'å­¦ä¹ ' },
    { value: 'diary', label: 'æ—¥è®°' }
  ];

  aboutToAppear() {
    const context = getContext(this);
    if (context) {
      this.lifeHubData.setContext(context);
    }
    this.loadTags();
  }

  async loadTags() {
    this.isLoading = true;
    try {
      const allTags = await this.lifeHubData.getAllTags();
      // ç»Ÿè®¡æ¯ä¸ªæ ‡ç­¾çš„ä½¿ç”¨æ¬¡æ•°
      const tagsWithCount = await this.updateTagCounts(allTags);
      this.tags = tagsWithCount;
    } catch (error) {
      console.error('TagsMain: åŠ è½½æ ‡ç­¾å¤±è´¥:', error);
      this.tags = [];
    } finally {
      this.isLoading = false;
    }
  }

  async updateTagCounts(tags: Tag[]): Promise<TagWithCount[]> {
    try {
      const healthRecords = await this.lifeHubData.getHealthRecords(undefined, 10000);
      const goals = await this.lifeHubData.getAllGoals();
      const moodRecords = await this.lifeHubData.getMoodRecords(10000);
      const diaries = await this.lifeHubData.getAllDiaries();

      const tagsWithCount: TagWithCount[] = [];
      // ç»Ÿè®¡æ ‡ç­¾ä½¿ç”¨æ¬¡æ•°
      for (let i = 0; i < tags.length; i++) {
        const tag = tags[i];
        let count = 0;
        
        if (tag.category === 'all' || tag.category === 'health') {
          for (let j = 0; j < healthRecords.length; j++) {
            const r = healthRecords[j];
            if (r.note && r.note.includes(`#${tag.name}`)) {
              count++;
            }
          }
        }
        
        if (tag.category === 'all' || tag.category === 'goal') {
          for (let j = 0; j < goals.length; j++) {
            const g = goals[j];
            if (g.description && g.description.includes(`#${tag.name}`)) {
              count++;
            }
          }
        }
        
        if (tag.category === 'all' || tag.category === 'mood') {
          for (let j = 0; j < moodRecords.length; j++) {
            const m = moodRecords[j];
            if (m.tags && m.tags.includes(tag.name)) {
              count++;
            }
          }
        }
        
        if (tag.category === 'all' || tag.category === 'diary') {
          for (let j = 0; j < diaries.length; j++) {
            const d = diaries[j];
            if (d.tags && d.tags.includes(tag.name)) {
              count++;
            }
          }
        }
        
        const tagWithCount: TagWithCount = {
          id: tag.id,
          name: tag.name,
          color: tag.color,
          category: tag.category,
          createTime: tag.createTime,
          count: count
        };
        tagsWithCount.push(tagWithCount);
      }
      return tagsWithCount;
    } catch (error) {
      console.error('TagsMain: æ›´æ–°æ ‡ç­¾ç»Ÿè®¡å¤±è´¥:', error);
      const defaultTags: TagWithCount[] = [];
      for (let i = 0; i < tags.length; i++) {
        const tag = tags[i];
        defaultTags.push({
          id: tag.id,
          name: tag.name,
          color: tag.color,
          category: tag.category,
          createTime: tag.createTime,
          count: 0
        });
      }
      return defaultTags;
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('æ ‡ç­¾ç®¡ç†')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Button('+')
          .fontSize(20)
          .width(40)
          .height(40)
          .borderRadius(20)
          .backgroundColor('#007DFF')
          .fontColor(Color.White)
          .onClick(() => {
            this.showAddDialog = true;
          })
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#f0f0f0')

      // æ ‡ç­¾åˆ—è¡¨
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .margin({ top: 100 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.tags.length === 0) {
        Column() {
          Text('ğŸ·ï¸')
            .fontSize(60)
            .margin({ bottom: 20 })
          Text('è¿˜æ²¡æœ‰æ ‡ç­¾')
            .fontSize(18)
            .fontColor('#666')
          Text('ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ æ ‡ç­¾')
            .fontSize(14)
            .fontColor('#999')
            .margin({ top: 10 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column() {
            ForEach(this.tags, (tag: TagWithCount) => {
              this.buildTagCard(tag)
            })
          }
          .width('100%')
          .padding(15)
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildTagCard(tag: TagWithCount) {
    Row() {
      Row() {
        Text('#')
          .fontSize(16)
          .fontColor(tag.color)
        Text(tag.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333')
      }
      .layoutWeight(1)
      .alignItems(VerticalAlign.Top)

      Row() {
        Text(this.getCategoryLabel(tag.category))
          .fontSize(12)
          .fontColor('#666')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .backgroundColor('#f0f0f0')
          .borderRadius(10)
          .margin({ right: 10 })

        Text(`${tag.count}æ¬¡`)
          .fontSize(14)
          .fontColor('#666')
      }

      Button('åˆ é™¤')
        .fontSize(14)
        .height(32)
        .backgroundColor('#FF5722')
        .fontColor(Color.White)
        .margin({ left: 10 })
        .onClick(() => {
          this.deleteTag(tag);
        })
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .border({
      width: 2,
      color: tag.color
    })
    .margin({ bottom: 10 })
  }

  getCategoryLabel(category: string): string {
    const cat = this.categories.find(c => c.value === category);
    return cat?.label || category;
  }

  async deleteTag(tag: Tag) {
    try {
      await this.lifeHubData.deleteTag(tag.id!);
      await this.loadTags();
    } catch (error) {
      console.error('TagsMain: åˆ é™¤æ ‡ç­¾å¤±è´¥:', error);
    }
  }
}
