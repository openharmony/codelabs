/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License,Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * ÂÅ•Â∫∑ËÆ∞ÂΩïÈ°µÈù¢
 */
import { LifeHubData, HealthRecord as HealthRecordModel } from '../../model/LifeHubData';
import { router } from '@kit.ArkUI';

// ÂÅ•Â∫∑Á±ªÂûãÈÄâÈ°πÊé•Âè£
interface HealthTypeOption {
  value: string;
  label: string;
  unit: string;
  icon: string;
}

@Entry
@Component
export struct HealthRecord {
  private lifeHubData: LifeHubData = new LifeHubData();
  @State selectedType: string = 'weight';
  @State value: string = '';
  @State unit: string = 'kg';
  @State note: string = '';
  @State isSaving: boolean = false;
  private types: HealthTypeOption[] = [
    {
      value: 'weight',
      label: '‰ΩìÈáç',
      unit: 'kg',
      icon: '‚öñÔ∏è'
    },
    {
      value: 'blood_pressure',
      label: 'Ë°ÄÂéã',
      unit: 'mmHg',
      icon: 'ü©∫'
    },
    {
      value: 'blood_sugar',
      label: 'Ë°ÄÁ≥ñ',
      unit: 'mmol/L',
      icon: 'ü©∏'
    },
    {
      value: 'exercise',
      label: 'ËøêÂä®',
      unit: 'ÂàÜÈíü',
      icon: 'üèÉ'
    },
    {
      value: 'sleep',
      label: 'Áù°Áú†',
      unit: 'Â∞èÊó∂',
      icon: 'üò¥'
    }
  ];

  aboutToAppear() {
    const context = getContext(this);
    if (context) {
      this.lifeHubData.setContext(context);
    }
    // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÈªòËÆ§Âçï‰Ωç
    this.updateUnit();
  }

  updateUnit() {
    const type = this.types.find(t => t.value === this.selectedType);
    if (type) {
      this.unit = type.unit;
    }
  }

  build() {
    Column() {
      // Ê†áÈ¢òÊ†è
      Row() {
        Button('ÂèñÊ∂à')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => {
            router.back();
          })

        Text('ËÆ∞ÂΩïÂÅ•Â∫∑')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .textAlign(TextAlign.Center)
          .layoutWeight(1)

        Button('‰øùÂ≠ò')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor(this.value ? '#007DFF' : '#999')
          .enabled(!!this.value && !this.isSaving)
          .onClick(() => {
            this.saveRecord();
          })
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#f0f0f0')

      Scroll() {
        Column() {
          // Á±ªÂûãÈÄâÊã©
          Column() {
            Text('ËÆ∞ÂΩïÁ±ªÂûã')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .textAlign(TextAlign.Start)
              .width('100%')
              .margin({ bottom: 15 })

            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
              ForEach(this.types, (type: HealthTypeOption) => {
                Column() {
                  Text(type.icon)
                    .fontSize(32)
                  Text(type.label)
                    .fontSize(14)
                    .fontColor('#333')
                    .margin({ top: 5 })
                }
                .width(80)
                .height(100)
                .justifyContent(FlexAlign.Center)
                .backgroundColor(this.selectedType === type.value ? '#4CAF5020' : '#f0f0f0')
                .borderRadius(10)
                .onClick(() => {
                  this.selectedType = type.value;
                  this.updateUnit();
                })
                .margin({ right: 10, bottom: 10 })
              })
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ top: 20, left: 15, right: 15 })

          // Êï∞ÂÄºËæìÂÖ•
          Column() {
            Text('Êï∞ÂÄº')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .textAlign(TextAlign.Start)
              .width('100%')
              .margin({ bottom: 15 })

            Row() {
              TextInput({ placeholder: 'ËØ∑ËæìÂÖ•Êï∞ÂÄº', text: this.value })
                .layoutWeight(1)
                .type(InputType.Number)
                .onChange((value: string) => {
                  this.value = value;
                })

              Text(this.unit)
                .fontSize(16)
                .fontColor('#666')
                .margin({ left: 10 })
            }
            .width('100%')
            .height(50)
            .padding({ left: 15, right: 15 })
            .backgroundColor('#f8f8f8')
            .borderRadius(8)
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ top: 15, left: 15, right: 15 })

          // Â§áÊ≥®
          Column() {
            Text('Â§áÊ≥®ÔºàÂèØÈÄâÔºâ')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .textAlign(TextAlign.Start)
              .width('100%')
              .margin({ bottom: 15 })

            TextArea({ placeholder: 'Ê∑ªÂä†Â§áÊ≥®...', text: this.note })
              .width('100%')
              .height(100)
              .onChange((value: string) => {
                this.note = value;
              })
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({
            top: 15,
            left: 15,
            right: 15,
            bottom: 20
          })
        }
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  async saveRecord() {
    if (!this.value) {
      return;
    }

    this.isSaving = true;
    try {
      const record: HealthRecordModel = {
        type: this.selectedType as 'weight' | 'blood_pressure' | 'blood_sugar' | 'exercise' | 'sleep',
        value: parseFloat(this.value),
        unit: this.unit,
        note: this.note,
        date: this.getTodayString(),
        time: Date.now()
      };

      await this.lifeHubData.addHealthRecord(record);
      router.replaceUrl({
        url: 'pages/Index',
        params: {
          tab: 1
        }
      });
    } catch (error) {
      console.error('HealthRecord: ‰øùÂ≠òÂ§±Ë¥•:', error);
    } finally {
      this.isSaving = false;
    }
  }

  getTodayString(): string {
    const date = new Date();
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
}
