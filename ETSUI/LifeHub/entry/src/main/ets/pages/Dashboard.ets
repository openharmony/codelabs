/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License,Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * ä»ªè¡¨ç›˜é¡µé¢
 * å±•ç¤ºå„æ¨¡å—çš„å…³é”®æ•°æ®å’Œå¿«é€Ÿå…¥å£
 */
import { LifeHubData, DashboardStats } from '../model/LifeHubData';
import { router } from '@kit.ArkUI';

@Component
export struct Dashboard {
  private lifeHubData: LifeHubData = new LifeHubData();
  @State healthRecordsToday: number = 0;
  @State activeGoals: number = 0;
  @State moodToday: string = 'ğŸ˜Š';
  @State skillsCount: number = 0;
  @State travelPlansActive: number = 0;
  @State isLoading: boolean = true;

  aboutToAppear() {
    const context = getContext(this);
    if (context) {
      this.lifeHubData.setContext(context);
      // å»¶è¿ŸåŠ è½½ï¼Œç¡®ä¿æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
      setTimeout(() => {
        this.loadDashboardData();
      }, 500);
    } else {
      this.loadDashboardData();
    }
  }

  async loadDashboardData() {
    this.isLoading = true;
    try {
      // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
      await new Promise<void>((resolve: () => void) => setTimeout(resolve, 300));
      const stats: DashboardStats = await this.lifeHubData.getDashboardStats();
      console.log('Dashboard: ç»Ÿè®¡æ•°æ®:', JSON.stringify(stats));
      this.healthRecordsToday = stats.healthRecordsToday;
      this.activeGoals = stats.activeGoals;
      this.moodToday = stats.moodToday?.mood || 'ğŸ˜Š';
      this.skillsCount = stats.skillsCount;
      this.travelPlansActive = stats.travelPlansActive;
      console.log('Dashboard: æ•°æ®å·²æ›´æ–°', {
        healthRecordsToday: this.healthRecordsToday,
        activeGoals: this.activeGoals,
        moodToday: this.moodToday,
        skillsCount: this.skillsCount,
        travelPlansActive: this.travelPlansActive
      });
    } catch (error) {
      console.error('Dashboard: åŠ è½½æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // build() {
  //   Scroll() {
  //     Column() {
  //       // æ ‡é¢˜
  //       Row() {
  //         Text('ç”Ÿæ´»ä¸­å¿ƒ')
  //           .fontSize(28)
  //           .fontWeight(FontWeight.Bold)
  //
  //         Blank()
  //       }
  //       .width('100%')
  //       .padding({ left: 20, right: 20, top: 20, bottom: 10 })
  //
  //       // ä»Šæ—¥æ¦‚è§ˆ
  //       Text('ä»Šæ—¥æ¦‚è§ˆ')
  //         .fontSize(18)
  //         .fontWeight(FontWeight.Medium)
  //         .textAlign(TextAlign.Start)
  //         .width('100%')
  //         .padding({ left: 20, right: 20, top: 10, bottom: 10 })
  //
  //       // æ•°æ®å¡ç‰‡
  //       Row() {
  //         // å¥åº·
  //         this.buildStatCard('å¥åº·', 'ğŸ’š', this.healthRecordsToday > 0 ? this.healthRecordsToday.toString() : '0', 'ä»Šæ—¥è®°å½•', '#4CAF50', () => {
  //           // è·³è½¬åˆ°å¥åº·æ¨¡å—
  //         })
  //
  //         // ç›®æ ‡
  //         this.buildStatCard('ç›®æ ‡', 'ğŸ¯', this.activeGoals > 0 ? this.activeGoals.toString() : '0', 'è¿›è¡Œä¸­', '#FF9800', () => {
  //           // è·³è½¬åˆ°ç›®æ ‡æ¨¡å—
  //         })
  //       }
  //       .width('100%')
  //       .padding({ left: 15, right: 15, bottom: 10 })
  //       .justifyContent(FlexAlign.SpaceBetween)
  //
  //       Row() {
  //         // å¿ƒæƒ…
  //         this.buildStatCard('å¿ƒæƒ…', this.moodToday, '', 'ä»Šæ—¥å¿ƒæƒ…', '#E91E63', () => {
  //           // è·³è½¬åˆ°å¿ƒæƒ…æ¨¡å—
  //         })
  //
  //         // å­¦ä¹ 
  //         this.buildStatCard('å­¦ä¹ ', 'ğŸ“š', this.skillsCount > 0 ? this.skillsCount.toString() : '0', 'æŠ€èƒ½æ•°', '#2196F3', () => {
  //           // è·³è½¬åˆ°å­¦ä¹ æ¨¡å—
  //         })
  //       }
  //       .width('100%')
  //       .padding({ left: 15, right: 15, bottom: 10 })
  //       .justifyContent(FlexAlign.SpaceBetween)
  //
  //       // å¿«é€Ÿå…¥å£
  //       Text('å¿«é€Ÿå…¥å£')
  //         .fontSize(18)
  //         .fontWeight(FontWeight.Medium)
  //         .textAlign(TextAlign.Start)
  //         .width('100%')
  //         .padding({ left: 20, right: 20, top: 20, bottom: 10 })
  //
  //       // åŠŸèƒ½å…¥å£ç½‘æ ¼
  //       Grid() {
  //         GridItem() {
  //           this.buildQuickEntry('è®°å½•å¥åº·', 'ğŸ’š', '#4CAF50', () => {
  //             router.pushUrl({ url: 'pages/health/HealthRecord' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('åˆ›å»ºç›®æ ‡', 'ğŸ¯', '#FF9800', () => {
  //             router.pushUrl({ url: 'pages/goals/GoalDetail' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('è®°å½•å¿ƒæƒ…', 'ğŸ˜Š', '#E91E63', () => {
  //             router.pushUrl({ url: 'pages/mood/MoodRecord' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('è§„åˆ’æ—…è¡Œ', 'âœˆï¸', '#2196F3', () => {
  //             router.pushUrl({ url: 'pages/travel/TravelPlan' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('æ·»åŠ æŠ€èƒ½', 'ğŸ“š', '#9C27B0', () => {
  //             router.pushUrl({ url: 'pages/learning/SkillDetail' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('å†™æ—¥è®°', 'ğŸ“', '#00BCD4', () => {
  //             router.pushUrl({ url: 'pages/diary/DiaryEdit' });
  //           })
  //         }
  //       }
  //       .columnsTemplate('1fr 1fr 1fr')
  //       .rowsTemplate('1fr 1fr')
  //       .columnsGap(10)
  //       .rowsGap(10)
  //       .width('100%')
  //       .height(200)
  //       .padding({ left: 15, right: 15, bottom: 20 })
  //
  //       // æ›´å¤šåŠŸèƒ½
  //       Text('æ›´å¤šåŠŸèƒ½')
  //         .fontSize(18)
  //         .fontWeight(FontWeight.Medium)
  //         .textAlign(TextAlign.Start)
  //         .width('100%')
  //         .padding({ left: 20, right: 20, top: 20, bottom: 10 })
  //
  //       Grid() {
  //         GridItem() {
  //           this.buildQuickEntry('æ•°æ®ç»Ÿè®¡', 'ğŸ“Š', '#607D8B', () => {
  //             router.pushUrl({ url: 'pages/statistics/StatisticsMain' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('ç»Ÿä¸€æœç´¢', 'ğŸ”', '#795548', () => {
  //             router.pushUrl({ url: 'pages/search/SearchMain' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('æˆå°±ç³»ç»Ÿ', 'ğŸ†', '#FFD700', () => {
  //             router.pushUrl({ url: 'pages/achievements/AchievementsMain' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('ç”Ÿæ´»æŠ¥å‘Š', 'ğŸ“„', '#9E9E9E', () => {
  //             router.pushUrl({ url: 'pages/report/ReportMain' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('è®¾ç½®', 'âš™ï¸', '#424242', () => {
  //             router.pushUrl({ url: 'pages/settings/SettingsMain' });
  //           })
  //         }
  //       }
  //       .columnsTemplate('1fr 1fr 1fr')
  //       .rowsTemplate('1fr 1fr')
  //       .columnsGap(10)
  //       .rowsGap(10)
  //       .width('100%')
  //       .height(200)
  //       .padding({ left: 15, right: 15, bottom: 20 })
  //
  //       // å·¥å…·åŠŸèƒ½
  //       Text('å·¥å…·åŠŸèƒ½')
  //         .fontSize(18)
  //         .fontWeight(FontWeight.Medium)
  //         .textAlign(TextAlign.Start)
  //         .width('100%')
  //         .padding({ left: 20, right: 20, top: 20, bottom: 10 })
  //
  //       Grid() {
  //         GridItem() {
  //           this.buildQuickEntry('æé†’ç®¡ç†', 'â°', '#FF9800', () => {
  //             router.pushUrl({ url: 'pages/reminder/ReminderMain' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('æ•°æ®å¤‡ä»½', 'ğŸ“¦', '#607D8B', () => {
  //             router.pushUrl({ url: 'pages/backup/BackupMain' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('æ ‡ç­¾ç®¡ç†', 'ğŸ·ï¸', '#9C27B0', () => {
  //             router.pushUrl({ url: 'pages/tags/TagsMain' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('æ•°æ®ç­›é€‰', 'ğŸ”', '#795548', () => {
  //             router.pushUrl({ url: 'pages/filter/FilterMain' });
  //           })
  //         }
  //
  //         GridItem() {
  //           this.buildQuickEntry('å¸®åŠ©ä¸­å¿ƒ', 'â“', '#00BCD4', () => {
  //             router.pushUrl({ url: 'pages/help/HelpMain' });
  //           })
  //         }
  //       }
  //       .columnsTemplate('1fr 1fr 1fr')
  //       .rowsTemplate('1fr 1fr')
  //       .columnsGap(10)
  //       .rowsGap(10)
  //       .width('100%')
  //       .height(200)
  //       .padding({ left: 15, right: 15, bottom: 20 })
  //     }
  //   }
  //   .width('100%')
  //   .layoutWeight(1)
  // }

  build() {
    Scroll() {
      Column() {
        // æ ‡é¢˜
        Row() {
          Text('ç”Ÿæ´»ä¸­å¿ƒ')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)

          Blank()
        }
        .width('100%')
        .padding({
          left: 20,
          right: 20,
          top: 20,
          bottom: 10
        })

        // ===== åˆ é™¤ï¼šä»Šæ—¥æ¦‚è§ˆæ•´ä¸ªåŒºåŸŸ =====


        // å¿«é€Ÿå…¥å£ï¼ˆä¿ç•™ï¼‰
        Text('å¿«é€Ÿå…¥å£')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .textAlign(TextAlign.Start)
          .width('100%')
          .padding({
            left: 20,
            right: 20,
            top: 20,
            bottom: 10
          })

        Grid() {
          GridItem() {
            this.buildQuickEntry('è®°å½•å¥åº·', 'ğŸ’š', '#4CAF50', () => {
              router.pushUrl({ url: 'pages/health/HealthRecord' });
            })
          }

          GridItem() {
            this.buildQuickEntry('åˆ›å»ºç›®æ ‡', 'ğŸ¯', '#FF9800', () => {
              router.pushUrl({ url: 'pages/goals/GoalDetail' });
            })
          }

          GridItem() {
            this.buildQuickEntry('è®°å½•å¿ƒæƒ…', 'ğŸ˜Š', '#E91E63', () => {
              router.pushUrl({ url: 'pages/mood/MoodRecord' });
            })
          }

          GridItem() {
            this.buildQuickEntry('è§„åˆ’æ—…è¡Œ', 'âœˆï¸', '#2196F3', () => {
              router.pushUrl({ url: 'pages/travel/TravelPlan' });
            })
          }

          GridItem() {
            this.buildQuickEntry('æ·»åŠ æŠ€èƒ½', 'ğŸ“š', '#9C27B0', () => {
              router.pushUrl({ url: 'pages/learning/SkillDetail' });
            })
          }

          GridItem() {
            this.buildQuickEntry('å†™æ—¥è®°', 'ğŸ“', '#00BCD4', () => {
              router.pushUrl({ url: 'pages/diary/DiaryEdit' });
            })
          }
        }
        .columnsTemplate('1fr 1fr 1fr')
        .rowsTemplate('1fr 1fr')
        .columnsGap(10)
        .rowsGap(10)
        .width('100%')
        .height(200)
        .padding({ left: 15, right: 15, bottom: 20 })

        // æ›´å¤šåŠŸèƒ½ï¼ˆåˆ é™¤ ç»Ÿä¸€æœç´¢ã€è®¾ç½®ï¼‰
        Text('æ›´å¤šåŠŸèƒ½')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .textAlign(TextAlign.Start)
          .width('100%')
          .padding({
            left: 20,
            right: 20,
            top: 20,
            bottom: 10
          })

        Grid() {
          GridItem() {
            this.buildQuickEntry('æ•°æ®ç»Ÿè®¡', 'ğŸ“Š', '#607D8B', () => {
              router.pushUrl({ url: 'pages/statistics/StatisticsMain' });
            })
          }

          GridItem() {
            this.buildQuickEntry('æˆå°±ç³»ç»Ÿ', 'ğŸ†', '#FFD700', () => {
              router.pushUrl({ url: 'pages/achievements/AchievementsMain' });
            })
          }

          GridItem() {
            this.buildQuickEntry('ç”Ÿæ´»æŠ¥å‘Š', 'ğŸ“„', '#9E9E9E', () => {
              router.pushUrl({ url: 'pages/report/ReportMain' });
            })
          }
        }
        .columnsTemplate('1fr 1fr 1fr')
        .rowsTemplate('1fr')
        .columnsGap(10)
        .rowsGap(10)
        .width('100%')
        .height(100)
        .padding({ left: 15, right: 15, bottom: 20 })

        // å·¥å…·åŠŸèƒ½ï¼ˆåˆ é™¤ æ•°æ®å¤‡ä»½ã€æ ‡ç­¾ç®¡ç†ï¼‰
        Text('å·¥å…·åŠŸèƒ½')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .textAlign(TextAlign.Start)
          .width('100%')
          .padding({
            left: 20,
            right: 20,
            top: 20,
            bottom: 10
          })

        Grid() {
          GridItem() {
            this.buildQuickEntry('æé†’ç®¡ç†', 'â°', '#FF9800', () => {
              router.pushUrl({ url: 'pages/reminder/ReminderMain' });
            })
          }

          GridItem() {
            this.buildQuickEntry('æ•°æ®ç­›é€‰', 'ğŸ”', '#795548', () => {
              router.pushUrl({ url: 'pages/filter/FilterMain' });
            })
          }

          GridItem() {
            this.buildQuickEntry('å¸®åŠ©ä¸­å¿ƒ', 'â“', '#00BCD4', () => {
              router.pushUrl({ url: 'pages/help/HelpMain' });
            })
          }
        }
        .columnsTemplate('1fr 1fr 1fr')
        .rowsTemplate('1fr')
        .columnsGap(10)
        .rowsGap(10)
        .width('100%')
        .height(100)
        .padding({ left: 15, right: 15, bottom: 20 })
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildStatCard(title: string, icon: string, value: string, subtitle: string, color: string, onClick: () => void) {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 8 })

      Text(value || '0')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
        .margin({ bottom: 4 })

      Text(title)
        .fontSize(14)
        .fontColor('#666')
        .margin({ bottom: 2 })

      Text(subtitle)
        .fontSize(12)
        .fontColor('#999')
    }
    .width('48%')
    .height(140)
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#10000000',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(onClick)
  }

  @Builder
  buildQuickEntry(title: string, icon: string, color: string, onClick: () => void) {
    Column() {
      Text(icon)
        .fontSize(36)
        .margin({ bottom: 8 })

      Text(title)
        .fontSize(14)
        .fontColor('#333')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 2,
      color: '#10000000',
      offsetX: 0,
      offsetY: 1
    })
    .onClick(onClick)
  }
}
