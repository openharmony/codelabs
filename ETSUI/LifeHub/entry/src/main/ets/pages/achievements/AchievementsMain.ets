/**
 * æˆå°±ç³»ç»Ÿé¡µé¢
 */
import { LifeHubData, HealthRecord, Goal, MoodRecord, Skill, TravelPlan, Diary } from '../../model/LifeHubData';

interface Achievement {
  id: string;
  title: string;
  description: string;
  icon: string;
  progress: number;
  maxProgress: number;
  unlocked: boolean;
  category: string;
}

@Entry
@Component
export struct AchievementsMain {
  private lifeHubData: LifeHubData = new LifeHubData();
  
  @State achievements: Achievement[] = [];
  @State unlockedCount: number = 0;

  aboutToAppear() {
    const context = getContext(this);
    if (context) {
      this.lifeHubData.setContext(context);
    }
    this.loadAchievements();
  }

  async loadAchievements() {
    try {
      // èŽ·å–ç»Ÿè®¡æ•°æ®
      const stats = await this.lifeHubData.getDashboardStats();
      const healthRecords = await this.lifeHubData.getHealthRecords(undefined, 1000);
      const goals = await this.lifeHubData.getAllGoals();
      const moodRecords = await this.lifeHubData.getMoodRecords(1000);
      const skills = await this.lifeHubData.getAllSkills();
      const travelPlans = await this.lifeHubData.getAllTravelPlans();
      const diaries = await this.lifeHubData.getAllDiaries();

      // è®¡ç®—æˆå°±
      this.achievements = [
        {
          id: 'first_record',
          title: 'åˆæ¬¡è®°å½•',
          description: 'è®°å½•ç¬¬ä¸€æ¡å¥åº·æ•°æ®',
          icon: 'ðŸŽ‰',
          progress: healthRecords.length > 0 ? 1 : 0,
          maxProgress: 1,
          unlocked: healthRecords.length > 0,
          category: 'å¥åº·'
        },
        {
          id: 'health_master',
          title: 'å¥åº·è¾¾äºº',
          description: 'è®°å½•100æ¡å¥åº·æ•°æ®',
          icon: 'ðŸ’š',
          progress: healthRecords.length,
          maxProgress: 100,
          unlocked: healthRecords.length >= 100,
          category: 'å¥åº·'
        },
        {
          id: 'goal_setter',
          title: 'ç›®æ ‡è®¾å®šè€…',
          description: 'åˆ›å»ºç¬¬ä¸€ä¸ªç›®æ ‡',
          icon: 'ðŸŽ¯',
          progress: goals.length > 0 ? 1 : 0,
          maxProgress: 1,
          unlocked: goals.length > 0,
          category: 'ç›®æ ‡'
        },
        {
          id: 'goal_master',
          title: 'ç›®æ ‡å¤§å¸ˆ',
          description: 'å®Œæˆ10ä¸ªç›®æ ‡',
          icon: 'ðŸ†',
          progress: this.getCompletedGoalsCount(goals),
          maxProgress: 10,
          unlocked: this.getCompletedGoalsCount(goals) >= 10,
          category: 'ç›®æ ‡'
        },
        {
          id: 'mood_tracker',
          title: 'å¿ƒæƒ…è®°å½•è€…',
          description: 'è®°å½•30å¤©å¿ƒæƒ…',
          icon: 'ðŸ˜Š',
          progress: moodRecords.length,
          maxProgress: 30,
          unlocked: moodRecords.length >= 30,
          category: 'å¿ƒæƒ…'
        },
        {
          id: 'skill_learner',
          title: 'æŠ€èƒ½å­¦ä¹ è€…',
          description: 'æ·»åŠ ç¬¬ä¸€ä¸ªæŠ€èƒ½',
          icon: 'ðŸ“š',
          progress: skills.length > 0 ? 1 : 0,
          maxProgress: 1,
          unlocked: skills.length > 0,
          category: 'å­¦ä¹ '
        },
        {
          id: 'skill_master',
          title: 'æŠ€èƒ½å¤§å¸ˆ',
          description: 'æ‹¥æœ‰10ä¸ªæŠ€èƒ½',
          icon: 'ðŸŒŸ',
          progress: skills.length,
          maxProgress: 10,
          unlocked: skills.length >= 10,
          category: 'å­¦ä¹ '
        },
        {
          id: 'traveler',
          title: 'æ—…è¡Œè€…',
          description: 'åˆ›å»ºç¬¬ä¸€ä¸ªæ—…è¡Œè®¡åˆ’',
          icon: 'âœˆï¸',
          progress: travelPlans.length > 0 ? 1 : 0,
          maxProgress: 1,
          unlocked: travelPlans.length > 0,
          category: 'æ—…è¡Œ'
        },
        {
          id: 'diarist',
          title: 'æ—¥è®°ä½œå®¶',
          description: 'å†™10ç¯‡æ—¥è®°',
          icon: 'ðŸ“',
          progress: diaries.length,
          maxProgress: 10,
          unlocked: diaries.length >= 10,
          category: 'æ—¥è®°'
        },
        {
          id: 'dedicated',
          title: 'æŒä¹‹ä»¥æ’',
          description: 'è¿žç»­è®°å½•7å¤©',
          icon: 'ðŸ”¥',
          progress: this.getConsecutiveDays(moodRecords),
          maxProgress: 7,
          unlocked: this.getConsecutiveDays(moodRecords) >= 7,
          category: 'åšæŒ'
        },
        {
          id: 'data_collector',
          title: 'æ•°æ®æ”¶é›†è€…',
          description: 'æ€»è®°å½•æ•°è¾¾åˆ°500æ¡',
          icon: 'ðŸ“Š',
          progress: healthRecords.length + goals.length + moodRecords.length + 
                   skills.length + travelPlans.length + diaries.length,
          maxProgress: 500,
          unlocked: (healthRecords.length + goals.length + moodRecords.length + 
                    skills.length + travelPlans.length + diaries.length) >= 500,
          category: 'ç»¼åˆ'
        },
        {
          id: 'all_rounder',
          title: 'å…¨èƒ½é€‰æ‰‹',
          description: 'æ‰€æœ‰æ¨¡å—éƒ½æœ‰è®°å½•',
          icon: 'â­',
          progress: this.getAllModulesProgress(healthRecords, goals, moodRecords, skills, travelPlans, diaries),
          maxProgress: 6,
          unlocked: this.getAllModulesProgress(healthRecords, goals, moodRecords, skills, travelPlans, diaries) === 6,
          category: 'ç»¼åˆ'
        }
      ];

      this.unlockedCount = this.achievements.filter(a => a.unlocked).length;
    } catch (error) {
      console.error('AchievementsMain: åŠ è½½æˆå°±å¤±è´¥:', error);
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('æˆå°±ç³»ç»Ÿ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Column() {
          Text(this.unlockedCount.toString())
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF9800')
          Text(`/${this.achievements.length}`)
            .fontSize(14)
            .fontColor('#666')
        }
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#f0f0f0')

      Scroll() {
        Column() {
          // æˆå°±åˆ—è¡¨
          ForEach(this.achievements, (achievement: Achievement) => {
            this.buildAchievementCard(achievement)
          })
        }
        .width('100%')
        .padding(15)
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildAchievementCard(achievement: Achievement) {
    Column() {
      Row() {
        Text(achievement.icon)
          .fontSize(40)
          .opacity(achievement.unlocked ? 1 : 0.3)
          .width(60)
          .textAlign(TextAlign.Center)

        Column() {
          Text(achievement.title)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(achievement.unlocked ? '#333' : '#999')
            .textAlign(TextAlign.Start)
            .width('100%')

          Text(achievement.description)
            .fontSize(14)
            .fontColor('#666')
            .textAlign(TextAlign.Start)
            .width('100%')
            .margin({ top: 5 })

          Row() {
            Text(achievement.category)
              .fontSize(12)
              .fontColor('#999')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor('#f0f0f0')
              .borderRadius(10)

            Blank()

            if (achievement.unlocked) {
              Text('âœ“ å·²è§£é”')
                .fontSize(12)
                .fontColor('#4CAF50')
                .fontWeight(FontWeight.Bold)
            } else {
              Text(`${achievement.progress}/${achievement.maxProgress}`)
                .fontSize(12)
                .fontColor('#666')
            }
          }
          .width('100%')
          .margin({ top: 10 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        .padding({ left: 15 })
      }
      .width('100%')

      if (!achievement.unlocked && achievement.maxProgress > 1) {
        Progress({ 
          value: achievement.progress, 
          total: achievement.maxProgress, 
          type: ProgressType.Linear 
        })
          .width('100%')
          .height(6)
          .color('#007DFF')
          .margin({ top: 15 })
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor(achievement.unlocked ? Color.White : '#fafafa')
    .borderRadius(12)
    .border({
      width: achievement.unlocked ? 2 : 1,
      color: achievement.unlocked ? '#FFD700' : '#e0e0e0'
    })
    .margin({ bottom: 15 })
  }

  getCompletedGoalsCount(goals: Goal[]): number {
    let count = 0;
    for (let i = 0; i < goals.length; i++) {
      if (goals[i].status === 'completed') {
        count++;
      }
    }
    return count;
  }

  getConsecutiveDays(records: MoodRecord[]): number {
    if (records.length === 0) return 0;
    
    const dates: string[] = [];
    for (let i = 0; i < records.length; i++) {
      dates.push(records[i].date);
    }
    dates.sort().reverse();
    let consecutive = 1;
    const today = new Date();
    
    for (let i = 0; i < dates.length - 1; i++) {
      const date1 = new Date(dates[i]);
      const date2 = new Date(dates[i + 1]);
      const diffDays = Math.floor((date1.getTime() - date2.getTime()) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 1) {
        consecutive++;
      } else {
        break;
      }
    }
    
    return consecutive;
  }

  getAllModulesProgress(health: HealthRecord[], goals: Goal[], mood: MoodRecord[], skills: Skill[], travel: TravelPlan[], diaries: Diary[]): number {
    let progress = 0;
    if (health.length > 0) progress++;
    if (goals.length > 0) progress++;
    if (mood.length > 0) progress++;
    if (skills.length > 0) progress++;
    if (travel.length > 0) progress++;
    if (diaries.length > 0) progress++;
    return progress;
  }
}
