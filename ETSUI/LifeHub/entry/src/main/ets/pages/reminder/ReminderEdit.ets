/**
 * ç¼–è¾‘æé†’é¡µé¢
 */
import { LifeHubData, Reminder } from '../../model/LifeHubData';
import { router } from '@kit.ArkUI';

interface TypeOption {
  value: 'health' | 'goal' | 'mood' | 'learning' | 'diary' | 'custom';
  label: string;
  icon: string;
}

@Entry
@Component
export struct ReminderEdit {
  private lifeHubData: LifeHubData = new LifeHubData();
  private reminderId: number = 0;
  
  @State title: string = '';
  @State description: string = '';
  @State type: 'health' | 'goal' | 'mood' | 'learning' | 'diary' | 'custom' = 'health';
  @State time: string = '09:00';
  @State selectedDays: boolean[] = [false, true, true, true, true, true, false]; // å‘¨ä¸€åˆ°å‘¨æ—¥
  @State isReminderEnabled: boolean = true;
  @State isSaving: boolean = false;

  private types: TypeOption[] = [
    { value: 'health', label: 'å¥åº·', icon: 'ğŸ’š' },
    { value: 'goal', label: 'ç›®æ ‡', icon: 'ğŸ¯' },
    { value: 'mood', label: 'å¿ƒæƒ…', icon: 'ğŸ˜Š' },
    { value: 'learning', label: 'å­¦ä¹ ', icon: 'ğŸ“š' },
    { value: 'diary', label: 'æ—¥è®°', icon: 'ğŸ“' },
    { value: 'custom', label: 'è‡ªå®šä¹‰', icon: 'ğŸ””' }
  ];

  private dayNames = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];

  aboutToAppear() {
    const context = getContext(this);
    if (context) {
      this.lifeHubData.setContext(context);
    }
    const params = router.getParams() as Record<string, number>;
    this.reminderId = params?.reminderId || 0;
    if (this.reminderId) {
      this.loadReminder();
    }
  }

  async loadReminder() {
    // TODO: ä»æ•°æ®åº“åŠ è½½æé†’è¯¦æƒ…
  }

  build() {
    Column() {
      Row() {
        Button('å–æ¶ˆ')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => {
            router.back();
          })

        Text('æé†’è®¾ç½®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .textAlign(TextAlign.Center)
          .layoutWeight(1)

        Button('ä¿å­˜')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor(this.title ? '#007DFF' : '#999')
          .enabled(!!this.title && !this.isSaving)
          .onClick(() => {
            this.saveReminder();
          })
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#f0f0f0')

      Scroll() {
        Column() {
          // æ ‡é¢˜
          Text('æé†’æ ‡é¢˜')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .textAlign(TextAlign.Start)
            .margin({ top: 20, bottom: 10, left: 15 })

          TextInput({ placeholder: 'è¾“å…¥æé†’æ ‡é¢˜', text: this.title })
            .width('100%')
            .height(50)
            .fontSize(16)
            .padding({ left: 15, right: 15 })
            .backgroundColor('#f8f8f8')
            .borderRadius(8)
            .onChange((value: string) => {
              this.title = value;
            })
            .margin({ left: 15, right: 15 })

          // æè¿°
          Text('æé†’æè¿°')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .textAlign(TextAlign.Start)
            .margin({ top: 20, bottom: 10, left: 15 })

          TextArea({ placeholder: 'è¾“å…¥æé†’æè¿°ï¼ˆå¯é€‰ï¼‰', text: this.description })
            .width('100%')
            .height(100)
            .fontSize(16)
            .padding(15)
            .backgroundColor('#f8f8f8')
            .borderRadius(8)
            .onChange((value: string) => {
              this.description = value;
            })
            .margin({ left: 15, right: 15 })

          // ç±»å‹é€‰æ‹©
          Text('æé†’ç±»å‹')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .textAlign(TextAlign.Start)
            .margin({ top: 20, bottom: 10, left: 15 })

          Grid() {
            ForEach(this.types, (t: TypeOption) => {
              GridItem() {
                Column() {
                  Text(t.icon)
                    .fontSize(32)
                    .margin({ bottom: 8 })
                  Text(t.label)
                    .fontSize(14)
                    .fontColor(this.type === t.value ? '#007DFF' : '#666')
                }
                .width('100%')
                .height(100)
                .justifyContent(FlexAlign.Center)
                .backgroundColor(this.type === t.value ? '#E3F2FD' : '#f8f8f8')
                .borderRadius(8)
                .border({
                  width: this.type === t.value ? 2 : 0,
                  color: '#007DFF'
                })
                .onClick(() => {
                  this.type = t.value;
                })
              }
            })
          }
          .columnsTemplate('1fr 1fr 1fr')
          .columnsGap(10)
          .rowsGap(10)
          .width('100%')
          .height(220)
          .margin({ left: 15, right: 15 })

          // æ—¶é—´é€‰æ‹©
          Text('æé†’æ—¶é—´')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .textAlign(TextAlign.Start)
            .margin({ top: 20, bottom: 10, left: 15 })

          Row() {
            Text(this.time)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#007DFF')
          }
          .width('100%')
          .height(60)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#f8f8f8')
          .borderRadius(8)
          .margin({ left: 15, right: 15 })
          .onClick(() => {
            // TODO: æ‰“å¼€æ—¶é—´é€‰æ‹©å™¨
          })

          // é‡å¤è®¾ç½®
          Text('é‡å¤è®¾ç½®')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .textAlign(TextAlign.Start)
            .margin({ top: 20, bottom: 10, left: 15 })

          Row() {
            ForEach(this.selectedDays, (selected: boolean, index: number) => {
              Column() {
                Text(this.dayNames[index])
                  .fontSize(14)
                  .fontColor(selected ? '#007DFF' : '#666')
                  .fontWeight(selected ? FontWeight.Bold : FontWeight.Normal)
              }
              .width(40)
              .height(50)
              .justifyContent(FlexAlign.Center)
              .backgroundColor(selected ? '#E3F2FD' : '#f8f8f8')
              .borderRadius(8)
              .border({
                width: selected ? 2 : 0,
                color: '#007DFF'
              })
              .onClick(() => {
                this.selectedDays[index] = !this.selectedDays[index];
              })
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceAround)
          .margin({ left: 15, right: 15, bottom: 20 })
        }
        .width('100%')
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  async saveReminder() {
    if (!this.title) return;

    this.isSaving = true;
    try {
      const days = this.selectedDays.map((selected: boolean, index: number) => 
        selected ? index.toString() : ''
      ).filter(d => d).join(',');

      const reminder: Reminder = {
        id: this.reminderId || undefined,
        title: this.title,
        description: this.description,
        type: this.type,
        time: this.time,
        days: days,
        enabled: this.isReminderEnabled,
        createTime: this.reminderId ? Date.now() : Date.now(),
        updateTime: Date.now()
      };

      if (this.reminderId) {
        await this.lifeHubData.updateReminder(reminder);
      } else {
        await this.lifeHubData.addReminder(reminder);
      }
      router.back();
    } catch (error) {
      console.error('ReminderEdit: ä¿å­˜å¤±è´¥:', error);
    } finally {
      this.isSaving = false;
    }
  }
}
