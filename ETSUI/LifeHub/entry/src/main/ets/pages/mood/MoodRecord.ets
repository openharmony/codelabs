/**
 * ËÆ∞ÂΩïÂøÉÊÉÖÈ°µÈù¢
 */
import { LifeHubData, MoodRecord as MoodRecordModel } from '../../model/LifeHubData';
import { router } from '@kit.ArkUI';

// ÂøÉÊÉÖÈÄâÈ°πÊé•Âè£
interface MoodOption {
  emoji: string;
  score: number;
  label: string;
}

@Entry
@Component
export struct MoodRecord {
  private lifeHubData: LifeHubData = new LifeHubData();
  
  @State selectedMood: string = 'üòä';
  @State score: number = 5;
  @State note: string = '';
  @State isSaving: boolean = false;

  private moods: MoodOption[] = [
    { emoji: 'üòÑ', score: 9, label: 'ÈùûÂ∏∏ÂºÄÂøÉ' },
    { emoji: 'üòä', score: 7, label: 'ÂºÄÂøÉ' },
    { emoji: 'üòê', score: 5, label: '‰∏ÄËà¨' },
    { emoji: 'üòî', score: 3, label: '‰ΩéËêΩ' },
    { emoji: 'üò¢', score: 1, label: 'ÈöæËøá' }
  ];

  aboutToAppear() {
    const context = getContext(this);
    if (context) {
      this.lifeHubData.setContext(context);
    }
  }

  build() {
    Column() {
      Row() {
        Button('ÂèñÊ∂à')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => {
            router.back();
          })

        Text('ËÆ∞ÂΩïÂøÉÊÉÖ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .textAlign(TextAlign.Center)
          .layoutWeight(1)

        Button('‰øùÂ≠ò')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .enabled(!this.isSaving)
          .onClick(() => {
            this.saveMood();
          })
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#f0f0f0')

      Scroll() {
        Column() {
          Text('ÈÄâÊã©ÂøÉÊÉÖ')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .textAlign(TextAlign.Center)
            .margin({ top: 30, bottom: 20 })

          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Center }) {
            ForEach(this.moods, (mood: MoodOption) => {
              Column() {
                Text(mood.emoji)
                  .fontSize(50)
                Text(mood.label)
                  .fontSize(14)
                  .fontColor('#333')
                  .margin({ top: 10 })
              }
              .width(100)
              .height(120)
              .justifyContent(FlexAlign.Center)
              .backgroundColor(this.selectedMood === mood.emoji ? '#E91E6320' : '#f0f0f0')
              .borderRadius(12)
              .onClick(() => {
                this.selectedMood = mood.emoji;
                this.score = mood.score;
              })
              .margin({ right: 10, bottom: 10 })
            })
          }
          .width('100%')
          .padding({ left: 20, right: 20 })

          Column() {
            Text('Â§áÊ≥®ÔºàÂèØÈÄâÔºâ')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .textAlign(TextAlign.Start)
              .width('100%')
              .margin({ bottom: 15, top: 20 })

            TextArea({ placeholder: 'ËÆ∞ÂΩïÊ≠§ÂàªÁöÑÊÉ≥Ê≥ï...', text: this.note })
              .width('100%')
              .height(120)
              .onChange((value: string) => {
                this.note = value;
              })
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ top: 20, left: 15, right: 15, bottom: 20 })
        }
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  async saveMood() {
    this.isSaving = true;
    try {
      const record: MoodRecordModel = {
        mood: this.selectedMood,
        score: this.score,
        note: this.note,
        date: this.getTodayString(),
        time: Date.now()
      };

      await this.lifeHubData.addMoodRecord(record);
      router.back();
    } catch (error) {
      console.error('MoodRecord: ‰øùÂ≠òÂ§±Ë¥•:', error);
    } finally {
      this.isSaving = false;
    }
  }

  getTodayString(): string {
    const date = new Date();
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
}
