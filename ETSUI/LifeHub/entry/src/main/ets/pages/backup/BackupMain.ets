/**
 * æ•°æ®å¤‡ä»½å’Œæ¢å¤é¡µé¢
 */
import { LifeHubData, HealthRecord, Goal, MoodRecord, Skill, TravelPlan, Diary } from '../../model/LifeHubData';

interface BackupData {
  healthRecords: HealthRecord[];
  goals: Goal[];
  moodRecords: MoodRecord[];
  skills: Skill[];
  travelPlans: TravelPlan[];
  diaries: Diary[];
}

interface Backup {
  version: string;
  timestamp: number;
  data: BackupData;
}

@Entry
@Component
export struct BackupMain {
  private lifeHubData: LifeHubData = new LifeHubData();
  
  @State backupData: string = '';
  @State isBackingUp: boolean = false;
  @State isRestoring: boolean = false;
  @State lastBackupTime: string = 'ä»æœªå¤‡ä»½';
  @State restoreText: string = '';

  aboutToAppear() {
    const context = getContext(this);
    if (context) {
      this.lifeHubData.setContext(context);
    }
    this.loadLastBackupTime();
  }

  async loadLastBackupTime() {
    // TODO: ä»æœ¬åœ°å­˜å‚¨åŠ è½½æœ€åå¤‡ä»½æ—¶é—´
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('æ•°æ®å¤‡ä»½')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
        
        Blank()
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#f0f0f0')

      Scroll() {
        Column() {
          // å¤‡ä»½åŠŸèƒ½
          Text('æ•°æ®å¤‡ä»½')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .width('100%')
            .textAlign(TextAlign.Start)
            .padding({ left: 20, top: 20, bottom: 10 })

          Column() {
            Row() {
              Column() {
                Text('ğŸ“¦')
                  .fontSize(40)
                  .margin({ bottom: 10 })
                Text('å¤‡ä»½æ‰€æœ‰æ•°æ®')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333')
                Text('å°†æ•°æ®å¯¼å‡ºä¸ºJSONæ ¼å¼')
                  .fontSize(14)
                  .fontColor('#666')
                  .margin({ top: 5 })
                Text(`æœ€åå¤‡ä»½: ${this.lastBackupTime}`)
                  .fontSize(12)
                  .fontColor('#999')
                  .margin({ top: 10 })
              }
              .alignItems(HorizontalAlign.Center)
              .width('100%')
            }
            .width('100%')
            .padding(20)

            Button('å¼€å§‹å¤‡ä»½')
              .width('90%')
              .height(50)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .backgroundColor('#007DFF')
              .fontColor(Color.White)
              .borderRadius(25)
              .enabled(!this.isBackingUp)
              .onClick(() => {
                this.performBackup();
              })
              .margin({ top: 10, bottom: 20 })
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ left: 15, right: 15, bottom: 20 })

          // æ¢å¤åŠŸèƒ½
          Text('æ•°æ®æ¢å¤')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .width('100%')
            .textAlign(TextAlign.Start)
            .padding({ left: 20, top: 20, bottom: 10 })

          Column() {
            Text('âš ï¸ è­¦å‘Šï¼šæ¢å¤æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œï¼')
              .fontSize(14)
              .fontColor('#FF5722')
              .width('100%')
              .textAlign(TextAlign.Start)
              .padding(15)
              .backgroundColor('#FFF3E0')
              .borderRadius(8)
              .margin({ bottom: 15 })

            Text('ç²˜è´´å¤‡ä»½æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰')
              .fontSize(14)
              .fontColor('#666')
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ bottom: 10 })

            TextArea({ 
              placeholder: 'åœ¨æ­¤ç²˜è´´å¤‡ä»½çš„JSONæ•°æ®...', 
              text: this.restoreText 
            })
              .width('100%')
              .height(200)
              .fontSize(14)
              .padding(15)
              .backgroundColor('#f8f8f8')
              .borderRadius(8)
              .onChange((value: string) => {
                this.restoreText = value;
              })

            Button('å¼€å§‹æ¢å¤')
              .width('90%')
              .height(50)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .backgroundColor('#FF5722')
              .fontColor(Color.White)
              .borderRadius(25)
              .enabled(!this.isRestoring && this.restoreText.length > 0)
              .onClick(() => {
                this.performRestore();
              })
              .margin({ top: 15, bottom: 20 })
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ left: 15, right: 15, bottom: 20 })

          // å¤‡ä»½æ•°æ®é¢„è§ˆ
          if (this.backupData.length > 0) {
            Column() {
              Row() {
                Text('å¤‡ä»½æ•°æ®é¢„è§ˆ')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333')
                
                Blank()
                
                Button('å¤åˆ¶')
                  .fontSize(14)
                  .height(32)
                  .backgroundColor('#007DFF')
                  .fontColor(Color.White)
                  .onClick(() => {
                    // TODO: å¤åˆ¶åˆ°å‰ªè´´æ¿
                  })
              }
              .width('100%')
              .margin({ bottom: 10 })

              Text(this.backupData)
                .fontSize(12)
                .fontColor('#666')
                .width('100%')
                .maxLines(10)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .padding(15)
                .backgroundColor('#f8f8f8')
                .borderRadius(8)
            }
            .width('100%')
            .padding(15)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ left: 15, right: 15, bottom: 20 })
          }

          // ä½¿ç”¨è¯´æ˜
          Column() {
            Text('ğŸ“– ä½¿ç”¨è¯´æ˜')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ bottom: 15 })

            Text('1. å®šæœŸå¤‡ä»½æ•°æ®å¯ä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±')
              .fontSize(14)
              .fontColor('#666')
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ bottom: 10 })

            Text('2. å¤‡ä»½æ•°æ®ä¸ºJSONæ ¼å¼ï¼Œå¯ä»¥ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹')
              .fontSize(14)
              .fontColor('#666')
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ bottom: 10 })

            Text('3. æ¢å¤æ•°æ®å‰è¯·ç¡®ä¿å¤‡ä»½æ•°æ®æ ¼å¼æ­£ç¡®')
              .fontSize(14)
              .fontColor('#666')
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ bottom: 10 })

            Text('4. æ¢å¤æ“ä½œä¸å¯é€†ï¼Œè¯·è°¨æ…æ“ä½œ')
              .fontSize(14)
              .fontColor('#FF5722')
              .width('100%')
              .textAlign(TextAlign.Start)
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFF9C4')
          .borderRadius(12)
          .margin({ left: 15, right: 15, bottom: 20 })
        }
        .width('100%')
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  async performBackup() {
    this.isBackingUp = true;
    try {
      // è·å–æ‰€æœ‰æ•°æ®
      const healthRecords = await this.lifeHubData.getHealthRecords(undefined, 10000);
      const goals = await this.lifeHubData.getAllGoals();
      const moodRecords = await this.lifeHubData.getMoodRecords(10000);
      const skills = await this.lifeHubData.getAllSkills();
      const travelPlans = await this.lifeHubData.getAllTravelPlans();
      const diaries = await this.lifeHubData.getAllDiaries();

      const backup: Backup = {
        version: '1.0',
        timestamp: Date.now(),
        data: {
          healthRecords,
          goals,
          moodRecords,
          skills,
          travelPlans,
          diaries
        }
      };

      this.backupData = JSON.stringify(backup, null, 2);
      this.lastBackupTime = new Date().toLocaleString();
      
      // TODO: ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶æˆ–åˆ†äº«
      console.log('å¤‡ä»½å®Œæˆ:', this.backupData);
    } catch (error) {
      console.error('BackupMain: å¤‡ä»½å¤±è´¥:', error);
    } finally {
      this.isBackingUp = false;
    }
  }

  async performRestore() {
    if (!this.restoreText) return;

    this.isRestoring = true;
    try {
      const backup = JSON.parse(this.restoreText) as Backup;
      
      if (!backup.data) {
        throw new Error('å¤‡ä»½æ•°æ®æ ¼å¼é”™è¯¯');
      }

      // TODO: å®ç°æ•°æ®æ¢å¤é€»è¾‘
      // 1. æ¸…é™¤ç°æœ‰æ•°æ®
      // 2. å¯¼å…¥å¤‡ä»½æ•°æ®
      
      console.log('æ¢å¤å®Œæˆ');
    } catch (error) {
      console.error('BackupMain: æ¢å¤å¤±è´¥:', error);
    } finally {
      this.isRestoring = false;
    }
  }
}
