/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// pages/ProfilePage.ets
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import {
  PassType,
  PasswordManager,
  RouterUtil
} from '../common/Config';
import common from '@ohos.app.ability.common';
import { Note, NoteManager } from '../common/NoteManager';


interface UserInfo {
  username: string;
  avatar: Resource;
  lastLogin: string;
  loginMethod: PassType;
}

interface AuthMethodConfig {
  type: PassType;
  name: string;
  icon: Resource;
  color: string;
  enabled: boolean;
  lastUsed: string;
}

@Entry
@Component
struct ProfilePage {
  @State oldPassword: string = '';
  @State newPassword: string = '';
  @State confirmPassword: string = '';
  @State showPassword: boolean = false;
  @State selectedAuthType: PassType | null = null;
  @State isSaving: boolean = false;

  // ===== å¿˜è®°å¯†ç ç›¸å…³çŠ¶æ€ =====
  @State showResetDialog: boolean = false
  @State resetPassword: string = ''
  @State resetConfirmPassword: string = ''
  @State isResetting: boolean = false

  // å¿˜è®°å¯†ç æ—¶ç”¨äºéªŒè¯çš„å¯†ç 
  @State verifyPassword: string = ''
  @State verifyAuthType: PassType | null = null

  @State currentMethod: AuthMethodConfig = {
    type: PassType.NUMBER,
    name: '',
    icon: $r('app.media.avatar_default'),
    color: '',
    enabled: true,
    lastUsed: ''
  };

  @State userInfo: UserInfo = {
    username: 'é¸¿å°è’™',
    avatar: $r('app.media.avatar_default'),
    lastLogin: this.getNowDateTime(),
    loginMethod: PassType.NUMBER
  };

  @State authMethods: AuthMethodConfig[] = [
    {
      type: PassType.NUMBER,
      name: 'æ•°å­—å¯†ç ',
      icon: $r('app.media.ic_number'),
      color: '#4CAF50',
      enabled: true,
      lastUsed: 'ä»Šå¤© 14:30'
    },
    {
      type: PassType.GRAPH,
      name: 'å›¾å½¢å¯†ç ',
      icon: $r('app.media.ic_pattern'),
      color: '#2196F3',
      enabled: true,
      lastUsed: 'æ˜¨å¤© 09:15'
    },
    {
      type: PassType.FINGERPRINT,
      name: 'æŒ‡çº¹è¯†åˆ«',
      icon: $r('app.media.ic_up'),
      color: '#FF9800',
      enabled: true,
      lastUsed: this.getNowDateTime()
    }
  ];

  // ä¾¿ç­¾ç›¸å…³çŠ¶æ€
  @State notes: Note[] = [];
  @State showNoteDialog: boolean = false;

  // ä¾¿ç­¾æœç´¢ä¸ç¼–è¾‘çŠ¶æ€
  @State searchKeyword: string = '';
  @State currentNoteId: string = '';
  @State currentNoteTitle: string = '';
  @State currentNoteContent: string = '';
  @State currentNotePinned: boolean = false;

  private validatePasswordFormat(type: PassType, password: string): boolean {
    if (type === PassType.NUMBER) {
      // 6 ä½çº¯æ•°å­—
      return /^\d{6}$/.test(password);
    }

    if (type === PassType.GRAPH) {
      // åªèƒ½æ˜¯ 1~9
      if (!/^[1-9]+$/.test(password)) {
        return false;
      }

      // è‡³å°‘ 4 ä¸ªç‚¹
      if (password.length < 4) {
        return false;
      }

      // æ‰€æœ‰ç‚¹å¿…é¡»å”¯ä¸€
      const uniquePoints = new Set(password.split(''));
      return uniquePoints.size === password.length;
    }

    return true;
  }



  private getNowDateTime(): string {
    const now = new Date()

    const year = now.getFullYear()
    const month = (now.getMonth() + 1).toString().padStart(2, '0')
    const day = now.getDate().toString().padStart(2, '0')
    const hour = now.getHours().toString().padStart(2, '0')
    const minute = now.getMinutes().toString().padStart(2, '0')

    return `${year}-${month}-${day} ${hour}:${minute}`
  }


  // å¼¹çª—æ§åˆ¶å™¨å®šä¹‰
  dialogController: CustomDialogController | null = new CustomDialogController({
    builder: ChangePasswordDialog({
      authMethod: this.currentMethod,
      oldPass: $oldPassword,
      newPass: $newPassword,
      confirmPass: $confirmPassword,
      showPass: $showPassword,
      onConfirm: () => {
        this.saveNewPassword();
      }
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: true
  });


  resetDialogController: CustomDialogController | null =
    new CustomDialogController({
      builder: ResetPasswordDialog({
        authMethod: this.currentMethod,
        verifyAuthType: this.verifyAuthType!,
        verifyPass: $verifyPassword,
        newPass: $resetPassword,
        confirmPass: $resetConfirmPassword,
        onConfirm: () => {
          this.resetPasswordDirectly()
        }
      }),
      autoCancel: true,
      alignment: DialogAlignment.Center,
      customStyle: true
    });

  aboutToAppear() {
    // 1. åˆå§‹åŒ–ä¾¿ç­¾ç®¡ç†å™¨
    const context = getContext(this) as common.UIAbilityContext;
    NoteManager.init(context);
    // 2. åŠ è½½ä¾¿ç­¾æ•°æ®
    this.loadNotes();
  }

  // åŠ è½½ä¾¿ç­¾ï¼ˆæ”¯æŒæœç´¢ï¼‰
  async loadNotes() {
    if (this.searchKeyword) {
      this.notes = await NoteManager.searchNotes(this.searchKeyword);
    } else {
      this.notes = await NoteManager.getNotes();
    }
  }

  // æ‰“å¼€ä¾¿ç­¾å¼¹çª—ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
  openNoteDialog(note?: Note) {
    if (note) {
      this.currentNoteId = note.id;
      this.currentNoteTitle = note.title;
      this.currentNoteContent = note.content;
      this.currentNotePinned = note.isPinned;
    } else {
      this.currentNoteId = '';
      this.currentNoteTitle = '';
      this.currentNoteContent = '';
      this.currentNotePinned = false;
    }
    this.showNoteDialog = true;
  }

  // ä¿å­˜ä¾¿ç­¾
  async handleSaveNote() {
    if (!this.currentNoteContent.trim() && !this.currentNoteTitle.trim()) {
      // è¿™é‡Œæ˜¯åŒæ­¥çš„ï¼ŒåŸæ¥çš„å†™æ³•ä¹Ÿèƒ½ç”¨ï¼Œä½†å»ºè®®ç»Ÿä¸€é£æ ¼
      this.getUIContext().getPromptAction().showToast({ message: 'è¯·è‡³å°‘è¾“å…¥æ ‡é¢˜æˆ–å†…å®¹' });
      return;
    }

    const newNote: Note = {
      id: this.currentNoteId || Date.now().toString(),
      title: this.currentNoteTitle,
      content: this.currentNoteContent,
      isPinned: this.currentNotePinned,
      updateTime: new Date().toLocaleString() // æ³¨æ„ï¼šè¿™é‡Œæœ€å¥½ç”¨ä¹‹å‰å®šä¹‰çš„ getNowDateTime() ä¿æŒæ ¼å¼ç»Ÿä¸€
    };

    // ç­‰å¾…å¼‚æ­¥æ“ä½œ
    await NoteManager.saveNote(newNote);
    await this.loadNotes();

    // å…³é—­å¼¹çª—
    this.showNoteDialog = false;

    // ä½¿ç”¨ getUIContext æ¥æ˜¾ç¤º Toast
    try {
      this.getUIContext().getPromptAction().showToast({
        message: 'ä¿å­˜æˆåŠŸ',
        duration: 2000
      });
    } catch (error) {
      console.error('Toast error:', error);
    }
  }

  // åˆ é™¤ä¾¿ç­¾
  async handleDeleteNote(id: string) {
    // ç­‰å¾…å¼‚æ­¥æ“ä½œ
    await NoteManager.deleteNote(id);
    await this.loadNotes();

    // ä½¿ç”¨ getUIContext æ¥æ˜¾ç¤º Toast
    try {
      this.getUIContext().getPromptAction().showToast({
        message: 'å·²åˆ é™¤',
        duration: 2000
      });
    } catch (error) {
      console.error('Toast error:', error);
    }
  }


  changeAuthPassword(method: AuthMethodConfig): void {
    this.selectedAuthType = method.type;
    this.currentMethod = method;
    this.oldPassword = '';
    this.newPassword = '';
    this.confirmPassword = '';
    this.showPassword = false;
    this.isSaving = false;
    if (this.dialogController) {
      this.dialogController.open();
    }
  }

  // pages/ProfilePage.ets

  async saveNewPassword(): Promise<void> {
    if (this.isSaving || !this.selectedAuthType) return;

    // 1. æœ¬åœ°é€»è¾‘æ ¡éªŒ (è¿™äº›ä¸æ¶‰åŠå¼‚æ­¥ï¼Œæ²¡é—®é¢˜)
    if (this.newPassword !== this.confirmPassword) {
      promptAction.showToast({ message: 'æ–°å¯†ç ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´' });
      this.confirmPassword = '';
      return;
    }
    if (this.oldPassword.trim() === '' || this.newPassword.trim() === '') {
      promptAction.showToast({ message: 'å¯†ç ä¸èƒ½ä¸ºç©º' });
      return;
    }

    if (!this.validatePasswordFormat(this.selectedAuthType!, this.newPassword.trim())) {
      if (this.selectedAuthType === PassType.NUMBER) {
        promptAction.showToast({ message: 'æ•°å­—å¯†ç å¿…é¡»ä¸º 6 ä½æ•°å­—' });
      } else if (this.selectedAuthType === PassType.GRAPH) {
        promptAction.showToast({ message: 'æ•°å­—ä¸èƒ½é‡å¤ä¸”è‡³å°‘éœ€è¦è¿æ¥ 4 ä¸ªç‚¹' });
      }
      this.newPassword = '';
      this.confirmPassword = '';
      return;
    }

    // æ ¸å¿ƒä¿®å¤ï¼šæå‰è·å– UIContext å’Œ commonContext
    const uiContext = this.getUIContext();
    const context = getContext(this) as common.Context;
    this.isSaving = true;

    try {
      const success: boolean = await PasswordManager.updatePassword(
        context,
        this.selectedAuthType,
        this.oldPassword.trim(),
        this.newPassword.trim()
      );

      // ä½¿ç”¨ uiContext.runScopedTask ç¡®ä¿ UI æ“ä½œå›åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œä¸Šä¸‹æ–‡
      uiContext.runScopedTask(() => {
        if (success) {
          promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸ' });

          // æ˜¾å¼å…³é—­å¼¹çª—
          if (this.dialogController) {
            this.dialogController.close();
          }

          // æ›´æ–°çŠ¶æ€
          this.updateLastUsedTime(this.selectedAuthType!);
          this.oldPassword = '';
          this.newPassword = '';
          this.confirmPassword = '';
        } else {
          promptAction.showToast({ message: 'åŸå¯†ç è¾“å…¥é”™è¯¯' });
          this.oldPassword = '';
        }
      });

    } catch (err) {
      console.error('Password update exception');
      // å³ä½¿å‡ºé”™ä¹Ÿè¦å°è¯•åœ¨ UI çº¿ç¨‹æç¤º
      uiContext.runScopedTask(() => {
        promptAction.showToast({ message: 'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•' });
      });
    } finally {
      this.isSaving = false;
    }
  }


  async resetPasswordDirectly(): Promise<void> {
    if (this.isResetting || !this.selectedAuthType) return

    if (this.resetPassword !== this.resetConfirmPassword) {
      promptAction.showToast({ message: 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´' })
      this.resetConfirmPassword = ''
      return
    }

    if (this.resetPassword.trim() === '') {
      promptAction.showToast({ message: 'å¯†ç ä¸èƒ½ä¸ºç©º' })
      return
    }

    if (!this.validatePasswordFormat(this.selectedAuthType!, this.resetPassword.trim())) {
      if (this.selectedAuthType === PassType.NUMBER) {
        promptAction.showToast({ message: 'æ•°å­—å¯†ç å¿…é¡»ä¸º 6 ä½æ•°å­—' });
      } else if (this.selectedAuthType === PassType.GRAPH) {
        promptAction.showToast({ message: 'æ•°å­—ä¸èƒ½é‡å¤ä¸”è‡³å°‘éœ€è¦è¿æ¥ 4 ä¸ªç‚¹' });
      }
      this.resetPassword = '';
      this.resetConfirmPassword = '';
      return;
    }



    const uiContext = this.getUIContext()
    const context = getContext(this) as common.Context
    this.isResetting = true

    // å…ˆéªŒè¯èº«ä»½
    const verified = await PasswordManager.verifyPassword(
      context,
      this.verifyAuthType!,
      this.verifyPassword.trim()
    )

    if (!verified) {
      uiContext.runScopedTask(() => {
        promptAction.showToast({ message: 'éªŒè¯å¯†ç é”™è¯¯' })
        this.verifyPassword = ''
      })
      this.isResetting = false
      return
    }


    try {
      const success = await PasswordManager.resetPassword(
        context,
        this.selectedAuthType,
        this.resetPassword.trim()
      )

      uiContext.runScopedTask(() => {
        if (success) {
          promptAction.showToast({ message: 'å¯†ç é‡ç½®æˆåŠŸ' })
          this.resetDialogController?.close()
          this.updateLastUsedTime(this.selectedAuthType!)
          this.resetPassword = ''
          this.resetConfirmPassword = ''
        } else {
          promptAction.showToast({ message: 'å¯†ç é‡ç½®å¤±è´¥' })
        }
      })
    } catch (e) {
      uiContext.runScopedTask(() => {
        promptAction.showToast({ message: 'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•' })
      })
    } finally {
      this.isResetting = false
    }
  }


  updateLastUsedTime(authType: PassType): void {
    const now = new Date();
    const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    this.authMethods = this.authMethods.map((m: AuthMethodConfig): AuthMethodConfig => {
      if (m.type === authType) {
        return {
          type: m.type,
          name: m.name,
          icon: m.icon,
          color: m.color,
          enabled: m.enabled,
          lastUsed: `ä»Šå¤© ${timeStr}`
        } as AuthMethodConfig;
      }
      return m;
    });
  }


  @Builder buildUserHeader() {
    Column({ space: 15 }) {
      Row() {
        Button('â†')
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => RouterUtil.goBack())

        Text('ä¸ªäººä¸­å¿ƒ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Blank()
          .width(40)
      }
      .width('100%')
      Row({ space: 20 })
      {
        Image(this.userInfo.avatar)
          .width(80)
          .height(80)
          .borderRadius(40)

        Column({ space: 8 })
        {
          Text(this.userInfo.username)
            .fontSize(22)
            .fontWeight(FontWeight.Bold)

          Text(`æœ€åç™»å½•: ${this.userInfo.lastLogin}`)
            .fontSize(13)
            .fontColor('#666')

        }
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(15)

    }
    .padding(20)

  }

  @Builder buildAuthMethodCard(method: AuthMethodConfig) {
    Row() {
      Column() {
        Image(method.icon)
          .width(30)
          .height(30)
      }
      .width(50)
      .height(50)
      .backgroundColor(method.color)
      .borderRadius(12)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      Column({ space: 4 })
      {
        Text(method.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)

        Text(`æœ€åä½¿ç”¨: ${method.lastUsed}`)
          .fontSize(12)
          .fontColor('#999')

      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: 15 })
      Row({ space: 6 }) {
        // ===== æŒ‡çº¹ï¼šåªæ˜¾ç¤º å¯ç”¨ / ç¦ç”¨ =====
        if (method.type === PassType.FINGERPRINT) {
          Blank()
            .width(8)
            .height(8)
            .backgroundColor('#4CAF50')
            .borderRadius(4)

          Text('å·²å¯ç”¨')
            .fontSize(12)
            .fontColor('#4CAF50')
        }
        Row({ space: 10 }) {


          // ===== éæŒ‡çº¹ï¼šåŸæ¥çš„é€»è¾‘ =====
          if (method.type !== PassType.FINGERPRINT) {
            Button('ä¿®æ”¹')
              .height(28)
              .fontSize(12)
              .backgroundColor('#E8F4FF')
              .fontColor('#007DFF')
              .onClick(() => this.changeAuthPassword(method))

            Button('å¿˜è®°å¯†ç ')
              .height(28)
              .fontSize(12)
              .backgroundColor('#FFF7E6')
              .fontColor('#FF9500')
              .onClick(() => {
                this.currentMethod = method
                this.selectedAuthType = method.type

                this.verifyAuthType =
                  method.type === PassType.NUMBER
                    ? PassType.GRAPH
                    : PassType.NUMBER

                this.verifyPassword = ''
                this.resetPassword = ''
                this.resetConfirmPassword = ''
                this.isResetting = false

                this.resetDialogController?.open()
              })
          }
        }
      }

    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(10)


  }

  // è·³è½¬åˆ°è¯¾ç¨‹è¡¨é¡µé¢
  navigateToSchedule() {
    router.pushUrl({
      url: 'pages/SchedulePage' // ç¡®ä¿æ‚¨å·²ç»åœ¨ main_pages.json ä¸­é…ç½®äº†è¿™ä¸ªè·¯å¾„
    });
  }

  // æ„å»ºåŠŸèƒ½å…¥å£å¡ç‰‡ï¼ˆè¯¾è¡¨ï¼‰
  @Builder buildFeatureCard() {
    Column() {
      Text('å¸¸ç”¨åŠŸèƒ½')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .width('100%')
        .margin({ bottom: 10 })

      Row() {
        // å·¦ä¾§å›¾æ ‡
        Column() {
          Text('ğŸ“…') // ä½¿ç”¨ Emoji ä½œä¸ºå›¾æ ‡ï¼Œæˆ–è€…ä½¿ç”¨å›¾ç‰‡
            .fontSize(24)
        }
        .width(50)
        .height(50)
        .backgroundColor('#E3F2FD') // æµ…è“è‰²èƒŒæ™¯
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)

        // ä¸­é—´æ–‡å­—
        Column({ space: 4 }) {
          Text('æˆ‘çš„è¯¾è¡¨')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)

          Text('æŸ¥çœ‹æœ¬å­¦æœŸè¯¾ç¨‹å®‰æ’')
            .fontSize(12)
            .fontColor('#999')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 15 })

        // å³ä¾§ç®­å¤´
        Text('>')
          .fontSize(18)
          .fontColor('#CCCCCC')
      }
      .width('100%')
      .padding(15)
      .backgroundColor(Color.White)
      .borderRadius(10)
      .onClick(() => {
        this.navigateToSchedule();
      })
    }
    .padding(20) // å¤–è¾¹è·ï¼Œä¸ä¸Šé¢çš„è®¤è¯æ–¹å¼ä¿æŒä¸€è‡´
  }

  // ä¾¿ç­¾ UI æ„å»ºå™¨
  // ä¾¿ç­¾åˆ—è¡¨å¡ç‰‡
  @Builder buildNotesCard() {
    Column({ space: 15 }) {
      // æ ‡é¢˜æ 
      Row() {
        Text('æˆ‘çš„ä¾¿ç­¾')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)

        Blank()

        Button('+ æ–°å»º')
          .height(28)
          .fontSize(12)
          .backgroundColor('#E8F4FF')
          .fontColor('#007DFF')
          .onClick(() => this.openNoteDialog())
      }
      .width('100%')

      // æœç´¢æ 
      Search({ placeholder: 'æœç´¢ä¾¿ç­¾...', value: this.searchKeyword })
        .width('100%')
        .height(36)
        .backgroundColor('#F5F5F5')
        .onChange((value: string) => {
          this.searchKeyword = value;
          this.loadNotes();
        })

      // åˆ—è¡¨
      if (this.notes.length === 0) {
        Text(this.searchKeyword ? 'æ— æœç´¢ç»“æœ' : 'æš‚æ— ä¾¿ç­¾')
          .fontSize(14)
          .fontColor('#999')
          .width('100%')
          .textAlign(TextAlign.Center)
          .padding(20)
      } else {
        List({ space: 10 }) {
          ForEach(this.notes, (note: Note) => {
            ListItem() {
              Row() {
                Column({ space: 5 }) {
                  Row({ space: 5 }) {
                    if (note.isPinned)
                      Text('')
                        .fontSize(12)

                    Text(note.title || 'æ— æ ‡é¢˜')
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                  }
                  Text(note.content)
                    .fontSize(14)
                    .fontColor('#666')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })

                  Text(note.updateTime)
                    .fontSize(10)
                    .fontColor('#CCC')

                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)

                Button('åˆ é™¤')
                  .type(ButtonType.Normal)
                  .backgroundColor(Color.Transparent)
                  .fontColor('#FF3B30')
                  .fontSize(12)
                  .onClick(() => this.handleDeleteNote(note.id))
              }
              .width('100%')
              .padding(10)
              .backgroundColor(note.isPinned ? '#FFF8E1' : '#F9F9F9')
              .borderRadius(8)
              .onClick(() => this.openNoteDialog(note))
            }
          })
        }
        .width('100%')
        .height('auto')
        .constraintSize({ maxHeight: 300 })
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(15)
    .margin({ bottom: 20 }) // æ³¨æ„è¿™é‡ŒåŠ äº† margin bottom
  }

  // ä¾¿ç­¾ç¼–è¾‘å¼¹çª— (å…¨å±é®ç½©)
  @Builder buildNoteEditDialog() {
    if (this.showNoteDialog) {
      Stack() {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('#00000040')
          .onClick(() => this.showNoteDialog = false)

        Column({ space: 15 }) {
          Text(this.currentNoteId ? 'ç¼–è¾‘ä¾¿ç­¾' : 'æ–°å»ºä¾¿ç­¾')
            .fontSize(18)
            .fontWeight(FontWeight.Bold).width('100%')

          TextInput({ text: this.currentNoteTitle, placeholder: 'æ ‡é¢˜' })
            .height(40)
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .onChange(v => this.currentNoteTitle = v)

          TextArea({ text: this.currentNoteContent, placeholder: 'å†…å®¹' })
            .height(100)
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .onChange(v => this.currentNoteContent = v)

          Row() {
            Text('ç½®é¡¶')
              .fontSize(16)

            Blank()

            Toggle({ type: ToggleType.Switch, isOn: this.currentNotePinned })
              .onChange(v => this.currentNotePinned = v)

          }
          .width('100%')

          Row({ space: 15 }) {
            Button('å–æ¶ˆ')
              .layoutWeight(1)
              .backgroundColor('#F5F5F5')
              .fontColor('#666')
              .onClick(() => this.showNoteDialog = false)

            Button('ä¿å­˜')
              .layoutWeight(1)
              .onClick(() => this.handleSaveNote())

          }
        }
        .width(300)
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(15)
      }
      .width('100%')
      .height('100%')
      .zIndex(999)
    }
  }

  build() {
    // æ ¹å¸ƒå±€æ”¹ä¸º Stackï¼Œä»¥ä¾¿å¼¹çª—å¯ä»¥è¦†ç›–åœ¨æœ€ä¸Šå±‚
    Stack() {
      // ä¸»é¡µé¢å†…å®¹
      Column() {
        this.buildUserHeader()

        // æ·»åŠ  Scrollï¼Œé˜²æ­¢å†…å®¹è¿‡å¤šå¯¼è‡´æ— æ³•æ»šåŠ¨
        Scroll() {
          Column() {
            // åŸæœ‰çš„è®¤è¯æ–¹å¼åˆ—è¡¨
            Column() {
              Text('è®¤è¯æ–¹å¼ç®¡ç†')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .width('100%')
                .margin({ top: 0, bottom: 10 })

              ForEach(this.authMethods,
                (m: AuthMethodConfig) => {
                  this.buildAuthMethodCard(m)
                },
                (m: AuthMethodConfig) => m.type.toString())
            }
            .padding(20)

            this.buildFeatureCard()
            // åœ¨è®¤è¯åˆ—è¡¨ä¸‹æ–¹æ·»åŠ ä¾¿ç­¾å¡ç‰‡
            // æ³¨æ„ï¼šå› ä¸ºä¸Šé¢å·²ç»æœ‰ paddingï¼Œè¿™é‡Œé€šè¿‡ margin è°ƒæ•´é—´è·
            Column() {
              this.buildNotesCard()
            }
            .padding({ left: 20, right: 20 })

            // é€€å‡ºç™»å½•æŒ‰é’®
            Button('é€€å‡ºç™»å½•')
              .width('80%')
              .height(50)
              .backgroundColor('#FF3B30')
              .fontColor(Color.White)
              .margin({ top: 20, bottom: 30 }) // åº•éƒ¨å¤šç•™ç‚¹ç™½
              .onClick(() => {
                router.pushUrl({ url: 'pages/Index' })
              })
          }
        }
        .layoutWeight(1) // è®© Scroll å æ®å‰©ä½™ç©ºé—´
        .scrollBar(BarState.Off)
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8F9FA')

      // å°†ç¼–è¾‘å¼¹çª—æ”¾åœ¨ Stack çš„æœ€ä¸Šå±‚
      this.buildNoteEditDialog()
    }
  }
}

@CustomDialog
struct ChangePasswordDialog {
  controller?: CustomDialogController
  authMethod: AuthMethodConfig = {
    type: PassType.NUMBER,
    name: '',
    icon:$r('app.media.avatar_default') ,
    color: '',
    enabled: true,
    lastUsed: ''
  }
  @Link oldPass: string
  @Link newPass: string
  @Link confirmPass: string
  @Link showPass: boolean
  onConfirm: () => void = () => {}

  build() {
    Column({ space: 15 })
    {
      Text(`ä¿®æ”¹${this.authMethod.name}`)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)

      TextInput({ text: this.oldPass, placeholder: 'åŸå¯†ç ' })
        .type(this.showPass ? InputType.Normal : InputType.Password)
        .onChange(v => this.oldPass = v)

      TextInput({ text: this.newPass, placeholder: 'æ–°å¯†ç ' })
        .type(this.showPass ? InputType.Normal : InputType.Password)
        .onChange(v => this.newPass = v)

      TextInput({ text: this.confirmPass, placeholder: 'ç¡®è®¤æ–°å¯†ç ' })
        .type(this.showPass ? InputType.Normal : InputType.Password)
        .onChange(v => this.confirmPass = v)

      Row() {
        Checkbox()
          .select(this.showPass)
          .onChange(v => this.showPass = v)

        Text('æ˜¾ç¤ºå¯†ç ')
          .fontSize(14)
          .margin({ left: 5 })

      }
      .width('100%')


      Row({ space: 10 }) {
        Button('å–æ¶ˆ')
          .layoutWeight(1)
          .backgroundColor('#F2F2F2')
          .fontColor('#666')
          .onClick(() => this.controller?.close())


        Button('ç¡®å®šä¿®æ”¹')
          .layoutWeight(1)
          .onClick(() => {
            this.onConfirm()
          })
      }
      .width('100%')
      .margin({ top: 10 })

    }
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(15)
    .width(310)
  }
}



@CustomDialog
struct ResetPasswordDialog {
  controller?: CustomDialogController
  verifyAuthType: PassType = PassType.NUMBER
  authMethod: AuthMethodConfig = {
    type: PassType.NUMBER,
    name: '',
    icon:$r('app.media.avatar_default') ,
    color: '',
    enabled: true,
    lastUsed: ''
  }
  @Link verifyPass: string
  @Link newPass: string
  @Link confirmPass: string
  onConfirm: () => void = () => {}

  build() {
    Column({ space: 15 }) {
      Text(`é‡ç½®${this.authMethod.name}`)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)

      Text(
        this.verifyAuthType === PassType.NUMBER
          ? 'è¯·è¾“å…¥åŸæ•°å­—å¯†ç '
          : 'è¯·è¾“å…¥åŸå›¾å½¢å¯†ç '
      )
        .fontSize(14)
        .fontColor('#666')

      TextInput({
        text: this.verifyPass,
        placeholder: 'éªŒè¯å¯†ç '
      })
        .type(InputType.Password)
        .onChange(v => this.verifyPass = v)

      TextInput({ text: this.newPass, placeholder: 'æ–°å¯†ç ' })
        .type(InputType.Password)
        .onChange(v => this.newPass = v)

      TextInput({ text: this.confirmPass, placeholder: 'ç¡®è®¤æ–°å¯†ç ' })
        .type(InputType.Password)
        .onChange(v => this.confirmPass = v)

      Row({ space: 10 }) {
        Button('å–æ¶ˆ')
          .layoutWeight(1)
          .backgroundColor('#F2F2F2')
          .fontColor('#666')
          .onClick(() => this.controller?.close())

        Button('ç¡®è®¤é‡ç½®')
          .layoutWeight(1)
          .onClick(() => this.onConfirm())
      }
      .margin({ top: 10 })
    }
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(15)
    .width(300)
  }
}