/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import router from '@ohos.router';
import Habit from '../common/bean/Habit';
import HabitRepository from '../model/repository/HabitRepository';
import RecordRepository from '../model/repository/RecordRepository'; // ğŸ†• å¼•å…¥ RecordDetail æ¥å£
import AchievementRepository, { Achievement } from '../model/repository/AchievementRepository';
import { CalendarView } from '../view/component/CalendarView';
import { TimeAnalysisCard } from '../view/component/TimeAnalysisCard';
// ğŸ†• å¼•å…¥è¯¦æƒ…å¼¹çª—
import { RecordDetailDialog } from '../view/dialog/RecordDetailDialog';

@Entry
@Component
struct HabitDetailPage {
  @State habit: Habit | null = null;
  @State achievements: Achievement[] = [];
  @State recordDateStrings: string[] = [];
  // å­˜å‚¨è¯¦ç»†çš„æ—¶é—´æˆ³ (ç”¨äºæ—¶æ®µåˆ†æ)
  @State recordTimestamps: number[] = [];
  // ç»Ÿè®¡æ•°æ®
  @State currentStreak: number = 0;
  @State maxStreak: number = 0;
  @State totalCount: number = 0;
  @State selectedAchievementName: string = '';
  // ğŸ†• è¯¦æƒ…å¼¹çª—æ‰€éœ€æ•°æ®
  @State detailDate: string = '';
  @State detailMood: number = 1;
  @State detailNote: string = '';
  // ğŸ†• è¯¦æƒ…å¼¹çª—æ§åˆ¶å™¨
  detailDialogController: CustomDialogController = new CustomDialogController({
    builder: RecordDetailDialog({
      dateStr: this.detailDate,
      mood: this.detailMood,
      note: this.detailNote
    }),
    alignment: DialogAlignment.Center,
    customStyle: true
  });

  async onPageShow() {
    const params = router.getParams() as Record<string, Object>;
    if (params && params.habitId) {
      const habitId = params.habitId as number;

      // 1. åŠ è½½åŸºç¡€æ•°æ® (åªåŠ è½½ä¸€æ¬¡)
      this.habit = await HabitRepository.queryById(habitId);

      // 2. åŠ è½½åŠ¨æ€æ•°æ® (æå–ä¸ºç‹¬ç«‹æ–¹æ³•ï¼Œæ–¹ä¾¿æ‰“å¡ååˆ·æ–°)
      await this.loadData();
    }
  }

  /**
   * ğŸ†• [æ ¸å¿ƒä¿®å¤] æ•°æ®åŠ è½½æ–¹æ³•
   * æ‰“å¡åè°ƒç”¨æ­¤æ–¹æ³•ï¼Œå¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç»„ä»¶çš„æ•°æ®ï¼ˆåŒ…æ‹¬æ—¶æ®µåˆ†æå¡ç‰‡ï¼‰
   */
  async loadData() {
    if (!this.habit) {
      return;
    }
    const habitId = this.habit.id;

    // A. åˆ·æ–°ç»Ÿè®¡æ•°æ®
    const stats = await RecordRepository.getStreakStats(habitId);
    this.currentStreak = stats.currentStreak;
    this.maxStreak = stats.maxStreak;
    this.totalCount = stats.totalCount;

    // B. åˆ·æ–°æ—¥å†çƒ­åŠ›å›¾
    this.recordDateStrings = await RecordRepository.getRecordDateStrings(habitId);

    // C. â—åˆ·æ–°è¯¦ç»†æ—¶é—´æˆ³ (è¿™é‡Œæ›´æ–°åï¼ŒTimeAnalysisCard ä¼šè‡ªåŠ¨é‡ç»˜)
    this.recordTimestamps = await RecordRepository.getRecordTimestamps(habitId);

    // D. åˆ·æ–°å‹‹ç« çŠ¶æ€
    let allAchievements = await AchievementRepository.queryAll();
    this.achievements = this.calculateAchievementState(allAchievements);
  }

  // ğŸ†• æ‰“å¼€è¯¦æƒ…å¼¹çª—çš„é€»è¾‘
  async openRecordDetail(dateStr: string) {
    if (!this.habit) {
      return;
    }

    // æŸ¥è¯¢é‚£å¤©çš„è®°å½•
    const detail = await RecordRepository.getRecordByDate(this.habit.id, dateStr);

    if (detail) {
      this.detailDate = dateStr;
      this.detailMood = detail.mood || 1; // é»˜è®¤å€¼ä¿æŠ¤
      this.detailNote = detail.note || '';

      this.detailDialogController.open();
    } else {
      // æ²¡æŸ¥åˆ°è®°å½•ï¼ˆå¯èƒ½æ˜¯å•çº¯çš„è¡¥å¡æˆ–è€…æ•°æ®é—®é¢˜ï¼‰
      // å¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸€ä¸ª Prompt.showToast æç¤ºï¼Œæˆ–è€…ä»€ä¹ˆéƒ½ä¸åš
    }
  }

  calculateAchievementState(list: Achievement[]): Achievement[] {
    return list.map(item => {
      let isUnlockedNow = false;
      switch (item.unlockCondition) {
        case 'total_3':
          if (this.totalCount >= 3) {
            isUnlockedNow = true;
          }
          break;
        case 'total_7':
          if (this.totalCount >= 7) {
            isUnlockedNow = true;
          }
          break;
        case 'total_15':
          if (this.totalCount >= 15) {
            isUnlockedNow = true;
          }
          break;
        case 'total_30':
          if (this.totalCount >= 30) {
            isUnlockedNow = true;
          }
          break;
        case 'total_50':
          if (this.totalCount >= 50) {
            isUnlockedNow = true;
          }
          break;
        case 'total_100':
          if (this.totalCount >= 100) {
            isUnlockedNow = true;
          }
          break;
        case 'total_365':
          if (this.totalCount >= 365) {
            isUnlockedNow = true;
          }
          break;

        case 'streak_3':
          if (this.maxStreak >= 3) {
            isUnlockedNow = true;
          }
          break;
        case 'streak_7':
          if (this.maxStreak >= 7) {
            isUnlockedNow = true;
          }
          break;
        case 'streak_15':
          if (this.maxStreak >= 15) {
            isUnlockedNow = true;
          }
          break;
        case 'streak_30':
          if (this.maxStreak >= 30) {
            isUnlockedNow = true;
          }
          break;
        case 'streak_50':
          if (this.maxStreak >= 50) {
            isUnlockedNow = true;
          }
          break;
        case 'streak_100':
          if (this.maxStreak >= 100) {
            isUnlockedNow = true;
          }
          break;
        case 'streak_365':
          if (this.maxStreak >= 365) {
            isUnlockedNow = true;
          }
          break;
      }
      item.isUnlocked = isUnlockedNow;
      return item;
    });
  }

  @Builder
  AchievementPopupBuilder(desc: string) {
    Text(desc)
      .fontSize(12)
      .fontColor(Color.White)
      .padding({
        left: 10,
        right: 10,
        top: 8,
        bottom: 8
      })
      .backgroundColor('rgba(0,0,0,0.8)')
      .borderRadius(8)
  }

  @Builder
  AchievementGrid(list: Achievement[]) {
    Flex({ wrap: FlexWrap.Wrap }) {
      ForEach(list, (item: Achievement) => {
        Column() {
          Image($r(`app.media.${item.icon}`))
            .width(50)
            .height(50)
            .grayscale(item.isUnlocked ? 0 : 1)
            .opacity(item.isUnlocked ? 1 : 0.4)
            .animation({ duration: 300 })

          Text(item.name)
            .fontSize(12)
            .margin({ top: 6 })
            .fontColor(item.isUnlocked ? '#333' : '#999')
        }
        .width('25%').margin({ bottom: 20 })
        .onClick(() => {
          if (this.selectedAchievementName === item.name) {
            this.selectedAchievementName = '';
          } else {
            this.selectedAchievementName = item.name;
          }
        })
        .bindPopup(this.selectedAchievementName === item.name, {
          builder: this.AchievementPopupBuilder(item.description),
          placement: Placement.Top,
          mask: false,
          onStateChange: (e) => {
            if (!e.isVisible) {
              this.selectedAchievementName = '';
            }
          }
        })
      })
    }
  }

  build() {
    Column() {
      // --- é¡¶éƒ¨å¯¼èˆªæ  ---
      Row() {
        Text('<')
          .fontSize(30).fontWeight(FontWeight.Bold).fontColor('#333')
          .onClick(() => router.back())
        Text('ä¹ æƒ¯è¯¦æƒ…').fontSize(20).fontWeight(FontWeight.Bold).margin({ left: 16 })
        Blank()
        Text('ç¼–è¾‘').fontColor('#007DFF')
          .onClick(() => {
            router.pushUrl({
              url: 'pages/HabitEditPage',
              params: { habitId: this.habit?.id }
            })
          })
      }
      .width('100%')
      .padding({
        left: 20,
        right: 20,
        top: 12,
        bottom: 12
      })
      .backgroundColor('#F1F3F5')

      Scroll() {
        Column({ space: 12 }) {
          // 1. ä¹ æƒ¯ä¿¡æ¯å¤´
          if (this.habit) {
            Row() {
              Circle().width(12).height(12).fill(this.habit.color)
              Text(this.habit.name).fontSize(24).fontWeight(FontWeight.Bold).margin({ left: 12 })
            }
            .cardStyle() // ğŸ†• åº”ç”¨é€šç”¨å¡ç‰‡æ ·å¼
          }

          // 2. ç»Ÿè®¡æ•°æ®å¡ç‰‡
          Row() {
            Column() {
              Text(this.currentStreak.toString()).statNumStyle() // ğŸ†• åº”ç”¨æ•°å­—æ ·å¼
              Text('å½“å‰è¿ç»­').statLabelStyle() // ğŸ†• åº”ç”¨æ ‡ç­¾æ ·å¼
            }.layoutWeight(1)

            Column() {
              Text(this.maxStreak.toString()).statNumStyle()
              Text('å†å²æœ€é«˜').statLabelStyle()
            }.layoutWeight(1)

            Column() {
              Text(this.totalCount.toString()).statNumStyle()
              Text('ç´¯è®¡æ‰“å¡').statLabelStyle()
            }.layoutWeight(1)
          }
          .cardStyle() // ğŸ†• åº”ç”¨é€šç”¨å¡ç‰‡æ ·å¼

          // 3. çƒ­åŠ›å›¾ç»„ä»¶
          Column() {
            CalendarView({
              recordDates: this.recordDateStrings,
              // âœ… ä¿®å¤ç‚¹ï¼šåŠ ä¸Š : string ç±»å‹æ³¨è§£
              onDateClick: async (dateStr: string) => {
                await this.loadData();
                await this.openRecordDetail(dateStr);
              }
            })
          }
          .width('100%').backgroundColor(Color.White).borderRadius(16) // çƒ­åŠ›å›¾æ— å†…è¾¹è·ï¼Œä¿æŒåŸæ ·

          // 4. æ—¶æ®µåˆ†æå¡ç‰‡
          TimeAnalysisCard({ timeStamps: this.recordTimestamps })

          // 5. æˆå°±å‹‹ç« å¢™
          this.AchievementSection()
        }
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
    }
    .width('100%').height('100%').backgroundColor('#F1F3F5')
  }

  @Builder
  AchievementSection() {
    Column() {
      Text('æˆå°±å‹‹ç« ').sectionTitleStyle() // ğŸ†• åº”ç”¨æ ‡é¢˜æ ·å¼

      if (this.achievements.length === 0) {
        Text('æš‚æ— æˆå°±æ•°æ®').fontSize(14).fontColor('#999')
      } else {
        Text('ğŸŒŸ ç´¯è®¡é‡Œç¨‹ç¢‘').milestoneTitleStyle() // ğŸ†• åº”ç”¨å‰¯æ ‡é¢˜æ ·å¼

        this.AchievementGrid(this.achievements.filter(item => item.unlockCondition.startsWith('total')))

        Divider().color('#F1F3F5').margin({ top: 10, bottom: 20 })

        Text('ğŸ”¥ è¿èƒœé‡Œç¨‹ç¢‘').milestoneTitleStyle()

        this.AchievementGrid(this.achievements.filter(item => item.unlockCondition.startsWith('streak')))
      }
    }
    .cardStyle() // ğŸ†• åº”ç”¨é€šç”¨å¡ç‰‡æ ·å¼
  }
}

// =================================================================
// ğŸ†• åº•éƒ¨æ‰©å±•æ ·å¼å®šä¹‰ (@Extend & @Styles)
// =================================================================

/**
 * ç»Ÿè®¡å¡ç‰‡ä¸­çš„æ•°å­—æ ·å¼
 */
@Extend(Text)
function statNumStyle() {
  .fontSize(18)
  .fontWeight(FontWeight.Bold)
  .fontColor('#007DFF')
  .textAlign(TextAlign.Center)
}

/**
 * ç»Ÿè®¡å¡ç‰‡ä¸­çš„è¯´æ˜æ–‡å­—æ ·å¼
 */
@Extend(Text)
function statLabelStyle() {
  .fontSize(12)
  .fontColor('#666')
  .margin({ top: 4 })
  .fontWeight(FontWeight.Regular)
}

/**
 * æ¿å—ä¸»æ ‡é¢˜æ ·å¼ (å¦‚"æˆå°±å‹‹ç« ")
 */
@Extend(Text)
function sectionTitleStyle() {
  .fontSize(16)
  .fontWeight(FontWeight.Bold)
  .width('100%')
  .margin({ bottom: 15 })
  .fontColor('#333')
}

/**
 * é‡Œç¨‹ç¢‘å‰¯æ ‡é¢˜æ ·å¼ (å¦‚"ç´¯è®¡é‡Œç¨‹ç¢‘")
 */
@Extend(Text)
function milestoneTitleStyle() {
  .fontSize(14)
  .fontColor('#666')
  .fontWeight(FontWeight.Bold)
  .width('100%')
  .margin({ bottom: 10, top: 5 })
}

/**
 * é€šç”¨ç™½è‰²å¡ç‰‡æ ·å¼
 * åŒ…å«ï¼šç™½è‰²èƒŒæ™¯ã€åœ†è§’ã€å†…è¾¹è·
 */
@Styles
function cardStyle() {
  .width('100%')
  .padding(20)
  .backgroundColor(Color.White)
  .borderRadius(16)
}