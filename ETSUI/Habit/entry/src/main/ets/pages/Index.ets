/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import router from '@ohos.router';
import Habit from '../common/bean/Habit';
import { CommonConstants } from '../common/constants/CommonConstants';
import { DateUtil } from '../common/utils/DateUtil';
import RdbHelper from '../model/database/RdbHelper';
import HabitRepository from '../model/repository/HabitRepository';
import { HabitItem } from '../view/component/HabitItem';
import { ProgressCircle } from '../view/component/ProgressCircle';
import RecordRepository from '../model/repository/RecordRepository';
import Category from '../common/bean/Category';
import CategoryRepository from '../model/repository/CategoryRepository';
// ğŸ†• å¼•å…¥æ‰“å¡è¾“å…¥å¼¹çª—
import { CheckInDialog } from '../view/dialog/CheckInDialog';

@Entry
@Component
struct Index {
  // === é¡µé¢çŠ¶æ€ ===
  @State habits: Array<Habit> = []; // å½“å‰æ˜¾ç¤ºçš„ä¹ æƒ¯åˆ—è¡¨
  @State todayProgress: number = 0; // ä»Šæ—¥è¿›åº¦ç™¾åˆ†æ¯”
  @State isLoading: boolean = true; // åŠ è½½çŠ¶æ€
  @State categories: Category[] = []; // åˆ†ç±»åˆ—è¡¨
  @State currentCategoryId: number = 1; // å½“å‰é€‰ä¸­çš„åˆ†ç±»IDï¼Œé»˜è®¤1(å…¨éƒ¨)
  @State allHabitsCache: Habit[] = []; // æœ¬åœ°ç¼“å­˜æ‰€æœ‰ä¹ æƒ¯
  // ğŸ†• è®°å½•å½“å‰æ­£åœ¨æ“ä½œçš„ä¹ æƒ¯ (ä¸ºäº†ä¼ ç»™å¼¹çª—)
  @State currentOperatingHabit: Habit | null = null;
  // ğŸ†• å®šä¹‰æ‰“å¡å¼¹çª—æ§åˆ¶å™¨
  checkInDialogController: CustomDialogController = new CustomDialogController({
    builder: CheckInDialog({
      onConfirm: (mood: number, note: string) => {
        // å¼¹çª—ç¡®è®¤åçš„å›è°ƒ
        if (this.currentOperatingHabit) {
          this.executeCheckIn(this.currentOperatingHabit, mood, note);
        }
      }
    }),
    alignment: DialogAlignment.Center,
    customStyle: true
  });

  // é¡µé¢æ˜¾ç¤ºæ—¶è§¦å‘ (åŒ…æ‹¬ä»ç¼–è¾‘é¡µè¿”å›)
  onPageShow() {
    this.initSystem();
  }

  // åˆå§‹åŒ–ç³»ç»Ÿ
  async initSystem() {
    const context = getContext(this);
    // 1. åˆå§‹åŒ–æ•°æ®åº“
    await RdbHelper.initRdb(context);

    // 2. åŠ è½½åˆ†ç±»æ•°æ®
    this.categories = await CategoryRepository.queryAll();

    // 3. åˆ·æ–°ä¹ æƒ¯åˆ—è¡¨æ•°æ®
    this.refreshData();
  }

  // åˆ·æ–°æ•°æ®çš„æ ¸å¿ƒæ–¹æ³•
  refreshData() {
    this.isLoading = true;
    // å¹¶è¡ŒæŸ¥è¯¢ï¼šæ‰€æœ‰ä¹ æƒ¯ + ä»Šæ—¥æ‰“å¡è®°å½•ID + ä»Šæ—¥æ‰“å¡æ¬¡æ•°Map
    Promise.all([
      HabitRepository.queryAll(),
      RecordRepository.getTodayCompletedIds(),
      RecordRepository.getTodayCompletedNums()
    ]).then((results: Object[]) => {

      // å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œè§£å†³ç¼–è¯‘æŠ¥é”™
      let allHabits = results[0]! as Habit[];
      let completedNums = results[2]! as Map<number, number>;

      // 1. æ ‡è®°è¿›åº¦å’Œå®ŒæˆçŠ¶æ€
      allHabits.forEach(habit => {
        // ä» Map ä¸­è·å–å½“å‰æ‰“å¡æ¬¡æ•°ï¼Œæ²¡æœ‰åˆ™ä¸º 0
        habit.currentCount = completedNums.get(habit.id) || 0;
        // åˆ¤æ–­æ ‡å‡†ï¼šå½“å‰æ¬¡æ•° >= ç›®æ ‡æ¬¡æ•°
        habit.isChecked = habit.currentCount >= habit.targetCount;
      });

      // 2. å­˜å…¥ç¼“å­˜æ± 
      this.allHabitsCache = allHabits;

      // 3. è§¦å‘ç­›é€‰å’Œè¿›åº¦è®¡ç®—
      this.filterHabits();

      this.isLoading = false;
    }).catch((err: Error) => {
      console.error('[Index] åˆ·æ–°å¤±è´¥: ' + JSON.stringify(err));
      this.isLoading = false;
    });
  }

  // ğŸ” ç­›é€‰é€»è¾‘
  filterHabits() {
    if (this.currentCategoryId === 1) {
      this.habits = this.allHabitsCache;
    } else {
      this.habits = this.allHabitsCache.filter(h => h.categoryId === this.currentCategoryId);
    }
    this.calculateProgress();
  }

  // ğŸ“Š è®¡ç®—è¿›åº¦
  calculateProgress() {
    let validFinishedCount = this.habits.filter(h => h.isChecked).length;
    let totalCount = this.habits.length;

    if (totalCount > 0) {
      this.todayProgress = (validFinishedCount / totalCount) * 100;
    } else {
      this.todayProgress = 0;
    }
  }

  // âœ… æ‰“å¡é€»è¾‘ (æ”¯æŒå¤šæ¬¡æ‰“å¡)
  // ä¿®æ”¹ï¼šç‚¹å‡»ä¸å†ç›´æ¥æ‰“å¡ï¼Œè€Œæ˜¯æ‰“å¼€å¼¹çª—
  createRecord(habit: Habit) {
    if (habit.isChecked) {
      // å¦‚æœå·²ç»è¾¾æ ‡ï¼Œé€šå¸¸ä¸å†æ‰“å¡ï¼Œæˆ–è€…ä½ å¯ä»¥å…è®¸ç»§ç»­æ‰“
      return;
    }
    // ğŸ†• è®¾ç½®å½“å‰ä¹ æƒ¯å¹¶æ‰“å¼€å¼¹çª—
    this.currentOperatingHabit = habit;
    this.checkInDialogController.open();
  }

  // ğŸ†• çœŸæ­£æ‰§è¡Œå†™å…¥æ•°æ®åº“çš„æ–¹æ³• (ç”±å¼¹çª—å›è°ƒè°ƒç”¨)
  executeCheckIn(habit: Habit, mood: number, note: string) {
    // 1. æ’å…¥è®°å½• (å¸¦å¿ƒæƒ…å’Œå¿ƒå¾—)
    RecordRepository.createRecord(habit.id, mood, note).then(() => {
      // 2. åˆ·æ–°é¡µé¢
      this.refreshData();
    }).catch((err: Error) => {
      console.error('æ‰“å¡å¤±è´¥:' + JSON.stringify(err));
    });
  }

  // ğŸ—‘ï¸ åˆ é™¤ä¹ æƒ¯é€»è¾‘
  deleteHabit(id: number) {
    RecordRepository.deleteByHabitId(id).then(() => {
      return HabitRepository.deleteById(id);
    }).then(() => {
      this.refreshData();
    }).catch((err: Error) => {
      console.error('åˆ é™¤å¤±è´¥: ' + JSON.stringify(err));
    });
  }

  // â†©ï¸ æ’¤é”€æ‰“å¡é€»è¾‘ (åæ‚”åŠŸèƒ½)
  backoutRecord(id: number) {
    RecordRepository.deleteLatestRecord(id).then(() => {
      this.refreshData();
    }).catch((err: Error) => {
      console.error('æ’¤é”€å¤±è´¥: ' + JSON.stringify(err));
    });
  }

  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {

      // === 0. å…¨å±€èƒŒæ™¯ (æ¸…æ–°è“ç™½æ¸å˜) ===
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [
            ['#FFFFFF', 0.0], // é¡¶éƒ¨ç™½
            ['#F0F4FF', 0.5], // ä¸­é—´æ·¡è“
            ['#E6F2FF', 1.0]// åº•éƒ¨è“
          ]
        })

      Column() {
        // === 1. é¡¶éƒ¨æ ‡é¢˜æ  ===
        Row() {
          // å·¦ä¾§ï¼šè®¾ç½®æŒ‰é’®
          Button({ type: ButtonType.Circle }) {
            Text('âš™ï¸').fontSize(24)
          }
          .width(48)
          .height(48)
          .backgroundColor('#FFFFFF')
          .shadow({ radius: 8, color: '#1A000000', offsetY: 2 })
          .margin({ right: 12 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/SettingPage' });
          })

          // ä¸­é—´ï¼šæ ‡é¢˜
          Column() {
            Text(CommonConstants.HOME_TITLE)
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')

            Text(DateUtil.formatDate(DateUtil.now()))
              .fontSize(14)
              .fontColor('#888')
              .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)

          Blank()

          // å³ä¾§ï¼šç»Ÿè®¡æŒ‰é’®
          Button({ type: ButtonType.Circle }) {
            Text('ğŸ“Š').fontSize(22)
          }
          .width(48)
          .height(48)
          .backgroundColor('#FFFFFF')
          .shadow({ radius: 8, color: '#1A000000', offsetY: 2 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/StatsPage' });
          })
        }
        .width('100%')
        .padding({
          left: 24,
          right: 24,
          top: 20,
          bottom: 10
        })
        .alignItems(VerticalAlign.Center)

        // === 2. åˆ†ç±» Tab æ  (èƒ¶å›Šæ ·å¼) ===
        List({ space: 12 }) {
          ForEach(this.categories, (item: Category) => {
            ListItem() {
              Text(item.name)
                .fontSize(14)
                .fontWeight(this.currentCategoryId === item.id ? FontWeight.Bold : FontWeight.Medium)
                .fontColor(this.currentCategoryId === item.id ? Color.White : '#666')
                .backgroundColor(this.currentCategoryId === item.id ? '#333333' : '#FFFFFF')
                .padding({
                  left: 20,
                  right: 20,
                  top: 8,
                  bottom: 8
                })
                .borderRadius(20)
                .shadow({ radius: this.currentCategoryId === item.id ? 4 : 0, color: '#33000000', offsetY: 2 })
                .onClick(() => {
                  this.currentCategoryId = item.id;
                  this.filterHabits();
                })
                .animation({ duration: 300 })
            }
          })
        }
        .listDirection(Axis.Horizontal)
        .width('100%')
        .height(60)
        .padding({ left: 24, right: 24 })
        .scrollBar(BarState.Off)

        // === 3. ä»ªè¡¨ç›˜åŒºåŸŸ ===
        Row() {
          ProgressCircle({
            percent: this.todayProgress,
            color: '#007DFF'
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding({ top: 10, bottom: 20 })

        // === 4. ä¹ æƒ¯åˆ—è¡¨åŒºåŸŸ ===
        if (this.isLoading) {
          Column() {
            LoadingProgress().width(40).height(40).color('#007DFF')
            Text('åŠ è½½ä¸­...').fontSize(14).fontColor('#999').margin({ top: 10 })
          }
          .width('100%').margin({ top: 50 })
        } else if (this.habits.length === 0) {
          Column() {
            Text('ğŸƒ').fontSize(60).opacity(0.3)
            Text('è¿˜æ²¡æœ‰ä¹ æƒ¯ï¼Œå¿«å»åˆ›å»ºä¸€ä¸ªå§ï¼')
              .fontSize(14).fontColor('#999').margin({ top: 10 })
          }
          .width('100%').margin({ top: 50 })
        } else {
          List({ space: 16 }) {
            ForEach(this.habits, (item: Habit) => {
              ListItem() {
                HabitItem({
                  habit: item,
                  // ğŸ”´ é€‚é… HabitItem ç»„ä»¶çš„å›è°ƒ
                  clickDelete: (id: number) => {
                    this.deleteHabit(id);
                  },

                  // æ‰“å¡å›è°ƒ (ç‚¹å‡»å³ä¾§åœ†åœˆ)
                  onCheckIn: () => {
                    this.createRecord(item);
                  },

                  // ğŸ†• é€‚é…æ–°é¡µé¢ï¼šç‚¹å‡»å·¦ä¾§è·³è½¬è¯¦æƒ…é¡µ
                  clickToEdit: () => {
                    router.pushUrl({
                      url: 'pages/HabitDetailPage',
                      params: { habitId: item.id }
                    });
                  },

                  // â†©ï¸ æ’¤é”€å›è°ƒ (é•¿æŒ‰æŒ‰é’®)
                  clickBackout: (id: number) => {
                    this.backoutRecord(id);
                  }
                })
              }
            }, (item: Habit) => JSON.stringify(item))
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 24, right: 24, bottom: 100 }) // åº•éƒ¨ç•™ç™½ç»™æŒ‰é’®
          .scrollBar(BarState.Off)
        }
      }
      .width('100%')
      .height('100%')

      // === 5. æ‚¬æµ®æ·»åŠ æŒ‰é’® (æ¸å˜è‰²) ===
      Button({ type: ButtonType.Circle, stateEffect: true }) {
        Text('+')
          .fontSize(36)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 2 })
      }
      .width(64)
      .height(64)
      .linearGradient({
        angle: 135,
        colors: [['#007DFF', 0.0], ['#005BBB', 1.0]]
      })
      .shadow({ radius: 10, color: '#4D007DFF', offsetY: 5 })
      .margin({ right: 24, bottom: 36 })
      .onClick(() => {
        try {
          router.pushUrl({ url: 'pages/HabitEditPage' });
        } catch (err) {
          console.error("è·¯ç”±è·³è½¬é”™è¯¯: " + JSON.stringify(err));
        }
      })

    }
    .width('100%')
    .height('100%')
  }
}