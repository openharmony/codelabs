/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import Habit from '../common/bean/Habit';
import { ThemeColorPicker } from '../view/component/ColorPicker';
import HabitRepository from '../model/repository/HabitRepository';
import Category from '../common/bean/Category';
import CategoryRepository from '../model/repository/CategoryRepository';
import { CategoryDialog } from '../view/component/CategoryDialog';
import { ReminderHelper } from '../model/ReminderHelper';

@Entry
@Component
struct HabitEditPage {
  // === ç¼–è¾‘æ¨¡å¼çŠ¶æ€ ===
  @State editHabitId: number = -1; // å¦‚æœå¤§äº0ï¼Œè¯´æ˜æ˜¯ç¼–è¾‘æ¨¡å¼
  @State oldReminderId: number = -1; // è®°å½•æ—§çš„é—¹é’ŸIDï¼Œç”¨äºå–æ¶ˆ
  // === è¡¨å•çŠ¶æ€ ===
  @State habitName: string = '';
  @State targetCount: string = '1';
  @State selectedColor: string = '#FF5733';
  @State isSubmitting: boolean = false;
  // åˆ†ç±»çŠ¶æ€
  @State categories: Category[] = [];
  @State selectedCategoryId: number = 2;
  // æé†’çŠ¶æ€
  @State isReminderOn: boolean = false;
  @State reminderTime: Date = new Date('2023-01-01T08:00:00');
  dialogController: CustomDialogController = new CustomDialogController({
    builder: CategoryDialog({
      confirm: (text: string) => {
        this.addCategory(text);
      }
    }),
    alignment: DialogAlignment.Center,
    autoCancel: true
  });

  aboutToAppear() {
    this.refreshCategories();

    // ğŸ•µï¸â€â™‚ï¸ æ£€æŸ¥æ˜¯å¦æœ‰ä¼ è¿‡æ¥çš„ ID (ç¼–è¾‘æ¨¡å¼)
    const params = router.getParams() as Record<string, Object>;
    if (params && params['habitId']) {
      this.editHabitId = params['habitId'] as number;
      this.loadHabitDetail(this.editHabitId);
    }
  }

  // åŠ è½½è¯¦æƒ…å¹¶å›æ˜¾
  async loadHabitDetail(id: number) {
    let habit = await HabitRepository.queryById(id);
    if (habit) {
      this.habitName = habit.name;
      this.targetCount = habit.targetCount.toString();
      this.selectedColor = habit.color;
      this.selectedCategoryId = habit.categoryId;
      this.oldReminderId = habit.reminderId; // è®°ä½æ—§é—¹é’Ÿ

      // å›æ˜¾æé†’æ—¶é—´
      if (habit.reminderTime && habit.reminderTime.length > 0) {
        this.isReminderOn = true;
        // è§£æ "08:30"
        let parts = habit.reminderTime.split(':');
        if (parts.length === 2) {
          let d = new Date();
          d.setHours(parseInt(parts[0]), parseInt(parts[1]));
          this.reminderTime = d;
        }
      }
    }
  }

  refreshCategories() {
    CategoryRepository.queryAll().then(list => {
      this.categories = list.filter(c => c.id !== 1);
      if (this.categories.length > 0 && this.selectedCategoryId === 1 && this.editHabitId === -1) {
        this.selectedCategoryId = this.categories[0].id;
      }
    });
  }

  addCategory(name: string) {
    const randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16);
    CategoryRepository.insert(name, randomColor).then((newId) => {
      this.refreshCategories();
      setTimeout(() => {
        this.selectedCategoryId = newId;
      }, 100);
    });
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('<').fontSize(26).fontWeight(FontWeight.Bold).fontColor('#333').margin({ bottom: 2 })
        }
        .width(40).height(40).backgroundColor('#F5F5F5')
        .onClick(() => {
          router.back();
        })

        // åŠ¨æ€æ ‡é¢˜ï¼šç¼–è¾‘è¿˜æ˜¯æ–°å»ºï¼Ÿ
        Text(this.editHabitId > 0 ? "ç¼–è¾‘ä¹ æƒ¯" : "æ–°å»ºä¹ æƒ¯")
          .fontSize(20).fontWeight(FontWeight.Bold).margin({ left: 10 })
      }
      .width('100%').padding(15).backgroundColor('#FFFFFF')
      .shadow({ radius: 2, color: '#0F000000', offsetY: 1 })

      // 2. è¡¨å•ä¸»ä½“
      Scroll() {
        Column({ space: 24 }) {

          Column() {
            this.InputGroup("ä¹ æƒ¯åç§°", "ä¾‹å¦‚ï¼šæ¯å¤©æ™¨è·‘ 3 å…¬é‡Œ", (val) => {
              this.habitName = val;
            })
          }
          .width('100%')
          .onClick(() => {
            // è¿™ä¸ªç©ºçš„ç‚¹å‡»äº‹ä»¶æ˜¯ä¸ºäº†è§£å†³æŸäº›æƒ…å†µä¸‹çš„ç„¦ç‚¹é—®é¢˜ (Hack)
          })

          // æ³¨æ„ï¼šInputGroup éœ€è¦åœ¨ build ä¸‹é¢å®šä¹‰ï¼Œè¿™é‡Œç›´æ¥ç”¨ TextInput ä¹Ÿè¡Œï¼Œä¸ºäº†å¤ç”¨ä¹‹å‰çš„ InputGroup Builder
          Column() {
            Text("æ¯æ—¥ç›®æ ‡æ¬¡æ•°").fontSize(14).fontColor('#666').width('100%').margin({ bottom: 8 })
            TextInput({ placeholder: "ä¾‹å¦‚ï¼š1", text: this.targetCount }) // ç»‘å®š text å®ç°å›æ˜¾
              .type(InputType.Number)
              .height(50)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .padding({ left: 16, right: 16 })
              .border({ width: 1, color: '#E0E0E0' })
              .onChange((val) => {
                this.targetCount = val;
              })
          }

          // åˆ†ç±»é€‰æ‹©å™¨
          Column() {
            Text("æ‰€å±åˆ†ç±»").fontSize(14).fontColor('#666').width('100%').margin({ bottom: 8 })
            Flex({ wrap: FlexWrap.Wrap }) {
              ForEach(this.categories, (item: Category) => {
                Text(item.name)
                  .fontSize(14)
                  .fontColor(this.selectedCategoryId === item.id ? Color.White : '#666')
                  .backgroundColor(this.selectedCategoryId === item.id ? item.color : '#F0F0F0')
                  .padding({
                    left: 16,
                    right: 16,
                    top: 8,
                    bottom: 8
                  })
                  .borderRadius(20)
                  .margin({ right: 10, bottom: 10 })
                  .onClick(() => {
                    this.selectedCategoryId = item.id;
                  })
              }, (item: Category) => JSON.stringify(item))

              Text('+')
                .fontSize(16)
                .fontColor('#007DFF')
                .backgroundColor('#E6F2FF')
                .padding({
                  left: 20,
                  right: 20,
                  top: 8,
                  bottom: 8
                })
                .borderRadius(20)
                .margin({ bottom: 10 })
                .border({ width: 1, color: '#007DFF', style: BorderStyle.Dashed })
                .onClick(() => {
                  this.dialogController.open();
                })
            }
          }

          // æé†’è®¾ç½®
          Column() {
            Row() {
              Text("æ¯æ—¥æé†’").fontSize(14).fontColor('#666')
              Blank()
              Toggle({ type: ToggleType.Switch, isOn: this.isReminderOn })
                .onChange((isOn) => {
                  this.isReminderOn = isOn;
                })
            }
            .width('100%').margin({ bottom: this.isReminderOn ? 10 : 20 })

            if (this.isReminderOn) {
              Row() {
                Column() {
                  Text("æé†’æ—¶é—´").fontSize(14).fontColor('#999').margin({ bottom: 8 })
                  Text(`${this.reminderTime.getHours().toString().padStart(2, '0')}ç‚¹${this.reminderTime.getMinutes()
                    .toString()
                    .padStart(2, '0')}åˆ†`)
                    .fontSize(32).fontColor('#007DFF').fontWeight(FontWeight.Bold)
                }
                .alignItems(HorizontalAlign.Start).layoutWeight(1)

                Column() {
                  Row() {
                    Text('æ—¶').fontSize(12).fontColor('#999').textAlign(TextAlign.Center).layoutWeight(1)
                    Text('åˆ†').fontSize(12).fontColor('#999').textAlign(TextAlign.Center).layoutWeight(1)
                  }
                  .width(140)

                  TimePicker({ selected: this.reminderTime })
                    .useMilitaryTime(true).height(100).width(140)
                    .onChange((date: TimePickerResult) => {
                      let d = new Date();
                      d.setHours(date.hour, date.minute);
                      this.reminderTime = d;
                    })
                }
              }
              .width('100%')
              .padding(20)
              .backgroundColor(Color.White)
              .borderRadius(16)
              .margin({ bottom: 20 })
              .shadow({ radius: 4, color: '#1A000000', offsetY: 2 })
              .alignItems(VerticalAlign.Center)
            }
          }

          // é¢œè‰²é€‰æ‹©å™¨
          ThemeColorPicker({ selectedColor: $selectedColor })

          // æäº¤æŒ‰é’®
          Button(this.isSubmitting ? "æ­£åœ¨ä¿å­˜..." : (this.editHabitId > 0 ? "ä¿å­˜ä¿®æ”¹" : "åˆ›å»ºä¹ æƒ¯"))
            .width('100%')
            .height(50)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .backgroundColor(this.selectedColor)
            .margin({ top: 30 })
            .enabled(!this.isSubmitting)
            .onClick(() => {
              this.submitForm();
            })

        }
        .padding(20).width('100%')
      }
      .layoutWeight(1).scrollBar(BarState.Off)
    }
    .height('100%').backgroundColor('#F1F3F5')
  }

  // è¿™é‡Œçš„ InputGroup ç”¨äºä¹ æƒ¯åç§°çš„å¤ç”¨
  @Builder
  InputGroup(title: string, placeholder: string, onChange: (val: string) => void) {
    Column() {
      Text(title).fontSize(14).fontColor('#666666').width('100%').margin({ bottom: 8 })
      TextInput({ placeholder: placeholder, text: this.habitName }) // ç»‘å®š text å›æ˜¾
        .height(50)
        .fontSize(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .padding({ left: 16, right: 16 })
        .border({ width: 1, color: '#E0E0E0' })
        .onChange((value: string) => {
          onChange(value);
        })
    }
  }

  async submitForm() {
    if (this.isSubmitting) {
      return;
    }
    if (this.habitName.trim().length === 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥ä¹ æƒ¯åç§°' });
      return;
    }
    let count = parseInt(this.targetCount);
    if (isNaN(count) || count <= 0) {
      promptAction.showToast({ message: 'ç›®æ ‡æ¬¡æ•°å¿…é¡»å¤§äº 0' });
      return;
    }

    this.isSubmitting = true;

    // 1. å‡†å¤‡æ•°æ®å¯¹è±¡
    let habit = new Habit(this.habitName, this.selectedColor, count, this.selectedCategoryId);

    // 2. å¤„ç†æé†’é€»è¾‘
    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä¸”ä¹‹å‰æœ‰é—¹é’Ÿï¼Œå…ˆæŠŠæ—§çš„å…³æ‰
    if (this.editHabitId > 0 && this.oldReminderId > 0) {
      await ReminderHelper.cancelReminder(this.oldReminderId);
      habit.reminderId = -1;
      habit.reminderTime = '';
    }

    if (this.isReminderOn) {
      let hour = this.reminderTime.getHours();
      let minute = this.reminderTime.getMinutes();
      habit.reminderTime = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
      try {
        let newId = await ReminderHelper.publishReminder(this.habitName, hour, minute);
        habit.reminderId = newId;
      } catch (e) {
        console.error("æ³¨å†Œæé†’å¤±è´¥");
      }
    }

    try {
      if (this.editHabitId > 0) {
        // ğŸš¨ ç¼–è¾‘æ¨¡å¼ï¼šè°ƒç”¨ Update
        habit.id = this.editHabitId;
        await HabitRepository.update(habit);
        promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸ' });
      } else {
        // âœ¨ æ–°å»ºæ¨¡å¼ï¼šè°ƒç”¨ Insert
        await HabitRepository.insert(habit);
        promptAction.showToast({ message: 'åˆ›å»ºæˆåŠŸ' });
      }
      router.back();
    } catch (err) {
      console.error("ä¿å­˜å¤±è´¥: " + JSON.stringify(err));
      this.isSubmitting = false;
    }
  }
}