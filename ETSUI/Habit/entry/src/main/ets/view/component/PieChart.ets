export class PieData {
  name: string;
  count: number;
  color: string;

  constructor(name: string, count: number, color: string) {
    this.name = name;
    this.count = count;
    this.color = color;
  }
}

@Component
export struct PieChart {
  @Prop @Watch('onDataChange') data: PieData[];

  private settings: RenderingContextSettings = new RenderingContextSettings(true);
  private context: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.settings);

  onDataChange() {
    this.draw(); // æ•°æ®å˜äº†é‡ç”»
  }

  build() {
    Column() {
      Text("ä¹ æƒ¯å æ¯”åˆ†æ")
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .width('100%')
        .margin({ bottom: 10 })

      Row() {
        // å·¦ä¾§ï¼šç”»å¸ƒ
        Canvas(this.context)
          .width(140)
          .height(140)
          .onReady(() => {
            this.draw();
          })

        // å³ä¾§ï¼šå›¾ä¾‹ (Legend)
        Column({ space: 8 }) {
          ForEach(this.data, (item: PieData) => {
            Row() {
              // 1. é¢œè‰²åœ†ç‚¹
              Circle({ width: 8, height: 8 }).fill(item.color)

              // 2. æ ‡ç­¾åç§°
              Text(item.name)
                .fontSize(12)
                .fontColor('#666')
                .margin({ left: 6 })

              // ğŸ”´ ä¿®æ”¹ç‚¹ï¼šåˆ é™¤äº† Blank()ï¼Œé˜²æ­¢ä¸¤ç«¯å¯¹é½

              // 3. å…·ä½“æ•°é‡ (å¢åŠ å·¦è¾¹è·ï¼Œä¿æŒé€‚å½“é—´éš”)
              Text(item.count.toString())
                .fontSize(12)
                .fontWeight(FontWeight.Bold)
                .margin({ left: 12 }) // ğŸ‘ˆ è¿™é‡Œçš„ 12 å¯ä»¥æ ¹æ®å–œå¥½è°ƒæ•´
            }
            .width('100%')
            // é»˜è®¤å¯¹é½æ–¹å¼å°±æ˜¯ FlexAlign.Start (ä»å·¦åˆ°å³ç´§æŒ¨ç€)ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–è®¾ç½®
          })
        }
        .layoutWeight(1)
        .padding({ left: 20 })
      }
    }
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .width('100%')
  }

  // ğŸ¨ æ ¸å¿ƒç»˜å›¾é€»è¾‘ (ä¿æŒä¸å˜)
  draw() {
    // 1. è®¡ç®—æ€»æ•°
    let total = 0;
    this.data.forEach(item => total += item.count);

    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œç”»ä¸ªç°è‰²çš„åœ†
    if (total === 0) {
      this.context.clearRect(0, 0, 140, 140);
      this.context.beginPath();
      this.context.arc(70, 70, 60, 0, 2 * Math.PI);
      this.context.fillStyle = '#F0F0F0';
      this.context.fill();
      return;
    }

    // 2. å¼€å§‹ç”»æ‰‡å½¢
    let startAngle = -0.5 * Math.PI; // ä» 12 ç‚¹é’Ÿæ–¹å‘å¼€å§‹
    let centerX = 70;
    let centerY = 70;
    let radius = 60;

    this.context.clearRect(0, 0, 140, 140);

    for (let i = 0; i < this.data.length; i++) {
      let item = this.data[i];
      // è®¡ç®—è¿™ä¸ªæ‰‡å½¢å çš„å¼§åº¦
      let sliceAngle = (item.count / total) * 2 * Math.PI;
      let endAngle = startAngle + sliceAngle;

      this.context.beginPath();
      this.context.moveTo(centerX, centerY); // ç§»åŠ¨åˆ°åœ†å¿ƒ
      this.context.arc(centerX, centerY, radius, startAngle, endAngle);
      this.context.closePath();

      this.context.fillStyle = item.color;
      this.context.fill();

      // ç»™æ‰‡å½¢åŠ ä¸ªç™½è¾¹ï¼Œçœ‹èµ·æ¥æœ‰é—´éš™
      this.context.lineWidth = 2;
      this.context.strokeStyle = '#FFFFFF';
      this.context.stroke();

      startAngle = endAngle; // ä¸‹ä¸€ä¸ªæ‰‡å½¢çš„èµ·ç‚¹æ˜¯å½“å‰çš„ç»ˆç‚¹
    }

    // 3. (å¯é€‰) ç”»ä¸­é—´çš„ç™½æ´ï¼Œåšæˆç”œç”œåœˆæ•ˆæœ
    this.context.beginPath();
    this.context.arc(centerX, centerY, 30, 0, 2 * Math.PI);
    this.context.fillStyle = '#FFFFFF';
    this.context.fill();
  }
}