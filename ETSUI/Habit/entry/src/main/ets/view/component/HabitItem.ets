/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import Habit from '../../common/bean/Habit';

import { promptAction } from '@kit.ArkUI';

@Component
export struct HabitItem {
  @ObjectLink habit: Habit;
  // å®šä¹‰ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œç»™é»˜è®¤ç©ºå‡½æ•°é˜²æ­¢æŠ¥é”™

  clickDelete: (id: number) => void = (id: number) => {
  };
  onCheckIn: () => void = () => {
  };
  clickBackout: (id: number) => void = (id: number) => {
  };
  // ğŸ†• æ–°å¢ï¼šç‚¹å‡»å¡ç‰‡ä¸»ä½“çš„å›è°ƒ (å»ç¼–è¾‘)

  clickToEdit: () => void = () => {
  };

  build() {

    Row() {

      // ========= ğŸ‘ˆ å·¦ä¾§åŒºåŸŸï¼šç‚¹å‡»å»ç¼–è¾‘ =========

      Row() {

        // 1. é¢œè‰²æ¡

        Column()

          .width(6)

          .height('100%')

          .backgroundColor(this.habit.isChecked ? '#E0E0E0' : this.habit.color)

          .borderRadius({ topLeft: 16, bottomLeft: 16 })


        // 2. æ–‡å­—å†…å®¹

        Column() {

          Row() {

            Text(this.habit.name)

              .fontSize(18)

              .fontWeight(FontWeight.Bold)

              .fontColor(this.habit.isChecked ? '#999' : '#333')

              .decoration({

                type: this.habit.isChecked ? TextDecorationType.LineThrough : TextDecorationType.None,

                color: '#999'

              })

              .maxLines(1)

              .textOverflow({ overflow: TextOverflow.Ellipsis })

              .layoutWeight(1)


            if (this.habit.reminderId > 0 && !this.habit.isChecked) {

              Text('â°').fontSize(14).margin({ left: 5 })

            }

          }

          .width('100%')

          .margin({ bottom: 8 })


          Row() {

            Text(`ä»Šæ—¥å·²å®Œæˆ: ${this.habit.currentCount}/${this.habit.targetCount} æ¬¡`)

              .fontSize(12)

              .fontColor('#999')

              .backgroundColor('#F5F5F5')

              .padding({
                left: 8,
                right: 8,
                top: 2,
                bottom: 2
              })

              .borderRadius(4)


            Blank()


            if (this.habit.isChecked) {

              Text('å·²å®Œæˆ').fontSize(12).fontColor('#00CC66').fontWeight(FontWeight.Medium)

            }

          }

          .width('100%')

        }

        .layoutWeight(1) // å æ»¡ä¸­é—´ç©ºé—´

        .padding({
          left: 15,
          right: 15,
          top: 15,
          bottom: 15
        })

      }

      .layoutWeight(1) // è®©å·¦ä¾§åŒºåŸŸå æ»¡å‰©ä½™ç©ºé—´

      .height('100%')

      // ğŸ‘‡ğŸ‘‡ğŸ‘‡ å…³é”®ï¼šç¼–è¾‘äº‹ä»¶åŠ åœ¨è¿™é‡Œ (å·¦ä¾§åŒºåŸŸ)

      .onClick(() => {

        this.clickToEdit();

      })


      // ========= ğŸ‘‰ å³ä¾§åŒºåŸŸï¼šç‚¹å‡»æ‰“å¡ =========

      Column() {

        Stack() {

          if (this.habit.isChecked) {

            // === A. å·²å®ŒæˆçŠ¶æ€ ===


            // 1. ç»¿è‰²å®å¿ƒåœ†

            Circle({ width: 32, height: 32 })

              .fill('#00CC66')


            // 2. çŸ¢é‡å¯¹å‹¾ (ä¿®å¤å†™æ³•)

            Polyline() // ğŸ‘ˆ æ„é€ å‡½æ•°ç•™ç©º

              .points([[9, 16], [14, 21], [24, 11]]) // ğŸ‘ˆ points å¿…é¡»å†™åœ¨è¿™é‡Œï¼

              .fill(Color.Transparent)

              .stroke(Color.White)

              .strokeWidth(3)

              .strokeLineCap(LineCapStyle.Round)

              .strokeLineJoin(LineJoinStyle.Round)

              .width(32)

              .height(32)


          } else {

            // === B. æœªå®ŒæˆçŠ¶æ€ ===

            Circle({ width: 32, height: 32 })

              .stroke(this.habit.color)

              .strokeWidth(4)

              .fill(Color.Transparent)

          }

        }

        // åŠ¨ç”»æ›²çº¿ä¿®å¤

        .animation({

          duration: 300,

          curve: Curve.FastOutSlowIn // ğŸ‘ˆ æ”¹ç”¨æ ‡å‡†æ›²çº¿ï¼Œé˜²æ­¢æŠ¥é”™

        })

      }

      .padding({
        right: 10,
        left: 10,
        top: 20,
        bottom: 20
      })

      .onClick(() => {

        this.onCheckIn();

      })

      Button({ type: ButtonType.Circle }) {

        Text('ğŸ—‘ï¸').fontSize(16)

      }
      .width(32)
      .height(32)

      .margin({
        right: 20,
        left: 10,
        top: 20,
        bottom: 20
      })

      .backgroundColor('#FFFFFF')

      .shadow({ radius: 4, color: '#22000000', offsetY: 2 })

      .onClick(() => {

        AlertDialog.show({

          title: 'åˆ é™¤æé†’',

          message: `ç¡®å®šè¦åˆ é™¤ "${this.habit.name}" å—ï¼Ÿ\nåˆ é™¤åæ— æ³•æ¢å¤ï¼Œä¸”ä¼šæ¸…ç©ºæ‰“å¡è®°å½•ã€‚`,

          autoCancel: true,

          primaryButton: {
            value: 'å–æ¶ˆ', action: () => {
            }
          },

          secondaryButton: { value: 'ç¡®è®¤åˆ é™¤', fontColor: Color.Red, action: () => this.clickDelete(this.habit.id) }

        });

      })

    }
    .width('100%')

    .height(80)

    .backgroundColor(Color.White)

    .borderRadius(16)

    .shadow({ radius: 8, color: '#0F000000', offsetY: 4 })

    .margin({ bottom: 2 })

    .stateStyles({

      pressed: {
        .scale({ x: 0.98, y: 0.98 }).opacity(0.8)
      },

      normal: {
        .scale({ x: 1, y: 1 }).opacity(1)
      }

    })

    .gesture(

      LongPressGesture({ repeat: false })

        .onAction(async () => {

          if (this.habit.currentCount > 0) {

            AlertDialog.show({

              title: 'æ’¤é”€æé†’',

              message: `ç¡®å®šè¦æ’¤é”€ "${this.habit.name}" çš„ä¸Šä¸€æ¬¡æ‰“å¡å—ï¼Ÿ`,

              autoCancel: true,

              primaryButton: {
                value: 'ä¿ç•™', action: () => {
                }
              },

              secondaryButton: { value: 'æ’¤é”€', fontColor: Color.Red, action: () => this.clickBackout(this.habit.id) }

            });

          } else {

            promptAction.showToast({ message: 'ä»Šæ—¥æ²¡æœ‰æ‰“å¡è®°å½•ï¼Œæ— æ³•æ’¤é”€' });

          }

        })

    )

  }
}