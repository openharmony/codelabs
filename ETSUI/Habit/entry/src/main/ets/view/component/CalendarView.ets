import { DateUtil } from '../../common/utils/DateUtil';

@Component
export struct CalendarView {
  @Prop recordDates: string[] = []; // å·²æ‰“å¡çš„æ—¥æœŸåˆ—è¡¨
  private weeks: number[] = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]; // å±•ç¤º13å‘¨ï¼ˆçº¦ä¸‰ä¸ªæœˆï¼‰
  private days: number[] = [0, 1, 2, 3, 4, 5, 6]; // ä¸€å‘¨7å¤©
  // ðŸ‘‡ðŸ‘‡ðŸ‘‡ æ–°å¢žè¿™ä¸€è¡Œ ðŸ‘‡ðŸ‘‡ðŸ‘‡
  // å®šä¹‰ä¸€ä¸ªå›žè°ƒå‡½æ•°ï¼ŒæŽ¥æ”¶ç‚¹å‡»çš„æ—¥æœŸå­—ç¬¦ä¸²
  onDateClick: (date: string) => void = () => {};
  // è®¡ç®—æŸä¸ªåæ ‡ç‚¹å¯¹åº”çš„æ—¥æœŸ
  getDateByCoordinate(weekIndex: number, dayIndex: number): string {
    let date = new Date();
    // å€’æŽ¨æ—¥æœŸï¼šä»Šå¤©å¾€å‰æŽ¨ (12 - weekIndex) å‘¨ï¼Œå†æ ¹æ®æ˜ŸæœŸåç§»
    const totalDaysBack = (12 - weekIndex) * 7 + (new Date().getDay() - dayIndex);
    date.setDate(date.getDate() - totalDaysBack);
    return DateUtil.formatDate(date.getTime());
  }

  // åˆ¤æ–­è¯¥æ—¥æœŸæ˜¯å¦æ‰“å¡
  isDateChecked(weekIndex: number, dayIndex: number): boolean {
    const targetDate = this.getDateByCoordinate(weekIndex, dayIndex);
    return this.recordDates.includes(targetDate);
  }

  build() {
    Column() {
      Row() {
        Text('æœ€è¿‘ä¸‰ä¸ªæœˆæ‰“å¡åˆ†å¸ƒ').fontSize(14).fontColor('#666')
      }.width('100%').margin({ bottom: 10 })

      // çƒ­åŠ›å›¾æ ¸å¿ƒç½‘æ ¼
      Scroll() {
        Row({ space: 4 }) {
          ForEach(this.weeks, (week: number) => {
            Column({ space: 4 }) {
              ForEach(this.days, (day: number) => {
                // å¦‚æžœæ—¥æœŸè¶…è¿‡äº†ä»Šå¤©ï¼Œå°±éšè—ï¼ˆä¸æ˜¾ç¤ºæœªæ¥çš„æ–¹å—ï¼‰
                if (this.isFuture(week, day)) {
                  Rect()
                    .width(12).height(12)
                    .fill('transparent')
                } else {
                  // âœ… å…³é”®ä¿®æ”¹ï¼šåœ¨è¿™é‡Œæ·»åŠ  onClick äº‹ä»¶
                  Rect()
                    .width(12).height(12)
                    .radius(2)
                    // æ‰“å¡äº†æ·±ç»¿è‰²ï¼Œæ²¡æ‰“å¡æµ…ç°è‰²
                    .fill(this.isDateChecked(week, day) ? '#28C060' : '#EBEDF0')
                    .onClick(() => {
                      // 1. è®¡ç®—ç‚¹å‡»çš„æ—¥æœŸ
                      const dateStr = this.getDateByCoordinate(week, day);
                      // 2. è§¦å‘å›žè°ƒ
                      this.onDateClick(dateStr);
                    })
                }
              })
            }
          })
        }
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)

      // å›¾ä¾‹
      Row({ space: 8 }) {
        Text('å°‘').fontSize(10).fontColor('#999')
        Rect().width(10).height(10).fill('#EBEDF0').radius(2)
        Rect().width(10).height(10).fill('#28C060').radius(2)
        Text('å¤š').fontSize(10).fontColor('#999')
      }
      .width('100%')
      .justifyContent(FlexAlign.End)
      .margin({ top: 8 })
    }
    .padding(12)
  }

  // è¾…åŠ©å‡½æ•°ï¼šåˆ¤æ–­åæ ‡æ—¥æœŸæ˜¯å¦åœ¨æœªæ¥
  isFuture(weekIndex: number, dayIndex: number): boolean {
    const targetStr = this.getDateByCoordinate(weekIndex, dayIndex);
    const todayStr = DateUtil.formatDate(new Date().getTime());
    return targetStr > todayStr;
  }
}