
import RdbHelper from '../database/RdbHelper';
import Habit from '../../common/bean/Habit';
import { CommonConstants } from '../../common/constants/CommonConstants';
import relationalStore from '@ohos.data.relationalStore';
import { ReminderHelper } from '../ReminderHelper';

class HabitRepository {

  // 1. æ£€æŸ¥ INSERTï¼šå­˜çš„æ—¶å€™å¸¦ä¸Š categoryId äº†å—ï¼Ÿ
  insert(habit: Habit): Promise<number> {
    const store = RdbHelper.getRdbStore();
    if (!store) return Promise.reject('æ•°æ®åº“æœªåˆå§‹åŒ–');

    const valueBucket: relationalStore.ValuesBucket = {
      name: habit.name,
      color: habit.color,
      targetCount: habit.targetCount,
      categoryId: habit.categoryId,
      // ğŸ†• æ–°å¢ä¸¤åˆ—
      reminderTime: habit.reminderTime,
      reminderId: habit.reminderId
    };

    try {
      return store.insert(CommonConstants.HABIT_TABLE_NAME, valueBucket);
    } catch (err) {
      return Promise.reject(err);
    }
  }

  async deleteById(id: number): Promise<number> {
    const store = RdbHelper.getRdbStore();
    if (!store) return Promise.reject('DB Error');

    try {
      // ğŸ›‘ åœ¨åˆ é™¤æ•°æ®åº“è®°å½•å‰ï¼Œå…ˆæŸ¥ä¸€ä¸‹è¿™ä¸ªä¹ æƒ¯æœ‰æ²¡æœ‰æé†’
      // å¦‚æœæœ‰ï¼Œè¦å…ˆè°ƒç”¨ç³»ç»ŸAPIå–æ¶ˆæ‰
      let predicates = new relationalStore.RdbPredicates(CommonConstants.HABIT_TABLE_NAME);
      predicates.equalTo('id', id);

      const resultSet = await store.query(predicates);
      if (resultSet.goToFirstRow()) {
        let reminderId = resultSet.getLong(resultSet.getColumnIndex('reminderId'));
        // å¦‚æœæœ‰æœ‰æ•ˆçš„æé†’IDï¼Œå–æ¶ˆå®ƒ
        if (reminderId && reminderId > 0) {
          await ReminderHelper.cancelReminder(reminderId);
        }
      }
      resultSet.close();

      // æ‰§è¡Œç‰©ç†åˆ é™¤
      return store.delete(predicates);
    } catch (err) {
      return Promise.reject(err);
    }
  }

  // 2. æ£€æŸ¥ QUERYï¼šå–çš„æ—¶å€™è¯»å‡ºæ¥äº†å—ï¼Ÿ(æœ€å®¹æ˜“æ¼è¿™é‡Œï¼)
  queryAll(): Promise<Array<Habit>> {
    const store = RdbHelper.getRdbStore();
    if (!store) return Promise.reject('æ•°æ®åº“æœªåˆå§‹åŒ–');

    try {
      let predicates = new relationalStore.RdbPredicates(CommonConstants.HABIT_TABLE_NAME);
      return store.query(predicates).then((resultSet) => {
        let habits: Array<Habit> = [];
        while (resultSet.goToNextRow()) {
          let habit = new Habit(
            resultSet.getString(resultSet.getColumnIndex('name')),
            resultSet.getString(resultSet.getColumnIndex('color')),
            resultSet.getLong(resultSet.getColumnIndex('targetCount'))
          );
          habit.id = resultSet.getLong(resultSet.getColumnIndex('id'));

          // è¯»å– categoryId
          try {
            let catIndex = resultSet.getColumnIndex('categoryId');
            if (catIndex >= 0) habit.categoryId = resultSet.getLong(catIndex);
          } catch (e) {}

          // ğŸ†• è¯»å– reminderTime å’Œ reminderId
          try {
            let timeIndex = resultSet.getColumnIndex('reminderTime');
            let idIndex = resultSet.getColumnIndex('reminderId');
            if (timeIndex >= 0) habit.reminderTime = resultSet.getString(timeIndex);
            if (idIndex >= 0) habit.reminderId = resultSet.getLong(idIndex);
          } catch (e) {}

          habits.push(habit);
        }
        resultSet.close();
        return habits;
      });
    } catch (err) {
      return Promise.reject(err);
    }
  }
  cleanAll(): Promise<void> {
    const store = RdbHelper.getRdbStore();
    if (!store) return Promise.reject('DB Error');

    let predicates = new relationalStore.RdbPredicates(CommonConstants.HABIT_TABLE_NAME);
    return store.delete(predicates).then(() => {
      return;
    });
  }
  /**
   * ğŸ†• æ ¹æ® ID æ›´æ–°ä¹ æƒ¯ä¿¡æ¯
   */
  update(habit: Habit): Promise<number> {
    const store = RdbHelper.getRdbStore();
    if (!store) return Promise.reject('DB Error');

    const valueBucket: relationalStore.ValuesBucket = {
      name: habit.name,
      color: habit.color,
      targetCount: habit.targetCount,
      categoryId: habit.categoryId,
      reminderTime: habit.reminderTime,
      reminderId: habit.reminderId
    };

    try {
      let predicates = new relationalStore.RdbPredicates(CommonConstants.HABIT_TABLE_NAME);
      predicates.equalTo('id', habit.id); // ğŸ‘ˆ é”å®šè¦ä¿®æ”¹çš„é‚£ä¸€è¡Œ
      return store.update(valueBucket, predicates);
    } catch (err) {
      return Promise.reject(err);
    }
  }

  /**
   * ğŸ†• æ ¹æ® ID æŸ¥è¯¢å•ä¸ªä¹ æƒ¯ (ç”¨äºå›æ˜¾)
   */
  queryById(id: number): Promise<Habit | null> {
    const store = RdbHelper.getRdbStore();
    if (!store) return Promise.reject('DB not initialized');

    try {
      let predicates = new relationalStore.RdbPredicates(CommonConstants.HABIT_TABLE_NAME);
      predicates.equalTo('id', id); // åªæŸ¥è¿™ä¸€ä¸ª

      return store.query(predicates).then((resultSet) => {
        if (resultSet.goToFirstRow()) {
          let habit = new Habit(
            resultSet.getString(resultSet.getColumnIndex('name')),
            resultSet.getString(resultSet.getColumnIndex('color')),
            resultSet.getLong(resultSet.getColumnIndex('targetCount'))
          );
          habit.id = resultSet.getLong(resultSet.getColumnIndex('id'));

          // è¡¥å…¨æ‰€æœ‰å­—æ®µ
          try {
            let catIndex = resultSet.getColumnIndex('categoryId');
            if (catIndex >= 0) habit.categoryId = resultSet.getLong(catIndex);

            let timeIndex = resultSet.getColumnIndex('reminderTime');
            let idIndex = resultSet.getColumnIndex('reminderId');
            if (timeIndex >= 0) habit.reminderTime = resultSet.getString(timeIndex);
            if (idIndex >= 0) habit.reminderId = resultSet.getLong(idIndex);
          } catch (e) {}

          resultSet.close();
          return habit;
        }
        resultSet.close();
        return null;
      });
    } catch (err) {
      return Promise.reject(err);
    }
  }
}

export default new HabitRepository();