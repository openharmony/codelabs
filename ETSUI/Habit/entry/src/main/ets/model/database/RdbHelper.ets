import relationalStore from '@ohos.data.relationalStore';
import { CommonConstants } from '../../common/constants/CommonConstants';

class RdbHelper {
  private rdbStore: relationalStore.RdbStore | null = null;

  /**
   * åˆå§‹åŒ–æ•°æ®åº“
   */
  initRdb(context: Context): Promise<void> {
    const config: relationalStore.StoreConfig = {
      name: CommonConstants.DATABASE_NAME,
      securityLevel: relationalStore.SecurityLevel.S1
    };

    return new Promise((resolve, reject) => {
      relationalStore.getRdbStore(context, config, async (err, store) => {
        if (err) {
          console.error(`[RdbHelper] åˆå§‹åŒ–å¤±è´¥: code=${err.code}, message=${err.message}`);
          reject(err);
          return;
        }

        // åˆ›å»ºè¡¨
        if (store.version === 0) {
          store.executeSql(CommonConstants.CREATE_TABLE_SQL);
          store.executeSql(CommonConstants.CREATE_RECORD_TABLE_SQL);
          store.executeSql(CommonConstants.CREATE_CATEGORY_TABLE_SQL);

          // åˆ›å»ºæˆå°±è¡¨
          store.executeSql(CommonConstants.CREATE_ACHIEVEMENT_TABLE_SQL);

          // åˆå§‹åŒ–æ•°æ®
          await this.initDefaultCategories(store);
          await this.initDefaultAchievements(store);

          store.version = 1;
        }

        this.rdbStore = store;
        console.info('[RdbHelper] æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ!');
        resolve();
      });
    });
  }

  getRdbStore(): relationalStore.RdbStore | null {
    return this.rdbStore;
  }

  private async initDefaultCategories(store: relationalStore.RdbStore): Promise<void> {
    class InitCategory {
      name: string;
      color: string;
      constructor(name: string, color: string) {
        this.name = name;
        this.color = color;
      }
    }

    const categories: InitCategory[] = [
      new InitCategory('å…¨éƒ¨', '#007DFF'),
      new InitCategory('å­¦ä¹ ', '#FF9900'),
      new InitCategory('è¿åŠ¨', '#00CC66'),
      new InitCategory('ç”Ÿæ´»', '#FF5555')
    ];

    for (const c of categories) {
      const valueBucket: relationalStore.ValuesBucket = {
        name: c.name,
        color: c.color
      };

      try {
        await store.insert(CommonConstants.CATEGORY_TABLE_NAME, valueBucket);
      } catch (err) {
        console.error(`[RdbHelper] æ’å…¥åˆ†ç±»å¤±è´¥: ${JSON.stringify(err)}`);
      }
    }
  }

  /**
   * åˆå§‹åŒ–é»˜è®¤å‹‹ç« 
   */
  private async initDefaultAchievements(store: relationalStore.RdbStore): Promise<void> {
    interface InitAchievement {
      name: string;
      icon: string;
      description: string;
      unlockCondition: string;
    }

    const achievements: InitAchievement[] = [
      // --- ç´¯è®¡é‡Œç¨‹ç¢‘ ---
      { name: 'åˆå‡ºèŒ…åº', icon: 'medal_total_3', description: 'ç´¯è®¡æ‰“å¡è¾¾åˆ° 3 å¤©ï¼Œè¿ˆå‡ºç¬¬ä¸€æ­¥', unlockCondition: 'total_3' },
      { name: 'å°è¯•ç‰›åˆ€', icon: 'medal_total_7', description: 'ç´¯è®¡æ‰“å¡è¾¾åˆ° 7 å¤©ï¼Œæ¸å…¥ä½³å¢ƒ', unlockCondition: 'total_7' },
      { name: 'åˆå…·è§„æ¨¡', icon: 'medal_total_15', description: 'ç´¯è®¡æ‰“å¡è¾¾åˆ° 15 å¤©ï¼Œå…»æˆä¹ æƒ¯', unlockCondition: 'total_15' },
      { name: 'å‡‘æ»¡æ•´æœˆ', icon: 'medal_total_30', description: 'ç´¯è®¡æ‰“å¡è¾¾åˆ° 30 å¤©ï¼Œå‡‘æ»¡æ•´æœˆ', unlockCondition: 'total_30' },
      { name: 'åšæŒä¸æ‡ˆ', icon: 'medal_total_50', description: 'ç´¯è®¡æ‰“å¡è¾¾åˆ° 50 å¤©ï¼Œæ„å¿—åšå®š', unlockCondition: 'total_50' },
      { name: 'ç™¾æ—¥ç­‘åŸº', icon: 'medal_total_100', description: 'ç´¯è®¡æ‰“å¡è¾¾åˆ° 100 å¤©ï¼Œåšå¦‚ç£çŸ³', unlockCondition: 'total_100' },
      { name: 'ç™»å³°é€ æ', icon: 'medal_total_365', description: 'ç´¯è®¡æ‰“å¡è¾¾åˆ° 365 å¤©ï¼Œå¹´åº¦éœ¸ä¸»', unlockCondition: 'total_365' },

      // --- è¿èƒœé‡Œç¨‹ç¢‘ ---
      { name: 'ä¹ æƒ¯è¾¾äºº', icon: 'medal_streak_3', description: 'è¿ç»­æ‰“å¡è¾¾åˆ° 3 å¤©ï¼Œä¿æŒåŠ¿å¤´', unlockCondition: 'streak_3' },
      { name: 'è‡ªå¾‹ç²¾è‹±', icon: 'medal_streak_7', description: 'è¿ç»­æ‰“å¡è¾¾åˆ° 7 å¤©ï¼ŒåŠ¿ä¸å¯æŒ¡', unlockCondition: 'streak_7' },
      { name: 'ä¸è´¥ä¼ è¯´', icon: 'medal_streak_15', description: 'è¿ç»­æ‰“å¡è¾¾åˆ° 15 å¤©ï¼Œç‹¬å­¤æ±‚è´¥', unlockCondition: 'streak_15' },
      { name: 'è¶…è¶Šè‡ªæˆ‘', icon: 'medal_streak_30', description: 'è¿ç»­æ‰“å¡è¾¾åˆ° 30 å¤©ï¼Œä½ å°±æ˜¯ç¥ï¼', unlockCondition: 'streak_30' },

      // ğŸ†• æ–°å¢çš„3ä¸ªè¿èƒœå‹‹ç« 
      { name: 'åšéŸ§ä¸æ‹”', icon: 'medal_streak_50', description: 'è¿ç»­æ‰“å¡è¾¾åˆ° 50 å¤©ï¼ŒåšéŸ§å¦‚é’¢', unlockCondition: 'streak_50' },
      { name: 'ç™¾ç‚¼æˆé’¢', icon: 'medal_streak_100', description: 'è¿ç»­æ‰“å¡è¾¾åˆ° 100 å¤©ï¼Œç‚‰ç«çº¯é’', unlockCondition: 'streak_100' },
      { name: 'æ°¸æ’ä¼ å¥‡', icon: 'medal_streak_365', description: 'è¿ç»­æ‰“å¡è¾¾åˆ° 365 å¤©ï¼Œåˆ›é€ ä¼ å¥‡', unlockCondition: 'streak_365' }
    ];

    for (const a of achievements) {
      const valueBucket: relationalStore.ValuesBucket = {
        name: a.name,
        icon: a.icon,
        description: a.description,
        unlockCondition: a.unlockCondition,
        isUnlocked: 0,
        unlockTime: 0
      };
      try {
        await store.insert(CommonConstants.ACHIEVEMENT_TABLE_NAME, valueBucket);
      } catch (err) {
        console.error(`[RdbHelper] æ’å…¥æˆå°±å¤±è´¥: ${JSON.stringify(err)}`);
      }
    }
  }
}

export default new RdbHelper();