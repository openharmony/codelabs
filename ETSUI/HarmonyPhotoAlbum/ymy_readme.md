搜索与分类功能开发

## 一、工作概述

作为团队成员3,我负责实现电子相册应用的**图片搜索与分类功能**。该功能是电子相册从静态展示升级为动态管理应用的核心模块之一,极大提升了用户查找和浏览图片的效率。

## 二、完成的工作内容

### 1. 核心组件开发

#### 1.1 SearchBar.ets - 搜索栏组件

**功能特性:**
- 实时搜索输入框,支持输入图片名称或标签关键词
- 集成搜索图标和清除按钮,提供良好的视觉反馈
- **防抖优化**:采用300ms防抖延迟,避免频繁触发搜索请求,提升性能
- 双向数据绑定(`@Link`),与父组件状态实时同步

**技术实现:**
```typescript
// 防抖搜索核心逻辑
private handleSearchWithDebounce(text: string) {
  if (this.debounceTimer !== -1) {
    clearTimeout(this.debounceTimer);
  }
  this.debounceTimer = setTimeout(() => {
    this.onSearch?.(text);
    this.debounceTimer = -1;
  }, this.debounceDelay);
}
```

**UI特性:**
- 圆角设计(24px),符合现代化UI风格
- 灰色背景(#F5F5F5),与整体界面协调
- 输入时显示清除按钮,方便快速重置搜索

#### 1.2 CategoryFilter.ets - 分类筛选组件

**功能特性:**
- 支持"全部"和预定义分类(风景、人物、动物、建筑、美食、生活、其他)
- 横向滚动布局,适配多分类显示
- 选中态视觉反馈:蓝色背景(#007DFF)+ 白色文字
- 平滑切换动画(200ms),提升交互体验

**技术实现:**
```typescript
aboutToAppear() {
  // 初始化分类列表:全部 + 预定义分类
  this.categories = [Constants.ALL_CATEGORY, ...Constants.CATEGORIES];
}
```

**UI特性:**
- 圆角胶囊按钮设计(16px),现代化风格
- 选中态:蓝色背景 + 白色文字
- 未选中态:浅灰背景(#E8E8E8)+ 深灰文字
- 平滑动画过渡

### 2. 页面功能集成

#### 2.1 ListPage.ets - 搜索页面改造

**核心改进:**

1. **完全数据库驱动**
    - 移除硬编码数据依赖,所有图片数据从数据库动态加载
    - 实现`aboutToAppear()`和`onPageShow()`生命周期函数,确保数据实时刷新

2. **搜索与分类联动**
   ```typescript
   // 组合搜索逻辑
   private handleSearch(keyword: string) {
     PhotoService.searchPhotosByCategoryAndKeyword(
       this.selectedCategory, 
       keyword
     ).then((photos) => {
       this.displayPhotos = photos;
       this.isLoading = false;
     });
   }
   ```

3. **三种筛选模式**
    - **仅分类筛选**:选择分类 + 无关键词 → 显示该分类所有图片
    - **全局搜索**:选择"全部" + 输入关键词 → 搜索所有分类
    - **精确筛选**:选择分类 + 输入关键词 → 在指定分类内搜索

4. **状态管理优化**
    - `isLoading`:加载状态控制
    - `displayPhotos`:动态显示图片列表
    - `selectedCategory`:当前选中分类
    - `searchText`:搜索关键词

5. **导航增强**
    - 添加Navigation组件的返回按钮
    - 工具栏提供"返回首页"快捷按钮
    - 空状态时显示"返回首页上传"引导按钮

#### 2.2 IndexPage.ets - 底部Tab导航集成

**实现的关键功能:**

1. **Tab导航架构**
   ```typescript
   Tabs({ index: this.currentTabIndex }) {
     TabContent() { this.HomeContent() }
       .tabBar(this.TabBuilder(0, '首页', '🏠'))
     
     TabContent() { /* 搜索占位页 */ }
       .tabBar(this.TabBuilder(1, '搜索', '🔍'))
   }
   ```

2. **智能跳转机制**
    - 点击"搜索"Tab自动跳转到ListPage
    - 跳转后自动切回"首页"Tab,避免UI状态错乱
    - 从ListPage返回时自动刷新数据

3. **生命周期管理**
   ```typescript
   onPageShow() {
     this.currentTabIndex = 0;  // 确保回到首页Tab
     this.refreshData();        // 刷新图片列表
   }
   ```

### 3. 数据服务层增强

#### 3.1 PhotoService.ets - 搜索功能扩展

**新增搜索方法:**

1. **searchPhotosByCategoryAndKeyword()**
    - 支持分类 + 关键词组合搜索
    - 智能SQL查询构建(支持AND/OR逻辑)
    - 搜索范围:图片名称、分类、标签

2. **搜索逻辑矩阵:**

| 分类选择 | 关键词输入 | 查询逻辑 |
|---------|----------|---------|
| 全部 | 无 | 查询所有图片 |
| 全部 | 有 | 在所有分类中搜索关键词 |
| 指定分类 | 无 | 显示该分类所有图片 |
| 指定分类 | 有 | 在该分类内搜索关键词 |

3. **SQL查询优化:**
   ```typescript
   // 情况3:既有分类又有关键词
   predicates.equalTo(Constants.COL_CATEGORY, category)
     .and()
     .beginWrap()
     .like(Constants.COL_NAME, `%${keyword}%`)
     .or()
     .like(Constants.COL_TAGS, `%${keyword}%`)
     .endWrap();
   ```

#### 3.2 Constants.ets - 常量扩展

**新增配置:**
```typescript
// 预定义分类列表
static readonly CATEGORIES: string[] = [
  '风景', '人物', '动物', '建筑', '美食', '生活', '其他'
];

// 默认分类
static readonly DEFAULT_CATEGORY: string = '其他';

// 全部分类标识
static readonly ALL_CATEGORY: string = '全部';
```

### 4. 文件路径修复

**问题修复:**
- 统一图片路径格式:`'file://' + photo.path`
- 确保图片正确显示在Grid、Swiper等组件中
- 添加占位图:`alt($r('app.media.app_icon'))`

### 5. 数据模型优化

#### PhotoModel.ets 工具方法
虽然该文件由团队成员1负责,但我为搜索功能的需求提供了详细的接口需求文档,确保数据模型支持:
- 标签数组解析(`getTagArray()`)
- 关键词匹配(`matchesKeyword()`)
- 标签检查(`hasTag()`)

---

## 三、功能使用说明

### 使用场景1:按分类浏览图片

**操作步骤:**
1. 在首页点击底部"🔍 搜索"Tab
2. 自动跳转到搜索页面
3. 点击顶部分类筛选栏,选择目标分类(如"风景")
4. 页面自动加载该分类的所有图片

**效果:**
- 图片网格动态刷新,仅显示选中分类的图片
- 选中分类按钮变为蓝色高亮
- 空状态时显示"暂无图片"提示

### 使用场景2:搜索图片

**操作步骤:**
1. 进入搜索页面
2. 点击顶部搜索框,输入关键词(如"旅行")
3. 输入时自动触发搜索(300ms防抖)
4. 搜索结果实时显示在网格中

**搜索范围:**
- 图片名称(如"IMG_旅行_001")
- 图片标签(如"#旅行 #开心")
- 图片分类(如"风景")

**搜索技巧:**
- 支持模糊匹配(如搜索"旅"可以匹配"旅行")
- 支持多标签搜索(如"#旅行"或"旅行")
- 点击搜索框右侧"✖"按钮快速清除搜索

### 使用场景3:精确筛选

**操作步骤:**
1. 进入搜索页面
2. 先选择分类(如"人物")
3. 再输入关键词(如"家人")
4. 系统在"人物"分类内搜索包含"家人"的图片

**效果:**
- 双重筛选条件同时生效
- 结果更精准,提高查找效率

### 使用场景4:返回首页

**三种返回方式:**
1. **系统返回键**:点击左上角"←"返回首页
2. **工具栏按钮**:点击底部工具栏"返回首页"按钮
3. **空状态引导**:数据库无图片时,点击"返回首页上传"按钮

### 使用场景5:查看图片详情

**操作步骤:**
1. 在搜索结果中点击任意图片
2. 自动跳转到详情页,支持放大缩小和左右滑动切换
3. 从详情页返回时,搜索页自动刷新数据

---

## 四、技术亮点

### 1. 性能优化
- **防抖搜索**:避免频繁数据库查询,提升响应速度
- **懒加载**:Grid组件设置`cachedCount(10)`,优化滚动性能
- **SQL优化**:使用`beginWrap()`和`endWrap()`构建高效查询

### 2. 用户体验
- **平滑动画**:分类切换、搜索框交互均有200-300ms过渡动画
- **实时反馈**:加载状态显示LoadingProgress组件
- **空状态引导**:无数据时提供清晰的操作指引

### 3. 代码质量
- **组件化设计**:SearchBar和CategoryFilter独立封装,可复用
- **状态管理**:使用`@Link`双向绑定,确保数据一致性
- **错误处理**:所有数据库操作均有try-catch和Promise.catch()

### 4. 可维护性
- **日志追踪**:关键操作均有`console.info()`日志输出
- **常量管理**:分类列表等配置集中在Constants.ets
- **接口设计**:PhotoService提供清晰的搜索API

---

## 五、测试用例

### 测试用例1:搜索功能
- **输入**:关键词"旅行"
- **预期**:显示所有名称或标签包含"旅行"的图片
- **实际**:✅ 通过

### 测试用例2:分类筛选
- **输入**:选择"风景"分类
- **预期**:仅显示分类为"风景"的图片
- **实际**:✅ 通过

### 测试用例3:组合筛选
- **输入**:分类"人物" + 关键词"家人"
- **预期**:显示"人物"分类中包含"家人"的图片
- **实际**:✅ 通过

### 测试用例4:空状态处理
- **输入**:搜索不存在的关键词"XXXXXX"
- **预期**:显示"暂无图片"提示
- **实际**:✅ 通过

### 测试用例5:返回导航
- **操作**:从搜索页返回首页
- **预期**:首页Tab选中,数据刷新
- **实际**:✅ 通过

---

## 六、协作与集成

### 与团队成员1协作
- **数据模型定义**:明确PhotoModel需要支持的搜索字段
- **数据库服务**:配合完成PhotoService的搜索方法开发
- **SQL优化**:共同优化查询性能

### 与团队成员2协作
- **图片路径格式**:统一使用`file://`前缀
- **上传后刷新**:确保新上传图片可被搜索到

### 与团队成员4协作
- **组件集成**:SearchBar和CategoryFilter组件的样式统一
- **动画配合**:搜索结果加载时的过渡效果协调

---

## 七、后续优化建议

1. **搜索历史记录**:保存用户最近搜索的关键词
2. **热门标签推荐**:展示使用频率最高的标签
3. **高级筛选**:支持按时间范围、图片大小等条件筛选
4. **搜索结果排序**:支持按时间、名称、相关度排序
5. **语音搜索**:集成语音识别API,支持语音输入关键词

---

## 八、总结

通过本次开发工作,我成功实现了电子相册应用的**搜索与分类功能**,核心成果包括:

- ✅ 开发了SearchBar和CategoryFilter两个核心组件
- ✅ 改造ListPage支持动态数据加载和多条件筛选
- ✅ 集成底部Tab导航,实现首页与搜索页的无缝切换
- ✅ 扩展PhotoService数据层,支持复杂的组合查询
- ✅ 实现防抖优化、状态管理、错误处理等技术细节

该功能模块已完全满足需求文档要求,并通过了全部测试用例,为用户提供了高效、流畅的图片查找体验,是电子相册应用从静态展示升级为动态管理系统的关键里程碑。