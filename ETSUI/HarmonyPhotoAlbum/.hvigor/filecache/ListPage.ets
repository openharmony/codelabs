/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/*
 * ä¿®å¤åŽçš„ ListPage.ets
 * å¼ºåˆ¶ä½¿ç”¨æ•°æ®åº“æ•°æ®ï¼Œæ˜¾ç¤ºæœç´¢æ å’Œåˆ†ç±»ç­›é€‰
 * âœ… æ”¯æŒè¿”å›žé¦–é¡µåŠŸèƒ½
 */

import router from '@ohos.router';
import Constants from '../common/constants/Constants';
import { SearchBar } from '../components/SearchBar';
import { CategoryFilter } from '../components/CategoryFilter';
import PhotoService from '../service/PhotoService';
import { PhotoModel } from '../model/PhotoModel';
import { LazyImage } from '../components/LazyImage';
import Logger from '../common/utils/Logger';

@Entry
@Component
struct ListPage {
  // çŠ¶æ€å˜é‡
  @State searchText: string = '';
  @State selectedCategory: string = Constants.ALL_CATEGORY;
  @State displayPhotos: PhotoModel[] = [];
  @State isLoading: boolean = true;
  @StorageLink('selectedIndex') selectedIndex: number = 0;

  // ==========================================
  // ðŸ”§ ä¿®å¤ï¼šç›´æŽ¥ä½¿ç”¨æ•°æ®åº“æ•°æ®
  // ==========================================
  aboutToAppear() {
    console.info('[ListPage] ========== é¡µé¢åŠ è½½å¼€å§‹ ==========');
    this.loadPhotos();
  }

  // ==========================================
  // ðŸ†• é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®ï¼ˆä»Žè¯¦æƒ…é¡µè¿”å›žæ—¶ï¼‰
  // ==========================================
  onPageShow() {
    console.info('[ListPage] é¡µé¢æ˜¾ç¤ºï¼Œåˆ·æ–°æ•°æ®');
    this.loadPhotos();
  }

  build() {
    Navigation() {
      Column() {
        // ==========================================
        // âœ… æœç´¢æ ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
        // ==========================================
        SearchBar({
          searchText: $searchText,
          onSearch: (text: string) => {
            console.info(`[ListPage] æœç´¢å…³é”®è¯: ${text}`);
            this.handleSearch(text);
          }
        })
          .margin({ left: 16, right: 16 })

        // ==========================================
        // âœ… åˆ†ç±»ç­›é€‰ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
        // ==========================================
        CategoryFilter({
          selectedCategory: $selectedCategory,
          onCategoryChange: (category: string) => {
            console.info(`[ListPage] åˆ‡æ¢åˆ†ç±»: ${category}`);
            this.handleCategoryChange(category);
          }
        })

        // ==========================================
        // å›¾ç‰‡ç½‘æ ¼
        // ==========================================
        if (this.isLoading) {
          this.LoadingView();
        } else if (this.displayPhotos.length > 0) {
          this.PhotoGrid();
        } else {
          this.EmptyView();
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8F8F8')
    }
    .title(Constants.PAGE_TITLE)
    .hideBackButton(false) // âœ… æ˜¾ç¤ºè¿”å›žæŒ‰é’®ï¼ˆç³»ç»Ÿé»˜è®¤è¿”å›žåˆ°ä¸Šä¸€é¡µï¼‰
    .titleMode(NavigationTitleMode.Mini)
    // ==========================================
    // ðŸ†• æ·»åŠ å·¥å…·æ æŒ‰é’®ï¼ˆæä¾›é¢å¤–çš„è¿”å›žæ–¹å¼ï¼‰
    // ==========================================
    .toolbarConfiguration([
      {
        value: 'è¿”å›žé¦–é¡µ',
        action: () => {
          console.info('[ListPage] å·¥å…·æ -è¿”å›žé¦–é¡µ');
          router.back();
        }
      }
    ])
  }

  // ==========================================
  // å›¾ç‰‡ç½‘æ ¼
  // ==========================================
  @Builder
  PhotoGrid() {
    Grid() {
      ForEach(this.displayPhotos, (photo: PhotoModel, index: number) => {
        GridItem() {
          this.PhotoItem(photo, index);
        }
        .width(Constants.FULL_PERCENT)
        .aspectRatio(1)
      }, (photo: PhotoModel) => photo.id.toString())
    }
    .columnsTemplate(Constants.GRID_COLUMNS_TEMPLATE)
    .rowsGap(Constants.LIST_ITEM_SPACE)
    .columnsGap(Constants.LIST_ITEM_SPACE)
    .layoutWeight(1)
    .cachedCount(10)
  }

  @Builder
  PhotoItem(photo: PhotoModel, index: number) {
    Stack({ alignContent: Alignment.BottomStart }) {
      // å›¾ç‰‡ - ðŸ”§ ä¿®å¤ï¼šæ·»åŠ  file:// å‰ç¼€
      LazyImage({
        src: 'file://' + photo.path,
        width: '100%',
        height: '100%',
        objectFit: ImageFit.Cover,
        placeholder: Constants.PLACEHOLDER_IMAGE,
        errorHolder: Constants.ERROR_IMAGE,
        cornerRadius: 8
      })

      // å›¾ç‰‡ä¿¡æ¯å åŠ å±‚
      Column() {
        Text(photo.name)
          .fontSize(12)
          .fontColor(Color.White)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)

        if (photo.category) {
          Text(photo.category)
            .fontSize(10)
            .fontColor(Color.White)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .borderRadius(4)
            .margin({ top: 4 })
        }
      }
      .width('100%')
      .padding(8)
      .linearGradient({
        direction: GradientDirection.Bottom,
        colors: [[0x00000000, 0.0], [0xAA000000, 1.0]]
      })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .height('100%')
    .onClick(() => {
      this.navigateToDetail(index);
    })
  }

  // ==========================================
  // åŠ è½½ä¸­è§†å›¾
  // ==========================================
  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#007DFF')

      Text('åŠ è½½ä¸­...')
        .fontSize(14)
        .fontColor('#999999')
        .margin({ top: 16 })
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // ==========================================
  // ç©ºçŠ¶æ€è§†å›¾
  // ==========================================
  @Builder
  EmptyView() {
    Column() {
      Text('ðŸ“·')
        .fontSize(60)
        .opacity(0.4)

      Text('æš‚æ— å›¾ç‰‡')
        .fontSize(14)
        .fontColor('#999999')
        .margin({ top: 16 })

      Text(this.searchText ? 'è¯•è¯•å…¶ä»–æœç´¢è¯' : 'å¿«åŽ»æ·»åŠ å›¾ç‰‡å§')
        .fontSize(12)
        .fontColor('#CCCCCC')
        .margin({ top: 8 })

      // ==========================================
      // ðŸ†• æ·»åŠ è¿”å›žé¦–é¡µæŒ‰é’®
      // ==========================================
      if (!this.searchText && this.displayPhotos.length === 0) {
        Button('è¿”å›žé¦–é¡µä¸Šä¼ ')
          .fontSize(14)
          .margin({ top: 20 })
          .onClick(() => {
            router.back();
          })
      }
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // ==========================================
  // æ•°æ®åŠ è½½ä¸Žæœç´¢é€»è¾‘
  // ==========================================
  private loadPhotos() {
    console.info('[ListPage] å¼€å§‹åŠ è½½å›¾ç‰‡...');
    this.isLoading = true;

    PhotoService.queryAll()
      .then((photos: PhotoModel[]) => {
        this.displayPhotos = photos;
        this.isLoading = false;
        console.info(`[ListPage] âœ… åŠ è½½æˆåŠŸï¼Œå…± ${photos.length} å¼ å›¾ç‰‡`);

        // ðŸ‘‡ å¦‚æžœæ•°æ®åº“ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·
        if (photos.length === 0) {
          console.warn('[ListPage] âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰å›¾ç‰‡ï¼Œè¯·å…ˆä¸Šä¼ å›¾ç‰‡');
        }
      })
      .catch((err: Error) => {
        console.error(`[ListPage] âŒ åŠ è½½å¤±è´¥: ${err.message}`);
        Logger.showError('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•');
        this.displayPhotos = [];
        this.isLoading = false;
      });
  }

  private handleSearch(keyword: string) {
    console.info(`[ListPage] æ‰§è¡Œæœç´¢ï¼Œå…³é”®è¯: "${keyword}", åˆ†ç±»: "${this.selectedCategory}"`);
    this.isLoading = true;

    PhotoService.searchPhotosByCategoryAndKeyword(this.selectedCategory, keyword)
      .then((photos: PhotoModel[]) => {
        this.displayPhotos = photos;
        this.isLoading = false;
        console.info(`[ListPage] âœ… æœç´¢æˆåŠŸï¼Œæ‰¾åˆ° ${photos.length} å¼ å›¾ç‰‡`);
      })
      .catch((err: Error) => {
        console.error(`[ListPage] âŒ æœç´¢å¤±è´¥: ${err.message}`);
        Logger.showError('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•');
        this.displayPhotos = [];
        this.isLoading = false;
      });
  }

  private handleCategoryChange(category: string) {
    console.info(`[ListPage] åˆ‡æ¢åˆ†ç±»åˆ°: "${category}"`);
    this.isLoading = true;

    PhotoService.searchPhotosByCategoryAndKeyword(category, this.searchText)
      .then((photos: PhotoModel[]) => {
        this.displayPhotos = photos;
        this.isLoading = false;
        console.info(`[ListPage] âœ… åˆ†ç±»åˆ‡æ¢æˆåŠŸï¼Œå…± ${photos.length} å¼ å›¾ç‰‡`);
      })
      .catch((err: Error) => {
        console.error(`[ListPage] âŒ åˆ†ç±»åˆ‡æ¢å¤±è´¥: ${err.message}`);
        Logger.showError('åˆ‡æ¢åˆ†ç±»å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•');
        this.displayPhotos = [];
        this.isLoading = false;
      });
  }

  private navigateToDetail(index: number) {
    this.selectedIndex = index;
    const photoPaths = this.displayPhotos.map(photo => 'file://' + photo.path); // ðŸ”§ æ·»åŠ  file:// å‰ç¼€

    console.info(`[ListPage] è·³è½¬åˆ°è¯¦æƒ…é¡µï¼Œç´¢å¼•: ${index}`);

    router.pushUrl({
      url: Constants.URL_DETAIL_LIST_PAGE,
      params: {
        photoArr: photoPaths,
      }
    }).catch((err: Error) => {
      console.error(`${Constants.TAG_LIST_PAGE}${err.message}`);
    });
  }

}
