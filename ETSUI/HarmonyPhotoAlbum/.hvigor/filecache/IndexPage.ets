/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import Constants from '../common/constants/Constants';
import { ImagePicker } from '../components/ImagePicker';
import { PhotoModel } from '../model/PhotoModel';
import PhotoService from '../service/PhotoService';
import { LazyImage } from '../components/LazyImage';
import Logger from '../common/utils/Logger';

// ÂÆö‰πâÊï∞ÊçÆÊé•Âè£
interface PhotoData {
  filePath: string;
  fileName: string;
  category: string;
  tags: string;
  createTime: number;
}

// ==========================================
// Â≠êÁªÑ‰ª∂:‰ø°ÊÅØÂΩïÂÖ•ÂºπÁ™ó
// ==========================================
@CustomDialog
struct PhotoInfoDialog {
  controller: CustomDialogController;
  imagePath: string = '';
  @State category: string = 'ÁîüÊ¥ª';
  @State tags: string = '';
  @State fileName: string = '';
  onSave: (data: PhotoData) => void = (data: PhotoData) => {};

  aboutToAppear() {
    this.fileName = 'IMG_' + new Date().getTime();
  }

  build() {
    Column({ space: 15 }) {
      Text('ÂÆåÂñÑÂõæÁâá‰ø°ÊÅØ').fontSize(20).fontWeight(FontWeight.Bold)

      Image('file://' + this.imagePath)
        .height(150).width('100%').objectFit(ImageFit.Contain)
        .borderRadius(8).backgroundColor('#f0f0f0')

      TextInput({ placeholder: 'ÂõæÁâáÂêçÁß∞', text: this.fileName })
        .onChange((value) => { this.fileName = value; })

      Row() {
        Text('ÂàÜÁ±ª:').fontSize(16)
        TextInput({ placeholder: '‰æãÂ¶Ç: È£éÊôØ', text: this.category })
          .layoutWeight(1).onChange((value) => { this.category = value; })
      }.width('100%')

      Row() {
        Text('Ê†áÁ≠æ:').fontSize(16)
        TextInput({ placeholder: '‰æãÂ¶Ç: #ÊóÖË°å', text: this.tags })
          .layoutWeight(1).onChange((value) => { this.tags = value; })
      }.width('100%')

      Row({ space: 20 }) {
        Button('ÂèñÊ∂à').backgroundColor('#E5E5E5').fontColor('#000')
          .onClick(() => { this.controller.close(); })
        Button('‰øùÂ≠ò').onClick(() => {
          const finalData: PhotoData = {
            filePath: this.imagePath,
            fileName: this.fileName,
            category: this.category,
            tags: this.tags,
            createTime: new Date().getTime()
          };
          this.onSave(finalData);
          this.controller.close();
        })
      }
    }
    .padding(20).backgroundColor(Color.White).borderRadius(16).width('90%')
  }
}

// ==========================================
// ‰∏ªÈ°µÈù¢:IndexPage (Â∏¶Â∫ïÈÉ®TabÂØºËà™)
// ==========================================
@Entry
@Component
struct IndexPage {
  swiperController: SwiperController = new SwiperController();
  @State currentIndex: number = 0;
  @State tempSelectedPath: string = '';
  @State dbPhotoList: Array<PhotoModel> = [];
  @StorageLink('selectedIndex') selectedIndex: number = 0;

  // TabÂØºËà™Áõ∏ÂÖ≥Áä∂ÊÄÅ
  @State currentTabIndex: number = 0;

  aboutToAppear() {
    console.info('[IndexPage] È°µÈù¢Âä†ËΩΩ,Ê≠£Âú®ÂàùÂßãÂåñÊï∞ÊçÆÂ∫ì...');
    PhotoService.initDB(getContext(this) as common.UIAbilityContext)
      .then(() => {
        console.info('[IndexPage] Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñÂÆåÊàê,ÂºÄÂßãÂä†ËΩΩÊï∞ÊçÆ');
        this.refreshData();
      })
      .catch((err: Error) => {
        console.error('[IndexPage] Êï∞ÊçÆÂ∫ìÂêØÂä®Â§±Ë¥•: ' + JSON.stringify(err));
        Logger.showError('Áõ∏ÂÜåÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
      });
  }

  refreshData() {
    PhotoService.queryAll().then((photos) => {
      this.dbPhotoList = photos;
      console.info(`[IndexPage] ÂàóË°®Â∑≤Âà∑Êñ∞,ÂΩìÂâçÂÖ±Êúâ ${this.dbPhotoList.length} Âº†ÁÖßÁâá`);
    });
  }

  infoDialogController: CustomDialogController = new CustomDialogController({
    builder: PhotoInfoDialog({
      imagePath: this.tempSelectedPath,
      onSave: (data: PhotoData) => {
        this.handleSaveData(data);
      }
    }),
    autoCancel: false,
    customStyle: true
  });

  pickerDialogController: CustomDialogController = new CustomDialogController({
    builder: ImagePicker({
      onImageSelected: (path: string) => {
        this.tempSelectedPath = path;
        setTimeout(() => {
          this.infoDialogController.open();
        }, 100);
      }
    }),
    alignment: DialogAlignment.Bottom,
    customStyle: true
  });

  handleSaveData(data: PhotoData) {
    const newPhoto = new PhotoModel(0, data.fileName, data.filePath, data.category, data.createTime, data.tags);

    PhotoService.insert(newPhoto).then((rowId) => {
      console.info(`[IndexPage] ‰øùÂ≠òÊàêÂäü,Êñ∞ËÆ∞ÂΩï ID: ${rowId}`);
      this.refreshData();

      AlertDialog.show({
        title: '‰øùÂ≠òÊàêÂäü',
        message: 'ÂõæÁâáÂ∑≤ÂÆâÂÖ®Â≠òÂÖ•Êï∞ÊçÆÂ∫ì!',
        confirm: {
          value: 'Ê£í', action: () => {}
        }
      });
    }).catch((err: Error) => {
      console.error('[IndexPage] ‰øùÂ≠òÂ§±Ë¥•: ' + JSON.stringify(err));
      Logger.showError('‰øùÂ≠òÂ§±Ë¥•ÔºåÊï∞ÊçÆÂ∫ìÂÜôÂÖ•ÈîôËØØ');
    });
  }

  // ==========================================
  // È°∂ÈÉ®ÊªöÂä®ÁÖßÁâáÁªÑ‰ª∂ÔºàÂü∫‰∫é PhotoModelÔºå‰∏é‰∏ãÊñπÁΩëÊ†ºÂØπÈΩêÔºâ
  // ==========================================

  /**
   * Ëé∑ÂèñÁî®‰∫éËΩÆÊí≠Â±ïÁ§∫ÁöÑÁÖßÁâáÂàóË°®
   * ËøôÈáåÁõ¥Êé•Âèñ dbPhotoList Ââç N Âº†ÔºåËøôÊ†∑Á¥¢Âºï‰∏éÁΩëÊ†ºÂÆåÂÖ®‰∏ÄËá¥
   */
  private getCarouselPhotos(): PhotoModel[] {
    if (!this.dbPhotoList || this.dbPhotoList.length === 0) {
      return [];
    }
    const count: number = Math.min(Constants.SHOW_COUNT, this.dbPhotoList.length);
    return this.dbPhotoList.slice(0, count);
  }

  @Builder
  FeaturedCarousel() {
    const photos = this.getCarouselPhotos();

    // Êó†Êï∞ÊçÆÊó∂ÊòæÁ§∫Âç†‰ΩçÂõæ
    if (photos.length === 0) {
      Column() {
        Image(Constants.PLACEHOLDER_IMAGE)
          .width(Constants.FULL_PERCENT)
          .aspectRatio(Constants.BANNER_ASPECT_RATIO)
          .objectFit(ImageFit.Cover)
          .borderRadius($r('app.float.img_border_radius'))
          .backgroundColor('#F0F0F0')

        Text('ÊöÇÊó†Á≤æÈÄâÁÖßÁâáÔºåÂéªÊ∑ªÂä†‰∏ÄÂº†ÂêßÔΩû')
          .fontSize(14)
          .fontColor('#999999')
          .margin({ top: 12 })
      }
      .padding($r('app.float.grid_padding'))
      return;
    }

    Swiper(this.swiperController) {
      ForEach(photos, (photo: PhotoModel, index: number) => {
        Stack({ alignContent: Alignment.BottomStart }) {
          LazyImage({
            src: 'file://' + photo.path,
            widthValue: Constants.FULL_PERCENT,
            heightValue: Constants.FULL_PERCENT,
            objectFit: ImageFit.Cover,
            placeholder: Constants.PLACEHOLDER_IMAGE,
            errorHolder: Constants.ERROR_IMAGE,
            cornerRadius: $r('app.float.img_border_radius')
          })

          Column() {
            Text(photo.name || 'Êú™ÂëΩÂêçÂõæÁâá')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor(Color.White)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            if (photo.category) {
              Text(photo.category)
                .fontSize(12)
                .fontColor(Color.White)
                .padding({ left: 12, right: 12, top: 4, bottom: 4 })
                .backgroundColor('rgba(0,0,0,0.4)')
                .borderRadius(999)
                .margin({ top: 12 })
            }

            if (photo.tags) {
              Text(photo.tags)
                .fontSize(10)
                .fontColor('#EEEEEE')
                .margin({ top: 6 })
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
          }
          .padding(20)
          .width(Constants.FULL_PERCENT)
          .linearGradient({
            direction: GradientDirection.Bottom,
            colors: [[0x00000000, 0.0], [0xAA000000, 1.0]]
          })
        }
        .width(Constants.FULL_PERCENT)
        .aspectRatio(Constants.BANNER_ASPECT_RATIO)
        .clip(true)
        .onClick(() => {
          // Áî±‰∫é photos ÊòØ dbPhotoList ÁöÑÂ§¥ÈÉ®ÂàáÁâáÔºåindex ‰∏é dbPhotoList ‰∏≠‰∏ÄËá¥
          this.navigateToDetail(index);
        })
      }, (photo: PhotoModel) => photo.id.toString())
    }
    .autoPlay(photos.length > 1)
    .loop(photos.length > 1)
    .duration(Constants.BANNER_ANIMATE_DURATION)
    .margin($r('app.float.grid_padding'))
    .borderRadius($r('app.float.img_border_radius'))
    .clip(true)
  }

  // ==========================================
  // È¶ñÈ°µÂÜÖÂÆπÊûÑÂª∫Âô®
  // ==========================================
  @Builder
  HomeContent() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      Column() {
        // 1. Ê†áÈ¢òÊ†è
        Row() {
          Text($r('app.string.EntryAbility_label'))
            .fontSize($r('app.float.title_font_size'))
            .fontWeight(Constants.TITLE_FONT_WEIGHT)
        }
        .height($r('app.float.navi_bar_height'))
        .width(Constants.FULL_PERCENT)
        .padding({ left: $r('app.float.title_padding') })

        // 2. È°∂ÈÉ®ÊªöÂä®ÁÖßÁâá
        this.FeaturedCarousel()

        // 3. ÂõæÁâáÁΩëÊ†º
        if (this.dbPhotoList.length === 0) {
          Column() {
            Text('üì∑')
              .fontSize(60)
              .opacity(0.3)
              .margin({ top: 50 })

            Text('Áõ∏ÂÜåÁ©∫Á©∫Â¶Ç‰πü')
              .fontSize(16)
              .fontColor(Color.Gray)
              .margin({ top: 20 })

            Text('ÁÇπÂáªÂè≥‰∏ãËßí + Âè∑Ê∑ªÂä†ÁÖßÁâá')
              .fontSize(14)
              .fontColor('#CCCCCC')
              .margin({ top: 10 })
          }
          .layoutWeight(1)
          .width('100%')
          .justifyContent(FlexAlign.Center)
        } else {
          Grid() {
            ForEach(this.dbPhotoList, (photo: PhotoModel, index: number) => {
              GridItem() {
                this.PhotoItem(photo, index);
              }
              .width(Constants.FULL_PERCENT)
              .aspectRatio(1)
            }, (photo: PhotoModel) => photo.id.toString())
          }
          .columnsTemplate(Constants.INDEX_COLUMNS_TEMPLATE)
          .columnsGap($r('app.float.grid_padding'))
          .rowsGap($r('app.float.grid_padding'))
          .padding($r('app.float.grid_padding'))
          .width(Constants.FULL_PERCENT)
          .layoutWeight(1)
        }
      }
      .width(Constants.FULL_PERCENT)
      .height(Constants.FULL_PERCENT)

      // 4. ÊÇ¨ÊµÆÊ∑ªÂä†ÊåâÈíÆ
      Button({ type: ButtonType.Circle, stateEffect: true }) {
        Text('+')
          .fontSize(40)
          .fontColor(Color.White)
          .fontWeight(300)
          .margin({ bottom: 4 })
      }
      .width(60)
      .height(60)
      .margin({ right: 20, bottom: 30 })
      .backgroundColor('#007DFF')
      .shadow({ radius: 10, color: '#888888', offsetY: 5 })
      .onClick(() => {
        this.pickerDialogController.open();
      })
    }
    .width(Constants.FULL_PERCENT)
    .height(Constants.FULL_PERCENT)
  }

  @Builder
  PhotoItem(photo: PhotoModel, index: number) {
    Stack({ alignContent: Alignment.BottomStart }) {
      LazyImage({
        src: 'file://' + photo.path,
        widthValue: '100%',
        heightValue: '100%',
        objectFit: ImageFit.Cover,
        placeholder: Constants.PLACEHOLDER_IMAGE,
        errorHolder: Constants.ERROR_IMAGE,
        cornerRadius: 8
      })

      Column() {
        Text(photo.name)
          .fontSize(12)
          .fontColor(Color.White)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)

        if (photo.category) {
          Text(photo.category)
            .fontSize(10)
            .fontColor(Color.White)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .borderRadius(4)
            .margin({ top: 4 })
        }
      }
      .width('100%')
      .padding(8)
      .linearGradient({
        direction: GradientDirection.Bottom,
        colors: [[0x00000000, 0.0], [0xAA000000, 1.0]]
      })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .height('100%')
    .onClick(() => {
      this.navigateToDetail(index);
    })
  }

  // È°µÈù¢ÊòæÁ§∫Êó∂Ôºà‰ªéListPageËøîÂõûËß¶ÂèëÔºâ
  onPageShow() {
    console.info('[IndexPage] È°µÈù¢ÊòæÁ§∫ÔºåÂà∑Êñ∞Êï∞ÊçÆ');
    this.currentTabIndex = 0;
    this.refreshData();
  }

  // ‰∏ªÊûÑÂª∫ÂáΩÊï∞ - ‰ΩøÁî®TabsÁªÑ‰ª∂
  build() {
    Tabs({ index: this.currentTabIndex }) {
      // Tab 1: È¶ñÈ°µ
      TabContent() {
        this.HomeContent()
      }
      .tabBar(this.TabBuilder(0, 'È¶ñÈ°µ', 'üè†'))

      // Tab 2: ÊêúÁ¥¢È°µ
      TabContent() {
        Column() {
          Text('Ê≠£Âú®Ë∑≥ËΩ¨Âà∞ÊêúÁ¥¢È°µ...')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }
      .tabBar(this.TabBuilder(1, 'ÊêúÁ¥¢', 'üîç'))
    }
    .barPosition(BarPosition.End)
    .scrollable(false)
    .animationDuration(300)
    .onChange((index: number) => {
      console.info(`[IndexPage] ÂàáÊç¢Âà∞ Tab ${index}`);
      this.currentTabIndex = index;

      if (index === 1) {
        router.pushUrl({
          url: 'pages/ListPage'
        }).then(() => {
          console.info('[IndexPage] ÊàêÂäüË∑≥ËΩ¨Âà∞ÊêúÁ¥¢È°µ');
          this.currentTabIndex = 0;
        }).catch((err: Error) => {
          console.error(`[IndexPage] Ë∑≥ËΩ¨Â§±Ë¥•: ${err.message}`);
          this.currentTabIndex = 0;
        });
      }
    })
  }

  // TabÂõæÊ†áÊûÑÂª∫Âô®
  @Builder
  TabBuilder(index: number, title: string, icon: string) {
    Column() {
      Text(icon)
        .fontSize(24)
        .fontColor(this.currentTabIndex === index ? '#007DFF' : '#666666')

      Text(title)
        .fontSize(12)
        .fontColor(this.currentTabIndex === index ? '#007DFF' : '#666666')
        .margin({ top: 4 })
    }
    .width('100%')
    .height(50)
    .justifyContent(FlexAlign.Center)
  }

  private navigateToDetail(index: number) {
    this.selectedIndex = index;
    const photoPaths = this.dbPhotoList.map(photo => 'file://' + photo.path);

    console.info(`[IndexPage] Ë∑≥ËΩ¨Âà∞ËØ¶ÊÉÖÈ°µÔºåÁ¥¢Âºï: ${index}`);

    router.pushUrl({
      url: Constants.URL_DETAIL_LIST_PAGE,
      params: {
        photoArr: photoPaths,
      }
    }).catch((err: Error) => {
      console.error(`${Constants.TAG_INDEX_PAGE}${err.message}`);
    });
  }
}

