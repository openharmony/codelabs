/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import Constants from '../common/constants/Constants';
import { PhotoModel } from '../model/PhotoModel';
import PhotoService from '../service/PhotoService';
import { LazyImage } from '../components/LazyImage';
import Logger from '../common/utils/Logger';
import AuthService from '../service/AuthService';
import { ImagePicker } from '../components/ImagePicker';
import { GALLERY_ITEMS, GalleryItem } from '../model/ResourceGallery';

// å®šä¹‰æ•°æ®æ¥å£
interface PhotoData {
  filePath: string;
  fileName: string;
  category: string;
  tags: string;
  createTime: number;
}

// é¡¶éƒ¨è½®æ’­é¢„ç½®å›¾ç‰‡æ•°æ®ç»“æ„ï¼ˆä»…ç”¨äº UI å±•ç¤ºï¼Œä¸å…¥åº“ï¼‰
interface PreloadCarouselItem {
  src: Resource;
  name: string;
  category: string;
  tags: string;
}

// ==========================================
// å­ç»„ä»¶:ä¿¡æ¯å½•å…¥å¼¹çª—
// ==========================================
@CustomDialog
struct PhotoInfoDialog {
  controller: CustomDialogController;
  imagePath: string = '';
  @State category: string = 'ç”Ÿæ´»';
  @State tags: string = '';
  @State fileName: string = '';
  onSave: (data: PhotoData) => void = (data: PhotoData) => {};

  aboutToAppear() {
    this.fileName = 'IMG_' + new Date().getTime();
  }

  build() {
    Column({ space: 15 }) {
      Text('å®Œå–„å›¾ç‰‡ä¿¡æ¯').fontSize(20).fontWeight(FontWeight.Bold)

      Image('file://' + this.imagePath)
        .height(150).width('100%').objectFit(ImageFit.Contain)
        .borderRadius(8).backgroundColor('#f0f0f0')

      TextInput({ placeholder: 'å›¾ç‰‡åç§°', text: this.fileName })
        .onChange((value) => { this.fileName = value; })

      Row() {
        Text('åˆ†ç±»:').fontSize(16)
        TextInput({ placeholder: 'ä¾‹å¦‚: é£æ™¯', text: this.category })
          .layoutWeight(1).onChange((value) => { this.category = value; })
      }.width('100%')

      Row() {
        Text('æ ‡ç­¾:').fontSize(16)
        TextInput({ placeholder: 'ä¾‹å¦‚: #æ—…è¡Œ', text: this.tags })
          .layoutWeight(1).onChange((value) => { this.tags = value; })
      }.width('100%')

      Row({ space: 20 }) {
        Button('å–æ¶ˆ').backgroundColor('#E5E5E5').fontColor('#000')
          .onClick(() => { this.controller.close(); })
        Button('ä¿å­˜').onClick(() => {
          const finalData: PhotoData = {
            filePath: this.imagePath,
            fileName: this.fileName,
            category: this.category,
            tags: this.tags,
            createTime: new Date().getTime()
          };
          this.onSave(finalData);
          this.controller.close();
        })
      }
    }
    .padding(20).backgroundColor(Color.White).borderRadius(16).width('90%')
  }
}

// ==========================================
// ä¸»é¡µé¢:IndexPage (å¸¦åº•éƒ¨Tabå¯¼èˆª)
// ==========================================
@Entry
@Component
struct IndexPage {
  swiperController: SwiperController = new SwiperController();
  @State currentIndex: number = 0;
  @State tempSelectedPath: string = '';
  @State dbPhotoList: Array<PhotoModel> = [];
  @StorageLink('selectedIndex') selectedIndex: number = 0;

  // Tabå¯¼èˆªç›¸å…³çŠ¶æ€
  @State currentTabIndex: number = 0;

  // éšç§ä¿é™©ç®±é‰´æƒç›¸å…³çŠ¶æ€
  @State hasPin: boolean = false;          // æ˜¯å¦å·²ç»è®¾ç½®è¿‡ PIN
  @State isAuthed: boolean = false;        // å½“å‰ä¼šè¯æ˜¯å¦å·²é€šè¿‡é‰´æƒ
  @State pinInput: string = '';            // è¾“å…¥çš„ PIN
  @State pinConfirmInput: string = '';     // ç¡®è®¤ PINï¼ˆé¦–æ¬¡è®¾ç½®æ—¶ä½¿ç”¨ï¼‰
  @State isSettingPin: boolean = false;    // å½“å‰æ˜¯å¦å¤„äºé¦–æ¬¡è®¾ç½® PIN æµç¨‹
  @State pinErrorMsg: string = '';         // PIN ç›¸å…³é”™è¯¯æç¤º

  aboutToAppear() {
    console.info('[IndexPage] é¡µé¢åŠ è½½,æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...');
    const context = getContext(this) as common.UIAbilityContext;

    // 1. åˆå§‹åŒ–éšç§ä¿é™©ç®± PIN çŠ¶æ€
    AuthService.hasPin(context)
      .then((has: boolean) => {
        this.hasPin = has;
        // å¦‚æœè¿˜æ²¡æœ‰è®¾ç½® PINï¼Œåˆ™è¿›å…¥è®¾ç½®æµç¨‹
        this.isSettingPin = !has;
      })
      .catch((err: Error) => {
        console.error('[IndexPage] è¯»å– PIN çŠ¶æ€å¤±è´¥: ' + JSON.stringify(err));
      });

    // 2. é¢„åˆå§‹åŒ–æ•°æ®åº“ï¼ˆä¿æŒåŸæœ‰æ•°æ®ç»“æ„ä¸å˜ï¼‰
    PhotoService.initDB(context)
      .then(() => {
        console.info('[IndexPage] æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ,å¼€å§‹åŠ è½½æ•°æ®');
        this.refreshData();
      })
      .catch((err: Error) => {
        console.error('[IndexPage] æ•°æ®åº“å¯åŠ¨å¤±è´¥: ' + JSON.stringify(err));
        Logger.showError('ç›¸å†Œåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      });
  }

  refreshData() {
    PhotoService.queryAll().then((photos) => {
      this.dbPhotoList = photos;
      console.info(`[IndexPage] åˆ—è¡¨å·²åˆ·æ–°,å½“å‰å…±æœ‰ ${this.dbPhotoList.length} å¼ ç…§ç‰‡`);
    });
  }

  /**
   * é¦–æ¬¡è®¾ç½® PIN ç ï¼ˆéšç§ä¿é™©ç®±åˆå§‹åŒ–ï¼‰
   */
  private handleSetPin() {
    this.pinErrorMsg = '';

    if (this.pinInput.length !== 4 || !/^\d{4}$/.test(this.pinInput)) {
      this.pinErrorMsg = 'PIN ç å¿…é¡»æ˜¯ 4 ä½æ•°å­—';
      return;
    }

    if (this.pinInput !== this.pinConfirmInput) {
      this.pinErrorMsg = 'ä¸¤æ¬¡è¾“å…¥çš„ PIN ç ä¸ä¸€è‡´';
      return;
    }

    const context = getContext(this) as common.UIAbilityContext;
    AuthService.setPin(context, this.pinInput)
      .then(() => {
        this.hasPin = true;
        this.isAuthed = true;
        this.isSettingPin = false;
        this.pinErrorMsg = '';
        this.pinConfirmInput = '';
        // é‰´æƒæˆåŠŸååˆ·æ–°ä¸€æ¬¡æ•°æ®
        this.refreshData();
      })
      .catch((err: Error) => {
        console.error('[IndexPage] è®¾ç½® PIN å¤±è´¥: ' + JSON.stringify(err));
        this.pinErrorMsg = 'ä¿å­˜ PIN å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
      });
  }

  /**
   * æ ¡éªŒå·²æœ‰ PINï¼Œè§£é”éšç§ç›¸å†Œ
   */
  private handleVerifyPin() {
    this.pinErrorMsg = '';

    if (this.pinInput.length !== 4 || !/^\d{4}$/.test(this.pinInput)) {
      this.pinErrorMsg = 'PIN ç å¿…é¡»æ˜¯ 4 ä½æ•°å­—';
      return;
    }

    const context = getContext(this) as common.UIAbilityContext;
    AuthService.verifyPin(context, this.pinInput)
      .then((ok: boolean) => {
        if (ok) {
          this.isAuthed = true;
          this.pinErrorMsg = '';
          this.refreshData();
        } else {
          this.pinErrorMsg = 'PIN ç é”™è¯¯ï¼Œè¯·é‡è¯•';
        }
      })
      .catch((err: Error) => {
        console.error('[IndexPage] æ ¡éªŒ PIN å¤±è´¥: ' + JSON.stringify(err));
        this.pinErrorMsg = 'æ ¡éªŒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
      });
  }

  infoDialogController: CustomDialogController = new CustomDialogController({
    builder: PhotoInfoDialog({
      imagePath: this.tempSelectedPath,
      onSave: (data: PhotoData) => {
        this.handleSaveData(data);
      }
    }),
    autoCancel: false,
    customStyle: true
  });

  pickerDialogController: CustomDialogController = new CustomDialogController({
    builder: ImagePicker({
      onImageSelected: (path: string) => {
        this.tempSelectedPath = path;
        setTimeout(() => {
          this.infoDialogController.open();
        }, 100);
      }
    }),
    alignment: DialogAlignment.Bottom,
    customStyle: true
  });

  handleSaveData(data: PhotoData) {
    const newPhoto = new PhotoModel(0, data.fileName, data.filePath, data.category, data.createTime, data.tags);

    PhotoService.insert(newPhoto).then((rowId) => {
      console.info(`[IndexPage] ä¿å­˜æˆåŠŸ,æ–°è®°å½• ID: ${rowId}`);
      this.refreshData();

      AlertDialog.show({
        title: 'ä¿å­˜æˆåŠŸ',
        message: 'å›¾ç‰‡å·²å®‰å…¨å­˜å…¥æ•°æ®åº“!',
        confirm: {
          value: 'æ£’', action: () => {}
        }
      });
    }).catch((err: Error) => {
      console.error('[IndexPage] ä¿å­˜å¤±è´¥: ' + JSON.stringify(err));
      Logger.showError('ä¿å­˜å¤±è´¥ï¼Œæ•°æ®åº“å†™å…¥é”™è¯¯');
    });
  }

  // ==========================================
  // é¡¶éƒ¨æ»šåŠ¨ç…§ç‰‡ç»„ä»¶ï¼ˆåŸºäº PhotoModelï¼Œä¸ä¸‹æ–¹ç½‘æ ¼å¯¹é½ï¼‰
  // ==========================================

  /**
   * è·å–ç”¨äºè½®æ’­å±•ç¤ºçš„ç…§ç‰‡åˆ—è¡¨
   * è¿™é‡Œç›´æ¥å– dbPhotoList å‰ N å¼ ï¼Œè¿™æ ·ç´¢å¼•ä¸ç½‘æ ¼å®Œå…¨ä¸€è‡´
   */
  private getCarouselPhotos(): PhotoModel[] {
    if (!this.dbPhotoList || this.dbPhotoList.length === 0) {
      return [];
    }
    const count: number = Math.min(Constants.SHOW_COUNT, this.dbPhotoList.length);
    return this.dbPhotoList.slice(0, count);
  }

  /**
   * è·å–ç”¨äºç½‘æ ¼å±•ç¤ºçš„ç…§ç‰‡åˆ—è¡¨ï¼ˆæ’é™¤è½®æ’­ä¸­çš„å›¾ç‰‡ï¼‰
   */
  private getGridPhotos(): PhotoModel[] {
    if (!this.dbPhotoList || this.dbPhotoList.length === 0) {
      return [];
    }
    // ä»è½®æ’­åçš„ç…§ç‰‡å¼€å§‹æ˜¾ç¤º
    const carouselCount: number = Math.min(Constants.SHOW_COUNT, this.dbPhotoList.length);
    return this.dbPhotoList.slice(carouselCount);
  }

  /**
   * é¡¶éƒ¨è½®æ’­é¢„ç½®å›¾ç‰‡ï¼ˆæ¥è‡ª resources/base/mediaï¼‰ï¼Œç”¨äºåœ¨æ²¡æœ‰ç”¨æˆ·ç…§ç‰‡æ—¶å…ˆå±•ç¤ºå‡ å¼ ç¤ºä¾‹å›¾
   * ä¸å†™å…¥æ•°æ®åº“ï¼Œä¿æŒç°æœ‰å›¾ç‰‡æ•°æ®æ¨¡å¼ä¸å˜
   * è¿™é‡Œç»Ÿä¸€ä½¿ç”¨ ResourceGallery ä¸­çš„å…¨é‡èµ„æºï¼Œä¿è¯ä¸æŸ¥è¯¢é¡µã€ç”µå­ç›¸æ¡†ä½¿ç”¨åŒä¸€å¥—å›¾åº“
   */
  private getPreloadCarouselImages(): Array<PreloadCarouselItem> {
    // å–å‰4å¼ ä½œä¸ºè½®æ’­å›¾
    const carouselCount = Math.min(4, GALLERY_ITEMS.length);
    return GALLERY_ITEMS.slice(0, carouselCount).map((item: GalleryItem) => {
      const preload: PreloadCarouselItem = {
        src: item.src,
        name: item.name,
        category: item.category,
        tags: item.tags
      };
      return preload;
    });
  }

  /**
   * è·å–ç”¨äºç½‘æ ¼å±•ç¤ºçš„é¢„ç½®å›¾ç‰‡ï¼ˆæ’é™¤è½®æ’­ä¸­çš„å›¾ç‰‡ï¼‰
   */
  private getPreloadGridImages(): Array<PreloadCarouselItem> {
    // ä»ç¬¬5å¼ å¼€å§‹ä½œä¸ºç½‘æ ¼å›¾ç‰‡
    const carouselCount = Math.min(4, GALLERY_ITEMS.length);
    return GALLERY_ITEMS.slice(carouselCount).map((item: GalleryItem) => {
      const preload: PreloadCarouselItem = {
        src: item.src,
        name: item.name,
        category: item.category,
        tags: item.tags
      };
      return preload;
    });
  }
  @Builder
  FeaturedCarousel() {
    // 1. ç”¨æˆ·ç…§ç‰‡ä¸é¢„ç½®å›¾ç‰‡éƒ½æ²¡æœ‰æ—¶ï¼Œæ˜¾ç¤ºå ä½
    if (this.getCarouselPhotos().length === 0 && this.getPreloadCarouselImages().length === 0) {
      Column() {
        Image(Constants.PLACEHOLDER_IMAGE)
          .width(Constants.FULL_PERCENT)
          .aspectRatio(Constants.BANNER_ASPECT_RATIO)
          .objectFit(ImageFit.Cover)
          .borderRadius($r('app.float.img_border_radius'))
          .backgroundColor('#F0F0F0')

        Text('æš‚æ— ç²¾é€‰ç…§ç‰‡ï¼Œå»æ·»åŠ ä¸€å¼ å§ï½')
          .fontSize(14)
          .fontColor('#999999')
          .margin({ top: 12 })
      }
      .padding($r('app.float.grid_padding'))
      // 2. ä»…æœ‰é¢„ç½®å›¾ç‰‡ï¼ˆæ•°æ®åº“è¿˜æ²¡æœ‰ç…§ç‰‡ï¼‰æ—¶ï¼Œå…ˆç”¨é¢„ç½®å›¾åšè½®æ’­
    } else if (this.getCarouselPhotos().length === 0 && this.getPreloadCarouselImages().length > 0) {
      Swiper(this.swiperController) {
        ForEach(this.getPreloadCarouselImages(), (photo: PreloadCarouselItem, index: number) => {
          Stack({ alignContent: Alignment.BottomStart }) {
            Image(photo.src)
              .width(Constants.FULL_PERCENT)
              .aspectRatio(Constants.BANNER_ASPECT_RATIO)
              .objectFit(ImageFit.Cover)
              .borderRadius($r('app.float.img_border_radius'))
              .backgroundColor('#F0F0F0')

            Column() {
              Text(photo.name || 'ç¤ºä¾‹å›¾ç‰‡')
                .fontSize(20)
                .fontWeight(FontWeight.Medium)
                .fontColor(Color.White)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })

              if (photo.category) {
                Text(photo.category)
                  .fontSize(12)
                  .fontColor(Color.White)
                  .padding({ left: 12, right: 12, top: 4, bottom: 4 })
                  .backgroundColor('rgba(0,0,0,0.4)')
                  .borderRadius(999)
                  .margin({ top: 12 })
              }

              if (photo.tags) {
                Text(photo.tags)
                  .fontSize(10)
                  .fontColor('#EEEEEE')
                  .margin({ top: 6 })
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
            }
            .padding(20)
            .width(Constants.FULL_PERCENT)
            .linearGradient({
              direction: GradientDirection.Bottom,
              colors: [[0x00000000, 0.0], [0xAA000000, 1.0]]
            })
          }
          .width(Constants.FULL_PERCENT)
          .aspectRatio(Constants.BANNER_ASPECT_RATIO)
          .clip(true)
          .onClick(() => {
            // é¢„ç½®å›¾ç‰‡ç‚¹å‡»åä¹Ÿè¿›å…¥å¤§å›¾æµè§ˆé¡µ
            this.navigateToPreloadDetail(index);
          })
        })
      }
      .autoPlay(this.getPreloadCarouselImages().length > 1)
      .loop(this.getPreloadCarouselImages().length > 1)
      .duration(Constants.BANNER_ANIMATE_DURATION)
      .margin($r('app.float.grid_padding'))
      .borderRadius($r('app.float.img_border_radius'))
      .clip(true)
      // 3. æ­£å¸¸æƒ…å†µï¼šä½¿ç”¨æ•°æ®åº“ä¸­çš„ç…§ç‰‡åšè½®æ’­ï¼Œè¡Œä¸ºä¿æŒä¸å˜
    } else {
      Swiper(this.swiperController) {
        ForEach(this.getCarouselPhotos(), (photo: PhotoModel, index: number) => {
          Stack({ alignContent: Alignment.BottomStart }) {
            LazyImage({
              src: 'file://' + photo.path,
              widthValue: Constants.FULL_PERCENT,
              heightValue: Constants.FULL_PERCENT,
              objectFit: ImageFit.Cover,
              placeholder: Constants.PLACEHOLDER_IMAGE,
              errorHolder: Constants.ERROR_IMAGE,
              cornerRadius: $r('app.float.img_border_radius')
            })

            Column() {
              Text(photo.name || 'æœªå‘½åå›¾ç‰‡')
                .fontSize(20)
                .fontWeight(FontWeight.Medium)
                .fontColor(Color.White)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
              if (photo.category) {
                Text(photo.category)
                  .fontSize(12)
                  .fontColor(Color.White)
                  .padding({ left: 12, right: 12, top: 4, bottom: 4 })
                  .backgroundColor('rgba(0,0,0,0.4)')
                  .borderRadius(999)
                  .margin({ top: 12 })
              }

              if (photo.tags) {
                Text(photo.tags)
                  .fontSize(10)
                  .fontColor('#EEEEEE')
                  .margin({ top: 6 })
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
            }
            .padding(20)
            .width(Constants.FULL_PERCENT)
            .linearGradient({
              direction: GradientDirection.Bottom,
              colors: [[0x00000000, 0.0], [0xAA000000, 1.0]]
            })
          }
          .width(Constants.FULL_PERCENT)
          .aspectRatio(Constants.BANNER_ASPECT_RATIO)
          .clip(true)
          .onClick(() => {
            // ç”±äº photos æ˜¯ dbPhotoList çš„å¤´éƒ¨åˆ‡ç‰‡ï¼Œindex ä¸ dbPhotoList ä¸­ä¸€è‡´
            this.navigateToDetail(index);
          })
        }, (photo: PhotoModel) => photo.id.toString())
      }
      .autoPlay(this.getCarouselPhotos().length > 1)
      .loop(this.getCarouselPhotos().length > 1)
      .duration(Constants.BANNER_ANIMATE_DURATION)
      .margin($r('app.float.grid_padding'))
      .borderRadius($r('app.float.img_border_radius'))
      .clip(true)
    }
  }

  // ==========================================
  // é¦–é¡µå†…å®¹æ„å»ºå™¨
  // ==========================================
  @Builder
  HomeContent() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      Column() {
        // 1. æ ‡é¢˜æ 
        Row() {
          Text($r('app.string.EntryAbility_label'))
            .fontSize($r('app.float.title_font_size'))
            .fontWeight(Constants.TITLE_FONT_WEIGHT)

          Blank().layoutWeight(1)

          // è¿›å…¥ç”µå­ç›¸æ¡†åˆ†ç±»é€‰æ‹©é¡µï¼ˆå…ˆé€‰åˆ†ç±»ï¼Œå†è·³è½¬å¯¹åº”å¹»ç¯ç‰‡æ’­æ”¾é¡µï¼‰
          Button('ç”µå­ç›¸æ¡†')
            .height(32)
            .padding({ left: 12, right: 12 })
            .fontSize(12)
            .backgroundColor('#007DFF')
            .fontColor(Color.White)
            .onClick(() => {
              router.pushUrl({
                url: Constants.URL_FRAME_CATEGORY_PAGE
              }).catch((err: Error) => {
                console.error('[IndexPage] è·³è½¬ç”µå­ç›¸æ¡†åˆ†ç±»é¡µå¤±è´¥: ' + JSON.stringify(err));
              });
            })
        }
        .height($r('app.float.navi_bar_height'))
        .width(Constants.FULL_PERCENT)
        .padding({ left: $r('app.float.title_padding'), right: 16 })

        // 2. é¡¶éƒ¨æ»šåŠ¨ç…§ç‰‡
        this.FeaturedCarousel()

        // 3. å›¾ç‰‡ç½‘æ ¼
        if (this.dbPhotoList.length === 0) {
          // æ•°æ®åº“ä¸ºç©ºæ—¶ï¼Œæ˜¾ç¤ºé¢„ç½®å›¾ç‰‡ç½‘æ ¼ï¼ˆæ’é™¤è½®æ’­ä¸­çš„å›¾ç‰‡ï¼‰
          if (this.getPreloadGridImages().length > 0) {
            Grid() {
              ForEach(this.getPreloadGridImages(), (photo: PreloadCarouselItem, index: number) => {
                GridItem() {
                  this.PreloadPhotoItem(photo, index);
                }
                .width(Constants.FULL_PERCENT)
                .aspectRatio(1)
              }, (photo: PreloadCarouselItem, index?: number) => `preload_${index}`)
            }
            .columnsTemplate(Constants.INDEX_COLUMNS_TEMPLATE)
            .columnsGap($r('app.float.grid_padding'))
            .rowsGap($r('app.float.grid_padding'))
            .padding($r('app.float.grid_padding'))
            .width(Constants.FULL_PERCENT)
            .layoutWeight(1)
          } else {
            // å®Œå…¨æ²¡æœ‰å›¾ç‰‡æ—¶çš„å ä½
            Column() {
              Text('ğŸ“·')
                .fontSize(60)
                .opacity(0.3)
                .margin({ top: 50 })

              Text('ç›¸å†Œç©ºç©ºå¦‚ä¹Ÿ')
                .fontSize(16)
                .fontColor(Color.Gray)
                .margin({ top: 20 })

              Text('è¿™æ˜¯ä¸€ä¸ªåŸºäºæ²™ç®±çš„éšç§ç›¸å†Œ')
                .fontSize(14)
                .fontColor('#CCCCCC')
                .margin({ top: 10 })
            }
            .layoutWeight(1)
            .width('100%')
            .justifyContent(FlexAlign.Center)
          }
        } else {
          // æ•°æ®åº“æœ‰ç…§ç‰‡æ—¶ï¼Œæ˜¾ç¤ºé™¤è½®æ’­å¤–çš„ç…§ç‰‡
          Grid() {
            ForEach(this.getGridPhotos(), (photo: PhotoModel, index: number) => {
              GridItem() {
                // æ³¨æ„ï¼šè¿™é‡Œçš„indexæ˜¯ç½‘æ ¼ä¸­çš„ç´¢å¼•ï¼Œéœ€è¦åŠ ä¸Šè½®æ’­æ•°é‡æ‰æ˜¯dbPhotoListä¸­çš„çœŸå®ç´¢å¼•
                this.PhotoItem(photo, index + Math.min(Constants.SHOW_COUNT, this.dbPhotoList.length));
              }
              .width(Constants.FULL_PERCENT)
              .aspectRatio(1)
            }, (photo: PhotoModel) => photo.id.toString())
          }
          .columnsTemplate(Constants.INDEX_COLUMNS_TEMPLATE)
          .columnsGap($r('app.float.grid_padding'))
          .rowsGap($r('app.float.grid_padding'))
          .padding($r('app.float.grid_padding'))
          .width(Constants.FULL_PERCENT)
          .layoutWeight(1)
        }
      }
      .width(Constants.FULL_PERCENT)
      .height(Constants.FULL_PERCENT)
    }
    .width(Constants.FULL_PERCENT)
    .height(Constants.FULL_PERCENT)
  }

  @Builder
  PhotoItem(photo: PhotoModel, index: number) {
    Stack({ alignContent: Alignment.BottomStart }) {
      LazyImage({
        src: 'file://' + photo.path,
        widthValue: '100%',
        heightValue: '100%',
        objectFit: ImageFit.Cover,
        placeholder: Constants.PLACEHOLDER_IMAGE,
        errorHolder: Constants.ERROR_IMAGE,
        cornerRadius: 8
      })

      Column() {
        Text(photo.name)
          .fontSize(12)
          .fontColor(Color.White)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)

        if (photo.category) {
          Text(photo.category)
            .fontSize(10)
            .fontColor(Color.White)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .borderRadius(4)
            .margin({ top: 4 })
        }
      }
      .width('100%')
      .padding(8)
      .linearGradient({
        direction: GradientDirection.Bottom,
        colors: [[0x00000000, 0.0], [0xAA000000, 1.0]]
      })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .height('100%')
    .onClick(() => {
      this.navigateToDetail(index);
    })
  }

  @Builder
  PreloadPhotoItem(photo: PreloadCarouselItem, index: number) {
    Stack({ alignContent: Alignment.BottomStart }) {
      Image(photo.src)
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)
        .borderRadius(8)

      Column() {
        Text(photo.name)
          .fontSize(12)
          .fontColor(Color.White)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)

        if (photo.category) {
          Text(photo.category)
            .fontSize(10)
            .fontColor(Color.White)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .borderRadius(4)
            .margin({ top: 4 })
        }
      }
      .width('100%')
      .padding(8)
      .linearGradient({
        direction: GradientDirection.Bottom,
        colors: [[0x00000000, 0.0], [0xAA000000, 1.0]]
      })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .height('100%')
    .onClick(() => {
      // ç‚¹å‡»é¢„ç½®ç½‘æ ¼å›¾ç‰‡ï¼Œè·³è½¬åˆ°è¯¦æƒ…é¡µï¼ˆindexéœ€è¦åŠ ä¸Šè½®æ’­å›¾æ•°é‡ï¼‰
      this.navigateToPreloadGridDetail(index);
    })
  }

  // é¡µé¢æ˜¾ç¤ºæ—¶ï¼ˆä»ListPageè¿”å›è§¦å‘ï¼‰
  onPageShow() {
    console.info('[IndexPage] é¡µé¢æ˜¾ç¤ºï¼Œåˆ·æ–°æ•°æ®');
    this.currentTabIndex = 0;
    if (this.isAuthed) {
      this.refreshData();
    }
  }

  // ä¸»æ„å»ºå‡½æ•°ï¼šå…ˆè¿›è¡Œ PIN é‰´æƒï¼ŒæˆåŠŸåå†è¿›å…¥ä¸»ç•Œé¢
  build() {
    if (!this.isAuthed) {
      this.AuthContent();
    } else {
      this.MainTabs();
    }
  }

  // é‰´æƒé¡µé¢ï¼ˆéšç§å®‰å…¨ä¿é™©ç®±ï¼‰
  @Builder
  AuthContent() {
    Column({ space: 24 }) {
      Blank().layoutWeight(1)

      Column({ space: 12 }) {
        Text('éšç§å®‰å…¨ä¿é™©ç®±')
          .fontSize(26)
          .fontWeight(FontWeight.Bold)
          .fontColor('#222222')

        if (!this.hasPin || this.isSettingPin) {
          Text('é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½® 4 ä½æ•°å­— PIN ç ')
            .fontSize(14)
            .fontColor('#666666')
        } else {
          Text('è¯·è¾“å…¥ 4 ä½æ•°å­— PIN ç è§£é”ç›¸å†Œ')
            .fontSize(14)
            .fontColor('#666666')
        }
      }

      // è¾“å…¥åŒºåŸŸ
      if (!this.hasPin || this.isSettingPin) {
        // è®¾ç½® PIN
        Column({ space: 12 }) {
          TextInput({
            placeholder: 'è®¾ç½® 4 ä½ PIN',
            text: this.pinInput
          })
            .type(InputType.Number)
            .maxLength(4)
            .onChange((value: string) => {
              this.pinInput = value;
            })

          TextInput({
            placeholder: 'å†æ¬¡è¾“å…¥ä»¥ç¡®è®¤',
            text: this.pinConfirmInput
          })
            .type(InputType.Number)
            .maxLength(4)
            .onChange((value: string) => {
              this.pinConfirmInput = value;
            })

          Button('ä¿å­˜å¹¶è¿›å…¥ç›¸å†Œ')
            .width('100%')
            .height(44)
            .backgroundColor('#007DFF')
            .fontColor(Color.White)
            .onClick(() => this.handleSetPin())
        }
      } else {
        // æ ¡éªŒ PIN
        Column({ space: 12 }) {
          TextInput({
            placeholder: 'è¾“å…¥ 4 ä½ PIN',
            text: this.pinInput
          })
            .type(InputType.Number)
            .maxLength(4)
            .onChange((value: string) => {
              this.pinInput = value;
            })

          Button('è§£é”ç›¸å†Œ')
            .width('100%')
            .height(44)
            .backgroundColor('#007DFF')
            .fontColor(Color.White)
            .onClick(() => this.handleVerifyPin())
        }
      }

      if (this.pinErrorMsg) {
        Text(this.pinErrorMsg)
          .fontSize(12)
          .fontColor(Color.Red)
      }

      Blank().layoutWeight(1)

      Text('æ‰€æœ‰ç…§ç‰‡å‡ä¿å­˜åœ¨åº”ç”¨æ²™ç®±ä¸­ï¼Œç³»ç»Ÿå›¾åº“æ— æ³•è®¿é—®ã€‚')
        .fontSize(12)
        .fontColor('#999999')
        .textAlign(TextAlign.Center)
        .width('100%')
    }
    .padding(24)
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // ä¸»ç•Œé¢ï¼šTabs + ç›¸å†Œé¦–é¡µ/æœç´¢é¡µ
  @Builder
  MainTabs() {
    Tabs({ index: this.currentTabIndex }) {
      // Tab 1: é¦–é¡µ
      TabContent() {
        this.HomeContent()
      }
      .tabBar(this.TabBuilder(0, 'é¦–é¡µ', 'ğŸ '))

      // Tab 2: æœç´¢é¡µ
      TabContent() {
        Column() {
          Text('æ­£åœ¨è·³è½¬åˆ°æœç´¢é¡µ...')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }
      .tabBar(this.TabBuilder(1, 'æœç´¢', 'ğŸ”'))
    }
    .barPosition(BarPosition.End)
    .scrollable(false)
    .animationDuration(300)
    .onChange((index: number) => {
      console.info(`[IndexPage] åˆ‡æ¢åˆ° Tab ${index}`);
      this.currentTabIndex = index;

      if (index === 1) {
        router.pushUrl({
          url: 'pages/ListPage'
        }).then(() => {
          console.info('[IndexPage] æˆåŠŸè·³è½¬åˆ°æœç´¢é¡µ');
          this.currentTabIndex = 0;
        }).catch((err: Error) => {
          console.error(`[IndexPage] è·³è½¬å¤±è´¥: ${err.message}`);
          this.currentTabIndex = 0;
        });
      }
    })
  }

  // Tabå›¾æ ‡æ„å»ºå™¨
  @Builder
  TabBuilder(index: number, title: string, icon: string) {
    Column() {
      Text(icon)
        .fontSize(24)
        .fontColor(this.currentTabIndex === index ? '#007DFF' : '#666666')

      Text(title)
        .fontSize(12)
        .fontColor(this.currentTabIndex === index ? '#007DFF' : '#666666')
        .margin({ top: 4 })
    }
    .width('100%')
    .height(50)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * è·³è½¬åˆ°é¢„ç½®è½®æ’­å›¾ç‰‡çš„è¯¦æƒ…åˆ—è¡¨é¡µ
   * ä½¿ç”¨ä¸ç”¨æˆ·ç…§ç‰‡ç›¸åŒçš„ DetailListPageï¼Œå¤§å›¾æµè§ˆä½“éªŒä¸€è‡´
   */
  private navigateToPreloadDetail(index: number) {
    this.selectedIndex = index;
    // åªåŒ…å«è½®æ’­å›¾ç‰‡
    const photoArr = this.getPreloadCarouselImages().map((item: PreloadCarouselItem) => item.src);

    router.pushUrl({
      url: Constants.URL_DETAIL_LIST_PAGE,
      params: {
        photoArr: photoArr
      }
    }).catch((err: Error) => {
      console.error(`${Constants.TAG_INDEX_PAGE}${err.message}`);
    });
  }

  /**
   * è·³è½¬åˆ°é¢„ç½®ç½‘æ ¼å›¾ç‰‡çš„è¯¦æƒ…åˆ—è¡¨é¡µ
   * åŒ…å«æ‰€æœ‰é¢„ç½®å›¾ç‰‡ï¼ˆè½®æ’­+ç½‘æ ¼ï¼‰ï¼Œå¹¶è®¾ç½®æ­£ç¡®çš„èµ·å§‹ç´¢å¼•
   */
  private navigateToPreloadGridDetail(index: number) {
    // è®¡ç®—çœŸå®ç´¢å¼•ï¼šç½‘æ ¼å›¾ç‰‡çš„ç´¢å¼•éœ€è¦åŠ ä¸Šè½®æ’­å›¾ç‰‡æ•°é‡
    const carouselCount = Math.min(4, GALLERY_ITEMS.length);
    this.selectedIndex = carouselCount + index;
    
    // åŒ…å«æ‰€æœ‰é¢„ç½®å›¾ç‰‡ï¼ˆè½®æ’­+ç½‘æ ¼ï¼‰
    const allPreloadImages = GALLERY_ITEMS.map((item: GalleryItem) => item.src);

    router.pushUrl({
      url: Constants.URL_DETAIL_LIST_PAGE,
      params: {
        photoArr: allPreloadImages
      }
    }).catch((err: Error) => {
      console.error(`${Constants.TAG_INDEX_PAGE}${err.message}`);
    });
  }

  private navigateToDetail(index: number) {
    this.selectedIndex = index;
    const photoPaths = this.dbPhotoList.map(photo => 'file://' + photo.path);

    console.info(`[IndexPage] è·³è½¬åˆ°è¯¦æƒ…é¡µï¼Œç´¢å¼•: ${index}`);

    router.pushUrl({
      url: Constants.URL_DETAIL_LIST_PAGE,
      params: {
        photoArr: photoPaths,
      }
    }).catch((err: Error) => {
      console.error(`${Constants.TAG_INDEX_PAGE}${err.message}`);
    });
  }
}
