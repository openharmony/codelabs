import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import Constants from '../common/constants/Constants';
import { ImagePicker } from '../components/ImagePicker';
import { PhotoModel } from '../model/PhotoModel';
import PhotoService from '../service/PhotoService';
import { LazyImage } from '../components/LazyImage';
import Logger from '../common/utils/Logger';

// å®šä¹‰æ•°æ®æ¥å£
interface PhotoData {
  filePath: string;
  fileName: string;
  category: string;
  tags: string;
  createTime: number;
}

// ==========================================
// å­ç»„ä»¶:ä¿¡æ¯å½•å…¥å¼¹çª—
// ==========================================
@CustomDialog
struct PhotoInfoDialog {
  controller: CustomDialogController;
  imagePath: string = '';
  @State category: string = 'ç”Ÿæ´»';
  @State tags: string = '';
  @State fileName: string = '';
  onSave: (data: PhotoData) => void = (data: PhotoData) => {};

  aboutToAppear() {
    this.fileName = 'IMG_' + new Date().getTime();
  }

  build() {
    Column({ space: 15 }) {
      Text('å®Œå–„å›¾ç‰‡ä¿¡æ¯').fontSize(20).fontWeight(FontWeight.Bold)

      Image('file://' + this.imagePath)
        .height(150).width('100%').objectFit(ImageFit.Contain)
        .borderRadius(8).backgroundColor('#f0f0f0')

      TextInput({ placeholder: 'å›¾ç‰‡åç§°', text: this.fileName })
        .onChange((value) => { this.fileName = value; })

      Row() {
        Text('åˆ†ç±»:').fontSize(16)
        TextInput({ placeholder: 'ä¾‹å¦‚: é£æ™¯', text: this.category })
          .layoutWeight(1).onChange((value) => { this.category = value; })
      }.width('100%')

      Row() {
        Text('æ ‡ç­¾:').fontSize(16)
        TextInput({ placeholder: 'ä¾‹å¦‚: #æ—…è¡Œ', text: this.tags })
          .layoutWeight(1).onChange((value) => { this.tags = value; })
      }.width('100%')

      Row({ space: 20 }) {
        Button('å–æ¶ˆ').backgroundColor('#E5E5E5').fontColor('#000')
          .onClick(() => { this.controller.close(); })
        Button('ä¿å­˜').onClick(() => {
          const finalData: PhotoData = {
            filePath: this.imagePath,
            fileName: this.fileName,
            category: this.category,
            tags: this.tags,
            createTime: new Date().getTime()
          };
          this.onSave(finalData);
          this.controller.close();
        })
      }
    }
    .padding(20).backgroundColor(Color.White).borderRadius(16).width('90%')
  }
}

// ==========================================
// ä¸»é¡µé¢:IndexPage (å¸¦åº•éƒ¨Tabå¯¼èˆª)
// ==========================================
@Entry
@Component
struct IndexPage {
  swiperController: SwiperController = new SwiperController();
  @State currentIndex: number = 0;
  @State tempSelectedPath: string = '';
  @State dbPhotoList: Array<PhotoModel> = [];

  // ==========================================
  // ğŸ†• Tabå¯¼èˆªç›¸å…³çŠ¶æ€
  // ==========================================
  @State currentTabIndex: number = 0;

  aboutToAppear() {
    console.info('[IndexPage] é¡µé¢åŠ è½½,æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...');
    PhotoService.initDB(getContext(this) as common.UIAbilityContext)
      .then(() => {
        console.info('[IndexPage] æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ,å¼€å§‹åŠ è½½æ•°æ®');
        this.refreshData();
      })
      .catch((err: Error) => {
        console.error('[IndexPage] æ•°æ®åº“å¯åŠ¨å¤±è´¥: ' + JSON.stringify(err));
        Logger.showError('ç›¸å†Œåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      });
  }

  refreshData() {
    PhotoService.queryAll().then((photos) => {
      this.dbPhotoList = photos;
      console.info(`[IndexPage] åˆ—è¡¨å·²åˆ·æ–°,å½“å‰å…±æœ‰ ${this.dbPhotoList.length} å¼ ç…§ç‰‡`);
    });
  }

  infoDialogController: CustomDialogController = new CustomDialogController({
    builder: PhotoInfoDialog({
      imagePath: this.tempSelectedPath,
      onSave: (data: PhotoData) => {
        this.handleSaveData(data);
      }
    }),
    autoCancel: false,
    customStyle: true
  });

  pickerDialogController: CustomDialogController = new CustomDialogController({
    builder: ImagePicker({
      onImageSelected: (path: string) => {
        this.tempSelectedPath = path;
        setTimeout(() => { this.infoDialogController.open(); }, 100);
      }
    }),
    alignment: DialogAlignment.Bottom,
    customStyle: true
  });

  handleSaveData(data: PhotoData) {
    const newPhoto = new PhotoModel(0, data.fileName, data.filePath, data.category, data.createTime, data.tags);

    PhotoService.insert(newPhoto).then((rowId) => {
      console.info(`[IndexPage] ä¿å­˜æˆåŠŸ,æ–°è®°å½• ID: ${rowId}`);
      this.refreshData();

      AlertDialog.show({
        title: 'ä¿å­˜æˆåŠŸ',
        message: 'å›¾ç‰‡å·²å®‰å…¨å­˜å…¥æ•°æ®åº“!',
        confirm: { value: 'æ£’', action: () => {} }
      });
    }).catch((err: Error) => {
      console.error('[IndexPage] ä¿å­˜å¤±è´¥: ' + JSON.stringify(err));
      Logger.showError('ä¿å­˜å¤±è´¥ï¼Œæ•°æ®åº“å†™å…¥é”™è¯¯');
    });
  }

  // ==========================================
  // ğŸ†• é¦–é¡µå†…å®¹æ„å»ºå™¨
  // ==========================================
  @Builder
  HomeContent() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      Column() {
        // 1. æ ‡é¢˜æ 
        Row() {
          Text($r('app.string.EntryAbility_label'))
            .fontSize($r('app.float.title_font_size'))
            .fontWeight(Constants.TITLE_FONT_WEIGHT)
        }
        .height($r('app.float.navi_bar_height'))
        .width(Constants.FULL_PERCENT)
        .padding({ left: $r('app.float.title_padding') })

        // 2. è½®æ’­å›¾
        Swiper(this.swiperController) {
          ForEach(Constants.BANNER_IMG_LIST, (item: Resource) => {
            Row() {
              Image(item).width(Constants.FULL_PERCENT).height(Constants.FULL_PERCENT)
            }
            .width(Constants.FULL_PERCENT).aspectRatio(Constants.BANNER_ASPECT_RATIO)
          }, (item: Resource, index?: number) => JSON.stringify(item) + index)
        }
        .autoPlay(true).loop(true)
        .margin($r('app.float.grid_padding'))
        .borderRadius($r('app.float.img_border_radius'))
        .clip(true)

        // 3. å›¾ç‰‡ç½‘æ ¼
        if (this.dbPhotoList.length === 0) {
          Column() {
            Text('ğŸ“·')
              .fontSize(60)
              .opacity(0.3)
              .margin({ top: 50 })

            Text('ç›¸å†Œç©ºç©ºå¦‚ä¹Ÿ')
              .fontSize(16)
              .fontColor(Color.Gray)
              .margin({ top: 20 })

            Text('ç‚¹å‡»å³ä¸‹è§’ + å·æ·»åŠ ç…§ç‰‡')
              .fontSize(14)
              .fontColor('#CCCCCC')
              .margin({ top: 10 })
          }
          .layoutWeight(1)
          .width('100%')
          .justifyContent(FlexAlign.Center)
        } else {
          Grid() {
            ForEach(this.dbPhotoList, (item: PhotoModel) => {
              GridItem() {
                Column() {
                  LazyImage({
                    src: 'file://' + item.path,
                    widthValue: '100%',
                    heightValue: 100,
                    objectFit: ImageFit.Cover,
                    cornerRadius: 8,
                    placeholder: Constants.PLACEHOLDER_IMAGE,
                    errorHolder: Constants.ERROR_IMAGE
                  })

                  Text(item.name)
                    .fontSize(14)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .margin({ top: 5 })
                }
                .padding(5)
                .backgroundColor('#F5F5F5')
                .borderRadius(8)
              }
              .onClick(() => {
                console.info(`ç‚¹å‡»äº†å›¾ç‰‡: ${item.name}`);
              })
            }, (item: PhotoModel) => item.id.toString())
          }
          .columnsTemplate(Constants.INDEX_COLUMNS_TEMPLATE)
          .columnsGap($r('app.float.grid_padding'))
          .rowsGap($r('app.float.grid_padding'))
          .padding($r('app.float.grid_padding'))
          .width(Constants.FULL_PERCENT)
          .layoutWeight(1)
        }
      }
      .width(Constants.FULL_PERCENT)
      .height(Constants.FULL_PERCENT)

      // 4. æ‚¬æµ®æ·»åŠ æŒ‰é’®
      Button({ type: ButtonType.Circle, stateEffect: true }) {
        Text('+')
          .fontSize(40)
          .fontColor(Color.White)
          .fontWeight(300)
          .margin({ bottom: 4 })
      }
      .width(60)
      .height(60)
      .margin({ right: 20, bottom: 30 })
      .backgroundColor('#007DFF')
      .shadow({ radius: 10, color: '#888888', offsetY: 5 })
      .onClick(() => {
        this.pickerDialogController.open();
      })
    }
    .width(Constants.FULL_PERCENT)
    .height(Constants.FULL_PERCENT)
  }

  // ==========================================
  // ğŸ†• é¡µé¢æ˜¾ç¤ºæ—¶çš„ç”Ÿå‘½å‘¨æœŸï¼ˆä»ListPageè¿”å›æ—¶è§¦å‘ï¼‰
  // ==========================================
  onPageShow() {
    console.info('[IndexPage] é¡µé¢æ˜¾ç¤ºï¼Œåˆ·æ–°æ•°æ®');
    this.currentTabIndex = 0; // ç¡®ä¿å›åˆ°é¦–é¡µTab
    this.refreshData(); // åˆ·æ–°å›¾ç‰‡åˆ—è¡¨
  }

  // ==========================================
  // ğŸ†• ä¸»æ„å»ºå‡½æ•° - ä½¿ç”¨Tabsç»„ä»¶
  // ==========================================
  build() {
    Tabs({ index: this.currentTabIndex }) {
      // ==========================================
      // Tab 1: é¦–é¡µ
      // ==========================================
      TabContent() {
        this.HomeContent()
      }
      .tabBar(this.TabBuilder(0, 'é¦–é¡µ', 'ğŸ '))

      // ==========================================
      // Tab 2: æœç´¢é¡µ
      // ==========================================
      TabContent() {
        Column() {
          Text('æ­£åœ¨è·³è½¬åˆ°æœç´¢é¡µ...')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }
      .tabBar(this.TabBuilder(1, 'æœç´¢', 'ğŸ”'))
    }
    .barPosition(BarPosition.End) // åº•éƒ¨å¯¼èˆª
    .scrollable(false) // ç¦æ­¢æ»‘åŠ¨åˆ‡æ¢
    .animationDuration(300) // åˆ‡æ¢åŠ¨ç”»æ—¶é•¿
    .onChange((index: number) => {
      console.info(`[IndexPage] åˆ‡æ¢åˆ° Tab ${index}`);
      this.currentTabIndex = index;

      // ==========================================
      // ğŸ¯ å…³é”®:ç‚¹å‡»"æœç´¢"Tabæ—¶è·³è½¬åˆ°ListPage
      // ==========================================
      if (index === 1) {
        router.pushUrl({
          url: 'pages/ListPage'
        }).then(() => {
          console.info('[IndexPage] æˆåŠŸè·³è½¬åˆ°æœç´¢é¡µ');
          // è·³è½¬åç«‹å³åˆ‡å›é¦–é¡µTab,é¿å…UIé”™ä¹±
          this.currentTabIndex = 0;
        }).catch((err: Error) => {
          console.error(`[IndexPage] è·³è½¬å¤±è´¥: ${err.message}`);
          this.currentTabIndex = 0;
        });
      }
    })
  }

  // ==========================================
  // ğŸ†• Tabå›¾æ ‡æ„å»ºå™¨
  // ==========================================
  @Builder
  TabBuilder(index: number, title: string, icon: string) {
    Column() {
      Text(icon)
        .fontSize(24)
        .fontColor(this.currentTabIndex === index ? '#007DFF' : '#666666')

      Text(title)
        .fontSize(12)
        .fontColor(this.currentTabIndex === index ? '#007DFF' : '#666666')
        .margin({ top: 4 })
    }
    .width('100%')
    .height(50)
    .justifyContent(FlexAlign.Center)
  }

}
