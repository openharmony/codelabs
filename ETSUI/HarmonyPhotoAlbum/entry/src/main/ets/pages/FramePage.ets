/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License,Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


import router from '@ohos.router';
import Constants from '../common/constants/Constants';
import { LazyImage } from '../components/LazyImage';

// ç”µå­ç›¸æ¡†ä½¿ç”¨çš„é¢„ç½®å›¾ç‰‡åˆ†ç±»ï¼ˆä¸ resources/base/media ä¸€ä¸€å¯¹åº”ï¼‰
const FRAME_IMAGES_SCENE: Resource[] = [
  $r('app.media.ic_scene_0'),
  $r('app.media.ic_scene_1'),
  $r('app.media.ic_scene_2')
];

const FRAME_IMAGES_LIFE: Resource[] = [
  $r('app.media.ic_life_0'),
  $r('app.media.ic_life_1'),
  $r('app.media.ic_life_2'),
  $r('app.media.ic_life_3'),
  $r('app.media.ic_life_4'),
  $r('app.media.ic_life_5')
];

const FRAME_IMAGES_FOOD: Resource[] = [
  $r('app.media.ic_food_0'),
  $r('app.media.ic_food_1')
];

const FRAME_IMAGES_MEN: Resource[] = [
  $r('app.media.ic_men_0'),
  $r('app.media.ic_men_2'),
  $r('app.media.ic_men_3')
];

// å¦‚æœ‰éœ€è¦ï¼Œä¹Ÿå¯ä»¥æŠŠåº”ç”¨å›¾æ ‡ä½œä¸ºâ€œå…¶ä»–â€ç±»åˆ«çš„ä¸€éƒ¨åˆ†
const FRAME_IMAGES_ICON: Resource[] = [
  $r('app.media.icon')
];

@Entry
@Component
struct FramePage {
  // æ¯æ¬¡åˆ†ç±»åˆ‡æ¢æ—¶é‡æ–°åˆ›å»º controllerï¼Œç”¨äºå¼ºåˆ¶åˆ·æ–° Swiper çŠ¶æ€
  private swiperController: SwiperController = new SwiperController();

  @State autoPlayInterval: number = 5000; // ms
  @State showControlPanel: boolean = true;

  // å½“å‰ç”µå­ç›¸æ¡†åˆ†ç±»
  @State currentCategory: string = 'å…¨éƒ¨';

  // å½“å‰åˆ†ç±»å¯¹åº”çš„å›¾ç‰‡åˆ—è¡¨ï¼ˆç”¨äºé©±åŠ¨ Swiperï¼Œä¿è¯åˆ†ç±»åˆ‡æ¢æ—¶å³æ—¶æ›´æ–°ï¼‰
  @State frameImages: Resource[] = [];

  // å¯é€‰åˆ†ç±»ï¼ˆä¸èµ„æºç›®å½•å¯¹åº”ï¼‰
  private readonly frameCategories: string[] = ['å…¨éƒ¨', 'é£æ™¯', 'ç”Ÿæ´»', 'ç¾é£Ÿ', 'äººç‰©'];

  // å„åˆ†ç±»å¯¹åº”çš„åˆ‡æ¢æ–¹æ³•ï¼šæ¯ä¸ªæŒ‰é’®è°ƒç”¨è‡ªå·±çš„æ–¹æ³•ï¼Œä¿è¯ä¸€ä¸€å¯¹åº”
  private showAllCategory() {
    console.info('[FramePage] åˆ‡æ¢åˆ†ç±»: å…¨éƒ¨');
    this.currentCategory = 'å…¨éƒ¨';
    this.frameImages = new Array<Resource>().concat(
      FRAME_IMAGES_SCENE,
      FRAME_IMAGES_LIFE,
      FRAME_IMAGES_FOOD,
      FRAME_IMAGES_MEN,
      FRAME_IMAGES_ICON
    );
    this.swiperController = new SwiperController();
  }

  private showSceneCategory() {
    console.info('[FramePage] åˆ‡æ¢åˆ†ç±»: é£æ™¯');
    this.currentCategory = 'é£æ™¯';
    this.frameImages = FRAME_IMAGES_SCENE;
    this.swiperController = new SwiperController();
  }

  private showLifeCategory() {
    console.info('[FramePage] åˆ‡æ¢åˆ†ç±»: ç”Ÿæ´»');
    this.currentCategory = 'ç”Ÿæ´»';
    this.frameImages = FRAME_IMAGES_LIFE;
    this.swiperController = new SwiperController();
  }

  private showFoodCategory() {
    console.info('[FramePage] åˆ‡æ¢åˆ†ç±»: ç¾é£Ÿ');
    this.currentCategory = 'ç¾é£Ÿ';
    this.frameImages = FRAME_IMAGES_FOOD;
    this.swiperController = new SwiperController();
  }

  private showMenCategory() {
    console.info('[FramePage] åˆ‡æ¢åˆ†ç±»: äººç‰©');
    this.currentCategory = 'äººç‰©';
    this.frameImages = FRAME_IMAGES_MEN;
    this.swiperController = new SwiperController();
  }
  
  aboutToAppear() {
    // ä»è·¯ç”±å‚æ•°ä¸­è¯»å–åˆ†ç±»ï¼ˆç”± FrameCategoryPage ä¼ å…¥ï¼‰
    let category: string = 'å…¨éƒ¨';
    try {
      const params: Record<string, Object> = router.getParams() as Record<string, Object>;
      const fromRouter: string | undefined = params && params[Constants.PARAM_FRAME_CATEGORY] as string;
      if (fromRouter) {
        category = fromRouter;
      }
    } catch (e) {
      console.warn('[FramePage] è¯»å–è·¯ç”±å‚æ•°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åˆ†ç±»: å…¨éƒ¨');
    }

    switch (category) {
      case 'é£æ™¯':
        this.showSceneCategory();
        break;
      case 'ç”Ÿæ´»':
        this.showLifeCategory();
        break;
      case 'ç¾é£Ÿ':
        this.showFoodCategory();
        break;
      case 'äººç‰©':
        this.showMenCategory();
        break;
      case 'å…¨éƒ¨':
      default:
        this.showAllCategory();
        break;
    }
  }
  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      // èƒŒæ™¯å…¨å±è½®æ’­
      if (this.frameImages.length > 0) {
        Swiper(this.swiperController) {
          ForEach(this.frameImages, (img: Resource, index: number) => {
            Stack() {
              LazyImage({
                src: img,
                widthValue: Constants.FULL_PERCENT,
                heightValue: Constants.FULL_PERCENT,
                objectFit: ImageFit.Cover,
                placeholder: Constants.PLACEHOLDER_IMAGE,
                errorHolder: Constants.ERROR_IMAGE
              })
            }
            .width(Constants.FULL_PERCENT)
            .height(Constants.FULL_PERCENT)
          }, (img: Resource, index?: number) => `${index}`)
        }
        .autoPlay(this.frameImages.length > 1)
        .interval(this.autoPlayInterval)
        .loop(this.frameImages.length > 1)
        .duration(Constants.TRANSITION_DURATION_LONG)
        .width(Constants.FULL_PERCENT)
        .height(Constants.FULL_PERCENT)
        .indicator(false)
        .onClick(() => {
          // ç‚¹å‡»åˆ‡æ¢æ§åˆ¶é¢æ¿æ˜¾éš
          this.showControlPanel = !this.showControlPanel;
        })
      } else {
        // æ— ç…§ç‰‡æ—¶çš„å ä½æç¤º
        Column() {
          Text('ğŸ“·')
            .fontSize(60)
            .opacity(0.3)
            .margin({ bottom: 16 })

          Text('æš‚æ— å¯æ’­æ”¾çš„ç…§ç‰‡')
            .fontSize(18)
            .fontColor('#EEEEEE')

          Text('è¯·ç¡®è®¤èµ„æºå›¾ç‰‡æ˜¯å¦å­˜åœ¨')
            .fontSize(14)
            .fontColor('#BBBBBB')
            .margin({ top: 8 })
        }
        .width(Constants.FULL_PERCENT)
        .height(Constants.FULL_PERCENT)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(Color.Black)
      }

      // é¡¶éƒ¨è¿”å› + æ ‡é¢˜æ  + åº•éƒ¨æ§åˆ¶é¢æ¿
      if (this.showControlPanel) {
        Column() {
          // é¡¶éƒ¨å¯¼èˆª
          Row({ space: 12 }) {
            Button({ type: ButtonType.Circle }) {
              Text('<')
                .fontSize(18)
                .fontColor(Color.White)
            }
            .backgroundColor('rgba(0,0,0,0.4)')
            .width(40)
            .height(40)
            .onClick(() => {
              router.back();
            })

            Column() {
              Text('æ²‰æµ¸å¼ç”µå­ç›¸æ¡†')
                .fontSize(18)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Medium)

              // æ˜¾ç¤ºå½“å‰æ­£åœ¨æ’­æ”¾çš„åˆ†ç±»
              Text(`æ­£åœ¨æ’­æ”¾: ${this.currentCategory}`)
                .fontSize(12)
                .fontColor('#DDDDDD')
            }
          }
          .padding({ top: 24, left: 16, right: 16 })

          Blank().layoutWeight(1)

          // åº•éƒ¨æ§åˆ¶é¢æ¿ï¼šè°ƒæ•´è½®æ’­é—´éš”
          Column() {
            Row() {
              Text('è½®æ’­é—´éš”: ')
                .fontSize(14)
                .fontColor(Color.White)

              Text(`${Math.round(this.autoPlayInterval / 1000)} ç§’`)
                .fontSize(16)
                .fontColor('#FFD166')
                .fontWeight(FontWeight.Bold)
            }
            .margin({ bottom: 8 })

            Slider({
              value: this.autoPlayInterval,
              min: 2000,
              max: 15000,
              step: 1000
            })
              .blockColor('#FFD166')
              .trackColor('rgba(255,255,255,0.3)')
              .selectedColor('#FFD166')
              .onChange((value: number) => {
                this.autoPlayInterval = value;
              })
          }
          .padding({ left: 24, right: 24, bottom: 32 })
          .backgroundColor('rgba(0,0,0,0.5)')
          .borderRadius({ topLeft: 24, topRight: 24, bottomLeft: 0, bottomRight: 0 })
        }
        .width(Constants.FULL_PERCENT)
        .height(Constants.FULL_PERCENT)
      }
    }
    .width(Constants.FULL_PERCENT)
    .height(Constants.FULL_PERCENT)
    .backgroundColor(Color.Black)
  }
}
