/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/*
 * ä¿®å¤åçš„ ListPage.ets
 * å¼ºåˆ¶ä½¿ç”¨æ•°æ®åº“æ•°æ®ï¼Œæ˜¾ç¤ºæœç´¢æ å’Œåˆ†ç±»ç­›é€‰
 * âœ… æ”¯æŒè¿”å›é¦–é¡µåŠŸèƒ½
 */

import router from '@ohos.router';
import Constants from '../common/constants/Constants';
import { SearchBar } from '../components/SearchBar';
import { CategoryFilter } from '../components/CategoryFilter';
import PhotoService from '../service/PhotoService';
import { PhotoModel } from '../model/PhotoModel';
import { LazyImage } from '../components/LazyImage';
import Logger from '../common/utils/Logger';
import { GALLERY_ITEMS, GalleryItem } from '../model/ResourceGallery';

// æœç´¢åˆ—è¡¨ç”¨åˆ°çš„ç»Ÿä¸€å±•ç¤ºæ¨¡å‹ï¼ˆåŒ…å«æ•°æ®åº“å›¾ç‰‡ + é¢„ç½®èµ„æºå›¾ï¼‰
type SearchPhotoSrc = string | Resource;

interface SearchPhotoItem {
  id: number;           // å¯¹äºé¢„ç½®å›¾ä½¿ç”¨è´Ÿæ•° IDï¼Œé¿å…ä¸æ•°æ®åº“å†²çª
  name: string;
  category: string;
  tags: string;
  src: SearchPhotoSrc;  // æ•°æ®åº“å›¾ç‰‡: 'file://' + è·¯å¾„ï¼›é¢„ç½®å›¾ç‰‡: èµ„æº ID
  isPreload: boolean;   // æ˜¯å¦ä¸ºé¢„ç½®èµ„æºå›¾ç‰‡
}

@Entry
@Component
struct ListPage {
  // çŠ¶æ€å˜é‡
  @State searchText: string = '';
  @State selectedCategory: string = Constants.ALL_CATEGORY;
  @State displayPhotos: SearchPhotoItem[] = [];
  @State isLoading: boolean = true;
  @StorageLink('selectedIndex') selectedIndex: number = 0;

  // ==========================================
  // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨æ•°æ®åº“æ•°æ®
  // ==========================================
  aboutToAppear() {
    console.info('[ListPage] ========== é¡µé¢åŠ è½½å¼€å§‹ ==========');
    this.loadPhotos();
  }

  // ==========================================
  // ğŸ†• é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®ï¼ˆä»è¯¦æƒ…é¡µè¿”å›æ—¶ï¼‰
  // ==========================================
  onPageShow() {
    console.info('[ListPage] é¡µé¢æ˜¾ç¤ºï¼Œåˆ·æ–°æ•°æ®');
    this.loadPhotos();
  }

  build() {
    Navigation() {
      Column() {
        // ==========================================
        // âœ… æœç´¢æ ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
        // ==========================================
        SearchBar({
          searchText: $searchText,
          onSearch: (text: string) => {
            console.info(`[ListPage] æœç´¢å…³é”®è¯: ${text}`);
            this.handleSearch(text);
          }
        })
          .margin({ left: 16, right: 16 })

        // ==========================================
        // âœ… åˆ†ç±»ç­›é€‰ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
        // ==========================================
        CategoryFilter({
          selectedCategory: $selectedCategory,
          onCategoryChange: (category: string) => {
            console.info(`[ListPage] åˆ‡æ¢åˆ†ç±»: ${category}`);
            this.handleCategoryChange(category);
          }
        })

        // ==========================================
        // å›¾ç‰‡ç½‘æ ¼
        // ==========================================
        if (this.isLoading) {
          this.LoadingView();
        } else if (this.displayPhotos.length > 0) {
          this.PhotoGrid();
        } else {
          this.EmptyView();
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8F8F8')
    }
    .title(Constants.PAGE_TITLE)
    .hideBackButton(false) // âœ… æ˜¾ç¤ºè¿”å›æŒ‰é’®ï¼ˆç³»ç»Ÿé»˜è®¤è¿”å›åˆ°ä¸Šä¸€é¡µï¼‰
    .titleMode(NavigationTitleMode.Mini)
    // ==========================================
    // ğŸ†• æ·»åŠ å·¥å…·æ æŒ‰é’®ï¼ˆæä¾›é¢å¤–çš„è¿”å›æ–¹å¼ï¼‰
    // ==========================================
    .toolbarConfiguration([
      {
        value: 'è¿”å›é¦–é¡µ',
        action: () => {
          console.info('[ListPage] å·¥å…·æ -è¿”å›é¦–é¡µ');
          router.back();
        }
      }
    ])
  }

  // ==========================================
  // å›¾ç‰‡ç½‘æ ¼
  // ==========================================
  @Builder
  PhotoGrid() {
    Grid() {
      ForEach(this.displayPhotos, (photo: SearchPhotoItem, index: number) => {
        GridItem() {
          this.PhotoItem(photo, index);
        }
        .width(Constants.FULL_PERCENT)
        .aspectRatio(1)
      }, (photo: SearchPhotoItem) => photo.id.toString())
    }
    .columnsTemplate(Constants.GRID_COLUMNS_TEMPLATE)
    .rowsGap(Constants.LIST_ITEM_SPACE)
    .columnsGap(Constants.LIST_ITEM_SPACE)
    .layoutWeight(1)
    .cachedCount(10)
  }

  @Builder
  PhotoItem(photo: SearchPhotoItem, index: number) {
    Stack({ alignContent: Alignment.BottomStart }) {
      LazyImage({
        // ç»Ÿä¸€ä» src å­—æ®µè¯»å–ï¼Œæ•°æ®åº“å›¾ç‰‡ä¸º 'file://' è·¯å¾„ï¼Œé¢„ç½®å›¾ç‰‡ä¸ºèµ„æº ID
        src: photo.src,
        widthValue: '100%',
        heightValue: '100%',
        objectFit: ImageFit.Cover,
        placeholder: Constants.PLACEHOLDER_IMAGE,
        errorHolder: Constants.ERROR_IMAGE,
        cornerRadius: 8
      })

      // å›¾ç‰‡ä¿¡æ¯å åŠ å±‚
      Column() {
        Text(photo.name)
          .fontSize(12)
          .fontColor(Color.White)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .textAlign(TextAlign.Start)

        if (photo.category) {
          Text(photo.category)
            .fontSize(10)
            .fontColor(Color.White)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .borderRadius(4)
            .margin({ top: 4 })
        }
      }
      .width('100%')
      .padding(8)
      .linearGradient({
        direction: GradientDirection.Bottom,
        colors: [[0x00000000, 0.0], [0xAA000000, 1.0]]
      })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .height('100%')
    .onClick(() => {
      this.navigateToDetail(index);
    })
  }

  // ==========================================
  // åŠ è½½ä¸­è§†å›¾
  // ==========================================
  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#007DFF')

      Text('åŠ è½½ä¸­...')
        .fontSize(14)
        .fontColor('#999999')
        .margin({ top: 16 })
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // ==========================================
  // ç©ºçŠ¶æ€è§†å›¾
  // ==========================================
  @Builder
  EmptyView() {
    Column() {
      Text('ğŸ“·')
        .fontSize(60)
        .opacity(0.4)

      Text('æš‚æ— å›¾ç‰‡')
        .fontSize(14)
        .fontColor('#999999')
        .margin({ top: 16 })

      Text(this.searchText ? 'è¯•è¯•å…¶ä»–æœç´¢è¯' : 'å¿«å»æ·»åŠ å›¾ç‰‡å§')
        .fontSize(12)
        .fontColor('#CCCCCC')
        .margin({ top: 8 })

      // ==========================================
      // ğŸ†• æ·»åŠ è¿”å›é¦–é¡µæŒ‰é’®
      // ==========================================
      if (!this.searchText && this.displayPhotos.length === 0) {
        Button('è¿”å›é¦–é¡µä¸Šä¼ ')
          .fontSize(14)
          .margin({ top: 20 })
          .onClick(() => {
            router.back();
          })
      }
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // ==========================================
  // æ•°æ®åŠ è½½ä¸æœç´¢é€»è¾‘
  // ==========================================
  private loadPhotos() {
    console.info('[ListPage] å¼€å§‹åŠ è½½å›¾ç‰‡...');
    this.isLoading = true;

    // æŸ¥è¯¢æ•°æ®åº“ï¼Œä¿ç•™åŸæœ‰é€»è¾‘
    PhotoService.queryAll()
      .then((photos: PhotoModel[]) => {
        const dbItems: Array<SearchPhotoItem> = photos.map((photo: PhotoModel) => this.mapDbPhotoToSearchItem(photo));

        // ä½¿ç”¨ç»Ÿä¸€èµ„æºå›¾åº“ä½œä¸ºé¢„ç½®æ•°æ®ï¼Œä¿è¯ä¸é¦–é¡µ/ç”µå­ç›¸æ¡†ä¸€è‡´
        const preloadItems: Array<SearchPhotoItem> = this.getPreloadSearchItemsFromGallery();

        this.displayPhotos = dbItems.concat(preloadItems);
        this.isLoading = false;
        console.info(`[ListPage] âœ… åŠ è½½æˆåŠŸï¼ŒDB: ${photos.length} æ¡ï¼Œé¢„ç½®: ${preloadItems.length} æ¡`);

        if (photos.length === 0) {
          console.warn('[ListPage] âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰å›¾ç‰‡ï¼Œä»…å±•ç¤ºé¢„ç½®å›¾åº“');
        }
      })
      .catch((err: Error) => {
        console.error(`[ListPage] âŒ åŠ è½½å¤±è´¥: ${err.message}`);
        Logger.showError('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');

        // å³ä½¿ DB å¤±è´¥ï¼Œä¹Ÿä½¿ç”¨é¢„ç½®èµ„æºå›¾åº“ä¿è¯æœç´¢é¡µå¯ç”¨
        this.displayPhotos = this.getPreloadSearchItemsFromGallery();
        this.isLoading = false;
      });
  }

  private handleSearch(keyword: string) {
    console.info(`[ListPage] æ‰§è¡Œæœç´¢ï¼Œå…³é”®è¯: "${keyword}", åˆ†ç±»: "${this.selectedCategory}"`);
    this.isLoading = true;

    PhotoService.searchPhotosByCategoryAndKeyword(this.selectedCategory, keyword)
      .then((photos: PhotoModel[]) => {
        const dbItems: Array<SearchPhotoItem> = photos.map((photo: PhotoModel) => this.mapDbPhotoToSearchItem(photo));

        // å°†ç¬¦åˆå½“å‰æœç´¢æ¡ä»¶çš„é¢„ç½®å›¾åº“ä¸€å¹¶åŠ å…¥
        const preloadItems: Array<SearchPhotoItem> = this.filterPreloadBy(this.selectedCategory, keyword);

        this.displayPhotos = dbItems.concat(preloadItems);
        this.isLoading = false;
        console.info(`[ListPage] âœ… æœç´¢æˆåŠŸï¼ŒDB: ${photos.length} æ¡ï¼Œé¢„ç½®: ${preloadItems.length} æ¡`);
      })
      .catch((err: Error) => {
        console.error(`[ListPage] âŒ æœç´¢å¤±è´¥: ${err.message}`);
        Logger.showError('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        this.displayPhotos = [];
        this.isLoading = false;
      });
  }

  private handleCategoryChange(category: string) {
    console.info(`[ListPage] åˆ‡æ¢åˆ†ç±»åˆ°: "${category}"`);
    this.isLoading = true;

    PhotoService.searchPhotosByCategoryAndKeyword(category, this.searchText)
      .then((photos: PhotoModel[]) => {
        const dbItems: Array<SearchPhotoItem> = photos.map((photo: PhotoModel) => this.mapDbPhotoToSearchItem(photo));

        const preloadItems: Array<SearchPhotoItem> = this.filterPreloadBy(category, this.searchText);

        this.displayPhotos = dbItems.concat(preloadItems);
        this.isLoading = false;
        console.info(`[ListPage] âœ… åˆ†ç±»åˆ‡æ¢æˆåŠŸï¼ŒDB: ${photos.length} æ¡ï¼Œé¢„ç½®: ${preloadItems.length} æ¡`);
      })
      .catch((err: Error) => {
        console.error(`[ListPage] âŒ åˆ†ç±»åˆ‡æ¢å¤±è´¥: ${err.message}`);
        Logger.showError('åˆ‡æ¢åˆ†ç±»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        this.displayPhotos = [];
        this.isLoading = false;
      });
  }

  private navigateToDetail(index: number) {
    this.selectedIndex = index;
    // ç»Ÿä¸€ä» displayPhotos.src æ„å»ºè¯¦æƒ…é¡µå›¾ç‰‡æ•°ç»„ï¼Œ
    // æ•°æ®åº“å›¾ç‰‡ä¸º 'file://' è·¯å¾„å­—ç¬¦ä¸²ï¼Œé¢„ç½®å›¾ç‰‡ä¸ºèµ„æº ID
    const photoArr = this.displayPhotos.map((photo: SearchPhotoItem) => photo.src);

    console.info(`[ListPage] è·³è½¬åˆ°è¯¦æƒ…é¡µï¼Œç´¢å¼•: ${index}`);

    router.pushUrl({
      url: Constants.URL_DETAIL_LIST_PAGE,
      params: {
        photoArr: photoArr,
      }
    }).catch((err: Error) => {
      console.error(`${Constants.TAG_LIST_PAGE}${err.message}`);
    });
  }

  /**
   * å°†æ•°æ®åº“ä¸­çš„ PhotoModel è½¬æ¢ä¸ºç”¨äºæœç´¢å±•ç¤ºçš„ SearchPhotoItem
   */
  private mapDbPhotoToSearchItem(photo: PhotoModel): SearchPhotoItem {
    const src: string = 'file://' + photo.path;
    const item: SearchPhotoItem = {
      id: photo.id,
      name: photo.name,
      category: photo.category,
      tags: photo.tags,
      src: src,
      isPreload: false
    };
    return item;
  }

  // ==========================================
  // é¢„ç½®èµ„æºå›¾ï¼šå‚ä¸æœç´¢é¡µå±•ç¤º
  // ä¸é¦–é¡µé¡¶éƒ¨è½®æ’­ä¿æŒä¸€è‡´çš„åç§° / åˆ†ç±» / æ ‡ç­¾
  // ==========================================
  // ä½¿ç”¨ç»Ÿä¸€èµ„æºå›¾åº“æ„é€ é¢„ç½®æœç´¢é¡¹
  private getPreloadSearchItemsFromGallery(): Array<SearchPhotoItem> {
    return GALLERY_ITEMS.map((item: GalleryItem, index: number) => {
      const searchItem: SearchPhotoItem = {
        id: -1000 - index, // è´Ÿæ•° IDï¼Œé¿å…ä¸æ•°æ®åº“å†²çª
        name: item.name,
        category: item.category,
        tags: item.tags,
        src: item.src,
        isPreload: true
      };
      return searchItem;
    });
  }

  /**
   * æ ¹æ®å½“å‰åˆ†ç±»å’Œå…³é”®è¯ï¼Œä»é¢„ç½®å›¾ç‰‡ä¸­ç­›é€‰ç¬¦åˆæ¡ä»¶çš„é¡¹
   */
  private filterPreloadBy(category: string, keyword: string): Array<SearchPhotoItem> {
    let result: Array<SearchPhotoItem> = this.getPreloadSearchItemsFromGallery();

    // åˆ†ç±»è¿‡æ»¤ï¼ˆ"å…¨éƒ¨" è¡¨ç¤ºä¸è¿‡æ»¤ï¼‰
    if (category && category !== Constants.ALL_CATEGORY) {
      result = result.filter((item: SearchPhotoItem) => item.category === category);
    }

    // å…³é”®è¯è¿‡æ»¤ï¼ˆåç§° / åˆ†ç±» / æ ‡ç­¾ æ¨¡ç³ŠåŒ¹é…ï¼‰
    if (keyword && keyword.trim() !== '') {
      const lowerKeyword: string = keyword.toLowerCase();
      result = result.filter((item: SearchPhotoItem) => {
        const nameMatch: boolean = item.name.toLowerCase().includes(lowerKeyword);
        const categoryMatch: boolean = item.category.toLowerCase().includes(lowerKeyword);
        const tagsMatch: boolean = item.tags.toLowerCase().includes(lowerKeyword);
        return nameMatch || categoryMatch || tagsMatch;
      });
    }

    return result;
  }

}
