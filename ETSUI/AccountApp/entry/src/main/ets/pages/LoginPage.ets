import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import RdbHelper from '../database/RdbHelper';
import User from '../model/User';
import { BusinessError } from '@ohos.base';
import PreferenceUtil from '../utils/PreferenceUtil'; // 1. å¼•å…¥å·¥å…·ç±»

/**
 * LoginPage.ets
 * ç”¨æˆ·ç™»å½•é¡µé¢
 * ã€å…³é”®æ›´æ–°ã€‘å¢žåŠ äº†è‡ªåŠ¨ç™»å½•å‹¾é€‰å’Œç”¨æˆ·ä¿¡æ¯ä¿å­˜é€»è¾‘
 */
@Entry
@Component
struct LoginPage {
  // --- çŠ¶æ€å˜é‡ ---
  @State usernameStr: string = '';
  @State passwordStr: string = '';
  @State isRemember: boolean = false; // è¿™é‡Œçš„â€œè®°ä½å¯†ç â€æˆ‘ä»¬ç”¨æ¥ä½œä¸ºâ€œè‡ªåŠ¨ç™»å½•â€çš„å¼€å…³

  // æ•°æ®åº“å·¥å…·ç±»
  private rdbHelper: RdbHelper | null = null;

  /**
   * é¡µé¢åˆå§‹åŒ–
   */
  aboutToAppear() {
    try {
      let context = getContext(this) as common.UIAbilityContext;
      this.rdbHelper = new RdbHelper(context);

      // åˆå§‹åŒ–æ•°æ®åº“
      this.rdbHelper.initRdbStore((isSuccess: boolean) => {
        if (!isSuccess) {
          this.showToast('æ•°æ®åº“å¼‚å¸¸ï¼Œè¯·é‡å¯åº”ç”¨');
        }
      });

      // 2. åˆå§‹åŒ–åå¥½è®¾ç½®å·¥å…· (ä¸ºäº†åŽç»­ä¿å­˜ç™»å½•çŠ¶æ€)
      PreferenceUtil.init(context);

    } catch (err) {
      console.error(`[LoginPage] init failed: ${JSON.stringify(err)}`);
    }
  }

  /**
   * é€šç”¨ Toast æç¤º
   */
  showToast(msg: string) {
    try {
      promptAction.showToast({
        message: msg,
        duration: 2000,
        bottom: 100
      });
    } catch (error) {
      console.error(`[LoginPage] showToast error: ${JSON.stringify(error)}`);
    }
  }

  /**
   * å¤„ç†ç™»å½•é€»è¾‘
   */
  handleLogin() {
    if (this.usernameStr === '' || this.passwordStr === '') {
      this.showToast('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
      return;
    }

    if (!this.rdbHelper) {
      this.showToast('ç³»ç»Ÿåˆå§‹åŒ–ä¸­...');
      return;
    }

    // æŸ¥è¯¢æ•°æ®åº“
    this.rdbHelper.queryUser(this.usernameStr).then((user: User | null) => {
      if (user) {
        // ç”¨æˆ·å­˜åœ¨ï¼Œæ ¡éªŒå¯†ç 
        if (user.getPassword() === this.passwordStr) {
          this.showToast('ç™»å½•æˆåŠŸï¼æ¬¢è¿Žå›žæ¥');

          // ==========================================
          // ðŸ‘‡ðŸ‘‡ðŸ‘‡ ã€æ–°å¢žã€‘ä¿å­˜è‡ªåŠ¨ç™»å½•ä¿¡æ¯ ðŸ‘‡ðŸ‘‡ðŸ‘‡
          if (this.isRemember) {
            // å¦‚æžœå‹¾é€‰äº†â€œè®°ä½å¯†ç /è‡ªåŠ¨ç™»å½•â€ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° Preferences
            PreferenceUtil.saveLoginInfo(user.getId(), user.getUsername());
          }
          // ==========================================

          // ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°ä¸»é¡µ
          setTimeout(() => {
            try {
              router.replaceUrl({
                url: 'pages/Index',
                params: {
                  username: user.getUsername(), // ä¼ å‚
                  userId: user.getId()
                }
              });
            } catch (err) {
              console.error(`[LoginPage] router error: ${JSON.stringify(err)}`);
            }
          }, 1000);

        } else {
          this.showToast('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
        }
      } else {
        this.showToast('ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ');
      }
    }).catch((err: BusinessError) => {
      console.error(`Login failed: ${err}`);
      this.showToast('ç™»å½•å‡ºé”™ï¼Œè¯·ç¨åŽé‡è¯•');
    });
  }

  build() {
    Column() {
      // --- æ ‡é¢˜åŒºåŸŸ ---
      Text('Account Manager')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(0x333333)
        .margin({ top: 80, bottom: 50 })

      // --- è¾“å…¥åŒºåŸŸ ---
      Column({ space: 15 }) {
        // ç”¨æˆ·å
        TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å' })
          .width('100%')
          .height(50)
          .backgroundColor(0xF5F5F5)
          .borderRadius(25)
          .padding({ left: 20 })
          .onChange((value: string) => {
            this.usernameStr = value;
          })

        // å¯†ç 
        TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ' })
          .width('100%')
          .height(50)
          .backgroundColor(0xF5F5F5)
          .borderRadius(25)
          .padding({ left: 20 })
          .type(InputType.Password)
          .onChange((value: string) => {
            this.passwordStr = value;
          })
      }
      .width('85%')

      // --- è¾…åŠ©åŠŸèƒ½åŒº ---
      Row() {
        Row() {
          // è¿™ä¸ª Checkbox çŽ°åœ¨æŽ§åˆ¶æ˜¯å¦â€œè‡ªåŠ¨ç™»å½•â€
          Checkbox({ name: 'remember', group: 'login' })
            .select(this.isRemember)
            .selectedColor(0x007DFF)
            .onChange((value: boolean) => {
              this.isRemember = value;
            })
          // ä¸ºäº†æ›´æ˜Žç¡®ï¼Œä½ å¯ä»¥æŠŠæ–‡æ¡ˆæ”¹æˆâ€œä¸‹æ¬¡è‡ªåŠ¨ç™»å½•â€
          Text('ä¸‹æ¬¡è‡ªåŠ¨ç™»å½•')
            .fontSize(14)
            .fontColor(Color.Gray)
            .onClick(() => {
              this.isRemember = !this.isRemember;
            })
        }

        Blank()

        Text('å¿˜è®°å¯†ç ï¼Ÿ')
          .fontSize(14)
          .fontColor(0x007DFF)
          // ðŸ‘‡ å¿…é¡»æœ‰è¿™ä¸ª onClick è·³è½¬ ðŸ‘‡
          .onClick(() => {
            try {
              router.pushUrl({ url: 'pages/ForgotPasswordPage' });
            } catch (e) {
              console.error(`Nav error: ${e}`);
            }
          })
      }
      .width('80%')
      .margin({ top: 15, bottom: 30 })

      // --- ç™»å½•æŒ‰é’® ---
      Button('ç™» å½•')
        .width('85%')
        .height(50)
        .borderRadius(25)
        .backgroundColor(0x007DFF)
        .fontSize(18)
        .onClick(() => {
          this.handleLogin();
        })

      // --- æ³¨å†Œå¼•å¯¼ ---
      Row() {
        Text('è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ ')
          .fontSize(14)
          .fontColor(Color.Gray)

        Text('ç«‹å³æ³¨å†Œ')
          .fontSize(14)
          .fontColor(0x007DFF)
          .fontWeight(FontWeight.Medium)
          .onClick(() => {
            try {
              router.pushUrl({
                url: 'pages/RegisterPage'
              });
            } catch (err) {
              console.error(`Navigation failed: ${err}`);
            }
          })
      }
      .margin({ top: 20 })

    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }
}