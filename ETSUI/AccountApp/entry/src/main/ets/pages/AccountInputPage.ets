import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import RdbHelper from '../database/RdbHelper';
import AppAccount from '../model/AppAccount';

@Entry
@Component
struct AccountInputPage {
  // --- çŠ¶æ€å˜é‡ ---
  @State platform: string = '';
  @State account: string = '';
  @State password: string = '';

  // ã€æ–°å¢ã€‘å¯†ç å¼ºåº¦çŠ¶æ€
  @State strengthLevel: number = 0; // 0:æ— , 1:å¼±, 2:ä¸­, 3:å¼º
  @State strengthColor: Color = Color.Gray;
  @State strengthText: string = '';

  // æ ¸å¿ƒå˜é‡
  private currentUserId: number = 0;
  private editAccountId: number = 0;
  private rdbHelper: RdbHelper | null = null;

  aboutToAppear() {
    try {
      let params = router.getParams() as Record<string, Object>;
      if (params) {
        if (params['userId']) this.currentUserId = params['userId'] as number;
        if (params['id']) {
          this.editAccountId = params['id'] as number;
          this.platform = params['platform'] as string;
          this.account = params['account'] as string;
          this.password = params['password'] as string;
          // åˆå§‹åŒ–æ—¶æ£€æµ‹ä¸€æ¬¡å¼ºåº¦
          this.checkStrength(this.password);
        }
      }
    } catch (e) { console.error(`Get params failed: ${e}`); }

    try {
      let context = getContext(this) as common.UIAbilityContext;
      this.rdbHelper = new RdbHelper(context);
      this.rdbHelper.initRdbStore((isSuccess: boolean) => {});
    } catch (e) { console.error(`Init DB failed: ${e}`); }
  }

  safeToast(msg: string): void {
    try { promptAction.showToast({ message: msg }); } catch (e) {}
  }

  safeBack(): void {
    try { router.back(); } catch (e) {}
  }

  /**
   * ã€æ–°å¢ã€‘æ ¸å¿ƒç®—æ³•ï¼šæ£€æµ‹å¯†ç å¼ºåº¦
   */
  checkStrength(pwd: string) {
    if (pwd.length === 0) {
      this.strengthLevel = 0;
      this.strengthText = '';
      return;
    }

    let score = 0;
    // 1. é•¿åº¦å¥–åŠ±
    if (pwd.length >= 6) score += 1;
    if (pwd.length >= 10) score += 1;

    // 2. å­—ç¬¦ç±»å‹å¥–åŠ±
    const hasLower = /[a-z]/.test(pwd);
    const hasUpper = /[A-Z]/.test(pwd);
    const hasNum = /[0-9]/.test(pwd);
    const hasSpecial = /[^a-zA-Z0-9]/.test(pwd);

    if (hasLower) score += 1;
    if (hasUpper) score += 1;
    if (hasNum) score += 1;
    if (hasSpecial) score += 2; // ç‰¹æ®Šç¬¦å·æƒé‡é«˜

    // 3. è¯„çº§é€»è¾‘
    if (score < 3) {
      this.strengthLevel = 1;
      this.strengthColor = Color.Red;
      this.strengthText = 'å¼± (å»ºè®®åŠ é•¿æˆ–æ··åˆå­—ç¬¦)';
    } else if (score < 5) {
      this.strengthLevel = 2;
      this.strengthColor = Color.Orange;
      this.strengthText = 'ä¸­ (å°šå¯)';
    } else {
      this.strengthLevel = 3;
      this.strengthColor = 0x00CC66; // é²œç»¿è‰²
      this.strengthText = 'å¼º (éå¸¸å®‰å…¨)';
    }
  }

  generateRandomPassword(): string {
    const length = 12;
    const charset = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%&*+?';
    let result = '';
    for (let i = 0; i < length; i++) {
      const randomIndex = Math.floor(Math.random() * charset.length);
      result += charset.charAt(randomIndex);
    }
    this.safeToast('å·²ç”Ÿæˆéšæœºå¼ºå¯†ç ');
    // ç”Ÿæˆåä¹Ÿè¦æ£€æµ‹å¼ºåº¦
    this.checkStrength(result);
    return result;
  }

  handleSave() {
    if (this.platform === '' || this.account === '' || this.password === '') {
      this.safeToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
      return;
    }
    if (this.currentUserId === 0) {
      this.safeToast('ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
      return;
    }

    let newAccount = new AppAccount(this.platform, this.account, this.password, this.currentUserId);

    if (this.rdbHelper) {
      if (this.editAccountId > 0) {
        newAccount.setId(this.editAccountId);
        this.rdbHelper.updateAppAccount(newAccount).then((rows) => {
          if (rows >= 0) {
            this.safeToast('ä¿®æ”¹æˆåŠŸ');
            setTimeout(() => this.safeBack(), 500);
          }
        });
      } else {
        this.rdbHelper.insertAppAccount(newAccount).then((rowId) => {
          if (rowId > 0) {
            this.safeToast('ä¿å­˜æˆåŠŸ');
            setTimeout(() => this.safeBack(), 500);
          }
        });
      }
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('< è¿”å›').fontSize(16).fontColor(Color.Gray).onClick(() => this.safeBack())
        Blank()
        Text(this.editAccountId > 0 ? 'ç¼–è¾‘è´¦å·' : 'æ·»åŠ æ–°è´¦å·').fontSize(18).fontWeight(FontWeight.Bold)
        Blank()
        Text('      ')
      }
      .width('100%').padding(15).backgroundColor(Color.White)

      Column({ space: 20 }) {
        // å¹³å°
        Column({ space: 8 }) {
          Text('å¹³å°åç§°').fontSize(14).fontColor(Color.Gray).width('100%')
          TextInput({ text: this.platform, placeholder: 'ä¾‹å¦‚: å¾®ä¿¡ / QQ' })
            .height(50).backgroundColor(0xF5F5F5).borderRadius(10)
            .onChange((val) => this.platform = val)
        }

        // è´¦å·
        Column({ space: 8 }) {
          Text('è´¦å· / ç”¨æˆ·å').fontSize(14).fontColor(Color.Gray).width('100%')
          TextInput({ text: this.account, placeholder: 'è¾“å…¥æ‚¨çš„è´¦å·' })
            .height(50).backgroundColor(0xF5F5F5).borderRadius(10)
            .onChange((val) => this.account = val)
        }

        // å¯†ç åŒºåŸŸ (UIæ”¹é€ )
        Column({ space: 8 }) {
          Text('å¯†ç ').fontSize(14).fontColor(Color.Gray).width('100%')

          Row({ space: 10 }) {
            TextInput({ text: this.password, placeholder: 'è¾“å…¥å¯†ç ' })
              .layoutWeight(1).height(50).backgroundColor(0xF5F5F5).borderRadius(10)
              .onChange((val) => {
                this.password = val;
                this.checkStrength(val); // ã€æ ¸å¿ƒã€‘å®æ—¶æ£€æµ‹
              })
            Button('ğŸ² ç”Ÿæˆ')
              .height(50).fontSize(14).backgroundColor(0xF0F8FF).fontColor(0x007DFF).borderRadius(10)
              .onClick(() => {
                this.password = this.generateRandomPassword();
              })
          }.width('100%')

          // ã€æ–°å¢ã€‘å¼ºåº¦æŒ‡ç¤ºæ¡
          if (this.password.length > 0) {
            Row({ space: 5 }) {
              // ä¸‰æ®µå¼è¿›åº¦æ¡
              Row().height(4).layoutWeight(1).borderRadius(2)
                .backgroundColor(this.strengthLevel >= 1 ? this.strengthColor : 0xE0E0E0)
              Row().height(4).layoutWeight(1).borderRadius(2)
                .backgroundColor(this.strengthLevel >= 2 ? this.strengthColor : 0xE0E0E0)
              Row().height(4).layoutWeight(1).borderRadius(2)
                .backgroundColor(this.strengthLevel >= 3 ? this.strengthColor : 0xE0E0E0)
            }.width('100%').margin({ top: 5 })

            // æ–‡å­—æç¤º
            Text(this.strengthText)
              .fontSize(12)
              .fontColor(this.strengthColor)
              .width('100%')
              .textAlign(TextAlign.End)
          }
        }

        Button('ä¿ å­˜')
          .width('100%').height(50).backgroundColor(0x007DFF).borderRadius(25)
          .fontSize(18).margin({ top: 30 })
          .onClick(() => this.handleSave())
      }
      .padding(20).width('100%').layoutWeight(1).backgroundColor(Color.White)
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }
}