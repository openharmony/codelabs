/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import pasteboard from '@ohos.pasteboard';
import Want from '@ohos.app.ability.Want';
import { BusinessError } from '@ohos.base';
import RdbHelper from '../database/RdbHelper';
import AppAccount from '../model/AppAccount';
import PreferenceUtil from '../utils/PreferenceUtil';

@Entry
@Component
struct Index {
  @State currentUsername: string = 'User';
  @State currentUserId: number = 0;
  @State searchText: string = '';
  @State accountList: Array<AppAccount> = [];
  @State allAccounts: Array<AppAccount> = [];
  @State isVisibleMap: Record<number, boolean> = {};

  // --- ã€æ‰¾å›ã€‘å¥åº·ä½“æ£€çŠ¶æ€ ---
  @State securityScore: number = 100;
  @State weakCount: number = 0;
  @State duplicateCount: number = 0;

  private rdbHelper: RdbHelper | null = null;

  aboutToAppear(): void {
    // 1. å°è¯•ä»è·¯ç”±å‚æ•°è·å–
    try {
      let params = router.getParams() as Record<string, Object>;
      if (params) {
        if (params['username']) this.currentUsername = params['username'] as string;
        if (params['userId']) this.currentUserId = params['userId'] as number;
      }
    } catch (e) { console.error(`Params error: ${JSON.stringify(e)}`); }

    let context = getContext(this) as common.UIAbilityContext;

    // 2. å…œåº•é€»è¾‘ï¼šè‡ªåŠ¨ç™»å½•
    if (this.currentUserId === 0) {
      PreferenceUtil.init(context).then(async () => {
        const info = await PreferenceUtil.getLoginInfo();
        if (info) {
          this.currentUsername = info.username;
          this.currentUserId = info.userId;
          this.loadData();
        }
      });
    }

    try {
      this.rdbHelper = new RdbHelper(context);
      this.rdbHelper.initRdbStore((isSuccess: boolean) => {
        if (isSuccess) this.loadData();
      });
    } catch (e) { console.error(`DB error: ${JSON.stringify(e)}`); }
  }

  onPageShow(): void {
    this.loadData();
  }

  loadData(): void {
    if (!this.rdbHelper || this.currentUserId === 0) return;
    this.rdbHelper.queryAppAccounts(this.currentUserId).then((list) => {
      this.allAccounts = list;
      // ã€æ‰¾å›ã€‘åŠ è½½å®Œæ•°æ®åï¼Œç«‹å³è¿›è¡Œä½“æ£€
      this.analyzeSecurity(list);
      this.filterData();
    });
  }


  analyzeSecurity(list: Array<AppAccount>): void {
    // 1. ç©ºåˆ—è¡¨å¤„ç†ï¼šé»˜è®¤ä¸º 100 åˆ†
    if (list.length === 0) {
      this.securityScore = 100;
      this.weakCount = 0;
      this.duplicateCount = 0;
      return;
    }

    let lowCount = 0;    // ä½å¼ºåº¦æ•°é‡
    let mediumCount = 0; // ä¸­å¼ºåº¦æ•°é‡
    let highCount = 0;   // é«˜å¼ºåº¦æ•°é‡

    let duplicates = 0;
    const pwdMap = new Map<string, number>();

    list.forEach(item => {
      const pwd = item.getPassword();

      // --- A. ç»Ÿè®¡é‡å¤ ---
      if (pwdMap.has(pwd)) {
        let count = pwdMap.get(pwd);
        if (count !== undefined) pwdMap.set(pwd, count + 1);
      } else {
        pwdMap.set(pwd, 1);
      }

      // --- B. è®¡ç®—å•æ¡å¯†ç å¼ºåº¦ (å¤ç”¨ AccountInputPage çš„é€»è¾‘) ---
      let itemScore = 0;
      // é•¿åº¦åŠ åˆ†
      if (pwd.length >= 8) itemScore += 1; // åŸºç¡€é•¿åº¦
      if (pwd.length >= 10) itemScore += 1; // è¾ƒé•¿

      // å­—ç¬¦ç±»å‹åŠ åˆ†
      if (/[a-z]/.test(pwd)) itemScore += 1; // å°å†™
      if (/[A-Z]/.test(pwd)) itemScore += 1; // å¤§å†™
      if (/[0-9]/.test(pwd)) itemScore += 1; // æ•°å­—
      if (/[^a-zA-Z0-9]/.test(pwd)) itemScore += 2; // ç‰¹æ®Šç¬¦å·(æƒé‡é«˜)

      // --- C. å½’ç±» (ä½/ä¸­/é«˜) ---
      // è¯„åˆ†æ ‡å‡†ï¼š<3åˆ†=ä½, <5åˆ†=ä¸­, >=5åˆ†=é«˜
      if (itemScore < 3) {
        lowCount++;
      } else if (itemScore < 5) {
        mediumCount++;
      } else {
        highCount++;
      }
    });

    // --- D. è®¡ç®—é‡å¤æ€»æ•° ---
    pwdMap.forEach((count) => {
      if (count > 1) duplicates += (count - 1);
    });

    // --- E. ã€æ ¸å¿ƒã€‘åŠ æƒè®¡ç®—æ€»åˆ† ---
    // ç®—æ³•ï¼š( (é«˜*100) + (ä¸­*60) + (ä½*0) ) / æ€»æ•°é‡
    // è¿™æ ·èƒ½å‡†ç¡®åæ˜ æ•´ä½“è´¦å·è´¨é‡
    let totalPoints = (highCount * 100) + (mediumCount * 60) + (lowCount * 0);
    let averageScore = totalPoints / list.length;

    // --- F. æ‰£é™¤é‡å¤é¡¹æƒ©ç½š ---
    // æ¯ä¸ªé‡å¤é¡¹æ‰£ 5 åˆ† (å¯è‡ªè¡Œè°ƒæ•´æƒé‡)
    let finalScore = averageScore - (duplicates * 5);

    // å…œåº•ï¼šèŒƒå›´é™åˆ¶åœ¨ 0-100
    if (finalScore < 0) finalScore = 0;
    if (finalScore > 100) finalScore = 100;

    // æ›´æ–°çŠ¶æ€
    this.weakCount = lowCount; // è¿™é‡ŒæŠŠ"ä½å¼ºåº¦"çš„æ•°é‡ä½œä¸º"å¼±å¯†ç "æ˜¾ç¤º
    this.duplicateCount = duplicates;
    this.securityScore = Math.floor(finalScore);
  }

  filterData(): void {
    let keyword = this.searchText.trim().toLowerCase();
    if (keyword === '') {
      this.accountList = this.allAccounts;
    } else {
      this.accountList = this.allAccounts.filter((item) => {
        return item.getPlatformName().toLowerCase().includes(keyword) ||
        item.getAccountName().toLowerCase().includes(keyword);
      });
    }
  }

  safeToast(msg: string): void {
    try { promptAction.showToast({ message: msg }); } catch (e) {}
  }

  getAvatarColor(name: string): string {
    const n = name.toLowerCase();
    if (n.includes('å¾®ä¿¡') || n.includes('wechat')) return '#07C160';
    if (n.includes('æ”¯ä»˜å®') || n.includes('alipay')) return '#1677FF';
    if (n.includes('æ·˜å®') || n.includes('taobao')) return '#FF5000';
    if (n.includes('äº¬ä¸œ') || n.includes('jd')) return '#E1251B';
    if (n.includes('qq')) return '#12B7F5';
    if (n.includes('æŠ–éŸ³') || n.includes('tiktok')) return '#1C1C1C';
    if (n.includes('google') || n.includes('è°·æ­Œ')) return '#DB4437';
    if (n.includes('bilibili')) return '#FB7299';

    const colors = ['#F56A00', '#7265E6', '#FFBF00', '#00A2AE', '#9F4D95', '#1FCEC3'];
    let index = 0;
    if (name.length > 0) {
      index = name.charCodeAt(0) % colors.length;
    }
    return colors[index];
  }

  getAvatarText(name: string): string {
    if (!name) return '?';
    return name.substring(0, 1).toUpperCase();
  }

  jumpToTargetApp(platformName: string, password: string): void {
    try {
      let data = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, password);
      let systemPasteboard = pasteboard.getSystemPasteboard();
      systemPasteboard.setData(data).then(() => {
        this.safeToast('å¯†ç å·²å¤åˆ¶ (30ç§’åæ¸…é™¤)');
        setTimeout(() => {
          try {
            let sysPb = pasteboard.getSystemPasteboard();
            sysPb.clear();
          } catch(e) {}
        }, 30000);
      }).catch((err: BusinessError) => {
        console.error(`Paste failed: ${err.message}`);
      });
    } catch (e) {
      console.error(`Paste error: ${JSON.stringify(e)}`);
    }

    let context = getContext(this) as common.UIAbilityContext;
    if (platformName.startsWith('http') || platformName.startsWith('www') || platformName.includes('.com')) {
      let url = platformName.startsWith('http') ? platformName : 'https://' + platformName;
      let wantInfo: Want = { action: 'ohos.want.action.viewData', entities: ['entity.system.browsable'], uri: url };
      try { context.startAbility(wantInfo).catch((err: BusinessError) => {}); } catch (e) {}
      return;
    }

    let targetBundleName = '';
    if (platformName.includes('å¾®ä¿¡')) targetBundleName = 'com.tencent.mm';
    else if (platformName.includes('æ·˜å®')) targetBundleName = 'com.taobao.taobao';
    else if (platformName.includes('æ”¯ä»˜å®')) targetBundleName = 'com.eg.android.AlipayGphone';
    else if (platformName.includes('æŠ–éŸ³')) targetBundleName = 'com.ss.android.ugc.aweme';
    else if (platformName.includes('QQ') || platformName.includes('qq')) targetBundleName = 'com.tencent.mobileqq';

    if (targetBundleName !== '') {
      let wantInfo: Want = { bundleName: targetBundleName, abilityName: 'EntryAbility' };
      try { context.startAbility(wantInfo).catch(() => this.safeToast('æœªæ£€æµ‹åˆ°åº”ç”¨')); } catch (e) {}
    }
  }

  handleDelete(id: number): void {
    try {
      AlertDialog.show({
        title: 'åˆ é™¤ç¡®è®¤',
        message: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ',
        primaryButton: { value: 'å–æ¶ˆ', action: () => {} },
        secondaryButton: {
          value: 'åˆ é™¤', fontColor: Color.Red,
          action: () => {
            this.rdbHelper?.deleteAppAccount(id).then((rows) => {
              if (rows > 0) {
                this.safeToast('å·²åˆ é™¤');
                this.loadData();
              }
            });
          }
        }
      });
    } catch (e) {}
  }

  toggleVisibility(id: number): void {
    let newMap: Record<number, boolean> = JSON.parse(JSON.stringify(this.isVisibleMap));
    newMap[id] = !newMap[id];
    this.isVisibleMap = newMap;
  }

  @Builder SwipeMenu(item: AppAccount) {
    Row() {
      Button() {
        Column() { Text('ç¼–è¾‘').fontColor(Color.White).fontSize(14) }.justifyContent(FlexAlign.Center)
      }
      .width(60).height('100%').backgroundColor(0x007DFF).type(ButtonType.Normal)
      .onClick(() => {
        try {
          router.pushUrl({
            url: 'pages/AccountInputPage',
            params: { userId: this.currentUserId, id: item.getId(), platform: item.getPlatformName(), account: item.getAccountName(), password: item.getPassword() }
          });
        } catch (e) {}
      })

      Button() { Text('åˆ é™¤').fontColor(Color.White).fontSize(14) }
      .width(60).height('100%').backgroundColor(Color.Red).type(ButtonType.Normal)
      .onClick(() => { this.handleDelete(item.getId()); })
    }
    .height('100%')
  }

  // --- ã€æ‰¾å›ã€‘å¥åº·è¯„åˆ†å¡ç‰‡ UI ---
  @Builder SecurityCard() {
    Column() {
      Row() {
        Column() {
          Text('å®‰å…¨è¯„åˆ†')
            .fontSize(15).fontWeight(800).fontColor(Color.White).opacity(0.9)
          Text(`${this.securityScore}`)
            .fontSize(40).fontWeight(FontWeight.Bold).fontColor(Color.White)
            .margin({ top: 5 })
        }.alignItems(HorizontalAlign.Start)

        Blank()

        // å³ä¾§çŠ¶æ€
        Column({ space: 8 }) {
          Row() {
            Text('âš ï¸ å¼±å¯†ç : ').fontSize(15).fontWeight(800).fontColor(Color.White).opacity(0.9)
            Text(`${this.weakCount}`).fontSize(14).fontWeight(800).fontColor(Color.White)
          }
          Row() {
            Text('â™»ï¸ é‡å¤é¡¹: ').fontSize(15).fontWeight(900).fontColor(Color.White).opacity(0.9)
            Text(`${this.duplicateCount}`).fontSize(14).fontWeight(900).fontColor(this.duplicateCount > 0 ? 0xFF5252 : Color.White)
          }
        }.alignItems(HorizontalAlign.End)
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(this.securityScore >= 90 ? 0x07C160 : (this.securityScore >= 60 ? 0xFFC107 : 0xFF5252))
    .borderRadius(16)
    .shadow({ radius: 10, color: 0x33000000, offsetY: 5 })
    .margin({ bottom: 20 })
  }

  build() {
    Column() {
      // é¡¶éƒ¨
      Column() {
        Row() {
          Text('æˆ‘çš„å¯†ç æœ¬').fontSize(22).fontWeight(FontWeight.Bold).fontColor(Color.White)
          Blank()

          // âš™ï¸ è®¾ç½®æŒ‰é’®
          Row() {
            Text('âš™ï¸ è®¾ç½®')
              .fontSize(16).fontWeight(FontWeight.Bold).fontColor(Color.White)
          }
          .onClick(() => {
            try {
              router.pushUrl({ url: 'pages/SettingsPage' });
            } catch (e) {
              console.error(`Nav error: ${JSON.stringify(e)}`);
            }
          })
        }.width('100%').margin({ bottom: 10 })

        Text(`æ¬¢è¿ä½ ï¼Œ${this.currentUsername}`).fontSize(14).fontColor(Color.White).opacity(0.8).width('100%').margin({ bottom: 15 })

        Search({ value: this.searchText, placeholder: 'æœç´¢å¹³å°æˆ–è´¦å·...' })
          .width('100%').height(40).backgroundColor(Color.White).borderRadius(20)
          .onChange((value: string) => { this.searchText = value; this.filterData(); })
      }
      .width('100%').height(160).backgroundColor(0x007DFF).padding(20)

      // åˆ—è¡¨åŒºåŸŸ (ç”¨ Stack è¦†ç›–æ–¹å¼è®© List å¯ä»¥æ»šåˆ°é¡¶éƒ¨ä¸‹é¢)
      Column() {
        List({ space: 12 }) {
          // 1. æŠŠâ€œæ·»åŠ æŒ‰é’®â€æ”¾è¿› List çš„ç¬¬ä¸€ä¸ª Item (Header)
          ListItem() {
            Button('+ æ·»åŠ æ–°è´¦å·')
              .width('100%').height(45).backgroundColor(Color.White).fontColor(0x007DFF)
              .border({ width: 1, color: 0x007DFF })
              .onClick(() => { try { router.pushUrl({ url: 'pages/AccountInputPage', params: { userId: this.currentUserId } }); } catch(e){} })
          }.margin({ top: 15, bottom: 5 })

          // 2. ã€æ‰¾å›ã€‘æ˜¾ç¤ºä½“æ£€å¡ç‰‡ (å¦‚æœæœ‰æ•°æ®çš„è¯)
          if (this.allAccounts.length > 0) {
            ListItem() {
              this.SecurityCard()
            }
          }

          // 3. æ•°æ®åˆ—è¡¨
          if (this.accountList.length === 0) {
            ListItem() {
              Column() {
                Text(this.searchText ? 'æœªæ‰¾åˆ°ç»“æœ' : 'ç©ºç©ºå¦‚ä¹Ÿ').fontSize(16).fontColor(Color.Gray).margin({ top: 30 })
              }.width('100%').justifyContent(FlexAlign.Center)
            }
          } else {
            ForEach(this.accountList, (item: AppAccount) => {
              ListItem() {
                // å¡ç‰‡ä¸»ä½“
                Row() {
                  Stack({ alignContent: Alignment.Center }) {
                    Circle({ width: 50, height: 50 }).fill(this.getAvatarColor(item.getPlatformName()))
                    Text(this.getAvatarText(item.getPlatformName())).fontSize(20).fontColor(Color.White).fontWeight(FontWeight.Bold)
                  }.margin({ right: 15 })

                  Column() {
                    Row() {
                      Text(item.getPlatformName()).fontSize(18).fontWeight(FontWeight.Bold).fontColor(0x333333).layoutWeight(1)
                      Text('ğŸš€').fontSize(16).backgroundColor(0xF0F8FF).padding(8).borderRadius(20)
                        .onClick(() => this.jumpToTargetApp(item.getPlatformName(), item.getPassword()))
                    }.width('100%').margin({ bottom: 8 })

                    Text(item.getAccountName()).fontSize(14).fontColor(Color.Gray).width('100%').margin({ bottom: 5 })
                      .onClick(() => {
                        try {
                          let data = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, item.getAccountName());
                          let sysPb = pasteboard.getSystemPasteboard();
                          sysPb.setData(data).then(() => this.safeToast(`è´¦å·å·²å¤åˆ¶`));
                        } catch(e){}
                      })

                    Row() {
                      if (this.isVisibleMap[item.getId()]) {
                        Text(item.getPassword()).fontSize(16).fontColor(0x007DFF).fontWeight(FontWeight.Bold)
                      } else {
                        Text('â€¢â€¢â€¢â€¢â€¢â€¢').fontSize(16).fontColor(Color.Black).letterSpacing(2)
                      }
                      Blank()
                      Text(this.isVisibleMap[item.getId()] ? 'ğŸ™ˆ' : 'ğŸ‘ï¸').fontSize(18).padding(5)
                        .onClick(() => this.toggleVisibility(item.getId()))
                    }.width('100%')
                  }.layoutWeight(1)
                }
                .padding(15).backgroundColor(Color.White).borderRadius(12)
                .shadow({ radius: 5, color: 0xDDDDDD, offsetX: 2, offsetY: 2 })
              }
              .swipeAction({ end: this.SwipeMenu(item) })
            })
          }
        }
        .width('90%').height('100%').layoutWeight(1).edgeEffect(EdgeEffect.Spring)
        .padding({ left: 15, right: 15 }) // ç»™åˆ—è¡¨åŠ ç‚¹å·¦å³è¾¹è·
      }
      .layoutWeight(1) // å¡«æ»¡å‰©ä½™é«˜åº¦
      .backgroundColor(0xF0F2F5)
    }
    .width('100%').height('100%').backgroundColor(0xF0F2F5)
  }
}