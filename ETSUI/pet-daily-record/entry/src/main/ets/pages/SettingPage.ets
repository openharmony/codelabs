/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import promptAction from '@ohos.promptAction';
import dataPreferences from '@ohos.data.preferences';

/**
 * ============================================================================
 * ã€ä¸ªäººè®¾ç½®é¡µé¢ç»„ä»¶ã€‘
 * æ ¸å¿ƒåŠŸèƒ½ï¼šå¤šç”¨æˆ·ä¸ªæ€§åŒ–æ˜µç§°è®¾ç½®ä¸è´¦å·æ³¨é”€ç³»ç»Ÿ
 * ============================================================================
 */
@Component
export struct SettingPage {
  /** æœ€ç»ˆå±•ç¤ºçš„æ˜µç§° */
  @State nickname: string = 'èŒå® ä¸»'
  /** æ–‡æœ¬æ¡†è¾“å…¥çš„ä¸´æ—¶å†…å®¹ */
  @State inputNickname: string = ''
  /** åŒæ­¥å…¨å±€ç™»å½•çš„ç”¨æˆ·å */
  @StorageLink('currentUserName') loggedUser: string = 'admin'

  /**
   * ç”Ÿå‘½å‘¨æœŸï¼šæ˜¾ç¤ºç»„ä»¶æ—¶ç«‹å³åŒæ­¥ç¡¬ç›˜æ•°æ®
   */
  async aboutToAppear() {
    await this.syncUserPreference();
  }

  /**
   * --- UI æ„å»ºå™¨ï¼šä¸ªäººèµ„æ–™å±•ç¤ºåŒºåŸŸ ---
   */
  @Builder
  UserCard() {
    Column({ space: 12 }) {
      Text('ğŸ¾')
        .fontSize(60)
        .margin({ top: 20 })

      Text(this.nickname)
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')

      Row() {
        Text('èº«ä»½ID: ').fontSize(12).fontColor('#999')
        Text(this.loggedUser).fontSize(12).fontColor('#666').fontWeight(FontWeight.Medium)
      }
      .backgroundColor('#F5F7FA')
      .padding({
        left: 12,
        right: 12,
        top: 4,
        bottom: 4
      })
      .borderRadius(8)
      .margin({ bottom: 20 })
    }
    .width('92%')
    .backgroundColor(Color.White)
    .borderRadius(20)
    .shadow({ radius: 10, color: '#08000000', offsetY: 5 })
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨è‡ªå®šä¹‰æ ‡é¢˜
      Row() {
        Text('è®¾ç½®ä¸­å¿ƒ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
      }
      .width('100%')
      .padding({ left: 25, top: 40, bottom: 20 })

      // 2. èµ„æ–™å¡ç‰‡
      this.UserCard()

      // 3. æ˜µç§°ä¿®æ”¹è¡¨å•åŒºåŸŸ
      Column({ space: 12 }) {
        Text('ä¿®æ”¹æˆ‘çš„æ˜µç§°').fontSize(14).fontColor('#666').width('100%')

        Row({ space: 10 }) {
          TextInput({ text: this.inputNickname, placeholder: 'å–ä¸ªå¥½å¬çš„åå­—...' })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#F5F7FA')
            .borderRadius(10)
            .onChange((val: string) => {
              this.inputNickname = val;
            })

          Button('ä¿å­˜')
            .onClick(() => {
              this.handleSaveNickname();
            })
            .backgroundColor('#4CAF50')
            .height(48)
            .padding({ left: 20, right: 20 })
            .borderRadius(10)
        }
        .width('100%')
      }
      .width('92%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(20)
      .margin({ top: 20 })

      // å æ®å¤šä½™ç©ºé—´
      Blank().layoutWeight(1)

      // 4. é€€å‡ºæ“ä½œåŒº
      Column() {
        Button('é€€å‡ºå½“å‰è´¦å·')
          .width('85%')
          .height(50)
          .backgroundColor('#FFF1F0')
          .fontColor('#F5222D')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .borderRadius(15)
          .margin({ bottom: 40 })
          .onClick(() => {
            this.triggerLogoutProcess();
          })
      }
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F7F8FA')
  }

  /**
   * ä¸šåŠ¡é€»è¾‘ï¼šä»ç£ç›˜åŠ è½½å±äºå½“å‰ç”¨æˆ·çš„ä¸ªæ€§åŒ–é…ç½®
   */
  private async syncUserPreference() {
    try {
      console.info('PetDiary: æ­£åœ¨åŠ è½½ç”¨æˆ· [' + this.loggedUser + '] çš„ä¸ªæ€§åŒ–é…ç½®');
      let pref = await dataPreferences.getPreferences(getContext(this), 'AccountStore');

      /**
       * ç»„é•¿è®¾è®¡ç‚¹ï¼šä½¿ç”¨åŠ¨æ€ Key é¿å…è´¦å·é—´æ•°æ®æ±¡æŸ“
       * å­˜å‚¨æ ¼å¼å¦‚ï¼šnickname_admin, nickname_zqh
       */
      const savedName = await pref.get('nickname_' + this.loggedUser, 'èŒå® ä¸»') as string;

      this.nickname = savedName;
      this.inputNickname = savedName;

      console.info('PetDiary: æ˜µç§°é…ç½®åŠ è½½å®Œæˆ -> ' + savedName);
    } catch (e) {
      console.error('PetDiary: é…ç½®åŠ è½½å¼‚å¸¸');
    }
  }

  /**
   * ä¸šåŠ¡é€»è¾‘ï¼šæŒä¹…åŒ–ä¿å­˜è‡ªå®šä¹‰æ˜µç§°
   */
  private async handleSaveNickname() {
    // 1. åŸºç¡€æ ¡éªŒ
    if (this.inputNickname.trim() === '') {
      promptAction.showToast({ message: 'æ˜µç§°ä¸èƒ½ä¸ºç©º' });
      return;
    }

    if (this.inputNickname.length > 10) {
      promptAction.showToast({ message: 'æ˜µç§°å¤ªé•¿äº†(é™10å­—)' });
      return;
    }

    try {
      // 2. å†™å…¥ç¡¬ç›˜
      let pref = await dataPreferences.getPreferences(getContext(this), 'AccountStore');
      await pref.put('nickname_' + this.loggedUser, this.inputNickname);
      await pref.flush(); // å¿…é¡»è½ç›˜

      // 3. æ›´æ–°ç•Œé¢çŠ¶æ€
      this.nickname = this.inputNickname;
      promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸ âœ¨' });
      console.info('PetDiary: ç”¨æˆ·æ˜µç§°å·²æ›´æ–°ä¸º -> ' + this.nickname);

    } catch (err) {
      console.error('PetDiary: æ˜µç§°ä¿å­˜å¤±è´¥');
      promptAction.showToast({ message: 'ç³»ç»Ÿç¹å¿™ï¼Œä¿å­˜å¤±è´¥' });
    }
  }

  /**
   * ä¸šåŠ¡é€»è¾‘ï¼šæ‰§è¡Œé€€å‡ºç™»å½•æµç¨‹
   */
  private triggerLogoutProcess() {
    AlertDialog.show({
      title: 'æ³¨é”€ç¡®è®¤',
      message: 'ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å· [' + this.loggedUser + '] å—ï¼Ÿ',
      primaryButton: {
        value: 'è¿”å›',
        action: () => {
          console.info('User cancelled logout.');
        }
      },
      secondaryButton: {
        value: 'é€€å‡ºç™»å½•',
        fontColor: Color.Red,
        action: () => {
          /**
           * ã€ç»„é•¿å¿…çœ‹æ ¸å¿ƒåŠ¨ä½œã€‘
           * è¿™ä¸€è¡Œä»£ç ä¼šæ¸…ç©ºå…¨å±€èº«ä»½ï¼Œç›´æ¥å¯¼è‡´ Index.ets çš„è·¯ç”±å®ˆå«ç”Ÿæ•ˆï¼Œ
           * å°†æ•´ä¸ª UI æ ‘åˆ‡å› LoginPageï¼Œå®ç°å®Œç¾çš„é€€å‡ºæ•ˆæœã€‚
           */
          AppStorage.setOrCreate('currentUserName', '');

          console.info('PetDiary: Session cleared. Identity card destroyed.');
          promptAction.showToast({ message: 'å·²å®‰å…¨é€€å‡º' });
        }
      }
    })
  }
}