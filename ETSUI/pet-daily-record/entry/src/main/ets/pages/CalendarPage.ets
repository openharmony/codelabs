/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { DatabaseManager } from '../models/DatabaseManager';
import { Pet, PetRecord } from '../models/PetModel';
import reminderAgentManager from '@ohos.reminderAgentManager';
import notificationManager from '@ohos.notificationManager';
import promptAction from '@ohos.promptAction';

/**
 * æ¥å£å®šä¹‰ï¼šå® ç‰©è¡Œä¸ºè¯æ¡é¡¹çš„ä¸¥æ ¼ç±»å‹çº¦æŸ
 * å¢åŠ ä»£ç ä¸¥è°¨æ€§
 */
interface PetActionItem {
  label: string;
  icon: string;
  color: string;
}

/**
 * ç³»ç»Ÿå¸¸é‡ï¼šå® ç‰© 9 å¤§æ ¸å¿ƒè¡Œä¸ºè¯æ¡é…ç½®
 * é›†ä¸­ç®¡ç†ä»¥ä¾¿äºåæœŸç»´æŠ¤å’Œæ‰©å±•
 */
const PET_ACTIONS: PetActionItem[] = [
  { label: 'å–‚é£Ÿ', icon: 'ğŸ–', color: '#FF9800' },
  { label: 'é›å¼¯', icon: 'ğŸ¦®', color: '#4CAF50' },
  { label: 'æ’ä¾¿', icon: 'ğŸ’©', color: '#795548' },
  { label: 'ç–«è‹—', icon: 'ğŸ’‰', color: '#F44336' },
  { label: 'é©±è™«', icon: 'ğŸ’Š', color: '#E91E63' },
  { label: 'å–‚è¯', icon: 'ğŸ¥', color: '#9C27B0' },
  { label: 'æ´—æ¾¡', icon: 'ğŸ›', color: '#2196F3' },
  { label: 'å‰ªæŒ‡ç”²', icon: 'âœ‚ï¸', color: '#00BCD4' },
  { label: 'ç§°é‡', icon: 'âš–ï¸', color: '#607D8B' }
];

/**
 * å­ç»„ä»¶ï¼šé«˜çº§æ—¥ç¨‹æé†’å¼¹çª—
 * é‡‡ç”¨ç‹¬ç«‹ç»“æ„ä½“å®šä¹‰ï¼Œå¢åŠ é¡¹ç›®ä»£ç å±‚çº§æ„Ÿ
 */
@CustomDialog
struct AdvancedReminderDialog {
  controller: CustomDialogController = new CustomDialogController({ builder: '' })
  @State reminderContent: string = ''
  @State selectedDate: Date = new Date()
  @State selectedTime: Date = new Date()
  /**
   * ç¡®è®¤æ“ä½œçš„å›è°ƒæ¥å£
   */
  confirm: (content: string, date: Date, time: Date) => void = () => {
  }

  build() {
    Column() {
      Text('è®¾ç½®è®¡åˆ’æé†’ â°')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 15, bottom: 15 })

      // æé†’å†…å®¹è¾“å…¥åŒºåŸŸ
      TextInput({ placeholder: 'åœ¨æ­¤è¾“å…¥æé†’å¤‡æ³¨...', text: this.reminderContent })
        .onChange((value: string) => {
          this.reminderContent = value;
        })
        .width('90%')
        .height(45)
        .margin({ bottom: 12 })

      Text('ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æ—¥æœŸ')
        .fontSize(14)
        .fontColor('#666666')
        .width('90%')
        .margin({ bottom: 5 })

      DatePicker({ start: new Date(), end: new Date(2026, 11, 31), selected: this.selectedDate })
        .onChange((value: DatePickerResult) => {
          if (value.year !== undefined && value.month !== undefined && value.day !== undefined) {
            this.selectedDate.setFullYear(value.year, value.month, value.day);
          }
        })
        .height(100)
        .width('100%')

      Text('ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æ—¶é—´')
        .fontSize(14)
        .fontColor('#666666')
        .width('90%')
        .margin({ top: 10, bottom: 5 })

      TimePicker({ selected: this.selectedTime })
        .useMilitaryTime(true)
        .onChange((value: TimePickerResult) => {
          if (value.hour !== undefined && value.minute !== undefined) {
            this.selectedTime.setHours(value.hour, value.minute);
          }
        })
        .height(100)
        .width('100%')

      // æ“ä½œæŒ‰é’®å¸ƒå±€
      Row({ space: 20 }) {
        Button('å–æ¶ˆ')
          .onClick(() => {
            this.controller.close();
          })
          .backgroundColor('#F5F5F5')
          .fontColor('#666666')
          .layoutWeight(1)

        Button('ç¡®è®¤æé†’')
          .onClick(() => {
            this.confirm(this.reminderContent, this.selectedDate, this.selectedTime);
            this.controller.close();
          })
          .backgroundColor(Color.Orange)
          .layoutWeight(1)
      }
      .width('90%')
      .margin({ top: 20, bottom: 15 })
    }
    .backgroundColor(Color.White)
    .padding(10)
    .borderRadius(20)
  }
}

/**
 * ä¸»é¡µé¢ç»„ä»¶ï¼šæ—¥å†ä¸æ—¥å¸¸è®°å½•ç³»ç»Ÿ
 */
@Component
export struct CalendarPage {
  /**
   * çŠ¶æ€ç®¡ç†ï¼šå½“å‰æ—¥å†é€‰ä¸­çš„æ—¥æœŸå­—ç¬¦ä¸² (æ ¼å¼: YYYY-MM-DD)
   */
  @State selectedDate: string = '';
  /**
   * çŠ¶æ€ç®¡ç†ï¼šä»æ•°æ®åº“åŠ è½½çš„è¡Œä¸ºè®°å½•æ•°æ®é›†
   */
  @State dayRecords: PetRecord[] = [];
  /**
   * çŠ¶æ€ç®¡ç†ï¼šå½“å‰ç”¨æˆ·é€‰ä¸­çš„è¡Œä¸ºç±»å‹ï¼ˆå¦‚ï¼šå–‚é£Ÿï¼‰
   */
  @State activeType: string = 'å–‚é£Ÿ';
  /**
   * çŠ¶æ€ç®¡ç†ï¼šä¸‹æ–¹çš„å†å²è®°å½•ç­›é€‰æ¡ä»¶
   */
  @State filterType: string = 'å…¨éƒ¨';
  /**
   * çŠ¶æ€ç®¡ç†ï¼šç”¨æˆ·å¡«å†™çš„å®æ—¶å¤‡æ³¨æ–‡æœ¬
   */
  @State userRemark: string = '';
  /**
   * çŠ¶æ€ç®¡ç†ï¼šæ˜¯å¦å¼€å¯æŒ‰æ—¥æœŸç­›é€‰æ¨¡å¼
   */
  @State isFilterByDay: boolean = false;
  // --- ã€æ–°å¢ï¼šå¤šå® ç‰©ç®¡ç†ç›¸å…³çŠ¶æ€ã€‘ ---
  @State allPets: Pet[] = []; // å­˜å‚¨æ‰€æœ‰å® ç‰©æ¡£æ¡ˆ
  @State currentPetId: number = -1; // å½“å‰è®°å½•é€‰ä¸­çš„å® ç‰©ID
  @State currentPetName: string = 'é€‰æ‹©å® ç‰©'; // å½“å‰æ˜¾ç¤ºçš„å® ç‰©å
  // --- ã€æ–°å¢ï¼šå…¨å±€ä¿¡å·é›·è¾¾ã€‘ ---
  @StorageLink('petDataChangeSignal') @Watch('onDataUpdate') dataSignal: number = 0;
  /**
   * å¼¹çª—æ§åˆ¶å™¨ï¼šå…³è”é«˜çº§æ—¥ç¨‹æé†’è®¾ç½®å¼¹çª—
   */
  advancedReminderDialog: CustomDialogController = new CustomDialogController({
    builder: AdvancedReminderDialog({
      confirm: (content: string, date: Date, time: Date) => {
        this.publishCalendarReminder(content, date, time);
      }
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center
  });

  /**
   * ã€æ–°å¢é€»è¾‘ã€‘ï¼šå“åº”æ¡£æ¡ˆé¡µçš„æ•°æ®å˜æ›´
   * å½“æ”¶åˆ°ä¿¡å·å¼¹æ—¶ï¼Œä¸»åŠ¨ä¸‹äº•æŠ“å–æœ€æ–°çš„å® ç‰©åˆ—è¡¨
   */
  onDataUpdate(): void {
    console.info('PetDiary: è®°å½•é¡µæ„Ÿåº”åˆ°æ•°æ®å˜åŒ–ï¼Œå¼€å§‹åŒæ­¥...');
    const db = DatabaseManager.getInstance();

    // å¼‚æ­¥æ‹‰å–æœ€æ–°å® ç‰©ï¼Œå¹¶è§¦å‘é¡µé¢åˆ—è¡¨åˆ·æ–°
    db.getAllPets().then((latestPets: Pet[]) => {
      this.allPets = latestPets;
      this.refreshLogs(); // åˆ·æ–°ä¸‹æ–¹çš„å†å²è¯æ¡
    });
  }

  /**
   * ç”Ÿå‘½å‘¨æœŸé’©å­ï¼šç»„ä»¶å³å°†å‡ºç°æ—¶æ‰§è¡Œåˆå§‹åŒ–åŠ è½½
   */
  async aboutToAppear() {
    this.selectedDate = this.getTodayDate();

    // ã€ä¿®æ”¹é€»è¾‘ï¼šåˆå§‹åŒ–æ—¶åŠ è½½å® ç‰©åˆ—è¡¨ã€‘
    const db = DatabaseManager.getInstance();
    this.allPets = await db.getAllPets();

    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå® ç‰©
    if (this.allPets.length > 0) {
      this.currentPetId = this.allPets[0].id;
      this.currentPetName = this.allPets[0].name;
    }

    await this.refreshLogs();
  }

  /**
   * æ ¸å¿ƒé€»è¾‘ï¼šä»æœ¬åœ°æ•°æ®åº“åˆ·æ–°è®°å½•åˆ—è¡¨
   * ä¿®æ”¹ï¼šå¢åŠ æŒ‰å½“å‰é€‰ä¸­å® ç‰©è¿‡æ»¤çš„é€»è¾‘
   */
  async refreshLogs() {
    try {
      let rawData: PetRecord[] = [];
      if (this.isFilterByDay) {
        rawData = await DatabaseManager.getInstance().getRecordsByDate(this.selectedDate);
      } else {
        rawData = await DatabaseManager.getInstance().getAllRecords();
      }

      // ã€å…³é”®é€»è¾‘å‡çº§ã€‘ï¼šåªç­›é€‰å‡ºå±äºå½“å‰é€‰å®šå® ç‰©çš„è®°å½•
      if (this.currentPetId !== -1) {
        this.dayRecords = rawData.filter(item => item.petId === this.currentPetId);
      } else {
        this.dayRecords = rawData;
      }

      console.info(`PetDiary: å·²åŠ è½½å® ç‰©[${this.currentPetName}]çš„è®°å½•å…± ${this.dayRecords.length} æ¡`);
    } catch (exception) {
      console.error("CalendarPage: Refresh Database Error -> " + JSON.stringify(exception));
    }
  }

  /**
   * UIæ„å»ºæ¨¡å—ï¼šæ—¥å†é€‰æ‹©å™¨éƒ¨åˆ†
   */
  @Builder
  CalendarSection() {
    CalendarPicker({ selected: new Date() })
      .edgeAlign(CalendarAlign.CENTER)
      .margin({
        top: 15,
        bottom: 10,
        left: 15,
        right: 15
      })
      .padding(10)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .onChange((value: Date) => {
        const y = value.getFullYear();
        const m = (value.getMonth() + 1).toString().padStart(2, '0');
        const d = value.getDate().toString().padStart(2, '0');

        this.selectedDate = `${y}-${m}-${d}`;
        this.isFilterByDay = true;
        this.refreshLogs();
      })
  }

  /**
   * UIæ„å»ºæ¨¡å—ï¼šå†å²è¶³è¿¹æ ‡é¢˜ä¸ç­›é€‰æ§åˆ¶åŒº
   */
  @Builder
  ListHeaderSection() {
    Row() {
      Text(this.isFilterByDay ? `è¶³è¿¹ (${this.selectedDate})` : 'å†å²è¶³è¿¹')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')

      if (this.isFilterByDay) {
        Text('æŸ¥çœ‹å…¨éƒ¨')
          .fontSize(14)
          .fontColor('#007DFF')
          .margin({ left: 10 })
          .onClick(() => {
            this.isFilterByDay = false;
            this.refreshLogs();
          })
      }

      Blank()

      Select(this.getFilterOptions())
        .selected(0)
        .value(this.filterType)
        .font({ size: 14 })
        .onSelect((index: number, value: string) => {
          this.filterType = value;
        })
    }
    .width('90%')
    .margin({ top: 5, bottom: 10 })
  }

  /**
   * ä¸»é¡µé¢æ¸²æŸ“æ„å»ºå‡½æ•°
   */
  build() {
    Column() {
      // 1. é¡¶éƒ¨æ—¥å†
      this.CalendarSection()

      // --- ã€æ–°å¢ï¼šå® ç‰©åˆ‡æ¢é€‰æ‹©å™¨ã€‘ ---
      Row({ space: 10 }) {
        Text('æ­£åœ¨è®°å½•:').fontSize(14).fontColor('#888')
        if (this.allPets.length > 0) {
          Select(this.allPets.map(p => ({ value: p.name } as SelectOption)))
            .value(this.currentPetName)
            .selected(this.allPets.findIndex(p => p.id === this.currentPetId))
            .font({ size: 14, weight: FontWeight.Medium })
            .onSelect((idx, val) => {
              this.currentPetId = this.allPets[idx].id;
              this.currentPetName = val;
              this.refreshLogs();
            })
        } else {
          Text('æš‚æ— å® ç‰©')
            .fontSize(14)
            .fontColor(Color.Red)
            .onClick(() => {
              promptAction.showToast({ message: 'è¯·å…ˆå»å® ç‰©æ¡£æ¡ˆé¡µæ·»åŠ å® ç‰©' })
            })
        }
      }
      .width('90%')
      .justifyContent(FlexAlign.End)
      .margin({ bottom: 5 })

      // 2. å¿«æ·è®°å½•é¢æ¿
      Column() {
        Text(`å‡†å¤‡åœ¨ [${this.selectedDate}] è®°ä¸€ç¬”...`)
          .fontSize(14)
          .fontColor('#666666')
          .width('100%')
          .margin({ bottom: 12 })

        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
          ForEach(PET_ACTIONS, (item: PetActionItem) => {
            Column() {
              Text(item.icon).fontSize(24)
              Text(item.label).fontSize(12).margin({ top: 4 })
            }
            .width('21%')
            .margin({ bottom: 10 })
            .padding(8)
            .borderRadius(12)
            .backgroundColor(this.activeType === item.label ? item.color : '#F7F7F7')
            .shadow({
              radius: this.activeType === item.label ? 10 : 0,
              color: this.activeType === item.label ? item.color + '44' : '#00000000'
            })
            .onClick(() => {
              this.activeType = item.label;
            })
          })
        }

        TextInput({ placeholder: `ç»™ [${this.activeType}] å¢åŠ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰...`, text: this.userRemark })
          .onChange((value: string) => {
            this.userRemark = value;
          })
          .width('100%')
          .height(42)
          .backgroundColor('#F1F3F5')
          .borderRadius(8)
          .margin({ top: 8, bottom: 12 })

        Row({ space: 12 }) {
          Button(`ä¿å­˜åˆ°è¶³è¿¹`)
            .layoutWeight(1)
            .backgroundColor('#4CAF50')
            .height(45)
            .onClick(() => {
              this.handleSaveRecord();
            })

          Button('è®¾ä¸ºæé†’')
            .layoutWeight(1)
            .backgroundColor(Color.Orange)
            .height(45)
            .onClick(() => {
              this.advancedReminderDialog.open();
            })
        }
        .width('100%')
      }
      .padding(15)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .margin({ left: 15, right: 15, bottom: 15 })

      // 3. å†å²è¶³è¿¹æ ‡é¢˜
      this.ListHeaderSection()

      // 4. æ•°æ®å±•ç¤ºåˆ—è¡¨
      List({ space: 12 }) {
        ForEach(this.dayRecords, (item: PetRecord) => {
          if (this.filterType === 'å…¨éƒ¨' || item.type === this.filterType) {
            ListItem() {
              Row() {
                Circle({ width: 12, height: 12 })
                  .fill(this.getIconColor(item.type))

                Column() {
                  Text(item.type).fontSize(16).fontWeight(FontWeight.Bold)
                  Text(item.content).fontSize(13).fontColor('#666666').margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
                .margin({ left: 12 })
                .layoutWeight(1)

                Text(item.date)
                  .fontSize(12)
                  .fontColor('#999999')
                  .padding({
                    left: 8,
                    right: 8,
                    top: 4,
                    bottom: 4
                  })
                  .backgroundColor('#F1F3F5')
                  .borderRadius(6)
              }
              .width('95%')
              .padding(15)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .gesture(
                LongPressGesture({ repeat: false })
                  .onAction(() => {
                    this.confirmDelete(item.id, item.type);
                  })
              )
            }
          }
        }, (item: PetRecord) => item.id.toString())
      }
      .width('100%')
      .layoutWeight(1)
      .alignListItem(ListItemAlign.Center)
      .padding({ bottom: 20 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
    .onAppear(async () => {
      console.info('PetDiary: è®°å½•é¡µæ¿€æ´»ï¼Œæ­£åœ¨æ‰§è¡Œå…¨é‡åŒæ­¥...');
      const db = DatabaseManager.getInstance();

      // 1. æ— è®ºå¦‚ä½•ï¼Œå…ˆæ‹¿æœ€æ–°çš„å® ç‰©åå•
      const latestList = await db.getAllPets();
      this.allPets = latestList;

      // 2. æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœå½“å‰é€‰ä¸­çš„å® ç‰©ä¸åœ¨æ–°åˆ—è¡¨é‡Œï¼Œæˆ–è€…è¿˜æ²¡é€‰è¿‡ï¼Œæ‰å¼ºåˆ¶é€‰ç¬¬ä¸€ä¸ª
      if (this.allPets.length > 0) {
        const isCurrentValid = this.allPets.find(p => p.id === this.currentPetId);
        if (!isCurrentValid || this.currentPetId === -1) {
          this.currentPetId = this.allPets[0].id;
          this.currentPetName = this.allPets[0].name;
        }
      }

      // 3. ã€æœ€é‡è¦ã€‘ï¼šæ— è®ºåˆ—è¡¨å˜æ²¡å˜ï¼Œéƒ½é‡æ–°åˆ·ä¸€éè¶³è¿¹ï¼Œç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„
      await this.refreshLogs();
      console.info('PetDiary: è®°å½•é¡µæ•°æ®åŒæ­¥å®Œæˆ');
    })
  }

  /**
   * è¾…åŠ©æ–¹æ³•ï¼šç”Ÿæˆæ ‡å‡†æ ¼å¼çš„ä»Šæ—¥æ—¥æœŸ
   * å¢åŠ è¡¥é›¶é€»è¾‘ä»¥ç¡®ä¿æ•°æ®åº“æ’åºæ­£å¸¸
   */
  private getTodayDate(): string {
    const date = new Date();
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  /**
   * é€»è¾‘æ–¹æ³•ï¼šåŠ¨æ€ç”Ÿæˆä¸‹æ‹‰ç­›é€‰èœå•çš„é€‰é¡¹åˆ—è¡¨
   */
  private getFilterOptions(): SelectOption[] {
    let options: SelectOption[] = [{ value: 'å…¨éƒ¨' }];
    for (let i = 0; i < PET_ACTIONS.length; i++) {
      options.push({ value: PET_ACTIONS[i].label });
    }
    return options;
  }

  /**
   * è¾…åŠ©æ–¹æ³•ï¼šæ ¹æ®è¡Œä¸ºç±»å‹è·å–å¯¹åº”çš„ä¸»é¢˜é¢œè‰²
   */
  private getIconColor(type: string): string {
    for (let i = 0; i < PET_ACTIONS.length; i++) {
      if (PET_ACTIONS[i].label === type) {
        return PET_ACTIONS[i].color;
      }
    }
    return '#CCCCCC';
  }

  /**
   * ä¸šåŠ¡é€»è¾‘ï¼šå¤„ç†ä¿å­˜æ“ä½œ
   */
  private async handleSaveRecord() {
    // æ ¡éªŒï¼šå¿…é¡»å…ˆé€‰ä¸­å® ç‰©
    if (this.currentPetId === -1) {
      promptAction.showToast({ message: 'è¯·å…ˆåœ¨æ¡£æ¡ˆé¡µæ·»åŠ å® ç‰©' });
      return;
    }

    try {
      let finalContent: string = this.userRemark.trim();
      if (finalContent === '') {
        finalContent = `${this.activeType}å®Œæˆ`;
      }

      // ã€é€»è¾‘å‡çº§ã€‘ï¼šä½¿ç”¨ this.currentPetId å­˜å‚¨ï¼Œå®ç°å¤šå® ç‹¬ç«‹è®°å½•
      await DatabaseManager.getInstance()
        .insertRecord(this.currentPetId, this.activeType, finalContent, this.selectedDate);

      this.userRemark = '';
      promptAction.showToast({ message: `å·²ä¸º ${this.currentPetName} è®°å½•æˆåŠŸï¼` });

      await this.refreshLogs();
    } catch (err) {
      console.error("Save Record Logic Error");
    }
  }

  /**
   * é€»è¾‘æ–¹æ³•ï¼šåˆ é™¤è¡Œä¸ºè®°å½•çš„äºŒæ¬¡ç¡®è®¤å¼¹çª—
   */
  private confirmDelete(id: number, type: string) {
    AlertDialog.show({
      title: 'åˆ é™¤è®°å½•',
      message: `ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡ [${type}] çš„è¶³è¿¹å—ï¼Ÿ`,
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
        }
      },
      secondaryButton: {
        value: 'ç¡®è®¤åˆ é™¤',
        fontColor: Color.Red,
        action: async () => {
          try {
            await DatabaseManager.getInstance().deleteRecord(id);
            await this.refreshLogs();
            promptAction.showToast({ message: 'å·²åˆ é™¤' });
          } catch (e) {
            console.error("Delete Record Failed");
          }
        }
      }
    })
  }

  /**
   * æ ¸å¿ƒé€»è¾‘ï¼šå‘å¸ƒç³»ç»Ÿçº§ä»£ç†æé†’ (æ—¥å†æ¨¡å¼)
   */
  private publishCalendarReminder(content: string, date: Date, time: Date) {
    // é€»è¾‘å‡çº§ï¼šæé†’å†…å®¹è‡ªåŠ¨åŠ ä¸Šå® ç‰©åå­—ï¼Œè®©æé†’æ›´ç²¾å‡†
    let finalContent = content.trim();
    if (finalContent === '') {
      finalContent = `æé†’ï¼šè¯¥ç»™ ${this.currentPetName} å¤„ç† [${this.activeType}] å•¦ï¼`;
    } else {
      finalContent = `ã€${this.currentPetName}ã€‘${finalContent}`;
    }

    let calendarReminder: reminderAgentManager.ReminderRequestCalendar = {
      reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_CALENDAR,
      dateTime: {
        year: date.getFullYear(),
        month: date.getMonth() + 1,
        day: date.getDate(),
        hour: time.getHours(),
        minute: time.getMinutes(),
        second: 0
      },
      repeatMonths: [],
      repeatDays: [],
      title: `ğŸ¾ ${this.currentPetName} çš„æ—¥ç¨‹æé†’`,
      content: finalContent,
      slotType: notificationManager.SlotType.SOCIAL_COMMUNICATION,
      ringDuration: 60,
      wantAgent: {
        pkgName: "com.group.petrecord",
        abilityName: "EntryAbility"
      }
    }

    try {
      reminderAgentManager.publishReminder(calendarReminder, (err, reminderId) => {
        if (!err) {
          AlertDialog.show({
            title: 'æé†’è®¾å®šæˆåŠŸ',
            message: `æé†’æ—¶é—´ï¼š${date.getFullYear()}-${date.getMonth() +
              1}-${date.getDate()} ${time.getHours()}:${time.getMinutes()} \nå¯¹è±¡ï¼š${this.currentPetName}`,
            confirm: {
              value: 'çŸ¥é“äº†', action: () => {
              }
            }
          });
        }
      });
    } catch (e) {
      console.error('PetDiary: ç³»ç»Ÿç»„ä»¶è°ƒç”¨å¼‚å¸¸');
    }
  }
}