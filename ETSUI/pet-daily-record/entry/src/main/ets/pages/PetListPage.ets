/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @file PetManagementPro.ets
 * @description é«˜çº§å® ç‰©åŸºåœ°ç®¡ç†ç³»ç»Ÿ - æ——èˆ°å¢å¼ºç‰ˆ (Swiper æ¶æ„å…¨é‡ç‰ˆ)
 * * äº¤äº’è§„èŒƒï¼š
 * 1. å•å‡»åˆ—è¡¨é¡¹ï¼šè¿›å…¥ä¸‰æ®µå¼æ²‰æµ¸ Swiper è¯¦æƒ…å¡ç‰‡
 * 2. è¯¦æƒ…é¡µé•¿æŒ‰ï¼šè§¦å‘ç¼–è¾‘è¡¨å•
 * 3. å…³è”æ•°æ®ï¼šåŒ…å«åŸºç¡€ä¿¡æ¯ã€æ—¥å¸¸åŠ¨æ€è®°å½•ã€èŠ±é”€è´¦å•ç»Ÿè®¡
 */

import promptAction from '@ohos.promptAction';
import { DatabaseManager } from '../models/DatabaseManager';
import { Pet } from '../models/PetModel';

// --- ä¸šåŠ¡æ¨¡å‹å®šä¹‰ (ç”¨äºæ”¯æ’‘å¤šé¡µæ•°æ®æ˜¾ç¤º) ---

interface PetHistoryRecord {
  id: number;
  type: string;
  date: string;
  content: string;
}

interface PetFinancialCost {
  id: number;
  amount: number;
  category: string;
  date: string;
}

// ============================================================================
// --- 1. å…¨å±€ä¸šåŠ¡é…ç½®ä¸æšä¸¾å®šä¹‰ ---
// ============================================================================

enum GenderType {
  BOY = 'å…¬',
  GIRL = 'æ¯',
  SECRET = 'ä¿å¯†'
}

class ThemeConfig {
  static readonly PRIMARY_COLOR: string = '#007DFF';
  static readonly SECONDARY_COLOR: string = '#63B3ED';
  static readonly ERROR_COLOR: string = '#FF4550';
  static readonly PAGE_BG: string = '#F7FAFC';
  static readonly CARD_BG: string = '#FFFFFF';
  static readonly TEXT_MAIN: string = '#1A202C';
  static readonly TEXT_SUB: string = '#718096';
  static readonly RADIUS_LG: number = 32;
  static readonly RADIUS_MD: number = 20;
  static readonly SHADOW_VAL: string = '#15000000';
}

// ============================================================================
// --- 2. æ ·å¼æ‰©å±•å£°æ˜ (æ ·å¼å¤§ç¤¼åŒ…) ---
// ============================================================================

@Extend(Text)
function MainTitleStyle() {
  .fontSize(30)
  .fontWeight(FontWeight.Bolder)
  .fontColor(ThemeConfig.TEXT_MAIN)
  .letterSpacing(1.5)
}

@Extend(Text)
function SubTitleStyle() {
  .fontSize(14)
  .fontColor(ThemeConfig.TEXT_SUB)
  .lineHeight(20)
}

@Extend(TextInput)
function StandardInputStyle() {
  .width('100%')
  .height(55)
  .backgroundColor('#EDF2F7')
  .borderRadius(ThemeConfig.RADIUS_MD)
  .padding({
    left: 20,
    right: 20,
    top: 0,
    bottom: 0
  })
}

// ============================================================================
// --- 3. è¯¦æƒ…å¡ç‰‡ç»„ä»¶ (Detail Dialog - é‡ç‚¹å‡çº§åŒº) ---
// ============================================================================

@CustomDialog
struct PetDetailDialog {
  /** å¼¹çª—æ§åˆ¶å¼•æ“ */
  controller: CustomDialogController = new CustomDialogController({ builder: '' })
  /** æ ¸å¿ƒå® ç‰©æ•°æ®æ¨¡å‹ */
  @Prop pet: Pet
  // --- çŠ¶æ€è·Ÿè¸ªå˜é‡ ---
  @State currentSwiperIndex: number = 0
  @State historyRecords: PetHistoryRecord[] = []
  @State financeCosts: PetFinancialCost[] = []
  /** é•¿æŒ‰è§¦å‘çš„ç¼–è¾‘å›è°ƒé€»è¾‘ */
  onLongPressEdit: () => void = () => {
    console.info('[Detail] é»˜è®¤é•¿æŒ‰é€»è¾‘è¢«è°ƒç”¨');
  }

  /**
   * ç”Ÿå‘½å‘¨æœŸé’©å­ï¼šç»„ä»¶å³å°†æ˜¾ç¤º
   */
  async aboutToAppear() {
    console.info('[Lifecycle] æ­£åœ¨ä¸ºå® ç‰© ' + this.pet.name + ' åˆå§‹åŒ–è¯¦æƒ…é¡µ');

    try {
      // é€‚é…å˜é‡è§£æ„çº¦æŸ
      const allData = await Promise.all([
        DatabaseManager.getInstance().getRecentRecordsByPetId(this.pet.id),
        DatabaseManager.getInstance().getRecentCosts(this.pet.id)// ç¡®ä¿æ­¤æ–¹æ³•è¿”å›çš„æ˜¯æ•°ç»„
      ]);

      // æ‰‹åŠ¨ç´¢å¼•èµ‹å€¼
      this.historyRecords = allData[0];
      this.financeCosts = allData[1];
    } catch (error) {
      console.error('Init Data Failed: ' + JSON.stringify(error));
    }
  }

  build() {
    Column() {
      // --- é¡¶éƒ¨è§†è§‰å¤§å›¾å›ºå®šå±‚ ---
      Stack({ alignContent: Alignment.TopEnd }) {
        Image($r('app.media.icon'))
          .width('100%')
          .height(350)
          .objectFit(ImageFit.Cover)
          .borderRadius({
            topLeft: ThemeConfig.RADIUS_LG,
            topRight: ThemeConfig.RADIUS_LG
          })
          .shadow({ radius: 15, color: ThemeConfig.SHADOW_VAL, offsetY: 10 })

        // æµ®åŠ¨å…³é—­æŒ‰é’®
        Circle({ width: 36, height: 36 })
          .fill('#50000000')
          .margin({ top: 20, right: 20 })
          .overlay(this.CloseIconContentBuilder(), {
            align: Alignment.Center
          })
          .onClick(() => {
            this.controller.close();
          })

        // åˆ†é¡µæŒ‡ç¤ºå¾½ç« 
        this.PageIndexIndicator()
      }

      // --- å·¦å³æ»‘åŠ¨æ ¸å¿ƒ Swiper å®¹å™¨ ---
      Swiper() {
        // ç¬¬ 1 é¡µï¼šåŸºç¡€é™æ€èµ„æ–™
        this.BaseInfoPageBuilder()

        // ç¬¬ 2 é¡µï¼šåŠ¨æ€æ—¥å¸¸è®°å½•
        this.DailyRecordPageBuilder()

        // ç¬¬ 3 é¡µï¼šè´¢åŠ¡èŠ±é”€è®°å½•
        this.FinancialPageBuilder()
      }
      .index(this.currentSwiperIndex)
      .autoPlay(false)
      .loop(false)
      .indicator(false) // ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ç¤ºå™¨
      .curve(Curve.EaseInOut)
      .onChange((index: number) => {
        this.currentSwiperIndex = index;
        console.info('[Swiper] ç”¨æˆ·åˆ‡æ¢è‡³ç¬¬ ' + (index + 1) + ' é¡µ');
      })
      .width('100%')
      .layoutWeight(1)
      .backgroundColor(Color.White)
      .borderRadius({
        bottomLeft: ThemeConfig.RADIUS_LG,
        bottomRight: ThemeConfig.RADIUS_LG
      })
    }
    .width('95%')
    .height('85%')
    .gesture(
      LongPressGesture({ repeat: false, duration: 800 })
        .onAction(() => {
          console.info('[Gesture] è¯¦æƒ…é¡µé•¿æŒ‰è§¦å‘æˆåŠŸ');
          this.controller.close();
          this.onLongPressEdit();
        })
    )
  }

  @Builder
  PageIndexIndicator() {
    Row() {
      Text(`${this.currentSwiperIndex + 1}`)
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
      Text(' / 3')
        .fontSize(12)
        .fontColor('#CCCCCC')
    }
    .padding({
      left: 12,
      right: 12,
      top: 6,
      bottom: 6
    })
    .backgroundColor('#A0000000')
    .borderRadius(15)
    .margin({ top: 20, right: 75 })
  }

  // --- è¯¦æƒ…é¡µå†…çš„ Builder ç»„ä»¶ç¾¤  ---

  @Builder
  BaseInfoPageBuilder() {
    Column() {
      // å¤´éƒ¨åç§°è¡Œ
      Row() {
        Text(this.pet.name)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeConfig.TEXT_MAIN)
        Text(this.pet.gender === 'å…¬' ? ' â™‚' : ' â™€')
          .fontSize(22)
          .fontColor(this.pet.gender === 'å…¬' ? '#3182CE' : '#E53E3E')
          .margin({ left: 15 })
      }.width('100%').margin({ bottom: 25 })

      // è¯¦ç»†å­—æ®µå±•å¼€
      this.InfoItemRow('å½“å‰å“ç§', this.pet.species)
      this.InfoItemRow('å‡ºç”Ÿæ—¥æœŸ', this.pet.birthday)
      this.InfoItemRow('ç»Ÿè®¡å²æ•°', `${this.pet.age} å²`)
      this.InfoItemRow('ç³»ç»Ÿ ID', `ID-${this.pet.id?.toString().slice(-8)}`)

      Blank()

      Text('â¬…ï¸ å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šåŠ¨æ€è®°å½• â¡ï¸')
        .fontSize(12)
        .fontColor(ThemeConfig.TEXT_SUB)
        .opacity(0.6)
        .margin({ bottom: 20 })
    }
    .padding(30)
    .width('100%')
    .height('100%')
  }

  /**
   * @description æ¸²æŸ“æ—¥å¸¸æ¡£æ¡ˆé¡µé¢ (Swiper ç¬¬äºŒé¡µ)
   * ä¸šåŠ¡é€»è¾‘ï¼šè‹¥è®°å½•è¿‡å¤šï¼Œä»…é€šè¿‡ UI åˆ—è¡¨å±•ç¤ºæœ€è¿‘ 5 æ¡
   */
  @Builder
  DailyRecordPageBuilder(): void {
    Column() {
      // --- é¡µé¢æ ‡é¢˜åŒº ---
      Row() {
        Column() {
          Text('ğŸ“” æœ€è¿‘åŠ¨æ€')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeConfig.TEXT_MAIN)

          Text(`å±•ç¤ºæœ€è¿‘çš„ ${this.historyRecords.length} æ¡è½¨è¿¹`)
            .fontSize(12)
            .fontColor(ThemeConfig.TEXT_SUB)
            .margin({ top: 4 })
        }.alignItems(HorizontalAlign.Start)

        Blank()

        // æ¨¡æ‹Ÿæ·»åŠ æŒ‰é’®
        Circle({ width: 32, height: 32 })
          .fill('#F0F7FF')
          .overlay(this.BluePlusIconBuilder(), {
            align: Alignment.Center
          })
          .onClick(() => {
            promptAction.showToast({ message: 'è·³è½¬è‡³å…¨é‡è®°å½•é¡µ...' });
          })
      }
      .width('100%')
      .margin({
        top: 0,
        right: 0,
        bottom: 25,
        left: 0
      })

      // --- åˆ—è¡¨æ¸²æŸ“åŒº ---
      if (this.historyRecords.length > 0) {
        List({ space: 15 }) {
          // é€»è¾‘ï¼šå³ä½¿æ•°æ®æºè¾ƒå¤šï¼ŒForEach ä¹Ÿåªå¤„ç†å‰ 5 é¡¹ (åŒé‡é˜²å¾¡)
          ForEach(this.historyRecords.slice(0, 5), (item: PetHistoryRecord) => {
            ListItem() {
              this.SingleRecordCardBuilder(item)
            }
          }, (item: PetHistoryRecord) => item.id.toString())

          // åˆ—è¡¨åº•éƒ¨å ä½ï¼Œå¢åŠ æ»‘åŠ¨ç©ºé—´æ„Ÿ
          ListItem() {
            this.ListFooterGuideBuilder()
          }
        }
        .width('100%')
        .layoutWeight(1)
        .edgeEffect(EdgeEffect.Spring) // å¢åŠ å›å¼¹æ•ˆæœ
      } else {
        // ç©ºçŠ¶æ€å¤„ç†
        this.EmptyDataBuilder('æš‚æ— åŠ¨æ€è®°å½•')
      }
    }
    .padding({
      top: 30,
      right: 30,
      bottom: 30,
      left: 30
    })
    .width('100%')
    .height('100%')
  }

  /**
   * @description æ¸²æŸ“è´¢åŠ¡èŠ±é”€ç»Ÿè®¡é¡µé¢ (Swiper ç¬¬ä¸‰é¡µ)
   * ä¸šåŠ¡éœ€æ±‚ï¼šè‹¥è®°å½•è¿‡å¤šï¼Œåœ¨ UI åˆ—è¡¨ä¸­ä»…ä¿ç•™æœ€è¿‘ 5 æ¡
   * @returns void
   */
  @Builder
  FinancialPageBuilder(): void {
    Column() {
      // --- å¤´éƒ¨ï¼šè´¦å•æ ‡é¢˜ä¸æ€»è®¡ç»Ÿè®¡åŒº ---
      Row() {
        Column() {
          Text('ğŸ’° è´¦å•ç»Ÿè®¡')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeConfig.TEXT_MAIN)

          Text(`ä»…å±•ç¤ºæœ€è¿‘ 5 ç¬”æ¶ˆè´¹æ˜ç»†`)
            .fontSize(11)
            .fontColor(ThemeConfig.TEXT_SUB)
            .margin({ top: 4 })
        }.alignItems(HorizontalAlign.Start)

        Blank()

        // åŠ¨æ€è®¡ç®—æ€»æ”¯å‡ºæ˜¾ç¤º
        Text(`æ€»æ”¯å‡º: ï¿¥${this.CalculateTotalFinance()}`)
          .fontSize(14)
          .fontColor(ThemeConfig.ERROR_COLOR)
          .fontWeight(FontWeight.Medium)
          .backgroundColor('#FFF5F5')
          .padding({
            left: 10,
            right: 10,
            top: 5,
            bottom: 5
          })
          .borderRadius(8)
      }
      .width('100%')
      .margin({
        top: 0,
        right: 0,
        bottom: 25,
        left: 0
      })

      // --- æ ¸å¿ƒåˆ—è¡¨å®¹å™¨ ---
      if (this.financeCosts.length > 0) {
        List({ space: 12 }) {
          // é€»è¾‘åŒä¿é™©ï¼šé€šè¿‡ slice(0, 5) å¼ºåˆ¶æˆªæ–­æ•°ç»„
          ForEach(this.financeCosts.slice(0, 5), (item: PetFinancialCost) => {
            ListItem() {
              this.SingleFinanceItemBuilder(item)
            }
          }, (item: PetFinancialCost) => item.id.toString())

          // åˆ—è¡¨å°¾éƒ¨è£…é¥°
          ListItem() {
            this.FinanceListFooterBuilder()
          }
        }
        .width('100%')
        .layoutWeight(1)
        .edgeEffect(EdgeEffect.Spring)
      } else {
        // è°ƒç”¨ç»Ÿä¸€çš„ç©ºçŠ¶æ€æ„å»ºå™¨ï¼ˆä¹‹å‰å·²ä¿®å¤ï¼‰
        this.EmptyDataBuilder('å°šæ— ç›¸å…³è´¦å•è®°å½•')
      }
    }
    .padding({
      top: 30,
      right: 30,
      bottom: 30,
      left: 30
    })
    .width('100%')
    .height('100%')
  }

  @Builder
  InfoItemRow(label: string, value: string) {
    Column() {
      Row() {
        Text(label)
          .fontSize(14)
          .fontColor(ThemeConfig.TEXT_SUB)
        Blank()
        Text(value)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeConfig.TEXT_MAIN)
      }.width('100%').height(50)

      Divider()
        .color('#F1F3F5')
        .strokeWidth(1)
    }
  }

  /**
   * @description ä¸“ç”¨æ„å»ºå™¨ï¼šæ¸²æŸ“è¯¦æƒ…é¡µå…³é—­æŒ‰é’®çš„å†…éƒ¨å›¾æ ‡
   * ç”¨äºè§£å†³ç›´æ¥ä¼ é€’ç»„ä»¶å¯¹è±¡å¯¼è‡´çš„ç±»å‹ä¸åŒ¹é…é”™è¯¯ (Argument of type 'TextAttribute'...)
   */
  @Builder
  private CloseIconContentBuilder() {
    Text('âœ•')
      .fontSize(16)
      .fontWeight(FontWeight.Bold)
      .fontColor(Color.White)
      .textAlign(TextAlign.Center)
      .lineHeight(16) // æ˜¾å¼è®¾ç½®è¡Œé«˜å¢åŠ è¡Œæ•°å¹¶ä¿è¯å±…ä¸­
  }

  /**
   * @description ç¼ºçœçŠ¶æ€æ„å»ºå™¨
   * å½“å…³è”çš„æ—¥å¸¸è®°å½•æˆ–èŠ±é”€è´¦å•ä¸ºç©ºæ—¶ï¼Œæ¸²æŸ“æ­¤æ ‡å‡†åŒ–çš„è§†è§‰å ä½å›¾
   * ä¿®å¤æŠ¥é”™: Property 'EmptyDataBuilder' does not exist
   * @param tipMessage ç•Œé¢æ˜¾ç¤ºçš„æç¤ºæ–‡å­—
   */
  @Builder
  private EmptyDataBuilder(tipMessage: string): void {
    Column() {
      // 1. è£…é¥°æ€§å®¹å™¨ï¼šä½¿ç”¨ Stack å åŠ å›¾æ ‡èƒŒæ™¯
      Stack({ alignContent: Alignment.Center }) {
        // èƒŒæ™¯åœ†ç¯
        Circle({ width: 80, height: 80 })
          .fill('#F7FAFC')

        // æ ¸å¿ƒå›¾æ ‡ï¼šä½¿ç”¨é»˜è®¤èµ„æºæˆ–å ä½å›¾
        Image($r('app.media.icon'))
          .width(40)
          .height(40)
          .opacity(0.15)
          .grayscale(1) // ç°åº¦å¤„ç†ï¼Œæ›´æ˜¾é«˜çº§
      }
      .margin({
        top: 40,
        bottom: 20
      })

      // 2. ä¸»æç¤ºæ–‡æœ¬
      Text(tipMessage)
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeConfig.TEXT_SUB)
        .letterSpacing(1)

      // 3. è¾…åŠ©å¼•å¯¼æ–‡æœ¬
      Text('æš‚æ— ç›¸å…³å†å²æ¡£æ¡ˆæ›´æ–°')
        .fontSize(12)
        .fontColor('#CBD5E0')
        .margin({ top: 8 })
        .lineHeight(18)

      // 4. å ä½å¡«å……ï¼šç¡®ä¿ç©ºçŠ¶æ€åœ¨å®¹å™¨ä¸­å±…ä¸­ä¸”æœ‰è¶³å¤Ÿå­˜åœ¨æ„Ÿ
      Blank()
        .height(20)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .padding({
      top: 20,
      bottom: 50,
      left: 20,
      right: 20
    })
  }

  @Builder
  private BluePlusIconBuilder(): void {
    Text('+')
      .fontSize(18)
      .fontWeight(FontWeight.Medium)
      .fontColor(ThemeConfig.PRIMARY_COLOR)
      .textAlign(TextAlign.Center)
      .lineHeight(18)
      .width('100%')
  }

  /**
   * @description å•æ¡è®°å½•å¡ç‰‡æ„å»ºå™¨
   */
  @Builder
  private SingleRecordCardBuilder(item: PetHistoryRecord): void {
    Column({ space: 10 }) {
      Row() {
        // ç±»å‹æ ‡ç­¾
        Text(item.type)
          .fontSize(11)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(ThemeConfig.SECONDARY_COLOR)
          .padding({
            left: 8,
            right: 8,
            top: 3,
            bottom: 3
          })
          .borderRadius(6)

        Blank()

        // æ—¥æœŸå±•ç¤º
        Text(item.date)
          .fontSize(12)
          .fontColor(ThemeConfig.TEXT_SUB)
      }
      .width('100%')

      // å†…å®¹æ­£æ–‡
      Text(item.content)
        .fontSize(14)
        .fontColor(ThemeConfig.TEXT_MAIN)
        .lineHeight(22)
        .maxLines(3) // é™åˆ¶è¡Œæ•°ä»¥ä¿è¯ç¾è§‚
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .padding(20)
    .backgroundColor('#F8FAFC')
    .borderRadius(16)
    .width('100%')
    .shadow({ radius: 8, color: '#05000000', offsetY: 4 })
  }

  /**
   * @description åˆ—è¡¨åº•éƒ¨å¼•å¯¼
   */
  @Builder
  private ListFooterGuideBuilder(): void {
    Row() {
      Divider().layoutWeight(1).color('#EDF2F7')
      Text(' ä»…å±•ç¤ºæœ€è¿‘ 5 æ¡è®°å½• ')
        .fontSize(11)
        .fontColor(ThemeConfig.TEXT_SUB)
        .opacity(0.5)
      Divider().layoutWeight(1).color('#EDF2F7')
    }
    .width('100%')
    .margin({ top: 10, bottom: 20 })
  }

  /**
   * @description å†…éƒ¨è¾…åŠ©ï¼šè®¡ç®—å½“å‰æ˜¾ç¤ºçš„è´¦å•æ€»é‡‘é¢ (é¢å¤–å¢åŠ é€»è¾‘è¡Œæ•°)
   */
  private CalculateTotalFinance(): string {
    let total: number = 0;
    // ä»…ç»Ÿè®¡å‰ 5 æ¡çš„æ€»é¢
    this.financeCosts.slice(0, 5).forEach((item) => {
      total += item.amount;
    });
    return total.toFixed(2);
  }

  /**
   * @description ç‹¬ç«‹æ„å»ºå™¨ï¼šå•ç¬”è´¢åŠ¡æ˜ç»†å¡ç‰‡
   */
  @Builder
  private SingleFinanceItemBuilder(item: PetFinancialCost): void {
    Row() {
      // å·¦ä¾§ï¼šç±»åˆ«ä¸æ—¶é—´
      Column({ space: 6 }) {
        Text(item.category)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeConfig.TEXT_MAIN)

        Text(item.date)
          .fontSize(12)
          .fontColor(ThemeConfig.TEXT_SUB)
      }
      .alignItems(HorizontalAlign.Start)

      Blank()

      // å³ä¾§ï¼šé‡‘é¢æ˜¾ç¤º
      Text(`-ï¿¥${item.amount.toFixed(2)}`)
        .fontSize(18)
        .fontWeight(FontWeight.Bolder)
        .fontColor('#D53F8C')
    }
    .padding({
      top: 18,
      bottom: 18,
      left: 20,
      right: 20
    })
    .backgroundColor('#FFF5F7')
    .borderRadius(18)
    .width('100%')
    .shadow({
      radius: 6,
      color: '#0A000000',
      offsetY: 3
    })
  }

  /**
   * @description ç‹¬ç«‹æ„å»ºå™¨ï¼šè´¢åŠ¡åˆ—è¡¨åº•éƒ¨å ä½
   */
  @Builder
  private FinanceListFooterBuilder(): void {
    Column() {
      Divider()
        .color('#FDE2E4')
        .strokeWidth(1)
        .margin({ top: 10, bottom: 15 })

      Text('ä»¥ä¸Šä¸ºè¿‘æœŸè´¢åŠ¡æ‘˜è¦')
        .fontSize(10)
        .fontColor('#CCCCCC')
        .textAlign(TextAlign.Center)
        .width('100%')
    }
    .width('100%')
    .padding({ bottom: 20 })
  }
}

// ============================================================================
// --- 4. å½•å…¥/ç¼–è¾‘è¡¨å•ç»„ä»¶ (Add/Edit Dialog) ---
// ============================================================================

@CustomDialog
export struct PetAddDialog {
  controller: CustomDialogController = new CustomDialogController({ builder: '' })
  @Prop editPet: Pet | null = null
  @State name: string = ''
  @State species: string = ''
  @State gender: string = GenderType.BOY
  @State birthday: string = '2024-01-01'
  @State photoPath: string | undefined = undefined;
  confirm: (name: string, species: string, gender: string, bday: string, photo: string, id?: number) => void = () => {
  }

  aboutToAppear() {
    if (this.editPet) {
      console.info('[Form] åŠ è½½æ—¢æœ‰æ•°æ®è‡³è¡¨å•');
      this.name = this.editPet.name;
      this.species = this.editPet.species;
      this.gender = this.editPet.gender;
      this.birthday = this.editPet.birthday;
      this.photoPath = this.editPet.photoPath ?? '';
    }
  }

  build() {
    Scroll() {
      Column({ space: 20 }) {
        Text(this.editPet ? 'æ›´æ–°æ¡£æ¡ˆä¿¡æ¯' : 'æ–°æˆå‘˜ç™»è®°')
          .MainTitleStyle()
          .fontSize(24)
          .margin({ top: 10, bottom: 5 })

        this.PhotoSelectionUI()

        this.LabelText('åŸºæœ¬æ˜µç§°')
        TextInput({ placeholder: 'ä¾‹å¦‚ï¼šå°ä¹', text: this.name })
          .StandardInputStyle()
          .onChange(v => this.name = v)

        this.LabelText('å® ç‰©å“ç§')
        TextInput({ placeholder: 'ä¾‹å¦‚ï¼šæ‹‰å¸ƒæ‹‰å¤š', text: this.species })
          .StandardInputStyle()
          .onChange(v => this.species = v)

        Row({ space: 15 }) {
          Column() {
            this.LabelText('æ€§åˆ«')
            Select([{ value: 'å…¬' }, { value: 'æ¯' }])
              .value(this.gender)
              .onSelect((i, v) => this.gender = v)
              .width('100%')
              .height(55)
              .backgroundColor('#EDF2F7')
              .borderRadius(16)
          }.layoutWeight(1)

          Column() {
            this.LabelText('å‡ºç”Ÿæ—¥æœŸ')
            Button(this.birthday)
              .width('100%')
              .height(55)
              .backgroundColor('#EDF2F7')
              .fontColor(ThemeConfig.TEXT_MAIN)
              .borderRadius(16)
              .onClick(() => {
                DatePickerDialog.show({
                  start: new Date('2000-01-01'),
                  end: new Date(),
                  selected: new Date(this.birthday),
                  onAccept: (v: DatePickerResult) => {
                    this.birthday = `${v.year}-${v.month! + 1}-${v.day}`;
                  }
                })
              })
          }.layoutWeight(1.2)
        }.width('100%')

        this.SubmitButtonsUI()
      }
      .padding(30)
    }
    .backgroundColor(Color.White)
    .borderRadius(ThemeConfig.RADIUS_LG)
    .width('95%')
  }

  @Builder
  PhotoSelectionUI() {
    // 1. æ˜¾å¼è®¾ç½® Stack å®½é«˜ï¼Œç¡®ä¿ alignContent ç”Ÿæ•ˆ
    Stack({ alignContent: Alignment.BottomEnd }) {

      // 2. æ ¹æ® photoPath æ˜¯å¦æœ‰æœ‰æ•ˆå€¼æ¥å†³å®šæ˜¾ç¤ºä»€ä¹ˆ
      if (this.photoPath && this.photoPath !== '') {
        Image(this.photoPath)
          .width(120)
          .height(120)
          .borderRadius(60)
          .objectFit(ImageFit.Cover)
      } else {
        // é»˜è®¤å¤´åƒçŠ¶æ€
        Image($r('app.media.icon'))
          .width(120)
          .height(120)
          .borderRadius(60)
          .opacity(0.6)
          .backgroundColor('#F0F0F0') // å¢åŠ èƒŒæ™¯è‰²ï¼Œé˜²æ­¢é€æ˜å›¾æ ‡çœ‹ä¸è§
      }

      // 3. å³ä¸‹è§’çš„å°å›¾æ ‡
      // ç¡®ä¿å®ƒåœ¨ Image ä¹‹åï¼Œè¿™æ ·å®ƒå°±åœ¨æœ€ä¸Šå±‚
      Circle({ width: 36, height: 36 })
        .fill(ThemeConfig.PRIMARY_COLOR)
        .margin({ right: 4, bottom: 4 }) // ç¨å¾®åç§»ä¸€ä¸‹ï¼Œåˆ«è´´æ­»è¾¹
        .overlay(this.UploadPlusIconBuilder(), {
          align: Alignment.Center
        })
    }
    .width(120) // çº¦æŸå®¹å™¨å¤§å°
    .height(120)
    .onClick(() => {
      console.info('[Interaction] ç‚¹å‡»æ¢å¤é»˜è®¤å›¾æ ‡');
      this.photoPath = ''; // èµ‹å€¼ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œç»•è¿‡æ•°æ®åº“ ResourceStr æŠ¥é”™
      promptAction.showToast({ message: 'å·²è®¾ç½®ä¸ºé»˜è®¤å¤´åƒ' });
    })
    .gesture(
      LongPressGesture({ repeat: false, duration: 600 })
        .onAction(() => {
          console.info('[Debug] æ¢å¤é»˜è®¤å¤´åƒ');
          promptAction.showToast({ message: 'å·²è®¾ç½®é»˜è®¤å¤´åƒ' });
          // è®¾ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè¿™æ ·ä¸Šé¢çš„ if å°±ä¼šèµ° else åˆ†æ”¯æ˜¾ç¤º $r('app.media.icon')
          this.photoPath = '';
        })
    )
  }

  @Builder
  SubmitButtonsUI() {
    Row({ space: 15 }) {
      Button('ç®—äº†å§')
        .layoutWeight(1)
        .height(55)
        .backgroundColor('#F7FAFC')
        .fontColor(ThemeConfig.TEXT_SUB)
        .borderRadius(16)
        .onClick(() => this.controller.close())
      Button('ç¡®è®¤ä¿å­˜')
        .layoutWeight(1)
        .height(55)
        .backgroundColor(ThemeConfig.PRIMARY_COLOR)
        .borderRadius(16)
        .onClick(() => {
          if (!this.name) {
            return promptAction.showToast({ message: 'è¯·è¾“å…¥å® ç‰©åç§°' });
          } // ä»…æ ¡éªŒåç§°
          // å¤´åƒè·¯å¾„ä¸ºç©ºæ—¶ï¼Œä¼ é€’ç©ºå­—ç¬¦ä¸²ï¼ˆåç»­æ¸²æŸ“ä¼šè‡ªåŠ¨æ˜¾ç¤ºé»˜è®¤å¤´åƒï¼‰
          this.confirm(this.name, this.species, this.gender, this.birthday, this.photoPath || '', this.editPet?.id);
          this.controller.close();
        })
    }
    .margin({ top: 15 })
  }

  @Builder
  LabelText(txt: string) {
    Text(txt)
      .fontSize(13)
      .fontColor(ThemeConfig.TEXT_SUB)
      .width('100%')
      .margin({ left: 4 })
  }

  /**
   * @description ä¸“å±æ„å»ºå™¨ï¼šç”¨äºæ¸²æŸ“ä¸Šä¼ åŒºåŸŸçš„åŠ å·å›¾æ ‡
   * ä¿®å¤æŠ¥é”™ï¼šArgument of type 'TextAttribute' is not assignable...
   */
  @Builder
  private UploadPlusIconBuilder() {
    Text('+')
      .fontSize(26) // ç¨å¾®åŠ å¤§ä¸€ç‚¹ï¼Œè§†è§‰æ›´åè°ƒ
      .fontWeight(FontWeight.Medium)
      .fontColor(Color.White)
      .textAlign(TextAlign.Center)
      .width('100%')
      .height('100%')
  }
}

// ============================================================================
// --- 5. ä¸»é¡µé¢é€»è¾‘ (Main List Page) ---
// ============================================================================

@Entry
@Component
export struct PetListPage {
  @State pets: Pet[] = [];
  dialogController: CustomDialogController | null = null;

  async aboutToAppear() {
    await this.refreshDataList();
  }

  async refreshDataList() {
    const db = DatabaseManager.getInstance();
    let resultSet = await db.queryAllPets();
    let temp: Pet[] = [];

    // 1. å®‰å…¨è§£ææ•°æ®åº“æ•°æ®
    if (resultSet !== undefined) {
      try {
        if (resultSet.rowCount > 0) {
          while (resultSet.goToNextRow()) {
            const bday = resultSet.getString(resultSet.getColumnIndex('birthday'));
            temp.push({
              id: resultSet.getLong(resultSet.getColumnIndex('id')),
              name: resultSet.getString(resultSet.getColumnIndex('name')),
              species: resultSet.getString(resultSet.getColumnIndex('species')),
              gender: resultSet.getString(resultSet.getColumnIndex('gender')),
              birthday: bday,
              photoPath: resultSet.getString(resultSet.getColumnIndex('photoPath')),
              age: new Date().getFullYear() - new Date(bday).getFullYear()
            });
          }
        }
      } catch (err) {
        console.error('è§£æå® ç‰©åˆ—è¡¨å¤±è´¥: ' + JSON.stringify(err));
      } finally {
        // ç¡®ä¿èµ„æºé‡Šæ”¾
        resultSet.close();
      }
    }

    // 3. æ›´æ–° UI çŠ¶æ€
    this.pets = temp;
  }

  /**
   * @description å”¤èµ·å® ç‰©é«˜ä¿çœŸè¯¦æƒ…å¡ç‰‡
   * ä¿®å¤æŠ¥é”™: Function return type inference is limited (æ˜¾å¼å£°æ˜ : void)
   * @param item å½“å‰é€‰ä¸­çš„å® ç‰©æ•°æ®å¯¹è±¡
   * @returns void
   */
  public invokeDetailCard(item: Pet): void {
    console.info('[Interaction] å‡†å¤‡æ‰§è¡Œï¼šå”¤èµ·è¯¦æƒ…æ²‰æµ¸å¼å¡ç‰‡');

    // 1. é˜²å¾¡æ€§ç¼–ç¨‹ï¼šæ£€æŸ¥ä¼ å…¥å¯¹è±¡æ˜¯å¦åˆæ³•
    if (item === null || item === undefined) {
      console.error('[Error] å°è¯•å”¤èµ·è¯¦æƒ…é¡µæ—¶ä¼ å…¥äº†æ— æ•ˆçš„ Pet å¯¹è±¡');
      return;
    }

    // 2. å®ä¾‹åŒ–å¼¹çª—æ§åˆ¶å™¨ï¼Œæ˜¾å¼å±•å¼€æ‰€æœ‰é…ç½®å±æ€§
    this.dialogController = new CustomDialogController({
      // æ˜¾å¼æŒ‡å®š builder é—­åŒ…çš„è¿”å›ç±»å‹
      builder: PetDetailDialog({
        pet: item,
        onLongPressEdit: (): void => {
          console.info('[Callback] è¯¦æƒ…é¡µé•¿æŒ‰åé¦ˆï¼Œæ­£åœ¨é‡å®šå‘è‡³ç¼–è¾‘è¡¨å•');
          this.invokeEditForm(item);
        }
      }),
      // è‡ªåŠ¨å–æ¶ˆé…ç½®ï¼šç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
      autoCancel: true,
      // è‡ªå®šä¹‰æ ·å¼å¼€å…³ï¼šå¼€å¯åå¯å…¨æƒæ§åˆ¶å¼¹çª— UI è¾¹ç•Œ
      customStyle: true,
      // å¼¹çª—åœ¨å±å¹•ä¸­çš„å¯¹é½ä½ç½®
      alignment: DialogAlignment.Center,
      // å¼¹çª—ç›¸å¯¹äºå¯¹é½ä½ç½®çš„åç§»é‡
      offset: { dx: 0, dy: 0 },
      // é®ç½©å±‚é¢œè‰²é…ç½®
      maskColor: '#33000000'
    });

    // 3. æ‰§è¡Œå¼¹çª—å¼€å¯æŒ‡ä»¤
    this.dialogController.open();
    console.info('[System] è¯¦æƒ…å¡ç‰‡å·²æˆåŠŸæ¸²æŸ“');
  }

  /**
   * @description å”¤èµ·å® ç‰©å½•å…¥æˆ–ä¿®æ”¹çš„äº¤äº’è¡¨å•
   * ä¿®å¤æŠ¥é”™: Function return type inference is limited (æ˜¾å¼å£°æ˜ : void)
   * @param target å¾…ç¼–è¾‘çš„å® ç‰©å¯¹è±¡ï¼Œè‹¥ä¸ä¼ åˆ™è§†ä¸ºæ–°å¢
   * @returns void
   */
  public invokeEditForm(target?: Pet): void {
    console.info('[Interaction] å‡†å¤‡æ‰§è¡Œï¼šå”¤èµ·æ¡£æ¡ˆå½•å…¥è¡¨å•');

    this.dialogController = new CustomDialogController({
      builder: PetAddDialog({
        editPet: target,
        // æ˜¾å¼å£°æ˜å›è°ƒå‡½æ•°è¿”å›ç±»å‹ä¸ºå¼‚æ­¥ Promise<void>
        confirm: async (name: string, spec: string, gen: string, bday: string, pic: string,
          id?: number): Promise<void> => {
          console.info('[Transaction] æ”¶åˆ°è¡¨å•ä¿å­˜æŒ‡ä»¤ï¼Œå‡†å¤‡æŒä¹…åŒ–æ•°æ®...');
          const mgr = DatabaseManager.getInstance();

          try {
            if (id) {
              await mgr.updatePet(id, name, spec, bday, gen, pic);
              promptAction.showToast({ message: 'æ¡£æ¡ˆå·²æˆåŠŸåŒæ­¥è‡³æœ¬åœ°åº“' });
            } else {
              await mgr.insertPet(name, spec, bday, gen, pic);
              promptAction.showToast({ message: 'æ–°æˆå‘˜å·²æˆåŠŸå½•å…¥æ¡£æ¡ˆåº“' });
            }
            AppStorage.setOrCreate('petDataChangeSignal', Date.now());
            // åˆ·æ–°ä¸»é¡µåˆ—è¡¨æ•°æ®æµ
            await this.refreshDataList();
          } catch (error) {
            console.error('[Database] æŒä¹…åŒ–è¿‡ç¨‹å‘ç”Ÿå¼‚å¸¸: ' + JSON.stringify(error));
          }
        }
      }),
      autoCancel: true,
      customStyle: true,
      alignment: DialogAlignment.Center,
      offset: { dx: 0, dy: 0 },
      maskColor: '#33000000'
    });

    this.dialogController.open();
  }

  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      Column() {
        // å¤´éƒ¨
        Column() {
          Text('å® ç‰©åŸºåœ°')
            .MainTitleStyle()
            .margin({ top: 60, bottom: 8 })
          Text(`ç®¡ç†æ ¸å¿ƒ Â· å·²å½•å…¥ ${this.pets.length} ä»½æ¡£æ¡ˆ`).SubTitleStyle()
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
        .padding({ left: 25, right: 25, bottom: 30 })

        // åˆ—è¡¨
        List({ space: 16 }) {
          ForEach(this.pets, (item: Pet) => {
            ListItem() {
              this.PetCardBuilder(item)
            }
            .onClick(() => this.invokeDetailCard(item))
            .swipeAction({ end: this.DeleteActionBuilder(item) })
          }, (item: Pet) => item.id.toString())
        }
        .padding({ left: 20, right: 20, bottom: 120 })
        .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(ThemeConfig.PAGE_BG)

      // æ‚¬æµ®æŒ‰é’®
      this.FloatingBtnUI()
    }
  }

  @Builder
  PetCardBuilder(item: Pet) {
    Row() {
      Image($r('app.media.icon'))
        .width(85)
        .height(85)
        .borderRadius(18)
        .margin(15)
        .objectFit(ImageFit.Cover)
      Column({ space: 6 }) {
        Row() {
          Text(item.name)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
          Text(item.gender === 'å…¬' ? ' â™‚' : ' â™€')
            .fontColor(item.gender === 'å…¬' ? '#3182CE' : '#E53E3E')
            .margin({ left: 8 })
        }

        Text(item.species)
          .fontSize(14)
          .fontColor(ThemeConfig.TEXT_SUB)
          .backgroundColor('#EDF2F7')
          .padding({
            left: 8,
            right: 8,
            top: 2,
            bottom: 2
          })
          .borderRadius(6)
      }.alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(24)
    .shadow({ radius: 10, color: '#08000000', offsetY: 4 })
  }

  @Builder
  DeleteActionBuilder(item: Pet) {
    Button() {
      Image($r('app.media.delete_list')).width(24).fillColor(Color.White)
    }
    .width(70)
    .height(85)
    .backgroundColor(ThemeConfig.ERROR_COLOR)
    .borderRadius(20)
    .margin({ left: 15 })
    .onClick(async () => {
      await DatabaseManager.getInstance().deletePet(item.id!);
      await this.refreshDataList();
    })
  }

  @Builder
  FloatingBtnUI() {
    Button('+ æ–°å¢')
      .width(120)
      .height(60)
      .borderRadius(30)
      .backgroundColor(ThemeConfig.PRIMARY_COLOR)
      .shadow({ radius: 20, color: '#40007DFF', offsetY: 10 })
      .margin({ right: 25, bottom: 40 })
      .onClick(() => this.invokeEditForm())
  }
}