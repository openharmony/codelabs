/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import dataPreferences from '@ohos.data.preferences'; // ã€æ–°å¢ã€‘å¯¼å…¥é¦–é€‰é¡¹æ¨¡å—

// --- æ–°å¢ï¼šæ³¨å†Œå¼¹çª—ï¼ˆå¢åŠ è¡Œæ•°å¹¶è§£å†³è¾“å…¥é—®é¢˜ï¼‰ ---
@CustomDialog
struct RegisterDialog {
  controller: CustomDialogController = new CustomDialogController({ builder: '' })
  @State regUser: string = ''
  @State regPass: string = ''
  @State regPass2: string = ''
  confirm: (u: string, p: string, p2: string) => void = () => {
  }

  build() {
    Column({ space: 15 }) {
      Text('æ–°ç”¨æˆ·æ³¨å†Œ').fontSize(20).fontWeight(FontWeight.Bold).margin({ top: 10 })
      TextInput({ placeholder: 'è¯·è¾“å…¥è´¦å·' }).onChange(v => this.regUser = v).width('90%')
      TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ' }).type(InputType.Password).onChange(v => this.regPass = v).width('90%')
      TextInput({ placeholder: 'ç¡®è®¤å¯†ç ' }).type(InputType.Password).onChange(v => this.regPass2 = v).width('90%')
      Row({ space: 20 }) {
        Button('å–æ¶ˆ').onClick(() => this.controller.close()).backgroundColor('#EEE').fontColor('#666').layoutWeight(1)
        Button('ç¡®å®š').onClick(() => {
          this.confirm(this.regUser, this.regPass, this.regPass2)
          this.controller.close()
        }).backgroundColor('#FF9800').layoutWeight(1)
      }.width('90%').margin({ bottom: 10 })
    }.padding(20).backgroundColor(Color.White).borderRadius(20)
  }
}

// --- æ–°å¢ï¼šæ‰¾å›å¯†ç å¼¹çª— ---
@CustomDialog
struct ForgetDialog {
  controller: CustomDialogController = new CustomDialogController({ builder: '' })
  @State user: string = ''
  @State code: string = ''
  @State newP: string = ''
  @State newP2: string = ''
  confirm: (u: string, c: string, p: string, p2: string) => void = () => {
  }

  build() {
    Column({ space: 15 }) {
      Text('é‡ç½®å¯†ç ').fontSize(20).fontWeight(FontWeight.Bold).margin({ top: 10 })
      TextInput({ placeholder: 'è´¦å·', text: this.user }).onChange(v => this.user = v).width('90%')
      TextInput({ placeholder: 'éªŒè¯ç  (1234)' }).onChange(v => this.code = v).width('90%')
      TextInput({ placeholder: 'æ–°å¯†ç ' }).type(InputType.Password).onChange(v => this.newP = v).width('90%')
      TextInput({ placeholder: 'ç¡®è®¤æ–°å¯†ç ' }).type(InputType.Password).onChange(v => this.newP2 = v).width('90%')
      Row({ space: 20 }) {
        Button('å–æ¶ˆ').onClick(() => this.controller.close()).backgroundColor('#EEE').fontColor('#666').layoutWeight(1)
        Button('é‡ç½®').onClick(() => {
          this.confirm(this.user, this.code, this.newP, this.newP2)
          this.controller.close()
        }).backgroundColor('#FF9800').layoutWeight(1)
      }.width('90%').margin({ bottom: 10 })
    }.padding(20).backgroundColor(Color.White).borderRadius(20)
  }
}

type UserAccountMap = Record<string, string>;

@Component
export struct LoginPage {
  onLoginSuccess?: () => void
  @State user: string = ''
  @State pass: string = ''
  @State isRememberPwd: boolean = false
  @State isLoginLoading: boolean = false
  @State loginErrorCount: number = 0
  @State userErrorMsg: string = ''
  @State passErrorMsg: string = ''
  @State pwdLevelText: string = ''
  @State pwdLevelColor: Color = Color.Grey
  @State isShowRegister: boolean = false
  @State regUser: string = ''
  @State regPass: string = ''
  @State regPass2: string = ''
  @State regErrorMsg: string = ''
  @State isShowForgetPwd: boolean = false
  @State forgetUser: string = ''
  @State forgetCode: string = ''
  @State newPwd: string = ''
  @State newPwd2: string = ''
  @State forgetErrorMsg: string = ''
  @State verifyCode: string = '1234'
  @State isPageInited: boolean = false
  @State savedUser: string = 'admin' // é»˜è®¤è´¦å·
  @State savedPass: string = '123456' // é»˜è®¤å¯†ç 
  // --- æ’å…¥å¼¹çª—æ§åˆ¶å™¨ï¼Œå…³è”åˆšæ‰å®šä¹‰çš„å¼¹çª— ---
  regDialog: CustomDialogController = new CustomDialogController({
    builder: RegisterDialog({
      confirm: (u, p, p2) => {
        this.regUser = u;
        this.regPass = p;
        this.regPass2 = p2
        this.handleRegister() // è°ƒç”¨ä½ åŸæœ‰çš„æ³¨å†Œé€»è¾‘
      }
    }),
    autoCancel: true, alignment: DialogAlignment.Center
  })
  forgetDialog: CustomDialogController = new CustomDialogController({
    builder: ForgetDialog({
      confirm: (u, c, p, p2) => {
        this.forgetUser = u;
        this.forgetCode = c;
        this.newPwd = p;
        this.newPwd2 = p2
        this.handleForgetPwd() // è°ƒç”¨ä½ åŸæœ‰çš„é‡ç½®é€»è¾‘
      }
    }),
    autoCancel: true, alignment: DialogAlignment.Center
  })

  async aboutToAppear() {
    try {
      await this.loadAccountFromDisk();
      this.initLoginPage()
      console.info('ç™»å½•é¡µé¢åˆå§‹åŒ–å®Œæˆ')
    } catch (error) {
      console.error('ç™»å½•é¡µé¢åˆå§‹åŒ–å¼‚å¸¸ï¼š' + error)
    }
  }

  aboutToDisappear(): void {
    try {
      this.resetLoginState()
      console.info('ç™»å½•é¡µé¢å·²é”€æ¯')
    } catch (error) {
      console.error('ç™»å½•é¡µé¢é”€æ¯å¼‚å¸¸ï¼š' + error)
    }
  }

  build() {
    Column({ space: 20 }) {
      Text('ğŸ¾').fontSize(80).margin({ top: 60 })
      Text('å® ç‰©è®°å½•ç°¿').fontSize(26).fontWeight(FontWeight.Bold).fontColor('#333')
      Text('æ‚¨çš„ä¸“å±å® ç‰©æˆé•¿è®°å½•åŠ©æ‰‹').fontSize(14).fontColor('#999').margin({ bottom: 10 })

      Column({ space: 4 }) {
        TextInput({ placeholder: 'è´¦å·ï¼ˆæ”¯æŒæ‰‹æœºå·/é‚®ç®±/ç”¨æˆ·åï¼‰', text: this.user })
          .onChange((value: string) => {
            this.user = value
            this.checkAccountFormat(value)
          })
          .onFocus(() => {
            this.userErrorMsg = ''
          })
          .height(50)
          .width('80%')
          .padding({ left: 15, right: 15 })
          .backgroundColor('#F7F8FA')
          .borderRadius(8)
        if (this.userErrorMsg) {
          Text(this.userErrorMsg)
            .fontSize(12)
            .fontColor(Color.Red)
            .width('80%')
            .textAlign(TextAlign.Start)
        }
      }

      Column({ space: 4 }) {
        TextInput({ placeholder: 'å¯†ç ï¼ˆ6-16ä½ï¼Œæ”¯æŒæ•°å­—/å­—æ¯/ç‰¹æ®Šå­—ç¬¦ï¼‰', text: this.pass })
          .onChange((value: string) => {
            this.pass = value
            this.checkPasswordFormat(value)
          })
          .onFocus(() => {
            this.passErrorMsg = ''
          })
          .height(50)
          .width('80%')
          .padding({ left: 15, right: 15 })
          .backgroundColor('#F7F8FA')
          .borderRadius(8)
        if (this.passErrorMsg) {
          Text(this.passErrorMsg)
            .fontSize(12)
            .fontColor(Color.Red)
            .width('80%')
            .textAlign(TextAlign.Start)
        } else {
          Text(this.pwdLevelText)
            .fontSize(12)
            .fontColor(this.pwdLevelColor)
            .width('80%')
            .textAlign(TextAlign.Start)
        }
      }

      Row({ space: 0 }) {
        Checkbox({ name: 'remember' })
          .select(this.isRememberPwd)
          .onChange((checked: boolean) => {
            this.isRememberPwd = checked

          })
        Text('è®°ä½å¯†ç ').fontSize(12).fontColor('#666').margin({ left: 5, right: 20 })
      }
      .width('80%')
      .justifyContent(FlexAlign.Start)
      .margin({ top: 5, bottom: 5 })

      Button(this.isLoginLoading ? 'ç™»å½•ä¸­...' : 'ç«‹å³è¿›å…¥')
        .width('80%')
        .height(50)
        .backgroundColor('#FF9800')
        .borderRadius(8)
        .fontWeight(FontWeight.Bold) // ç»„é•¿å»ºè®®ï¼šåŠ ç²—æ˜¾å¾—æ›´ä¸“ä¸š
        .enabled(!this.isLoginLoading)
        .onClick(() => {
          const isUserOk: boolean = this.checkAccountFormat(this.user)
          const isPassOk: boolean = this.checkPasswordFormat(this.pass)

          if (!isUserOk || !isPassOk) {
            AlertDialog.show({
              message: this.userErrorMsg || this.passErrorMsg,
              primaryButton: {
                value: 'çŸ¥é“äº†',
                action: (): void => {
                }
              }
            })
            return
          }

          this.isLoginLoading = true

          setTimeout(async () => {
            let pref = await dataPreferences.getPreferences(getContext(this), 'AccountStore');
            let jsonStr = await pref.get('all_users_json', '{}') as string;

            // ã€å…³é”®ä¿®æ”¹ç‚¹ã€‘ï¼šåŒæ ·ä½¿ç”¨ Record ç±»å‹
            let userMap: Record<string, string> = JSON.parse(jsonStr) as Record<string, string>;

            // 1. ä¿åº• admin é€»è¾‘
            if (this.user === 'admin' && this.pass === '123456') {
              this.loginSuccessHandle();
            }
            // 2. ä»ç¡¬ç›˜å…¨é‡åº“é‡ŒåŒ¹é…
            // æ³¨æ„ï¼šArkTS ä¸­æ¨èä½¿ç”¨ Object.keys().includes() æˆ–ç›´æ¥åˆ¤æ–­
            else if (userMap[this.user] && userMap[this.user] === this.pass) {
              this.loginSuccessHandle();
            } else {
              this.loginFailHandle();
            }
            this.isLoginLoading = false
          }, 800)
        })

      Row({ space: 30 }) {
        Text('å¿˜è®°å¯†ç ï¼Ÿ')
          .fontSize(12).fontColor('#FF9800')
          .onClick(() => {
            this.forgetDialog.open() // æ”¹ä¸ºè°ƒç”¨æ§åˆ¶å™¨
          })
        Text('è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ')
          .fontSize(12).fontColor('#999')
          .onClick(() => {
            this.regDialog.open() // æ”¹ä¸ºè°ƒç”¨æ§åˆ¶å™¨
          })
      }.margin({ top: 10 })

      Text('ç™»å½•é¡»çŸ¥ï¼š\n1. æµ‹è¯•è´¦å·ï¼šadmin å¯†ç ï¼š123456\n2. æ³¨å†Œè´¦å·ä»…åšæœ¬åœ°ç¼“å­˜ï¼Œæ— éœ€çœŸå®ä¿¡æ¯\n3. è®°ä½å¯†ç åŠŸèƒ½å¯è‡ªåŠ¨ä¿å­˜æ‚¨çš„è´¦å·ä¿¡æ¯')
        .fontSize(10)
        .fontColor('#CCCCCC')
        .width('80%')
        .textAlign(TextAlign.Center)
        .margin({ top: 20 })

    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .padding({ left: 20, right: 20 })
    // âœ… ä¿®å¤æŠ¥é”™ï¼šItemAlign â†’ HorizontalAlign
    .alignItems(HorizontalAlign.Center)
  }

  private initLoginPage(): void {
    if (this.isRememberPwd) {
      this.user = this.savedUser;
      this.pass = this.savedPass;
    }
    this.isPageInited = true
  }

  private resetLoginState(): void {
    this.userErrorMsg = ''
    this.passErrorMsg = ''
    this.loginErrorCount = 0
    this.isLoginLoading = false
    this.regErrorMsg = ''
    this.forgetErrorMsg = ''
  }

  private async saveAccountToDisk(username: string, password: string) {
    try {
      let pref = await dataPreferences.getPreferences(getContext(this), 'AccountStore');

      // è¯»å–å…¨å®¶æ¡¶å­—ç¬¦ä¸²
      let jsonStr = await pref.get('all_users_json', '{}') as string;

      // ã€å…³é”®ä¿®æ”¹ç‚¹ã€‘ï¼šè§£ææ—¶æŒ‡å®šç±»å‹ä¸º Record<string, string>
      let userMap: Record<string, string> = JSON.parse(jsonStr) as Record<string, string>;

      // å¾€é‡Œæ·»äºº
      userMap[username] = password;

      // é‡æ–°æ‰“åŒ…
      await pref.put('all_users_json', JSON.stringify(userMap));
      await pref.flush();

      console.info(`PetDiary: è´¦å·åº“æ›´æ–°æˆåŠŸï¼Œå½“å‰è´¦å·æ•°: ${Object.keys(userMap).length}`);
    } catch (err) {
      console.error('PetDiary: å­˜ç›˜é€»è¾‘å¼‚å¸¸');
    }
  }

  /**
   * ã€ç»„é•¿å¢é‡ä»£ç ã€‘ï¼šä»æ‰‹æœºç£ç›˜è¯»å–æ›¾ç»æ³¨å†Œè¿‡çš„è´¦å·
   */
  private async loadAccountFromDisk() {
    try {
      let pref = await dataPreferences.getPreferences(getContext(this), 'AccountStore');

      // 1. åŠ è½½æ‰€æœ‰æ³¨å†Œè¿‡çš„ç”¨æˆ·åº“ï¼ˆä½ åŸæœ‰çš„é€»è¾‘ï¼‰
      const u = await pref.get('saved_user', 'admin') as string;
      const p = await pref.get('saved_pass', '123456') as string;
      this.savedUser = u;
      this.savedPass = p;

      // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šåŠ è½½â€œè®°ä½å¯†ç â€ç›¸å…³çš„çŠ¶æ€
      this.isRememberPwd = await pref.get('is_remember', false) as boolean;

      if (this.isRememberPwd) {
        // å¦‚æœä¸Šæ¬¡é€‰äº†è®°ä½å¯†ç ï¼ŒæŠŠè´¦å·å¯†ç å¡«å›è¾“å…¥æ¡†å˜é‡
        this.user = await pref.get('last_input_user', '') as string;
        this.pass = await pref.get('last_input_pass', '') as string;
      }

      console.info(`PetDiary: è®°å¿†å·²å”¤é†’ã€‚è®°ä½å¯†ç ï¼š${this.isRememberPwd}ï¼Œå½“å‰è´¦å·ï¼š${this.user}`);
    } catch (err) {
      console.warn('PetDiary: è¯»å–å­˜æ¡£å¼‚å¸¸');
    }
  }

  private checkAccountFormat(account: string): boolean {
    const trimAccount: string = account.trim()
    this.user = trimAccount
    if (trimAccount === '') {
      this.userErrorMsg = 'è´¦å·ä¸èƒ½ä¸ºç©ºï¼Œè¯·è¾“å…¥æ‚¨çš„è´¦å·'
      return false
    }
    if (trimAccount.length < 3 || trimAccount.length > 20) {
      this.userErrorMsg = 'è´¦å·é•¿åº¦éœ€åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´'
      return false
    }
    const reg: RegExp = /^[a-zA-Z0-9_\u4e00-\u9fa5]+$/
    if (!reg.test(trimAccount)) {
      this.userErrorMsg = 'è´¦å·ä»…æ”¯æŒæ±‰å­—ã€å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿'
      return false
    }
    this.userErrorMsg = ''
    return true
  }

  private checkPasswordFormat(password: string): boolean {
    const trimPwd: string = password.trim()
    this.pass = trimPwd
    if (trimPwd === '') {
      this.passErrorMsg = 'å¯†ç ä¸èƒ½ä¸ºç©ºï¼Œè¯·è¾“å…¥æ‚¨çš„å¯†ç '
      this.pwdLevelText = ''
      this.pwdLevelColor = Color.Grey
      return false
    }
    if (trimPwd.length < 6 || trimPwd.length > 16) {
      this.passErrorMsg = 'å¯†ç é•¿åº¦éœ€åœ¨6-16ä¸ªå­—ç¬¦ä¹‹é—´'
      this.pwdLevelText = ''
      this.pwdLevelColor = Color.Grey
      return false
    }
    this.checkPwdLevel(trimPwd)
    this.passErrorMsg = ''
    return true
  }

  private checkPwdLevel(password: string): void {
    let level: number = 0
    if (/[0-9]/.test(password)) {
      level++
    }
    if (/[a-z]/.test(password)) {
      level++
    }
    if (/[A-Z]/.test(password)) {
      level++
    }
    if (/[^a-zA-Z0-9]/.test(password)) {
      level++
    }

    if (level < 2) {
      this.pwdLevelText = 'å¯†ç å¼ºåº¦ï¼šå¼±'
      this.pwdLevelColor = Color.Red
    } else if (level === 2 || level === 3) {
      this.pwdLevelText = 'å¯†ç å¼ºåº¦ï¼šä¸­'
      this.pwdLevelColor = Color.Orange
    } else {
      this.pwdLevelText = 'å¯†ç å¼ºåº¦ï¼šå¼º'
      this.pwdLevelColor = Color.Green
    }
  }

  private checkRegisterInfo(): boolean {
    this.regErrorMsg = ''
    if (this.regUser.trim() === '') {
      this.regErrorMsg = 'æ³¨å†Œè´¦å·ä¸èƒ½ä¸ºç©º'
      return false
    }
    if (!this.checkAccountFormat(this.regUser)) {
      this.regErrorMsg = this.userErrorMsg
      return false
    }
    if (this.regPass.trim() === '') {
      this.regErrorMsg = 'æ³¨å†Œå¯†ç ä¸èƒ½ä¸ºç©º'
      return false
    }
    if (!this.checkPasswordFormat(this.regPass)) {
      this.regErrorMsg = this.passErrorMsg
      return false
    }
    if (this.regPass !== this.regPass2) {
      this.regErrorMsg = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥'
      return false
    }
    return true
  }

  private checkForgetPwdInfo(): boolean {
    this.forgetErrorMsg = ''
    if (this.forgetUser.trim() === '') {
      this.forgetErrorMsg = 'è¯·è¾“å…¥æ‚¨çš„è´¦å·'
      return false
    }
    if (this.forgetCode.trim() !== this.verifyCode) {
      this.forgetErrorMsg = 'éªŒè¯ç é”™è¯¯ï¼Œæ­£ç¡®éªŒè¯ç ä¸ºï¼š1234'
      return false
    }
    if (this.newPwd.trim() === '') {
      this.forgetErrorMsg = 'è¯·è¾“å…¥æ–°å¯†ç '
      return false
    }
    if (this.newPwd !== this.newPwd2) {
      this.forgetErrorMsg = 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´'
      return false
    }
    return true
  }

  /**
   * ã€æ–°å¢å‡½æ•°ã€‘ï¼šä¸“é—¨è´Ÿè´£ä¿å­˜ç™»å½•å‹¾é€‰çŠ¶æ€å’Œè´¦å·å¯†ç 
   */
  private async saveLoginStatusToDisk() {
    let pref = await dataPreferences.getPreferences(getContext(this), 'AccountStore');

    // ä¿å­˜ä¸¤ä¸ªå‹¾é€‰æ¡†çš„çŠ¶æ€
    await pref.put('is_remember', this.isRememberPwd);

    if (this.isRememberPwd) {
      // å¦‚æœå‹¾é€‰äº†è®°ä½å¯†ç ï¼ŒæŠŠå½“å‰è¾“å…¥çš„è¿™ä¸€å¯¹å­˜å…¥â€œå¿«æ·å¡«å……æ â€
      await pref.put('last_input_user', this.user);
      await pref.put('last_input_pass', this.pass);
    } else {
      // å¦‚æœæ²¡å‹¾é€‰ï¼Œæ¸…ç†æ‰ç¡¬ç›˜é‡Œçš„å¿«æ·å¡«å……ä¿¡æ¯
      await pref.put('last_input_user', '');
      await pref.put('last_input_pass', '');
    }
    await pref.flush();
    console.info('PetDiary: ç™»å½•åå¥½è®¾ç½®å·²æ›´æ–°åˆ°ç¡¬ç›˜');
  }

  private loginSuccessHandle(): void {
    // ã€æ ¸å¿ƒåŠ¨ä½œã€‘ï¼šåœ¨å…¨å±€å­˜å‚¨ä¸­é”å®šå½“å‰ç”¨æˆ·èº«ä»½
    // è¿™ä¸€è¡Œä»£ç å°±åƒæ˜¯åœ¨æ‰‹æœºå†…å­˜é‡ŒæŒ‚äº†ä¸€ä¸ªå…¨å±€ç‰Œå­
    AppStorage.setOrCreate('currentUserName', this.user);
    this.saveLoginStatusToDisk();
    const loginTime = new Date().getTime();
    AppStorage.setOrCreate('lastLoginTime', loginTime);
    console.info(`PetDiary: ç”¨æˆ·[${this.user}]äº${loginTime}ç™»å½•æˆåŠŸï¼Œèº«ä»½å·²å…¨å±€ç»‘å®š`);

    this.onLoginSuccess?.()
    this.loginErrorCount = 0
  }

  private loginFailHandle(): void {
    this.loginErrorCount++
    this.isLoginLoading = false
    if (this.loginErrorCount >= 3) {
      AlertDialog.show({
        title: 'ç™»å½•å¤±è´¥',
        message: `æ‚¨å·²è¿ç»­è¾“é”™${this.loginErrorCount}æ¬¡ï¼Œè´¦å·ï¼šadminï¼Œå¯†ç ï¼š123456`,
        primaryButton: {
          value: 'çŸ¥é“äº†',
          action: (): void => {
            this.loginErrorCount = 0
          }
        }
      })
    } else {
      AlertDialog.show({
        message: 'è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ï¼',
        primaryButton: {
          value: 'çŸ¥é“äº†',
          action: (): void => {
          }
        }
      })
    }
  }

  private handleRegister(): void {
    if (this.checkRegisterInfo()) {
      // --- ã€å…³é”®ä¿®æ”¹ã€‘ï¼šå°†æ³¨å†Œçš„ä¿¡æ¯å­˜å…¥æ¨¡æ‹Ÿå­˜æ¡£ ---
      this.savedUser = this.regUser
      this.savedPass = this.regPass
      this.saveAccountToDisk(this.regUser, this.regPass);
      AlertDialog.show({
        title: 'æ³¨å†ŒæˆåŠŸ',
        message: `æ­å–œï¼Œè´¦å·ã€${this.regUser}ã€‘å·²ç”Ÿæ•ˆï¼`,
        primaryButton: {
          value: 'ç«‹å³å»ç™»å½•',
          action: (): void => {
            this.isShowRegister = false;
            this.user = this.regUser // è‡ªåŠ¨å¡«å…¥åˆšæ³¨å†Œçš„è´¦å·
            this.pass = '' // æ¸…ç©ºå¯†ç æ¡†è®©ç”¨æˆ·æ‰‹åŠ¨è¾“ä¸€æ¬¡
          }
        }
      })
    } else {
      AlertDialog.show({
        message: this.regErrorMsg,
        primaryButton: {
          value: 'çŸ¥é“äº†',
          action: (): void => {
          }
        }
      })
    }
  }

  private handleForgetPwd(): void {
    if (this.checkForgetPwdInfo()) {
      // --- ã€å…³é”®æ–°å¢ï¼šåŒæ­¥æ›´æ–°å†…å­˜å’Œç¡¬ç›˜é‡Œçš„å¯†ç ã€‘ ---
      this.savedPass = this.newPwd; // æ›´æ–°å½“å‰å†…å­˜å˜é‡
      this.saveAccountToDisk(this.forgetUser, this.newPwd); // è°ƒç”¨ä½ å†™å¥½çš„å­˜ç›˜å‡½æ•°ï¼ŒæŠŠæ–°å¯†ç åˆ»è¿›ç¡¬ç›˜
      // -------------------------------------------

      AlertDialog.show({
        title: 'å¯†ç é‡ç½®æˆåŠŸ',
        message: 'æ‚¨çš„å¯†ç å·²é‡ç½®æˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•',
        primaryButton: {
          value: 'ç¡®å®š',
          action: (): void => {
            this.isShowForgetPwd = false;
            this.pass = this.newPwd // è‡ªåŠ¨æŠŠæ–°å¯†ç å¡«å…¥è¾“å…¥æ¡†
          }
        }
      })
    } else {
      AlertDialog.show({
        message: this.forgetErrorMsg,
        primaryButton: {
          value: 'çŸ¥é“äº†',
          action: (): void => {
          }
        }
      })
    }
  }
}