/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License,Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { MandalaLayer } from './MandalaLayer'
import router from '@ohos.router'
import { AUDIO_DATA } from '../../model/AudioItem'

@Entry
@Component
export struct MeditationPage {

  @State duration: number = 10 * 60
  @State isRunning: boolean = false

  // 1. ã€æ–°å¢ã€‘å¼•å…¥å…¨å±€å­—ä½“ç¼©æ”¾å˜é‡
  @StorageProp('appFontScale') fontScale: number = 1.0;

  private timerId?: number

  // ğŸµ éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆç”¨ Videoï¼‰
  private audioController: VideoController = new VideoController()

  private audio = AUDIO_DATA[1]

  aboutToAppear() {
    const params = router.getParams() as Record<string, number>
    if (params?.duration !== undefined) {
      this.duration = params.duration * 60
    } else {
      this.duration = 5 * 60
    }
  }

  build() {
    Stack() {

      // ===== ğŸµ éšå½¢éŸ³é¢‘æ’­æ”¾å™¨ =====
      Video({
        src: this.audio.source,
        controller: this.audioController
      })
        .width(1)
        .height(1)
        .opacity(0)          // ğŸ‘ˆ å®Œå…¨ä¸å¯è§
        .controls(false)     // ğŸ‘ˆ ä¸è¦ä»»ä½•æ¡†
        .autoPlay(false)

      // ===== UI =====
      Column({ space: 36 }) {

        Row() {
          MandalaLayer({ duration: this.duration })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding({ left: 45 })

        Text('æ”¾æ¾ä½ çš„æ€ç»ª')
          .fontSize(36 * this.fontScale) // 2. æ ‡é¢˜å˜å¤§
          .fontWeight(FontWeight.Medium)

        Text(this.formatTime())
          .fontSize(48 * this.fontScale) // 3. å€’è®¡æ—¶å˜å¤§
          .fontWeight(FontWeight.Bold)

        Button(this.isRunning ? 'åœæ­¢æ²‰æ€' : 'å¼€å§‹æ²‰æ€')
          .fontSize(30 * this.fontScale) // 4. æŒ‰é’®æ–‡å­—å˜å¤§
          .height(60 * this.fontScale)   // 5. æŒ‰é’®å°ºå¯¸é€‚é…
          .width(220 * this.fontScale)
          .onClick(() => {
            this.toggleMeditation()
          })
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Start)
      .alignItems(HorizontalAlign.Center)
      .padding({ top: 180 })
    }
  }

  toggleMeditation() {
    if (this.isRunning) {
      this.stopMeditation()
    } else {
      this.startMeditation()
    }
    this.isRunning = !this.isRunning
  }

  startMeditation() {
    // â–¶ï¸ æ’­æ”¾éŸ³é¢‘
    this.audioController.start()

    // â±ï¸ å¼€å§‹è®¡æ—¶
    if (this.timerId !== undefined) {
      return
    }

    this.timerId = setInterval(() => {
      if (this.duration > 0) {
        this.duration--
      } else {
        this.stopMeditation()
        this.isRunning = false
      }
    }, 1000)
  }

  stopMeditation() {
    // â¸ï¸ æš‚åœéŸ³é¢‘
    this.audioController.pause()

    // â¸ï¸ åœæ­¢è®¡æ—¶
    if (this.timerId !== undefined) {
      clearInterval(this.timerId)
      this.timerId = undefined
    }
  }

  formatTime(): string {
    let m = Math.floor(this.duration / 60)
    let s = this.duration % 60
    return `${m}:${s < 10 ? '0' + s : s}`
  }
}