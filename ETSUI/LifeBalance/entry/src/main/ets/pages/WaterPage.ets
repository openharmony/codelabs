/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License,Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { WaterDao, WaterRecord } from '../common/database/WaterDao';
import { RdbManager } from '../common/database/RdbManager';
import promptAction from '@ohos.promptAction';
import { WaterChartData, WaterTrendDialog } from './WaterTrendDialog';

interface TimeInfo {
  timePercent: number;
  stepIndex: number;
}

@Component
export struct WaterPage {
  @State actualWater: number = 0;
  @StorageLink('targetWater') goalWater: number = 2000;
  @State inputWater: string = '';
  @StorageProp('appFontScale') fontScale: number = 1.0;
  @State weeklyData: WaterChartData[] = [];
  @State selectedDate: Date = new Date();
  @StorageProp('globalDataUpdate') @Watch('onUpdateData') updateSignal: number = 0;
  // ã€ä¿®æ”¹ç‚¹1ã€‘ç§»é™¤ @State è®¾ç½®å˜é‡ï¼Œæ”¹ä¸ºå†…éƒ¨å›ºå®šå¸¸é‡
  dialogController: CustomDialogController | null = null;
  // æ¯å¤©åˆ†ä¸º 6 ä¸ªæ—¶æ®µè¿›è¡Œæ£€æŸ¥ï¼ˆçº¦æ¯2å°æ—¶ä¸€æ¬¡ï¼‰ï¼Œé˜²æ­¢é¢‘ç¹å¼¹çª—æ‰“æ‰°
  private readonly REMIND_COUNT: number = 6;
  private readonly WAKE_START_HOUR: number = 8;
  private readonly WAKE_END_HOUR: number = 20;
  private lastNotifiedStep: number = -1;
  // æ ·å¼å¸¸é‡
  private readonly COLOR_PRIMARY: string = '#007DFF';
  private readonly COLOR_BACKGROUND: string = '#F1F7FF';
  private readonly COLOR_CARD_BG: string = '#FFFFFF';
  private readonly COLOR_TEXT_MAIN: string = '#000000';
  private readonly COLOR_TEXT_SUB: string = '#666666';
  private readonly BUTTON_SHADOW_COLOR: string = '#10000000';
  private readonly BUTTON_RADIUS: number = 15;
  private readonly SHADOW_RADIUS: number = 4;
  private waterDao = new WaterDao();

  onUpdateData() {
    this.refreshData();
  }

  getSelectedDateStr(): string {
    const y = this.selectedDate.getFullYear();
    const m = (this.selectedDate.getMonth() + 1).toString().padStart(2, '0');
    const d = this.selectedDate.getDate().toString().padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  getSystemTodayStr(): string {
    const now = new Date();
    const y = now.getFullYear();
    const m = (now.getMonth() + 1).toString().padStart(2, '0');
    const d = now.getDate().toString().padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  changeDate(days: number) {
    let newDate = new Date(this.selectedDate);
    newDate.setDate(newDate.getDate() + days);
    this.selectedDate = newDate;
    this.refreshData();
  }

  async aboutToAppear() {
    const store = RdbManager.getInstance().getRdbStore();
    if (!store) {
      return;
    }
    await this.refreshData();

    // å¦‚æœæ˜¯ä»Šå¤©ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å¼¹çª—æé†’
    if (this.getSelectedDateStr() === this.getSystemTodayStr()) {
      this.checkAndNotify();
    }
  }

  async refreshData() {
    try {
      const dateStr = this.getSelectedDateStr();
      let record = await this.waterDao.getWaterByDate(dateStr);
      if (record) {
        this.actualWater = record.actual;
        this.goalWater = record.goal;
      } else {
        this.actualWater = 0;
      }
    } catch (error) {
      console.error(`WaterPage refresh error: ${JSON.stringify(error)}`);
    }
  }

  async openTrendDialog() {
    const dates: string[] = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const y = d.getFullYear();
      const m = (d.getMonth() + 1).toString().padStart(2, '0');
      const day = d.getDate().toString().padStart(2, '0');
      dates.push(`${y}-${m}-${day}`);
    }
    const records = await this.waterDao.getWaterBatch(dates);
    this.weeklyData = records.map(r => new WaterChartData(r.date, r.actual));

    this.dialogController = new CustomDialogController({
      builder: WaterTrendDialog({ data: this.weeklyData }),
      customStyle: true,
      alignment: DialogAlignment.Center,
      autoCancel: true
    });
    this.dialogController.open();
  }

  async addWater(amount: number) {
    if (amount <= 0) {
      return;
    }
    this.actualWater += amount;
    const record: WaterRecord = {
      date: this.getSelectedDateStr(),
      actual: this.actualWater,
      goal: this.goalWater
    };
    const success = await this.waterDao.saveWaterRecord(record);
    if (success) {
      promptAction.showToast({ message: `å·²è®°å½•`, duration: 2000 });
      AppStorage.SetOrCreate('globalDataUpdate', Date.now());

      // è®°å½•æ•°æ®åï¼Œé‡æ–°æ£€æŸ¥è¿›åº¦ï¼Œå¦‚æœè¾¾æ ‡äº†å°±ä¸å†å¼¹çª—
      if (this.getSelectedDateStr() === this.getSystemTodayStr()) {
        this.checkAndNotify();
      }
    }
    this.inputWater = '';
  }

  calculatePercent(): number {
    if (this.goalWater <= 0) {
      return 0;
    }
    const percent = Math.floor((this.actualWater / this.goalWater) * 100);
    return Math.min(percent, 100);
  }

  getTimeInfo(): TimeInfo {
    const now = new Date();
    const start = new Date();
    const end = new Date();

    // ä½¿ç”¨å†…éƒ¨å¸¸é‡
    start.setHours(this.WAKE_START_HOUR, 0, 0, 0);
    end.setHours(this.WAKE_END_HOUR, 0, 0, 0);

    if (now <= start) {
      return { timePercent: 0, stepIndex: -1 };
    }
    if (now >= end) {
      return { timePercent: 100, stepIndex: this.REMIND_COUNT - 1 };
    }

    const passed = now.getTime() - start.getTime();
    const total = end.getTime() - start.getTime();
    const timePercent = Math.floor((passed / total) * 100);
    // ä½¿ç”¨å†…éƒ¨å¸¸é‡ REMIND_COUNT
    const stepLength = total / this.REMIND_COUNT;
    const stepIndex = Math.floor(passed / stepLength);
    return { timePercent: timePercent, stepIndex: stepIndex };
  }

  async checkAndNotify() {
    if (this.getSelectedDateStr() !== this.getSystemTodayStr()) {
      return;
    }
    // ã€ä¿®æ”¹ç‚¹2ã€‘ç§»é™¤å¼€å…³åˆ¤æ–­ï¼Œé»˜è®¤æ€»æ˜¯æ£€æŸ¥ï¼ˆåªè¦æ˜¯åœ¨ä»Šå¤©ï¼‰

    const info = this.getTimeInfo();

    // å¦‚æœå½“å‰æ—¶é—´æ®µï¼ˆä¾‹å¦‚ 10:00-12:00ï¼‰å·²ç»æé†’è¿‡äº†ï¼Œå°±ä¸å†æ‰“æ‰°
    if (info.stepIndex <= this.lastNotifiedStep) {
      return;
    }

    const drinkPercent = this.calculatePercent();

    // å¦‚æœå–æ°´è¿›åº¦è¾¾æ ‡ï¼Œæ ‡è®°è¯¥æ—¶æ®µå·²å¤„ç†ï¼Œä¸å¼¹çª—
    if (drinkPercent >= info.timePercent) {
      this.lastNotifiedStep = info.stepIndex;
      return;
    }

    // è®°å½•è¯¥æ—¶æ®µå·²æé†’
    this.lastNotifiedStep = info.stepIndex;
    this.showReminderDialog(info.timePercent, drinkPercent);
  }

  showReminderDialog(timePercent: number, drinkPercent: number) {
    AlertDialog.show({
      title: 'æ¸©é¦¨æç¤º ğŸ¥¤',
      message: `ä»Šæ—¥æ—¶é—´å·²è¿‡ ${timePercent}%ï¼Œä½†æ‚¨çš„é¥®æ°´ç›®æ ‡ä»…å®Œæˆ ${drinkPercent}%ã€‚\n\nèº«ä½“ç¼ºæ°´å•¦ï¼Œå¿«å–æ¯æ°´ä¼‘æ¯ä¸€ä¸‹å§ï¼`,
      autoCancel: true,
      alignment: DialogAlignment.Center,
      offset: { dx: 0, dy: -20 },
      confirm: {
        value: 'ç«‹åˆ»å»å–',
        fontColor: '#FFFFFF',
        backgroundColor: this.COLOR_PRIMARY,
        action: () => {
          console.info('ç”¨æˆ·ç‚¹å‡»äº†å»å–æ°´');
        }
      },
      cancel: () => {
        console.info('ç”¨æˆ·æš‚æ—¶å¿½ç•¥');
      }
    });
  }

  build() {
    Column() {
      this.DateNavigator()
      this.waterProgressCard()

      Text('å¿«æ·åŠ æ°´')
        .fontSize(16 * this.fontScale)
        .fontColor(this.COLOR_TEXT_SUB)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 12, left: 10 })

      this.quickActionButtons()
      this.waterInputRow()

      // ã€ä¿®æ”¹ç‚¹3ã€‘åˆ é™¤äº†åº•éƒ¨çš„ Rowï¼ˆæé†’è®¾ç½®åŒºåŸŸï¼‰
    }
    .width('100%')
    .height('100%')
    .padding(20)
    .backgroundColor(this.COLOR_BACKGROUND)
  }

  // ... (DateNavigator, waterProgressCard, quickActionButtons, quickBtn, waterInputRow ä¿æŒä¸å˜)

  @Builder
  DateNavigator() {
    Row() {
      Column() {
        Text('é¥®æ°´è¿½è¸ª')
          .fontSize(24 * this.fontScale)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.COLOR_TEXT_MAIN)
        Text('å‘¨è¶‹åŠ¿ >')
          .fontSize(12 * this.fontScale)
          .fontColor(this.COLOR_PRIMARY)
          .margin({ top: 4 })
          .onClick(() => this.openTrendDialog())
      }
      .alignItems(HorizontalAlign.Start)

      Blank()
      Row() {
        Image($r('app.media.ic_public_arrow_left'))
          .width(24).height(24)
          .onClick(() => this.changeDate(-1))
        Text(this.getSelectedDateStr() === this.getSystemTodayStr() ? 'ä»Šå¤©' : this.getSelectedDateStr())
          .fontSize(16 * this.fontScale)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.COLOR_TEXT_MAIN)
          .margin({ left: 10, right: 10 })
          .onClick(() => {
            CalendarPickerDialog.show({
              selected: this.selectedDate,
              onAccept: (value) => {
                this.selectedDate = value;
                this.refreshData();
              }
            })
          })
        Image($r('app.media.ic_public_arrow_right_filled'))
          .width(24).height(24)
          .onClick(() => this.changeDate(1))
      }
      .backgroundColor(this.COLOR_CARD_BG)
      .padding({
        left: 8,
        right: 8,
        top: 6,
        bottom: 6
      })
      .borderRadius(16)
    }
    .width('100%')
    .padding({ top: 10, bottom: 20 })
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  waterProgressCard() {
    Stack() {
      Progress({
        value: this.actualWater,
        total: this.goalWater,
        type: ProgressType.Ring
      })
        .width(220 * this.fontScale)
        .height(220 * this.fontScale)
        .style({ strokeWidth: 20 * this.fontScale })
        .color(this.COLOR_PRIMARY)
      Column() {
        Image($r('app.media.startIcon'))
          .width(40)
          .height(40)
          .margin({ bottom: 10 })
          .objectFit(ImageFit.Contain)
        Text(`${this.calculatePercent()}%`)
          .fontSize(40 * this.fontScale)
          .fontWeight(FontWeight.Bolder)
          .fontColor(this.COLOR_PRIMARY)
        Text(`${this.actualWater} / ${this.goalWater} ml`)
          .fontSize(16 * this.fontScale)
          .fontColor(this.COLOR_TEXT_SUB)
          .margin({ top: 5 })
      }
    }
    .margin({ bottom: 40 })
  }

  @Builder
  quickActionButtons() {
    Row({ space: 15 }) {
      this.quickBtn(300, 'æ¯')
      this.quickBtn(500, 'ç“¶')
      this.quickBtn(1000, 'å¤§ç“¶')
    }
    .width('100%')
    .margin({ bottom: 30 })
    .justifyContent(FlexAlign.SpaceBetween)
  }

  @Builder
  quickBtn(amount: number, label: string) {
    Button() {
      Column() {
        Text(`+${amount}`)
          .fontSize(18 * this.fontScale)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.COLOR_PRIMARY)
        Text(label)
          .fontSize(12 * this.fontScale)
          .fontColor(this.COLOR_TEXT_SUB)
      }
    }
    .layoutWeight(1)
    .height(70 * this.fontScale)
    .backgroundColor(this.COLOR_CARD_BG)
    .borderRadius(this.BUTTON_RADIUS)
    .shadow({ radius: this.SHADOW_RADIUS, color: this.BUTTON_SHADOW_COLOR })
    .onClick(() => this.addWater(amount))
  }

  @Builder
  waterInputRow() {
    Row({ space: 10 }) {
      TextInput({ placeholder: 'æ‰‹åŠ¨è¾“å…¥ (ml)', text: this.inputWater })
        .layoutWeight(1)
        .height(50)
        .type(InputType.Number)
        .fontSize(16 * this.fontScale)
        .backgroundColor(this.COLOR_CARD_BG)
        .onChange(v => this.inputWater = v)
      Button('å–æ°´')
        .height(50)
        .width(100)
        .fontSize(16 * this.fontScale)
        .backgroundColor(this.COLOR_PRIMARY)
        .onClick(() => {
          const val = Number(this.inputWater);
          if (val > 0) {
            this.addWater(val);
          }
        })
    }
  }
}