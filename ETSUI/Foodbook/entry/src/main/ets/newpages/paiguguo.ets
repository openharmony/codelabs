/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import {  router } from '@kit.ArkUI';
import { Constants } from '../common/Constants';

// å®šä¹‰èœå“æ•°æ®ç±»åž‹
interface Dish {
  id: string;
  name: string;
  description: string;
  image: Resource;
  ingredients: string;
  seasonings: string;
}

@Entry
@Component
struct DishDetailPage {
  @State isSharePanelVisible: boolean = false;
  @State isCollected: boolean = false; // æ”¹ä¸ºä½¿ç”¨ @State è€Œä¸æ˜¯ @Link

  // ä½¿ç”¨æ˜Žç¡®ç±»åž‹çš„èœå“æ•°æ®
  private dishData: Dish = {
    id: 'paigushishuoguo',
    name: 'æŽ’éª¨æ—¶è”¬é”…',
    description: 'å®¶å¸¸ç‚–èœÂ·è¥å…»ä¸°å¯Œ',
    image: $r('app.media.paiguguo'),
    ingredients: 'æŽ’éª¨ã€åœŸè±†ã€èƒ¡èåœã€çŽ‰ç±³ã€è¥¿å…°èŠ±ã€æ´‹è‘±',
    seasonings: 'å§œç‰‡ã€è‘±æ®µã€æ–™é…’ã€ç”ŸæŠ½ã€è€æŠ½ã€å†°ç³–ã€å…«è§’ã€æ¡‚çš®ã€é¦™å¶ã€ç›ã€é¸¡ç²¾'
  };

  // æ”¶è—çŠ¶æ€å˜åŒ–å¤„ç†
  onCollectChange(): void {
    const favorites: Dish[] = AppStorage.get(Constants.FAVORITE_LIST) || [];
    if (this.isCollected) {
      // æ·»åŠ åˆ°æ”¶è—
      if (!favorites.some((item: Dish) => item.id === this.dishData.id)) {
        const newFavorites = [...favorites, this.dishData];
        AppStorage.set(Constants.FAVORITE_LIST, newFavorites);
      }
    } else {
      // ä»Žæ”¶è—ç§»é™¤
      const newFavorites = favorites.filter((item: Dish) => item.id !== this.dishData.id);
      AppStorage.set(Constants.FAVORITE_LIST, newFavorites);
    }
  }
  addToHistory(): void {
    const history: Dish[] = AppStorage.get(Constants.HISTORY_LIST) || [];
    const filtered = history.filter((item: Dish) => item.id !== this.dishData.id);
    AppStorage.set(Constants.HISTORY_LIST, [this.dishData, ...filtered]);
  }



  aboutToAppear(): void {
    const favorites: Dish[] = AppStorage.get(Constants.FAVORITE_LIST) || [];
    this.isCollected = favorites.some((item: Dish) => item.id === this.dishData.id);
    this.addToHistory();
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Image($r('app.media.return1')) // è¿”å›žå›¾æ ‡
          .width(25)
          .height(25)
          .margin({ left: 10 })
          .onClick(() => router.back())

        Text('æŽ’éª¨æ—¶è”¬é”…')
          .fontSize(25)
          .fontWeight(FontWeight.Bold)
          .margin({ left: '32%' })
          .layoutWeight(1)

      }
      .width('100%')
      .height(50)
      .backgroundColor('#FFFFFF')
      .border({ width: 1, color: '#F0F0F0' })

      // 2. å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // èœå“åç§°å’Œæ”¶è—æŒ‰é’®
          Row() {
            Column() {
              Text(this.dishData.name)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
              Text(this.dishData.description)
                .fontSize(14)
                .fontColor('#666666')
                .margin({ top: 5 })
            }
            .layoutWeight(1)
          }

          Divider().color('#F0F0F0').margin({ top: 10, bottom: 10 })

          // èœå“å›¾ç‰‡
          Image(this.dishData.image)
            .width('100%')
            .height(250)
            .objectFit(ImageFit.Cover)
            .borderRadius(8)

          // èœå“æè¿°
          Text('æŽ’éª¨æ—¶è”¬é”…æ˜¯ä¸€é“è¥å…»ä¸°å¯Œçš„å®¶å¸¸ç‚–èœï¼Œä»¥æŽ’éª¨ä¸ºä¸»æ–™ï¼Œæ­é…å¤šç§æ—¶ä»¤è”¬èœï¼Œå¦‚åœŸè±†ã€èƒ¡èåœã€çŽ‰ç±³ç­‰ã€‚æŽ’éª¨è‚‰è´¨é²œå«©ï¼Œè”¬èœå¸é¥±äº†è‚‰é¦™ï¼Œæ±¤æ±æµ“éƒé†‡åŽšï¼Œå£æ„Ÿä¸°å¯Œï¼Œæ˜¯å®¶åº­èšé¤çš„ç†æƒ³é€‰æ‹©ã€‚')
            .fontSize(16)
            .lineHeight(22)
            .margin({ top: 15 })
            .textOverflow({ overflow: TextOverflow.None })

          // é£Ÿæå‡†å¤‡
          Text('ðŸ¥© ä¸»è¦é£Ÿæ:')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 20 })

          Text(this.dishData.ingredients.split('ã€').map(item => `â€¢ ${item}`).join('\n'))
            .fontSize(16)
            .margin({ top: 8 })

          // è°ƒæ–™å‡†å¤‡
          Text('ðŸ§‚ æ‰€éœ€è°ƒæ–™:')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 20 })

          Text(this.dishData.seasonings.split('ã€').map(item => `â€¢ ${item}`).join('\n'))
            .fontSize(16)
            .margin({ top: 8 })

          // åˆ¶ä½œæ­¥éª¤
          Text('ðŸ‘©â€ðŸ³ è¯¦ç»†åšæ³•:')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 20 })

          Text('1. å‡†å¤‡é£Ÿæï¼šå°†æŽ’éª¨æ´—å‡€ï¼Œåˆ‡æˆå°æ®µï¼›åœŸè±†å’Œèƒ¡èåœåŽ»çš®åˆ‡å—ï¼›çŽ‰ç±³åˆ‡æ®µï¼›è¥¿å…°èŠ±åˆ‡æˆå°æœµï¼›æ´‹è‘±åˆ‡ä¸å¤‡ç”¨ã€‚\n\n' +
            '2. ç„¯æ°´ï¼šæŽ’éª¨æ”¾å…¥å†·æ°´é”…ä¸­ï¼ŒåŠ å…¥å§œç‰‡ã€è‘±æ®µå’Œæ–™é…’ï¼Œå¤§ç«ç…®å¼€ï¼Œæ’‡åŽ»æµ®æ²«ï¼Œæžå‡ºæŽ’éª¨ç”¨æ¸…æ°´å†²æ´—å¹²å‡€ã€‚\n\n' +
            '3. ç‚’é¦™ï¼šé”…ä¸­å€’æ²¹ï¼Œæ²¹çƒ­åŽæ”¾å…¥å§œç‰‡ã€è‘±æ®µã€å…«è§’ã€æ¡‚çš®å’Œé¦™å¶ç‚’é¦™ï¼ŒåŠ å…¥æŽ’éª¨ç¿»ç‚’è‡³è¡¨é¢å¾®é»„ã€‚\n\n' +
            '4. è°ƒå‘³ï¼šåŠ å…¥ç”ŸæŠ½ã€è€æŠ½å’Œå†°ç³–ï¼Œç»§ç»­ç¿»ç‚’å‡åŒ€ï¼Œä½¿æŽ’éª¨ä¸Šè‰²ã€‚\n\n' +
            '5. ç‚–ç…®ï¼šåŠ å…¥è¶³å¤Ÿçš„æ¸…æ°´ï¼ˆæ²¡è¿‡æŽ’éª¨ï¼‰ï¼Œå¤§ç«çƒ§å¼€åŽè½¬å°ç«æ…¢ç‚–40-50åˆ†é’Ÿï¼Œç›´åˆ°æŽ’éª¨é…¥çƒ‚ã€‚\n\n' +
            '6. åŠ è”¬èœï¼šä¾æ¬¡åŠ å…¥åœŸè±†ã€èƒ¡èåœå’ŒçŽ‰ç±³ï¼Œç»§ç»­ç‚–ç…®15-20åˆ†é’Ÿï¼Œç›´åˆ°è”¬èœç†Ÿè½¯ã€‚\n\n' +
            '7. æœ€åŽåŠ å…¥è¥¿å…°èŠ±å’Œæ´‹è‘±ï¼Œå†ç…®5åˆ†é’Ÿå·¦å³ï¼Œç›´åˆ°è¥¿å…°èŠ±å˜ç¿ ç»¿ã€‚\n\n' +
            '8. è°ƒå‘³ï¼šæ ¹æ®ä¸ªäººå£å‘³åŠ å…¥é€‚é‡ç›å’Œé¸¡ç²¾ï¼Œæ…æ‹Œå‡åŒ€å³å¯å…³ç«ã€‚')
            .fontSize(16)
            .margin({ top: 8 })
            .lineHeight(24)

          // å°è´´å£«
          Text('ðŸ’¡ çƒ¹é¥ªå°è´´å£«:')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 20, bottom: 10 })

          Text('â€¢ æŽ’éª¨ç„¯æ°´æ—¶è¦å†·æ°´ä¸‹é”…ï¼Œè¿™æ ·æ‰èƒ½å……åˆ†åŽ»é™¤è¡€æ°´å’Œè…¥å‘³\n' +
            'â€¢ ç‚–ç…®æ—¶é—´è¦è¶³å¤Ÿé•¿ï¼Œè¿™æ ·æŽ’éª¨æ‰ä¼šé…¥çƒ‚å…¥å‘³\n' +
            'â€¢ è”¬èœå¯ä»¥æ ¹æ®å­£èŠ‚å’Œä¸ªäººå–œå¥½é€‰æ‹©ï¼Œå¦‚é¦™è‡ã€å±±è¯ã€èŽ²è—•ç­‰\n' +
            'â€¢ æœ€åŽåŠ å…¥è¥¿å…°èŠ±æ˜¯ä¸ºäº†ä¿æŒå…¶ç¿ ç»¿çš„é¢œè‰²å’Œè„†å«©çš„å£æ„Ÿ\n' +
            'â€¢ å¦‚æžœå–œæ¬¢åƒè¾£ï¼Œå¯ä»¥åœ¨ç‚’é¦™æ—¶åŠ å…¥å¹²è¾£æ¤’å¢žæ·»é£Žå‘³')
            .fontSize(16)
            .margin({ bottom: 20 })
        }
        .padding(15)
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.On)
      .scrollBarColor('#cccccc')

      // 3. åº•éƒ¨æŒ‰é’®
      Column() {
        Row() {
          Button(this.isCollected ? 'å·²æ”¶è—' : 'åŠ å…¥æ”¶è—')
            .width('70%')
            .height(45)
            .backgroundColor(this.isCollected ? '#FF5722' : '#999999')
            .fontColor(Color.White)
            .onClick(() => {
              this.isCollected = !this.isCollected;
              this.onCollectChange(); // æ‰‹åŠ¨è°ƒç”¨æ”¶è—çŠ¶æ€å˜æ›´å¤„ç†
            })

          Button('åˆ†äº«')
            .width('25%')
            .height(45)
            .margin({ left: 10 })
            .backgroundColor('#4285F4')
            .fontColor(Color.White)
            .onClick(() => {
              this.isSharePanelVisible = true;
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')
      .margin({ top: 10 })

      // 4. åˆ†äº«é¢æ¿
      if (this.isSharePanelVisible) {
        Column() {
          // åˆ†äº«é€‰é¡¹
          Row() {
            Column() {
              Image($r('app.media.wxphoto'))
                .width(50)
                .height(50)
              Text('å¾®ä¿¡å¥½å‹')
                .fontSize(12)
                .margin({ top: 5 })
            }
            .margin({ right: 20 })
            .onClick(() => {
              this.isSharePanelVisible = false;
            })

            Column() {
              Image($r('app.media.moment'))
                .width(50)
                .height(50)
              Text('æœ‹å‹åœˆ')
                .fontSize(12)
                .margin({ top: 5 })
            }
            .margin({ right: 20 })
            .onClick(() => {
              this.isSharePanelVisible = false;
            })

            Column() {
              Image($r('app.media.weibo'))
                .width(50)
                .height(50)
              Text('å¾®åš')
                .fontSize(12)
                .margin({ top: 5 })
            }
            .margin({ right: 20 })
            .onClick(() => {
              this.isSharePanelVisible = false;
            })

            Column() {
              Image($r('app.media.qqphoto'))
                .width(50)
                .height(50)
              Text('QQ')
                .fontSize(12)
                .margin({ top: 5 })
            }
            .onClick(() => {
              this.isSharePanelVisible = false;
            })
          }
          .margin({ top: 20, bottom: 20 })

          // å…¶ä»–é€‰é¡¹
          Row() {
            Column() {
              Image($r('app.media.link'))
                .width(50)
                .height(50)
              Text('å¤åˆ¶é“¾æŽ¥')
                .fontSize(12)
                .margin({ top: 5 })
            }
            .margin({ right: 20 })
            .onClick(() => {
              this.isSharePanelVisible = false;
            })

            Column() {
              Image($r('app.media.more'))
                .width(50)
                .height(50)
              Text('æ›´å¤š')
                .fontSize(12)
                .margin({ top: 5 })
            }
            .onClick(() => {
              this.isSharePanelVisible = false;
            })
          }
          .margin({ bottom: 20 })

          // å–æ¶ˆæŒ‰é’®
          Button('å–æ¶ˆ')
            .width('90%')
            .height(45)
            .backgroundColor('#F5F5F5')
            .fontColor('#333333')
            .onClick(() => {
              this.isSharePanelVisible = false;
            })
        }
        .width('100%')
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(20)
        .position({ x: 0, y: '100%' })
        .translate({ y: this.isSharePanelVisible ? -200 : 0 })
        .animation({ duration: 300, curve: Curve.EaseOut })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .onClick(() => {
      if (this.isSharePanelVisible) {
        this.isSharePanelVisible = false;
      }
    })
  }
}