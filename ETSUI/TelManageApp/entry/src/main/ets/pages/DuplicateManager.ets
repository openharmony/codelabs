/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-20
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * ËÅîÁ≥ª‰∫∫ÂéªÈáçÁÆ°ÁêÜÈ°µÈù¢
 * Êèê‰æõÈáçÂ§çËÅîÁ≥ª‰∫∫Ê£ÄÊµã„ÄÅÈ¢ÑËßà„ÄÅÂêàÂπ∂„ÄÅÂøΩÁï•Á≠âÂÆåÊï¥ÂäüËÉΩ
 */

import { contact } from '@kit.ContactsKit';
import { promptAction, router } from '@kit.ArkUI';
import { abilityAccessCtrl, Context } from '@kit.AbilityKit';
import { ContactData } from '../model/ContactData';
import { DuplicateService } from '../model/DuplicateDetector';
import { DuplicateGroupModel, DuplicateStatistics, MergePreview } from '../model/MergeResult';
import {
  DEFAULT_DUPLICATE_STRATEGY_CONFIG,
  DuplicateStrategyConfig,
  DuplicateStrategyPresets,
  DuplicateStrategyType,
  DuplicateStrictLevel,
  STRATEGY_TYPE_DESCRIPTIONS,
  STRICT_LEVEL_DESCRIPTIONS
} from '../model/DuplicateStrategy';

/**
 * ËæÖÂä©ÂáΩÊï∞ÔºöÂ§çÂà∂ÈÖçÁΩÆÂØπË±°ÔºàÈÅøÂÖç‰ΩøÁî®Â±ïÂºÄËøêÁÆóÁ¨¶Ôºâ
 */
function copyStrategyConfig(config: DuplicateStrategyConfig): DuplicateStrategyConfig {
  const copied: DuplicateStrategyConfig = {
    strategyType: config.strategyType,
    strictLevel: config.strictLevel,
    phoneSimThreshold: config.phoneSimThreshold,
    nameSimThreshold: config.nameSimThreshold,
    emailSimThreshold: config.emailSimThreshold,
    overallSimThreshold: config.overallSimThreshold,
    fieldWeights: {
      phoneWeight: config.fieldWeights.phoneWeight,
      nameWeight: config.fieldWeights.nameWeight,
      emailWeight: config.fieldWeights.emailWeight,
      organizationWeight: config.fieldWeights.organizationWeight
    },
    conflictResolution: config.conflictResolution,
    ignorePhoneFormat: config.ignorePhoneFormat,
    ignoreCaseInName: config.ignoreCaseInName,
    ignoreWhitespace: config.ignoreWhitespace,
    enablePinyinMatch: config.enablePinyinMatch
  };
  return copied;
}

/**
 * Êâ´ÊèèÁä∂ÊÄÅÊûö‰∏æ
 */
enum ScanState {
  IDLE = 'IDLE',
  SCANNING = 'SCANNING',
  COMPLETED = 'COMPLETED',
  ERROR = 'ERROR'
}

/**
 * ËßÜÂõæÊ®°ÂºèÊûö‰∏æ
 */
enum ViewMode {
  LIST = 'LIST', // ÂàóË°®ËßÜÂõæ
  DETAIL = 'DETAIL', // ËØ¶ÊÉÖËßÜÂõæ
  SETTINGS = 'SETTINGS' // ËÆæÁΩÆËßÜÂõæ
}

@Entry
@Component
struct DuplicateManager {
  // ‰∏ä‰∏ãÊñá‰∏éÊï∞ÊçÆÂ±Ç
  @Provide('context') context: Context = getContext(this);
  private contactData: ContactData = new ContactData(this.context);
  private duplicateService: DuplicateService = DuplicateService.getInstance();
  // È°µÈù¢Áä∂ÊÄÅ
  @State scanState: ScanState = ScanState.IDLE;
  @State viewMode: ViewMode = ViewMode.LIST;
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  // Êï∞ÊçÆÁä∂ÊÄÅ
  @State allContacts: contact.Contact[] = [];
  @State duplicateGroups: DuplicateGroupModel[] = [];
  @State selectedGroup: DuplicateGroupModel | null = null;
  @State mergePreview: MergePreview | null = null;
  @State statistics: DuplicateStatistics | null = null;
  // ÈÖçÁΩÆÁä∂ÊÄÅ
  @State currentConfig: DuplicateStrategyConfig = copyStrategyConfig(DEFAULT_DUPLICATE_STRATEGY_CONFIG);
  @State selectedStrategyType: DuplicateStrategyType = DuplicateStrategyType.SMART_DETECT;
  @State selectedStrictLevel: DuplicateStrictLevel = DuplicateStrictLevel.NORMAL;
  // ÊâπÈáèÊìç‰ΩúÁä∂ÊÄÅ
  @State showBatchConfirm: boolean = false;
  @State batchProcessing: boolean = false;
  @State processedCount: number = 0;
  // ËØ¶ÊÉÖÈ°µÁä∂ÊÄÅ
  @State showMergeConfirm: boolean = false;
  @State showIgnoreConfirm: boolean = false;

  aboutToAppear() {
    console.log('DuplicateManager: È°µÈù¢Âç≥Â∞ÜÊòæÁ§∫');
    this.duplicateService.setContactData(this.contactData);
    this.checkPermissionsAndLoad();
  }

  /**
   * Ê£ÄÊü•ÊùÉÈôêÂπ∂Âä†ËΩΩÊï∞ÊçÆ
   */
  async checkPermissionsAndLoad() {
    const atManager = abilityAccessCtrl.createAtManager();
    try {
      const result = await atManager.requestPermissionsFromUser(this.context, [
        'ohos.permission.READ_CONTACTS',
        'ohos.permission.WRITE_CONTACTS'
      ]);

      if (result.authResults[0] === 0) {
        console.log('DuplicateManager: ÊùÉÈôêÂ∑≤Ëé∑Âèñ');
        await this.loadContacts();
      } else {
        this.errorMessage = 'ÈúÄË¶ÅÈÄöËÆØÂΩïÊùÉÈôêÊâçËÉΩ‰ΩøÁî®ÂéªÈáçÂäüËÉΩ';
        this.scanState = ScanState.ERROR;
      }
    } catch (err) {
      console.error('DuplicateManager: ÊùÉÈôêËØ∑Ê±ÇÂ§±Ë¥•', err);
      this.errorMessage = 'ÊùÉÈôêËØ∑Ê±ÇÂ§±Ë¥•';
      this.scanState = ScanState.ERROR;
    }
  }

  /**
   * Âä†ËΩΩËÅîÁ≥ª‰∫∫
   */
  async loadContacts() {
    this.isLoading = true;
    try {
      this.allContacts = await this.contactData.queryAllContacts();
      console.log(`DuplicateManager: Â∑≤Âä†ËΩΩ ${this.allContacts.length} ‰∏™ËÅîÁ≥ª‰∫∫`);
    } catch (error) {
      console.error('DuplicateManager: Âä†ËΩΩËÅîÁ≥ª‰∫∫Â§±Ë¥•', error);
      this.errorMessage = 'Âä†ËΩΩËÅîÁ≥ª‰∫∫Â§±Ë¥•';
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * ÊâßË°åÊâ´Êèè
   */
  async startScan() {
    if (this.allContacts.length === 0) {
      promptAction.showToast({ message: 'Ê≤°ÊúâËÅîÁ≥ª‰∫∫ÂèØÊâ´Êèè' });
      return;
    }

    this.scanState = ScanState.SCANNING;
    this.errorMessage = '';

    try {
      // Êõ¥Êñ∞ÈÖçÁΩÆ
      this.duplicateService.updateConfig(this.currentConfig);

      // ÊâßË°åÊâ´Êèè
      this.duplicateGroups = await this.duplicateService.scan(this.allContacts, true);

      // ËÆ°ÁÆóÁªüËÆ°‰ø°ÊÅØ
      this.statistics = this.duplicateService.getDetector()
        .getStatistics(this.allContacts, this.duplicateGroups);

      this.scanState = ScanState.COMPLETED;
      console.log(`DuplicateManager: Êâ´ÊèèÂÆåÊàêÔºåÂèëÁé∞ ${this.duplicateGroups.length} ÁªÑÈáçÂ§ç`);

      if (this.duplicateGroups.length === 0) {
        promptAction.showToast({ message: 'Êú™ÂèëÁé∞ÈáçÂ§çËÅîÁ≥ª‰∫∫' });
      }
    } catch (error) {
      console.error('DuplicateManager: Êâ´ÊèèÂ§±Ë¥•', error);
      this.errorMessage = 'Êâ´ÊèèËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ';
      this.scanState = ScanState.ERROR;
    }
  }

  /**
   * Êü•ÁúãÈáçÂ§çÁªÑËØ¶ÊÉÖ
   */
  viewGroupDetail(group: DuplicateGroupModel) {
    this.selectedGroup = group;
    try {
      this.mergePreview = this.duplicateService.getDetector().generateMergePreview(group);
    } catch (error) {
      console.error('DuplicateManager: ÁîüÊàêÈ¢ÑËßàÂ§±Ë¥•', error);
    }
    this.viewMode = ViewMode.DETAIL;
  }

  /**
   * ÂêàÂπ∂ÈÄâ‰∏≠ÁöÑÁªÑ
   */
  async mergeSelectedGroup() {
    if (!this.selectedGroup) {
      return;
    }

    this.isLoading = true;
    try {
      const success = await this.duplicateService.mergeGroup(this.selectedGroup);
      if (success) {
        promptAction.showToast({ message: 'ÂêàÂπ∂ÊàêÂäü' });
        this.duplicateGroups = this.duplicateService.getCachedGroups();
        this.viewMode = ViewMode.LIST;
        this.selectedGroup = null;
        this.mergePreview = null;

        // Âà∑Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®
        await this.loadContacts();
      } else {
        promptAction.showToast({ message: 'ÂêàÂπ∂Â§±Ë¥•' });
      }
    } catch (error) {
      console.error('DuplicateManager: ÂêàÂπ∂Â§±Ë¥•', error);
      promptAction.showToast({ message: 'ÂêàÂπ∂ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ' });
    } finally {
      this.isLoading = false;
      this.showMergeConfirm = false;
    }
  }

  /**
   * ÂøΩÁï•ÈÄâ‰∏≠ÁöÑÁªÑ
   */
  ignoreSelectedGroup() {
    if (!this.selectedGroup) {
      return;
    }

    this.duplicateService.ignoreGroup(this.selectedGroup);
    this.duplicateGroups = this.duplicateService.getCachedGroups();
    promptAction.showToast({ message: 'Â∑≤ÂøΩÁï•ËØ•ÁªÑ' });
    this.viewMode = ViewMode.LIST;
    this.selectedGroup = null;
    this.mergePreview = null;
    this.showIgnoreConfirm = false;
  }

  /**
   * ÊâπÈáèÂêàÂπ∂ÊâÄÊúâ
   */
  async batchMergeAll() {
    this.batchProcessing = true;
    this.processedCount = 0;

    try {
      const result = await this.duplicateService.mergeAll();

      if (result.success) {
        promptAction.showToast({
          message: `ÊàêÂäüÂêàÂπ∂ ${result.mergedContacts} ‰∏™ËÅîÁ≥ª‰∫∫`
        });
      } else {
        promptAction.showToast({
          message: `ÈÉ®ÂàÜÂêàÂπ∂Â§±Ë¥•: ${result.errors.join(', ')}`
        });
      }

      this.duplicateGroups = this.duplicateService.getCachedGroups();
      await this.loadContacts();
    } catch (error) {
      console.error('DuplicateManager: ÊâπÈáèÂêàÂπ∂Â§±Ë¥•', error);
      promptAction.showToast({ message: 'ÊâπÈáèÂêàÂπ∂Â§±Ë¥•' });
    } finally {
      this.batchProcessing = false;
      this.showBatchConfirm = false;
    }
  }

  /**
   * Â∫îÁî®È¢ÑËÆæÈÖçÁΩÆ
   */
  applyPreset(preset: 'strict' | 'normal' | 'loose' | 'phoneOnly') {
    switch (preset) {
      case 'strict':
        this.currentConfig = DuplicateStrategyPresets.getStrictConfig();
        break;
      case 'loose':
        this.currentConfig = DuplicateStrategyPresets.getLooseConfig();
        break;
      case 'phoneOnly':
        this.currentConfig = DuplicateStrategyPresets.getPhoneOnlyConfig();
        break;
      case 'normal':
      default:
        this.currentConfig = copyStrategyConfig(DEFAULT_DUPLICATE_STRATEGY_CONFIG);
    }

    this.selectedStrategyType = this.currentConfig.strategyType;
    this.selectedStrictLevel = this.currentConfig.strictLevel;

    promptAction.showToast({ message: 'ÈÖçÁΩÆÂ∑≤Êõ¥Êñ∞' });
  }

  build() {
    Stack() {
      // ‰∏ªÂÜÖÂÆπ
      Column() {
        // Ê†áÈ¢òÊ†è
        this.TitleBar()

        // Ê†πÊçÆËßÜÂõæÊ®°ÂºèÊòæÁ§∫‰∏çÂêåÂÜÖÂÆπ
        if (this.viewMode === ViewMode.LIST) {
          this.ListView()
        } else if (this.viewMode === ViewMode.DETAIL) {
          this.DetailView()
        } else if (this.viewMode === ViewMode.SETTINGS) {
          this.SettingsView()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f5f5f5')

      // ÂêàÂπ∂Á°ÆËÆ§ÂºπÁ™ó
      if (this.showMergeConfirm) {
        this.MergeConfirmDialog()
      }

      // ÂøΩÁï•Á°ÆËÆ§ÂºπÁ™ó
      if (this.showIgnoreConfirm) {
        this.IgnoreConfirmDialog()
      }

      // ÊâπÈáèÁ°ÆËÆ§ÂºπÁ™ó
      if (this.showBatchConfirm) {
        this.BatchConfirmDialog()
      }

      // Âä†ËΩΩÈÅÆÁΩ©
      if (this.isLoading || this.batchProcessing) {
        this.LoadingOverlay()
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * Ê†áÈ¢òÊ†è
   */
  @Builder
  TitleBar() {
    Row() {
      // ËøîÂõûÊåâÈíÆ
      Button('ËøîÂõû')
        .fontSize(16)
        .backgroundColor(Color.Transparent)
        .fontColor('#007DFF')
        .onClick(() => {
          if (this.viewMode !== ViewMode.LIST) {
            this.viewMode = ViewMode.LIST;
            this.selectedGroup = null;
            this.mergePreview = null;
          } else {
            router.back();
          }
        })

      Text(this.getTitleText())
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .textAlign(TextAlign.Center)
        .layoutWeight(1)

      // Âè≥‰æßÊìç‰ΩúÊåâÈíÆ
      if (this.viewMode === ViewMode.LIST) {
        Button('ËÆæÁΩÆ')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => {
            this.viewMode = ViewMode.SETTINGS;
          })
      } else {
        Text('').width(60)
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#f0f0f0')
  }

  /**
   * Ëé∑ÂèñÊ†áÈ¢òÊñáÊú¨
   */
  getTitleText(): string {
    switch (this.viewMode) {
      case ViewMode.DETAIL:
        return 'ÈáçÂ§çËØ¶ÊÉÖ';
      case ViewMode.SETTINGS:
        return 'ÂéªÈáçËÆæÁΩÆ';
      default:
        return 'ËÅîÁ≥ª‰∫∫ÂéªÈáç';
    }
  }

  /**
   * ÂàóË°®ËßÜÂõæ
   */
  @Builder
  ListView() {
    Column() {
      // ÁªüËÆ°‰ø°ÊÅØÂç°Áâá
      if (this.statistics) {
        this.StatisticsCard()
      }

      // Êâ´ÊèèÊåâÈíÆÂå∫Âüü
      this.ScanSection()

      // ÁªìÊûúÂàóË°®
      if (this.scanState === ScanState.COMPLETED && this.duplicateGroups.length > 0) {
        this.DuplicateGroupList()
      } else if (this.scanState === ScanState.IDLE) {
        this.IdleStateView()
      } else if (this.scanState === ScanState.ERROR) {
        this.ErrorStateView()
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  /**
   * ÁªüËÆ°‰ø°ÊÅØÂç°Áâá
   */
  @Builder
  StatisticsCard() {
    Column() {
      Text('Êâ´ÊèèÁªìÊûú')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .width('100%')
        .margin({ bottom: 12 })

      Row() {
        this.StatItem('ÊÄªËÅîÁ≥ª‰∫∫', this.statistics!.totalContacts.toString())
        this.StatItem('ÈáçÂ§çÁªÑ', this.statistics!.duplicateGroups.toString())
        this.StatItem('ÈáçÂ§çÊï∞', this.statistics!.duplicateContacts.toString())
        this.StatItem('ÂèØËäÇÁúÅ', this.statistics!.potentialSavings.toString())
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 16 })
    .shadow({ radius: 4, color: '#10000000', offsetY: 2 })
  }

  /**
   * ÁªüËÆ°È°π
   */
  @Builder
  StatItem(label: string, value: string) {
    Column() {
      Text(value)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#007DFF')

      Text(label)
        .fontSize(12)
        .fontColor('#666')
        .margin({ top: 4 })
    }
  }

  /**
   * Êâ´ÊèèÂå∫Âüü
   */
  @Builder
  ScanSection() {
    Column() {
      Row() {
        Button(this.scanState === ScanState.SCANNING ? 'Êâ´Êèè‰∏≠...' : 'ÂºÄÂßãÊâ´Êèè')
          .width('45%')
          .height(44)
          .fontSize(16)
          .backgroundColor('#007DFF')
          .enabled(this.scanState !== ScanState.SCANNING)
          .onClick(() => this.startScan())

        if (this.duplicateGroups.length > 0) {
          Button('‰∏ÄÈîÆÂêàÂπ∂ÂÖ®ÈÉ®')
            .width('45%')
            .height(44)
            .fontSize(16)
            .backgroundColor('#FF6D00')
            .onClick(() => {
              this.showBatchConfirm = true;
            })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)

      // Êâ´ÊèèËøõÂ∫¶
      if (this.scanState === ScanState.SCANNING) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('Ê≠£Âú®ÂàÜÊûêËÅîÁ≥ª‰∫∫...')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 8 })
        }
        .width('100%')
        .padding(20)
      }
    }
    .width('100%')
    .padding(16)
  }

  /**
   * ÈáçÂ§çÁªÑÂàóË°®
   */
  @Builder
  DuplicateGroupList() {
    Column() {
      Text(`ÂèëÁé∞ ${this.duplicateGroups.length} ÁªÑÈáçÂ§çËÅîÁ≥ª‰∫∫`)
        .fontSize(14)
        .fontColor('#666')
        .width('100%')
        .padding({ left: 16, bottom: 8 })

      List({ space: 12 }) {
        ForEach(this.duplicateGroups, (group: DuplicateGroupModel) => {
          ListItem() {
            this.DuplicateGroupCard(group)
          }
        }, (group: DuplicateGroupModel) => group.groupId)
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16, bottom: 80 })
    }
    .width('100%')
    .layoutWeight(1)
  }

  /**
   * ÈáçÂ§çÁªÑÂç°Áâá
   */
  @Builder
  DuplicateGroupCard(group: DuplicateGroupModel) {
    Column() {
      Row() {
        // ËÅîÁ≥ª‰∫∫Â§¥ÂÉèÂ†ÜÂè†
        Stack() {
          ForEach(group.contacts.slice(0, 3), (contactItem: contact.Contact, index: number) => {
            Text(contactItem.name?.fullName?.charAt(0) || '?')
              .fontSize(14)
              .fontColor(Color.White)
              .textAlign(TextAlign.Center)
              .width(36)
              .height(36)
              .borderRadius(18)
              .backgroundColor(this.getAvatarColor(index))
              .border({ width: 2, color: Color.White })
              .position({ x: index * 20, y: 0 })
          }, (item: contact.Contact, index: number) => item.key || index.toString())
        }
        .width(80)
        .height(40)

        Column() {
          // ÊòæÁ§∫ÁªÑÂÜÖËÅîÁ≥ª‰∫∫ÂêçÁß∞
          Text(this.getGroupDisplayName(group))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')

          Row() {
            Text(`${group.getContactCount()} ‰∏™ÈáçÂ§ç`)
              .fontSize(12)
              .fontColor('#666')

            Text(`Áõ∏‰ººÂ∫¶: ${(group.averageSimilarity * 100).toFixed(0)}%`)
              .fontSize(12)
              .fontColor('#007DFF')
              .margin({ left: 12 })
          }
          .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 12 })

        // Êü•ÁúãËØ¶ÊÉÖ
        Text('Êü•Áúã')
          .fontSize(14)
          .fontColor('#007DFF')
          .onClick(() => this.viewGroupDetail(group))
      }
      .width('100%')
      .padding(16)

      // Âø´Êç∑Êìç‰Ωú - È´òÂ∫¶Ë∞ÉÊï¥ÈÅøÂÖçËØØËß¶
      Row() {
        Button('ÂêàÂπ∂')
          .fontSize(12)
          .height(36)
          .layoutWeight(1)
          .backgroundColor('#007DFF')
          .onClick(() => {
            this.selectedGroup = group;
            this.mergePreview = this.duplicateService.getDetector().generateMergePreview(group);
            this.showMergeConfirm = true;
          })

        Button('ÂøΩÁï•')
          .fontSize(12)
          .height(36)
          .layoutWeight(1)
          .backgroundColor('#999')
          .margin({ left: 12 })
          .onClick(() => {
            this.selectedGroup = group;
            this.showIgnoreConfirm = true;
          })
      }
      .width('100%')
      .padding({
        left: 16,
        right: 16,
        bottom: 16,
        top: 8
      })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 2, color: '#10000000', offsetY: 1 })
  }

  /**
   * Ëé∑ÂèñÁªÑÊòæÁ§∫ÂêçÁß∞
   */
  getGroupDisplayName(group: DuplicateGroupModel): string {
    return group.contacts
      .map(c => c.name?.fullName || 'Êú™Áü•')
      .slice(0, 3)
      .join('„ÄÅ') + (group.contacts.length > 3 ? ' Á≠â' : '');
  }

  /**
   * Ëé∑ÂèñÂ§¥ÂÉèÈ¢úËâ≤
   */
  getAvatarColor(index: number): string {
    const colors = ['#007DFF', '#00C853', '#FF6D00', '#D500F9', '#FF1744'];
    return colors[index % colors.length];
  }

  /**
   * Á©∫Áä∂ÊÄÅËßÜÂõæ
   */
  @Builder
  IdleStateView() {
    Column() {
      Text('üîç')
        .fontSize(60)
        .margin({ bottom: 16 })

      Text('ÁÇπÂáª"ÂºÄÂßãÊâ´Êèè"Ê£ÄÊµãÈáçÂ§çËÅîÁ≥ª‰∫∫')
        .fontSize(16)
        .fontColor('#666')

      Text(`ÂΩìÂâçÂÖ±Êúâ ${this.allContacts.length} ‰∏™ËÅîÁ≥ª‰∫∫`)
        .fontSize(14)
        .fontColor('#999')
        .margin({ top: 8 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * ÈîôËØØÁä∂ÊÄÅËßÜÂõæ
   */
  @Builder
  ErrorStateView() {
    Column() {
      Text('‚ùå')
        .fontSize(60)
        .margin({ bottom: 16 })

      Text(this.errorMessage)
        .fontSize(16)
        .fontColor('#ff3b30')

      Button('ÈáçËØï')
        .margin({ top: 16 })
        .onClick(() => this.checkPermissionsAndLoad())
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * ËØ¶ÊÉÖËßÜÂõæ
   */
  @Builder
  DetailView() {
    if (!this.selectedGroup) {
      Text('ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÈáçÂ§çÁªÑ')
        .fontSize(16)
        .fontColor('#666')
    } else {
      Scroll() {
        Column() {
          // ÁªÑÂÜÖËÅîÁ≥ª‰∫∫ÂàóË°®
          Text('ÈáçÂ§çÁöÑËÅîÁ≥ª‰∫∫')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .padding({ left: 16, top: 16, bottom: 8 })

          ForEach(this.selectedGroup.contacts, (contactItem: contact.Contact) => {
            this.ContactDetailCard(contactItem,
              contactItem.key === this.selectedGroup?.primaryContact?.key)
          }, (item: contact.Contact) => item.key || '')

          // ÂêàÂπ∂È¢ÑËßà
          if (this.mergePreview) {
            this.MergePreviewSection()
          }

          // Êìç‰ΩúÊåâÈíÆ - Ê∑ªÂä†Â∫ïÈÉ®ËæπË∑ùÈÅøÂÖç‰∏éHomeÈîÆÈáçÂêà
          Row() {
            Button('ÂêàÂπ∂ËÅîÁ≥ª‰∫∫')
              .layoutWeight(1)
              .height(48)
              .backgroundColor('#007DFF')
              .onClick(() => {
                this.showMergeConfirm = true;
              })

            Button('ÂøΩÁï•Ê≠§ÁªÑ')
              .layoutWeight(1)
              .height(48)
              .backgroundColor('#999')
              .margin({ left: 16 })
              .onClick(() => {
                this.showIgnoreConfirm = true;
              })
          }
          .width('100%')
          .padding(16)
          .margin({ bottom: 80 })
        }
      }
      .layoutWeight(1)
    }
  }

  /**
   * ËÅîÁ≥ª‰∫∫ËØ¶ÊÉÖÂç°Áâá
   */
  @Builder
  ContactDetailCard(contactItem: contact.Contact, isPrimary: boolean) {
    Column() {
      Row() {
        // Â§¥ÂÉè
        Text(contactItem.name?.fullName?.charAt(0) || '?')
          .fontSize(18)
          .fontColor(Color.White)
          .textAlign(TextAlign.Center)
          .width(44)
          .height(44)
          .borderRadius(22)
          .backgroundColor(isPrimary ? '#007DFF' : '#999')

        Column() {
          Row() {
            Text(contactItem.name?.fullName || 'Êú™Áü•')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)

            if (isPrimary) {
              Text('Êé®Ëçê‰øùÁïô')
                .fontSize(10)
                .fontColor(Color.White)
                .backgroundColor('#00C853')
                .padding({
                  left: 6,
                  right: 6,
                  top: 2,
                  bottom: 2
                })
                .borderRadius(4)
                .margin({ left: 8 })
            }
          }

          if (contactItem.phoneNumbers && contactItem.phoneNumbers.length > 0) {
            Text(contactItem.phoneNumbers[0].phoneNumber || '')
              .fontSize(14)
              .fontColor('#666')
              .margin({ top: 4 })
          }

          if (contactItem.emails && contactItem.emails.length > 0) {
            Text(contactItem.emails[0].email || '')
              .fontSize(12)
              .fontColor('#999')
              .margin({ top: 2 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 12 })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16, bottom: 8 })
    .backgroundColor(Color.White)
    .borderRadius(8)
    .border({ width: isPrimary ? 2 : 0, color: '#007DFF' })
  }

  /**
   * ÂêàÂπ∂È¢ÑËßàÂå∫Âüü
   */
  @Builder
  MergePreviewSection() {
    Column() {
      Text('ÂêàÂπ∂ÂêéÁöÑËÅîÁ≥ª‰∫∫')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .width('100%')
        .margin({ bottom: 12 })

      // ÂêàÂπ∂ÂêéÁöÑ‰ø°ÊÅØ
      Column() {
        this.PreviewRow('ÂßìÂêç', this.mergePreview!.mergedContact.name?.fullName || '')

        ForEach(this.mergePreview!.mergedContact.phoneNumbers || [],
          (phone: contact.PhoneNumber) => {
            this.PreviewRow('ÁîµËØù', phone.phoneNumber || '')
          }, (phone: contact.PhoneNumber, index: number) => index.toString())

        ForEach(this.mergePreview!.mergedContact.emails || [],
          (email: contact.Email) => {
            this.PreviewRow('ÈÇÆÁÆ±', email.email || '')
          }, (email: contact.Email, index: number) => index.toString())
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#f8f8f8')
      .borderRadius(8)

      // Ë≠¶Âëä‰ø°ÊÅØ
      if (this.mergePreview!.warnings.length > 0) {
        Column() {
          ForEach(this.mergePreview!.warnings, (warning: string) => {
            Text(`‚ö†Ô∏è ${warning}`)
              .fontSize(12)
              .fontColor('#FF6D00')
              .width('100%')
              .margin({ top: 4 })
          }, (warning: string, index: number) => index.toString())
        }
        .margin({ top: 8 })
      }
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16, top: 8 })
    .backgroundColor(Color.White)
    .borderRadius(8)
  }

  /**
   * È¢ÑËßàË°å
   */
  @Builder
  PreviewRow(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor('#666')
        .width(60)

      Text(value)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 6, bottom: 6 })
  }

  /**
   * ËÆæÁΩÆËßÜÂõæ
   */
  @Builder
  SettingsView() {
    Scroll() {
      Column() {
        // È¢ÑËÆæÈÖçÁΩÆ
        Text('Âø´Êç∑ÈÖçÁΩÆ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .width('100%')
          .padding({ left: 16, top: 16, bottom: 8 })

        Row() {
          this.PresetButton('ÊôÆÈÄö', 'normal')
          this.PresetButton('‰∏•Ê†º', 'strict')
          this.PresetButton('ÂÆΩÊùæ', 'loose')
          this.PresetButton('‰ªÖÁîµËØù', 'phoneOnly')
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
        .padding({ left: 16, right: 16 })

        // Á≠ñÁï•Á±ªÂûã
        Column() {
          Text('Ê£ÄÊµãÁ≠ñÁï•')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .margin({ bottom: 12 })

          ForEach(Array.from(STRATEGY_TYPE_DESCRIPTIONS.entries()),
            (entry: [DuplicateStrategyType, string]) => {
              this.StrategyOption(entry[0], entry[1])
            }, (entry: [DuplicateStrategyType, string]) => entry[0])
        }
        .width('100%')
        .padding(16)
        .margin({ left: 16, right: 16, top: 16 })
        .backgroundColor(Color.White)
        .borderRadius(12)

        // ‰∏•Ê†ºÁ®ãÂ∫¶
        Column() {
          Text('Ê£ÄÊµã‰∏•Ê†ºÂ∫¶')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .margin({ bottom: 12 })

          ForEach(Array.from(STRICT_LEVEL_DESCRIPTIONS.entries()),
            (entry: [DuplicateStrictLevel, string]) => {
              this.StrictLevelOption(entry[0], entry[1])
            }, (entry: [DuplicateStrictLevel, string]) => entry[0])
        }
        .width('100%')
        .padding(16)
        .margin({ left: 16, right: 16, top: 16 })
        .backgroundColor(Color.White)
        .borderRadius(12)

        // Áõ∏‰ººÂ∫¶ÈòàÂÄº
        Column() {
          Text('Áõ∏‰ººÂ∫¶ÈòàÂÄº')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .margin({ bottom: 12 })

          this.ThresholdSlider('ÁªºÂêàÁõ∏‰ººÂ∫¶', this.currentConfig.overallSimThreshold,
            (value: number) => {
              this.currentConfig.overallSimThreshold = value;
            })

          this.ThresholdSlider('ÁîµËØùÁõ∏‰ººÂ∫¶', this.currentConfig.phoneSimThreshold,
            (value: number) => {
              this.currentConfig.phoneSimThreshold = value;
            })

          this.ThresholdSlider('ÂßìÂêçÁõ∏‰ººÂ∫¶', this.currentConfig.nameSimThreshold,
            (value: number) => {
              this.currentConfig.nameSimThreshold = value;
            })
        }
        .width('100%')
        .padding(16)
        .margin({
          left: 16,
          right: 16,
          top: 16,
          bottom: 16
        })
        .backgroundColor(Color.White)
        .borderRadius(12)
      }
    }
    .layoutWeight(1)
  }

  /**
   * È¢ÑËÆæÊåâÈíÆ
   */
  @Builder
  PresetButton(label: string, preset: 'strict' | 'normal' | 'loose' | 'phoneOnly') {
    Button(label)
      .fontSize(14)
      .height(36)
      .width(70)
      .backgroundColor('#007DFF')
      .onClick(() => this.applyPreset(preset))
  }

  /**
   * Á≠ñÁï•ÈÄâÈ°π
   */
  @Builder
  StrategyOption(type: DuplicateStrategyType, description: string) {
    Row() {
      Radio({ value: type, group: 'strategy' })
        .checked(this.selectedStrategyType === type)
        .onChange((isChecked: boolean) => {
          if (isChecked) {
            this.selectedStrategyType = type;
            this.currentConfig.strategyType = type;
          }
        })

      Text(description)
        .fontSize(14)
        .margin({ left: 8 })
        .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
  }

  /**
   * ‰∏•Ê†ºÁ®ãÂ∫¶ÈÄâÈ°π
   */
  @Builder
  StrictLevelOption(level: DuplicateStrictLevel, description: string) {
    Row() {
      Radio({ value: level, group: 'strictLevel' })
        .checked(this.selectedStrictLevel === level)
        .onChange((isChecked: boolean) => {
          if (isChecked) {
            this.selectedStrictLevel = level;
            this.currentConfig.strictLevel = level;
          }
        })

      Text(description)
        .fontSize(14)
        .margin({ left: 8 })
        .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
  }

  /**
   * ÈòàÂÄºÊªëÂùó
   */
  @Builder
  ThresholdSlider(label: string, value: number, onChange: (value: number) => void) {
    Column() {
      Row() {
        Text(label)
          .fontSize(14)

        Text(`${(value * 100).toFixed(0)}%`)
          .fontSize(14)
          .fontColor('#007DFF')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)

      Slider({
        value: value * 100,
        min: 0,
        max: 100,
        step: 5
      })
        .width('100%')
        .onChange((newValue: number) => {
          onChange(newValue / 100);
        })
    }
    .width('100%')
    .margin({ top: 12 })
  }

  /**
   * ÂêàÂπ∂Á°ÆËÆ§ÂºπÁ™ó
   */
  @Builder
  MergeConfirmDialog() {
    Column() {
      // ‰∏äÈÉ®Á©∫ÁôΩÂå∫ÂüüÔºåÁÇπÂáªÂèØÂÖ≥Èó≠
      Blank()
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('#000000')
        .opacity(0.5)
        .onClick(() => {
          this.showMergeConfirm = false;
        })

      // ÂºπÁ™óÂÜÖÂÆπ - Â∫ïÈÉ®Ë∑ùÁ¶ªÂ±èÂπïÂ∫ïÈÉ®100vp
      Column() {
        Text('Á°ÆËÆ§ÂêàÂπ∂')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 12 })

        Text(`Â∞ÜÂêàÂπ∂ ${this.selectedGroup?.getContactCount() || 0} ‰∏™ËÅîÁ≥ª‰∫∫‰∏∫‰∏Ä‰∏™`)
          .fontSize(14)
          .textAlign(TextAlign.Center)

        Text('Ê≠§Êìç‰Ωú‰ºöÂà†Èô§ÈáçÂ§çÁöÑËÅîÁ≥ª‰∫∫Ôºå‰øùÁïô‰ø°ÊÅØÊúÄÂÆåÊï¥ÁöÑÁâàÊú¨')
          .fontSize(12)
          .fontColor('#666')
          .textAlign(TextAlign.Center)
          .margin({ top: 8 })

        Row() {
          Button('ÂèñÊ∂à')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .onClick(() => {
              this.showMergeConfirm = false;
            })

          Button('Á°ÆËÆ§ÂêàÂπ∂')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#007DFF')
            .margin({ left: 12 })
            .onClick(() => this.mergeSelectedGroup())
        }
        .width('100%')
        .margin({ top: 20 })
      }
      .width('85%')
      .padding(24)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .margin({ bottom: 120 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.End)
    .alignItems(HorizontalAlign.Center)
    .position({ x: 0, y: 0 })
  }

  /**
   * ÂøΩÁï•Á°ÆËÆ§ÂºπÁ™ó
   */
  @Builder
  IgnoreConfirmDialog() {
    Column() {
      // ‰∏äÈÉ®Á©∫ÁôΩÂå∫ÂüüÔºåÁÇπÂáªÂèØÂÖ≥Èó≠
      Blank()
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('#000000')
        .opacity(0.5)
        .onClick(() => {
          this.showIgnoreConfirm = false;
        })

      // ÂºπÁ™óÂÜÖÂÆπ - Â∫ïÈÉ®Ë∑ùÁ¶ªÂ±èÂπïÂ∫ïÈÉ®120vp
      Column() {
        Text('Á°ÆËÆ§ÂøΩÁï•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 12 })

        Text('ÂøΩÁï•ÂêéÔºåËøôÁªÑËÅîÁ≥ª‰∫∫Â∞Ü‰∏çÂÜçÊòæÁ§∫‰∏∫ÈáçÂ§ç')
          .fontSize(14)
          .textAlign(TextAlign.Center)

        Row() {
          Button('ÂèñÊ∂à')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .onClick(() => {
              this.showIgnoreConfirm = false;
            })

          Button('Á°ÆËÆ§ÂøΩÁï•')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#999')
            .margin({ left: 12 })
            .onClick(() => this.ignoreSelectedGroup())
        }
        .width('100%')
        .margin({ top: 20 })
      }
      .width('85%')
      .padding(24)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .margin({ bottom: 120 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.End)
    .alignItems(HorizontalAlign.Center)
    .position({ x: 0, y: 0 })
  }

  /**
   * ÊâπÈáèÁ°ÆËÆ§ÂºπÁ™ó
   */
  @Builder
  BatchConfirmDialog() {
    Column() {
      // ‰∏äÈÉ®Á©∫ÁôΩÂå∫ÂüüÔºåÁÇπÂáªÂèØÂÖ≥Èó≠
      Blank()
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('#000000')
        .opacity(0.5)
        .onClick(() => {
          this.showBatchConfirm = false;
        })

      // ÂºπÁ™óÂÜÖÂÆπ - Â∫ïÈÉ®Ë∑ùÁ¶ªÂ±èÂπïÂ∫ïÈÉ®120vp
      Column() {
        Text('‚ö†Ô∏è ÊâπÈáèÂêàÂπ∂')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 12 })

        Text(`Âç≥Â∞ÜÂêàÂπ∂ ${this.duplicateGroups.length} ÁªÑÈáçÂ§çËÅîÁ≥ª‰∫∫`)
          .fontSize(14)
          .textAlign(TextAlign.Center)

        Text('Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºåÂª∫ËÆÆÂÖàÂ§á‰ªΩËÅîÁ≥ª‰∫∫')
          .fontSize(12)
          .fontColor('#ff3b30')
          .textAlign(TextAlign.Center)
          .margin({ top: 8 })

        Row() {
          Button('ÂèñÊ∂à')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .onClick(() => {
              this.showBatchConfirm = false;
            })

          Button('Á°ÆËÆ§ÂÖ®ÈÉ®ÂêàÂπ∂')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#FF6D00')
            .margin({ left: 12 })
            .onClick(() => this.batchMergeAll())
        }
        .width('100%')
        .margin({ top: 20 })
      }
      .width('85%')
      .padding(24)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .margin({ bottom: 120 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.End)
    .alignItems(HorizontalAlign.Center)
    .position({ x: 0, y: 0 })
  }

  /**
   * Âä†ËΩΩÈÅÆÁΩ©
   */
  @Builder
  LoadingOverlay() {
    Column() {
      LoadingProgress()
        .width(50)
        .height(50)

      Text(this.batchProcessing ? 'Ê≠£Âú®Â§ÑÁêÜ...' : 'Âä†ËΩΩ‰∏≠...')
        .fontSize(16)
        .fontColor(Color.White)
        .margin({ top: 12 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('rgba(0, 0, 0, 0.6)')
    .position({ x: 0, y: 0 })
  }
}
