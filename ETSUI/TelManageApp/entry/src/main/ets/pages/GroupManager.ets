/*
 * Copyright (c) 2026 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-20
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * è”ç³»äººåˆ†ç»„ç®¡ç†é¡µé¢
 * æä¾›åˆ†ç»„åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ã€è”ç³»äººåˆ†é…ç­‰å®Œæ•´åŠŸèƒ½
 */

import { contact } from '@kit.ContactsKit';
import { promptAction, router } from '@kit.ArkUI';
import { abilityAccessCtrl, Context } from '@kit.AbilityKit';
import { ContactData } from '../model/ContactData';
import {
  ContactGroupModel,
  GROUP_COLORS,
  GROUP_ICONS,
  GroupManager,
  GroupSortOrder,
  GroupStatistics,
  GroupType,
  SmartGroupGenerator
} from '../model/ContactGroup';

/**
 * è§†å›¾æ¨¡å¼æšä¸¾
 */
enum ViewMode {
  GROUP_LIST = 'GROUP_LIST', // åˆ†ç»„åˆ—è¡¨
  GROUP_DETAIL = 'GROUP_DETAIL', // åˆ†ç»„è¯¦æƒ…ï¼ˆæŸ¥çœ‹åˆ†ç»„å†…è”ç³»äººï¼‰
  GROUP_EDIT = 'GROUP_EDIT', // ç¼–è¾‘åˆ†ç»„
  GROUP_CREATE = 'GROUP_CREATE', // åˆ›å»ºåˆ†ç»„
  CONTACT_SELECT = 'CONTACT_SELECT', // é€‰æ‹©è”ç³»äºº
  SMART_GROUP = 'SMART_GROUP' // æ™ºèƒ½åˆ†ç»„
}

/**
 * æ™ºèƒ½åˆ†ç»„ç±»å‹
 */
enum SmartGroupType {
  BY_LAST_NAME = 'BY_LAST_NAME',
  BY_FIRST_LETTER = 'BY_FIRST_LETTER',
  BY_EMAIL_DOMAIN = 'BY_EMAIL_DOMAIN',
  BY_PHONE_AREA = 'BY_PHONE_AREA',
  BY_ORGANIZATION = 'BY_ORGANIZATION'
}

/**
 * æ’åºé€‰é¡¹æ•°æ®æ¥å£
 */
interface SortOptionItem {
  order: GroupSortOrder;
  label: string;
}

/**
 * æ™ºèƒ½åˆ†ç»„é€‰é¡¹æ•°æ®æ¥å£
 */
interface SmartGroupOptionItem {
  type: SmartGroupType;
  label: string;
  desc?: string;
}

@Entry
@Component
struct GroupManagerPage {
  // ä¸Šä¸‹æ–‡ä¸æ•°æ®å±‚
  @Provide('context') context: Context = getContext(this);
  private contactData: ContactData = new ContactData(this.context);
  private groupManager: GroupManager = new GroupManager();
  // é¢„å®šä¹‰çš„æ’åºé€‰é¡¹æ•°ç»„
  private sortOptions: SortOptionItem[] = [
    { order: GroupSortOrder.CUSTOM, label: 'é»˜è®¤' },
    { order: GroupSortOrder.NAME_ASC, label: 'åç§°' },
    { order: GroupSortOrder.COUNT_DESC, label: 'äººæ•°' }
  ];
  // æ™ºèƒ½åˆ†ç»„é€‰é¡¹æ•°ç»„
  private smartGroupOptions: SmartGroupOptionItem[] = [
    { type: SmartGroupType.BY_LAST_NAME, label: 'æŒ‰å§“æ°åˆ†ç»„', desc: 'å°†ç›¸åŒå§“æ°çš„è”ç³»äººåˆ†ä¸ºä¸€ç»„' },
    { type: SmartGroupType.BY_FIRST_LETTER, label: 'æŒ‰é¦–å­—æ¯åˆ†ç»„', desc: 'æŒ‰è”ç³»äººå§“åé¦–å­—æ¯åˆ†ç»„' },
    { type: SmartGroupType.BY_EMAIL_DOMAIN, label: 'æŒ‰é‚®ç®±åŸŸååˆ†ç»„', desc: 'ç›¸åŒé‚®ç®±åŸŸåçš„è”ç³»äººåˆ†ä¸ºä¸€ç»„' },
    { type: SmartGroupType.BY_PHONE_AREA, label: 'æŒ‰ç”µè¯åŒºå·åˆ†ç»„', desc: 'æŒ‰ç”µè¯å·ç å½’å±åœ°åˆ†ç»„' },
    { type: SmartGroupType.BY_ORGANIZATION, label: 'æŒ‰å…¬å¸/ç»„ç»‡åˆ†ç»„', desc: 'ç›¸åŒå…¬å¸çš„è”ç³»äººåˆ†ä¸ºä¸€ç»„' }
  ];
  // æ™ºèƒ½åˆ†ç»„å¯¹è¯æ¡†é€‰é¡¹æ•°ç»„
  private smartGroupDialogOptions: SmartGroupOptionItem[] = [
    { type: SmartGroupType.BY_LAST_NAME, label: 'æŒ‰å§“æ°' },
    { type: SmartGroupType.BY_FIRST_LETTER, label: 'æŒ‰é¦–å­—æ¯' },
    { type: SmartGroupType.BY_EMAIL_DOMAIN, label: 'æŒ‰é‚®ç®±åŸŸå' },
    { type: SmartGroupType.BY_PHONE_AREA, label: 'æŒ‰ç”µè¯åŒºå·' },
    { type: SmartGroupType.BY_ORGANIZATION, label: 'æŒ‰å…¬å¸' }
  ];
  // é¡µé¢çŠ¶æ€
  @State viewMode: ViewMode = ViewMode.GROUP_LIST;
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  // æ•°æ®çŠ¶æ€
  @State allContacts: contact.Contact[] = [];
  @State groups: ContactGroupModel[] = [];
  @State selectedGroup: ContactGroupModel | null = null;
  @State groupContacts: contact.Contact[] = [];
  @State statistics: GroupStatistics | null = null;
  // åˆ›å»º/ç¼–è¾‘åˆ†ç»„çŠ¶æ€
  @State editingGroupName: string = '';
  @State editingGroupDescription: string = '';
  @State editingGroupColor: string = GROUP_COLORS[0];
  @State editingGroupIcon: string = GROUP_ICONS[0];
  @State isEditMode: boolean = false;
  // è”ç³»äººé€‰æ‹©çŠ¶æ€
  @State selectedContactKeys: Set<string> = new Set();
  @State searchText: string = '';
  @State filteredContacts: contact.Contact[] = [];
  // æ’åºçŠ¶æ€
  @State currentSortOrder: GroupSortOrder = GroupSortOrder.CUSTOM;
  // å¼¹çª—çŠ¶æ€
  @State showDeleteConfirm: boolean = false;
  @State showSmartGroupDialog: boolean = false;
  @State selectedSmartGroupType: SmartGroupType = SmartGroupType.BY_LAST_NAME;
  @State showSaveConfirm: boolean = false;
  @State showCompleteConfirm: boolean = false;
  @State isGroupManagerInitialized: boolean = false;

  aboutToAppear() {
    console.log('GroupManagerPage: é¡µé¢å³å°†æ˜¾ç¤º');
    this.checkPermissionsAndLoad();
  }

  /**
   * æ£€æŸ¥æƒé™å¹¶åŠ è½½æ•°æ®
   */
  async checkPermissionsAndLoad() {
    const atManager = abilityAccessCtrl.createAtManager();
    try {
      const result = await atManager.requestPermissionsFromUser(this.context, [
        'ohos.permission.READ_CONTACTS',
        'ohos.permission.WRITE_CONTACTS'
      ]);

      if (result.authResults[0] === 0) {
        await this.loadContacts();
        await this.initializeGroupManager();
        this.loadGroups();
      } else {
        this.errorMessage = 'éœ€è¦é€šè®¯å½•æƒé™';
      }
    } catch (err) {
      console.error('GroupManagerPage: æƒé™è¯·æ±‚å¤±è´¥', err);
    }
  }

  /**
   * åˆå§‹åŒ–åˆ†ç»„ç®¡ç†å™¨ï¼ˆä»å­˜å‚¨åŠ è½½æ•°æ®ï¼‰
   */
  async initializeGroupManager() {
    if (!this.isGroupManagerInitialized) {
      this.isLoading = true;
      try {
        await this.groupManager.initialize(this.context);
        this.isGroupManagerInitialized = true;
        console.log('GroupManagerPage: åˆ†ç»„ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
      } catch (error) {
        console.error('GroupManagerPage: åˆ†ç»„ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥', error);
      } finally {
        this.isLoading = false;
      }
    }
  }

  /**
   * ä¿å­˜åˆ†ç»„æ•°æ®åˆ°å­˜å‚¨
   */
  async saveGroupData() {
    try {
      await this.groupManager.saveToStorage();
    } catch (error) {
      console.error('GroupManagerPage: ä¿å­˜åˆ†ç»„æ•°æ®å¤±è´¥', error);
    }
  }

  /**
   * åŠ è½½è”ç³»äºº
   */
  async loadContacts() {
    this.isLoading = true;
    try {
      this.allContacts = await this.contactData.queryAllContacts();
      this.filteredContacts = this.allContacts.slice();
      console.log(`GroupManagerPage: å·²åŠ è½½ ${this.allContacts.length} ä¸ªè”ç³»äºº`);
    } catch (error) {
      console.error('GroupManagerPage: åŠ è½½è”ç³»äººå¤±è´¥', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½åˆ†ç»„
   */
  loadGroups() {
    this.groups = this.groupManager.getAllGroups(this.currentSortOrder);
    this.statistics = this.groupManager.getStatistics(
      this.allContacts.map(c => c.key || '')
    );
  }

  /**
   * æŸ¥çœ‹åˆ†ç»„è¯¦æƒ…
   */
  viewGroupDetail(group: ContactGroupModel) {
    this.selectedGroup = group;
    this.loadGroupContacts();
    this.viewMode = ViewMode.GROUP_DETAIL;
  }

  /**
   * åŠ è½½åˆ†ç»„å†…çš„è”ç³»äºº
   */
  loadGroupContacts() {
    if (!this.selectedGroup) {
      return;
    }

    this.groupContacts = this.allContacts.filter(c =>
    c.key && this.selectedGroup!.hasContact(c.key)
    );
  }

  /**
   * åˆ›å»ºæ–°åˆ†ç»„
   */
  async createGroup() {
    if (!this.editingGroupName.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥åˆ†ç»„åç§°' });
      return;
    }

    const result = this.groupManager.createGroup(this.editingGroupName.trim());

    if (result.success && result.affectedGroupId) {
      const group = this.groupManager.getGroup(result.affectedGroupId);
      if (group) {
        group.description = this.editingGroupDescription;
        group.color = this.editingGroupColor;
        group.icon = this.editingGroupIcon;
      }

      await this.saveGroupData();
      promptAction.showToast({ message: 'åˆ†ç»„åˆ›å»ºæˆåŠŸ' });
      this.loadGroups();
      this.resetEditingState();
      this.viewMode = ViewMode.GROUP_LIST;
    } else {
      promptAction.showToast({ message: result.message });
    }
  }

  /**
   * æ›´æ–°åˆ†ç»„
   */
  async updateGroup() {
    if (!this.selectedGroup) {
      return;
    }

    if (!this.editingGroupName.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥åˆ†ç»„åç§°' });
      return;
    }

    const result = this.groupManager.updateGroup(this.selectedGroup.groupId, {
      name: this.editingGroupName.trim(),
      description: this.editingGroupDescription,
      color: this.editingGroupColor,
      icon: this.editingGroupIcon
    });

    if (result.success) {
      await this.saveGroupData();
      promptAction.showToast({ message: 'åˆ†ç»„å·²æ›´æ–°' });
      this.loadGroups();
      this.resetEditingState();
      this.viewMode = ViewMode.GROUP_LIST;
    } else {
      promptAction.showToast({ message: result.message });
    }
  }

  /**
   * åˆ é™¤åˆ†ç»„
   */
  async deleteGroup() {
    if (!this.selectedGroup) {
      return;
    }

    const result = this.groupManager.deleteGroup(this.selectedGroup.groupId);

    if (result.success) {
      await this.saveGroupData();
      promptAction.showToast({ message: 'åˆ†ç»„å·²åˆ é™¤' });
      this.loadGroups();
      this.selectedGroup = null;
      this.showDeleteConfirm = false;
      this.viewMode = ViewMode.GROUP_LIST;
    } else {
      promptAction.showToast({ message: result.message });
    }
  }

  /**
   * è¿›å…¥ç¼–è¾‘æ¨¡å¼
   */
  enterEditMode(group: ContactGroupModel) {
    this.selectedGroup = group;
    this.editingGroupName = group.name;
    this.editingGroupDescription = group.description;
    this.editingGroupColor = group.color;
    this.editingGroupIcon = group.icon;
    this.isEditMode = true;
    this.viewMode = ViewMode.GROUP_EDIT;
  }

  /**
   * è¿›å…¥åˆ›å»ºæ¨¡å¼
   */
  enterCreateMode() {
    this.resetEditingState();
    this.isEditMode = false;
    this.viewMode = ViewMode.GROUP_CREATE;
  }

  /**
   * é‡ç½®ç¼–è¾‘çŠ¶æ€
   */
  resetEditingState() {
    this.editingGroupName = '';
    this.editingGroupDescription = '';
    this.editingGroupColor = GROUP_COLORS[0];
    this.editingGroupIcon = GROUP_ICONS[0];
    this.isEditMode = false;
  }

  /**
   * è¿›å…¥è”ç³»äººé€‰æ‹©æ¨¡å¼
   */
  enterContactSelectMode() {
    if (!this.selectedGroup) {
      return;
    }

    // åˆå§‹åŒ–å·²é€‰ä¸­çš„è”ç³»äºº
    this.selectedContactKeys = new Set(this.selectedGroup.contactKeys);
    this.searchText = '';
    this.filteredContacts = this.allContacts.slice();
    this.viewMode = ViewMode.CONTACT_SELECT;
  }

  /**
   * åˆ‡æ¢è”ç³»äººé€‰ä¸­çŠ¶æ€
   */
  toggleContactSelection(contactKey: string) {
    if (this.selectedContactKeys.has(contactKey)) {
      this.selectedContactKeys.delete(contactKey);
    } else {
      this.selectedContactKeys.add(contactKey);
    }
    // è§¦å‘UIæ›´æ–°
    this.selectedContactKeys = new Set(this.selectedContactKeys);
  }

  /**
   * ä¿å­˜è”ç³»äººé€‰æ‹©
   */
  async saveContactSelection() {
    if (!this.selectedGroup) {
      return;
    }

    // è®¡ç®—æ·»åŠ å’Œç§»é™¤çš„è”ç³»äºº
    const currentKeys = new Set(this.selectedGroup.contactKeys);
    const newKeys = this.selectedContactKeys;

    // ç§»é™¤ä¸å†é€‰ä¸­çš„
    currentKeys.forEach(key => {
      if (!newKeys.has(key)) {
        this.groupManager.removeContactFromGroup(this.selectedGroup!.groupId, key);
      }
    });

    // æ·»åŠ æ–°é€‰ä¸­çš„
    newKeys.forEach(key => {
      if (!currentKeys.has(key)) {
        this.groupManager.addContactToGroup(this.selectedGroup!.groupId, key);
      }
    });

    await this.saveGroupData();
    promptAction.showToast({ message: 'è”ç³»äººå·²æ›´æ–°' });
    this.loadGroups();
    this.loadGroupContacts();
    this.viewMode = ViewMode.GROUP_DETAIL;
  }

  /**
   * æœç´¢è”ç³»äºº
   */
  searchContacts() {
    if (!this.searchText.trim()) {
      this.filteredContacts = this.allContacts.slice();
      return;
    }

    const keyword = this.searchText.toLowerCase();
    this.filteredContacts = this.allContacts.filter(c => {
      const name = c.name?.fullName?.toLowerCase() || '';
      const phone = c.phoneNumbers?.[0]?.phoneNumber || '';
      return name.includes(keyword) || phone.includes(keyword);
    });
  }

  /**
   * ç”Ÿæˆæ™ºèƒ½åˆ†ç»„
   */
  async generateSmartGroups() {
    let groupsMap: Map<string, string[]>;

    switch (this.selectedSmartGroupType) {
      case SmartGroupType.BY_LAST_NAME:
        groupsMap = SmartGroupGenerator.groupByLastName(this.allContacts);
        break;
      case SmartGroupType.BY_FIRST_LETTER:
        groupsMap = SmartGroupGenerator.groupByFirstLetter(this.allContacts);
        break;
      case SmartGroupType.BY_EMAIL_DOMAIN:
        groupsMap = SmartGroupGenerator.groupByEmailDomain(this.allContacts);
        break;
      case SmartGroupType.BY_PHONE_AREA:
        groupsMap = SmartGroupGenerator.groupByPhoneAreaCode(this.allContacts);
        break;
      case SmartGroupType.BY_ORGANIZATION:
        groupsMap = SmartGroupGenerator.groupByOrganization(this.allContacts);
        break;
      default:
        groupsMap = new Map();
    }

    // åˆ›å»ºåˆ†ç»„
    let createdCount = 0;
    groupsMap.forEach((contactKeys, groupName) => {
      if (contactKeys.length > 0) {
        const result = this.groupManager.createGroup(`${groupName}`, GroupType.SMART);
        if (result.success && result.affectedGroupId) {
          this.groupManager.addContactsToGroup(result.affectedGroupId, contactKeys);
          createdCount++;
        }
      }
    });

    await this.saveGroupData();
    promptAction.showToast({ message: `å·²åˆ›å»º ${createdCount} ä¸ªæ™ºèƒ½åˆ†ç»„` });
    this.loadGroups();
    this.showSmartGroupDialog = false;
    this.viewMode = ViewMode.GROUP_LIST;
  }

  /**
   * ä»åˆ†ç»„ç§»é™¤è”ç³»äºº
   */
  async removeContactFromGroup(contactKey: string) {
    if (!this.selectedGroup) {
      return;
    }

    const result = this.groupManager.removeContactFromGroup(
      this.selectedGroup.groupId,
      contactKey
    );

    if (result.success) {
      await this.saveGroupData();
      promptAction.showToast({ message: 'å·²ä»åˆ†ç»„ç§»é™¤' });
      this.loadGroups();
      this.loadGroupContacts();
    }
  }

  build() {
    Stack() {
      Column() {
        // æ ‡é¢˜æ 
        this.TitleBar()

        // æ ¹æ®è§†å›¾æ¨¡å¼æ˜¾ç¤ºä¸åŒå†…å®¹
        if (this.viewMode === ViewMode.GROUP_LIST) {
          this.GroupListView()
        } else if (this.viewMode === ViewMode.GROUP_DETAIL) {
          this.GroupDetailView()
        } else if (this.viewMode === ViewMode.GROUP_EDIT ||
          this.viewMode === ViewMode.GROUP_CREATE) {
          this.GroupEditView()
        } else if (this.viewMode === ViewMode.CONTACT_SELECT) {
          this.ContactSelectView()
        } else if (this.viewMode === ViewMode.SMART_GROUP) {
          this.SmartGroupView()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f5f5f5')

      // åˆ é™¤ç¡®è®¤å¼¹çª—
      if (this.showDeleteConfirm) {
        this.DeleteConfirmDialog()
      }

      // æ™ºèƒ½åˆ†ç»„å¼¹çª—
      if (this.showSmartGroupDialog) {
        this.SmartGroupDialog()
      }

      // åŠ è½½é®ç½©
      if (this.isLoading) {
        this.LoadingOverlay()
      }

      // ä¿å­˜ç¡®è®¤å¼¹çª—
      if (this.showSaveConfirm) {
        this.SaveConfirmDialog()
      }

      // å®Œæˆç¡®è®¤å¼¹çª—
      if (this.showCompleteConfirm) {
        this.CompleteConfirmDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ ‡é¢˜æ 
   */
  @Builder
  TitleBar() {
    Row() {
      // è¿”å›æŒ‰é’®
      Button(this.viewMode === ViewMode.GROUP_LIST ? 'è¿”å›' : 'å–æ¶ˆ')
        .fontSize(16)
        .backgroundColor(Color.Transparent)
        .fontColor('#007DFF')
        .onClick(() => {
          if (this.viewMode === ViewMode.GROUP_LIST) {
            router.back();
          } else if (this.viewMode === ViewMode.GROUP_DETAIL) {
            this.viewMode = ViewMode.GROUP_LIST;
            this.selectedGroup = null;
          } else {
            this.viewMode = this.selectedGroup ? ViewMode.GROUP_DETAIL : ViewMode.GROUP_LIST;
          }
        })

      Text(this.getTitleText())
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .textAlign(TextAlign.Center)
        .layoutWeight(1)

      // å³ä¾§æŒ‰é’®
      if (this.viewMode === ViewMode.GROUP_LIST) {
        Button('æ–°å»º')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => this.enterCreateMode())
      } else if (this.viewMode === ViewMode.GROUP_DETAIL) {
        Button('ç¼–è¾‘')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => this.enterEditMode(this.selectedGroup!))
      } else if (this.viewMode === ViewMode.GROUP_EDIT ||
        this.viewMode === ViewMode.GROUP_CREATE) {
        Button('ä¿å­˜')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => {
            this.showSaveConfirm = true;
          })
      } else if (this.viewMode === ViewMode.CONTACT_SELECT) {
        Button('å®Œæˆ')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#007DFF')
          .onClick(() => {
            this.showCompleteConfirm = true;
          })
      } else {
        Text('').width(60)
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#f0f0f0')
  }

  /**
   * è·å–æ ‡é¢˜æ–‡æœ¬
   */
  getTitleText(): string {
    switch (this.viewMode) {
      case ViewMode.GROUP_DETAIL:
        return this.selectedGroup?.name || 'åˆ†ç»„è¯¦æƒ…';
      case ViewMode.GROUP_EDIT:
        return 'ç¼–è¾‘åˆ†ç»„';
      case ViewMode.GROUP_CREATE:
        return 'æ–°å»ºåˆ†ç»„';
      case ViewMode.CONTACT_SELECT:
        return 'é€‰æ‹©è”ç³»äºº';
      case ViewMode.SMART_GROUP:
        return 'æ™ºèƒ½åˆ†ç»„';
      default:
        return 'åˆ†ç»„ç®¡ç†';
    }
  }

  /**
   * åˆ†ç»„åˆ—è¡¨è§†å›¾
   */
  @Builder
  GroupListView() {
    Column() {
      // ç»Ÿè®¡ä¿¡æ¯
      if (this.statistics) {
        this.StatisticsCard()
      }

      // æ™ºèƒ½åˆ†ç»„å…¥å£
      this.SmartGroupEntry()

      // æ’åºé€‰é¡¹
      this.SortOptions()

      // åˆ†ç»„åˆ—è¡¨
      if (this.groups.length === 0) {
        this.EmptyGroupView()
      } else {
        List({ space: 10 }) {
          ForEach(this.groups, (group: ContactGroupModel) => {
            ListItem() {
              this.GroupCard(group)
            }
          }, (group: ContactGroupModel) => group.groupId)
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, bottom: 16 })
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  /**
   * ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡
   */
  @Builder
  StatisticsCard() {
    Column() {
      Row() {
        this.StatItem('åˆ†ç»„æ•°', this.statistics!.totalGroups.toString())
        this.StatItem('å·²åˆ†ç»„', this.statistics!.totalContactsInGroups.toString())
        this.StatItem('æœªåˆ†ç»„', this.statistics!.ungroupedContacts.toString())
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 16 })
    .shadow({ radius: 4, color: '#10000000', offsetY: 2 })
  }

  /**
   * ç»Ÿè®¡é¡¹
   */
  @Builder
  StatItem(label: string, value: string) {
    Column() {
      Text(value)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#007DFF')

      Text(label)
        .fontSize(12)
        .fontColor('#666')
        .margin({ top: 4 })
    }
  }

  /**
   * æ™ºèƒ½åˆ†ç»„å…¥å£
   */
  @Builder
  SmartGroupEntry() {
    Row() {
      Text('âœ¨')
        .fontSize(20)

      Text('æ™ºèƒ½åˆ†ç»„')
        .fontSize(15)
        .margin({ left: 8 })

      Text('è‡ªåŠ¨æŒ‰è§„åˆ™åˆ†ç»„è”ç³»äºº')
        .fontSize(12)
        .fontColor('#666')
        .margin({ left: 8 })
        .layoutWeight(1)

      Text('>')
        .fontSize(16)
        .fontColor('#999')
    }
    .width('100%')
    .height(50)
    .padding({ left: 16, right: 16 })
    .margin({ left: 16, right: 16, top: 12 })
    .backgroundColor(Color.White)
    .borderRadius(10)
    .onClick(() => {
      this.showSmartGroupDialog = true;
    })
  }

  /**
   * æ’åºé€‰é¡¹
   */
  @Builder
  SortOptions() {
    Row() {
      Text('æ’åº:')
        .fontSize(12)
        .fontColor('#666')

      ForEach(this.sortOptions, (item: SortOptionItem) => {
        Text(item.label)
          .fontSize(12)
          .fontColor(this.currentSortOrder === item.order ? '#007DFF' : '#999')
          .padding({ left: 12, right: 12 })
          .onClick(() => {
            this.currentSortOrder = item.order;
            this.loadGroups();
          })
      }, (item: SortOptionItem) => item.order)
    }
    .width('100%')
    .padding({
      left: 16,
      right: 16,
      top: 12,
      bottom: 8
    })
  }

  /**
   * åˆ†ç»„å¡ç‰‡
   */
  @Builder
  GroupCard(group: ContactGroupModel) {
    Row() {
      // åˆ†ç»„å›¾æ ‡
      Text(this.getGroupIcon(group.icon))
        .fontSize(24)
        .width(44)
        .height(44)
        .textAlign(TextAlign.Center)
        .borderRadius(22)
        .backgroundColor(group.color + '20')

      Column() {
        Row() {
          Text(group.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)

          if (group.isDefault) {
            Text('é»˜è®¤')
              .fontSize(10)
              .fontColor('#666')
              .padding({
                left: 6,
                right: 6,
                top: 2,
                bottom: 2
              })
              .backgroundColor('#f0f0f0')
              .borderRadius(4)
              .margin({ left: 8 })
          }

          if (group.type === GroupType.SMART) {
            Text('æ™ºèƒ½')
              .fontSize(10)
              .fontColor('#007DFF')
              .padding({
                left: 6,
                right: 6,
                top: 2,
                bottom: 2
              })
              .backgroundColor('#007DFF20')
              .borderRadius(4)
              .margin({ left: 8 })
          }
        }

        Text(`${group.getContactCount()} ä½è”ç³»äºº`)
          .fontSize(12)
          .fontColor('#666')
          .margin({ top: 4 })

        if (group.description) {
          Text(group.description)
            .fontSize(11)
            .fontColor('#999')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 2 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: 12 })

      Text('>')
        .fontSize(18)
        .fontColor('#ccc')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 2, color: '#10000000', offsetY: 1 })
    .onClick(() => this.viewGroupDetail(group))
  }

  /**
   * è·å–åˆ†ç»„å›¾æ ‡
   */
  getGroupIcon(iconName: string): string {
    const iconMap: Record<string, string> = {
      'people': 'ğŸ‘¥',
      'star': 'â­',
      'work': 'ğŸ’¼',
      'home': 'ğŸ ',
      'school': 'ğŸ“',
      'favorite': 'â¤ï¸',
      'phone': 'ğŸ“',
      'mail': 'ğŸ“§',
      'location': 'ğŸ“',
      'event': 'ğŸ“…',
      'business': 'ğŸ¢',
      'groups': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦'
    };
    return iconMap[iconName] || 'ğŸ“';
  }

  /**
   * ç©ºåˆ†ç»„è§†å›¾
   */
  @Builder
  EmptyGroupView() {
    Column() {
      Text('ğŸ“‚')
        .fontSize(60)
        .margin({ bottom: 16 })

      Text('æš‚æ— åˆ†ç»„')
        .fontSize(18)
        .fontColor('#666')

      Text('ç‚¹å‡»å³ä¸Šè§’"æ–°å»º"åˆ›å»ºåˆ†ç»„')
        .fontSize(14)
        .fontColor('#999')
        .margin({ top: 8 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * åˆ†ç»„è¯¦æƒ…è§†å›¾
   */
  @Builder
  GroupDetailView() {
    if (this.selectedGroup) {
      Column() {
        // åˆ†ç»„ä¿¡æ¯å¤´éƒ¨
        Column() {
          Row() {
            Text(this.getGroupIcon(this.selectedGroup.icon))
              .fontSize(40)
              .width(60)
              .height(60)
              .textAlign(TextAlign.Center)
              .borderRadius(30)
              .backgroundColor(this.selectedGroup.color + '30')

            Column() {
              Text(this.selectedGroup.name)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)

              Text(`${this.selectedGroup.getContactCount()} ä½è”ç³»äºº`)
                .fontSize(14)
                .fontColor('#666')
                .margin({ top: 4 })

              if (this.selectedGroup.description) {
                Text(this.selectedGroup.description)
                  .fontSize(12)
                  .fontColor('#999')
                  .margin({ top: 4 })
              }
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 16 })
            .layoutWeight(1)
          }
          .width('100%')

          // æ“ä½œæŒ‰é’®
          Row() {
            Button('æ·»åŠ æˆå‘˜')
              .layoutWeight(1)
              .height(40)
              .backgroundColor('#007DFF')
              .onClick(() => this.enterContactSelectMode())

            if (!this.selectedGroup.isDefault) {
              Button('åˆ é™¤åˆ†ç»„')
                .layoutWeight(1)
                .height(40)
                .backgroundColor('#ff3b30')
                .margin({ left: 12 })
                .onClick(() => {
                  this.showDeleteConfirm = true;
                })
            }
          }
          .width('100%')
          .margin({ top: 16 })
        }
        .width('100%')
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ left: 16, right: 16, top: 16 })

        // æˆå‘˜åˆ—è¡¨
        Text('åˆ†ç»„æˆå‘˜')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .width('100%')
          .padding({ left: 16, top: 16, bottom: 8 })

        if (this.groupContacts.length === 0) {
          Column() {
            Text('æš‚æ— æˆå‘˜')
              .fontSize(14)
              .fontColor('#999')

            Text('ç‚¹å‡»"æ·»åŠ æˆå‘˜"å°†è”ç³»äººåŠ å…¥åˆ†ç»„')
              .fontSize(12)
              .fontColor('#ccc')
              .margin({ top: 4 })
          }
          .width('100%')
          .padding(40)
        } else {
          List({ space: 8 }) {
            ForEach(this.groupContacts, (contactItem: contact.Contact) => {
              ListItem() {
                this.ContactInGroupCard(contactItem)
              }
            }, (item: contact.Contact) => item.key || '')
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 16, right: 16 })
        }
      }
      .width('100%')
      .layoutWeight(1)
    }
  }

  /**
   * åˆ†ç»„ä¸­çš„è”ç³»äººå¡ç‰‡
   */
  @Builder
  ContactInGroupCard(contactItem: contact.Contact) {
    Row() {
      // å¤´åƒ
      Text(contactItem.name?.fullName?.charAt(0) || '?')
        .fontSize(16)
        .fontColor(Color.White)
        .textAlign(TextAlign.Center)
        .width(40)
        .height(40)
        .borderRadius(20)
        .backgroundColor('#007DFF')

      Column() {
        Text(contactItem.name?.fullName || 'æœªçŸ¥')
          .fontSize(15)
          .fontWeight(FontWeight.Medium)

        if (contactItem.phoneNumbers && contactItem.phoneNumbers.length > 0) {
          Text(contactItem.phoneNumbers[0].phoneNumber || '')
            .fontSize(12)
            .fontColor('#666')
            .margin({ top: 2 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: 12 })

      // ç§»é™¤æŒ‰é’®
      Button('ç§»é™¤')
        .fontSize(12)
        .height(28)
        .backgroundColor('#ff3b30')
        .onClick(() => {
          if (contactItem.key) {
            this.removeContactFromGroup(contactItem.key);
          }
        })
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
  }

  /**
   * åˆ†ç»„ç¼–è¾‘è§†å›¾
   */
  @Builder
  GroupEditView() {
    Scroll() {
      Column() {
        // åˆ†ç»„åç§°
        Column() {
          Text('åˆ†ç»„åç§°')
            .fontSize(14)
            .fontColor('#666')
            .width('100%')
            .margin({ bottom: 8 })

          TextInput({
            text: this.editingGroupName,
            placeholder: 'è¯·è¾“å…¥åˆ†ç»„åç§°'
          })
            .width('100%')
            .height(48)
            .fontSize(16)
            .backgroundColor('#f8f8f8')
            .borderRadius(8)
            .onChange((value: string) => {
              this.editingGroupName = value;
            })
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ top: 16 })

        // åˆ†ç»„æè¿°
        Column() {
          Text('åˆ†ç»„æè¿°ï¼ˆå¯é€‰ï¼‰')
            .fontSize(14)
            .fontColor('#666')
            .width('100%')
            .margin({ bottom: 8 })

          TextArea({
            text: this.editingGroupDescription,
            placeholder: 'è¯·è¾“å…¥åˆ†ç»„æè¿°'
          })
            .width('100%')
            .height(80)
            .fontSize(14)
            .backgroundColor('#f8f8f8')
            .borderRadius(8)
            .onChange((value: string) => {
              this.editingGroupDescription = value;
            })
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ top: 12 })

        // åˆ†ç»„é¢œè‰²
        Column() {
          Text('åˆ†ç»„é¢œè‰²')
            .fontSize(14)
            .fontColor('#666')
            .width('100%')
            .margin({ bottom: 12 })

          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(GROUP_COLORS, (color: string) => {
              Stack() {
                Circle()
                  .width(36)
                  .height(36)
                  .fill(color)

                if (this.editingGroupColor === color) {
                  Text('âœ“')
                    .fontSize(18)
                    .fontColor(Color.White)
                }
              }
              .width(44)
              .height(44)
              .margin(4)
              .onClick(() => {
                this.editingGroupColor = color;
              })
            }, (color: string) => color)
          }
          .width('100%')
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ top: 12 })

        // åˆ†ç»„å›¾æ ‡
        Column() {
          Text('åˆ†ç»„å›¾æ ‡')
            .fontSize(14)
            .fontColor('#666')
            .width('100%')
            .margin({ bottom: 12 })

          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(GROUP_ICONS, (icon: string) => {
              Text(this.getGroupIcon(icon))
                .fontSize(24)
                .textAlign(TextAlign.Center)
                .width(44)
                .height(44)
                .borderRadius(8)
                .margin(4)
                .backgroundColor(this.editingGroupIcon === icon ? '#007DFF20' : '#f5f5f5')
                .border({
                  width: this.editingGroupIcon === icon ? 2 : 0,
                  color: '#007DFF'
                })
                .onClick(() => {
                  this.editingGroupIcon = icon;
                })
            }, (icon: string) => icon)
          }
          .width('100%')
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ top: 12, bottom: 16 })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .layoutWeight(1)
  }

  /**
   * è”ç³»äººé€‰æ‹©è§†å›¾
   */
  @Builder
  ContactSelectView() {
    Column() {
      // æœç´¢æ¡†
      TextInput({ placeholder: 'æœç´¢è”ç³»äºº' })
        .width('100%')
        .height(40)
        .margin({ left: 16, right: 16, top: 12 })
        .onChange((value: string) => {
          this.searchText = value;
          this.searchContacts();
        })

      // å·²é€‰æ•°é‡
      Text(`å·²é€‰æ‹© ${this.selectedContactKeys.size} ä½è”ç³»äºº`)
        .fontSize(14)
        .fontColor('#666')
        .width('100%')
        .padding({ left: 16, top: 12, bottom: 8 })

      // è”ç³»äººåˆ—è¡¨
      List({ space: 6 }) {
        ForEach(this.filteredContacts, (contactItem: contact.Contact) => {
          ListItem() {
            this.SelectableContactCard(contactItem)
          }
        }, (item: contact.Contact) => item.key || '')
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
    .layoutWeight(1)
  }

  /**
   * å¯é€‰è”ç³»äººå¡ç‰‡
   */
  @Builder
  SelectableContactCard(contactItem: contact.Contact) {
    Row() {
      // å¤é€‰æ¡†
      Checkbox()
        .select(this.selectedContactKeys.has(contactItem.key || ''))
        .onChange((isSelected: boolean) => {
          if (contactItem.key) {
            this.toggleContactSelection(contactItem.key);
          }
        })

      // å¤´åƒ
      Text(contactItem.name?.fullName?.charAt(0) || '?')
        .fontSize(14)
        .fontColor(Color.White)
        .textAlign(TextAlign.Center)
        .width(36)
        .height(36)
        .borderRadius(18)
        .backgroundColor('#007DFF')
        .margin({ left: 12 })

      Column() {
        Text(contactItem.name?.fullName || 'æœªçŸ¥')
          .fontSize(15)

        if (contactItem.phoneNumbers && contactItem.phoneNumbers.length > 0) {
          Text(contactItem.phoneNumbers[0].phoneNumber || '')
            .fontSize(12)
            .fontColor('#666')
            .margin({ top: 2 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: 10 })
    }
    .width('100%')
    .padding(10)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .onClick(() => {
      if (contactItem.key) {
        this.toggleContactSelection(contactItem.key);
      }
    })
  }

  /**
   * æ™ºèƒ½åˆ†ç»„è§†å›¾
   */
  @Builder
  SmartGroupView() {
    Column() {
      Text('é€‰æ‹©åˆ†ç»„è§„åˆ™')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .width('100%')
        .padding({ left: 16, top: 16, bottom: 12 })

      ForEach(this.smartGroupOptions, (item: SmartGroupOptionItem) => {
        this.SmartGroupOption(item.type, item.label, item.desc || '')
      }, (item: SmartGroupOptionItem) => item.type)

      Blank()

      Button('ç”Ÿæˆæ™ºèƒ½åˆ†ç»„')
        .width('90%')
        .height(48)
        .backgroundColor('#007DFF')
        .margin({ bottom: 20 })
        .onClick(() => this.generateSmartGroups())
    }
    .width('100%')
    .layoutWeight(1)
  }

  /**
   * æ™ºèƒ½åˆ†ç»„é€‰é¡¹
   */
  @Builder
  SmartGroupOption(type: SmartGroupType, label: string, desc: string) {
    Row() {
      Radio({ value: type, group: 'smartGroup' })
        .checked(this.selectedSmartGroupType === type)
        .onChange((isChecked: boolean) => {
          if (isChecked) {
            this.selectedSmartGroupType = type;
          }
        })

      Column() {
        Text(label)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)

        Text(desc)
          .fontSize(12)
          .fontColor('#666')
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      .layoutWeight(1)
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16, bottom: 8 })
    .backgroundColor(Color.White)
    .borderRadius(10)
    .onClick(() => {
      this.selectedSmartGroupType = type;
    })
  }

  /**
   * åˆ é™¤ç¡®è®¤å¼¹çª—
   */
  @Builder
  DeleteConfirmDialog() {
    Column() {
      Blank()
        .width('100%')
        .height('100%')
        .backgroundColor('#000000')
        .opacity(0.5)
        .onClick(() => {
          this.showDeleteConfirm = false;
        })

      Column() {
        Text('ç¡®è®¤åˆ é™¤')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 12 })

        Text(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„"${this.selectedGroup?.name}"å—ï¼Ÿ`)
          .fontSize(14)
          .textAlign(TextAlign.Center)

        Text('åˆ†ç»„å†…çš„è”ç³»äººä¸ä¼šè¢«åˆ é™¤')
          .fontSize(12)
          .fontColor('#666')
          .margin({ top: 8 })

        Row() {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(40)
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .onClick(() => {
              this.showDeleteConfirm = false;
            })

          Button('åˆ é™¤')
            .layoutWeight(1)
            .height(40)
            .backgroundColor('#ff3b30')
            .margin({ left: 12 })
            .onClick(() => this.deleteGroup())
        }
        .width('100%')
        .margin({ top: 20 })
      }
      .width('80%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .position({ x: 0, y: 0 })
  }

  /**
   * æ™ºèƒ½åˆ†ç»„å¼¹çª—
   */
  @Builder
  SmartGroupDialog() {
    Column() {
      Blank()
        .width('100%')
        .height('100%')
        .backgroundColor('#000000')
        .opacity(0.5)
        .onClick(() => {
          this.showSmartGroupDialog = false;
        })

      Column() {
        Text('æ™ºèƒ½åˆ†ç»„')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 16 })

        ForEach(this.smartGroupDialogOptions, (item: SmartGroupOptionItem) => {
          Row() {
            Radio({ value: item.type, group: 'smartGroupDialog' })
              .checked(this.selectedSmartGroupType === item.type)
              .onChange((isChecked: boolean) => {
                if (isChecked) {
                  this.selectedSmartGroupType = item.type;
                }
              })

            Text(item.label)
              .fontSize(14)
              .margin({ left: 8 })
          }
          .width('100%')
          .padding(8)
        }, (item: SmartGroupOptionItem) => item.type)

        Row() {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(40)
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .onClick(() => {
              this.showSmartGroupDialog = false;
            })

          Button('ç”Ÿæˆ')
            .layoutWeight(1)
            .height(40)
            .backgroundColor('#007DFF')
            .margin({ left: 12 })
            .onClick(() => this.generateSmartGroups())
        }
        .width('100%')
        .margin({ top: 16 })
      }
      .width('80%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .position({ x: 0, y: 0 })
  }

  /**
   * åŠ è½½é®ç½©
   */
  @Builder
  LoadingOverlay() {
    Column() {
      LoadingProgress()
        .width(50)
        .height(50)

      Text('åŠ è½½ä¸­...')
        .fontSize(16)
        .fontColor(Color.White)
        .margin({ top: 12 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('rgba(0, 0, 0, 0.6)')
    .position({ x: 0, y: 0 })
  }

  /**
   * ä¿å­˜ç¡®è®¤å¼¹çª—
   */
  @Builder
  SaveConfirmDialog() {
    Column() {
      Column() {
        Text(this.isEditMode ? 'ç¡®è®¤ä¿å­˜ä¿®æ”¹' : 'ç¡®è®¤åˆ›å»ºåˆ†ç»„')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 16 })

        Text(this.isEditMode ?
          `ç¡®å®šè¦ä¿å­˜å¯¹åˆ†ç»„ "${this.editingGroupName}" çš„ä¿®æ”¹å—ï¼Ÿ` :
          `ç¡®å®šè¦åˆ›å»ºåˆ†ç»„ "${this.editingGroupName}" å—ï¼Ÿ`)
          .fontSize(14)
          .fontColor('#666')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 24 })

        Row() {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .onClick(() => {
              this.showSaveConfirm = false;
            })

          Button('ç¡®è®¤')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#007DFF')
            .fontColor(Color.White)
            .margin({ left: 12 })
            .onClick(() => {
              this.showSaveConfirm = false;
              if (this.isEditMode) {
                this.updateGroup();
              } else {
                this.createGroup();
              }
            })
        }
        .width('100%')
      }
      .width('80%')
      .padding(24)
      .backgroundColor(Color.White)
      .borderRadius(16)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#80000000')
    .justifyContent(FlexAlign.Center)
    .position({ x: 0, y: 0 })
  }

  /**
   * å®Œæˆç¡®è®¤å¼¹çª—ï¼ˆé€‰æ‹©è”ç³»äººåï¼‰
   */
  @Builder
  CompleteConfirmDialog() {
    Column() {
      Column() {
        Text('ç¡®è®¤å®Œæˆé€‰æ‹©')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 16 })

        Text(`å·²é€‰æ‹© ${this.selectedContactKeys.size} ä½è”ç³»äººï¼Œç¡®å®šè¦å®Œæˆå—ï¼Ÿ`)
          .fontSize(14)
          .fontColor('#666')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 24 })

        Row() {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .onClick(() => {
              this.showCompleteConfirm = false;
            })

          Button('ç¡®è®¤å®Œæˆ')
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#007DFF')
            .fontColor(Color.White)
            .margin({ left: 12 })
            .onClick(() => {
              this.showCompleteConfirm = false;
              this.saveContactSelection();
            })
        }
        .width('100%')
      }
      .width('80%')
      .padding(24)
      .backgroundColor(Color.White)
      .borderRadius(16)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#80000000')
    .justifyContent(FlexAlign.Center)
    .position({ x: 0, y: 0 })
  }
}
